#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
================================================================================
    TSUNAMI AUTO PENTEST - Report Generator v5.0
================================================================================

    Professional penetration test report generation:
    - Executive summary
    - Technical findings
    - Risk assessment
    - Remediation recommendations
    - Multiple output formats (HTML, PDF, JSON)

    IMPORTANT: For authorized security testing only.

================================================================================
"""

import logging
from datetime import datetime
from dataclasses import dataclass, field
from typing import Dict, List, Optional, Any
from enum import Enum
import uuid
import json

logger = logging.getLogger(__name__)


class ReportFormat(Enum):
    """Report output formats"""
    HTML = "html"
    PDF = "pdf"
    JSON = "json"
    MARKDOWN = "markdown"


class FindingSeverity(Enum):
    """Finding severity levels"""
    CRITICAL = "critical"
    HIGH = "high"
    MEDIUM = "medium"
    LOW = "low"
    INFORMATIONAL = "informational"


@dataclass
class ReportFinding:
    """Individual security finding"""
    finding_id: str = field(default_factory=lambda: str(uuid.uuid4()))
    title: str = ""
    description: str = ""
    severity: FindingSeverity = FindingSeverity.MEDIUM
    cvss_score: float = 0.0
    affected_assets: List[str] = field(default_factory=list)
    evidence: List[str] = field(default_factory=list)
    remediation: str = ""
    references: List[str] = field(default_factory=list)
    cve_ids: List[str] = field(default_factory=list)
    verified: bool = False


@dataclass
class PentestReport:
    """Complete penetration test report"""
    report_id: str = field(default_factory=lambda: str(uuid.uuid4()))
    title: str = "Penetration Test Report"
    target: str = ""
    scope: List[str] = field(default_factory=list)
    methodology: str = "OWASP Testing Guide / PTES"
    executive_summary: str = ""
    findings: List[ReportFinding] = field(default_factory=list)
    risk_summary: Dict[str, int] = field(default_factory=dict)
    recommendations: List[str] = field(default_factory=list)
    tester: str = "TSUNAMI AutoPentest"
    start_date: datetime = field(default_factory=datetime.now)
    end_date: Optional[datetime] = None
    classification: str = "Confidential"
    version: str = "1.0"
    metadata: Dict[str, Any] = field(default_factory=dict)


class ReportGenerator:
    """
    Generates professional penetration test reports
    """

    def __init__(self, config: Optional[Dict[str, Any]] = None):
        self.config = config or {}
        self.templates: Dict[str, str] = {}
        self.reports: Dict[str, PentestReport] = {}
        logger.info("ReportGenerator initialized")

    def create_report(
        self,
        target: str,
        findings: List[Dict[str, Any]],
        scope: Optional[List[str]] = None,
        **kwargs
    ) -> PentestReport:
        """Create a new penetration test report"""

        # Convert finding dicts to ReportFinding objects
        report_findings = []
        for f in findings:
            severity = FindingSeverity(f.get('severity', 'medium').lower())
            finding = ReportFinding(
                title=f.get('title', 'Untitled Finding'),
                description=f.get('description', ''),
                severity=severity,
                cvss_score=f.get('cvss_score', 0.0),
                affected_assets=f.get('affected_assets', []),
                remediation=f.get('remediation', ''),
                cve_ids=f.get('cve_ids', []),
                verified=f.get('verified', False)
            )
            report_findings.append(finding)

        # Calculate risk summary
        risk_summary = {
            'critical': sum(1 for f in report_findings if f.severity == FindingSeverity.CRITICAL),
            'high': sum(1 for f in report_findings if f.severity == FindingSeverity.HIGH),
            'medium': sum(1 for f in report_findings if f.severity == FindingSeverity.MEDIUM),
            'low': sum(1 for f in report_findings if f.severity == FindingSeverity.LOW),
            'informational': sum(1 for f in report_findings if f.severity == FindingSeverity.INFORMATIONAL)
        }

        # Generate executive summary
        total_findings = len(report_findings)
        critical_high = risk_summary['critical'] + risk_summary['high']

        executive_summary = f"""
This penetration test was conducted against {target} to identify security vulnerabilities.

Key Findings:
- Total vulnerabilities identified: {total_findings}
- Critical/High severity: {critical_high}
- Medium severity: {risk_summary['medium']}
- Low/Informational: {risk_summary['low'] + risk_summary['informational']}

Overall Risk Level: {'CRITICAL' if risk_summary['critical'] > 0 else 'HIGH' if risk_summary['high'] > 0 else 'MEDIUM' if risk_summary['medium'] > 0 else 'LOW'}
        """.strip()

        report = PentestReport(
            title=kwargs.get('title', f"Penetration Test Report - {target}"),
            target=target,
            scope=scope or [target],
            executive_summary=executive_summary,
            findings=report_findings,
            risk_summary=risk_summary,
            end_date=datetime.now(),
            **{k: v for k, v in kwargs.items() if k in ['tester', 'classification', 'methodology']}
        )

        self.reports[report.report_id] = report
        logger.info(f"Created report: {report.report_id} with {total_findings} findings")
        return report

    def export_report(
        self,
        report: PentestReport,
        format: ReportFormat = ReportFormat.JSON,
        output_path: Optional[str] = None
    ) -> str:
        """Export report to specified format"""

        if format == ReportFormat.JSON:
            content = self._to_json(report)
        elif format == ReportFormat.MARKDOWN:
            content = self._to_markdown(report)
        elif format == ReportFormat.HTML:
            content = self._to_html(report)
        else:
            content = self._to_json(report)

        if output_path:
            with open(output_path, 'w') as f:
                f.write(content)
            logger.info(f"Report exported to: {output_path}")

        return content

    def _to_json(self, report: PentestReport) -> str:
        """Convert report to JSON"""
        data = {
            'report_id': report.report_id,
            'title': report.title,
            'target': report.target,
            'scope': report.scope,
            'methodology': report.methodology,
            'executive_summary': report.executive_summary,
            'risk_summary': report.risk_summary,
            'findings': [
                {
                    'finding_id': f.finding_id,
                    'title': f.title,
                    'description': f.description,
                    'severity': f.severity.value,
                    'cvss_score': f.cvss_score,
                    'affected_assets': f.affected_assets,
                    'remediation': f.remediation,
                    'cve_ids': f.cve_ids,
                    'verified': f.verified
                }
                for f in report.findings
            ],
            'recommendations': report.recommendations,
            'tester': report.tester,
            'start_date': report.start_date.isoformat(),
            'end_date': report.end_date.isoformat() if report.end_date else None,
            'classification': report.classification,
            'version': report.version
        }
        return json.dumps(data, indent=2)

    def _to_markdown(self, report: PentestReport) -> str:
        """Convert report to Markdown"""
        lines = [
            f"# {report.title}",
            "",
            f"**Target:** {report.target}",
            f"**Classification:** {report.classification}",
            f"**Date:** {report.start_date.strftime('%Y-%m-%d')} to {report.end_date.strftime('%Y-%m-%d') if report.end_date else 'Ongoing'}",
            "",
            "## Executive Summary",
            "",
            report.executive_summary,
            "",
            "## Risk Summary",
            "",
            f"| Severity | Count |",
            f"|----------|-------|",
        ]

        for sev, count in report.risk_summary.items():
            lines.append(f"| {sev.title()} | {count} |")

        lines.extend([
            "",
            "## Findings",
            ""
        ])

        for i, finding in enumerate(report.findings, 1):
            lines.extend([
                f"### {i}. {finding.title}",
                "",
                f"**Severity:** {finding.severity.value.upper()}",
                f"**CVSS Score:** {finding.cvss_score}",
                "",
                f"**Description:** {finding.description}",
                "",
                f"**Remediation:** {finding.remediation}",
                ""
            ])

        return "\n".join(lines)

    def _to_html(self, report: PentestReport) -> str:
        """Convert report to HTML"""
        return f"""<!DOCTYPE html>
<html>
<head>
    <title>{report.title}</title>
    <style>
        body {{ font-family: Arial, sans-serif; margin: 40px; }}
        h1 {{ color: #333; }}
        .severity-critical {{ color: #d63031; }}
        .severity-high {{ color: #e17055; }}
        .severity-medium {{ color: #fdcb6e; }}
        .severity-low {{ color: #74b9ff; }}
        table {{ border-collapse: collapse; width: 100%; }}
        th, td {{ border: 1px solid #ddd; padding: 8px; text-align: left; }}
    </style>
</head>
<body>
    <h1>{report.title}</h1>
    <p><strong>Target:</strong> {report.target}</p>
    <p><strong>Classification:</strong> {report.classification}</p>

    <h2>Executive Summary</h2>
    <p>{report.executive_summary}</p>

    <h2>Risk Summary</h2>
    <table>
        <tr><th>Severity</th><th>Count</th></tr>
        {"".join(f"<tr><td>{sev}</td><td>{count}</td></tr>" for sev, count in report.risk_summary.items())}
    </table>

    <h2>Findings</h2>
    {"".join(f'''
    <div class="finding">
        <h3 class="severity-{f.severity.value}">{f.title}</h3>
        <p><strong>Severity:</strong> {f.severity.value.upper()}</p>
        <p>{f.description}</p>
        <p><strong>Remediation:</strong> {f.remediation}</p>
    </div>
    ''' for f in report.findings)}
</body>
</html>"""

    def get_report(self, report_id: str) -> Optional[PentestReport]:
        """Get report by ID"""
        return self.reports.get(report_id)

    def list_reports(self) -> List[Dict[str, Any]]:
        """List all reports"""
        return [
            {
                'report_id': r.report_id,
                'title': r.title,
                'target': r.target,
                'findings_count': len(r.findings),
                'created_at': r.start_date.isoformat()
            }
            for r in self.reports.values()
        ]

    def get_status(self) -> Dict[str, Any]:
        """Get generator status"""
        return {
            'total_reports': len(self.reports),
            'templates_loaded': len(self.templates)
        }
