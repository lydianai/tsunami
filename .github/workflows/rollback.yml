name: Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to rollback'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - canary
      version:
        description: 'Version/tag to rollback to (e.g., v6.0.0 or SHA)'
        required: true
        type: string
      reason:
        description: 'Reason for rollback'
        required: true
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  validate-rollback:
    name: Validate Rollback Request
    runs-on: ubuntu-latest
    outputs:
      approved: ${{ steps.check.outputs.approved }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check version exists
        id: check
        run: |
          VERSION="${{ github.event.inputs.version }}"
          
          # Check if it's a valid git tag or SHA
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "Version $VERSION is valid"
            echo "approved=true" >> $GITHUB_OUTPUT
          else
            echo "ERROR: Version '$VERSION' not found in git history"
            echo "approved=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Log rollback request
        run: |
          echo "## Rollback Request" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Initiated By | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ github.event.inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Target Version | ${{ github.event.inputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Reason | ${{ github.event.inputs.reason }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Timestamp | $(date -u) |" >> $GITHUB_STEP_SUMMARY

  rollback-production:
    name: Rollback Production
    runs-on: ubuntu-latest
    needs: validate-rollback
    if: github.event.inputs.environment == 'production' && needs.validate-rollback.outputs.approved == 'true'
    environment:
      name: production
      url: https://tsunami.ailydian.com

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.version }}

      - name: Execute Production Rollback
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}
          script: |
            set -e
            cd /opt/tsunami
            
            VERSION="${{ github.event.inputs.version }}"
            
            echo "=== ROLLBACK INITIATED ==="
            echo "Target version: $VERSION"
            echo "Initiated by: ${{ github.actor }}"
            echo "Reason: ${{ github.event.inputs.reason }}"
            echo ""
            
            # Store current state for rollback verification
            CURRENT=$(docker inspect --format='{{.Config.Image}}' tsunami-backend 2>/dev/null || echo "unknown")
            echo "Current image: $CURRENT"
            
            # Pull the target version
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$VERSION || \
              docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${VERSION:0:7} || \
              (echo "ERROR: Could not pull image for version $VERSION" && exit 1)
            
            # Update docker-compose to use specific version
            export IMAGE_TAG="$VERSION"
            
            # Perform rolling restart
            docker-compose up -d --no-deps --remove-orphans backend
            
            echo "=== Waiting for service to stabilize... ==="
            sleep 20
            docker-compose ps backend
        if: ${{ secrets.PROD_SERVER_HOST != '' }}

      - name: Verify Rollback Health
        run: |
          echo "Verifying rollback health..."
          
          for i in {1..12}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
              https://tsunami.ailydian.com/api/health 2>/dev/null || echo "000")
            
            if [ "$STATUS" = "200" ]; then
              echo "✅ Rollback successful! Health check passed (attempt $i)"
              exit 0
            fi
            
            echo "⏳ Health check pending HTTP $STATUS (attempt $i/12)"
            sleep 10
          done
          
          echo "❌ WARNING: Health check failed after rollback. Manual intervention may be required."
          exit 1
        continue-on-error: true

  rollback-staging:
    name: Rollback Staging
    runs-on: ubuntu-latest
    needs: validate-rollback
    if: github.event.inputs.environment == 'staging' && needs.validate-rollback.outputs.approved == 'true'
    environment:
      name: staging

    steps:
      - name: Execute Staging Rollback
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.STAGING_SERVER_HOST }}
          username: ${{ secrets.STAGING_SERVER_USER }}
          key: ${{ secrets.STAGING_SERVER_SSH_KEY }}
          script: |
            set -e
            cd /opt/tsunami-staging
            
            VERSION="${{ github.event.inputs.version }}"
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$VERSION
            
            export IMAGE_TAG="$VERSION"
            docker-compose -f docker-compose.staging.yml up -d --no-deps backend
            
            echo "Staging rolled back to $VERSION"
            docker-compose -f docker-compose.staging.yml ps
        if: ${{ secrets.STAGING_SERVER_HOST != '' }}

  rollback-canary:
    name: Rollback Canary
    runs-on: ubuntu-latest
    needs: validate-rollback
    if: github.event.inputs.environment == 'canary' && needs.validate-rollback.outputs.approved == 'true'
    environment:
      name: canary

    steps:
      - name: Remove Canary Deployment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}
          script: |
            set -e
            cd /opt/tsunami
            
            # Stop canary container
            docker-compose -f docker-compose.canary.yml stop backend-canary || true
            docker-compose -f docker-compose.canary.yml rm -f backend-canary || true
            
            # Reset nginx to 100% stable
            if [ -f /etc/nginx/conf.d/canary.conf ]; then
              sed -i "s/weight=[0-9]*/weight=0/g" /etc/nginx/conf.d/canary.conf
              nginx -t && nginx -s reload
            fi
            
            echo "Canary removed. 100% traffic routed to stable production."
        if: ${{ secrets.PROD_SERVER_HOST != '' }}

  rollback-notification:
    name: Send Rollback Notification
    runs-on: ubuntu-latest
    needs: [rollback-production, rollback-staging, rollback-canary]
    if: always() && (needs.rollback-production.result != 'skipped' || needs.rollback-staging.result != 'skipped' || needs.rollback-canary.result != 'skipped')

    steps:
      - name: Create Audit Trail
        run: |
          echo "## Rollback Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Rolled back to**: \`${{ github.event.inputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Reason**: ${{ github.event.inputs.reason }}" >> $GITHUB_STEP_SUMMARY
          echo "**Performed by**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time**: $(date -u)" >> $GITHUB_STEP_SUMMARY
