<!DOCTYPE html>
<html lang="tr" data-theme="cyan">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSUNAMI v3.0 CANLI ÜSTTE - Otonom Siber Komuta Merkezi</title>
    <!-- BUILD: 20260204-210058-CANLI-SALDIRILAR-EN-USTTE-FIX -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Orbitron:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        /* === TEMA SİSTEMİ === */
        :root, [data-theme="cyan"] {
            --bg-void: #020408;
            --bg-deep: #040810;
            --bg-panel: rgba(8, 16, 24, 0.85);
            --bg-glass: rgba(12, 24, 36, 0.6);
            --bg-card: rgba(10, 20, 30, 0.9);
            --border-glow: rgba(0, 180, 255, 0.3);
            --border-subtle: rgba(0, 120, 180, 0.15);
            --text-bright: #e8f4ff;
            --text-normal: #a0c0d8;
            --text-dim: #506070;
            --accent-primary: #00b4ff;
            --accent-secondary: #00ff9d;
            --accent-warning: #ffaa00;
            --accent-danger: #ff3355;
            --accent-purple: #8855ff;
            --hud-green: #00ff88;
            --hud-cyan: #00e5ff;
            --hud-amber: #ffcc00;
        }

        /* F-35 KOKPİT TEMASI - SİYAH ÜSTÜNE BEYAZ NEON */
        [data-theme="cockpit-bw"] {
            --bg-void: #000000;
            --bg-deep: #050505;
            --bg-panel: rgba(5, 5, 5, 0.98);
            --bg-glass: rgba(10, 10, 10, 0.9);
            --bg-card: rgba(8, 8, 8, 0.98);
            --border-glow: rgba(255, 255, 255, 0.5);
            --border-subtle: rgba(255, 255, 255, 0.15);
            --text-bright: #ffffff;
            --text-normal: #e0e0e0;
            --text-dim: #888888;
            --accent-primary: #ffffff;
            --accent-secondary: #e0e0e0;
            --accent-warning: #ffdd00;
            --accent-danger: #ff2222;
            --accent-purple: #cccccc;
            --hud-green: #00ff00;
            --hud-cyan: #ffffff;
            --hud-amber: #ffdd00;
        }
        /* Neon Glow Efektleri */
        [data-theme="cockpit-bw"] .side-panel { border-color: rgba(255,255,255,0.2) !important; }
        [data-theme="cockpit-bw"] .panel { border-color: rgba(255,255,255,0.2) !important; box-shadow: 0 0 15px rgba(255,255,255,0.05); }
        [data-theme="cockpit-bw"] .panel-header { border-bottom-color: rgba(255,255,255,0.15) !important; text-shadow: 0 0 10px rgba(255,255,255,0.3); }
        [data-theme="cockpit-bw"] .terminal-bar { border-color: rgba(255,255,255,0.3) !important; box-shadow: 0 -5px 30px rgba(255,255,255,0.1); }
        [data-theme="cockpit-bw"] .leaflet-container { filter: brightness(0.9) contrast(1.1); }
        [data-theme="cockpit-bw"] button { border-color: rgba(255,255,255,0.3) !important; color: #fff !important; }
        [data-theme="cockpit-bw"] button:hover { box-shadow: 0 0 20px rgba(255,255,255,0.3) !important; border-color: rgba(255,255,255,0.6) !important; }
        [data-theme="cockpit-bw"] select { background: rgba(0,0,0,0.8) !important; border-color: rgba(255,255,255,0.3) !important; color: #fff !important; }
        [data-theme="cockpit-bw"] .nav-item:hover, [data-theme="cockpit-bw"] .nav-item.active { background: rgba(255,255,255,0.1) !important; box-shadow: 0 0 10px rgba(255,255,255,0.1); }

        /* Cockpit-BW Top Bar Buton Stilleri */
        [data-theme="cockpit-bw"] .top-bar { background: linear-gradient(180deg, rgba(0,0,0,0.98) 0%, rgba(5,5,5,0.95) 100%) !important; border-bottom-color: rgba(255,255,255,0.3) !important; box-shadow: 0 4px 20px rgba(255,255,255,0.05) !important; }
        [data-theme="cockpit-bw"] .top-bar .logo-icon { background: linear-gradient(135deg, #fff, #888) !important; box-shadow: 0 0 20px rgba(255,255,255,0.3) !important; }
        [data-theme="cockpit-bw"] .top-bar .logo h1 { color: #fff !important; text-shadow: 0 0 15px rgba(255,255,255,0.5), 0 0 30px rgba(255,255,255,0.3) !important; }
        [data-theme="cockpit-bw"] .top-bar .logo span { color: #aaa !important; }
        [data-theme="cockpit-bw"] .btn-group .btn { background: rgba(0,0,0,0.8) !important; border: 1px solid rgba(255,255,255,0.3) !important; color: #fff !important; text-shadow: 0 0 8px rgba(255,255,255,0.5) !important; }
        [data-theme="cockpit-bw"] .btn-group .btn:hover { background: rgba(255,255,255,0.1) !important; border-color: rgba(255,255,255,0.7) !important; box-shadow: 0 0 25px rgba(255,255,255,0.4), inset 0 0 15px rgba(255,255,255,0.1) !important; text-shadow: 0 0 15px #fff !important; }
        [data-theme="cockpit-bw"] .btn-group .btn svg { filter: drop-shadow(0 0 5px rgba(255,255,255,0.6)) !important; }
        [data-theme="cockpit-bw"] .btn-group .btn:hover svg { filter: drop-shadow(0 0 10px #fff) !important; }

        /* Tek Toggle Buton Tema Değiştirici - Sol Üst */
        .theme-toggle { position: fixed; top: 80px; left: 70px; z-index: 9999; width: 42px; height: 42px; border-radius: 50%; border: 2px solid var(--border-glow); cursor: pointer; transition: all 0.3s; background: var(--bg-panel); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; }
        .theme-toggle:hover { transform: scale(1.1); box-shadow: 0 0 20px var(--accent-primary); }
        .theme-toggle svg { width: 20px; height: 20px; fill: var(--accent-primary); transition: all 0.3s; }
        [data-theme="cyan"] .theme-toggle { background: linear-gradient(135deg, rgba(0,180,255,0.2), rgba(136,85,255,0.2)); border-color: rgba(0,180,255,0.5); }
        [data-theme="cockpit-bw"] .theme-toggle { background: rgba(0,0,0,0.9) !important; border-color: rgba(255,255,255,0.5) !important; box-shadow: 0 0 15px rgba(255,255,255,0.2) !important; }
        [data-theme="cockpit-bw"] .theme-toggle:hover { box-shadow: 0 0 25px rgba(255,255,255,0.5) !important; }
        [data-theme="cockpit-bw"] .theme-toggle svg { fill: #fff !important; filter: drop-shadow(0 0 5px #fff); }

        /* Cockpit-BW Stealth Panel Stilleri */
        [data-theme="cockpit-bw"] #stealthInfoPanel { color: #fff !important; }
        [data-theme="cockpit-bw"] #stealthInfoPanel .stealth-stat { border-bottom-color: rgba(255,255,255,0.1) !important; }
        [data-theme="cockpit-bw"] #stealthInfoPanel .stealth-stat span:last-child { color: #fff !important; text-shadow: 0 0 8px rgba(255,255,255,0.5); }
        [data-theme="cockpit-bw"] #torActivateBtn { background: rgba(255,255,255,0.1) !important; border-color: rgba(255,255,255,0.5) !important; color: #fff !important; text-shadow: 0 0 10px rgba(255,255,255,0.5); }
        [data-theme="cockpit-bw"] #torActivateBtn:hover { background: rgba(255,255,255,0.2) !important; box-shadow: 0 0 20px rgba(255,255,255,0.4) !important; }
        [data-theme="cockpit-bw"] #stealthLevelSelect { background: rgba(0,0,0,0.8) !important; border-color: rgba(255,255,255,0.3) !important; color: #fff !important; }
        [data-theme="cockpit-bw"] #rotateStealthBtn { background: rgba(255,255,255,0.1) !important; border-color: rgba(255,255,255,0.3) !important; color: #fff !important; }

        /* Cockpit-BW Geo ve OSINT Buton Stilleri - Header butonlarıyla aynı */
        [data-theme="cockpit-bw"] .geo-btn {
            background: rgba(0,0,0,0.8) !important;
            border: 1px solid rgba(255,255,255,0.3) !important;
            color: #fff !important;
            text-shadow: 0 0 8px rgba(255,255,255,0.5) !important;
        }
        [data-theme="cockpit-bw"] .geo-btn:hover {
            background: rgba(255,255,255,0.1) !important;
            border-color: rgba(255,255,255,0.7) !important;
            box-shadow: 0 0 25px rgba(255,255,255,0.4), inset 0 0 15px rgba(255,255,255,0.1) !important;
            text-shadow: 0 0 15px #fff !important;
            transform: translateY(-2px);
        }
        [data-theme="cockpit-bw"] .osint-btn, [data-theme="cockpit-bw"] .osint-map-btn {
            background: rgba(255,255,255,0.1) !important;
            border-color: rgba(255,255,255,0.4) !important;
            color: #fff !important;
            text-shadow: 0 0 8px rgba(255,255,255,0.5);
        }
        [data-theme="cockpit-bw"] .osint-btn:hover, [data-theme="cockpit-bw"] .osint-map-btn:hover {
            background: rgba(255,255,255,0.2) !important;
            border-color: rgba(255,255,255,0.7) !important;
            box-shadow: 0 0 15px rgba(255,255,255,0.3) !important;
        }
        [data-theme="cockpit-bw"] .geo-panel, [data-theme="cockpit-bw"] .global-osint-panel {
            background: rgba(0,0,0,0.98) !important;
            border-color: rgba(255,255,255,0.3) !important;
        }
        [data-theme="cockpit-bw"] .geo-panel h4, [data-theme="cockpit-bw"] .global-osint-panel h4 {
            color: #fff !important;
            text-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        [data-theme="cockpit-bw"] .geo-layer-toggle label {
            color: #ccc !important;
        }
        [data-theme="cockpit-bw"] .legend { background: rgba(0,0,0,0.95) !important; border-color: rgba(255,255,255,0.3) !important; }
        [data-theme="cockpit-bw"] .legend h4 { color: #fff !important; text-shadow: 0 0 8px rgba(255,255,255,0.4); }
        [data-theme="cockpit-bw"] .leg-stat-num { color: #fff !important; }
        [data-theme="cockpit-bw"] .leg-stat-label { color: #aaa !important; }

        /* ═══════════════════════════════════════════════════════════════════════════
           F-35 KOKPİT TEMASI - SOL PANEL WİDGET STİLLERİ (BEYAZ NEON)
           Tüm sol panel widget'ları için kapsamlı beyaz/siyah tema
           ═══════════════════════════════════════════════════════════════════════════ */

        /* === Sol Panel Ana Yapı === */
        [data-theme="cockpit-bw"] .side-panel {
            background: rgba(0, 0, 0, 0.98) !important;
            border-color: rgba(255, 255, 255, 0.3) !important;
            box-shadow: 5px 0 30px rgba(255, 255, 255, 0.05) !important;
        }

        [data-theme="cockpit-bw"] .side-panel::-webkit-scrollbar {
            width: 6px;
        }
        [data-theme="cockpit-bw"] .side-panel::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.5);
        }
        [data-theme="cockpit-bw"] .side-panel::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }
        [data-theme="cockpit-bw"] .side-panel::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        /* === Panel Kartları === */
        [data-theme="cockpit-bw"] .side-panel .panel {
            background: rgba(5, 5, 5, 0.98) !important;
            border: 1px solid rgba(255, 255, 255, 0.25) !important;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.05), inset 0 0 30px rgba(255, 255, 255, 0.02) !important;
        }

        [data-theme="cockpit-bw"] .side-panel .panel:hover {
            border-color: rgba(255, 255, 255, 0.4) !important;
            box-shadow: 0 0 25px rgba(255, 255, 255, 0.1) !important;
        }

        /* === Panel Header === */
        [data-theme="cockpit-bw"] .side-panel .panel-header {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.03)) !important;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2) !important;
            color: #ffffff !important;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.6) !important;
        }

        [data-theme="cockpit-bw"] .side-panel .panel-header span,
        [data-theme="cockpit-bw"] .side-panel .panel-header h3,
        [data-theme="cockpit-bw"] .side-panel .panel-header h4 {
            color: #ffffff !important;
            text-shadow: 0 0 12px rgba(255, 255, 255, 0.5) !important;
        }

        [data-theme="cockpit-bw"] .side-panel .panel-header .collapse-arrow {
            color: rgba(255, 255, 255, 0.7) !important;
        }

        /* === Panel Body === */
        [data-theme="cockpit-bw"] .side-panel .panel-body {
            background: rgba(0, 0, 0, 0.6) !important;
            color: #e0e0e0 !important;
        }

        /* === Metrik Kutuları (WiFi, BT, Baz, Saldırı sayıları) === */
        [data-theme="cockpit-bw"] .metric {
            background: rgba(255, 255, 255, 0.05) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            transition: all 0.3s ease !important;
        }

        [data-theme="cockpit-bw"] .metric:hover {
            background: rgba(255, 255, 255, 0.12) !important;
            border-color: rgba(255, 255, 255, 0.5) !important;
            box-shadow: 0 0 25px rgba(255, 255, 255, 0.2) !important;
        }

        [data-theme="cockpit-bw"] .metric .val {
            color: #ffffff !important;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.8) !important;
        }

        [data-theme="cockpit-bw"] .metric .lbl {
            color: rgba(255, 255, 255, 0.7) !important;
        }

        /* Metrik özel renkleri - beyaz tema */
        [data-theme="cockpit-bw"] .metric.wifi .val,
        [data-theme="cockpit-bw"] .metric.bt .val,
        [data-theme="cockpit-bw"] .metric.baz .val,
        [data-theme="cockpit-bw"] .metric.atk .val {
            color: #ffffff !important;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.9) !important;
        }

        /* === Saldırı Feed === */
        [data-theme="cockpit-bw"] .attack-feed {
            background: transparent !important;
        }

        [data-theme="cockpit-bw"] .atk-item {
            border-bottom-color: rgba(255, 255, 255, 0.1) !important;
            color: #e0e0e0 !important;
        }

        [data-theme="cockpit-bw"] .atk-item:hover {
            background: rgba(255, 255, 255, 0.08) !important;
        }

        [data-theme="cockpit-bw"] .atk-src,
        [data-theme="cockpit-bw"] .atk-type,
        [data-theme="cockpit-bw"] .atk-time {
            color: rgba(255, 255, 255, 0.8) !important;
        }

        /* === Navigasyon Panel === */
        [data-theme="cockpit-bw"] .nav-panel {
            background: rgba(5, 5, 5, 0.98) !important;
            border-color: rgba(255, 255, 255, 0.25) !important;
        }

        [data-theme="cockpit-bw"] .nav-item {
            background: rgba(255, 255, 255, 0.03) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            color: #e0e0e0 !important;
        }

        [data-theme="cockpit-bw"] .nav-item:hover {
            background: rgba(255, 255, 255, 0.1) !important;
            border-color: rgba(255, 255, 255, 0.4) !important;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.15) !important;
            color: #ffffff !important;
        }

        [data-theme="cockpit-bw"] .nav-item.active {
            background: rgba(255, 255, 255, 0.15) !important;
            border-color: rgba(255, 255, 255, 0.5) !important;
            color: #ffffff !important;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.2) !important;
        }

        [data-theme="cockpit-bw"] .nav-item svg {
            fill: #ffffff !important;
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.5)) !important;
        }

        /* === Sol Panel Butonları === */
        [data-theme="cockpit-bw"] .side-panel button,
        [data-theme="cockpit-bw"] .side-panel .btn {
            background: rgba(255, 255, 255, 0.08) !important;
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
            color: #ffffff !important;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.5) !important;
        }

        [data-theme="cockpit-bw"] .side-panel button:hover,
        [data-theme="cockpit-bw"] .side-panel .btn:hover {
            background: rgba(255, 255, 255, 0.15) !important;
            border-color: rgba(255, 255, 255, 0.6) !important;
            box-shadow: 0 0 25px rgba(255, 255, 255, 0.3) !important;
            text-shadow: 0 0 15px #fff !important;
        }

        /* === Select/Dropdown === */
        [data-theme="cockpit-bw"] .side-panel select {
            background: rgba(0, 0, 0, 0.8) !important;
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
            color: #ffffff !important;
        }

        [data-theme="cockpit-bw"] .side-panel select:focus {
            border-color: rgba(255, 255, 255, 0.6) !important;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.2) !important;
        }

        /* === Input Alanları === */
        [data-theme="cockpit-bw"] .side-panel input {
            background: rgba(0, 0, 0, 0.8) !important;
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
            color: #ffffff !important;
        }

        [data-theme="cockpit-bw"] .side-panel input:focus {
            border-color: rgba(255, 255, 255, 0.6) !important;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.2) !important;
        }

        [data-theme="cockpit-bw"] .side-panel input::placeholder {
            color: rgba(255, 255, 255, 0.4) !important;
        }

        /* === Siber Komuta Widget === */
        [data-theme="cockpit-bw"] #siberKomutaWidget,
        [data-theme="cockpit-bw"] .siber-komuta-widget {
            border-color: rgba(255, 255, 255, 0.4) !important;
            box-shadow: 0 0 25px rgba(255, 255, 255, 0.15) !important;
        }

        [data-theme="cockpit-bw"] #siberKomutaWidget .panel-header,
        [data-theme="cockpit-bw"] .siber-komuta-widget .panel-header {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05)) !important;
        }

        /* === TOR Panel === */
        [data-theme="cockpit-bw"] [data-widget-id="torPanel"] {
            border-color: rgba(255, 255, 255, 0.3) !important;
        }

        [data-theme="cockpit-bw"] [data-widget-id="torPanel"] .panel-header {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.03)) !important;
        }

        /* === Agent Panel === */
        [data-theme="cockpit-bw"] [data-widget-id="agentsPanel"] {
            border-color: rgba(255, 255, 255, 0.3) !important;
        }

        [data-theme="cockpit-bw"] .agent-item {
            background: rgba(255, 255, 255, 0.05) !important;
            border: 1px solid rgba(255, 255, 255, 0.15) !important;
            color: #e0e0e0 !important;
        }

        [data-theme="cockpit-bw"] .agent-item:hover {
            background: rgba(255, 255, 255, 0.1) !important;
            border-color: rgba(255, 255, 255, 0.4) !important;
        }

        /* === Sol Panel Açma Butonu === */
        [data-theme="cockpit-bw"] .side-panel-open-btn {
            background: rgba(0, 0, 0, 0.95) !important;
            border-color: rgba(255, 255, 255, 0.4) !important;
            color: #ffffff !important;
            box-shadow: 2px 0 15px rgba(255, 255, 255, 0.1) !important;
        }

        [data-theme="cockpit-bw"] .side-panel-open-btn:hover {
            background: rgba(255, 255, 255, 0.1) !important;
            border-color: rgba(255, 255, 255, 0.6) !important;
            box-shadow: 2px 0 25px rgba(255, 255, 255, 0.2) !important;
        }

        /* === Listeler ve Tablo Satırları === */
        [data-theme="cockpit-bw"] .side-panel li,
        [data-theme="cockpit-bw"] .side-panel tr {
            color: #e0e0e0 !important;
            border-color: rgba(255, 255, 255, 0.1) !important;
        }

        [data-theme="cockpit-bw"] .side-panel li:hover,
        [data-theme="cockpit-bw"] .side-panel tr:hover {
            background: rgba(255, 255, 255, 0.08) !important;
        }

        /* === Badge/Etiketler === */
        [data-theme="cockpit-bw"] .side-panel .badge,
        [data-theme="cockpit-bw"] .side-panel .tag {
            background: rgba(255, 255, 255, 0.15) !important;
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
            color: #ffffff !important;
        }

        /* === İkonlar === */
        [data-theme="cockpit-bw"] .side-panel svg {
            fill: #ffffff !important;
            filter: drop-shadow(0 0 3px rgba(255, 255, 255, 0.4)) !important;
        }

        /* === Durum Göstergeleri === */
        [data-theme="cockpit-bw"] .status-dot,
        [data-theme="cockpit-bw"] .ghost-dot {
            box-shadow: 0 0 12px currentColor, 0 0 20px currentColor !important;
        }

        /* === Harita Kontrolleri === */
        /* Zoom butonları yatay düzen: - solda, + sağda */
        .leaflet-control-zoom {
            display: flex !important;
            flex-direction: row !important;
            border: none !important;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3) !important;
            border-radius: 6px !important;
            overflow: hidden;
        }
        .leaflet-control-zoom a {
            width: 32px !important;
            height: 32px !important;
            line-height: 32px !important;
            font-size: 18px !important;
            font-weight: bold !important;
            border: none !important;
            border-radius: 0 !important;
            background: rgba(10, 20, 30, 0.9) !important;
            color: var(--accent-primary, #00b4ff) !important;
            transition: all 0.2s ease !important;
        }
        .leaflet-control-zoom a:hover {
            background: rgba(0, 180, 255, 0.2) !important;
            color: #fff !important;
        }
        /* - butonu solda (ilk), + butonu sağda (son) */
        .leaflet-control-zoom-in {
            order: 2 !important;
            border-left: 1px solid rgba(255,255,255,0.1) !important;
            border-radius: 0 6px 6px 0 !important;
        }
        .leaflet-control-zoom-out {
            order: 1 !important;
            border-radius: 6px 0 0 6px !important;
        }

        [data-theme="cockpit-bw"] .leaflet-control-zoom a {
            background: rgba(0, 0, 0, 0.9) !important;
            border-color: rgba(255, 255, 255, 0.3) !important;
            color: #ffffff !important;
        }

        [data-theme="cockpit-bw"] .leaflet-control-zoom a:hover {
            background: rgba(255, 255, 255, 0.15) !important;
            border-color: rgba(255, 255, 255, 0.5) !important;
        }

        [data-theme="cockpit-bw"] .leaflet-control-layers {
            background: rgba(0, 0, 0, 0.95) !important;
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
            color: #ffffff !important;
        }

        [data-theme="cockpit-bw"] .leaflet-control-layers label {
            color: #e0e0e0 !important;
        }

        /* === Terminal Bar === */
        [data-theme="cockpit-bw"] .terminal-bar {
            background: rgba(0, 0, 0, 0.98) !important;
            border-color: rgba(255, 255, 255, 0.3) !important;
            color: #00ff00 !important;
        }

        [data-theme="cockpit-bw"] .terminal-bar input {
            color: #00ff00 !important;
        }

        /* === Tooltip/Popup === */
        [data-theme="cockpit-bw"] .leaflet-popup-content-wrapper {
            background: rgba(0, 0, 0, 0.95) !important;
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
            color: #ffffff !important;
        }

        [data-theme="cockpit-bw"] .leaflet-popup-tip {
            background: rgba(0, 0, 0, 0.95) !important;
            border-color: rgba(255, 255, 255, 0.3) !important;
        }

        /* ═══════════════════════════════════════════════════════════════════════════
           F-35 KOKPİT TEMASI SONU
           ═══════════════════════════════════════════════════════════════════════════ */

        /* Header Tema Butonu İkon Kontrolü */
        [data-theme="cyan"] .theme-toggle-header .theme-icon-light { display: inline; }
        [data-theme="cyan"] .theme-toggle-header .theme-icon-dark { display: none; }
        [data-theme="cockpit-bw"] .theme-toggle-header .theme-icon-light { display: none; }
        [data-theme="cockpit-bw"] .theme-toggle-header .theme-icon-dark { display: inline; }
        [data-theme="cockpit-bw"] .theme-toggle-header { background: rgba(255,255,255,0.15) !important; border-color: rgba(255,255,255,0.5) !important; }
        [data-theme="cockpit-bw"] .theme-toggle-header:hover { background: rgba(255,255,255,0.25) !important; box-shadow: 0 0 20px rgba(255,255,255,0.4) !important; }

        /* Gerçekçi Uçak Marker Stilleri */
        .aircraft-marker-real {
            transition: transform 0.3s ease;
        }
        .aircraft-marker-real:hover {
            transform: scale(1.3);
            z-index: 9999 !important;
        }
        .aircraft-marker-real svg {
            transition: all 0.3s ease;
        }

        /* ISS ve Uydu Marker */
        .iss-marker, .satellite-marker, .turksat-marker, .starlink-marker {
            transition: transform 0.3s ease;
        }
        .iss-marker:hover, .satellite-marker:hover {
            transform: scale(1.2);
        }

        /* Uçak iz çizgisi (opsiyonel) */
        .aircraft-trail {
            stroke: rgba(0, 229, 255, 0.3);
            stroke-width: 2;
            fill: none;
        }

        /* Deprem Marker */
        .earthquake-marker {
            transition: transform 0.2s ease;
        }
        .earthquake-marker:hover {
            transform: scale(1.3);
            z-index: 1000 !important;
        }
        .earthquake-marker.pulse > div {
            animation: earthquakePulse 2s infinite;
        }
        @keyframes earthquakePulse {
            0%, 100% { box-shadow: 0 0 5px currentColor; transform: scale(1); }
            50% { box-shadow: 0 0 20px currentColor, 0 0 30px currentColor; transform: scale(1.1); }
        }

        /* BLE Tracker Blink Animation */
        @keyframes blink {
            0%, 50%, 100% { opacity: 1; }
            25%, 75% { opacity: 0.3; }
        }

        /* AI Panel Styles */
        #aiChatMessages::-webkit-scrollbar {
            width: 4px;
        }
        #aiChatMessages::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.2);
        }
        #aiChatMessages::-webkit-scrollbar-thumb {
            background: rgba(138,43,226,0.5);
            border-radius: 2px;
        }

        .ai-quick-btn:hover {
            filter: brightness(1.3);
            transform: scale(1.02);
        }

        /* BLE Panel Styles */
        #bleCihazListesi::-webkit-scrollbar {
            width: 4px;
        }
        #bleCihazListesi::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.2);
        }
        #bleCihazListesi::-webkit-scrollbar-thumb {
            background: rgba(0,191,255,0.5);
            border-radius: 2px;
        }

        /* Cockpit-bw theme overrides for new panels */
        [data-theme="cockpit-bw"] #aiChatMessages {
            background: rgba(0, 0, 0, 0.5) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        [data-theme="cockpit-bw"] #bleCihazListesi {
            background: rgba(0, 0, 0, 0.5) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        [data-theme="cockpit-bw"] #aiChatInput {
            background: rgba(0, 0, 0, 0.6) !important;
            border-color: rgba(255, 255, 255, 0.3) !important;
            color: #ffffff !important;
        }

        [data-theme="cockpit-bw"] .ai-quick-btn {
            background: rgba(255, 255, 255, 0.08) !important;
            border-color: rgba(255, 255, 255, 0.2) !important;
            color: #ffffff !important;
        }

        [data-theme="cockpit-bw"] #bleTrackerUyari {
            background: rgba(255, 51, 85, 0.1) !important;
            border-color: rgba(255, 255, 255, 0.3) !important;
        }

        /* Fay Hattı */
        .fault-line {
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        body {
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg-void);
            color: var(--text-normal);
            height: 100vh;
            overflow: hidden;
        }

        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .attack-svg-layer {
            position: absolute;
            pointer-events: none;
            z-index: 500;
        }

        .attack-arc {
            fill: none;
            stroke-linecap: round;
        }

        /* Ust Bar - Cockpit Header */
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: linear-gradient(180deg, var(--bg-panel) 0%, var(--bg-glass) 100%);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-glow);
            box-shadow: 0 4px 20px rgba(0, 180, 255, 0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 38px;
            height: 38px;
            background: linear-gradient(135deg, var(--accent-primary), var(--hud-cyan));
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 15px var(--border-glow);
        }

        .logo-icon svg {
            width: 20px;
            height: 20px;
            fill: var(--bg-void);
        }

        .logo h1 {
            font-family: 'Orbitron', monospace;
            font-size: 18px;
            font-weight: 700;
            color: var(--text-bright);
            text-shadow: 0 0 10px var(--accent-primary);
            letter-spacing: 2px;
        }

        .logo span {
            font-size: 10px;
            color: var(--text-dim);
            font-family: 'JetBrains Mono', monospace;
        }

        /* Ghost Indicator - Tactical Status */
        .ghost-box {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--bg-card);
            border: 1px solid var(--hud-green);
            border-radius: 8px;
            padding: 8px 16px;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.25);
            transition: all 0.3s ease;
        }

        .ghost-box.danger {
            border-color: var(--accent-danger);
            box-shadow: 0 0 20px rgba(255, 51, 85, 0.4);
            animation: pulse-danger 1.5s infinite;
        }

        @keyframes pulse-danger {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .ghost-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--hud-green);
            box-shadow: 0 0 12px var(--hud-green);
            animation: pulse-dot 2s infinite;
        }

        @keyframes pulse-dot {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        @keyframes pulse-kritik {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 15px rgba(255, 0, 64, 0.5);
            }
            50% {
                transform: scale(1.15);
                box-shadow: 0 0 25px rgba(255, 0, 64, 0.8), 0 0 40px rgba(255, 0, 64, 0.4);
            }
        }

        .kritik-altyapi-marker {
            background: transparent !important;
            border: none !important;
        }

        .kritik-popup .leaflet-popup-content-wrapper {
            background: var(--bg-card) !important;
            border: 1px solid var(--border-glow) !important;
            border-radius: 8px !important;
            padding: 0 !important;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5), 0 0 30px rgba(0, 180, 255, 0.2) !important;
        }

        .kritik-popup .leaflet-popup-content {
            margin: 0 !important;
            padding: 0 !important;
        }

        .kritik-popup .leaflet-popup-tip {
            background: var(--bg-card) !important;
            border: 1px solid var(--border-glow) !important;
        }

        .ghost-box.danger .ghost-dot {
            background: var(--accent-danger);
            box-shadow: 0 0 12px var(--accent-danger);
        }

        .ghost-text {
            font-size: 11px;
        }

        .ghost-text .status {
            font-weight: 700;
            color: var(--hud-green);
            font-family: 'Orbitron', monospace;
        }

        .ghost-box.danger .ghost-text .status {
            color: var(--accent-danger);
        }

        .ghost-text .ip {
            font-family: 'JetBrains Mono', monospace;
            font-size: 9px;
            color: var(--text-dim);
        }

        /* Stealth Route Styles */
        .stealth-route-line {
            filter: drop-shadow(0 0 6px #00ff00);
        }

        .stealth-hop {
            animation: stealth-hop-pulse 2s infinite;
        }

        @keyframes stealth-hop-pulse {
            0%, 100% { transform: scale(1); filter: drop-shadow(0 0 5px #00ff00); }
            50% { transform: scale(1.1); filter: drop-shadow(0 0 10px #00ff00); }
        }

        .stealth-packet {
            position: fixed;
            font-size: 12px;
            color: #00ff00;
            text-shadow: 0 0 10px #00ff00;
            z-index: 9999;
            pointer-events: none;
            animation: packet-glow 0.5s infinite;
        }

        @keyframes packet-glow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        #stealthInfoPanel .stealth-stat {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid rgba(0,255,0,0.1);
        }

        #stealthInfoPanel .stealth-stat:last-child {
            border-bottom: none;
        }

        #stealthInfoPanel .stealth-stat span:last-child {
            color: #00ff00;
            font-weight: 600;
        }

        .btn-group {
            display: flex;
            gap: 8px;
            position: relative;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: rgba(0,255,136,0.4) transparent;
            padding-bottom: 4px;
            flex-wrap: nowrap;
        }
        .btn-group::-webkit-scrollbar {
            height: 3px;
        }
        .btn-group::-webkit-scrollbar-track {
            background: transparent;
        }
        .btn-group::-webkit-scrollbar-thumb {
            background: linear-gradient(90deg, rgba(0,255,136,0.5), rgba(0,180,255,0.5));
            border-radius: 2px;
        }
        .btn-group .btn {
            flex-shrink: 0;
        }

        /* Scroll indicator for header buttons */
        .btn-group-wrapper {
            position: relative;
            flex: 1;
            min-width: 0;
        }
        .btn-group-wrapper::after {
            content: '→';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            color: #00ff88;
            font-size: 16px;
            font-weight: bold;
            padding: 4px 8px;
            background: linear-gradient(90deg, transparent, rgba(10,10,15,0.95) 40%);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 5;
        }
        .btn-group-wrapper.has-scroll::after {
            opacity: 1;
            animation: scrollHint 1.5s ease-in-out infinite;
        }
        @keyframes scrollHint {
            0%, 100% { transform: translateY(-50%) translateX(0); }
            50% { transform: translateY(-50%) translateX(5px); }
        }

        .btn {
            padding: 8px 16px;
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            background: var(--bg-card);
            color: var(--text-normal);
            font-size: 11px;
            font-family: 'Orbitron', monospace;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn:hover {
            border-color: var(--accent-primary);
            background: var(--bg-glass);
            box-shadow: 0 0 15px var(--border-glow);
            color: var(--text-bright);
        }

        .btn-cyan {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: var(--bg-void);
            font-weight: 700;
            box-shadow: 0 0 15px var(--border-glow);
        }

        .btn-cyan:hover {
            background: var(--hud-cyan);
            transform: translateY(-2px);
        }

        /* F-35 Cockpit Unified Buton Stili */
        .btn-unified, .btn-lydian, .btn-gnn, .btn-osint, .btn-shodan {
            background: linear-gradient(135deg, rgba(0, 40, 80, 0.85), rgba(0, 60, 100, 0.7));
            border: 1px solid var(--border-glow);
            color: var(--hud-cyan);
            font-weight: 600;
            font-family: 'Orbitron', monospace;
            font-size: 10px;
            letter-spacing: 1px;
            box-shadow: 0 0 15px rgba(0, 180, 255, 0.25);
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-unified:hover, .btn-lydian:hover, .btn-gnn:hover, .btn-osint:hover, .btn-shodan:hover {
            background: linear-gradient(135deg, rgba(0, 60, 100, 0.9), rgba(0, 80, 120, 0.8));
            border-color: var(--hud-cyan);
            transform: translateY(-2px);
            box-shadow: 0 0 25px rgba(0, 229, 255, 0.4), inset 0 0 10px rgba(0, 229, 255, 0.1);
            color: var(--text-bright);
        }

        .btn-unified svg, .btn svg {
            vertical-align: middle;
        }

        /* Yeni F-35 Cockpit Butonları */
        .btn-threat {
            background: linear-gradient(135deg, #b71c1c, #880e4f);
            border-color: #e91e63;
            color: white;
            font-weight: 600;
            box-shadow: 0 0 15px rgba(233, 30, 99, 0.4);
        }
        .btn-threat:hover {
            background: linear-gradient(135deg, #880e4f, #b71c1c);
            transform: translateY(-2px);
            box-shadow: 0 0 25px rgba(233, 30, 99, 0.6);
        }

        .btn-pentest {
            background: linear-gradient(135deg, #ff5722, #e64a19);
            border-color: #ff7043;
            color: white;
            font-weight: 600;
            box-shadow: 0 0 15px rgba(255, 87, 34, 0.4);
        }
        .btn-pentest:hover {
            background: linear-gradient(135deg, #e64a19, #ff5722);
            transform: translateY(-2px);
            box-shadow: 0 0 25px rgba(255, 87, 34, 0.6);
        }

        .btn-dashboard {
            background: linear-gradient(135deg, #00bcd4, #0097a7);
            border-color: #26c6da;
            color: white;
            font-weight: 600;
            box-shadow: 0 0 15px rgba(0, 188, 212, 0.4);
        }
        .btn-dashboard:hover {
            background: linear-gradient(135deg, #0097a7, #00bcd4);
            transform: translateY(-2px);
            box-shadow: 0 0 25px rgba(0, 188, 212, 0.6);
        }

        .btn-beyin {
            background: linear-gradient(135deg, #9c27b0, #7b1fa2);
            border-color: #ba68c8;
            color: white;
            font-weight: 600;
            box-shadow: 0 0 15px rgba(156, 39, 176, 0.4);
        }
        .btn-beyin:hover {
            background: linear-gradient(135deg, #7b1fa2, #9c27b0);
            transform: translateY(-2px);
            box-shadow: 0 0 25px rgba(156, 39, 176, 0.6);
        }

        .btn-vuln {
            background: linear-gradient(135deg, #ffc107, #ff9800);
            border-color: #ffca28;
            color: #1a1a1a;
            font-weight: 600;
            box-shadow: 0 0 15px rgba(255, 193, 7, 0.4);
        }
        .btn-vuln:hover {
            background: linear-gradient(135deg, #ff9800, #ffc107);
            transform: translateY(-2px);
            box-shadow: 0 0 25px rgba(255, 193, 7, 0.6);
        }

        @keyframes osintPulse {
            0%, 100% { box-shadow: 0 0 5px rgba(255, 102, 0, 0.4); }
            50% { box-shadow: 0 0 20px rgba(255, 102, 0, 0.8); }
        }

        /* ==================== MÜDAHAlE PANELİ STİLLERİ ==================== */
        .intervention-panel {
            position: fixed;
            top: 140px;
            right: 20px;
            width: 340px;
            max-height: calc(100vh - 180px);
            background: rgba(8, 12, 20, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            z-index: 1500;
            display: none;
            overflow: hidden;
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.6), inset 0 1px 0 rgba(255,255,255,0.05);
            backdrop-filter: blur(20px);
        }
        .intervention-panel.active { display: block; }
        .intervention-header {
            background: linear-gradient(90deg, rgba(255, 0, 100, 0.3), rgba(100, 0, 255, 0.2));
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-glow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .intervention-header h3 {
            color: #ff0066;
            font-family: 'Orbitron', sans-serif;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 2px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .intervention-close {
            background: transparent;
            border: none;
            color: var(--text-dim);
            font-size: 18px;
            cursor: pointer;
        }
        .intervention-close:hover { color: var(--accent-danger); }
        .intervention-body {
            padding: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .intervention-module {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            margin-bottom: 10px;
            overflow: hidden;
        }
        .intervention-module-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .intervention-module-header:hover { background: rgba(255, 0, 100, 0.1); }
        .intervention-module-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            color: var(--text-bright);
        }
        .intervention-module-icon {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        .intervention-toggle {
            position: relative;
            width: 40px;
            height: 20px;
            background: var(--bg-void);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .intervention-toggle.active { background: linear-gradient(90deg, #ff0066, #6600ff); }
        .intervention-toggle::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            background: var(--text-bright);
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.3s;
        }
        .intervention-toggle.active::after { left: 22px; }
        .intervention-stats {
            padding: 8px 12px;
            border-top: 1px solid var(--border-subtle);
            display: none;
            font-size: 10px;
        }
        .intervention-module.expanded .intervention-stats { display: block; }
        .intervention-stat-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            color: var(--text-dim);
        }
        .intervention-stat-row .value { color: var(--hud-cyan); font-weight: 600; }
        .intervention-nlp {
            padding: 12px;
            border-top: 1px solid var(--border-subtle);
        }
        .intervention-nlp-input {
            width: 100%;
            padding: 10px;
            background: var(--bg-void);
            border: 1px solid var(--border-glow);
            border-radius: 6px;
            color: var(--text-bright);
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            resize: none;
        }
        .intervention-nlp-input:focus {
            outline: none;
            border-color: #ff0066;
            box-shadow: 0 0 10px rgba(255, 0, 100, 0.3);
        }
        .intervention-nlp-btn {
            width: 100%;
            margin-top: 8px;
            padding: 10px;
            background: linear-gradient(135deg, #ff0066, #6600ff);
            border: none;
            border-radius: 6px;
            color: white;
            font-family: 'Orbitron', sans-serif;
            font-size: 10px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
        }
        .intervention-nlp-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255, 0, 100, 0.4);
        }
        .intervention-trigger {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, rgba(255,0,100,0.9), rgba(100,0,255,0.9));
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1400;
            transition: all 0.3s;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
        }
        .intervention-trigger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 30px rgba(255, 0, 100, 0.5), inset 0 1px 0 rgba(255,255,255,0.2);
        }
        .intervention-trigger.hidden { display: none; }
        .intervention-trigger svg {
            width: 24px;
            height: 24px;
            fill: #fff;
            filter: drop-shadow(0 0 4px rgba(255,255,255,0.5));
        }
        @keyframes interventionPulse {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 0, 100, 0.4); }
            50% { box-shadow: 0 0 40px rgba(255, 0, 100, 0.8), 0 0 60px rgba(100, 0, 255, 0.4); }
        }
        .intervention-trigger.alert { animation: interventionPulse 1s infinite; }
        [data-theme="cockpit-bw"] .intervention-panel { border-color: rgba(255,255,255,0.3); }
        [data-theme="cockpit-bw"] .intervention-header { background: rgba(255,255,255,0.1); }
        [data-theme="cockpit-bw"] .intervention-header h3 { color: #fff; }
        [data-theme="cockpit-bw"] .intervention-trigger { background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.5); }

        /* OSINT Panel */
        .osint-panel {
            position: fixed;
            top: 70px;
            right: 20px;
            width: 420px;
            max-height: calc(100vh - 100px);
            background: var(--bg-panel);
            border: 1px solid var(--border-glow);
            border-radius: 12px;
            z-index: 2000;
            display: none;
            overflow: hidden;
            box-shadow: 0 0 40px rgba(255, 102, 0, 0.3);
        }

        .osint-panel.active { display: block; }

        .osint-header {
            background: linear-gradient(90deg, rgba(255, 102, 0, 0.3), transparent);
            padding: 15px;
            border-bottom: 1px solid var(--border-glow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .osint-header h3 {
            color: #ff9933;
            font-family: 'Orbitron', sans-serif;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .osint-close {
            background: transparent;
            border: none;
            color: var(--text-dim);
            font-size: 20px;
            cursor: pointer;
        }
        .osint-close:hover { color: var(--accent-danger); }

        .osint-body {
            padding: 15px;
            max-height: 500px;
            overflow-y: auto;
        }

        .osint-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .osint-tab {
            padding: 8px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text-dim);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .osint-tab:hover, .osint-tab.active {
            background: rgba(255, 102, 0, 0.2);
            border-color: #ff6600;
            color: #ff9933;
        }

        .osint-input-group {
            margin-bottom: 15px;
        }

        .osint-input-group label {
            display: block;
            color: var(--text-dim);
            font-size: 11px;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .osint-input {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text-bright);
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
        }
        .osint-input:focus {
            outline: none;
            border-color: #ff6600;
            box-shadow: 0 0 10px rgba(255, 102, 0, 0.3);
        }

        .osint-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #ff6600, #ff9933);
            border: none;
            border-radius: 6px;
            color: white;
            font-family: 'Orbitron', sans-serif;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .osint-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255, 102, 0, 0.4);
        }
        .osint-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .osint-results {
            margin-top: 15px;
            padding: 10px;
            background: var(--bg-card);
            border-radius: 6px;
            max-height: 300px;
            overflow-y: auto;
        }

        .osint-result-item {
            padding: 10px;
            border-bottom: 1px solid var(--border-subtle);
            font-size: 12px;
        }
        .osint-result-item:last-child { border-bottom: none; }

        .osint-result-item .label {
            color: var(--text-dim);
            font-size: 10px;
            text-transform: uppercase;
        }
        .osint-result-item .value {
            color: var(--text-bright);
            margin-top: 2px;
        }

        .osint-platform {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 4px;
            margin: 2px;
            font-size: 11px;
        }
        .osint-platform.not-found {
            background: rgba(255, 51, 85, 0.1);
            border-color: rgba(255, 51, 85, 0.3);
            color: var(--accent-danger);
        }

        .osint-map-btn {
            display: inline-block;
            padding: 6px 12px;
            background: linear-gradient(135deg, var(--hud-green), var(--hud-cyan));
            border: none;
            border-radius: 4px;
            color: black;
            font-size: 11px;
            cursor: pointer;
            margin-top: 8px;
        }
        .osint-map-btn:hover {
            transform: scale(1.05);
        }

        .osint-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(0, 180, 255, 0.1);
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 11px;
        }
        .osint-status.loading {
            background: rgba(255, 170, 0, 0.1);
        }
        .osint-status.error {
            background: rgba(255, 51, 85, 0.1);
            color: var(--accent-danger);
        }
        .osint-status.success {
            background: rgba(0, 255, 136, 0.1);
            color: var(--hud-green);
        }

        .osint-tab-content {
            display: none;
        }
        .osint-tab-content.active {
            display: block;
        }

        @keyframes gnnPulse {
            0%, 100% { box-shadow: 0 0 5px var(--hud-cyan); }
            50% { box-shadow: 0 0 15px var(--hud-cyan), 0 0 25px rgba(0, 229, 255, 0.3); }
        }

        @keyframes lydianPulse {
            0%, 100% { box-shadow: 0 0 20px rgba(136, 85, 255, 0.5); }
            50% { box-shadow: 0 0 30px rgba(255, 0, 255, 0.7); }
        }

        /* SVG İkon Animasyonları */
        @keyframes neuralPulse {
            0%, 100% { filter: drop-shadow(0 0 2px currentColor); }
            50% { filter: drop-shadow(0 0 6px currentColor) drop-shadow(0 0 10px currentColor); }
        }

        @keyframes scanSweep {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes radarSweep {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes shieldPulse {
            0%, 100% { filter: drop-shadow(0 0 2px var(--hud-green)); opacity: 1; }
            50% { filter: drop-shadow(0 0 8px var(--hud-green)); opacity: 0.8; }
        }

        @keyframes targetLock {
            0%, 100% { transform: scale(1); filter: drop-shadow(0 0 2px var(--accent-danger)); }
            50% { transform: scale(1.15); filter: drop-shadow(0 0 6px var(--accent-danger)); }
        }

        @keyframes dnaPulse {
            0%, 100% { filter: drop-shadow(0 0 2px var(--accent-purple)); }
            50% { filter: drop-shadow(0 0 6px var(--accent-purple)); }
        }

        @keyframes lockPulse {
            0%, 100% { filter: drop-shadow(0 0 2px var(--hud-amber)); }
            50% { filter: drop-shadow(0 0 6px var(--hud-amber)); }
        }

        @keyframes planeFly {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(2px) translateY(-1px); }
            75% { transform: translateX(-2px) translateY(1px); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Unified button SVG stili */
        .btn-unified svg {
            vertical-align: middle;
            margin-right: 4px;
        }

        /* ═══════════════════════════════════════════════════════════════
           TSUNAMI ICON DOCK + FLYOUT SYSTEM v3.0
           Profesyonel harita widget sistemi
           ═══════════════════════════════════════════════════════════════ */

        /* ===== ICON DOCK - Sol Dikey Bar ===== */
        .widget-dock {
            position: fixed;
            top: 80px;
            left: 10px;
            width: 52px;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 8px;
            background: rgba(5, 12, 20, 0.95);
            border: 1px solid rgba(0, 180, 255, 0.3);
            border-radius: 12px;
            backdrop-filter: blur(15px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.5),
                        0 0 40px rgba(0, 180, 255, 0.1);
        }

        /* Dock Item - Her bir icon butonu */
        .dock-item {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .dock-item svg {
            width: 18px;
            height: 18px;
            color: rgba(255,255,255,0.6);
            transition: all 0.2s ease;
        }

        .dock-item:hover {
            background: rgba(var(--dock-color-rgb, 0,180,255), 0.15);
            border-color: rgba(var(--dock-color-rgb, 0,180,255), 0.4);
        }

        .dock-item:hover svg {
            color: var(--dock-color, #00b4ff);
            transform: scale(1.1);
        }

        .dock-item.active {
            background: rgba(var(--dock-color-rgb, 0,180,255), 0.2);
            border-color: rgba(var(--dock-color-rgb, 0,180,255), 0.6);
            box-shadow: 0 0 15px rgba(var(--dock-color-rgb, 0,180,255), 0.3);
        }

        .dock-item.active svg {
            color: var(--dock-color, #00b4ff);
        }

        /* Dock Item Badge */
        .dock-item-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            min-width: 16px;
            height: 16px;
            padding: 0 4px;
            background: var(--dock-color, #ff3355);
            color: white;
            font-size: 9px;
            font-weight: bold;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
        }

        .dock-item-badge.pulse {
            animation: badgePulse 1.5s ease-in-out infinite;
        }

        @keyframes badgePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }

        /* SOC Komuta Merkezi Stilleri */
        .soc-tab {
            flex:1;padding:8px 4px;background:none;border:none;color:#666;font-size:9px;
            font-weight:600;letter-spacing:0.5px;cursor:pointer;transition:all 0.2s;
            border-bottom:2px solid transparent;
        }
        .soc-tab:hover { color:#aaa; }
        .soc-tab.active { color:#c832b4;border-bottom-color:#c832b4; }
        .soc-tab-content { display:none; }
        .soc-tab-content.active { display:block; }
        .soc-severity-card {
            background:rgba(0,0,0,0.3);border-radius:6px;padding:6px 4px;text-align:center;
            border-left:3px solid var(--sev-color);
        }
        .soc-severity-val { font-size:16px;font-weight:bold;color:var(--sev-color); }
        .soc-severity-lbl { font-size:7px;color:#888;text-transform:uppercase;letter-spacing:0.5px; }
        .soc-modul-badge {
            width:24px;height:24px;border-radius:6px;display:flex;align-items:center;justify-content:center;
            font-size:11px;font-weight:bold;color:#fff;flex-shrink:0;
        }
        .soc-mod-dot {
            width:8px;height:8px;border-radius:50%;background:#444;display:inline-block;
            transition:background 0.3s;cursor:pointer;
        }
        .soc-mod-dot.active { background:#00ff88;box-shadow:0 0 4px #00ff88; }
        .soc-alarm-item {
            display:flex;gap:8px;align-items:center;padding:6px 8px;
            background:rgba(0,0,0,0.3);border-radius:6px;cursor:pointer;
            border-left:3px solid var(--alarm-color, #444);transition:background 0.2s;
        }
        .soc-alarm-item:hover { background:rgba(255,255,255,0.05); }

        /* Dock Item Color Variants */
        .dock-item--danger { --dock-color: #ff3355; --dock-color-rgb: 255,51,85; }
        .dock-item--success { --dock-color: #00ff88; --dock-color-rgb: 0,255,136; }
        .dock-item--warning { --dock-color: #ffaa00; --dock-color-rgb: 255,170,0; }
        .dock-item--info { --dock-color: #00b4ff; --dock-color-rgb: 0,180,255; }
        .dock-item--purple { --dock-color: #8855ff; --dock-color-rgb: 136,85,255; }
        .dock-item--cyan { --dock-color: #00d4ff; --dock-color-rgb: 0,212,255; }
        .dock-item--neutral { --dock-color: #888888; --dock-color-rgb: 136,136,136; }

        /* Dock Tooltip */
        .dock-item::after {
            content: attr(data-tooltip);
            position: absolute;
            left: calc(100% + 12px);
            top: 50%;
            transform: translateY(-50%);
            padding: 6px 12px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            font-size: 11px;
            font-weight: 500;
            white-space: nowrap;
            border-radius: 6px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            pointer-events: none;
            border: 1px solid rgba(var(--dock-color-rgb, 0,180,255), 0.3);
        }

        .dock-item:hover::after {
            opacity: 1;
            visibility: visible;
        }

        /* Dock Separator */
        .dock-separator {
            width: 28px;
            height: 1px;
            margin: 4px auto;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        }

        /* ═══════════════════════════════════════════════════════════════
           PLAN MODU - ÇİZİM ARAÇLARI
           ═══════════════════════════════════════════════════════════════ */
        .dock-item--plan {
            border-color: rgba(0, 180, 255, 0.6);
            background: rgba(0, 180, 255, 0.1);
        }

        .dock-item--plan:hover {
            background: rgba(0, 180, 255, 0.25);
            border-color: rgba(0, 180, 255, 1);
            box-shadow: 0 0 20px rgba(0, 180, 255, 0.4);
        }

        .dock-item--plan.active {
            background: rgba(0, 255, 157, 0.3);
            border-color: rgba(0, 255, 157, 1);
            animation: planPulse 1.5s ease-in-out infinite;
        }

        @keyframes planPulse {
            0%, 100% { box-shadow: 0 0 5px rgba(0, 255, 157, 0.5); }
            50% { box-shadow: 0 0 20px rgba(0, 255, 157, 0.8); }
        }

        /* AI Tehdit Tahmin Butonu */
        .dock-item--ai {
            border-color: rgba(193, 0, 255, 0.6);
            background: rgba(193, 0, 255, 0.1);
        }

        .dock-item--ai:hover {
            background: rgba(193, 0, 255, 0.25);
            border-color: rgba(193, 0, 255, 1);
            box-shadow: 0 0 20px rgba(193, 0, 255, 0.4);
        }

        .dock-item--ai.active {
            background: rgba(138, 43, 226, 0.3);
            border-color: rgba(193, 0, 255, 1);
            animation: aiPulse 1.5s ease-in-out infinite;
        }

        @keyframes aiPulse {
            0%, 100% { box-shadow: 0 0 5px rgba(193, 0, 255, 0.5); }
            50% { box-shadow: 0 0 20px rgba(193, 0, 255, 0.8); }
        }

        /* Plan Modu - Çizim Araçları Paneli */
        #planToolbar {
            position: fixed;
            top: 50%;
            left: 20px;
            transform: translateY(-50%);
            background: rgba(5, 12, 20, 0.95);
            border: 2px solid rgba(0, 180, 255, 0.4);
            border-radius: 12px;
            padding: 12px;
            z-index: 1002;
            display: none;
            flex-direction: column;
            gap: 10px;
            backdrop-filter: blur(15px);
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        #planToolbar.active {
            display: flex;
        }

        .plan-tool-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 180, 255, 0.1);
            border: 2px solid rgba(0, 180, 255, 0.3);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .plan-tool-btn:hover {
            background: rgba(0, 180, 255, 0.25);
            border-color: rgba(0, 180, 255, 0.8);
        }

        .plan-tool-btn.active {
            background: rgba(0, 255, 157, 0.3);
            border-color: rgba(0, 255, 157, 1);
            box-shadow: 0 0 15px rgba(0, 255, 157, 0.5);
        }

        .plan-tool-btn svg {
            width: 20px;
            height: 20px;
            color: rgba(255, 255, 255, 0.8);
        }

        /* Plan Modu - Ölçüm Paneli */
        #planMeasurement {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(5, 12, 20, 0.95);
            border: 2px solid rgba(0, 255, 157, 0.4);
            border-radius: 12px;
            padding: 15px 20px;
            z-index: 1002;
            display: none;
            gap: 15px;
            backdrop-filter: blur(15px);
        }

        #planMeasurement.active {
            display: flex;
            align-items: center;
        }

        .measurement-display {
            color: #00ff9d;
            font-size: 14px;
            font-weight: 600;
            text-shadow: 0 0 10px rgba(0, 255, 157, 0.5);
        }

        /* Plan Modu - Not Paneli */
        #planNotes {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 300px;
            max-height: calc(100vh - 160px);
            background: rgba(5, 12, 20, 0.95);
            border: 2px solid rgba(0, 180, 255, 0.4);
            border-radius: 12px;
            padding: 15px;
            z-index: 1002;
            display: none;
            flex-direction: column;
            gap: 10px;
            backdrop-filter: blur(15px);
            overflow-y: auto;
        }

        #planNotes.active {
            display: flex;
        }

        #planNotes h3 {
            color: #00b4ff;
            font-size: 16px;
            margin: 0 0 10px 0;
            text-shadow: 0 0 10px rgba(0, 180, 255, 0.5);
        }

        #planNotes textarea {
            width: 100%;
            min-height: 100px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 180, 255, 0.3);
            border-radius: 8px;
            color: #fff;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            resize: vertical;
        }

        #planNotes button {
            background: rgba(0, 180, 255, 0.2);
            border: 1px solid rgba(0, 180, 255, 0.5);
            color: #00b4ff;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        #planNotes button:hover {
            background: rgba(0, 180, 255, 0.4);
            border-color: rgba(0, 180, 255, 0.8);
        }

        /* Plan Modu - Kayıtlı Planlar Listesi */
        #planList {
            max-height: 300px;
            overflow-y: auto;
        }

        .plan-item {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 180, 255, 0.2);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .plan-item:hover {
            background: rgba(0, 180, 255, 0.15);
            border-color: rgba(0, 180, 255, 0.5);
        }

        .plan-item-name {
            color: #fff;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .plan-item-meta {
            color: rgba(255, 255, 255, 0.6);
            font-size: 11px;
        }

        /* Plan Modu - Harita Göstergeleri */
        .drawing-marker {
            background: rgba(0, 255, 157, 0.3);
            border: 2px solid #00ff9d;
            border-radius: 50%;
            width: 16px;
            height: 16px;
        }

        .drawing-line {
            stroke: #00ff9d;
            stroke-width: 2;
            stroke-dasharray: 5, 5;
            animation: lineDash 1s linear infinite;
        }

        @keyframes lineDash {
            to { stroke-dashoffset: -10; }
        }

        .drawing-polygon {
            fill: rgba(0, 255, 157, 0.2);
            stroke: #00ff9d;
            stroke-width: 2;
        }

        .drawing-circle {
            fill: rgba(0, 180, 255, 0.2);
            stroke: #00b4ff;
            stroke-width: 2;
        }

        /* Plan Modu Aktif - Harita Kontrollerini Devre Dışı */
        body.plan-mode-active .leaflet-control-container {
            opacity: 0.3;
            pointer-events: none;
        }

        body.plan-mode-active #map {
            cursor: crosshair;
        }

        /* ===== FLYOUT PANEL - Acilan Icerik Paneli ===== */
        .widget-flyout {
            position: fixed;
            top: 80px;
            left: 75px;
            width: 280px;
            max-height: calc(100vh - 160px);
            background: rgba(5, 12, 20, 0.98);
            border: 2px solid rgba(var(--flyout-color-rgb, 0,180,255), 0.4);
            border-radius: 12px;
            backdrop-filter: blur(15px);
            box-shadow: 0 15px 50px rgba(0,0,0,0.6),
                        0 0 50px rgba(var(--flyout-color-rgb, 0,180,255), 0.15);
            z-index: 1000;
            overflow: hidden;
            transform: translateX(-20px);
            opacity: 0;
            visibility: hidden;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .widget-flyout.active {
            transform: translateX(0);
            opacity: 1;
            visibility: visible;
        }

        /* Flyout Color Variants */
        .widget-flyout--danger { --flyout-color: #ff3355; --flyout-color-rgb: 255,51,85; }
        .widget-flyout--success { --flyout-color: #00ff88; --flyout-color-rgb: 0,255,136; }
        .widget-flyout--warning { --flyout-color: #ffaa00; --flyout-color-rgb: 255,170,0; }
        .widget-flyout--info { --flyout-color: #00b4ff; --flyout-color-rgb: 0,180,255; }
        .widget-flyout--purple { --flyout-color: #8855ff; --flyout-color-rgb: 136,85,255; }
        .widget-flyout--cyan { --flyout-color: #00d4ff; --flyout-color-rgb: 0,212,255; }
        .widget-flyout--neutral { --flyout-color: #888888; --flyout-color-rgb: 136,136,136; }

        /* Flyout Header */
        .flyout-header {
            padding: 14px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(90deg,
                rgba(var(--flyout-color-rgb, 0,180,255), 0.15) 0%,
                rgba(var(--flyout-color-rgb, 0,180,255), 0.05) 100%);
            border-bottom: 1px solid rgba(var(--flyout-color-rgb, 0,180,255), 0.2);
        }

        .flyout-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .flyout-title svg {
            width: 18px;
            height: 18px;
            color: var(--flyout-color, #00b4ff);
        }

        .flyout-title-text {
            font-size: 13px;
            font-weight: 600;
            color: var(--flyout-color, #00b4ff);
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .flyout-close {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .flyout-close:hover {
            background: rgba(255,51,85,0.2);
            border-color: rgba(255,51,85,0.4);
        }

        .flyout-close svg {
            width: 14px;
            height: 14px;
            color: rgba(255,255,255,0.6);
        }

        .flyout-close:hover svg {
            color: #ff3355;
        }

        /* Flyout Body */
        .flyout-body {
            padding: 16px;
            max-height: calc(100vh - 250px);
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(var(--flyout-color-rgb, 0,180,255), 0.4) transparent;
        }

        .flyout-body::-webkit-scrollbar {
            width: 5px;
        }
        .flyout-body::-webkit-scrollbar-track {
            background: transparent;
        }
        .flyout-body::-webkit-scrollbar-thumb {
            background: rgba(var(--flyout-color-rgb, 0,180,255), 0.4);
            border-radius: 3px;
        }

        /* Flyout Backdrop - Disari tiklaninca kapanmasi icin */
        .flyout-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: transparent;
            z-index: 999;
            display: none;
        }

        .flyout-backdrop.active {
            display: block;
        }

        /* Cockpit-BW Theme */
        [data-theme="cockpit-bw"] .widget-dock {
            border-color: rgba(255,255,255,0.2);
        }
        [data-theme="cockpit-bw"] .dock-item:hover {
            border-color: rgba(255,255,255,0.4);
        }
        [data-theme="cockpit-bw"] .widget-flyout {
            border-color: rgba(255,255,255,0.3);
        }

        /* Legacy uyumluluk - eski class'lar icin */
        .widget-title {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .widget-icon {
            width: 16px;
            height: 16px;
            color: var(--widget-color);
            flex-shrink: 0;
        }

        .widget-title-text {
            font-size: 12px;
            font-weight: 600;
            color: var(--widget-color);
            letter-spacing: 0.3px;
            text-transform: uppercase;
        }

        .widget-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .widget-badge {
            font-size: 10px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
            background: rgba(var(--widget-color-rgb), 0.2);
            color: var(--widget-color);
            min-width: 20px;
            text-align: center;
        }

        .widget-badge.pulse {
            animation: badgePulse 1.5s ease-in-out infinite;
        }

        @keyframes badgePulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .widget-collapse-btn {
            width: 20px;
            height: 20px;
            background: transparent;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            border-radius: 4px;
            transition: background 0.2s ease;
        }

        .widget-collapse-btn:hover {
            background: rgba(var(--widget-color-rgb), 0.2);
        }

        .widget-collapse-btn svg {
            width: 14px;
            height: 14px;
            color: rgba(255,255,255,0.6);
            transition: transform 0.3s ease;
        }

        .widget-card.collapsed .widget-collapse-btn svg {
            transform: rotate(-90deg);
        }

        /* Widget Body */
        .widget-body {
            padding: 12px;
            max-height: 400px;
            overflow-y: auto;
            overflow-x: hidden;
            transition: max-height 0.3s ease,
                        padding 0.3s ease,
                        opacity 0.2s ease;
        }

        .widget-body::-webkit-scrollbar {
            width: 4px;
        }
        .widget-body::-webkit-scrollbar-track {
            background: transparent;
        }
        .widget-body::-webkit-scrollbar-thumb {
            background: rgba(var(--widget-color-rgb), 0.4);
            border-radius: 2px;
        }

        .widget-card.collapsed .widget-body {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            opacity: 0;
            overflow: hidden;
        }

        /* Widget Status Indicator */
        .widget-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 10px;
            color: rgba(255,255,255,0.5);
        }

        .widget-status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--widget-color);
        }

        .widget-status-dot.active {
            animation: statusPulse 1.5s ease-in-out infinite;
        }

        @keyframes statusPulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 4px var(--widget-color); }
            50% { opacity: 0.5; box-shadow: 0 0 8px var(--widget-color); }
        }

        /* Cockpit-BW Theme Override */
        [data-theme="cockpit-bw"] .widget-card {
            background: rgba(0, 0, 0, 0.85);
            border-color: rgba(255, 255, 255, 0.2);
        }

        [data-theme="cockpit-bw"] .widget-card:hover {
            border-color: rgba(255, 255, 255, 0.4);
        }

        [data-theme="cockpit-bw"] .widget-header {
            background: linear-gradient(90deg,
                rgba(255,255,255,0.08) 0%,
                rgba(255,255,255,0.02) 100%);
            border-bottom-color: rgba(255,255,255,0.15);
        }

        [data-theme="cockpit-bw"] .widget-icon,
        [data-theme="cockpit-bw"] .widget-title-text {
            color: #ffffff;
        }

        [data-theme="cockpit-bw"] .widget-badge {
            background: rgba(255,255,255,0.15);
            color: #ffffff;
        }

        [data-theme="cockpit-bw"] .sidebar-toggle-btn {
            border-color: rgba(255,255,255,0.3);
        }

        [data-theme="cockpit-bw"] .sidebar-toggle-btn:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.5);
        }

        [data-theme="cockpit-bw"] .sidebar-toggle-btn svg {
            color: #ffffff;
        }

        /* ═══════════════════════════════════════════════════════════════
           END OF PREMIUM WIDGET SYSTEM
           ═══════════════════════════════════════════════════════════════ */

        /* Sol Panel - Tactical Display (Legacy support) */
        .side-panel {
            position: fixed;
            top: 70px;
            left: 16px;
            width: 220px;
            z-index: 1000;
            display: flex !important;
            flex-direction: column;
            gap: 10px;
            max-height: calc(100vh - 180px);
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 4px;
            scrollbar-width: thin;
            scrollbar-color: rgba(0, 180, 255, 0.5) transparent;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .side-panel::-webkit-scrollbar {
            width: 6px;
        }
        .side-panel::-webkit-scrollbar-track {
            background: transparent;
        }
        .side-panel::-webkit-scrollbar-thumb {
            background: rgba(0, 180, 255, 0.5);
            border-radius: 3px;
        }
        .side-panel::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 180, 255, 0.8);
        }

        /* iframe icinde yuklendiginde sadece navigasyon menusunu gizle, diger paneller kalsın */
        body.in-iframe .side-panel .nav-panel {
            display: none !important;
        }

        body.in-iframe .top-bar {
            left: 0 !important;
        }

        body.in-iframe #map {
            left: 0 !important;
        }

        /* ═══════════════════════════════════════════════════════════════
           /panel#harita İÇİN ÖZEL STİLLER (iframe modu)
           Bu stiller harita iframe içinde yüklendiğinde aktif olur
           ═══════════════════════════════════════════════════════════════ */

        /* iframe'de side-panel'i GÖRÜNÜR TUT - ÖNCELİKLİ */
        body.in-iframe .side-panel {
            display: flex !important;
            flex-direction: column !important;
            position: fixed !important;
            width: 215px !important;
            top: 70px !important;
            left: 5px !important;
            max-height: calc(100vh - 80px) !important;
            z-index: 1000 !important;
            opacity: 1 !important;
            visibility: visible !important;
            transform: none !important;
            background: rgba(0, 15, 25, 0.95) !important;
            border: 1px solid rgba(0, 180, 255, 0.3) !important;
            border-radius: 10px !important;
            padding: 8px !important;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.6) !important;
        }

        /* iframe'de Canlı Saldırılar widget'ını küçült */
        body.in-iframe [data-widget-id="attacksPanel"] {
            order: 1;
            max-height: 120px;
        }

        body.in-iframe [data-widget-id="attacksPanel"] .attack-feed {
            max-height: 70px;
            overflow-y: auto;
        }

        /* iframe'de SİBER KOMUTA widget - EN ÜSTTE VE BELİRGİN */
        body.in-iframe #siberKomutaWidget,
        body.in-iframe .siber-komuta-widget {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            order: -100 !important;
            border: 2px solid #00ff88 !important;
            box-shadow: 0 0 25px rgba(0, 255, 136, 0.5), inset 0 0 20px rgba(0, 255, 136, 0.1) !important;
            animation: siberPulseIframe 2s ease-in-out infinite;
            background: linear-gradient(135deg, rgba(0, 40, 20, 0.98), rgba(0, 30, 40, 0.95)) !important;
            margin-bottom: 8px !important;
        }

        /* Normal modda da siber widget görünür */
        #siberKomutaWidget,
        .siber-komuta-widget {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        body.in-iframe #siberKomutaWidget .panel-header,
        body.in-iframe .siber-komuta-widget .panel-header {
            background: linear-gradient(90deg, rgba(0, 255, 136, 0.3), rgba(0, 100, 80, 0.2)) !important;
            color: #00ff88 !important;
            font-weight: bold;
            padding: 8px 12px;
        }

        @keyframes siberPulseIframe {
            0%, 100% {
                box-shadow: 0 0 20px rgba(0, 255, 136, 0.4), inset 0 0 15px rgba(0, 255, 136, 0.05);
                border-color: rgba(0, 255, 136, 0.6);
            }
            50% {
                box-shadow: 0 0 40px rgba(0, 255, 136, 0.7), inset 0 0 25px rgba(0, 255, 136, 0.15);
                border-color: #00ff88;
            }
        }

        /* iframe'de widget'lar görünür - kompakt stil */
        body.in-iframe [data-widget-id="torPanel"],
        body.in-iframe [data-widget-id="agentsPanel"],
        body.in-iframe [data-widget-id="geoAnalysisPanel"],
        body.in-iframe [data-widget-id="globalOsintPanel"] {
            display: block !important;
            max-height: 200px;
            overflow-y: auto;
        }

        /* iframe'de genel panel stilleri */
        body.in-iframe .panel {
            margin-bottom: 6px;
            border-radius: 8px;
        }

        body.in-iframe .panel-body {
            padding: 8px;
            font-size: 10px;
        }

        body.in-iframe .panel-header {
            padding: 6px 10px;
            font-size: 10px;
        }

        /* iframe'de siber stilleri */
        body.in-iframe .siber-stats {
            grid-template-columns: repeat(3, 1fr);
            gap: 4px;
        }

        body.in-iframe .siber-stat {
            padding: 5px 4px;
        }

        body.in-iframe .siber-stat-value {
            font-size: 14px;
            color: #00ff88;
        }

        body.in-iframe .siber-osint-input {
            margin-bottom: 8px;
        }

        body.in-iframe .siber-osint-input input {
            padding: 6px 8px;
            font-size: 10px;
        }

        body.in-iframe .siber-agents-mini {
            max-height: 100px;
        }

        body.in-iframe .siber-action-btns {
            gap: 4px;
        }

        body.in-iframe .siber-action-btn {
            padding: 6px 8px;
            font-size: 9px;
            background: rgba(0, 255, 136, 0.15);
            border-color: rgba(0, 255, 136, 0.4);
            color: #00ff88;
        }

        body.in-iframe .siber-action-btn:hover {
            background: rgba(0, 255, 136, 0.3);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.4);
        }

        .panel {
            background: var(--bg-panel);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
        }

        .panel-header {
            padding: 10px 14px;
            border-bottom: 1px solid var(--border-glow);
            background: linear-gradient(135deg, rgba(0, 180, 255, 0.1), rgba(0, 180, 255, 0.05));
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--accent-primary);
            font-weight: 700;
            font-family: 'Orbitron', monospace;
        }

        .panel-body {
            padding: 12px;
        }

        .metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .metric {
            background: var(--bg-glass);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid var(--border-subtle);
        }

        .metric:hover {
            background: rgba(0, 180, 255, 0.15);
            border-color: var(--border-glow);
            box-shadow: 0 0 15px var(--border-glow);
        }

        .metric .val {
            font-size: 22px;
            font-weight: 800;
            font-family: 'Orbitron', monospace;
        }

        .metric .lbl {
            font-size: 9px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 4px;
        }

        .metric.wifi .val { color: var(--hud-cyan); text-shadow: 0 0 10px var(--hud-cyan); }
        .metric.bt .val { color: var(--accent-purple); text-shadow: 0 0 10px var(--accent-purple); }
        .metric.baz .val { color: var(--hud-green); text-shadow: 0 0 10px var(--hud-green); }
        .metric.atk .val { color: var(--accent-danger); text-shadow: 0 0 10px var(--accent-danger); }

        /* Saldiri Feed - Threat Display */
        .attack-feed {
            max-height: 180px;
            overflow-y: auto;
        }

        .atk-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border-bottom: 1px solid var(--border-subtle);
            font-size: 10px;
            animation: fadeIn 0.4s;
            transition: all 0.2s;
        }

        .atk-item:hover {
            background: var(--bg-glass);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .atk-item:last-child { border: none; }

        .atk-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .atk-dot.critical { background: var(--accent-danger); box-shadow: 0 0 8px var(--accent-danger); }
        .atk-dot.high { background: var(--accent-warning); box-shadow: 0 0 8px var(--accent-warning); }
        .atk-dot.medium { background: var(--hud-amber); box-shadow: 0 0 8px var(--hud-amber); }
        .atk-dot.low { background: var(--hud-cyan); box-shadow: 0 0 8px var(--hud-cyan); }

        .atk-info {
            flex: 1;
            min-width: 0;
        }

        .atk-type {
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .atk-target {
            color: var(--text-dim);
            font-family: 'JetBrains Mono', monospace;
            font-size: 9px;
        }

        .atk-time {
            color: var(--text-dim);
            font-size: 9px;
        }

        /* Agent Durumu - System Status */
        .agent-list {
            font-size: 10px;
        }

        .agent-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid var(--border-subtle);
        }

        .agent-item:last-child { border: none; }

        .agent-name {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .agent-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--hud-green);
            box-shadow: 0 0 8px var(--hud-green);
        }

        .agent-dot.idle {
            background: var(--text-dim);
            box-shadow: none;
        }

        .agent-status {
            color: var(--text-dim);
            font-size: 9px;
        }

        .agent-status--aktif {
            color: #00ff88 !important;
            font-weight: bold;
        }

        .agent-status--calisiyor {
            color: #00b4ff !important;
            animation: agentPulse 1s infinite;
        }

        .agent-status--hata {
            color: #ff3355 !important;
        }

        .agent-dot--aktif {
            background: #00ff88 !important;
            box-shadow: 0 0 10px #00ff88 !important;
        }

        .agent-dot--calisiyor {
            background: #00b4ff !important;
            box-shadow: 0 0 10px #00b4ff !important;
            animation: agentPulse 1s infinite;
        }

        .agent-dot--hata {
            background: #ff3355 !important;
            box-shadow: 0 0 10px #ff3355 !important;
        }

        @keyframes agentPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .agent-item {
            cursor: pointer;
            transition: all 0.2s;
        }

        .agent-item:hover {
            background: rgba(0,180,255,0.1);
            border-radius: 4px;
        }

        /* Terminal - Command Interface */
        .terminal-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: var(--bg-panel);
            border-top: 2px solid var(--accent-primary);
            height: 42px;
            transition: height 0.3s;
            box-shadow: 0 -4px 20px rgba(0, 180, 255, 0.15);
        }

        .terminal-bar.expanded { height: 200px; }

        .terminal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 16px;
            height: 42px;
            cursor: pointer;
            background: linear-gradient(90deg, rgba(0, 180, 255, 0.08), transparent);
        }

        .terminal-title {
            font-family: 'Orbitron', monospace;
            font-size: 12px;
            font-weight: 700;
            color: var(--accent-primary);
            display: flex;
            align-items: center;
            gap: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .term-badge {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 9px;
            background: rgba(0, 255, 136, 0.25);
            color: var(--hud-green);
            font-weight: 700;
            border: 1px solid var(--hud-green);
        }

        .term-badge.off {
            background: rgba(255, 51, 85, 0.25);
            color: var(--accent-danger);
            border-color: var(--accent-danger);
        }

        .term-btns {
            display: flex;
            gap: 6px;
        }

        .term-btns button {
            padding: 4px 10px;
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            background: var(--bg-glass);
            color: var(--text-dim);
            font-size: 10px;
            cursor: pointer;
            font-family: 'JetBrains Mono', monospace;
            transition: all 0.2s;
        }

        .term-btns button:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            background: var(--bg-card);
        }

        .terminal-body {
            display: none;
            height: calc(100% - 42px);
            padding: 10px 16px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            overflow-y: auto;
            background: var(--bg-deep);
        }

        .terminal-bar.expanded .terminal-body { display: block; }

        .term-output {
            white-space: pre-wrap;
            color: var(--text-dim);
        }

        .term-output .ok { color: var(--hud-green); }
        .term-output .err { color: var(--accent-danger); }
        .term-output .warn { color: var(--accent-warning); }
        .term-output .info { color: var(--hud-cyan); }

        .term-input-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }

        .term-prompt {
            color: var(--accent-primary);
            font-weight: 700;
        }

        .term-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-bright);
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            outline: none;
        }

        /* Lejant - Legend Display */
        .legend {
            position: fixed;
            bottom: 55px;
            right: 16px;
            z-index: 900;
            background: var(--bg-panel);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: 10px 14px;
            backdrop-filter: blur(10px);
        }

        .legend h4 {
            font-size: 9px;
            color: var(--text-dim);
            margin-bottom: 8px;
            text-transform: uppercase;
            font-family: 'Orbitron', monospace;
            letter-spacing: 1px;
        }

        .leg-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 10px;
            margin-bottom: 4px;
        }

        .leg-item .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .leg-divider {
            height: 1px;
            background: var(--border-subtle);
            margin: 8px 0;
        }

        .leg-toggle {
            cursor: pointer;
            user-select: none;
            transition: color 0.2s;
        }

        .leg-toggle:hover {
            color: var(--accent-primary);
        }

        .kritik-legend {
            max-height: 180px;
            overflow-y: auto;
            transition: max-height 0.3s ease;
        }

        .kritik-legend.collapsed {
            max-height: 0;
            overflow: hidden;
        }

        .kritik-dot {
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 16px !important;
            height: 16px !important;
            background: #ff0000;
            border-radius: 50%;
            box-shadow: 0 0 8px currentColor;
        }

        .leg-stats {
            padding-top: 4px;
        }

        .leg-stat-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 10px;
        }

        .leg-stat-num {
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            color: var(--accent-primary);
            font-size: 14px;
        }

        .leg-stat-label {
            color: var(--text-dim);
            font-size: 9px;
            text-transform: uppercase;
        }

        /* Geo Analiz Panel */
        .geo-panel {
            position: fixed;
            top: 80px;
            left: 20px;
            background: linear-gradient(180deg, rgba(0,15,25,0.95) 0%, rgba(0,10,20,0.98) 100%);
            border: 1px solid rgba(0,255,170,0.3);
            border-radius: 8px;
            padding: 12px;
            z-index: 1500;
            min-width: 200px;
            max-width: 280px;
            display: none;
            box-shadow: 0 0 30px rgba(0,255,170,0.2), inset 0 0 10px rgba(0,0,0,0.5);
        }

        .geo-panel.active {
            display: block;
            animation: panelIn 0.3s ease;
        }

        @keyframes panelIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .geo-panel h4 {
            color: var(--hud-cyan);
            font-size: 12px;
            margin: 0 0 10px 0;
            border-bottom: 1px solid rgba(0,255,170,0.2);
            padding-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .geo-panel .close-btn {
            cursor: pointer;
            opacity: 0.7;
        }

        .geo-panel .close-btn:hover {
            opacity: 1;
        }

        .geo-layer-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            margin-bottom: 4px;
            background: rgba(0,20,40,0.5);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .geo-layer-toggle:hover {
            background: rgba(0,255,170,0.1);
        }

        .geo-layer-toggle.active {
            background: rgba(0,255,170,0.15);
            border-left: 2px solid var(--hud-cyan);
        }

        .geo-layer-toggle input[type="checkbox"] {
            accent-color: var(--hud-cyan);
        }

        .geo-layer-toggle label {
            font-size: 11px;
            cursor: pointer;
        }

        .geo-stats {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(0,255,170,0.2);
        }

        .geo-stat-row {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            padding: 3px 0;
        }

        .geo-stat-row .label {
            color: var(--text-dim);
        }

        .geo-stat-row .value {
            color: var(--hud-cyan);
            font-weight: bold;
        }

        .geo-btn {
            width: 100%;
            margin-top: 8px;
            padding: 8px 12px;
            background: linear-gradient(135deg, rgba(0, 40, 80, 0.85), rgba(0, 60, 100, 0.7));
            border: 1px solid var(--border-glow);
            color: var(--hud-cyan);
            font-size: 10px;
            font-family: 'Orbitron', monospace;
            font-weight: 500;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .geo-btn:hover {
            background: linear-gradient(135deg, rgba(0, 60, 100, 0.9), rgba(0, 80, 120, 0.8));
            border-color: var(--hud-cyan);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 180, 255, 0.3);
            color: var(--text-bright);
        }

        /* ==================== EAGLE EYE COMMAND CENTER ==================== */
        .eagle-command-center {
            position: fixed;
            top: 70px;
            right: 16px;
            width: 380px;
            max-height: calc(100vh - 100px);
            background: linear-gradient(180deg, rgba(0,8,16,0.98) 0%, rgba(0,4,10,0.99) 100%);
            border: 1px solid rgba(0,200,255,0.4);
            border-radius: 12px;
            z-index: 2000;
            overflow: hidden;
            box-shadow: 0 0 60px rgba(0,200,255,0.3), 0 0 120px rgba(0,100,200,0.15), inset 0 0 30px rgba(0,0,0,0.8);
            font-family: 'Inter', 'Segoe UI', sans-serif;
        }

        .eagle-header {
            background: linear-gradient(90deg, rgba(0,150,255,0.15) 0%, rgba(255,100,0,0.1) 50%, rgba(0,200,100,0.1) 100%);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid rgba(0,200,255,0.3);
        }

        .eagle-title {
            flex: 1;
        }

        .eagle-icon {
            font-size: 24px;
            margin-right: 8px;
            animation: eaglePulse 2s ease-in-out infinite;
        }

        @keyframes eaglePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes feedSlideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes alertBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .eagle-text {
            font-size: 14px;
            font-weight: 700;
            color: #00d4ff;
            letter-spacing: 2px;
            text-shadow: 0 0 10px rgba(0,212,255,0.5);
        }

        .eagle-subtitle {
            display: block;
            font-size: 9px;
            color: rgba(255,255,255,0.5);
            letter-spacing: 1px;
            margin-top: 2px;
        }

        .eagle-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 10px;
            color: #ff4444;
            font-weight: 600;
        }

        .eagle-live-indicator {
            width: 8px;
            height: 8px;
            background: #ff4444;
            border-radius: 50%;
            animation: liveGlow 1s ease-in-out infinite;
        }

        @keyframes liveGlow {
            0%, 100% { box-shadow: 0 0 5px #ff4444, 0 0 10px #ff4444; opacity: 1; }
            50% { box-shadow: 0 0 15px #ff4444, 0 0 30px #ff4444; opacity: 0.7; }
        }

        .eagle-close {
            background: transparent;
            border: 1px solid rgba(255,100,100,0.3);
            color: rgba(255,100,100,0.7);
            width: 28px;
            height: 28px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
        }

        .eagle-close:hover {
            background: rgba(255,100,100,0.2);
            color: #ff4444;
        }

        .eagle-search-bar {
            padding: 10px 16px;
            display: flex;
            gap: 8px;
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid rgba(0,200,255,0.2);
        }

        .eagle-search-bar input {
            flex: 1;
            padding: 10px 14px;
            background: rgba(0,20,40,0.8);
            border: 1px solid rgba(0,200,255,0.3);
            border-radius: 8px;
            color: #fff;
            font-size: 12px;
            outline: none;
            transition: all 0.2s;
        }

        .eagle-search-bar input:focus {
            border-color: rgba(0,200,255,0.6);
            box-shadow: 0 0 15px rgba(0,200,255,0.2);
        }

        .eagle-search-bar button {
            padding: 10px 20px;
            background: linear-gradient(135deg, rgba(0,200,255,0.3) 0%, rgba(0,150,200,0.2) 100%);
            border: 1px solid rgba(0,200,255,0.5);
            border-radius: 8px;
            color: #00d4ff;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .eagle-search-bar button:hover {
            background: linear-gradient(135deg, rgba(0,200,255,0.4) 0%, rgba(0,150,200,0.3) 100%);
            box-shadow: 0 0 20px rgba(0,200,255,0.3);
        }

        .eagle-tabs {
            display: flex;
            padding: 0 8px;
            background: rgba(0,0,0,0.4);
            border-bottom: 1px solid rgba(0,200,255,0.2);
        }

        .eagle-tab {
            flex: 1;
            padding: 10px 8px;
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.5);
            font-size: 10px;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .eagle-tab:hover {
            color: rgba(255,255,255,0.8);
            background: rgba(0,200,255,0.05);
        }

        .eagle-tab.active {
            color: #00d4ff;
            border-bottom-color: #00d4ff;
            background: rgba(0,200,255,0.1);
        }

        .eagle-tab-content {
            display: none;
            padding: 12px 16px;
            max-height: calc(100vh - 350px);
            overflow-y: auto;
        }

        .eagle-tab-content.active {
            display: block;
        }

        .eagle-tab-content::-webkit-scrollbar {
            width: 4px;
        }

        .eagle-tab-content::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.3);
        }

        .eagle-tab-content::-webkit-scrollbar-thumb {
            background: rgba(0,200,255,0.3);
            border-radius: 2px;
        }

        .eagle-live-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .eagle-stat {
            background: rgba(0,20,40,0.6);
            border-radius: 8px;
            padding: 10px 8px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .eagle-stat.critical { border-color: rgba(255,100,100,0.4); background: rgba(255,50,50,0.1); }
        .eagle-stat.warning { border-color: rgba(255,180,0,0.4); background: rgba(255,150,0,0.1); }
        .eagle-stat.info { border-color: rgba(0,200,255,0.4); background: rgba(0,150,200,0.1); }
        .eagle-stat.danger { border-color: rgba(200,0,255,0.4); background: rgba(150,0,200,0.1); }

        .eagle-stat .stat-icon {
            font-size: 18px;
            display: block;
        }

        .eagle-stat .stat-value {
            font-size: 18px;
            font-weight: 700;
            color: #fff;
            display: block;
            font-family: 'Orbitron', monospace;
        }

        .eagle-stat .stat-label {
            font-size: 8px;
            color: rgba(255,255,255,0.5);
            text-transform: uppercase;
        }

        .eagle-feed-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            color: var(--accent-cyan);
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid rgba(0,200,255,0.2);
        }

        .eagle-live-feed {
            max-height: 200px;
            overflow-y: auto;
        }

        .eagle-feed-item {
            padding: 10px 12px;
            background: rgba(0,20,40,0.5);
            border-radius: 6px;
            margin-bottom: 6px;
            border-left: 3px solid var(--accent-cyan);
            font-size: 11px;
            transition: all 0.2s;
        }

        .eagle-feed-item:hover {
            background: rgba(0,30,60,0.6);
            transform: translateX(4px);
        }

        .eagle-feed-item.critical { border-left-color: #ff4444; }
        .eagle-feed-item.high { border-left-color: #ff9900; }
        .eagle-feed-item.medium { border-left-color: #ffcc00; }
        .eagle-feed-item.loading { color: var(--text-dim); text-align: center; }

        .eagle-feed-item .feed-title {
            font-weight: 600;
            color: #fff;
            margin-bottom: 4px;
        }

        .eagle-feed-item .feed-desc {
            color: rgba(255,255,255,0.6);
            font-size: 10px;
        }

        .eagle-feed-item .feed-time {
            color: rgba(255,255,255,0.4);
            font-size: 9px;
            margin-top: 4px;
        }

        .eagle-section-title {
            font-size: 11px;
            color: var(--accent-cyan);
            font-weight: 600;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid rgba(0,200,255,0.2);
        }

        .eagle-layer-section {
            margin-bottom: 16px;
        }

        .eagle-layer-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: rgba(0,20,40,0.4);
            border-radius: 6px;
            margin-bottom: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .eagle-layer-toggle:hover {
            background: rgba(0,40,80,0.5);
        }

        .eagle-layer-toggle input {
            accent-color: var(--accent-cyan);
        }

        .eagle-layer-toggle label {
            font-size: 11px;
            color: rgba(255,255,255,0.8);
            cursor: pointer;
        }

        .eagle-btn {
            width: 100%;
            padding: 10px 16px;
            background: linear-gradient(135deg, rgba(0,200,255,0.2) 0%, rgba(0,150,200,0.1) 100%);
            border: 1px solid rgba(0,200,255,0.4);
            border-radius: 6px;
            color: var(--accent-cyan);
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .eagle-btn:hover {
            background: linear-gradient(135deg, rgba(0,200,255,0.3) 0%, rgba(0,150,200,0.2) 100%);
            box-shadow: 0 0 20px rgba(0,200,255,0.2);
        }

        .eagle-osint-search input {
            width: 100%;
            padding: 10px 14px;
            background: rgba(0,20,40,0.8);
            border: 1px solid rgba(0,200,255,0.3);
            border-radius: 6px;
            color: #fff;
            font-size: 11px;
            margin-bottom: 8px;
            box-sizing: border-box;
        }

        .eagle-osint-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
        }

        .eagle-osint-buttons button {
            padding: 8px;
            background: rgba(0,40,80,0.5);
            border: 1px solid rgba(0,200,255,0.3);
            border-radius: 4px;
            color: var(--accent-cyan);
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .eagle-osint-buttons button:hover {
            background: rgba(0,60,120,0.6);
            border-color: rgba(0,200,255,0.6);
        }

        .eagle-alert-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .eagle-alert-filters select {
            flex: 1;
            padding: 8px;
            background: rgba(0,20,40,0.8);
            border: 1px solid rgba(0,200,255,0.3);
            border-radius: 6px;
            color: #fff;
            font-size: 10px;
        }

        .eagle-alerts-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .eagle-footer {
            display: flex;
            justify-content: space-around;
            padding: 10px 16px;
            background: rgba(0,0,0,0.5);
            border-top: 1px solid rgba(0,200,255,0.2);
        }

        .eagle-footer-stat {
            font-size: 9px;
            color: rgba(255,255,255,0.6);
        }

        .eagle-footer-stat span:first-child {
            margin-right: 4px;
        }

        /* Hotspot ve Risk göstergeleri */
        .hotspot-marker {
            background: radial-gradient(circle, rgba(255,0,0,0.8) 0%, rgba(255,0,0,0) 70%);
            border-radius: 50%;
            animation: hotspotPulse 2s ease-in-out infinite;
        }

        @keyframes hotspotPulse {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.2); opacity: 0.5; }
        }

        .risk-popup {
            background: rgba(20,0,0,0.95);
            border: 1px solid rgba(255,0,0,0.5);
            border-radius: 6px;
            padding: 10px;
        }

        .risk-popup .risk-header {
            color: #ff4444;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .risk-popup .risk-score {
            font-size: 24px;
            font-weight: bold;
            color: #ff6666;
        }

        /* Saldiri Tooltip - Threat Details */
        .attack-tooltip {
            position: fixed;
            z-index: 2000;
            display: none;
            background: var(--bg-panel);
            border: 1px solid var(--border-glow);
            border-radius: 10px;
            padding: 14px;
            min-width: 280px;
            max-width: 340px;
            box-shadow: 0 10px 40px rgba(0, 180, 255, 0.3), 0 0 60px rgba(0, 180, 255, 0.15);
            backdrop-filter: blur(15px);
            transform: translateX(-50%);
            pointer-events: auto;
        }

        .attack-tooltip::before {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid var(--border-glow);
        }

        .attack-tooltip::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid var(--bg-panel);
        }

        .attack-tooltip.visible { display: block; }

        .attack-tooltip.pinned {
            box-shadow: 0 0 30px rgba(0, 180, 255, 0.5), 0 10px 40px rgba(0, 0, 0, 0.6);
            border-color: var(--hud-cyan);
            z-index: 10000;
        }

        .attack-tooltip.pinned .tooltip-close {
            display: flex;
            background: var(--accent-danger);
            color: white;
        }

        .attack-tooltip.feed-mode {
            transform: none;
        }

        .attack-tooltip.feed-mode::before,
        .attack-tooltip.feed-mode::after {
            display: none;
        }

        .tooltip-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .tooltip-type {
            font-weight: 800;
            font-size: 13px;
            font-family: 'Orbitron', monospace;
        }

        .tooltip-severity {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: 700;
            font-family: 'Orbitron', monospace;
        }

        .tooltip-severity.critical {
            background: rgba(255, 51, 85, 0.3);
            color: var(--accent-danger);
            border: 1px solid var(--accent-danger);
        }

        .tooltip-severity.high {
            background: rgba(255, 170, 0, 0.3);
            color: var(--accent-warning);
            border: 1px solid var(--accent-warning);
        }

        .tooltip-row {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            padding: 4px 0;
            border-bottom: 1px solid var(--border-subtle);
        }

        .tooltip-row:last-child { border: none; }

        .tooltip-row .label {
            color: var(--text-dim);
        }

        .tooltip-row .value {
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-bright);
        }

        .tooltip-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding-top: 10px;
            border-top: 1px solid var(--border-glow);
        }

        .tt-btn {
            flex: 1;
            padding: 6px 10px;
            border: none;
            border-radius: 5px;
            font-size: 9px;
            font-weight: 700;
            font-family: 'Orbitron', monospace;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .tt-btn svg {
            width: 12px;
            height: 12px;
            fill: currentColor;
            flex-shrink: 0;
        }

        .tt-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .tt-btn.danger {
            background: linear-gradient(135deg, var(--accent-danger), #cc0033);
            color: #fff;
        }

        .tt-btn.primary {
            background: linear-gradient(135deg, var(--accent-primary), #0088cc);
            color: #fff;
        }

        .tt-btn.secondary {
            background: linear-gradient(135deg, var(--accent-purple), #6633cc);
            color: #fff;
        }

        .tt-btn.ai-btn {
            background: linear-gradient(135deg, #00c853, #009624);
            color: #fff;
        }

        /* Live Threat Stream Button Styles */
        .canli-tehdit-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .stream-start-btn {
            background: linear-gradient(135deg, #00c853, #009624);
            color: #fff;
        }

        .stream-start-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #00e676, #00b248);
            box-shadow: 0 0 20px rgba(0, 200, 83, 0.5);
        }

        .stream-start-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .stream-stop-btn {
            background: linear-gradient(135deg, var(--accent-danger), #cc0033);
            color: #fff;
        }

        .stream-stop-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #ff1744, #d50000);
            box-shadow: 0 0 20px rgba(255, 23, 68, 0.5);
        }

        .stream-stop-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* AI Prediction Button Styles */
        .ai-tahmin-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .ai-btn {
            background: linear-gradient(135deg, #6c5ce7, #4834d4);
            color: #fff;
            position: relative;
            overflow: hidden;
        }

        .ai-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

        .ai-btn:hover::before {
            left: 100%;
        }

        .ai-btn:hover {
            background: linear-gradient(135deg, #a29bfe, #6c5ce7);
            box-shadow: 0 0 20px rgba(108, 92, 231, 0.5);
            transform: translateY(-2px);
        }

        .ai-btn:active {
            transform: translateY(0);
        }

        /* Live Threat Marker Pulse Animation */
        .live-threat-marker {
            animation: marker-pulse 2s ease-in-out infinite;
        }

        @keyframes marker-pulse {
            0%, 100% {
                filter: brightness(1);
            }
            50% {
                filter: brightness(1.3);
            }
        }

        .pulse-marker {
            box-shadow: 0 0 10px currentColor;
        }

        .tt-btn.counter-btn {
            background: linear-gradient(135deg, #ff6d00, #e65100);
            color: #fff;
        }

        .tt-btn.watch-btn {
            background: linear-gradient(135deg, #2979ff, #0d47a1);
            color: #fff;
        }

        .tt-btn.shodan-btn {
            background: linear-gradient(135deg, #00bcd4, #00838f);
            color: #fff;
        }

        .tt-btn.cell-btn {
            background: linear-gradient(135deg, #7c4dff, #651fff);
            color: #fff;
        }

        .tt-btn.vuln-btn {
            background: linear-gradient(135deg, #ff5722, #bf360c);
            color: #fff;
        }

        .tooltip-close {
            position: absolute;
            top: 8px;
            right: 10px;
            font-size: 18px;
            color: var(--text-dim);
            cursor: pointer;
            transition: color 0.2s;
            line-height: 1;
        }

        .tooltip-close:hover {
            color: var(--accent-danger);
        }

        .tsunami-power {
            border-top: 1px dashed var(--accent-primary) !important;
            margin-top: 8px;
            padding-top: 8px !important;
        }

        .tt-btn.ai-btn {
            background: linear-gradient(135deg, #ff00ff, #8855ff);
            color: #fff;
        }

        .tt-btn.counter-btn {
            background: linear-gradient(135deg, #ff3355, #ff6600);
            color: #fff;
        }

        .tt-btn.watch-btn {
            background: linear-gradient(135deg, #00ff88, #00b4ff);
            color: var(--bg-void);
        }

        /* Shodan/OpenCellID butonları */
        .shodan-actions {
            border-top: 1px dashed #0ff !important;
            margin-top: 8px;
            padding-top: 8px !important;
        }

        .tt-btn.shodan-btn {
            background: linear-gradient(135deg, #00bcd4, #0097a7);
            color: #fff;
        }

        .tt-btn.cell-btn {
            background: linear-gradient(135deg, #4caf50, #388e3c);
            color: #fff;
        }

        .tt-btn.vuln-btn {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: #fff;
        }

        /* SİBER KOMUTA Buton Stilleri */
        .tooltip-actions.siber-actions {
            border-top: 1px dashed #00ff88 !important;
            margin-top: 8px;
            padding-top: 8px !important;
            background: rgba(0, 255, 136, 0.05);
        }

        .tt-btn.siber-btn {
            background: linear-gradient(135deg, #00ff88, #00c853);
            color: #000;
            font-weight: bold;
        }

        .tt-btn.tehdit-btn {
            background: linear-gradient(135deg, #ff3355, #c62828);
            color: #fff;
        }

        .tt-btn.ajan-btn {
            background: linear-gradient(135deg, #7c4dff, #512da8);
            color: #fff;
        }

        .tt-btn.ucak-btn {
            background: linear-gradient(135deg, #00b4ff, #0277bd);
            color: #fff;
        }

        /* Shodan marker stilleri */
        .shodan-marker .shodan-icon {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 2px solid #0ff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }

        .cell-tower-marker .tower-icon {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 3px solid;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.3);
        }

        .vuln-marker {
            position: relative;
        }

        .vuln-marker .vuln-icon {
            font-size: 24px;
            animation: vulmPulse 1.5s infinite;
        }

        .vuln-marker .vuln-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff0000;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes vulmPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        /* Shodan Panel */
        .shodan-panel {
            position: fixed;
            right: 20px;
            top: 80px;
            width: 350px;
            max-height: 80vh;
            background: var(--bg-panel);
            border: 1px solid var(--accent-primary);
            border-radius: 10px;
            box-shadow: var(--shadow-glow);
            z-index: 1500;
            overflow: hidden;
        }

        .shodan-panel .panel-header {
            background: linear-gradient(135deg, #0a0a0f, #0d1117);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-glow);
        }

        .shodan-panel .panel-header h3 {
            margin: 0;
            color: #0ff;
            font-size: 14px;
        }

        .shodan-panel .close-btn {
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 20px;
            cursor: pointer;
        }

        .shodan-panel .panel-tabs {
            display: flex;
            background: var(--bg-void);
        }

        .shodan-panel .tab-btn {
            flex: 1;
            padding: 10px;
            background: none;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            font-size: 11px;
            font-family: 'Orbitron', monospace;
        }

        .shodan-panel .tab-btn.active {
            background: var(--bg-panel);
            color: var(--accent-primary);
            border-bottom: 2px solid var(--accent-primary);
        }

        .shodan-panel .panel-content {
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .shodan-panel .tab-content {
            display: none;
        }

        .shodan-panel .tab-content.active {
            display: block;
        }

        .shodan-panel .search-group {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .shodan-panel .search-group input {
            flex: 1;
            padding: 8px;
            background: var(--bg-void);
            border: 1px solid var(--border-glow);
            color: var(--text-bright);
            border-radius: 5px;
            font-size: 12px;
        }

        .shodan-panel .search-group button {
            padding: 8px 15px;
            background: var(--accent-primary);
            border: none;
            border-radius: 5px;
            color: var(--bg-void);
            cursor: pointer;
            font-weight: bold;
        }

        .shodan-panel .quick-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .shodan-panel .quick-filters button {
            padding: 5px 10px;
            background: var(--bg-darker);
            border: 1px solid var(--border-glow);
            color: var(--text-dim);
            border-radius: 3px;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .shodan-panel .quick-filters button:hover {
            background: var(--accent-primary);
            color: var(--bg-void);
        }

        .shodan-panel .results-area {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .shodan-panel .result-item {
            padding: 8px;
            margin-bottom: 5px;
            background: var(--bg-darker);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .shodan-panel .result-item:hover {
            background: var(--accent-primary);
            color: var(--bg-void);
        }

        .shodan-panel .result-ip {
            font-weight: bold;
            font-family: 'JetBrains Mono', monospace;
            color: #0ff;
        }

        .shodan-panel .result-info {
            font-size: 10px;
            color: var(--text-dim);
        }

        .shodan-panel .panel-stats {
            display: flex;
            justify-content: space-around;
            padding: 15px;
            background: var(--bg-void);
            border-top: 1px solid var(--border-glow);
        }

        .shodan-panel .stat {
            text-align: center;
        }

        .shodan-panel .stat-value {
            display: block;
            font-size: 18px;
            font-weight: bold;
            color: var(--accent-primary);
            font-family: 'Orbitron', monospace;
        }

        .shodan-panel .stat-label {
            font-size: 10px;
            color: var(--text-dim);
        }

        /* Shodan/Cell popup stilleri */
        .shodan-popup, .tower-popup, .vuln-popup {
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .shodan-popup h4, .tower-popup h4, .vuln-popup h4 {
            margin: 0 0 8px 0;
            color: #0ff;
            border-bottom: 1px solid rgba(0,255,255,0.3);
            padding-bottom: 5px;
        }

        .vuln-list ul {
            margin: 5px 0;
            padding-left: 15px;
        }

        .vuln-list li {
            color: #ff6b6b;
            font-size: 11px;
        }

        /* Bildirim Paneli */
        .notification-panel {
            position: fixed;
            top: 70px;
            right: 16px;
            width: 320px;
            max-height: 400px;
            background: var(--bg-panel);
            border: 1px solid var(--border-glow);
            border-radius: 10px;
            z-index: 1500;
            display: none;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 180, 255, 0.3);
            backdrop-filter: blur(15px);
        }

        .notification-panel.visible {
            display: flex;
        }

        .notification-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 14px;
            background: linear-gradient(135deg, var(--bg-deep), var(--bg-card));
            border-bottom: 1px solid var(--border-subtle);
            font-size: 12px;
            font-weight: 600;
            color: var(--text-bright);
        }

        .notification-count {
            background: var(--accent-danger);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 700;
        }

        .notification-clear {
            margin-left: auto;
            background: transparent;
            border: 1px solid var(--border-subtle);
            color: var(--text-dim);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 9px;
            cursor: pointer;
        }

        .notification-clear:hover {
            border-color: var(--accent-danger);
            color: var(--accent-danger);
        }

        .notification-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .notification-item {
            display: flex;
            gap: 10px;
            padding: 10px;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .notification-item:hover {
            border-color: var(--accent-primary);
            background: rgba(0, 180, 255, 0.1);
        }

        .notification-item.critical {
            border-left: 3px solid var(--accent-danger);
        }

        .notification-item.high {
            border-left: 3px solid var(--accent-warning);
        }

        .notification-item.medium {
            border-left: 3px solid var(--accent-primary);
        }

        .notif-icon {
            font-size: 18px;
        }

        .notif-content {
            flex: 1;
        }

        .notif-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-bright);
            margin-bottom: 2px;
        }

        .notif-desc {
            font-size: 10px;
            color: var(--text-dim);
        }

        .notif-time {
            font-size: 9px;
            color: var(--text-dim);
        }

        /* Bildirim Toggle Butonu */
        .notification-toggle {
            position: fixed;
            top: 70px;
            right: 16px;
            width: 44px;
            height: 44px;
            background: var(--bg-panel);
            border: 1px solid var(--border-glow);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
            z-index: 1400;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 180, 255, 0.2);
        }

        .notification-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px var(--accent-primary);
        }

        .notif-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--accent-danger);
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        .notif-badge.hidden {
            display: none;
        }

        /* Saldırı Feed tıklama stili */
        .atk-item {
            cursor: pointer;
            transition: all 0.2s;
        }

        .atk-item:hover {
            background: rgba(0, 180, 255, 0.15);
            transform: translateX(3px);
        }

        .atk-item.selected {
            background: rgba(0, 180, 255, 0.2);
            border-left: 3px solid var(--accent-primary);
        }

        /* Street View Modal */
        .streetview-modal {
            position: fixed;
            bottom: 55px;
            right: 16px;
            z-index: 3000;
            display: none;
        }

        .streetview-modal.visible { display: block; }

        .sv-container {
            width: 500px;
            height: 400px;
            background: var(--bg-panel);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            border: 1px solid var(--border-glow);
            box-shadow: 0 10px 50px rgba(0, 180, 255, 0.3);
        }

        .sv-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 20px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-glow);
        }

        .sv-header h3 {
            font-size: 15px;
            color: var(--accent-primary);
            font-family: 'Orbitron', monospace;
            font-weight: 700;
        }

        .sv-close {
            background: none;
            border: none;
            color: var(--text-normal);
            font-size: 28px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sv-close:hover {
            color: var(--accent-danger);
        }

        .sv-iframe {
            width: 100%;
            height: calc(100% - 55px);
            border: none;
        }

        /* Leaflet Overrides */
        .leaflet-popup-content-wrapper {
            background: #0a0e14 !important;
            border: 1px solid rgba(0, 180, 255, 0.3) !important;
            border-radius: 8px !important;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5), 0 0 15px rgba(0, 180, 255, 0.15) !important;
        }

        .leaflet-popup-content {
            color: #e0e0e0 !important;
            font-family: 'JetBrains Mono', monospace;
            margin: 12px;
            font-size: 11px;
        }

        .leaflet-popup-tip {
            background: #0a0e14 !important;
            border: 1px solid rgba(0, 180, 255, 0.3) !important;
        }

        .leaflet-popup-close-button {
            color: #00b4ff !important;
        }

        .leaflet-popup-close-button:hover {
            color: #ff3355 !important;
        }

        .marker-cluster {
            background: rgba(0, 180, 255, 0.35);
        }

        .marker-cluster div {
            background: var(--accent-primary);
            color: var(--bg-void);
            font-weight: 700;
            font-size: 11px;
            font-family: 'Orbitron', monospace;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb {
            background: var(--border-glow);
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-primary);
        }

        /* Navigasyon Menusu */
        .nav-panel .nav-body {
            max-height: 250px;
            transition: max-height 0.3s;
        }

        .nav-panel .nav-body.collapsed {
            max-height: 0;
            overflow: hidden;
            padding: 0;
        }

        /* Widget Toggle System - Tüm paneller için kapanır/açılır */
        .side-panel .panel {
            transition: all 0.3s ease;
        }

        .side-panel .panel .panel-header {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        .side-panel .panel .panel-header .collapse-arrow {
            font-size: 10px;
            transition: transform 0.3s ease;
            opacity: 0.7;
        }

        .side-panel .panel .panel-header:hover .collapse-arrow {
            opacity: 1;
        }

        .side-panel .panel.collapsed .panel-body {
            max-height: 0 !important;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
            overflow: hidden;
            opacity: 0;
        }

        .side-panel .panel.collapsed .panel-header .collapse-arrow {
            transform: rotate(-90deg);
        }

        .side-panel .panel .panel-body {
            max-height: 500px;
            transition: max-height 0.3s ease, padding 0.3s ease, opacity 0.2s ease;
            opacity: 1;
        }

        /* Sol panel gizle/göster */
        .side-panel.panel-hidden {
            transform: translateX(-100%);
        }

        /* Panel toggle butonu (header içinde) */
        #sidePanelToggleBtn {
            transition: all 0.2s ease;
        }
        #sidePanelToggleBtn:hover {
            background: rgba(0, 255, 170, 0.3) !important;
            border-color: #00ffaa !important;
        }

        /* Tüm Widget'ları Aç/Kapat butonu */
        #toggleAllWidgetsBtn {
            transition: all 0.2s ease;
            font-family: 'JetBrains Mono', monospace;
        }
        #toggleAllWidgetsBtn:hover {
            background: rgba(0, 180, 255, 0.4) !important;
            border-color: #00b4ff !important;
            box-shadow: 0 0 10px rgba(0, 180, 255, 0.3);
        }
        [data-theme="cockpit-bw"] #toggleAllWidgetsBtn {
            background: rgba(255, 255, 255, 0.1) !important;
            border-color: rgba(255, 255, 255, 0.4) !important;
            color: #fff !important;
        }
        [data-theme="cockpit-bw"] #toggleAllWidgetsBtn:hover {
            background: rgba(255, 255, 255, 0.2) !important;
            border-color: rgba(255, 255, 255, 0.7) !important;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.3) !important;
        }

        /* Canlı Saldırılar Panel - Özel Stil - EN ÜSTTE ZORLA */
        .side-panel > [data-widget-id="attacksPanel"] {
            order: -999 !important;
        }
        .side-panel > .nav-panel {
            order: 0 !important;
        }
        .side-panel > [data-widget-id="torPanel"] {
            order: 1 !important;
        }
        .side-panel > [data-widget-id="agentsPanel"] {
            order: 2 !important;
        }
        .side-panel > [data-widget-id="geoAnalysisPanel"] {
            order: 3 !important;
        }
        .side-panel > [data-widget-id="globalOsintPanel"] {
            order: 4 !important;
        }
        [data-theme="cockpit-bw"] [data-widget-id="attacksPanel"] {
            border-color: rgba(255, 255, 255, 0.3) !important;
            background: rgba(255, 50, 50, 0.05) !important;
        }
        [data-theme="cockpit-bw"] [data-widget-id="attacksPanel"] .panel-header {
            background: rgba(255, 255, 255, 0.05) !important;
        }

        /* Sol panel açma butonu (panel kapalıyken görünür) */
        .side-panel-open-btn {
            position: fixed;
            left: 0;
            top: 80px;
            width: 28px;
            height: 50px;
            background: linear-gradient(135deg, rgba(0, 30, 50, 0.95), rgba(0, 50, 70, 0.9));
            border: 1px solid rgba(0, 180, 255, 0.4);
            border-left: none;
            border-radius: 0 8px 8px 0;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            color: #00b4ff;
            font-size: 14px;
            z-index: 1001;
            transition: all 0.3s ease;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.5);
        }
        .side-panel-open-btn:hover {
            background: linear-gradient(135deg, rgba(0, 50, 70, 0.98), rgba(0, 80, 100, 0.95));
            box-shadow: 2px 0 15px rgba(0, 180, 255, 0.4);
            color: #00ffaa;
        }
        .side-panel-open-btn.visible {
            display: flex;
        }

        /* ═══════════════════════════════════════════════════════════════
           SİBER KOMUTA MERKEZİ v5.0 STİLLERİ
           ═══════════════════════════════════════════════════════════════ */

        /* Siber Komuta Widget - PARLAYAN YEŞİL VURGU */
        #siberKomutaWidget,
        .siber-komuta-widget {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            border: 2px solid rgba(0, 255, 136, 0.6) !important;
            box-shadow: 0 0 25px rgba(0, 255, 136, 0.25), 0 4px 20px rgba(0, 0, 0, 0.4);
            animation: siberWidgetGlow 3s ease-in-out infinite;
            background: linear-gradient(135deg, rgba(0, 30, 15, 0.95), rgba(0, 20, 30, 0.95)) !important;
        }

        @keyframes siberWidgetGlow {
            0%, 100% {
                box-shadow: 0 0 20px rgba(0, 255, 136, 0.2), 0 4px 20px rgba(0, 0, 0, 0.4);
                border-color: rgba(0, 255, 136, 0.5);
            }
            50% {
                box-shadow: 0 0 35px rgba(0, 255, 136, 0.4), 0 4px 25px rgba(0, 0, 0, 0.5);
                border-color: rgba(0, 255, 136, 0.8);
            }
        }

        #siberKomutaWidget .panel-header,
        .siber-komuta-widget .panel-header {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.2), rgba(0, 180, 255, 0.1)) !important;
            border-bottom: 1px solid rgba(0, 255, 136, 0.4) !important;
            color: #00ff88 !important;
        }

        #siberKomutaWidget .panel-header span:first-child,
        .siber-komuta-widget .panel-header span:first-child {
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }

        .siber-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            margin-bottom: 10px;
        }

        .siber-stat {
            background: rgba(0, 255, 136, 0.08);
            padding: 8px 6px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid rgba(0, 255, 136, 0.15);
        }

        .siber-stat-value {
            font-size: 16px;
            font-weight: bold;
            color: var(--hud-green);
            font-family: 'JetBrains Mono', monospace;
        }

        .siber-stat-label {
            font-size: 9px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .siber-osint-input {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
        }

        .siber-osint-input input {
            flex: 1;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(0, 180, 255, 0.3);
            border-radius: 4px;
            padding: 8px 10px;
            color: var(--text-bright);
            font-size: 11px;
        }

        .siber-osint-input input:focus {
            outline: none;
            border-color: var(--accent-secondary);
            box-shadow: 0 0 10px rgba(0, 255, 157, 0.2);
        }

        .siber-osint-btn {
            background: linear-gradient(135deg, rgba(0, 255, 157, 0.2), rgba(0, 180, 255, 0.2));
            border: 1px solid rgba(0, 255, 157, 0.4);
            border-radius: 4px;
            padding: 8px 12px;
            color: var(--hud-green);
            cursor: pointer;
            font-size: 10px;
            transition: all 0.2s;
        }

        .siber-osint-btn:hover {
            background: linear-gradient(135deg, rgba(0, 255, 157, 0.3), rgba(0, 180, 255, 0.3));
            box-shadow: 0 0 15px rgba(0, 255, 157, 0.3);
        }

        .siber-agents-mini {
            max-height: 150px;
            overflow-y: auto;
            margin-bottom: 10px;
        }

        .siber-agent-layer {
            margin-bottom: 6px;
        }

        .siber-layer-header {
            font-size: 9px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 4px 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px 4px 0 0;
            border-left: 2px solid var(--accent-primary);
        }

        .siber-layer-header.command { border-left-color: #ff6b6b; }
        .siber-layer-header.intelligence { border-left-color: #00d4ff; }
        .siber-layer-header.defense { border-left-color: #00ff88; }
        .siber-layer-header.offensive { border-left-color: #ff4444; }
        .siber-layer-header.purple { border-left-color: #9b59b6; }
        .siber-layer-header.critical { border-left-color: #f39c12; }
        .siber-layer-header.global { border-left-color: #1abc9c; }

        .siber-agent-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 8px;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 10px;
        }

        .siber-agent-item:last-child {
            border-radius: 0 0 4px 4px;
        }

        .siber-agent-name {
            color: var(--text-normal);
        }

        .siber-agent-status {
            font-size: 8px;
            padding: 2px 6px;
            border-radius: 3px;
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }

        .siber-agent-status.busy {
            background: rgba(255, 170, 0, 0.2);
            color: #ffaa00;
        }

        .siber-agent-status.error {
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
        }

        .siber-action-btns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }

        .siber-action-btn {
            background: rgba(0, 50, 80, 0.6);
            border: 1px solid rgba(0, 180, 255, 0.3);
            border-radius: 4px;
            padding: 8px;
            color: var(--text-normal);
            cursor: pointer;
            font-size: 10px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .siber-action-btn:hover {
            background: rgba(0, 80, 120, 0.8);
            border-color: var(--accent-primary);
            color: var(--hud-cyan);
        }

        .siber-action-btn.active {
            background: rgba(0, 255, 136, 0.2);
            border-color: var(--hud-green);
            color: var(--hud-green);
        }

        /* ═══════════════════════════════════════════════════════════════
           SİBER KOMUTA POPUP - SAĞ ALT
           ═══════════════════════════════════════════════════════════════ */
        #siberKomutaPopup {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 380px;
            max-height: 500px;
            background: linear-gradient(135deg, rgba(0, 20, 30, 0.98), rgba(0, 15, 25, 0.98));
            border: 1px solid rgba(0, 255, 136, 0.4);
            border-radius: 12px;
            z-index: 10000;
            display: none;
            box-shadow: 0 0 40px rgba(0, 255, 136, 0.2), 0 10px 40px rgba(0, 0, 0, 0.6);
            overflow: hidden;
            animation: siberPopupIn 0.3s ease-out;
        }

        @keyframes siberPopupIn {
            from { opacity: 0; transform: translateY(20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        #siberKomutaPopup.show { display: block; }

        .siber-popup-header {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.15), rgba(0, 100, 80, 0.1));
            padding: 12px 16px;
            border-bottom: 1px solid rgba(0, 255, 136, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .siber-popup-header h3 {
            color: #00ff88;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }

        .siber-popup-close {
            background: none;
            border: none;
            color: #888;
            font-size: 20px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .siber-popup-close:hover {
            color: #ff4444;
            background: rgba(255, 68, 68, 0.2);
        }

        .siber-popup-body {
            padding: 16px;
            max-height: 420px;
            overflow-y: auto;
        }

        .siber-popup-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }

        .siber-popup-stat {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px 6px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(0, 255, 136, 0.15);
        }

        .siber-popup-stat .value {
            font-size: 18px;
            font-weight: bold;
            font-family: 'JetBrains Mono', monospace;
        }

        .siber-popup-stat .label {
            font-size: 9px;
            color: var(--text-dim);
            text-transform: uppercase;
            margin-top: 4px;
        }

        .siber-popup-section {
            margin-bottom: 16px;
        }

        .siber-popup-section h4 {
            font-size: 11px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            padding-bottom: 6px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .siber-popup-osint {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .siber-popup-osint input {
            flex: 1;
            padding: 10px 12px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(0, 180, 255, 0.3);
            border-radius: 6px;
            color: var(--text-bright);
            font-size: 12px;
        }

        .siber-popup-osint input:focus {
            outline: none;
            border-color: #00ff88;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.2);
        }

        .siber-popup-osint button {
            padding: 10px 16px;
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.2), rgba(0, 180, 255, 0.2));
            border: 1px solid rgba(0, 255, 136, 0.4);
            border-radius: 6px;
            color: #00ff88;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .siber-popup-osint button:hover {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.3), rgba(0, 180, 255, 0.3));
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.3);
        }

        .siber-popup-agents {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 6px;
            margin-bottom: 12px;
        }

        .siber-popup-agent {
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 4px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: default;
        }

        .siber-popup-agent .count {
            font-size: 16px;
            font-weight: bold;
            font-family: 'JetBrains Mono', monospace;
        }

        .siber-popup-agent .name {
            font-size: 8px;
            color: var(--text-dim);
            text-transform: uppercase;
            margin-top: 2px;
        }

        .siber-popup-agent.komuta .count { color: #ff4444; }
        .siber-popup-agent.istihbarat .count { color: #00b4ff; }
        .siber-popup-agent.savunma .count { color: #00ff88; }
        .siber-popup-agent.saldiri .count { color: #ff8800; }
        .siber-popup-agent.uzman .count { color: #8855ff; }

        .siber-popup-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .siber-popup-btn {
            padding: 12px 10px;
            background: rgba(0, 50, 80, 0.5);
            border: 1px solid rgba(0, 180, 255, 0.3);
            border-radius: 8px;
            color: var(--text-normal);
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .siber-popup-btn:hover {
            background: rgba(0, 80, 120, 0.7);
            border-color: #00ff88;
            color: #00ff88;
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.2);
        }

        .siber-popup-btn.danger { border-color: rgba(255, 68, 68, 0.4); }
        .siber-popup-btn.danger:hover { border-color: #ff4444; color: #ff4444; box-shadow: 0 0 15px rgba(255, 68, 68, 0.2); }

        .siber-popup-btn.success { border-color: rgba(0, 255, 136, 0.4); }
        .siber-popup-btn.success:hover { border-color: #00ff88; color: #00ff88; }

        .siber-popup-btn.full {
            grid-column: span 2;
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.15), rgba(0, 100, 80, 0.1));
        }

        /* Aircraft Marker Stilleri */
        .aircraft-marker {
            background: none;
            border: none;
        }

        .aircraft-icon {
            font-size: 18px;
            text-shadow: 0 0 10px rgba(0, 180, 255, 0.8);
            transition: transform 0.5s ease;
        }

        .aircraft-icon.military {
            color: #ff3355;
            text-shadow: 0 0 10px rgba(255, 51, 85, 0.8);
        }

        .aircraft-icon.civilian {
            color: #00b4ff;
        }

        .aircraft-popup {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
        }

        .aircraft-popup .callsign {
            font-weight: bold;
            color: #00b4ff;
            margin-bottom: 4px;
        }

        .aircraft-popup .military {
            color: #ff3355;
        }

        /* ISS Marker */
        .iss-marker {
            background: none;
            border: none;
        }

        .iss-icon {
            font-size: 24px;
            animation: iss-pulse 2s infinite;
        }

        @keyframes iss-pulse {
            0%, 100% { text-shadow: 0 0 10px rgba(255, 255, 0, 0.8); }
            50% { text-shadow: 0 0 20px rgba(255, 255, 0, 1), 0 0 30px rgba(255, 255, 0, 0.5); }
        }

        /* ═══════════════════════════════════════════════════════════════ */

        .nav-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            margin: 3px 0;
            color: var(--text-dim);
            text-decoration: none;
            font-size: 11px;
            border-radius: 6px;
            transition: all 0.3s;
        }

        .nav-item:hover {
            background: rgba(0, 180, 255, 0.15);
            color: var(--accent-primary);
        }

        .nav-item.active {
            background: rgba(0, 180, 255, 0.2);
            color: var(--accent-primary);
            border-left: 3px solid var(--accent-primary);
            box-shadow: 0 0 10px var(--border-glow);
        }

        .nav-icon {
            font-size: 14px;
        }

        /* AI Chat Panel - Tactical Assistant */
        .ai-chat-panel {
            position: fixed;
            top: 70px;
            right: 16px;
            z-index: 1000;
            width: 380px;
        }

        .ai-chat-container {
            display: none;
            width: 100%;
            height: 500px;
            background: var(--bg-panel);
            border: 1px solid var(--border-glow);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 50px rgba(0, 180, 255, 0.3);
            flex-direction: column;
            backdrop-filter: blur(10px);
        }

        .ai-chat-container.visible { display: flex; }

        .ai-chat-header {
            padding: 14px 18px;
            background: linear-gradient(135deg, rgba(0, 180, 255, 0.15), rgba(0, 180, 255, 0.05));
            border-bottom: 1px solid var(--border-glow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            font-weight: 700;
            color: var(--accent-primary);
            font-family: 'Orbitron', monospace;
        }

        .ai-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 14px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .ai-msg {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 12px;
            line-height: 1.6;
        }

        .ai-msg.user {
            align-self: flex-end;
            background: var(--accent-primary);
            color: var(--bg-void);
            border-bottom-right-radius: 4px;
            font-weight: 500;
        }

        .ai-msg.system, .ai-msg.assistant {
            align-self: flex-start;
            background: var(--bg-glass);
            color: var(--text-normal);
            border-bottom-left-radius: 4px;
            border: 1px solid var(--border-subtle);
        }

        .ai-msg.assistant {
            border-left: 3px solid var(--accent-primary);
        }

        .ai-msg.error {
            border-left: 3px solid var(--accent-danger);
            background: rgba(255, 51, 85, 0.15);
        }

        .ai-msg-content pre {
            background: var(--bg-void);
            padding: 10px;
            border-radius: 6px;
            margin: 8px 0;
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            overflow-x: auto;
            border: 1px solid var(--border-subtle);
        }

        .ai-chat-input {
            padding: 14px;
            border-top: 1px solid var(--border-glow);
            display: flex;
            gap: 10px;
            background: var(--bg-card);
        }

        .ai-chat-input input {
            flex: 1;
            padding: 12px 16px;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 22px;
            color: var(--text-bright);
            font-size: 12px;
            outline: none;
            font-family: 'JetBrains Mono', monospace;
        }

        .ai-chat-input input:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 10px var(--border-glow);
        }

        .ai-chat-input button {
            width: 44px;
            height: 44px;
            background: var(--accent-primary);
            border: none;
            border-radius: 50%;
            color: var(--bg-void);
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 0 15px var(--border-glow);
        }

        .ai-chat-input button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0, 180, 255, 0.5);
        }

        .typing-indicator {
            display: flex;
            gap: 5px;
            padding: 12px;
        }

        .typing-indicator span {
            width: 7px;
            height: 7px;
            background: var(--accent-primary);
            border-radius: 50%;
            animation: typing 1s infinite;
            opacity: 0.6;
        }

        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        /* AI Analysis Styles */
        .ai-analysis {
            background: linear-gradient(135deg, rgba(255, 51, 85, 0.1), rgba(255, 102, 0, 0.1)) !important;
            border: 1px solid var(--accent-danger) !important;
            border-radius: 10px;
        }

        .ai-analysis-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            font-weight: 600;
            color: var(--accent-danger);
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 51, 85, 0.3);
        }

        .ai-analysis-time {
            font-size: 9px;
            color: var(--text-dim);
            text-align: right;
            margin-top: 8px;
        }

        /* Ses Butonlari - Voice Controls */
        .voice-btn, .speaker-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: 1px solid var(--border-subtle);
            background: var(--bg-card);
            color: var(--text-normal);
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .voice-btn:hover, .speaker-btn:hover {
            border-color: var(--accent-primary);
            box-shadow: 0 0 15px var(--border-glow);
        }

        .voice-btn.active {
            background: linear-gradient(135deg, var(--accent-danger), #cc0033);
            border-color: var(--accent-danger);
            animation: pulse-voice 1s infinite;
        }

        .speaker-btn.active {
            background: rgba(0, 255, 136, 0.25);
            border-color: var(--hud-green);
            color: var(--hud-green);
        }

        @keyframes pulse-voice {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 51, 85, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(255, 51, 85, 0); }
        }

        .voice-indicator {
            display: none;
            padding: 12px;
            text-align: center;
            background: rgba(255, 51, 85, 0.15);
            border-top: 1px solid var(--accent-danger);
            color: var(--accent-danger);
            font-size: 11px;
        }

        .voice-indicator.active { display: block; }

        .voice-wave {
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            margin-bottom: 6px;
        }

        .voice-wave::before, .voice-wave::after, .voice-wave span {
            content: '';
            width: 4px;
            height: 100%;
            background: var(--accent-danger);
            border-radius: 2px;
            animation: wave 0.5s infinite alternate;
        }

        .voice-wave::after { animation-delay: 0.2s; }

        @keyframes wave {
            0% { height: 6px; }
            100% { height: 24px; }
        }

        /* Bildirim Toast - Notifications */
        .toast-container {
            position: fixed;
            bottom: 120px;
            right: 16px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 300px;
        }

        .toast {
            background: var(--bg-panel);
            border: 1px solid var(--border-glow);
            border-radius: 10px;
            padding: 12px 18px;
            min-width: 270px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: toastIn 0.4s ease;
            box-shadow: 0 5px 25px rgba(0, 180, 255, 0.3);
            backdrop-filter: blur(10px);
        }

        .toast.success { border-color: var(--hud-green); }
        .toast.error { border-color: var(--accent-danger); }
        .toast.warning { border-color: var(--accent-warning); }

        @keyframes toastIn {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .toast-icon { font-size: 20px; }
        .toast-content { flex: 1; }
        .toast-title {
            font-size: 12px;
            font-weight: 700;
            font-family: 'Orbitron', monospace;
        }
        .toast-msg, .toast-text {
            font-size: 10px;
            color: var(--text-dim);
            margin-top: 2px;
        }

        .toast {
            transition: all 0.3s ease;
        }

        /* AILYDIAN Panel Stilleri - Agent Orchestrator */
        .ailydian-panel {
            position: fixed;
            top: 70px;
            right: 412px;
            z-index: 1000;
            width: 320px;
            max-height: calc(100vh - 130px);
            display: none;
            flex-direction: column;
        }

        .ailydian-panel.visible { display: flex; }

        .ailydian-card {
            background: var(--bg-panel);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            margin-bottom: 10px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        }

        .ailydian-card-header {
            padding: 10px 14px;
            background: linear-gradient(135deg, rgba(136, 85, 255, 0.15), rgba(136, 85, 255, 0.05));
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--accent-purple);
            font-weight: 700;
            font-family: 'Orbitron', monospace;
        }

        .ailydian-card-body {
            padding: 12px;
            max-height: 220px;
            overflow-y: auto;
        }


        .ajan-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            margin: 4px 0;
            background: var(--bg-glass);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 10px;
            border: 1px solid var(--border-subtle);
        }

        .ajan-item:hover {
            background: rgba(136, 85, 255, 0.2);
            border-color: var(--accent-purple);
        }

        .ajan-item.secili {
            background: rgba(136, 85, 255, 0.3);
            border-left: 3px solid var(--accent-purple);
            box-shadow: 0 0 10px rgba(136, 85, 255, 0.3);
        }

        .ajan-ikon { font-size: 16px; }
        .ajan-bilgi { flex: 1; min-width: 0; }
        .ajan-ad {
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .ajan-kategori {
            color: var(--text-dim);
            font-size: 9px;
        }
        .ajan-basari {
            font-size: 10px;
            color: var(--hud-green);
            font-weight: 700;
        }

        .gorev-item {
            padding: 8px 10px;
            margin: 4px 0;
            background: var(--bg-glass);
            border-radius: 6px;
            font-size: 10px;
            border: 1px solid var(--border-subtle);
        }

        .gorev-item.calisiyor {
            border-left: 3px solid var(--accent-warning);
            animation: pulse 1s infinite;
        }
        .gorev-item.tamamlandi {
            border-left: 3px solid var(--hud-green);
        }
        .gorev-item.hata {
            border-left: 3px solid var(--accent-danger);
        }

        .gorev-baslik {
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .gorev-meta {
            color: var(--text-dim);
            font-size: 9px;
            display: flex;
            justify-content: space-between;
        }

        .ailydian-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .ailydian-stat {
            background: var(--bg-glass);
            border-radius: 6px;
            padding: 10px;
            text-align: center;
            border: 1px solid var(--border-subtle);
        }

        .ailydian-stat .val {
            font-size: 18px;
            font-weight: 800;
            color: var(--accent-purple);
            font-family: 'Orbitron', monospace;
        }
        .ailydian-stat .lbl {
            font-size: 9px;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        .ailydian-input-row {
            display: flex;
            gap: 8px;
            padding: 10px;
            background: var(--bg-glass);
            border-radius: 6px;
            margin-top: 8px;
        }

        .ailydian-input {
            flex: 1;
            padding: 8px 12px;
            background: var(--bg-deep);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text-bright);
            font-size: 10px;
            outline: none;
            font-family: 'JetBrains Mono', monospace;
        }

        .ailydian-input:focus {
            border-color: var(--accent-purple);
            box-shadow: 0 0 10px rgba(136, 85, 255, 0.3);
        }

        .ailydian-btn {
            padding: 8px 14px;
            background: var(--accent-purple);
            border: none;
            border-radius: 6px;
            color: #fff;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 700;
            font-family: 'Orbitron', monospace;
        }

        .ailydian-btn:hover {
            background: #a040f0;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(136, 85, 255, 0.4);
        }

        .ailydian-btn-sm {
            padding: 5px 10px;
            font-size: 9px;
        }

        .kategori-filtre {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 10px;
        }

        .kategori-chip {
            padding: 4px 10px;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 14px;
            font-size: 9px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .kategori-chip:hover {
            border-color: var(--accent-purple);
        }

        .kategori-chip.aktif {
            background: var(--accent-purple);
            color: #fff;
            border-color: var(--accent-purple);
            box-shadow: 0 0 10px rgba(136, 85, 255, 0.4);
        }

        .ilerleme-bar {
            height: 5px;
            background: var(--bg-glass);
            border-radius: 3px;
            overflow: hidden;
        }

        .ilerleme-deger {
            height: 100%;
            background: var(--accent-purple);
            transition: width 0.3s;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes lydianGlow {
            0%, 100% { filter: drop-shadow(0 0 3px #00ff88); }
            50% { filter: drop-shadow(0 0 8px #00ff88) drop-shadow(0 0 15px #00ff88); }
        }

        @keyframes bellRing {
            0%, 100% { transform: rotate(0deg); }
            5% { transform: rotate(15deg); }
            10% { transform: rotate(-15deg); }
            15% { transform: rotate(10deg); }
            20% { transform: rotate(-10deg); }
            25% { transform: rotate(5deg); }
            30%, 100% { transform: rotate(0deg); }
        }

        @keyframes pulseBadge {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }

        .lydian-header-btn:hover {
            background: rgba(0,255,136,0.2) !important;
            box-shadow: 0 0 15px rgba(0,255,136,0.3);
        }

        .ghost-box-header:hover {
            background: rgba(0,255,136,0.2) !important;
            box-shadow: 0 0 15px rgba(0,255,136,0.3);
        }

        .notification-header-btn:hover {
            background: rgba(0,229,255,0.2) !important;
            box-shadow: 0 0 15px rgba(0,229,255,0.3);
        }

        .notif-item {
            padding: 12px;
            margin-bottom: 8px;
            background: rgba(0,229,255,0.05);
            border-left: 3px solid #00e5ff;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .notif-item:hover {
            background: rgba(0,229,255,0.1);
            transform: translateX(3px);
        }
        .notif-item.critical {
            border-left-color: #ff3355;
            background: rgba(255,51,85,0.08);
        }
        .notif-item.warning {
            border-left-color: #ffcc00;
            background: rgba(255,204,0,0.08);
        }
        .notif-item.success {
            border-left-color: #00ff88;
            background: rgba(0,255,136,0.08);
        }
        .notif-item .notif-title {
            color: #e8f4ff;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .notif-item .notif-msg {
            color: #a0c0d8;
            line-height: 1.4;
        }
        .notif-item .notif-time {
            color: #607080;
            font-size: 9px;
            margin-top: 6px;
        }
        .notif-empty {
            text-align: center;
            color: #607080;
            padding: 40px 20px;
            font-size: 12px;
        }

        /* LYDIAN AI Arac Paneli */
        .mcp-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .mcp-modal.active { display: flex; }

        .mcp-container {
            background: var(--bg-panel);
            border: 1px solid var(--border-glow);
            border-radius: 12px;
            width: 700px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .mcp-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mcp-header h3 {
            font-family: 'Orbitron', sans-serif;
            font-size: 14px;
            color: var(--text-bright);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mcp-header h3::before {
            content: '⚡';
        }

        .mcp-close {
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 22px;
            cursor: pointer;
        }

        .mcp-close:hover { color: var(--accent-danger); }

        .mcp-categories {
            display: flex;
            gap: 5px;
            padding: 10px 20px;
            border-bottom: 1px solid var(--border-subtle);
            flex-wrap: wrap;
        }

        .mcp-cat-btn {
            padding: 8px 14px;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text-dim);
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
        }

        .mcp-cat-btn:hover, .mcp-cat-btn.active {
            background: var(--accent-purple);
            color: white;
            border-color: var(--accent-purple);
        }

        .mcp-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .mcp-tools {
            width: 250px;
            border-right: 1px solid var(--border-subtle);
            overflow-y: auto;
            padding: 10px;
        }

        .mcp-tool-item {
            padding: 10px;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mcp-tool-item:hover {
            border-color: var(--accent-primary);
            background: rgba(0, 180, 255, 0.1);
        }

        .mcp-tool-item.selected {
            border-color: var(--accent-purple);
            background: rgba(136, 85, 255, 0.15);
        }

        .mcp-tool-name {
            font-weight: 600;
            color: var(--text-bright);
            font-size: 11px;
            margin-bottom: 4px;
        }

        .mcp-tool-desc {
            font-size: 10px;
            color: var(--text-dim);
        }

        .mcp-runner {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 15px;
        }

        .mcp-input-group {
            margin-bottom: 15px;
        }

        .mcp-input-group label {
            display: block;
            font-size: 10px;
            color: var(--text-dim);
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .mcp-input-group input {
            width: 100%;
            padding: 10px;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            color: var(--text-bright);
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
        }

        .mcp-input-group input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .mcp-run-btn {
            padding: 12px 20px;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-primary));
            border: none;
            border-radius: 6px;
            color: white;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            cursor: pointer;
            margin-bottom: 15px;
        }

        .mcp-run-btn:hover {
            opacity: 0.9;
        }

        .mcp-output {
            flex: 1;
            background: var(--bg-deep);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            padding: 10px;
            overflow-y: auto;
            font-size: 11px;
            color: var(--text-normal);
            white-space: pre-wrap;
            font-family: 'JetBrains Mono', monospace;
        }

        .mcp-output .loading {
            color: var(--accent-primary);
            animation: pulse 1s infinite;
        }

        .mcp-output .error {
            color: var(--accent-danger);
        }

        .mcp-output .success {
            color: var(--accent-secondary);
        }

        /* GNN Graf Görselleştirme Paneli */
        .gnn-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2100;
            align-items: center;
            justify-content: center;
        }
        .gnn-modal.active { display: flex; }

        .gnn-container {
            background: var(--bg-panel);
            border: 1px solid var(--hud-cyan);
            border-radius: 12px;
            width: 90vw;
            height: 85vh;
            max-width: 1400px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 40px rgba(0, 229, 255, 0.2);
        }

        .gnn-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(90deg, var(--bg-deep) 0%, var(--bg-panel) 100%);
        }

        .gnn-header h3 {
            font-family: 'Orbitron', sans-serif;
            font-size: 16px;
            color: var(--hud-cyan);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .gnn-header h3::before {
            content: '🧠';
        }

        .gnn-close {
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 24px;
            cursor: pointer;
            transition: color 0.2s;
        }
        .gnn-close:hover { color: var(--accent-danger); }

        .gnn-toolbar {
            display: flex;
            gap: 8px;
            padding: 12px 20px;
            border-bottom: 1px solid var(--border-subtle);
            background: var(--bg-glass);
            flex-wrap: wrap;
        }

        .gnn-btn {
            padding: 10px 16px;
            background: var(--bg-deep);
            border: 1px solid var(--border-glow);
            border-radius: 6px;
            color: var(--text-normal);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'JetBrains Mono', monospace;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .gnn-btn:hover {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }
        .gnn-btn.active {
            background: var(--hud-cyan);
            color: var(--bg-void);
            border-color: var(--hud-cyan);
        }
        .gnn-btn.danger:hover {
            background: var(--accent-danger);
            border-color: var(--accent-danger);
        }
        .gnn-btn.success:hover {
            background: var(--hud-green);
            border-color: var(--hud-green);
        }

        .gnn-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .gnn-sidebar {
            width: 280px;
            border-right: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            background: var(--bg-deep);
        }

        .gnn-stats {
            padding: 15px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .gnn-stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .gnn-stat-item {
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            padding: 12px;
            text-align: center;
        }

        .gnn-stat-val {
            font-size: 22px;
            font-weight: 800;
            color: var(--hud-cyan);
            font-family: 'Orbitron', monospace;
        }

        .gnn-stat-lbl {
            font-size: 9px;
            color: var(--text-dim);
            text-transform: uppercase;
            margin-top: 4px;
        }

        .gnn-legend {
            padding: 15px;
            flex: 1;
            overflow-y: auto;
        }

        .gnn-legend h4 {
            font-size: 11px;
            color: var(--text-bright);
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .gnn-legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 0;
            font-size: 10px;
            color: var(--text-normal);
        }

        .gnn-legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .gnn-training-panel {
            padding: 15px;
            border-top: 1px solid var(--border-subtle);
            background: var(--bg-glass);
        }

        .gnn-training-panel h4 {
            font-size: 11px;
            color: var(--hud-green);
            margin-bottom: 10px;
        }

        .gnn-input-group {
            margin-bottom: 10px;
        }

        .gnn-input-group label {
            font-size: 9px;
            color: var(--text-dim);
            display: block;
            margin-bottom: 4px;
        }

        .gnn-input-group input, .gnn-input-group select {
            width: 100%;
            padding: 8px;
            background: var(--bg-deep);
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            color: var(--text-bright);
            font-size: 11px;
        }

        .gnn-graph-area {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        #gnnSvg {
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, var(--bg-deep) 0%, var(--bg-void) 100%);
        }

        .gnn-node {
            cursor: pointer;
            stroke-width: 2px;
            transition: all 0.2s;
        }
        .gnn-node:hover {
            stroke-width: 4px;
            filter: brightness(1.3);
        }

        .gnn-link {
            stroke-opacity: 0.6;
        }

        .gnn-label {
            font-size: 9px;
            fill: var(--text-dim);
            pointer-events: none;
        }

        .gnn-tooltip {
            position: absolute;
            background: var(--bg-panel);
            border: 1px solid var(--hud-cyan);
            border-radius: 6px;
            padding: 12px;
            font-size: 11px;
            pointer-events: none;
            z-index: 100;
            max-width: 250px;
            box-shadow: 0 4px 20px rgba(0, 229, 255, 0.3);
            display: none;
        }

        .gnn-tooltip.visible { display: block; }

        .gnn-tooltip-header {
            font-weight: 700;
            color: var(--text-bright);
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .gnn-tooltip-row {
            display: flex;
            justify-content: space-between;
            margin: 4px 0;
        }

        .gnn-tooltip-label { color: var(--text-dim); }
        .gnn-tooltip-value { color: var(--text-bright); }

        .gnn-info-panel {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: var(--bg-panel);
            border: 1px solid var(--border-glow);
            border-radius: 8px;
            padding: 15px;
            width: 220px;
            font-size: 10px;
        }

        .gnn-info-title {
            color: var(--hud-cyan);
            font-weight: 700;
            margin-bottom: 8px;
        }

        .gnn-progress {
            width: 100%;
            height: 4px;
            background: var(--bg-deep);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 10px;
        }

        .gnn-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--hud-cyan), var(--hud-green));
            width: 0%;
            transition: width 0.3s;
        }

        /* ==================== YENİ POPUP PANELLER - F-35 COCKPIT ==================== */

        /* Genel Popup Modal Stili */
        .cockpit-modal {
            position: fixed;
            top: 70px;
            right: 20px;
            width: 480px;
            max-height: calc(100vh - 100px);
            background: var(--bg-panel);
            border: 1px solid var(--border-glow);
            border-radius: 12px;
            z-index: 2000;
            display: none;
            overflow: hidden;
            box-shadow: 0 0 40px rgba(0, 180, 255, 0.3);
            backdrop-filter: blur(10px);
        }
        .cockpit-modal.active { display: block; }

        /* Tor Stealth Popup Modal */
        .tor-modal {
            width: 420px;
            background: linear-gradient(135deg, rgba(0, 20, 10, 0.98), rgba(0, 40, 20, 0.95));
            border-color: rgba(0, 255, 100, 0.4);
            box-shadow: 0 0 50px rgba(0, 255, 100, 0.3);
        }
        .tor-modal .cockpit-header {
            background: linear-gradient(90deg, rgba(0, 255, 100, 0.2), transparent);
            border-bottom-color: rgba(0, 255, 100, 0.3);
        }
        .tor-modal .cockpit-header h3 {
            color: #00ff88;
        }
        .tor-status-container {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .tor-status-indicator {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            transition: all 0.5s ease;
        }
        .tor-status-indicator.offline {
            background: rgba(255, 50, 50, 0.2);
            border: 2px solid #ff3333;
            box-shadow: 0 0 20px rgba(255, 50, 50, 0.4);
        }
        .tor-status-indicator.connecting {
            background: rgba(255, 200, 0, 0.2);
            border: 2px solid #ffc800;
            box-shadow: 0 0 20px rgba(255, 200, 0, 0.4);
            animation: torPulse 1s infinite;
        }
        .tor-status-indicator.connected {
            background: rgba(0, 255, 100, 0.2);
            border: 2px solid #00ff88;
            box-shadow: 0 0 25px rgba(0, 255, 100, 0.5);
        }
        @keyframes torPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }
        .tor-status-info {
            flex: 1;
        }
        .tor-status-label {
            font-size: 11px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }
        .tor-status-text {
            font-size: 16px;
            font-weight: bold;
            font-family: 'Orbitron', monospace;
        }
        .tor-status-text.offline { color: #ff3333; }
        .tor-status-text.connecting { color: #ffc800; }
        .tor-status-text.connected { color: #00ff88; }
        .tor-ip-display {
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            color: #00ff88;
            background: rgba(0, 255, 100, 0.1);
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid rgba(0, 255, 100, 0.3);
            margin-top: 8px;
        }
        .tor-circuit-visual {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .tor-hop {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        .tor-hop-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(0, 255, 100, 0.1);
            border: 1px solid rgba(0, 255, 100, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        .tor-hop-label {
            font-size: 9px;
            color: var(--text-dim);
            text-transform: uppercase;
        }
        .tor-hop-country {
            font-size: 10px;
            color: #00ff88;
        }
        .tor-arrow {
            color: rgba(0, 255, 100, 0.5);
            font-size: 20px;
        }
        .tor-stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        .tor-stat-item {
            text-align: center;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            border: 1px solid rgba(0, 255, 100, 0.2);
        }
        .tor-stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #00ff88;
            font-family: 'Orbitron', monospace;
        }
        .tor-stat-label {
            font-size: 10px;
            color: var(--text-dim);
            text-transform: uppercase;
            margin-top: 4px;
        }
        .tor-level-selector {
            margin-bottom: 15px;
        }
        .tor-level-btn {
            width: 100%;
            padding: 12px;
            margin-bottom: 8px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 255, 100, 0.3);
            border-radius: 8px;
            color: var(--text-normal);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .tor-level-btn:hover {
            background: rgba(0, 255, 100, 0.1);
            border-color: rgba(0, 255, 100, 0.5);
        }
        .tor-level-btn.active {
            background: rgba(0, 255, 100, 0.2);
            border-color: #00ff88;
            color: #00ff88;
        }
        .tor-level-badge {
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 4px;
            background: rgba(0, 255, 100, 0.2);
            color: #00ff88;
        }
        .tor-actions {
            display: flex;
            gap: 10px;
        }
        .tor-action-btn {
            flex: 1;
            padding: 14px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .tor-btn-primary {
            background: linear-gradient(135deg, rgba(0, 255, 100, 0.3), rgba(0, 200, 80, 0.2));
            border: 1px solid #00ff88;
            color: #00ff88;
        }
        .tor-btn-primary:hover {
            background: linear-gradient(135deg, rgba(0, 255, 100, 0.4), rgba(0, 200, 80, 0.3));
            box-shadow: 0 0 20px rgba(0, 255, 100, 0.3);
        }
        .tor-btn-secondary {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 255, 100, 0.4);
            color: var(--text-normal);
        }
        .tor-btn-secondary:hover {
            border-color: #00ff88;
            color: #00ff88;
        }
        .tor-btn-danger {
            background: rgba(255, 50, 50, 0.2);
            border: 1px solid #ff5555;
            color: #ff5555;
        }
        .tor-btn-danger:hover {
            background: rgba(255, 50, 50, 0.3);
            box-shadow: 0 0 20px rgba(255, 50, 50, 0.3);
        }
        /* Toggle Switch */
        .toggle-switch input:checked + span {
            background: rgba(0, 255, 136, 0.5) !important;
        }
        .toggle-switch input:checked + span + span {
            transform: translateX(18px);
            background: #00ff88 !important;
        }

        .cockpit-header {
            background: linear-gradient(90deg, rgba(0, 180, 255, 0.2), transparent);
            padding: 15px;
            border-bottom: 1px solid var(--border-glow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .cockpit-header h3 {
            color: var(--hud-cyan);
            font-family: 'Orbitron', sans-serif;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .cockpit-header .close-btn {
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 24px;
            cursor: pointer;
            transition: color 0.2s;
        }
        .cockpit-header .close-btn:hover { color: var(--accent-danger); }

        .cockpit-body {
            padding: 15px;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }
        .cockpit-body::-webkit-scrollbar { width: 6px; }
        .cockpit-body::-webkit-scrollbar-track { background: var(--bg-deep); }
        .cockpit-body::-webkit-scrollbar-thumb { background: var(--border-glow); border-radius: 3px; }

        .cockpit-tabs {
            display: flex;
            gap: 5px;
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-subtle);
            overflow-x: auto;
        }
        .cockpit-tab {
            padding: 8px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text-dim);
            font-size: 11px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }
        .cockpit-tab:hover { border-color: var(--accent-primary); color: var(--text-normal); }
        .cockpit-tab.active {
            background: linear-gradient(135deg, var(--accent-primary), var(--hud-cyan));
            border-color: var(--accent-primary);
            color: var(--bg-void);
        }

        .cockpit-content { padding: 15px; }
        .cockpit-tab-content { display: none; }
        .cockpit-tab-content.active { display: block; }

        /* AILYDIAN Popup - Agent Grid */
        .ailydian-modal { border-color: #8855ff; box-shadow: 0 0 40px rgba(136, 85, 255, 0.3); }
        .ailydian-modal .cockpit-header { background: linear-gradient(90deg, rgba(136, 85, 255, 0.3), transparent); }
        .ailydian-modal .cockpit-header h3 { color: #aa88ff; }

        .agent-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        .agent-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .agent-card:hover {
            border-color: #8855ff;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(136, 85, 255, 0.2);
        }
        .agent-card .agent-icon { font-size: 20px; margin-bottom: 6px; }
        .agent-card .agent-name { font-size: 11px; font-weight: 600; color: var(--text-bright); margin-bottom: 4px; }
        .agent-card .agent-type { font-size: 9px; color: var(--text-dim); }
        .agent-card .agent-status { font-size: 8px; color: var(--hud-green); margin-top: 4px; }

        /* THREAT Intel Popup */
        .threat-modal { border-color: #e91e63; box-shadow: 0 0 40px rgba(233, 30, 99, 0.3); }
        .threat-modal .cockpit-header { background: linear-gradient(90deg, rgba(233, 30, 99, 0.3), transparent); }
        .threat-modal .cockpit-header h3 { color: #ff4081; }

        .threat-feed { max-height: 200px; overflow-y: auto; }
        .threat-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-bottom: 1px solid var(--border-subtle);
            font-size: 11px;
        }
        .threat-item:last-child { border-bottom: none; }
        .threat-severity {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .threat-severity.critical { background: #ff0040; }
        .threat-severity.high { background: #ff6600; }
        .threat-severity.medium { background: #ffcc00; }
        .threat-severity.low { background: #00ccff; }

        /* PENTEST Popup */
        .pentest-modal { border-color: #ff5722; box-shadow: 0 0 40px rgba(255, 87, 34, 0.3); }
        .pentest-modal .cockpit-header { background: linear-gradient(90deg, rgba(255, 87, 34, 0.3), transparent); }
        .pentest-modal .cockpit-header h3 { color: #ff7043; }

        .pentest-projects { margin-top: 10px; }
        .pentest-project {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .pentest-project:hover { border-color: #ff5722; }

        /* DASHBOARD Popup */
        .dashboard-modal { border-color: #00bcd4; box-shadow: 0 0 40px rgba(0, 188, 212, 0.3); }
        .dashboard-modal .cockpit-header { background: linear-gradient(90deg, rgba(0, 188, 212, 0.3), transparent); }
        .dashboard-modal .cockpit-header h3 { color: #26c6da; }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .dashboard-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        .dashboard-card .card-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--hud-cyan);
            font-family: 'Orbitron', sans-serif;
        }
        .dashboard-card .card-label {
            font-size: 10px;
            color: var(--text-dim);
            margin-top: 5px;
        }

        /* BEYIN Popup */
        .beyin-modal { border-color: #9c27b0; box-shadow: 0 0 40px rgba(156, 39, 176, 0.3); }
        .beyin-modal .cockpit-header { background: linear-gradient(90deg, rgba(156, 39, 176, 0.3), transparent); }
        .beyin-modal .cockpit-header h3 { color: #ba68c8; }

        .defcon-display {
            text-align: center;
            padding: 20px;
            background: var(--bg-card);
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .defcon-level {
            font-size: 48px;
            font-weight: 900;
            font-family: 'Orbitron', sans-serif;
            text-shadow: 0 0 30px currentColor;
        }
        .defcon-5 { color: #00ff88; }
        .defcon-4 { color: #00ccff; }
        .defcon-3 { color: #ffcc00; }
        .defcon-2 { color: #ff6600; }
        .defcon-1 { color: #ff0040; animation: defconPulse 1s infinite; }
        @keyframes defconPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* VULN Popup */
        .vuln-modal { border-color: #ffc107; box-shadow: 0 0 40px rgba(255, 193, 7, 0.3); }
        .vuln-modal .cockpit-header { background: linear-gradient(90deg, rgba(255, 193, 7, 0.3), transparent); }
        .vuln-modal .cockpit-header h3 { color: #ffca28; }

        .vuln-stats {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .vuln-stat {
            flex: 1;
            background: var(--bg-card);
            border-radius: 6px;
            padding: 10px;
            text-align: center;
        }
        .vuln-stat .stat-value {
            font-size: 20px;
            font-weight: 700;
            font-family: 'Orbitron', sans-serif;
        }
        .vuln-stat .stat-label { font-size: 9px; color: var(--text-dim); }
        .vuln-critical { color: #ff0040; }
        .vuln-high { color: #ff6600; }
        .vuln-medium { color: #ffcc00; }
        .vuln-low { color: #00ccff; }

        .vuln-list { max-height: 200px; overflow-y: auto; }
        .vuln-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 10px;
            border-bottom: 1px solid var(--border-subtle);
            font-size: 11px;
        }

        /* Cockpit Input */
        .cockpit-input {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-void);
            border: 1px solid var(--border-glow);
            border-radius: 6px;
            color: var(--text-bright);
            font-size: 12px;
            margin-bottom: 10px;
        }
        .cockpit-input:focus { outline: none; border-color: var(--accent-primary); }

        .cockpit-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--accent-primary), var(--hud-cyan));
            border: none;
            border-radius: 6px;
            color: var(--bg-void);
            font-weight: 600;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .cockpit-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 180, 255, 0.3); }

        /* ==================== DALGA SIGINT Panel Styles ==================== */
        .sigint-panel {
            position: fixed;
            right: 10px;
            top: 70px;
            width: 320px;
            background: linear-gradient(180deg, rgba(15, 23, 42, 0.98) 0%, rgba(10, 15, 30, 0.98) 100%);
            border: 1px solid rgba(0, 200, 150, 0.3);
            border-radius: 12px;
            box-shadow: 0 0 30px rgba(0, 200, 150, 0.2), inset 0 0 20px rgba(0, 200, 150, 0.05);
            z-index: 1000;
            display: none;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }
        .sigint-panel.active { display: block; animation: sigintSlideIn 0.3s ease; }
        @keyframes sigintSlideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .sigint-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: linear-gradient(90deg, rgba(0, 200, 150, 0.15), transparent);
            border-bottom: 1px solid rgba(0, 200, 150, 0.2);
        }
        .sigint-header h3 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
            color: #00c896;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .sigint-close {
            background: none;
            border: none;
            color: rgba(255,255,255,0.5);
            font-size: 20px;
            cursor: pointer;
            padding: 0 5px;
            transition: color 0.2s;
        }
        .sigint-close:hover { color: #ff5555; }
        .sigint-body {
            padding: 12px;
            max-height: calc(100vh - 180px);
            overflow-y: auto;
        }
        .sigint-body::-webkit-scrollbar { width: 4px; }
        .sigint-body::-webkit-scrollbar-thumb { background: rgba(0, 200, 150, 0.3); border-radius: 2px; }
        .sigint-section {
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            border: 1px solid rgba(0, 200, 150, 0.1);
        }
        .sigint-section h4 {
            margin: 0 0 10px 0;
            font-size: 11px;
            font-weight: 600;
            color: rgba(255,255,255,0.6);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .sigint-btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        .sigint-btn {
            padding: 10px 12px;
            background: linear-gradient(135deg, rgba(0, 200, 150, 0.1), rgba(0, 150, 100, 0.05));
            border: 1px solid rgba(0, 200, 150, 0.3);
            border-radius: 6px;
            color: #00c896;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .sigint-btn:hover {
            background: rgba(0, 200, 150, 0.2);
            border-color: #00c896;
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0, 200, 150, 0.3);
        }
        .sigint-btn.scanning {
            background: rgba(0, 200, 150, 0.3);
            animation: sigintPulse 1.5s infinite;
        }
        @keyframes sigintPulse {
            0%, 100% { box-shadow: 0 0 5px rgba(0, 200, 150, 0.3); }
            50% { box-shadow: 0 0 15px rgba(0, 200, 150, 0.6); }
        }
        .sigint-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        .sigint-stats .stat-item {
            text-align: center;
            padding: 8px 4px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            border: 1px solid rgba(0, 200, 150, 0.1);
        }
        .sigint-stats .stat-value {
            display: block;
            font-size: 18px;
            font-weight: 700;
            color: #00c896;
        }
        .sigint-stats .stat-label {
            display: block;
            font-size: 9px;
            color: rgba(255,255,255,0.5);
            margin-top: 2px;
        }
        .sigint-stats .stat-item.threat .stat-value { color: #ff5555; }
        .sigint-layers label {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            margin-bottom: 4px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
            font-size: 11px;
            color: rgba(255,255,255,0.8);
            cursor: pointer;
            transition: background 0.2s;
        }
        .sigint-layers label:hover { background: rgba(0, 200, 150, 0.1); }
        .sigint-layers input[type="checkbox"] {
            accent-color: #00c896;
            width: 14px;
            height: 14px;
        }
        .sigint-alerts {
            max-height: 150px;
            overflow-y: auto;
        }
        .sigint-alert-item {
            padding: 8px 10px;
            margin-bottom: 6px;
            background: rgba(255, 80, 80, 0.1);
            border-left: 3px solid #ff5555;
            border-radius: 4px;
            font-size: 10px;
        }
        .sigint-alert-item.high { border-left-color: #ff8800; background: rgba(255, 136, 0, 0.1); }
        .sigint-alert-item.medium { border-left-color: #ffcc00; background: rgba(255, 204, 0, 0.1); }
        .sigint-alert-item.low { border-left-color: #00c896; background: rgba(0, 200, 150, 0.1); }
        .sigint-alert-time {
            color: rgba(255,255,255,0.4);
            font-size: 9px;
            margin-top: 4px;
        }
        /* SIGINT Device Popup */
        .sigint-device-popup {
            min-width: 200px;
        }
        .sigint-device-popup .device-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(0, 200, 150, 0.2);
            margin-bottom: 8px;
        }
        .sigint-device-popup .device-icon {
            width: 32px;
            height: 32px;
            background: rgba(0, 200, 150, 0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        .sigint-device-popup .device-name {
            font-weight: 600;
            color: #00c896;
            font-size: 13px;
        }
        .sigint-device-popup .device-type {
            font-size: 10px;
            color: rgba(255,255,255,0.5);
        }
        .sigint-device-popup .device-info {
            font-size: 11px;
            color: rgba(255,255,255,0.7);
        }
        .sigint-device-popup .device-info div {
            padding: 3px 0;
            display: flex;
            justify-content: space-between;
        }
        .sigint-device-popup .threat-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .sigint-device-popup .threat-badge.critical { background: #ff3355; color: white; }
        .sigint-device-popup .threat-badge.high { background: #ff8800; color: white; }
        .sigint-device-popup .threat-badge.medium { background: #ffcc00; color: #333; }
        .sigint-device-popup .threat-badge.low { background: #00c896; color: white; }

        /* ═══════════════════════════════════════════════════════════════════
           RESPONSIVE TASARIM - Mobil ve Tablet Uyumluluk
           ═══════════════════════════════════════════════════════════════════ */

        /* Tablet (1200px ve altı) */
        @media screen and (max-width: 1200px) {
            .top-bar {
                padding: 10px 15px;
            }
            .btn-group {
                overflow-x: auto;
                flex-wrap: nowrap;
                gap: 6px;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: thin;
                scrollbar-color: rgba(0,255,136,0.5) rgba(0,0,0,0.3);
                padding-bottom: 6px;
            }
            .btn-group::-webkit-scrollbar {
                height: 3px;
            }
            .btn-group::-webkit-scrollbar-track {
                background: rgba(0,0,0,0.2);
                border-radius: 2px;
            }
            .btn-group::-webkit-scrollbar-thumb {
                background: linear-gradient(90deg, #00ff88, #00b4ff);
                border-radius: 2px;
            }
            .btn, .btn-unified, .btn-lydian, .btn-gnn, .btn-osint, .btn-shodan {
                padding: 6px 10px;
                font-size: 9px;
                white-space: nowrap;
                flex-shrink: 0;
            }
            .logo h1 {
                font-size: 16px;
            }
        }

        /* Küçük Tablet / Büyük Mobil (992px ve altı) */
        @media screen and (max-width: 992px) {
            .top-bar {
                flex-wrap: wrap;
                gap: 10px;
                padding: 10px;
                position: relative;
            }
            .btn-group {
                width: 100%;
                overflow-x: auto;
                flex-wrap: nowrap;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: thin;
                scrollbar-color: rgba(0,255,136,0.5) rgba(0,0,0,0.3);
                padding-bottom: 8px;
                margin-bottom: -3px;
                /* Scroll indicator shadow */
                mask-image: linear-gradient(90deg, #000 90%, transparent 100%);
                -webkit-mask-image: linear-gradient(90deg, #000 90%, transparent 100%);
            }
            .btn-group::-webkit-scrollbar {
                height: 4px;
            }
            .btn-group::-webkit-scrollbar-track {
                background: rgba(0,0,0,0.3);
                border-radius: 2px;
            }
            .btn-group::-webkit-scrollbar-thumb {
                background: linear-gradient(90deg, #00ff88, #00b4ff);
                border-radius: 2px;
            }
            .btn-group::-webkit-scrollbar-thumb:hover {
                background: linear-gradient(90deg, #00ffaa, #00d4ff);
            }
            .logo-icon {
                width: 32px;
                height: 32px;
            }
            .logo h1 {
                font-size: 14px;
            }
            .logo span {
                display: none;
            }
        }

        /* Mobil (768px ve altı) */
        @media screen and (max-width: 768px) {
            .top-bar {
                padding: 8px;
            }
            .btn, .btn-unified, .btn-lydian, .btn-gnn, .btn-osint, .btn-shodan {
                padding: 6px 8px;
                font-size: 8px;
                white-space: nowrap;
            }
            .ghost-box {
                display: none;
            }
            #quickLayerSwitch {
                left: 10px;
                bottom: 55px;
                padding: 3px 4px;
            }
            #quickLayerSwitch .ql-btn {
                padding: 4px 6px;
                font-size: 7px;
            }
            #quickLayerSwitch .ql-zoom-btn {
                width: 24px !important;
                height: 24px !important;
                font-size: 14px !important;
            }
            .legend {
                display: none;
            }
        }

        /* Küçük Mobil (480px ve altı) */
        @media screen and (max-width: 480px) {
            .logo h1 {
                font-size: 12px;
                letter-spacing: 1px;
            }
            .btn-group .btn {
                min-width: auto;
            }
            .sidebar {
                width: 100%;
                left: -100%;
            }
            .sidebar.open {
                left: 0;
            }
        }

    </style>
</head>
<body>
    <!-- TSUNAMI Premium Icon Library -->
    <svg style="display:none">
        <defs>
            <!-- Chevron icons -->
            <symbol id="icon-chevron-down" viewBox="0 0 24 24">
                <path d="M6 9l6 6 6-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </symbol>
            <symbol id="icon-chevron-right" viewBox="0 0 24 24">
                <path d="M9 6l6 6-6 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </symbol>
            <symbol id="icon-chevron-left" viewBox="0 0 24 24">
                <path d="M15 6l-6 6 6 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </symbol>

            <!-- Widget icons -->
            <symbol id="icon-zap" viewBox="0 0 24 24">
                <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" fill="none" stroke="currentColor" stroke-width="2"/>
            </symbol>
            <symbol id="icon-grid" viewBox="0 0 24 24">
                <rect x="3" y="3" width="7" height="7" rx="1" fill="none" stroke="currentColor" stroke-width="2"/>
                <rect x="14" y="3" width="7" height="7" rx="1" fill="none" stroke="currentColor" stroke-width="2"/>
                <rect x="3" y="14" width="7" height="7" rx="1" fill="none" stroke="currentColor" stroke-width="2"/>
                <rect x="14" y="14" width="7" height="7" rx="1" fill="none" stroke="currentColor" stroke-width="2"/>
            </symbol>
            <symbol id="icon-shield" viewBox="0 0 24 24">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" fill="none" stroke="currentColor" stroke-width="2"/>
            </symbol>
            <symbol id="icon-cpu" viewBox="0 0 24 24">
                <rect x="4" y="4" width="16" height="16" rx="2" fill="none" stroke="currentColor" stroke-width="2"/>
                <rect x="9" y="9" width="6" height="6" fill="none" stroke="currentColor" stroke-width="2"/>
                <path d="M9 1v3M15 1v3M9 20v3M15 20v3M1 9h3M1 15h3M20 9h3M20 15h3" stroke="currentColor" stroke-width="2"/>
            </symbol>
            <symbol id="icon-map" viewBox="0 0 24 24">
                <path d="M1 6v16l7-4 8 4 7-4V2l-7 4-8-4-7 4z" fill="none" stroke="currentColor" stroke-width="2"/>
                <path d="M8 2v16M16 6v16" stroke="currentColor" stroke-width="2"/>
            </symbol>
            <symbol id="icon-globe" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/>
                <path d="M2 12h20M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z" fill="none" stroke="currentColor" stroke-width="2"/>
            </symbol>
            <symbol id="icon-brain" viewBox="0 0 24 24">
                <path d="M12 4.5a2.5 2.5 0 00-4.96-.46 2.5 2.5 0 00-1.98 3 2.5 2.5 0 00-1.32 4.24 3 3 0 00.34 5.58 2.5 2.5 0 002.96 3.08A2.5 2.5 0 0012 19.5a2.5 2.5 0 004.96.44 2.5 2.5 0 002.96-3.08 3 3 0 00.34-5.58 2.5 2.5 0 00-1.32-4.24 2.5 2.5 0 00-1.98-3A2.5 2.5 0 0012 4.5" fill="none" stroke="currentColor" stroke-width="2"/>
                <path d="M12 4.5v15" stroke="currentColor" stroke-width="2"/>
            </symbol>
            <symbol id="icon-radar" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/>
                <circle cx="12" cy="12" r="6" fill="none" stroke="currentColor" stroke-width="2"/>
                <circle cx="12" cy="12" r="2" fill="none" stroke="currentColor" stroke-width="2"/>
                <path d="M12 2v4M12 18v4" stroke="currentColor" stroke-width="2"/>
            </symbol>
            <symbol id="icon-chart" viewBox="0 0 24 24">
                <path d="M3 3v18h18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M7 16l4-4 4 4 5-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </symbol>
            <symbol id="icon-menu" viewBox="0 0 24 24">
                <path d="M3 12h18M3 6h18M3 18h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </symbol>
            <symbol id="icon-wifi" viewBox="0 0 24 24">
                <path d="M5 12.55a11 11 0 0114 0" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M1.42 9a16 16 0 0121.16 0" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M8.53 16.11a6 6 0 016.95 0" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <circle cx="12" cy="20" r="1" fill="currentColor"/>
            </symbol>
            <symbol id="icon-bot" viewBox="0 0 24 24">
                <rect x="3" y="11" width="18" height="10" rx="2" fill="none" stroke="currentColor" stroke-width="2"/>
                <circle cx="12" cy="5" r="2" fill="none" stroke="currentColor" stroke-width="2"/>
                <path d="M12 7v4" stroke="currentColor" stroke-width="2"/>
                <circle cx="8" cy="16" r="1" fill="currentColor"/>
                <circle cx="16" cy="16" r="1" fill="currentColor"/>
            </symbol>
            <symbol id="icon-eye" viewBox="0 0 24 24">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" fill="none" stroke="currentColor" stroke-width="2"/>
                <circle cx="12" cy="12" r="3" fill="none" stroke="currentColor" stroke-width="2"/>
            </symbol>
        </defs>
    </svg>

    <div id="map"></div>

    <!-- Saldiri Tooltip -->
    <div class="attack-tooltip" id="attackTooltip" onclick="event.stopPropagation();">
        <div class="tooltip-close" onclick="closeTooltip()">&times;</div>
        <div class="tooltip-header">
            <span class="tooltip-type" id="ttType">DDoS</span>
            <span class="tooltip-severity critical" id="ttSeverity">KRİTİK</span>
        </div>
        <div class="tooltip-row"><span class="label">Kaynak IP</span><span class="value" id="ttSrcIP">-</span></div>
        <div class="tooltip-row"><span class="label">Kaynak Ülke</span><span class="value" id="ttSrcCountry">-</span></div>
        <div class="tooltip-row"><span class="label">Hedef</span><span class="value" id="ttTarget">-</span></div>
        <div class="tooltip-row"><span class="label">Port</span><span class="value" id="ttPort">-</span></div>
        <div class="tooltip-row"><span class="label">Protokol</span><span class="value" id="ttProtocol">-</span></div>
        <div class="tooltip-row"><span class="label">Paket Sayısı</span><span class="value" id="ttPackets">-</span></div>
        <div class="tooltip-row"><span class="label">Bant Genişliği</span><span class="value" id="ttBandwidth">-</span></div>
        <div class="tooltip-actions">
            <button class="tt-btn danger" onclick="ipEngelle()"><svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/></svg> Engelle</button>
            <button class="tt-btn primary" onclick="osintAnaliz()"><svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5z"/></svg> OSINT</button>
            <button class="tt-btn secondary" onclick="raporOlustur()"><svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg> Rapor</button>
        </div>
        <div class="tooltip-actions tsunami-power">
            <button class="tt-btn ai-btn" onclick="aiSaldiriAnaliz()"><svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M21 10.12h-6.78l2.74-2.82c-2.73-2.7-7.15-2.8-9.88-.1-2.73 2.71-2.73 7.08 0 9.79s7.15 2.71 9.88 0C18.32 15.65 19 14.08 19 12.1h2c0 1.98-.88 4.55-2.64 6.29-3.51 3.48-9.21 3.48-12.72 0-3.5-3.47-3.53-9.11-.02-12.58s9.14-3.47 12.65 0L21 3v7.12z"/></svg> AI Analiz</button>
            <button class="tt-btn counter-btn" onclick="karsiSaldiri()"><svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M6.92 5.51l-1.4 1.4c-.12.12-.29.19-.46.19H3.59c-.89 0-1.34 1.08-.71 1.71l1.41 1.41-4.24 4.24 7.07 7.07 4.24-4.24 1.41 1.41c.63.63 1.71.18 1.71-.71V14.5c0-.17.07-.34.19-.46l1.4-1.4c.63-.63.18-1.71-.71-1.71h-2.83z"/></svg> Saldiri</button>
            <button class="tt-btn watch-btn" onclick="saldiriIzle()"><svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/></svg> Izle</button>
        </div>
        <div class="tooltip-actions shodan-actions">
            <button class="tt-btn shodan-btn" onclick="shodanScan()"><svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"/></svg> Shodan</button>
            <button class="tt-btn cell-btn" onclick="findNearbyTowers()"><svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M17.7 7.7L12 2 6.3 7.7c-3.1 3.1-3.1 8.2 0 11.3 1.6 1.6 3.6 2.3 5.7 2.3s4.1-.8 5.7-2.3c3.1-3.1 3.1-8.2 0-11.3zM12 19.6c-1.6 0-3.1-.6-4.2-1.8-2.4-2.4-2.4-6.2 0-8.5L12 5.1l4.2 4.2c2.4 2.4 2.4 6.2 0 8.5-1.2 1.2-2.7 1.8-4.2 1.8z"/></svg> Kuleler</button>
            <button class="tt-btn vuln-btn" onclick="findVulnDevices()"><svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg> Zafiyetler</button>
        </div>
        <!-- SİBER KOMUTA BUTONLARI -->
        <div class="tooltip-actions siber-actions">
            <button class="tt-btn siber-btn" onclick="siberAnaliz()"><svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg> Siber</button>
            <button class="tt-btn tehdit-btn" onclick="siberTehditAvi()"><svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg> Tehdit</button>
            <button class="tt-btn ajan-btn" onclick="siberAjanGorev()"><svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg> Ajan</button>
            <button class="tt-btn ucak-btn" onclick="siberHavaSahasi()"><svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/></svg> Hava</button>
        </div>

        <!-- CANLI TEHDIT STREAM KONTROLLERLERI - Palantir-Style -->
        <div class="tooltip-actions canli-tehdit-actions">
            <button class="tt-btn stream-start-btn" onclick="startLiveThreatStreamFromUI()"><svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg> Başlat</button>
            <button class="tt-btn stream-stop-btn" onclick="stopLiveThreatStreamFromUI()"><svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h12v12H6z"/></svg> Durdur</button>
        </div>

        <!-- AI THREAT PREDICTION - Palantir-Style Predictive Analytics -->
        <div class="tooltip-actions ai-tahmin-actions">
            <button class="tt-btn ai-btn" onclick="aiTahminGoster()"><svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.5c0 1.3-.3 2.5-.8 3.6l-1.5.9c-.3.8-.1-1.6.1-2.3.3-2.9.6-.2.9.3-.5.6-.8-.8-.8-.5-2.2-.8-3.4-.4-1.3-.8-2.6-1.1-3.9-.3-1.2-.6-2.4-.9-3.6-.2-1.3.3-2.6.5-3.9.7-.3.3-.5-.5-.8-.8-.7-1.6.5-3.3.8-5.1.1-1.9.1-3.7.2-5.5.3-.2.2-.4.3-.5.6-.7-.8-.7-1.9.5-3.7.1-5.5.3-.2-.3-.5-.6-.7-.8-.7-.7-1.6-.5-3.3.8-5.1.1-1.9-.1-3.7.2-5.5.3-.1-.3-.3-.6-.5-.8-.7-1-.7-1.6.1-3.3.4-5.1.7-.1.1-.3-.3-.5-.6-.8-.7-.7-1-.7-.7-1.6-.6-3.3.4-5.1.7-.1.1-.3-.3-.6-.7-.8-.7-.7-1-.7-.6-1.6-.8-3.3.4-5.1.7-.1-.1-.3-.3-.6-.7-.8-.7-.7-1-.7-.6-1.6-.6-3.3.4-5.1.7-.1-.1-.3-.3-.6-.7-.8-.7-.7-1-.7-.5-1.6-.8-3.3.4-5.1.7-.1-.1-.3-.3-.6-.7-.8-.7-.7-1-.7-.5-1.6-.8-3.3.4-5.1.7-.1-.1-.3-.3-.6-.7-.8-.7-.7-1-.7-.5-1.6-.8-3.3.4-5.1.7-.1-.1-.3-.3-.6-.7-.8-.7-.7-1-.5-1.6-.8-3.3.4-5.1.7-.1-.1-.3-.3-.6-.7-.8-.7-1-.5-1.6-.8-3.3.4-5.1.7-.1-.1-.3-.3-.6-.7-.8-.7-1-.5-1.6-.8-3.3.4-5.1.7-.1-.1-.3-.3-.6-.7-.8-.7-1-.5-1.6-.8-3.3.4-5.1.7-.1-.1-.3-.3-.6-.7-.8-.7-1-.5-1.6-.8-3.3.4-5.1.7z"/></svg> AI Tahmin</button>
            <button class="tt-btn ai-btn" onclick="aiCokluTahminGoster()"><svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5v-5h5v5zm-7 2h5v-5H5v5z"/></svg> Çoklu</button>
        </div>
    </div>

    <!-- Street View Modal - Gelismis Versiyon -->
    <div class="streetview-modal" id="svModal">
        <div class="sv-container" style="width:90%;max-width:1200px;height:80vh;">
            <div class="sv-header" style="display:flex;justify-content:space-between;align-items:center;padding:10px 15px;background:linear-gradient(135deg,#1a1a2e,#0d0d1a);border-bottom:2px solid #00b4ff;">
                <h3 id="svTitle" style="margin:0;color:#00b4ff;font-size:14px;">Konum Goruntulu</h3>
                <div style="display:flex;gap:8px;align-items:center;">
                    <select id="svProvider" onchange="changeStreetViewProvider()" style="padding:5px 10px;background:#0d0d1a;border:1px solid #00b4ff;border-radius:4px;color:#00b4ff;font-size:11px;">
                        <option value="google">Google Street View</option>
                        <option value="osm">OpenStreetMap</option>
                        <option value="mapillary">Mapillary</option>
                        <option value="yandex">Yandex Panorama</option>
                    </select>
                    <button onclick="openInNewTab()" style="padding:5px 10px;background:rgba(0,180,255,0.2);border:1px solid #00b4ff;border-radius:4px;color:#00b4ff;font-size:11px;cursor:pointer;">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/></svg>
                    </button>
                    <button class="sv-close" onclick="closeSV()" style="width:30px;height:30px;background:#ff3355;border:none;border-radius:50%;color:#fff;font-size:18px;cursor:pointer;">&times;</button>
                </div>
            </div>
            <div style="display:flex;height:calc(100% - 50px);">
                <iframe class="sv-iframe" id="svFrame" src="" style="flex:1;border:none;"></iframe>
                <div id="svInfoPanel" style="width:250px;background:#0d0d1a;padding:10px;overflow-y:auto;border-left:1px solid #333;">
                    <div style="font-size:10px;color:#666;text-transform:uppercase;margin-bottom:8px;">Konum Bilgisi</div>
                    <div id="svCoords" style="font-size:11px;color:#00b4ff;margin-bottom:10px;">-</div>
                    <div id="svAddress" style="font-size:11px;color:#888;margin-bottom:15px;">Yukleniyor...</div>
                    <div style="font-size:10px;color:#666;text-transform:uppercase;margin-bottom:8px;">Hizli Islemler</div>
                    <button onclick="svOsintAnaliz()" style="width:100%;padding:8px;margin-bottom:5px;background:rgba(136,85,255,0.2);border:1px solid #8855ff;border-radius:4px;color:#8855ff;font-size:10px;cursor:pointer;">OSINT Analiz</button>
                    <button onclick="svWifiTara()" style="width:100%;padding:8px;margin-bottom:5px;background:rgba(0,180,255,0.2);border:1px solid #00b4ff;border-radius:4px;color:#00b4ff;font-size:10px;cursor:pointer;">WiFi Tara</button>
                    <button onclick="svGhostKaydet()" style="width:100%;padding:8px;margin-bottom:5px;background:rgba(0,255,136,0.2);border:1px solid #00ff88;border-radius:4px;color:#00ff88;font-size:10px;cursor:pointer;">GHOST'a Kaydet</button>
                    <button onclick="svRaporOlustur()" style="width:100%;padding:8px;background:rgba(255,170,0,0.2);border:1px solid #ffaa00;border-radius:4px;color:#ffaa00;font-size:10px;cursor:pointer;">Rapor Olustur</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Harita Katman Secici + Zoom Butonlari - Sol Alt Tek Satir -->
    <div id="quickLayerSwitch" style="position:fixed;bottom:60px;left:95px;z-index:9999;background:rgba(10,10,15,0.95);border:1px solid #333;border-radius:6px;padding:6px 8px;font-family:'Courier New',monospace;backdrop-filter:blur(10px);">
        <div style="display:flex;gap:4px;align-items:center;">
            <button onclick="switchToLayer('Siber Mod')" data-layer="Siber Mod" class="ql-btn" style="padding:6px 10px;background:rgba(0,180,255,0.15);border:1px solid rgba(0,180,255,0.4);border-radius:4px;color:#00b4ff;font-size:10px;cursor:pointer;font-family:'Courier New',monospace;text-transform:uppercase;transition:all 0.2s;">SİBER</button>
            <button onclick="switchToLayer('Uydu (ESRI)')" data-layer="Uydu (ESRI)" class="ql-btn" style="padding:6px 10px;background:rgba(255,255,255,0.05);border:1px solid #444;border-radius:4px;color:#888;font-size:10px;cursor:pointer;font-family:'Courier New',monospace;text-transform:uppercase;transition:all 0.2s;">UYDU</button>
            <button onclick="switchToLayer('Google Uydu')" data-layer="Google Uydu" class="ql-btn" style="padding:6px 10px;background:rgba(255,255,255,0.05);border:1px solid #444;border-radius:4px;color:#888;font-size:10px;cursor:pointer;font-family:'Courier New',monospace;text-transform:uppercase;transition:all 0.2s;">GOOGLE</button>
            <button onclick="switchToLayer('Detayli Harita')" data-layer="Detayli Harita" class="ql-btn" style="padding:6px 10px;background:rgba(255,255,255,0.05);border:1px solid #444;border-radius:4px;color:#888;font-size:10px;cursor:pointer;font-family:'Courier New',monospace;text-transform:uppercase;transition:all 0.2s;">DETAY</button>
            <div style="width:1px;height:20px;background:#444;margin:0 2px;"></div>
            <button onclick="map.setZoom(map.getZoom()+1)" class="ql-zoom-btn" style="width:28px;height:28px;background:rgba(0,255,136,0.1);border:1px solid rgba(0,255,136,0.4);border-radius:4px;color:#00ff88;cursor:pointer;font-size:16px;font-weight:bold;transition:all 0.2s;display:flex;align-items:center;justify-content:center;" onmouseover="this.style.borderColor='#00ff88';this.style.boxShadow='0 0 10px rgba(0,255,136,0.3)'" onmouseout="this.style.borderColor='rgba(0,255,136,0.4)';this.style.boxShadow='none'">+</button>
            <button onclick="map.setZoom(map.getZoom()-1)" class="ql-zoom-btn" style="width:28px;height:28px;background:rgba(0,255,136,0.1);border:1px solid rgba(0,255,136,0.4);border-radius:4px;color:#00ff88;cursor:pointer;font-size:16px;font-weight:bold;transition:all 0.2s;display:flex;align-items:center;justify-content:center;" onmouseover="this.style.borderColor='#00ff88';this.style.boxShadow='0 0 10px rgba(0,255,136,0.3)'" onmouseout="this.style.borderColor='rgba(0,255,136,0.4)';this.style.boxShadow='none'">−</button>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════════
         CANLI TEHDİT HARİTASI POPUP - Global Threat Map Entegrasyonu
         ═══════════════════════════════════════════════════════════════════ -->
    <div id="threatMapModal" class="tsunami-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:10000;overflow:auto;">
        <div style="max-width:1400px;margin:20px auto;background:linear-gradient(135deg,#0a0a0f 0%,#1a1a2e 100%);border:1px solid #ff3355;border-radius:12px;overflow:hidden;">
            <!-- Header -->
            <div style="padding:15px 20px;background:linear-gradient(90deg,rgba(255,51,85,0.2),transparent);border-bottom:1px solid #ff3355;display:flex;justify-content:space-between;align-items:center;">
                <div style="display:flex;align-items:center;gap:12px;">
                    <div style="width:40px;height:40px;background:linear-gradient(135deg,#ff3355,#ff6b35);border-radius:8px;display:flex;align-items:center;justify-content:center;">
                        <svg width="24" height="24" fill="white" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                    </div>
                    <div>
                        <h2 style="margin:0;color:#ff3355;font-family:'Orbitron',monospace;font-size:18px;">CANLI TEHDİT HARİTASI</h2>
                        <span style="color:#888;font-size:11px;">Global Threat Intelligence • Real-Time</span>
                    </div>
                </div>
                <button onclick="closeThreatMapModal()" style="background:rgba(255,51,85,0.2);border:1px solid #ff3355;color:#ff3355;padding:8px 16px;border-radius:6px;cursor:pointer;font-family:'Orbitron',monospace;">KAPAT</button>
            </div>

            <!-- Content -->
            <div style="padding:20px;">
                <!-- Stats Bar -->
                <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:15px;margin-bottom:20px;">
                    <div style="background:rgba(255,51,85,0.1);border:1px solid rgba(255,51,85,0.3);border-radius:8px;padding:15px;text-align:center;">
                        <div id="threatStatCritical" style="color:#ff3355;font-size:28px;font-weight:bold;font-family:'Orbitron',monospace;">0</div>
                        <div style="color:#888;font-size:10px;text-transform:uppercase;">Kritik</div>
                    </div>
                    <div style="background:rgba(255,136,0,0.1);border:1px solid rgba(255,136,0,0.3);border-radius:8px;padding:15px;text-align:center;">
                        <div id="threatStatHigh" style="color:#ff8800;font-size:28px;font-weight:bold;font-family:'Orbitron',monospace;">0</div>
                        <div style="color:#888;font-size:10px;text-transform:uppercase;">Yüksek</div>
                    </div>
                    <div style="background:rgba(255,200,0,0.1);border:1px solid rgba(255,200,0,0.3);border-radius:8px;padding:15px;text-align:center;">
                        <div id="threatStatMedium" style="color:#ffc800;font-size:28px;font-weight:bold;font-family:'Orbitron',monospace;">0</div>
                        <div style="color:#888;font-size:10px;text-transform:uppercase;">Orta</div>
                    </div>
                    <div style="background:rgba(0,255,136,0.1);border:1px solid rgba(0,255,136,0.3);border-radius:8px;padding:15px;text-align:center;">
                        <div id="threatStatLow" style="color:#00ff88;font-size:28px;font-weight:bold;font-family:'Orbitron',monospace;">0</div>
                        <div style="color:#888;font-size:10px;text-transform:uppercase;">Düşük</div>
                    </div>
                    <div style="background:rgba(0,180,255,0.1);border:1px solid rgba(0,180,255,0.3);border-radius:8px;padding:15px;text-align:center;">
                        <div id="threatStatTotal" style="color:#00b4ff;font-size:28px;font-weight:bold;font-family:'Orbitron',monospace;">0</div>
                        <div style="color:#888;font-size:10px;text-transform:uppercase;">Toplam</div>
                    </div>
                </div>

                <!-- Map Container -->
                <div id="threatMapContainer" style="height:500px;background:#0a0a0f;border:1px solid #333;border-radius:8px;position:relative;overflow:hidden;">
                    <div id="threatMapLoading" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;">
                        <div style="width:50px;height:50px;border:3px solid #333;border-top-color:#ff3355;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 15px;"></div>
                        <div style="color:#ff3355;font-family:'Orbitron',monospace;">Tehdit Verileri Yükleniyor...</div>
                    </div>
                </div>

                <!-- Controls -->
                <div style="margin-top:15px;display:flex;gap:10px;flex-wrap:wrap;">
                    <button onclick="showTurkeyView(); loadThreatData('TR')" style="padding:10px 20px;background:rgba(255,51,85,0.2);border:1px solid #ff3355;color:#ff3355;border-radius:6px;cursor:pointer;font-family:'Courier New',monospace;transition:all 0.3s;" onmouseover="this.style.background='rgba(255,51,85,0.4)'" onmouseout="this.style.background='rgba(255,51,85,0.2)'">🇹🇷 Türkiye</button>
                    <button onclick="showWorldView(); loadThreatData('all')" style="padding:10px 20px;background:rgba(0,180,255,0.2);border:1px solid #00b4ff;color:#00b4ff;border-radius:6px;cursor:pointer;font-family:'Courier New',monospace;transition:all 0.3s;" onmouseover="this.style.background='rgba(0,180,255,0.4)'" onmouseout="this.style.background='rgba(0,180,255,0.2)'">🌍 Dünya (Animasyonlu)</button>
                    <button onclick="simulateThreatData()" style="padding:10px 20px;background:rgba(138,43,226,0.2);border:1px solid #8a2be2;color:#8a2be2;border-radius:6px;cursor:pointer;font-family:'Courier New',monospace;transition:all 0.3s;" onmouseover="this.style.background='rgba(138,43,226,0.4)'" onmouseout="this.style.background='rgba(138,43,226,0.2)'">⚡ Demo Simülasyonu</button>
                    <button onclick="refreshThreatData()" style="padding:10px 20px;background:rgba(0,255,136,0.2);border:1px solid #00ff88;color:#00ff88;border-radius:6px;cursor:pointer;font-family:'Courier New',monospace;transition:all 0.3s;" onmouseover="this.style.background='rgba(0,255,136,0.4)'" onmouseout="this.style.background='rgba(0,255,136,0.2)'">🔄 Yenile</button>
                </div>

                <!-- Threat Feed -->
                <div style="margin-top:20px;">
                    <h3 style="color:#ff3355;font-family:'Orbitron',monospace;font-size:14px;margin-bottom:10px;">SON TEHDİTLER</h3>
                    <div id="threatFeed" style="max-height:200px;overflow-y:auto;background:rgba(0,0,0,0.3);border:1px solid #333;border-radius:8px;padding:10px;">
                        <div style="color:#666;text-align:center;padding:20px;">Veri bekleniyor...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════════
         WAF CHECKER POPUP - WAF-Checker Entegrasyonu
         ═══════════════════════════════════════════════════════════════════ -->
    <div id="wafCheckerModal" class="tsunami-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:10000;overflow:auto;">
        <div style="max-width:900px;margin:40px auto;background:linear-gradient(135deg,#0a0a0f 0%,#1a1a2e 100%);border:1px solid #00b4ff;border-radius:12px;overflow:hidden;">
            <!-- Header -->
            <div style="padding:15px 20px;background:linear-gradient(90deg,rgba(0,180,255,0.2),transparent);border-bottom:1px solid #00b4ff;display:flex;justify-content:space-between;align-items:center;">
                <div style="display:flex;align-items:center;gap:12px;">
                    <div style="width:40px;height:40px;background:linear-gradient(135deg,#00b4ff,#0066ff);border-radius:8px;display:flex;align-items:center;justify-content:center;">
                        <svg width="24" height="24" fill="white" viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>
                    </div>
                    <div>
                        <h2 style="margin:0;color:#00b4ff;font-family:'Orbitron',monospace;font-size:18px;">WAF CHECKER</h2>
                        <span style="color:#888;font-size:11px;">Web Application Firewall Detection & Testing</span>
                    </div>
                </div>
                <button onclick="closeWafCheckerModal()" style="background:rgba(0,180,255,0.2);border:1px solid #00b4ff;color:#00b4ff;padding:8px 16px;border-radius:6px;cursor:pointer;font-family:'Orbitron',monospace;">KAPAT</button>
            </div>

            <!-- Content -->
            <div style="padding:20px;">
                <!-- URL Input -->
                <div style="margin-bottom:20px;">
                    <label style="color:#00b4ff;font-size:12px;display:block;margin-bottom:8px;">Hedef URL</label>
                    <div style="display:flex;gap:10px;">
                        <input type="text" id="wafTargetUrl" placeholder="https://example.com" style="flex:1;padding:12px 15px;background:rgba(0,0,0,0.5);border:1px solid #333;border-radius:6px;color:#fff;font-family:'Courier New',monospace;font-size:14px;">
                        <button onclick="detectWaf()" style="padding:12px 25px;background:linear-gradient(135deg,#00b4ff,#0066ff);border:none;color:white;border-radius:6px;cursor:pointer;font-family:'Orbitron',monospace;font-weight:bold;">WAF TESPİT</button>
                    </div>
                </div>

                <!-- WAF Detection Result -->
                <div id="wafDetectionResult" style="display:none;background:rgba(0,0,0,0.3);border:1px solid #333;border-radius:8px;padding:20px;margin-bottom:20px;">
                    <h3 style="color:#00b4ff;margin:0 0 15px;font-family:'Orbitron',monospace;font-size:14px;">WAF TESPİT SONUCU</h3>
                    <div id="wafResultContent"></div>
                </div>

                <!-- Payload Test Section -->
                <div style="background:rgba(0,0,0,0.3);border:1px solid #333;border-radius:8px;padding:20px;margin-bottom:20px;">
                    <h3 style="color:#ff8800;margin:0 0 15px;font-family:'Orbitron',monospace;font-size:14px;">PAYLOAD TESTİ</h3>
                    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:15px;">
                        <label style="display:flex;align-items:center;gap:8px;color:#ccc;font-size:12px;cursor:pointer;">
                            <input type="checkbox" id="wafCatSql" checked style="accent-color:#ff8800;"> SQL Injection
                        </label>
                        <label style="display:flex;align-items:center;gap:8px;color:#ccc;font-size:12px;cursor:pointer;">
                            <input type="checkbox" id="wafCatXss" checked style="accent-color:#ff8800;"> XSS
                        </label>
                        <label style="display:flex;align-items:center;gap:8px;color:#ccc;font-size:12px;cursor:pointer;">
                            <input type="checkbox" id="wafCatCmd" style="accent-color:#ff8800;"> Command Injection
                        </label>
                        <label style="display:flex;align-items:center;gap:8px;color:#ccc;font-size:12px;cursor:pointer;">
                            <input type="checkbox" id="wafCatPath" style="accent-color:#ff8800;"> Path Traversal
                        </label>
                    </div>
                    <button onclick="testWafPayloads()" style="padding:12px 25px;background:linear-gradient(135deg,#ff8800,#ff5500);border:none;color:white;border-radius:6px;cursor:pointer;font-family:'Orbitron',monospace;font-weight:bold;">PAYLOAD TESTİ BAŞLAT</button>
                </div>

                <!-- Test Results -->
                <div id="wafTestResults" style="display:none;background:rgba(0,0,0,0.3);border:1px solid #333;border-radius:8px;padding:20px;">
                    <h3 style="color:#00ff88;margin:0 0 15px;font-family:'Orbitron',monospace;font-size:14px;">TEST SONUÇLARI</h3>
                    <div id="wafTestContent"></div>
                </div>

                <!-- Bypass Suggestions -->
                <div id="wafBypassSection" style="display:none;background:rgba(138,43,226,0.1);border:1px solid #8a2be2;border-radius:8px;padding:20px;margin-top:20px;">
                    <h3 style="color:#8a2be2;margin:0 0 15px;font-family:'Orbitron',monospace;font-size:14px;">BYPASS ÖNERİLERİ</h3>
                    <div id="wafBypassContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ust Bar -->
    <div class="top-bar">
        <div class="logo">
            <div class="logo-icon"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg></div>
            <div><h1>TSUNAMI</h1><span>Otonom Siber v5.0</span></div>
        </div>
        <div class="btn-group-wrapper" id="btnGroupWrapper">
        <div class="btn-group" id="headerBtnGroup">
            <button class="btn btn-unified" onclick="gnnPanelAc()" title="GNN Tehdit Ağı Görselleştirme">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="animation:neuralPulse 2s ease-in-out infinite"><path d="M13 3a9 9 0 0 0-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42A8.954 8.954 0 0 0 13 21a9 9 0 0 0 0-18zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg>
                GNN
            </button>
            <button class="btn btn-unified" onclick="osintPanelAc()" title="OSINT İstihbarat Toplama">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="animation:scanSweep 3s ease-in-out infinite"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                OSINT
            </button>
            <button class="btn btn-unified" onclick="openShodanPanel()" title="Shodan İstihbarat">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="animation:radarSweep 2s linear infinite"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm-5-9c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm5-5c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm5 5c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1z"/></svg>
                Shodan
            </button>
            <button class="btn btn-unified" onclick="threatIntelPanelAc()" title="Küresel Tehdit İstihbaratı">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="animation:shieldPulse 2s ease-in-out infinite"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>
                THREAT
            </button>
            <button class="btn btn-threat" onclick="openThreatMapModal()" title="Canlı Tehdit Haritası - Global Threat Map">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                LIVE
            </button>
            <button class="btn btn-unified" onclick="openWafCheckerModal()" title="WAF Checker - Firewall Test" style="background:linear-gradient(135deg,rgba(0,180,255,0.3),rgba(0,100,180,0.15));border-color:rgba(0,180,255,0.5);">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="#00b4ff"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/></svg>
                WAF
            </button>
            <button class="btn btn-unified" onclick="pentestPanelAc()" title="Penetrasyon Test Merkezi">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="animation:targetLock 1.5s ease-in-out infinite"><path d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm0 10c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4zm0-6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
                PENTEST
            </button>
            <button class="btn btn-unified" onclick="dashboardPanelAc()" title="Kontrol Paneli">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>
                PANEL
            </button>
            <button class="btn btn-unified" onclick="beyinPanelAc()" title="Otonom Zeka Merkezi">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="animation:dnaPulse 3s ease-in-out infinite"><path d="M4.5 5h15l-1.5 3-1.5-3H4.5zm15 14h-15l1.5-3 1.5 3h15zM5.05 11l1.41 1.41L5.05 13.83l-1.41-1.41L5.05 11zm13.9 0l-1.41 1.41 1.41 1.42 1.42-1.42-1.42-1.41zM12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm0 6c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg>
                BEYIN
            </button>
            <button class="btn btn-unified" onclick="vulnPanelAc()" title="Zafiyet Yönetimi">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="animation:lockPulse 2s ease-in-out infinite"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM9 6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9V6zm9 14H6V10h12v10zm-6-3c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2z"/></svg>
                VULN
            </button>
            <button class="btn btn-unified" onclick="toggleSiberKomutaPopup()" title="🎖️ Siber Komuta Merkezi" style="background:linear-gradient(135deg,rgba(0,255,136,0.3),rgba(0,100,80,0.15));border-color:rgba(0,255,136,0.5);">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="#00ff88"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>
                SİBER
            </button>
            <button class="btn btn-unified" onclick="termToggle()" title="Terminal">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zM4 18V6h16v12H4zM6 8l4 4-4 4 1.4 1.4L12.8 12l-5.4-5.4L6 8zm6 8h6v2h-6z"/></svg>
            </button>
            <button class="btn btn-unified" onclick="toggleVoice()" title="Sesli Asistan">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5zm6 6c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
            </button>
            <button class="btn btn-unified" onclick="toggleAIChat()" title="AI Asistan">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M21 10.12h-6.78l2.74-2.82c-2.73-2.7-7.15-2.8-9.88-.1-2.73 2.71-2.73 7.08 0 9.79s7.15 2.71 9.88 0C18.32 15.65 19 14.08 19 12.1h2c0 1.98-.88 4.55-2.64 6.29-3.51 3.48-9.21 3.48-12.72 0-3.5-3.47-3.53-9.11-.02-12.58s9.14-3.47 12.65 0L21 3v7.12z"/></svg>
            </button>
            <button class="btn btn-unified" onclick="konum()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
                Konum
            </button>
            <button class="btn btn-unified" onclick="toggleAerospacePanel()" title="Hava Sahası & Uydu Takibi">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="animation:planeFly 3s ease-in-out infinite"><path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/></svg>
                Hava/Uzay
            </button>
            <button class="btn btn-unified" onclick="toggleSigintPanel()" title="DALGA SIGINT - Sinyal İstihbaratı" style="background:linear-gradient(135deg,rgba(0,200,150,0.3),rgba(0,150,100,0.1));border-color:rgba(0,200,150,0.5)">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="animation:sigintPulse 2s ease-in-out infinite"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                SIGINT
            </button>
            <button class="btn btn-unified" onclick="toggleTimelinePanel()" title="📅 Event Timeline - Palantir-Style Görselleştirme" style="background:linear-gradient(135deg,rgba(255,0,255,0.3),rgba(136,85,255,0.15));border-color:rgba(255,0,255,0.5);">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="#ff00ff"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/></svg>
                TIMELINE
            </button>
            <button class="btn btn-unified" onclick="toggleNetworkGraphPanel()" title="🕸️ Network Graph - Palantir-Style Entity Relationship Mapping" style="background:linear-gradient(135deg,rgba(0,255,255,0.3),rgba(0,191,255,0.15));border-color:rgba(0,255,255,0.5);">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="#00ffff"><circle cx="12" cy="12" r="3"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="18" r="3"/><path d="M12 8v8M6 14h12" stroke="#00ffff" stroke-width="2"/></svg>
                GRAPH
            </button>
            <button class="btn btn-unified" onclick="toggleHeatmapPanel()" title="🔥 Advanced Heatmap - Multi-Layer Time-Series Analysis" style="background:linear-gradient(135deg,rgba(255,136,0,0.3),rgba(255,68,0,0.15));border-color:rgba(255,136,0,0.5);">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="#ff8800"><path d="M12 2C8.5 2 5.5 4.5 4.5 8c-1.5 0-3 1.5-3 3.5S3 15 4.5 15H7v-2H4.5c-.8 0-1.5-.7-1.5-1.5S3.7 10 4.5 10h1c.3-3 2.5-5.5 5.5-6V2zm4 2v2c3 .5 5.2 3 5.5 6h1c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5H17v2h2.5c1.5 0 3-1.5 3-3.5S20.5 8 19 8c-1-3.5-4-6-7.5-6h-4zm-4 8v2H8v2h2v2h2v-2h2v-2h-2v-2h-2zm4 0v2h2v-2h-2z"/></svg>
                HEATMAP
            </button>
            <button class="btn btn-unified" onclick="toggleFusionPanel()" title="🔮 Data Fusion Dashboard - Multi-Source Analysis & Correlation" style="background:linear-gradient(135deg,rgba(138,43,226,0.3),rgba(75,0,130,0.15));border-color:rgba(138,43,226,0.5);">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="#8a2be2"><path d="M3 3h8v8H3V3zm10 0h8v8h-8V3zM3 13h8v8H3v-8zm10 0h8v8h-8v-8z"/><path d="M4 4h6v6H4V4zm10 0h6v6h-6V4zM4 14h6v6H4v-6zm10 0h6v6h-6v-6z" fill="none" stroke="#8a2be2" stroke-width="1"/></svg>
                FUSION
            </button>
            <button class="btn btn-unified" onclick="toggleBeyazSapkaPanel()" title="⚖️ Beyaz Şapka Kuralları - Legal & Ethical Compliance" style="background:linear-gradient(135deg,rgba(200,200,200,0.25),rgba(150,150,150,0.15));border-color:rgba(200,200,200,0.5);">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="#e0e0e0"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>
                KURALLAR
            </button>
            <button class="btn btn-unified" onclick="toggleVideoStreamPanel()" title="📹 Canlı Video Stream - Real-Time Camera Feeds" style="background:linear-gradient(135deg,rgba(255,51,85,0.3),rgba(255,0,128,0.15));border-color:rgba(255,51,85,0.5);">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="#ff3355"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg>
                VIDEO
            </button>
            <button class="btn btn-unified theme-toggle-header" onclick="toggleTheme()" title="Tema Değiştir (Ctrl+Shift+T)" style="background:linear-gradient(135deg,rgba(136,85,255,0.3),rgba(0,180,255,0.2));border-color:rgba(136,85,255,0.5)">
                <svg class="theme-icon-light" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/></svg>
                <svg class="theme-icon-dark" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1z"/></svg>
            </button>
        </div>
        </div><!-- /btn-group-wrapper -->
    </div>

    <!-- ═══════════════════════════════════════════════════════════════
         ICON DOCK + FLYOUT WIDGET SYSTEM v3.0
         Profesyonel harita widget sistemi
         ═══════════════════════════════════════════════════════════════ -->

    <!-- Flyout Backdrop - Disari tiklaninca kapanmasi icin -->
    <div class="flyout-backdrop" id="flyoutBackdrop" onclick="closeFlyout()"></div>

    <!-- Widget Icon Dock -->
    <div class="widget-dock" id="widgetDock">
        <!-- Canli Saldirilar -->
        <div class="dock-item dock-item--danger" data-tooltip="Canli Saldirilar" onclick="toggleFlyout('attacks')">
            <svg><use href="#icon-zap"/></svg>
            <span class="dock-item-badge pulse" id="attackCount">0</span>
        </div>

        <!-- Moduller -->
        <div class="dock-item dock-item--neutral" data-tooltip="Moduller" onclick="toggleFlyout('nav')">
            <svg><use href="#icon-grid"/></svg>
        </div>

        <!-- TOR/Stealth -->
        <div class="dock-item dock-item--success" data-tooltip="TOR / Stealth" onclick="toggleFlyout('tor')">
            <svg><use href="#icon-shield"/></svg>
        </div>

        <!-- Otonom Agentlar -->
        <div class="dock-item dock-item--info" data-tooltip="Otonom Agentlar" onclick="toggleFlyout('agents')">
            <svg><use href="#icon-bot"/></svg>
            <span class="dock-item-badge" id="activeAgentCount">2</span>
        </div>

        <div class="dock-separator"></div>

        <!-- Cografi Analiz -->
        <div class="dock-item dock-item--info" data-tooltip="Cografi Analiz" onclick="toggleFlyout('geo')">
            <svg><use href="#icon-map"/></svg>
        </div>

        <!-- Global OSINT -->
        <div class="dock-item dock-item--warning" data-tooltip="Global OSINT" onclick="toggleFlyout('osint')">
            <svg><use href="#icon-globe"/></svg>
        </div>

        <div class="dock-separator"></div>

        <!-- AI Asistan -->
        <div class="dock-item dock-item--purple" data-tooltip="AI Asistan" onclick="toggleFlyout('ai')">
            <svg><use href="#icon-brain"/></svg>
        </div>

        <!-- BLE Radar -->
        <div class="dock-item dock-item--cyan" data-tooltip="BLE Radar" onclick="toggleFlyout('ble')">
            <svg><use href="#icon-radar"/></svg>
        </div>

        <!-- AI Istatistik -->
        <div class="dock-item dock-item--success" data-tooltip="AI Istatistik" onclick="toggleFlyout('stats')">
            <svg><use href="#icon-chart"/></svg>
        </div>

        <!-- GHOST OSINT CRM -->
        <div class="dock-item dock-item--purple" data-tooltip="GHOST CRM" onclick="toggleFlyout('ghost')">
            <svg><use href="#icon-shield"/></svg>
        </div>

        <div class="dock-separator"></div>

        <!-- KOMUTA MERKEZİ - Tüm Modüller -->
        <div class="dock-item dock-item--danger" data-tooltip="KOMUTA Merkezi" onclick="toggleFlyout('komuta')" style="background:linear-gradient(135deg,rgba(255,51,85,0.25),rgba(255,136,0,0.2));border:2px solid rgba(255,85,85,0.6);animation:komutaPulse 2s ease-in-out infinite;">
            <svg viewBox="0 0 24 24" fill="currentColor" style="width:18px;height:18px;filter:drop-shadow(0 0 4px #ff5555);"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>
            <span class="dock-item-badge pulse" id="komutaAlertCount" style="background:#ff3355;">!</span>
        </div>

        <!-- SOC KOMUTA MERKEZİ -->
        <div class="dock-item" data-tooltip="SOC Merkezi" onclick="toggleFlyout('soc')" style="background:linear-gradient(135deg,rgba(255,0,100,0.25),rgba(160,32,240,0.2));border:2px solid rgba(200,50,180,0.6);">
            <svg viewBox="0 0 24 24" fill="currentColor" style="width:18px;height:18px;filter:drop-shadow(0 0 4px #c832b4);">
                <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-1 15h2v2h-2v-2zm0-8h2v6h-2V8z"/>
            </svg>
            <span class="dock-item-badge pulse" id="socAlertBadge" style="background:linear-gradient(135deg,#ff0064,#a020f0);display:none;">0</span>
        </div>

        <!-- PLAN MODU - YENİ -->
        <div class="dock-item dock-item--plan" data-tooltip="Plan Modu" onclick="togglePlanMode()" id="planModeBtn" style="background:linear-gradient(135deg,rgba(0,180,255,0.25),rgba(0,255,157,0.2));border:2px solid rgba(0,180,255,0.6);">
            <svg viewBox="0 0 24 24" fill="currentColor" style="width:18px;height:18px;filter:drop-shadow(0 0 4px #00b4ff);">
                <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41 0l-1.84 1.83 3.75 3.75 1.84-1.83c.39-.39.39-1.02 0-1.41 0l-1.83-1.84zM3 17.25l9.19-9.19L17.81 9.69 8.62 18.88 3 17.25z"/>
            </svg>
            <span class="dock-item-badge" id="planModeIndicator" style="background:#00b4ff;display:none;">PLAN</span>
        </div>

        <!-- AI TEHDIT TAHMİN - YENİ -->
        <div class="dock-item dock-item--ai" data-tooltip="AI Tehdit Tahmini" onclick="aiPanelAc()" id="aiTahminBtn" style="background:linear-gradient(135deg,rgba(138,43,226,0.25),rgba(193,0,255,0.2));border:2px solid rgba(193,0,255,0.6);">
            <svg viewBox="0 0 24 24" fill="currentColor" style="width:18px;height:18px;filter:drop-shadow(0 0 4px #c100ff);">
                <path d="M21 10.12h-6.78l2.74-2.82c-2.73-2.89-6.66-4.08-10.39-2.38-1.67-.89-3.39-1.34-5.12-1.34-3.31 0-6 2.69-6 6s2.69 6 6 6c1.73 0 3.45-.45 5.12-1.34 3.73 1.7 7.66 2.89 10.39 2.38l2.74-2.82c.74-.76 1.9-.76 2.64 0zM12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-6 2.69 6 6 6zm0-10c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4-4z"/>
            </svg>
            <span class="dock-item-badge" id="aiTahminIndicator" style="background:#c100ff;display:none;">AI</span>
        </div>

        <div class="dock-separator"></div>

        <!-- SHANNON AI PENTESTER -->
        <div class="dock-item" data-tooltip="Shannon AI Pentester" onclick="toggleFlyout('shannon')" style="background:linear-gradient(135deg,rgba(156,39,176,0.25),rgba(103,58,183,0.2));border:2px solid rgba(156,39,176,0.6);">
            <svg viewBox="0 0 24 24" fill="currentColor" style="width:18px;height:18px;filter:drop-shadow(0 0 4px #9c27b0);">
                <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm4.5 11.5l-6 6-3-3 1.5-1.5 1.5 1.5 4.5-4.5 1.5 1.5z"/>
            </svg>
            <span class="dock-item-badge" id="shannonScanCount" style="background:#9c27b0;display:none;">0</span>
        </div>
    </div>

    <!-- ══════════════════════════════════════════════════════════════
         PLAN MODU - ARAYÜZLER
         ═══════════════════════════════════════════════════════════════ -->

    <!-- Plan Modu - Çizim Araçları Toolbar -->
    <div id="planToolbar">
        <div class="plan-tool-btn" data-tool="marker" onclick="selectPlanTool('marker')" title="Nokta Ekle">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 10 13h-2v2h2v2h-2v2h-6v-2h-2v-2h2c-3 0-10-7.75-10-13zm0 18c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-7z"/>
            </svg>
        </div>
        <div class="plan-tool-btn" data-tool="line" onclick="selectPlanTool('line')" title="Çizgi Çiz">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41 0l-1.84 1.83 3.75 3.75 1.84-1.83c.39-.39.39-1.02 0-1.41 0l-1.83-1.84z"/>
            </svg>
        </div>
        <div class="plan-tool-btn" data-tool="polygon" onclick="selectPlanTool('polygon')" title="Alan Çiz">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M17 15.7V13c0-1.1-.9-2-2-2H5v6h10v-1.3zM4 6V3c0-1.1.9-2 2-2h6l4 4H6z"/>
            </svg>
        </div>
        <div class="plan-tool-btn" data-tool="circle" onclick="selectPlanTool('circle')" title="Daire Çiz">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <circle cx="12" cy="12" r="8" fill="none" stroke="currentColor" stroke-width="2"/>
            </svg>
        </div>
        <div class="dock-separator"></div>
        <div class="plan-tool-btn" onclick="clearDrawings()" title="Temizle">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 8h-2V3H6v3h2v2h-2v2h2v-2h2v4h-2v2h2v-2h2v2z"/>
            </svg>
        </div>
        <div class="plan-tool-btn" onclick="openPlanNotes()" title="Notlar">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M14 2H6c-1.1 0-1.9.9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0 1.1-.9 2-2 2zm0 2H6V4h8v4z"/>
            </svg>
        </div>
    </div>

    <!-- Plan Modu - Ölçüm Paneli -->
    <div id="planMeasurement">
        <div class="measurement-display" id="measurementValue">Hazır: 0 km</div>
        <button class="plan-tool-btn" onclick="saveMeasurement()" title="Kaydet">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-3-1.34-3-3 3z"/>
            </svg>
        </button>
    </div>

    <!-- Plan Modu - Notlar Paneli -->
    <div id="planNotes">
        <h3>📝 Plan Notları</h3>
        <textarea id="planNoteText" placeholder="Planınız hakkında not alın..."></textarea>
        <div style="display:flex; gap:10px;">
            <button onclick="savePlanNote()">💾 Kaydet</button>
            <button onclick="closePlanNotes()">✕ Kapat</button>
        </div>
        <div style="border-top:1px solid rgba(0,180,255,0.3);margin-top:10px;padding-top:10px;">
            <h4 style="color:#00b4ff;margin:0 0 8px 0;">Kayıtlı Planlar</h4>
            <div id="planList">
                <!-- Planlar buraya yüklenecek -->
            </div>
        </div>
    </div>

    <!-- ══════════════════════════════════════════════════════════════
         FLYOUT PANELS - Her widget icin acilan panel
         ═══════════════════════════════════════════════════════════════ -->

    <!-- Canli Saldirilar Flyout -->
    <div class="widget-flyout widget-flyout--danger" id="flyout-attacks">
        <div class="flyout-header">
            <div class="flyout-title">
                <svg><use href="#icon-zap"/></svg>
                <span class="flyout-title-text">Canli Saldirilar</span>
            </div>
            <button class="flyout-close" onclick="closeFlyout()">
                <svg><use href="#icon-chevron-left"/></svg>
            </button>
        </div>
        <div class="flyout-body">
            <div class="attack-feed" id="atkFeed"></div>
        </div>
    </div>

    <!-- Moduller Flyout -->
    <div class="widget-flyout widget-flyout--neutral" id="flyout-nav">
        <div class="flyout-header">
            <div class="flyout-title">
                <svg><use href="#icon-grid"/></svg>
                <span class="flyout-title-text">Moduller</span>
            </div>
            <button class="flyout-close" onclick="closeFlyout()">
                <svg><use href="#icon-chevron-left"/></svg>
            </button>
        </div>
        <div class="flyout-body nav-body" id="navBody">
            <a href="/panel" class="nav-item"><svg width="12" height="12" style="margin-right:6px;vertical-align:middle;"><use href="#icon-grid"/></svg>Panel</a>
            <a href="/komuta" class="nav-item"><svg width="12" height="12" style="margin-right:6px;vertical-align:middle;"><use href="#icon-cpu"/></svg>Komuta</a>
            <a href="/harita" class="nav-item active"><svg width="12" height="12" style="margin-right:6px;vertical-align:middle;"><use href="#icon-map"/></svg>Harita</a>
            <a href="/siber" class="nav-item" style="color:#00ff88"><svg width="12" height="12" style="margin-right:6px;vertical-align:middle;"><use href="#icon-shield"/></svg>Siber</a>
            <a href="/osint" class="nav-item"><svg width="12" height="12" style="margin-right:6px;vertical-align:middle;"><use href="#icon-eye"/></svg>OSINT</a>
            <a href="/araclar" class="nav-item"><svg width="12" height="12" style="margin-right:6px;vertical-align:middle;"><use href="#icon-zap"/></svg>Araclar</a>
            <a href="/trafik" class="nav-item"><svg width="12" height="12" style="margin-right:6px;vertical-align:middle;"><use href="#icon-chart"/></svg>Trafik</a>
            <a href="/spektrum" class="nav-item"><svg width="12" height="12" style="margin-right:6px;vertical-align:middle;"><use href="#icon-radar"/></svg>Spektrum</a>
            <a href="/raporlar" class="nav-item"><svg width="12" height="12" style="margin-right:6px;vertical-align:middle;"><use href="#icon-menu"/></svg>Raporlar</a>
        </div>
    </div>

    <!-- TOR / Stealth Flyout -->
    <div class="widget-flyout widget-flyout--success" id="flyout-tor">
        <div class="flyout-header">
            <div class="flyout-title">
                <svg><use href="#icon-shield"/></svg>
                <span class="flyout-title-text">TOR / Stealth</span>
            </div>
            <button class="flyout-close" onclick="closeFlyout()">
                <svg><use href="#icon-chevron-left"/></svg>
            </button>
        </div>
        <div class="flyout-body">
            <div id="stealthInfoPanel" style="font-size:11px;margin-bottom:10px;color:var(--text-normal);">
                <div style="color:var(--text-dim);">Baslatilmadi</div>
            </div>
            <button id="torActivateBtn" onclick="activateTorStealth()" style="width:100%;padding:10px;background:rgba(0,180,0,0.2);border:1px solid rgba(0,255,0,0.5);border-radius:4px;color:#00ff88;font-size:12px;cursor:pointer;margin-bottom:8px;font-weight:bold;transition:all 0.3s;">
                <svg width="12" height="12" style="margin-right:4px;vertical-align:middle;"><use href="#icon-zap"/></svg>TOR AKTIF ET
            </button>
            <select id="stealthLevelSelect" onchange="setStealthLevel(this.value)" style="width:100%;padding:6px;background:rgba(0,0,0,0.3);border:1px solid rgba(0,255,0,0.3);border-radius:4px;color:#00ff88;font-size:11px;margin-bottom:8px;" disabled>
                <option value="normal">Normal (Tor)</option>
                <option value="enhanced">Gelismis (VPN+Tor)</option>
                <option value="maximum">Maksimum (VPN+Proxy+Tor)</option>
            </select>
            <button onclick="rotateStealthRoute()" style="width:100%;padding:8px;background:rgba(0,255,0,0.1);border:1px solid rgba(0,255,0,0.3);border-radius:4px;color:#00ff88;font-size:11px;cursor:pointer;" disabled id="rotateStealthBtn">
                <svg width="12" height="12" style="margin-right:4px;vertical-align:middle;color:#00ff88;"><use href="#icon-radar"/></svg>Rota Dondur
            </button>
        </div>
    </div>

    <!-- Otonom Agentlar Flyout -->
    <div class="widget-flyout widget-flyout--info" id="flyout-agents">
        <div class="flyout-header">
            <div class="flyout-title">
                <svg><use href="#icon-bot"/></svg>
                <span class="flyout-title-text">Otonom Agentlar</span>
            </div>
            <button class="flyout-close" onclick="closeFlyout()">
                <svg><use href="#icon-chevron-left"/></svg>
            </button>
        </div>
        <div class="flyout-body">
            <div class="agent-list" id="agentList">
                <div class="agent-item" onclick="otonumAgentTetikle('gizlilik')"><span class="agent-name"><span class="agent-dot agent-dot--aktif" id="agentDotGizlilik"></span>Gizlilik</span><span class="agent-status agent-status--aktif" id="agentStatusGizlilik">Aktif</span></div>
                <div class="agent-item" onclick="otonumAgentTetikle('tehdit')"><span class="agent-name"><span class="agent-dot agent-dot--aktif" id="agentDotTehdit"></span>Tehdit</span><span class="agent-status agent-status--aktif" id="agentStatusTehdit">Aktif</span></div>
                <div class="agent-item" onclick="otonumAgentTetikle('tarama')"><span class="agent-name"><span class="agent-dot" id="agentDotTarama"></span>Tarama</span><span class="agent-status" id="agentStatusTarama">Bekliyor</span></div>
                <div class="agent-item" onclick="otonumAgentTetikle('konum')"><span class="agent-name"><span class="agent-dot" id="agentDotKonum"></span>Konum</span><span class="agent-status" id="agentStatusKonum">Bekliyor</span></div>
                <div class="agent-item" onclick="otonumAgentTetikle('osint')"><span class="agent-name"><span class="agent-dot" id="agentDotOsint"></span>OSINT</span><span class="agent-status" id="agentStatusOsint">Bekliyor</span></div>
            </div>
            <div style="margin-top:12px;display:flex;gap:6px;">
                <button onclick="tumAgentlariBaslat()" style="flex:1;padding:8px;background:rgba(0,255,136,0.15);border:1px solid rgba(0,255,136,0.4);border-radius:6px;color:#00ff88;font-size:10px;cursor:pointer;">
                    <svg width="10" height="10" style="margin-right:4px;vertical-align:middle;"><use href="#icon-zap"/></svg>Tümünü Başlat
                </button>
                <button onclick="agentlariDurdur()" style="flex:1;padding:8px;background:rgba(255,51,85,0.15);border:1px solid rgba(255,51,85,0.4);border-radius:6px;color:#ff3355;font-size:10px;cursor:pointer;">
                    <svg width="10" height="10" style="margin-right:4px;vertical-align:middle;"><use href="#icon-x"/></svg>Durdur
                </button>
            </div>
        </div>
    </div>

    <!-- Cografi Analiz Flyout -->
    <div class="widget-flyout widget-flyout--info" id="flyout-geo">
        <div class="flyout-header">
            <div class="flyout-title">
                <svg><use href="#icon-map"/></svg>
                <span class="flyout-title-text">Cografi Analiz</span>
            </div>
            <button class="flyout-close" onclick="closeFlyout()">
                <svg><use href="#icon-chevron-left"/></svg>
            </button>
        </div>
        <div class="flyout-body">
            <div style="margin-bottom:10px;">
                <div class="geo-layer-toggle" onclick="toggleGeoLayer('ilSinirlari', event)" style="padding:8px;background:rgba(0,255,170,0.05);border:1px solid rgba(0,255,170,0.2);border-radius:6px;margin-bottom:6px;cursor:pointer;display:flex;align-items:center;gap:8px;">
                    <input type="checkbox" id="sidebarLayerIlSinirlari" style="accent-color:#00ffaa;">
                    <span style="font-size:11px;color:var(--text-normal);">Il Sinirlari (81 Il)</span>
                </div>
                <div class="geo-layer-toggle" onclick="toggleGeoLayer('hotspot', event)" style="padding:8px;background:rgba(255,100,0,0.05);border:1px solid rgba(255,100,0,0.2);border-radius:6px;margin-bottom:6px;cursor:pointer;display:flex;align-items:center;gap:8px;">
                    <input type="checkbox" id="sidebarLayerHotspot" style="accent-color:#ff6400;">
                    <span style="font-size:11px;color:var(--text-normal);">Saldiri Hotspot'lari</span>
                </div>
                <div class="geo-layer-toggle" onclick="toggleGeoLayer('riskHarita', event)" style="padding:8px;background:rgba(255,0,0,0.05);border:1px solid rgba(255,0,0,0.2);border-radius:6px;margin-bottom:6px;cursor:pointer;display:flex;align-items:center;gap:8px;">
                    <input type="checkbox" id="sidebarLayerRisk" style="accent-color:#ff0000;">
                    <span style="font-size:11px;color:var(--text-normal);">Risk Haritasi</span>
                </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:10px;margin-bottom:10px;">
                <div style="background:rgba(0,255,170,0.1);padding:8px;border-radius:4px;text-align:center;">
                    <div style="font-size:16px;font-weight:bold;color:#00ffaa;" id="sidebarGeoIlCount">81</div>
                    <div style="color:var(--text-dim);">Il</div>
                </div>
                <div style="background:rgba(255,100,0,0.1);padding:8px;border-radius:4px;text-align:center;">
                    <div style="font-size:16px;font-weight:bold;color:#ff6400;" id="sidebarGeoHotspotCount">0</div>
                    <div style="color:var(--text-dim);">Hotspot</div>
                </div>
            </div>
            <button onclick="geoAnalizGuncelle(); toggleGeoPanel();" style="width:100%;padding:8px;background:rgba(0,255,170,0.15);border:1px solid rgba(0,255,170,0.4);border-radius:6px;color:#00ffaa;font-size:11px;cursor:pointer;">
                <svg width="12" height="12" style="margin-right:4px;vertical-align:middle;"><use href="#icon-eye"/></svg>Detayli Analiz Paneli
            </button>
        </div>
    </div>

    <!-- Global OSINT Flyout -->
    <div class="widget-flyout widget-flyout--warning" id="flyout-osint">
        <div class="flyout-header">
            <div class="flyout-title">
                <svg><use href="#icon-globe"/></svg>
                <span class="flyout-title-text">Global OSINT</span>
            </div>
            <button class="flyout-close" onclick="closeFlyout()">
                <svg><use href="#icon-chevron-left"/></svg>
            </button>
        </div>
        <div class="flyout-body">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:10px;margin-bottom:10px;">
                <div style="background:rgba(0,180,255,0.1);padding:8px;border-radius:4px;text-align:center;">
                    <div style="font-size:14px;font-weight:bold;color:#00b4ff;" id="sidebarOsintApiCount">102+</div>
                    <div style="color:var(--text-dim);">API</div>
                </div>
                <div style="background:rgba(255,136,0,0.1);padding:8px;border-radius:4px;text-align:center;">
                    <div style="font-size:14px;font-weight:bold;color:#ff8800;" id="sidebarOsintCountryCount">193</div>
                    <div style="color:var(--text-dim);">Ulke</div>
                </div>
                <div style="background:rgba(136,85,255,0.1);padding:8px;border-radius:4px;text-align:center;">
                    <div style="font-size:14px;font-weight:bold;color:#8855ff;" id="sidebarOsintToolCount">614+</div>
                    <div style="color:var(--text-dim);">Arac</div>
                </div>
                <div style="background:rgba(255,51,85,0.1);padding:8px;border-radius:4px;text-align:center;">
                    <div style="font-size:14px;font-weight:bold;color:#ff3355;" id="sidebarOsintPastebinCount">49</div>
                    <div style="color:var(--text-dim);">Pastebin</div>
                </div>
            </div>
            <div style="margin-bottom:8px;">
                <button onclick="toggleGlobalOsintLayer('datacenters')" style="width:100%;padding:6px;margin-bottom:4px;background:rgba(0,180,255,0.1);border:1px solid rgba(0,180,255,0.3);border-radius:4px;color:#00b4ff;font-size:10px;cursor:pointer;text-align:left;">
                    <svg width="10" height="10" style="margin-right:4px;vertical-align:middle;"><use href="#icon-cpu"/></svg>Veri Merkezleri
                </button>
                <button onclick="toggleGlobalOsintLayer('ixp')" style="width:100%;padding:6px;margin-bottom:4px;background:rgba(255,136,0,0.1);border:1px solid rgba(255,136,0,0.3);border-radius:4px;color:#ff8800;font-size:10px;cursor:pointer;text-align:left;">
                    <svg width="10" height="10" style="margin-right:4px;vertical-align:middle;"><use href="#icon-wifi"/></svg>Internet Exchange Points
                </button>
                <button onclick="toggleGlobalOsintLayer('submarine')" style="width:100%;padding:6px;background:rgba(136,85,255,0.1);border:1px solid rgba(136,85,255,0.3);border-radius:4px;color:#8855ff;font-size:10px;cursor:pointer;text-align:left;">
                    <svg width="10" height="10" style="margin-right:4px;vertical-align:middle;"><use href="#icon-globe"/></svg>Denizalti Kablolari
                </button>
            </div>
            <button onclick="toggleGlobalOsintPanel();" style="width:100%;padding:8px;background:rgba(0,180,255,0.15);border:1px solid rgba(0,180,255,0.4);border-radius:6px;color:#00b4ff;font-size:11px;cursor:pointer;">
                <svg width="12" height="12" style="margin-right:4px;vertical-align:middle;"><use href="#icon-eye"/></svg>Tam OSINT Paneli
            </button>
        </div>
    </div>

    <!-- AI Asistan Flyout -->
    <div class="widget-flyout widget-flyout--purple" id="flyout-ai">
        <div class="flyout-header">
            <div class="flyout-title">
                <svg><use href="#icon-brain"/></svg>
                <span class="flyout-title-text">AI Asistan</span>
            </div>
            <div style="display:flex;align-items:center;gap:8px;">
                <span class="flyout-status-dot" id="aiStatusDot"></span>
                <button class="flyout-close" onclick="closeFlyout()">
                    <svg><use href="#icon-chevron-left"/></svg>
                </button>
            </div>
        </div>
        <div class="flyout-body">
            <!-- AI Sohbet Alani -->
            <div id="aiChatMessages" style="height:180px;overflow-y:auto;background:rgba(0,0,0,0.3);border-radius:6px;padding:8px;margin-bottom:8px;font-size:11px;">
                <div style="color:#666;text-align:center;padding:20px;">
                    <svg width="32" height="32" style="color:#8855ff;margin-bottom:8px;"><use href="#icon-brain"/></svg>
                    <div>TSUNAMI AI hazir</div>
                    <div style="font-size:10px;margin-top:4px;">Turkce komut verebilirsiniz</div>
                </div>
            </div>
            <!-- Mesaj Girisi -->
            <div style="display:flex;gap:6px;">
                <input type="text" id="aiChatInput" placeholder="Komut yazin... (orn: Ankara'ya git)"
                       style="flex:1;padding:8px;background:rgba(0,0,0,0.3);border:1px solid rgba(138,43,226,0.3);border-radius:4px;color:#fff;font-size:11px;"
                       onkeypress="if(event.key==='Enter')aiGonderMesaj()">
                <button onclick="aiGonderMesaj()" style="padding:8px 12px;background:rgba(138,43,226,0.3);border:1px solid rgba(138,43,226,0.5);border-radius:4px;color:#8a2be2;cursor:pointer;font-size:12px;">
                    <svg width="12" height="12"><use href="#icon-chevron-right"/></svg>
                </button>
            </div>
            <!-- Hizli Komutlar - Genisletilmis -->
            <div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:8px;">
                <button onclick="aiHizliKomut('WiFi tara')" class="ai-quick-btn" style="padding:4px 8px;background:rgba(0,180,255,0.1);border:1px solid rgba(0,180,255,0.3);border-radius:4px;color:#00b4ff;font-size:9px;cursor:pointer;">WiFi</button>
                <button onclick="aiHizliKomut('Bluetooth tara')" class="ai-quick-btn" style="padding:4px 8px;background:rgba(0,255,170,0.1);border:1px solid rgba(0,255,170,0.3);border-radius:4px;color:#00ffaa;font-size:9px;cursor:pointer;">BT</button>
                <button onclick="aiHizliKomut('BLE radar tara')" class="ai-quick-btn" style="padding:4px 8px;background:rgba(0,212,255,0.1);border:1px solid rgba(0,212,255,0.3);border-radius:4px;color:#00d4ff;font-size:9px;cursor:pointer;">BLE</button>
                <button onclick="aiHizliKomut('TOR baslat')" class="ai-quick-btn" style="padding:4px 8px;background:rgba(255,136,0,0.1);border:1px solid rgba(255,136,0,0.3);border-radius:4px;color:#ff8800;font-size:9px;cursor:pointer;">TOR</button>
                <button onclick="aiHizliKomut('TOR yenile')" class="ai-quick-btn" style="padding:4px 8px;background:rgba(255,200,0,0.1);border:1px solid rgba(255,200,0,0.3);border-radius:4px;color:#ffc800;font-size:9px;cursor:pointer;">Yenile</button>
                <button onclick="aiHizliKomut('Ghost mod ac')" class="ai-quick-btn" style="padding:4px 8px;background:rgba(136,85,255,0.1);border:1px solid rgba(136,85,255,0.3);border-radius:4px;color:#8855ff;font-size:9px;cursor:pointer;">Ghost</button>
                <button onclick="aiHizliKomut('Tehdit analizi yap')" class="ai-quick-btn" style="padding:4px 8px;background:rgba(255,51,85,0.1);border:1px solid rgba(255,51,85,0.3);border-radius:4px;color:#ff3355;font-size:9px;cursor:pointer;">Tehdit</button>
                <button onclick="aiHizliKomut('Sistem durumu')" class="ai-quick-btn" style="padding:4px 8px;background:rgba(0,255,0,0.1);border:1px solid rgba(0,255,0,0.3);border-radius:4px;color:#00ff00;font-size:9px;cursor:pointer;">Durum</button>
            </div>
            <!-- AI Istatistik -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:8px;font-size:9px;">
                <div style="background:rgba(138,43,226,0.1);padding:4px;border-radius:4px;text-align:center;">
                    <div style="color:#8a2be2;font-weight:bold;" id="aiMesajSayisi">0</div>
                    <div style="color:#666;">Mesaj</div>
                </div>
                <div style="background:rgba(0,255,0,0.1);padding:4px;border-radius:4px;text-align:center;">
                    <div style="color:#00ff00;font-weight:bold;" id="aiKomutSayisi">0</div>
                    <div style="color:#666;">Komut</div>
                </div>
            </div>
        </div>
    </div>

    <!-- BLE Radar Flyout -->
    <div class="widget-flyout widget-flyout--cyan" id="flyout-ble">
        <div class="flyout-header">
            <div class="flyout-title">
                <svg><use href="#icon-radar"/></svg>
                <span class="flyout-title-text">BLE Radar</span>
            </div>
            <div style="display:flex;align-items:center;gap:8px;">
                <span class="flyout-badge" id="bleTehditBadge" style="display:none;">0</span>
                <button class="flyout-close" onclick="closeFlyout()">
                    <svg><use href="#icon-chevron-left"/></svg>
                </button>
            </div>
        </div>
        <div class="flyout-body">
            <!-- BLE Tarama Durumu -->
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <div style="font-size:10px;color:#666;">
                    <span id="bleTaramaDurum">Bekliyor</span>
                </div>
                <button onclick="bleTaramaBaslat()" id="bleTaraBtn" style="padding:6px 12px;background:rgba(0,191,255,0.2);border:1px solid rgba(0,191,255,0.5);border-radius:4px;color:#00bfff;font-size:10px;cursor:pointer;">
                    <svg width="10" height="10" style="margin-right:4px;vertical-align:middle;"><use href="#icon-eye"/></svg>Tara
                </button>
            </div>
            <!-- BLE Cihaz Listesi -->
            <div id="bleCihazListesi" style="max-height:150px;overflow-y:auto;background:rgba(0,0,0,0.3);border-radius:6px;padding:6px;margin-bottom:8px;">
                <div style="color:#666;text-align:center;padding:15px;font-size:10px;">
                    <svg width="24" height="24" style="color:#00d4ff;margin-bottom:6px;"><use href="#icon-radar"/></svg>
                    <div>BLE taramasi baslatilmadi</div>
                </div>
            </div>
            <!-- Tehdit Ozeti -->
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:4px;font-size:9px;">
                <div style="background:rgba(0,255,0,0.1);padding:4px;border-radius:4px;text-align:center;">
                    <div style="color:#00ff00;font-weight:bold;" id="bleCihazSayisi">0</div>
                    <div style="color:#666;">Cihaz</div>
                </div>
                <div style="background:rgba(255,255,0,0.1);padding:4px;border-radius:4px;text-align:center;">
                    <div style="color:#ffff00;font-weight:bold;" id="bleDusukTehdit">0</div>
                    <div style="color:#666;">Dusuk</div>
                </div>
                <div style="background:rgba(255,165,0,0.1);padding:4px;border-radius:4px;text-align:center;">
                    <div style="color:#ffa500;font-weight:bold;" id="bleOrtaTehdit">0</div>
                    <div style="color:#666;">Orta</div>
                </div>
                <div style="background:rgba(255,51,85,0.1);padding:4px;border-radius:4px;text-align:center;">
                    <div style="color:#ff3355;font-weight:bold;" id="bleYuksekTehdit">0</div>
                    <div style="color:#666;">Yuksek</div>
                </div>
            </div>
            <!-- Tracker Uyarisi -->
            <div id="bleTrackerUyari" style="display:none;margin-top:8px;padding:8px;background:rgba(255,51,85,0.15);border:1px solid rgba(255,51,85,0.5);border-radius:6px;">
                <div style="display:flex;align-items:center;gap:6px;color:#ff3355;font-size:11px;font-weight:bold;">
                    <svg width="12" height="12" style="animation:blink 1s infinite;"><use href="#icon-shield"/></svg>
                    <span>Takip Cihazi Tespit Edildi!</span>
                </div>
                <div id="bleTrackerDetay" style="font-size:10px;color:#ff8888;margin-top:4px;"></div>
            </div>
        </div>
    </div>

    <!-- AI Istatistik Flyout -->
    <div class="widget-flyout widget-flyout--success" id="flyout-stats">
        <div class="flyout-header">
            <div class="flyout-title">
                <svg><use href="#icon-chart"/></svg>
                <span class="flyout-title-text">AI Istatistik</span>
            </div>
            <button class="flyout-close" onclick="closeFlyout()">
                <svg><use href="#icon-chevron-left"/></svg>
            </button>
        </div>
        <div class="flyout-body">
            <!-- Token Kullanimi -->
            <div style="margin-bottom:8px;">
                <div style="display:flex;justify-content:space-between;font-size:10px;margin-bottom:4px;">
                    <span style="color:#666;">Bugun Token</span>
                    <span style="color:#00ff88;" id="aiTodayTokens">0</span>
                </div>
                <div style="height:4px;background:rgba(0,0,0,0.3);border-radius:2px;overflow:hidden;">
                    <div id="aiTokenBar" style="height:100%;width:0%;background:linear-gradient(90deg,#00ff88,#00b4ff);transition:width 0.3s;"></div>
                </div>
            </div>
            <!-- Istatistik Grid -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:10px;">
                <div style="background:rgba(0,255,136,0.1);padding:8px;border-radius:4px;text-align:center;">
                    <div style="font-size:14px;font-weight:bold;color:#00ff88;" id="aiWeeklyTokens">0</div>
                    <div style="color:#666;font-size:9px;">Haftalik Token</div>
                </div>
                <div style="background:rgba(0,180,255,0.1);padding:8px;border-radius:4px;text-align:center;">
                    <div style="font-size:14px;font-weight:bold;color:#00b4ff;" id="aiWeeklyRequests">0</div>
                    <div style="color:#666;font-size:9px;">Haftalik Istek</div>
                </div>
            </div>
            <!-- Tasarruf Gostergesi -->
            <div style="margin-top:8px;padding:8px;background:rgba(0,255,0,0.05);border:1px solid rgba(0,255,0,0.2);border-radius:6px;">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <span style="font-size:10px;color:#666;"><svg width="10" height="10" style="vertical-align:middle;margin-right:4px;"><use href="#icon-chart"/></svg>Yerel AI Tasarrufu</span>
                    <span style="font-size:12px;font-weight:bold;color:#00ff00;" id="aiSavings">$0.00</span>
                </div>
                <div style="font-size:9px;color:#666;margin-top:4px;">
                    GPT4All ile bulut API maliyetinden tasarruf
                </div>
            </div>
        </div>
    </div>

    <!-- GHOST OSINT CRM Flyout -->
    <div class="widget-flyout widget-flyout--purple" id="flyout-ghost">
        <div class="flyout-header">
            <div class="flyout-title">
                <svg><use href="#icon-shield"/></svg>
                <span class="flyout-title-text">GHOST CRM</span>
            </div>
            <div style="display:flex;align-items:center;gap:8px;">
                <span class="flyout-badge" id="ghostEntityBadge">0</span>
                <button class="flyout-close" onclick="closeFlyout()">
                    <svg><use href="#icon-chevron-left"/></svg>
                </button>
            </div>
        </div>
        <div class="flyout-body">
            <!-- GHOST Istatistikler -->
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:4px;font-size:9px;margin-bottom:8px;">
                <div style="background:rgba(136,85,255,0.1);padding:6px;border-radius:4px;text-align:center;">
                    <div style="font-size:12px;font-weight:bold;color:#8855ff;" id="ghostEntityCount">0</div>
                    <div style="color:#666;">Varlik</div>
                </div>
                <div style="background:rgba(0,255,136,0.1);padding:6px;border-radius:4px;text-align:center;">
                    <div style="font-size:12px;font-weight:bold;color:#00ff88;" id="ghostCaseCount">0</div>
                    <div style="color:#666;">Dava</div>
                </div>
                <div style="background:rgba(0,180,255,0.1);padding:6px;border-radius:4px;text-align:center;">
                    <div style="font-size:12px;font-weight:bold;color:#00b4ff;" id="ghostRelCount">0</div>
                    <div style="color:#666;">Iliski</div>
                </div>
            </div>

            <!-- Hizli Islemler -->
            <div style="margin-bottom:8px;">
                <button onclick="openGhostEntityForm()" style="width:100%;padding:6px;margin-bottom:4px;background:rgba(136,85,255,0.15);border:1px solid rgba(136,85,255,0.4);border-radius:4px;color:#8855ff;font-size:10px;cursor:pointer;text-align:left;">
                    <svg width="10" height="10" style="margin-right:4px;vertical-align:middle;"><use href="#icon-user"/></svg>Yeni Kisi/Varlik Ekle
                </button>
                <button onclick="openGhostCaseForm()" style="width:100%;padding:6px;margin-bottom:4px;background:rgba(0,255,136,0.15);border:1px solid rgba(0,255,136,0.4);border-radius:4px;color:#00ff88;font-size:10px;cursor:pointer;text-align:left;">
                    <svg width="10" height="10" style="margin-right:4px;vertical-align:middle;"><use href="#icon-folder"/></svg>Yeni Dava/Sorusturma
                </button>
                <button onclick="showGhostRelationshipGraph()" style="width:100%;padding:6px;margin-bottom:4px;background:rgba(0,180,255,0.15);border:1px solid rgba(0,180,255,0.4);border-radius:4px;color:#00b4ff;font-size:10px;cursor:pointer;text-align:left;">
                    <svg width="10" height="10" style="margin-right:4px;vertical-align:middle;"><use href="#icon-network"/></svg>Iliski Agini Goster
                </button>
                <button onclick="loadGhostWirelessData()" style="width:100%;padding:6px;background:rgba(255,170,0,0.15);border:1px solid rgba(255,170,0,0.4);border-radius:4px;color:#ffaa00;font-size:10px;cursor:pointer;text-align:left;">
                    <svg width="10" height="10" style="margin-right:4px;vertical-align:middle;"><use href="#icon-wifi"/></svg>WiFi Istihbarati
                </button>
            </div>

            <!-- Son Eklenen Varliklar -->
            <div style="background:rgba(0,0,0,0.3);border-radius:6px;padding:6px;margin-bottom:8px;">
                <div style="font-size:9px;color:#666;margin-bottom:4px;text-transform:uppercase;">Son Varliklar</div>
                <div id="ghostRecentEntities" style="max-height:100px;overflow-y:auto;font-size:10px;">
                    <div style="color:#666;text-align:center;padding:10px;">Varlik bulunamadi</div>
                </div>
            </div>

            <!-- Tam Panel Butonu -->
            <button onclick="openGhostFullPanel()" style="width:100%;padding:8px;background:linear-gradient(135deg,rgba(136,85,255,0.2),rgba(0,180,255,0.2));border:1px solid rgba(136,85,255,0.5);border-radius:6px;color:#8855ff;font-size:11px;cursor:pointer;">
                <svg width="12" height="12" style="margin-right:4px;vertical-align:middle;"><use href="#icon-eye"/></svg>Tam GHOST Panel
            </button>
        </div>
    </div>

    <!-- GHOST Entity Form Modal -->
    <div id="ghostEntityModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:10000;justify-content:center;align-items:center;">
        <div style="background:#1a1a2e;border:2px solid rgba(136,85,255,0.5);border-radius:12px;padding:20px;width:90%;max-width:500px;max-height:80vh;overflow-y:auto;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                <h3 style="color:#8855ff;margin:0;font-size:14px;"><svg width="16" height="16" style="vertical-align:middle;margin-right:8px;"><use href="#icon-user"/></svg>Yeni Varlik Ekle</h3>
                <button onclick="closeGhostEntityModal()" style="background:none;border:none;color:#ff3355;font-size:20px;cursor:pointer;">&times;</button>
            </div>
            <form id="ghostEntityForm" onsubmit="submitGhostEntity(event)">
                <div style="margin-bottom:10px;">
                    <label style="display:block;font-size:10px;color:#666;margin-bottom:4px;">Varlik Tipi</label>
                    <select name="entity_type" style="width:100%;padding:8px;background:#0d0d1a;border:1px solid rgba(136,85,255,0.3);border-radius:4px;color:#fff;font-size:11px;">
                        <option value="person">Kisi</option>
                        <option value="organization">Organizasyon</option>
                        <option value="device">Cihaz</option>
                        <option value="account">Hesap</option>
                    </select>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
                    <div>
                        <label style="display:block;font-size:10px;color:#666;margin-bottom:4px;">Ad</label>
                        <input type="text" name="first_name" placeholder="Ad" style="width:100%;padding:8px;background:#0d0d1a;border:1px solid rgba(136,85,255,0.3);border-radius:4px;color:#fff;font-size:11px;">
                    </div>
                    <div>
                        <label style="display:block;font-size:10px;color:#666;margin-bottom:4px;">Soyad</label>
                        <input type="text" name="last_name" placeholder="Soyad" style="width:100%;padding:8px;background:#0d0d1a;border:1px solid rgba(136,85,255,0.3);border-radius:4px;color:#fff;font-size:11px;">
                    </div>
                </div>
                <div style="margin-bottom:10px;">
                    <label style="display:block;font-size:10px;color:#666;margin-bottom:4px;">Kategori</label>
                    <select name="category" style="width:100%;padding:8px;background:#0d0d1a;border:1px solid rgba(136,85,255,0.3);border-radius:4px;color:#fff;font-size:11px;">
                        <option value="poi">Ilgili Kisi (POI)</option>
                        <option value="suspect">Supheli</option>
                        <option value="witness">Tanik</option>
                        <option value="victim">Magdur</option>
                        <option value="informant">Muhbir</option>
                        <option value="associate">Baglanti</option>
                    </select>
                </div>
                <div style="margin-bottom:10px;">
                    <label style="display:block;font-size:10px;color:#666;margin-bottom:4px;">Notlar</label>
                    <textarea name="notes" rows="3" placeholder="Ek bilgiler..." style="width:100%;padding:8px;background:#0d0d1a;border:1px solid rgba(136,85,255,0.3);border-radius:4px;color:#fff;font-size:11px;resize:none;"></textarea>
                </div>
                <button type="submit" style="width:100%;padding:10px;background:linear-gradient(135deg,#8855ff,#6633cc);border:none;border-radius:6px;color:#fff;font-size:12px;cursor:pointer;font-weight:bold;">
                    <svg width="12" height="12" style="margin-right:4px;vertical-align:middle;"><use href="#icon-plus"/></svg>Varlik Olustur
                </button>
            </form>
        </div>
    </div>

    <!-- GHOST Relationship Graph Modal -->
    <div id="ghostGraphModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:10000;">
        <div style="position:absolute;top:10px;right:10px;z-index:10001;">
            <button onclick="closeGhostGraphModal()" style="background:rgba(255,51,85,0.2);border:1px solid #ff3355;border-radius:50%;width:36px;height:36px;color:#ff3355;font-size:18px;cursor:pointer;">&times;</button>
        </div>
        <div style="position:absolute;top:10px;left:10px;color:#8855ff;font-size:14px;font-weight:bold;">
            <svg width="20" height="20" style="vertical-align:middle;margin-right:8px;"><use href="#icon-network"/></svg>GHOST Iliski Agi
        </div>
        <div id="ghostGraphContainer" style="width:100%;height:100%;"></div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════
         KOMUTA MERKEZİ FLYOUT - Tüm Modüllerin Koordinasyonu
         ═══════════════════════════════════════════════════════════════ -->
    <div class="widget-flyout widget-flyout--danger" id="flyout-komuta" style="width:380px;">
        <div class="flyout-header" style="background:linear-gradient(135deg,rgba(255,51,85,0.2),rgba(255,136,0,0.15));">
            <div class="flyout-title">
                <svg viewBox="0 0 24 24" fill="currentColor" style="width:16px;height:16px;"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/></svg>
                <span class="flyout-title-text" style="background:linear-gradient(90deg,#ff5555,#ff8800);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">KOMUTA MERKEZİ</span>
            </div>
            <button class="flyout-close" onclick="closeFlyout()">
                <svg><use href="#icon-chevron-left"/></svg>
            </button>
        </div>
        <div class="flyout-body" style="padding:12px;">
            <!-- DEFCON Göstergesi -->
            <div id="komutaDefconPanel" style="background:linear-gradient(135deg,rgba(255,51,85,0.15),rgba(0,0,0,0.3));border:2px solid rgba(255,51,85,0.4);border-radius:10px;padding:12px;margin-bottom:12px;text-align:center;">
                <div style="font-size:10px;color:#888;text-transform:uppercase;letter-spacing:2px;margin-bottom:6px;">Tehdit Seviyesi</div>
                <div id="komutaDefconLevel" style="font-size:42px;font-weight:900;font-family:'Orbitron',monospace;color:#00ff88;text-shadow:0 0 20px currentColor;transition:all 0.3s;">5</div>
                <div id="komutaDefconText" style="font-size:12px;color:#00ff88;font-weight:bold;margin-top:4px;">GÜVENLİ</div>
                <div style="display:flex;justify-content:center;gap:6px;margin-top:10px;">
                    <button onclick="komutaDefconDegistir(1)" style="width:28px;height:28px;border-radius:50%;background:#ff3355;border:2px solid #ff5577;color:#fff;font-weight:bold;cursor:pointer;font-size:11px;">1</button>
                    <button onclick="komutaDefconDegistir(2)" style="width:28px;height:28px;border-radius:50%;background:#ff8800;border:2px solid #ffaa33;color:#fff;font-weight:bold;cursor:pointer;font-size:11px;">2</button>
                    <button onclick="komutaDefconDegistir(3)" style="width:28px;height:28px;border-radius:50%;background:#ffcc00;border:2px solid #ffdd44;color:#000;font-weight:bold;cursor:pointer;font-size:11px;">3</button>
                    <button onclick="komutaDefconDegistir(4)" style="width:28px;height:28px;border-radius:50%;background:#00cc88;border:2px solid #00ff99;color:#fff;font-weight:bold;cursor:pointer;font-size:11px;">4</button>
                    <button onclick="komutaDefconDegistir(5)" style="width:28px;height:28px;border-radius:50%;background:#00ff88;border:2px solid #44ffaa;color:#000;font-weight:bold;cursor:pointer;font-size:11px;">5</button>
                </div>
            </div>

            <!-- Modül Durumları -->
            <div style="margin-bottom:12px;">
                <div style="font-size:11px;color:#888;margin-bottom:8px;display:flex;align-items:center;gap:6px;">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="#888"><path d="M4 6h18V4H4c-1.1 0-2 .9-2 2v11H0v3h14v-3H4V6zm19 2h-6c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h6c.55 0 1-.45 1-1V9c0-.55-.45-1-1-1z"/></svg>
                    MODÜL DURUMU
                </div>
                <div id="komutaModulGrid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;">
                    <!-- Modüller JavaScript ile doldurulacak -->
                    <div class="komuta-modul" data-modul="beyin" onclick="komutaModulDetay('beyin')" style="background:rgba(0,255,136,0.1);border:1px solid rgba(0,255,136,0.3);border-radius:6px;padding:8px;text-align:center;cursor:pointer;transition:all 0.2s;">
                        <div style="font-size:16px;margin-bottom:2px;">🧠</div>
                        <div style="font-size:9px;color:#00ff88;font-weight:bold;">BEYIN</div>
                        <div style="font-size:8px;color:#666;" id="modulBeyin">Yükleniyor...</div>
                    </div>
                    <div class="komuta-modul" data-modul="sinkhole" onclick="komutaModulDetay('sinkhole')" style="background:rgba(0,180,255,0.1);border:1px solid rgba(0,180,255,0.3);border-radius:6px;padding:8px;text-align:center;cursor:pointer;transition:all 0.2s;">
                        <div style="font-size:16px;margin-bottom:2px;">🕳️</div>
                        <div style="font-size:9px;color:#00b4ff;font-weight:bold;">SINKHOLE</div>
                        <div style="font-size:8px;color:#666;" id="modulSinkhole">Yükleniyor...</div>
                    </div>
                    <div class="komuta-modul" data-modul="honeypot" onclick="komutaModulDetay('honeypot')" style="background:rgba(255,170,0,0.1);border:1px solid rgba(255,170,0,0.3);border-radius:6px;padding:8px;text-align:center;cursor:pointer;transition:all 0.2s;">
                        <div style="font-size:16px;margin-bottom:2px;">🍯</div>
                        <div style="font-size:9px;color:#ffaa00;font-weight:bold;">HONEYPOT</div>
                        <div style="font-size:8px;color:#666;" id="modulHoneypot">Yükleniyor...</div>
                    </div>
                    <div class="komuta-modul" data-modul="hunter" onclick="komutaModulDetay('hunter')" style="background:rgba(136,85,255,0.1);border:1px solid rgba(136,85,255,0.3);border-radius:6px;padding:8px;text-align:center;cursor:pointer;transition:all 0.2s;">
                        <div style="font-size:16px;margin-bottom:2px;">🎯</div>
                        <div style="font-size:9px;color:#8855ff;font-weight:bold;">HUNTER</div>
                        <div style="font-size:8px;color:#666;" id="modulHunter">Yükleniyor...</div>
                    </div>
                    <div class="komuta-modul" data-modul="wireless" onclick="komutaModulDetay('wireless')" style="background:rgba(0,255,200,0.1);border:1px solid rgba(0,255,200,0.3);border-radius:6px;padding:8px;text-align:center;cursor:pointer;transition:all 0.2s;">
                        <div style="font-size:16px;margin-bottom:2px;">📡</div>
                        <div style="font-size:9px;color:#00ffc8;font-weight:bold;">WIRELESS</div>
                        <div style="font-size:8px;color:#666;" id="modulWireless">Yükleniyor...</div>
                    </div>
                    <div class="komuta-modul" data-modul="soar" onclick="komutaModulDetay('soar')" style="background:rgba(255,51,85,0.1);border:1px solid rgba(255,51,85,0.3);border-radius:6px;padding:8px;text-align:center;cursor:pointer;transition:all 0.2s;">
                        <div style="font-size:16px;margin-bottom:2px;">⚡</div>
                        <div style="font-size:9px;color:#ff3355;font-weight:bold;">SOAR</div>
                        <div style="font-size:8px;color:#666;" id="modulSoar">Yükleniyor...</div>
                    </div>
                    <div class="komuta-modul" data-modul="ghost" onclick="komutaModulDetay('ghost')" style="background:rgba(100,100,100,0.1);border:1px solid rgba(100,100,100,0.3);border-radius:6px;padding:8px;text-align:center;cursor:pointer;transition:all 0.2s;">
                        <div style="font-size:16px;margin-bottom:2px;">👻</div>
                        <div style="font-size:9px;color:#888;font-weight:bold;">GHOST</div>
                        <div style="font-size:8px;color:#666;" id="modulGhost">Yükleniyor...</div>
                    </div>
                    <div class="komuta-modul" data-modul="tor" onclick="komutaModulDetay('tor')" style="background:rgba(128,0,128,0.1);border:1px solid rgba(128,0,128,0.3);border-radius:6px;padding:8px;text-align:center;cursor:pointer;transition:all 0.2s;">
                        <div style="font-size:16px;margin-bottom:2px;">🧅</div>
                        <div style="font-size:9px;color:#800080;font-weight:bold;">TOR</div>
                        <div style="font-size:8px;color:#666;" id="modulTor">Yükleniyor...</div>
                    </div>
                    <div class="komuta-modul" data-modul="waf" onclick="komutaModulDetay('waf')" style="background:rgba(0,200,150,0.1);border:1px solid rgba(0,200,150,0.3);border-radius:6px;padding:8px;text-align:center;cursor:pointer;transition:all 0.2s;">
                        <div style="font-size:16px;margin-bottom:2px;">🛡️</div>
                        <div style="font-size:9px;color:#00c896;font-weight:bold;">WAF</div>
                        <div style="font-size:8px;color:#666;" id="modulWaf">Yükleniyor...</div>
                    </div>
                    <div class="komuta-modul" data-modul="shannon" onclick="toggleFlyout('shannon')" style="background:rgba(156,39,176,0.1);border:1px solid rgba(156,39,176,0.3);border-radius:6px;padding:8px;text-align:center;cursor:pointer;transition:all 0.2s;">
                        <div style="font-size:16px;margin-bottom:2px;">🔓</div>
                        <div style="font-size:9px;color:#9c27b0;font-weight:bold;">SHANNON</div>
                        <div style="font-size:8px;color:#666;" id="modulShannon">AI Pentester</div>
                    </div>
                </div>
            </div>

            <!-- Son Alarmlar -->
            <div style="margin-bottom:12px;">
                <div style="font-size:11px;color:#888;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;">
                    <span><svg width="12" height="12" viewBox="0 0 24 24" fill="#888"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg> SON ALARMLAR</span>
                    <span id="komutaAlarmCount" style="background:#ff3355;color:#fff;padding:2px 6px;border-radius:10px;font-size:9px;">0</span>
                </div>
                <div id="komutaAlarmList" style="max-height:120px;overflow-y:auto;font-size:10px;">
                    <div style="color:#666;text-align:center;padding:20px;">Alarm yok</div>
                </div>
            </div>

            <!-- Hızlı Aksiyonlar -->
            <div style="margin-bottom:12px;">
                <div style="font-size:11px;color:#888;margin-bottom:8px;">⚡ HIZLI AKSİYONLAR</div>
                <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:6px;">
                    <button onclick="komutaAksiyon('ghost_full')" style="padding:10px;background:linear-gradient(135deg,rgba(100,100,100,0.2),rgba(50,50,50,0.3));border:1px solid rgba(100,100,100,0.4);border-radius:6px;color:#aaa;font-size:10px;cursor:pointer;text-align:left;">
                        <span style="font-size:14px;">👻</span> TAM GHOST MOD
                    </button>
                    <button onclick="komutaAksiyon('lockdown')" style="padding:10px;background:linear-gradient(135deg,rgba(255,51,85,0.2),rgba(200,0,50,0.3));border:1px solid rgba(255,51,85,0.4);border-radius:6px;color:#ff5577;font-size:10px;cursor:pointer;text-align:left;">
                        <span style="font-size:14px;">🔒</span> LOCKDOWN
                    </button>
                    <button onclick="komutaAksiyon('scan_all')" style="padding:10px;background:linear-gradient(135deg,rgba(0,180,255,0.2),rgba(0,100,200,0.3));border:1px solid rgba(0,180,255,0.4);border-radius:6px;color:#00b4ff;font-size:10px;cursor:pointer;text-align:left;">
                        <span style="font-size:14px;">🔍</span> TAM TARAMA
                    </button>
                    <button onclick="komutaAksiyon('report')" style="padding:10px;background:linear-gradient(135deg,rgba(0,255,136,0.2),rgba(0,200,100,0.3));border:1px solid rgba(0,255,136,0.4);border-radius:6px;color:#00ff88;font-size:10px;cursor:pointer;text-align:left;">
                        <span style="font-size:14px;">📊</span> DURUM RAPORU
                    </button>
                </div>
            </div>

            <!-- Onay Bekleyen Aksiyonlar -->
            <div id="komutaOnayPanel" style="display:none;margin-bottom:12px;">
                <div style="font-size:11px;color:#ffaa00;margin-bottom:8px;display:flex;align-items:center;gap:6px;">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="#ffaa00"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>
                    ONAY BEKLEYEN AKSİYONLAR
                </div>
                <div id="komutaOnayList" style="max-height:100px;overflow-y:auto;"></div>
            </div>

            <!-- Footer Stats -->
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:4px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.1);">
                <div style="text-align:center;">
                    <div style="font-size:14px;font-weight:bold;color:#00ff88;" id="komutaAktifModul">0</div>
                    <div style="font-size:8px;color:#666;">Aktif</div>
                </div>
                <div style="text-align:center;">
                    <div style="font-size:14px;font-weight:bold;color:#ffaa00;" id="komutaUyariSayisi">0</div>
                    <div style="font-size:8px;color:#666;">Uyarı</div>
                </div>
                <div style="text-align:center;">
                    <div style="font-size:14px;font-weight:bold;color:#ff3355;" id="komutaTehditSayisi">0</div>
                    <div style="font-size:8px;color:#666;">Tehdit</div>
                </div>
                <div style="text-align:center;">
                    <div style="font-size:14px;font-weight:bold;color:#00b4ff;" id="komutaAksiyonSayisi">0</div>
                    <div style="font-size:8px;color:#666;">Aksiyon</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════
         SOC KOMUTA MERKEZİ FLYOUT - 15 Modül Birleşik Panel
         ═══════════════════════════════════════════════════════════════ -->
    <div class="widget-flyout" id="flyout-soc" style="width:380px;border-color:rgba(200,50,180,0.4);">
        <div class="flyout-header" style="background:linear-gradient(135deg,rgba(255,0,100,0.15),rgba(160,32,240,0.1));">
            <div class="flyout-title">
                <svg viewBox="0 0 24 24" fill="currentColor" style="width:16px;height:16px;color:#c832b4;"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-1 15h2v2h-2v-2zm0-8h2v6h-2V8z"/></svg>
                <span class="flyout-title-text" style="background:linear-gradient(90deg,#ff0064,#a020f0);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">SOC KOMUTA MERKEZİ</span>
            </div>
            <button class="flyout-close" onclick="closeFlyout()">
                <svg><use href="#icon-chevron-left"/></svg>
            </button>
        </div>
        <div class="flyout-body" style="padding:0;">
            <!-- SOC Sekme Navigasyonu -->
            <div style="display:flex;border-bottom:1px solid rgba(255,255,255,0.1);background:rgba(0,0,0,0.2);">
                <button class="soc-tab active" data-tab="alarmlar" onclick="socTabDegistir('alarmlar')">ALARMLAR</button>
                <button class="soc-tab" data-tab="siem" onclick="socTabDegistir('siem')">SIEM</button>
                <button class="soc-tab" data-tab="vakalar" onclick="socTabDegistir('vakalar')">VAKALAR</button>
                <button class="soc-tab" data-tab="tehdit" onclick="socTabDegistir('tehdit')">TEHDİT</button>
                <button class="soc-tab" data-tab="uyumluluk" onclick="socTabDegistir('uyumluluk')">UYUM</button>
            </div>

            <!-- ALARMLAR Sekmesi -->
            <div class="soc-tab-content active" id="socTab-alarmlar" style="padding:10px;">
                <!-- Ciddiyet Kartları -->
                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:10px;">
                    <div class="soc-severity-card" style="--sev-color:#ff1744;">
                        <div class="soc-severity-val" id="socCritical">0</div>
                        <div class="soc-severity-lbl">KRİTİK</div>
                    </div>
                    <div class="soc-severity-card" style="--sev-color:#ff6d00;">
                        <div class="soc-severity-val" id="socHigh">0</div>
                        <div class="soc-severity-lbl">YÜKSEK</div>
                    </div>
                    <div class="soc-severity-card" style="--sev-color:#ffab00;">
                        <div class="soc-severity-val" id="socMedium">0</div>
                        <div class="soc-severity-lbl">ORTA</div>
                    </div>
                    <div class="soc-severity-card" style="--sev-color:#00bfa5;">
                        <div class="soc-severity-val" id="socLow">0</div>
                        <div class="soc-severity-lbl">DÜŞÜK</div>
                    </div>
                </div>
                <!-- Metrikler -->
                <div style="display:flex;gap:8px;margin-bottom:10px;">
                    <div style="flex:1;background:rgba(0,0,0,0.3);border-radius:6px;padding:6px 8px;text-align:center;">
                        <div style="font-size:11px;font-weight:bold;color:#00b4ff;" id="socMTTD">N/A</div>
                        <div style="font-size:8px;color:#666;">MTTD</div>
                    </div>
                    <div style="flex:1;background:rgba(0,0,0,0.3);border-radius:6px;padding:6px 8px;text-align:center;">
                        <div style="font-size:11px;font-weight:bold;color:#00ff88;" id="socMTTR">N/A</div>
                        <div style="font-size:8px;color:#666;">MTTR</div>
                    </div>
                    <div style="flex:1;background:rgba(0,0,0,0.3);border-radius:6px;padding:6px 8px;text-align:center;">
                        <div style="font-size:11px;font-weight:bold;color:#ff3355;" id="socSLABreached">0</div>
                        <div style="font-size:8px;color:#666;">SLA İhlal</div>
                    </div>
                </div>
                <!-- Alarm Listesi -->
                <div style="font-size:9px;color:#888;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">Son Alarmlar</div>
                <div id="socAlarmListesi" style="max-height:200px;overflow-y:auto;display:flex;flex-direction:column;gap:4px;">
                    <div style="text-align:center;color:#555;font-size:10px;padding:20px 0;">Yükleniyor...</div>
                </div>
            </div>

            <!-- SIEM Sekmesi -->
            <div class="soc-tab-content" id="socTab-siem" style="padding:10px;display:none;">
                <div style="display:flex;flex-direction:column;gap:8px;">
                    <!-- Wazuh -->
                    <div style="display:flex;align-items:center;gap:8px;padding:8px;background:rgba(0,0,0,0.3);border-radius:6px;">
                        <div class="soc-modul-badge" id="socWazuhBadge" style="background:#444;">W</div>
                        <div style="flex:1;">
                            <div style="font-size:11px;font-weight:bold;color:#ddd;">Wazuh HIDS</div>
                            <div style="font-size:9px;color:#888;" id="socWazuhStatus">Bağlantı kontrol ediliyor...</div>
                        </div>
                    </div>
                    <!-- Suricata -->
                    <div style="display:flex;align-items:center;gap:8px;padding:8px;background:rgba(0,0,0,0.3);border-radius:6px;">
                        <div class="soc-modul-badge" id="socSuricataBadge" style="background:#444;">S</div>
                        <div style="flex:1;">
                            <div style="font-size:11px;font-weight:bold;color:#ddd;">Suricata NIDS</div>
                            <div style="font-size:9px;color:#888;" id="socSuricataStatus">Bağlantı kontrol ediliyor...</div>
                        </div>
                    </div>
                    <!-- Sigma -->
                    <div style="display:flex;align-items:center;gap:8px;padding:8px;background:rgba(0,0,0,0.3);border-radius:6px;">
                        <div class="soc-modul-badge" style="background:#6a1b9a;">Σ</div>
                        <div style="flex:1;">
                            <div style="font-size:11px;font-weight:bold;color:#ddd;">Sigma Engine</div>
                            <div style="font-size:9px;color:#888;"><span id="socSigmaRules">0</span> kural aktif</div>
                        </div>
                    </div>
                    <!-- Normalizer -->
                    <div style="display:flex;align-items:center;gap:8px;padding:8px;background:rgba(0,0,0,0.3);border-radius:6px;">
                        <div class="soc-modul-badge" style="background:#00695c;">N</div>
                        <div style="flex:1;">
                            <div style="font-size:11px;font-weight:bold;color:#ddd;">Alert Normalizer</div>
                            <div style="font-size:9px;color:#888;">Kaynak normalizasyonu</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VAKALAR Sekmesi -->
            <div class="soc-tab-content" id="socTab-vakalar" style="padding:10px;display:none;">
                <div style="display:flex;flex-direction:column;gap:8px;">
                    <div style="display:flex;align-items:center;gap:8px;padding:10px;background:rgba(0,0,0,0.3);border-radius:6px;">
                        <div class="soc-modul-badge" style="background:#e65100;font-size:10px;">TH</div>
                        <div style="flex:1;">
                            <div style="font-size:11px;font-weight:bold;color:#ddd;">TheHive</div>
                            <div style="font-size:9px;color:#888;" id="socTheHiveStatus">Kontrol ediliyor...</div>
                        </div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">
                        <div style="background:rgba(0,0,0,0.3);border-radius:6px;padding:10px;text-align:center;">
                            <div style="font-size:18px;font-weight:bold;color:#ff6d00;" id="socOpenCases">0</div>
                            <div style="font-size:9px;color:#888;">Açık Vaka</div>
                        </div>
                        <div style="background:rgba(0,0,0,0.3);border-radius:6px;padding:10px;text-align:center;">
                            <div style="font-size:18px;font-weight:bold;color:#aaa;" id="socTotalCases">0</div>
                            <div style="font-size:9px;color:#888;">Toplam Vaka</div>
                        </div>
                    </div>
                    <!-- Onay Akışı -->
                    <div style="display:flex;align-items:center;gap:8px;padding:8px;background:rgba(0,0,0,0.3);border-radius:6px;">
                        <div class="soc-modul-badge" style="background:#1565c0;">✓</div>
                        <div style="flex:1;">
                            <div style="font-size:11px;font-weight:bold;color:#ddd;">Onay Akışı</div>
                            <div style="font-size:9px;color:#888;">Müdahale onay mekanizması</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TEHDİT Sekmesi -->
            <div class="soc-tab-content" id="socTab-tehdit" style="padding:10px;display:none;">
                <div style="display:flex;flex-direction:column;gap:8px;">
                    <!-- MISP -->
                    <div style="display:flex;align-items:center;gap:8px;padding:8px;background:rgba(0,0,0,0.3);border-radius:6px;">
                        <div class="soc-modul-badge" style="background:#b71c1c;">M</div>
                        <div style="flex:1;">
                            <div style="font-size:11px;font-weight:bold;color:#ddd;">MISP</div>
                            <div style="font-size:9px;color:#888;" id="socMISPStatus">Kontrol ediliyor...</div>
                        </div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">
                        <div style="background:rgba(0,0,0,0.3);border-radius:6px;padding:10px;text-align:center;">
                            <div style="font-size:18px;font-weight:bold;color:#ff1744;" id="socIOCCount">0</div>
                            <div style="font-size:9px;color:#888;">IOC</div>
                        </div>
                        <div style="background:rgba(0,0,0,0.3);border-radius:6px;padding:10px;text-align:center;">
                            <div style="font-size:18px;font-weight:bold;color:#aaa;" id="socEventCount">0</div>
                            <div style="font-size:9px;color:#888;">Olay</div>
                        </div>
                    </div>
                    <!-- IOC Enrichment -->
                    <div style="display:flex;align-items:center;gap:8px;padding:8px;background:rgba(0,0,0,0.3);border-radius:6px;">
                        <div class="soc-modul-badge" style="background:#4a148c;">E</div>
                        <div style="flex:1;">
                            <div style="font-size:11px;font-weight:bold;color:#ddd;">IOC Zenginleştirme</div>
                            <div style="font-size:9px;color:#888;">OTX, AbuseIPDB, VT</div>
                        </div>
                    </div>
                    <!-- Cortex -->
                    <div style="display:flex;align-items:center;gap:8px;padding:8px;background:rgba(0,0,0,0.3);border-radius:6px;">
                        <div class="soc-modul-badge" style="background:#283593;">C</div>
                        <div style="flex:1;">
                            <div style="font-size:11px;font-weight:bold;color:#ddd;">Cortex Analyzer</div>
                            <div style="font-size:9px;color:#888;">Otomatik analiz</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- UYUMLULUK Sekmesi -->
            <div class="soc-tab-content" id="socTab-uyumluluk" style="padding:10px;display:none;">
                <div style="display:flex;flex-direction:column;gap:8px;">
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;">
                        <div style="background:rgba(0,0,0,0.3);border-radius:6px;padding:10px;text-align:center;">
                            <div style="font-size:16px;font-weight:bold;color:#00b4ff;" id="socNIST">0%</div>
                            <div style="font-size:9px;color:#888;">NIST</div>
                        </div>
                        <div style="background:rgba(0,0,0,0.3);border-radius:6px;padding:10px;text-align:center;">
                            <div style="font-size:16px;font-weight:bold;color:#00ff88;" id="socISO">0%</div>
                            <div style="font-size:9px;color:#888;">ISO 27001</div>
                        </div>
                        <div style="background:rgba(0,0,0,0.3);border-radius:6px;padding:10px;text-align:center;">
                            <div style="font-size:16px;font-weight:bold;color:#ffab00;" id="socKVKK">0%</div>
                            <div style="font-size:9px;color:#888;">KVKK</div>
                        </div>
                    </div>
                    <div style="background:rgba(0,0,0,0.3);border-radius:6px;padding:10px;text-align:center;">
                        <div style="font-size:24px;font-weight:bold;color:#fff;" id="socOverallScore">0<span style="font-size:14px;color:#888;">%</span></div>
                        <div style="font-size:9px;color:#888;">Genel Uyumluluk Skoru</div>
                    </div>
                </div>
            </div>

            <!-- 15 Modül Durum Grid -->
            <div style="padding:8px 10px;border-top:1px solid rgba(255,255,255,0.06);">
                <div style="font-size:8px;color:#666;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">Modül Durumu (15)</div>
                <div id="socModulGrid" style="display:flex;flex-wrap:wrap;gap:4px;">
                    <span class="soc-mod-dot" data-mod="rbac" title="RBAC"></span>
                    <span class="soc-mod-dot" data-mod="alert_queue" title="Alarm Kuyruğu"></span>
                    <span class="soc-mod-dot" data-mod="soc_dashboard" title="Dashboard"></span>
                    <span class="soc-mod-dot" data-mod="notifications" title="Bildirimler"></span>
                    <span class="soc-mod-dot" data-mod="approval" title="Onay Akışı"></span>
                    <span class="soc-mod-dot" data-mod="auto_response" title="Oto Müdahale"></span>
                    <span class="soc-mod-dot" data-mod="wazuh" title="Wazuh"></span>
                    <span class="soc-mod-dot" data-mod="suricata" title="Suricata"></span>
                    <span class="soc-mod-dot" data-mod="normalizer" title="Normalizer"></span>
                    <span class="soc-mod-dot" data-mod="sigma" title="Sigma"></span>
                    <span class="soc-mod-dot" data-mod="enrichment" title="Zenginleştirme"></span>
                    <span class="soc-mod-dot" data-mod="cortex" title="Cortex"></span>
                    <span class="soc-mod-dot" data-mod="thehive" title="TheHive"></span>
                    <span class="soc-mod-dot" data-mod="misp" title="MISP"></span>
                    <span class="soc-mod-dot" data-mod="compliance" title="Uyumluluk"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════
         SHANNON AI PENTESTER FLYOUT - Otonom Sızma Testi
         ═══════════════════════════════════════════════════════════════ -->
    <div class="widget-flyout" id="flyout-shannon" style="width:360px;border-color:rgba(156,39,176,0.4);">
        <div class="flyout-header" style="background:linear-gradient(135deg,rgba(156,39,176,0.2),rgba(103,58,183,0.15));">
            <div class="flyout-title">
                <svg viewBox="0 0 24 24" fill="currentColor" style="width:16px;height:16px;color:#9c27b0;"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm4.5 11.5l-6 6-3-3 1.5-1.5 1.5 1.5 4.5-4.5 1.5 1.5z"/></svg>
                <span class="flyout-title-text" style="background:linear-gradient(90deg,#9c27b0,#673ab7);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">SHANNON AI PENTESTER</span>
            </div>
            <button class="flyout-close" onclick="closeFlyout()">
                <svg><use href="#icon-chevron-left"/></svg>
            </button>
        </div>
        <div class="flyout-body" style="padding:12px;">
            <!-- Durum Göstergesi -->
            <div id="shannonStatusPanel" style="background:linear-gradient(135deg,rgba(156,39,176,0.15),rgba(0,0,0,0.3));border:2px solid rgba(156,39,176,0.4);border-radius:10px;padding:12px;margin-bottom:12px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                    <div style="font-size:10px;color:#888;text-transform:uppercase;letter-spacing:2px;">AI Pentester Durumu</div>
                    <div id="shannonModuleStatus" style="font-size:10px;padding:3px 8px;border-radius:10px;background:rgba(0,255,136,0.2);color:#00ff88;">HAZIR</div>
                </div>
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;text-align:center;">
                    <div>
                        <div id="shannonActiveScans" style="font-size:20px;font-weight:bold;color:#9c27b0;">0</div>
                        <div style="font-size:9px;color:#666;">Aktif Test</div>
                    </div>
                    <div>
                        <div id="shannonTotalFindings" style="font-size:20px;font-weight:bold;color:#ff3355;">0</div>
                        <div style="font-size:9px;color:#666;">Toplam Bulgu</div>
                    </div>
                    <div>
                        <div id="shannonSuccessRate" style="font-size:20px;font-weight:bold;color:#00ff88;">96%</div>
                        <div style="font-size:9px;color:#666;">Başarı</div>
                    </div>
                </div>
            </div>

            <!-- Yeni Pentest Başlat -->
            <div style="margin-bottom:12px;">
                <div style="font-size:11px;color:#888;margin-bottom:8px;display:flex;align-items:center;gap:6px;">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="#888"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                    YENİ PENTEST
                </div>
                <input type="text" id="shannonTargetUrl" placeholder="Hedef URL (https://example.com)" style="width:100%;padding:10px;background:rgba(0,0,0,0.3);border:1px solid rgba(156,39,176,0.3);border-radius:6px;color:#fff;font-size:11px;margin-bottom:8px;box-sizing:border-box;">
                <input type="text" id="shannonRepoPath" placeholder="Repo Path (opsiyonel - white-box için)" style="width:100%;padding:10px;background:rgba(0,0,0,0.3);border:1px solid rgba(156,39,176,0.2);border-radius:6px;color:#fff;font-size:11px;margin-bottom:8px;box-sizing:border-box;">
                <button onclick="shannonStartPentest()" style="width:100%;padding:12px;background:linear-gradient(135deg,rgba(156,39,176,0.3),rgba(103,58,183,0.4));border:2px solid rgba(156,39,176,0.6);border-radius:6px;color:#9c27b0;font-size:12px;font-weight:bold;cursor:pointer;transition:all 0.3s;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="vertical-align:middle;margin-right:6px;"><path d="M8 5v14l11-7z"/></svg>
                    PENTEST BAŞLAT
                </button>
            </div>

            <!-- Desteklenen Açık Türleri -->
            <div style="margin-bottom:12px;">
                <div style="font-size:11px;color:#888;margin-bottom:8px;">🎯 TESPİT EDİLEN AÇIKLAR</div>
                <div style="display:flex;flex-wrap:wrap;gap:4px;">
                    <span style="padding:4px 8px;background:rgba(255,51,85,0.2);border:1px solid rgba(255,51,85,0.4);border-radius:4px;font-size:9px;color:#ff5577;">SQL Injection</span>
                    <span style="padding:4px 8px;background:rgba(255,136,0,0.2);border:1px solid rgba(255,136,0,0.4);border-radius:4px;font-size:9px;color:#ff8800;">XSS</span>
                    <span style="padding:4px 8px;background:rgba(0,180,255,0.2);border:1px solid rgba(0,180,255,0.4);border-radius:4px;font-size:9px;color:#00b4ff;">SSRF</span>
                    <span style="padding:4px 8px;background:rgba(136,85,255,0.2);border:1px solid rgba(136,85,255,0.4);border-radius:4px;font-size:9px;color:#8855ff;">Auth Bypass</span>
                    <span style="padding:4px 8px;background:rgba(0,255,136,0.2);border:1px solid rgba(0,255,136,0.4);border-radius:4px;font-size:9px;color:#00ff88;">IDOR</span>
                    <span style="padding:4px 8px;background:rgba(255,204,0,0.2);border:1px solid rgba(255,204,0,0.4);border-radius:4px;font-size:9px;color:#ffcc00;">Path Traversal</span>
                </div>
            </div>

            <!-- Aktif Oturumlar -->
            <div style="margin-bottom:12px;">
                <div style="font-size:11px;color:#888;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;">
                    <span>🔄 AKTİF OTURUMLAR</span>
                    <button onclick="shannonRefreshSessions()" style="padding:2px 8px;background:rgba(156,39,176,0.2);border:1px solid rgba(156,39,176,0.4);border-radius:4px;color:#9c27b0;font-size:9px;cursor:pointer;">Yenile</button>
                </div>
                <div id="shannonSessionList" style="max-height:120px;overflow-y:auto;">
                    <div style="color:#666;text-align:center;padding:15px;font-size:10px;">Aktif pentest yok</div>
                </div>
            </div>

            <!-- Son Bulgular -->
            <div style="margin-bottom:12px;">
                <div style="font-size:11px;color:#888;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;">
                    <span>🔍 SON BULGULAR</span>
                    <span id="shannonFindingCount" style="background:#ff3355;color:#fff;padding:2px 6px;border-radius:10px;font-size:9px;">0</span>
                </div>
                <div id="shannonFindingsList" style="max-height:150px;overflow-y:auto;">
                    <div style="color:#666;text-align:center;padding:15px;font-size:10px;">Bulgu yok - test başlatın</div>
                </div>
            </div>

            <!-- Hızlı Aksiyonlar -->
            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:6px;">
                <button onclick="shannonShowOnMap()" style="padding:10px;background:linear-gradient(135deg,rgba(0,180,255,0.2),rgba(0,100,200,0.3));border:1px solid rgba(0,180,255,0.4);border-radius:6px;color:#00b4ff;font-size:10px;cursor:pointer;text-align:left;">
                    <span style="font-size:14px;">🗺️</span> HARİTADA GÖSTER
                </button>
                <button onclick="shannonExportToSOAR()" style="padding:10px;background:linear-gradient(135deg,rgba(255,51,85,0.2),rgba(200,0,50,0.3));border:1px solid rgba(255,51,85,0.4);border-radius:6px;color:#ff5577;font-size:10px;cursor:pointer;text-align:left;">
                    <span style="font-size:14px;">⚡</span> SOAR'A AKTAR
                </button>
            </div>

            <!-- Footer: "No Exploit, No Report" -->
            <div style="margin-top:12px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.1);text-align:center;">
                <div style="font-size:9px;color:#666;">Sadece <span style="color:#00ff88;">DOĞRULANMIŞ</span> açıklar raporlanır</div>
                <div style="font-size:8px;color:#9c27b0;margin-top:4px;">"No Exploit, No Report" • Shannon AI v1.0</div>
            </div>
        </div>
    </div>

    <!-- Onay Modal -->
    <div id="komutaOnayModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:10001;display:none;align-items:center;justify-content:center;">
        <div style="background:linear-gradient(135deg,#1a1a2e,#0f0f1a);border:2px solid rgba(255,170,0,0.5);border-radius:12px;padding:24px;max-width:400px;width:90%;box-shadow:0 0 40px rgba(255,170,0,0.2);">
            <div style="text-align:center;margin-bottom:16px;">
                <div style="font-size:48px;margin-bottom:8px;">⚠️</div>
                <h3 style="color:#ffaa00;margin:0;font-size:16px;">KRİTİK AKSİYON ONAYI</h3>
            </div>
            <div id="komutaOnayIcerik" style="background:rgba(0,0,0,0.3);border-radius:8px;padding:12px;margin-bottom:16px;font-size:12px;color:#ddd;"></div>
            <div style="display:flex;gap:10px;">
                <button onclick="komutaOnayVer(true)" style="flex:1;padding:12px;background:linear-gradient(135deg,#00ff88,#00cc66);border:none;border-radius:8px;color:#000;font-weight:bold;cursor:pointer;font-size:13px;">✓ ONAYLA</button>
                <button onclick="komutaOnayVer(false)" style="flex:1;padding:12px;background:linear-gradient(135deg,#ff3355,#cc0033);border:none;border-radius:8px;color:#fff;font-weight:bold;cursor:pointer;font-size:13px;">✗ REDDET</button>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════
         SİBER KOMUTA POPUP - SAĞ ALT
         ═══════════════════════════════════════════════════════════════ -->
    <div id="siberKomutaPopup">
        <div class="siber-popup-header">
            <h3>🎖️ SİBER KOMUTA MERKEZİ</h3>
            <button class="siber-popup-close" onclick="toggleSiberKomutaPopup()">&times;</button>
        </div>
        <div class="siber-popup-body">
            <!-- İstatistikler -->
            <div class="siber-popup-stats">
                <div class="siber-popup-stat">
                    <div class="value" style="color:#00ff88" id="skpAjanSayisi">22</div>
                    <div class="label">Ajan</div>
                </div>
                <div class="siber-popup-stat">
                    <div class="value" style="color:#00b4ff" id="skpOpSayisi">0</div>
                    <div class="label">Operasyon</div>
                </div>
                <div class="siber-popup-stat">
                    <div class="value" style="color:#ff4444" id="skpTehditSayisi">0</div>
                    <div class="label">Tehdit</div>
                </div>
                <div class="siber-popup-stat">
                    <div class="value" style="color:#8855ff" id="skpGroqDurum">●</div>
                    <div class="label">GROQ AI</div>
                </div>
            </div>

            <!-- OSINT Arama -->
            <div class="siber-popup-section">
                <h4>🔍 Hızlı OSINT Arama</h4>
                <div class="siber-popup-osint">
                    <input type="text" id="skpOsintHedef" placeholder="IP / Domain / Hash / Email...">
                    <button onclick="skpOSINTBaslat()">ARA</button>
                </div>
            </div>

            <!-- Ajan Katmanları -->
            <div class="siber-popup-section">
                <h4>🎖️ Pentagon Ajanları (22)</h4>
                <div class="siber-popup-agents">
                    <div class="siber-popup-agent komuta">
                        <div class="count">3</div>
                        <div class="name">Komuta</div>
                    </div>
                    <div class="siber-popup-agent istihbarat">
                        <div class="count">5</div>
                        <div class="name">İstihbarat</div>
                    </div>
                    <div class="siber-popup-agent savunma">
                        <div class="count">4</div>
                        <div class="name">Savunma</div>
                    </div>
                    <div class="siber-popup-agent saldiri">
                        <div class="count">4</div>
                        <div class="name">Saldırı</div>
                    </div>
                    <div class="siber-popup-agent uzman">
                        <div class="count">6</div>
                        <div class="name">Uzman</div>
                    </div>
                </div>
            </div>

            <!-- Aksiyon Butonları -->
            <div class="siber-popup-section">
                <h4>⚡ Hızlı Aksiyonlar</h4>
                <div class="siber-popup-actions">
                    <button class="siber-popup-btn" onclick="skpTehditAvi()">
                        🎯 Tehdit Avı
                    </button>
                    <button class="siber-popup-btn" onclick="skpHavaSahasi()">
                        ✈️ Hava Sahası
                    </button>
                    <button class="siber-popup-btn" onclick="skpISSBaslat()">
                        🛰️ ISS Takip
                    </button>
                    <button class="siber-popup-btn" onclick="skpGroqSor()">
                        🤖 GROQ AI
                    </button>
                    <button class="siber-popup-btn danger" onclick="skpPentest()">
                        💀 Pentest
                    </button>
                    <button class="siber-popup-btn success" onclick="skpSavunma()">
                        🛡️ Savunma
                    </button>
                    <button class="siber-popup-btn full" onclick="window.location.href='/siber'">
                        📊 Tam Siber Komuta Paneli
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- DALGA SIGINT Control Panel -->
    <div id="sigint-panel" class="sigint-panel">
        <div class="sigint-header">
            <h3>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                </svg>
                DALGA SIGINT
            </h3>
            <button class="sigint-close" onclick="toggleSigintPanel()">&times;</button>
        </div>

        <div class="sigint-body">
            <!-- Stealth Mode -->
            <div class="sigint-section">
                <h4>Gizlilik Modu</h4>
                <select id="sigint-stealth" style="width:100%;padding:8px;background:rgba(0,0,0,0.3);border:1px solid rgba(0,200,150,0.3);border-radius:6px;color:#00c896;font-size:11px;">
                    <option value="normal">Normal - Tüm Özellikler</option>
                    <option value="reduced">Azaltılmış - Sadece Yerel</option>
                    <option value="ghost">Hayalet - Pasif Mod</option>
                </select>
            </div>

            <!-- Scan Controls -->
            <div class="sigint-section">
                <h4>Tarama Kontrolleri</h4>
                <div class="sigint-btn-group">
                    <button class="sigint-btn" id="btn-wifi" onclick="startSigintScan('wifi')">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M1 9l2 2c4.97-4.97 13.03-4.97 18 0l2-2C16.93 2.93 7.08 2.93 1 9zm8 8l3 3 3-3c-1.65-1.66-4.34-1.66-6 0zm-4-4l2 2c2.76-2.76 7.24-2.76 10 0l2-2C15.14 9.14 8.87 9.14 5 13z"/></svg>
                        WiFi
                    </button>
                    <button class="sigint-btn" id="btn-bluetooth" onclick="startSigintScan('bluetooth')">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M17.71 7.71L12 2h-1v7.59L6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 11 14.41V22h1l5.71-5.71-4.3-4.29 4.3-4.29zM13 5.83l1.88 1.88L13 9.59V5.83zm1.88 10.46L13 18.17v-3.76l1.88 1.88z"/></svg>
                        Bluetooth
                    </button>
                    <button class="sigint-btn" id="btn-cell" onclick="startSigintScan('cell')">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M17.7 7.7L12 2 6.3 7.7c-3.1 3.1-3.1 8.2 0 11.3 1.6 1.6 3.6 2.3 5.7 2.3s4.1-.8 5.7-2.3c3.1-3.1 3.1-8.2 0-11.3zM12 19.6c-1.6 0-3.1-.6-4.2-1.8-2.4-2.4-2.4-6.2 0-8.5L12 5.1l4.2 4.2c2.4 2.4 2.4 6.2 0 8.5-1.2 1.2-2.7 1.8-4.2 1.8z"/></svg>
                        Hücre
                    </button>
                    <button class="sigint-btn" id="btn-all" onclick="startSigintScan('all')">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm7-7H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.11 0 2-.9 2-2V5c0-1.1-.89-2-2-2zm-1.75 9c0 .23-.02.46-.05.68l1.48 1.16c.13.11.17.3.08.45l-1.4 2.42c-.09.15-.27.21-.43.15l-1.74-.7c-.36.28-.76.51-1.18.69l-.26 1.85c-.03.17-.18.3-.35.3h-2.8c-.17 0-.32-.13-.35-.29l-.26-1.85c-.43-.18-.82-.41-1.18-.69l-1.74.7c-.16.06-.34 0-.43-.15l-1.4-2.42c-.09-.15-.05-.34.08-.45l1.48-1.16c-.03-.23-.05-.46-.05-.69 0-.23.02-.46.05-.68l-1.48-1.16c-.13-.11-.17-.3-.08-.45l1.4-2.42c.09-.15.27-.21.43-.15l1.74.7c.36-.28.76-.51 1.18-.69l.26-1.85c.03-.17.18-.3.35-.3h2.8c.17 0 .32.13.35.29l.26 1.85c.43.18.82.41 1.18.69l1.74-.7c.16-.06.34 0 .43.15l1.4 2.42c.09.15.05.34-.08.45l-1.48 1.16c.03.23.05.46.05.69z"/></svg>
                        Tümü
                    </button>
                </div>
            </div>

            <!-- Stats -->
            <div class="sigint-section">
                <h4>İstatistikler</h4>
                <div class="sigint-stats">
                    <div class="stat-item">
                        <span class="stat-value" id="sigint-wifi-count">0</span>
                        <span class="stat-label">WiFi</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="sigint-bt-count">0</span>
                        <span class="stat-label">BT</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="sigint-cell-count">0</span>
                        <span class="stat-label">Baz</span>
                    </div>
                    <div class="stat-item threat">
                        <span class="stat-value" id="sigint-threat-count">0</span>
                        <span class="stat-label">Tehdit</span>
                    </div>
                </div>
            </div>

            <!-- Layers -->
            <div class="sigint-section">
                <h4>Harita Katmanları</h4>
                <div class="sigint-layers">
                    <label><input type="checkbox" id="layer-wifi" checked onchange="toggleSigintLayer('wifi')"> WiFi Ağları</label>
                    <label><input type="checkbox" id="layer-bt" checked onchange="toggleSigintLayer('bluetooth')"> Bluetooth Cihazlar</label>
                    <label><input type="checkbox" id="layer-cell" checked onchange="toggleSigintLayer('cell')"> Baz İstasyonları</label>
                    <label><input type="checkbox" id="layer-iot" onchange="toggleSigintLayer('iot')"> IoT Cihazlar</label>
                    <label><input type="checkbox" id="layer-heatmap" onchange="toggleSigintLayer('heatmap')"> Tehdit Isı Haritası</label>
                </div>
            </div>

            <!-- Threat Alerts -->
            <div class="sigint-section">
                <h4>Son Tehdit Uyarıları</h4>
                <div id="sigint-alerts" class="sigint-alerts">
                    <div style="text-align:center;color:rgba(255,255,255,0.4);font-size:10px;padding:15px;">
                        Tarama başlatıldığında tehditler burada görünecek
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="sigint-section">
                <h4>Hızlı İşlemler</h4>
                <div class="sigint-btn-group">
                    <button class="sigint-btn" onclick="exportSigintData()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                        Dışa Aktar
                    </button>
                    <button class="sigint-btn" onclick="clearSigintData()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                        Temizle
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- LYDIAN AI Guvenlik Araclari Modal -->
    <div class="mcp-modal" id="mcpModal">
        <div class="mcp-container">
            <div class="mcp-header">
                <h3>LYDIAN - AI Destekli Guvenlik Araclari</h3>
                <button class="mcp-close" onclick="mcpPanelKapat()">&times;</button>
            </div>
            <div class="mcp-categories" id="mcpCategories">
                <button class="mcp-cat-btn active" data-cat="">Tumu</button>
                <button class="mcp-cat-btn" data-cat="recon">Kesif</button>
                <button class="mcp-cat-btn" data-cat="vuln">Zafiyet</button>
                <button class="mcp-cat-btn" data-cat="osint">OSINT</button>
                <button class="mcp-cat-btn" data-cat="network">Ag</button>
                <button class="mcp-cat-btn" data-cat="web">Web</button>
                <button class="mcp-cat-btn" data-cat="crypto">Kripto</button>
            </div>
            <div class="mcp-content">
                <div class="mcp-tools" id="mcpTools">
                    <div style="text-align:center;color:var(--text-dim);padding:20px">Yukleniyor...</div>
                </div>
                <div class="mcp-runner">
                    <div class="mcp-input-group">
                        <label>Hedef (IP / Domain / URL)</label>
                        <input type="text" id="mcpHedef" placeholder="ornek.com veya 192.168.1.1">
                    </div>
                    <div class="mcp-input-group">
                        <label>Ek Parametreler (JSON)</label>
                        <input type="text" id="mcpParams" placeholder='{"ports": "1-1000"}'>
                    </div>
                    <button class="mcp-run-btn" id="mcpRunBtn" onclick="mcpCalistir()">Araci Calistir</button>
                    <div class="mcp-output" id="mcpOutput">Sonuclar burada gorunecek...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- GNN Graf Görselleştirme Modal -->
    <div class="gnn-modal" id="gnnModal">
        <div class="gnn-container">
            <div class="gnn-header">
                <h3>GNN Tehdit Ağı Görselleştirme</h3>
                <button class="gnn-close" onclick="gnnPanelKapat()">&times;</button>
            </div>
            <div class="gnn-toolbar">
                <button class="gnn-btn" onclick="gnnGrafiYenile()">↻ Yenile</button>
                <button class="gnn-btn" onclick="gnnTehditFeedTopla()">📡 Tehdit Feed</button>
                <button class="gnn-btn success" onclick="gnnEgitimBaslat()">🎯 Model Eğit</button>
                <button class="gnn-btn" onclick="gnnAnaliz()">🔍 Analiz</button>
                <button class="gnn-btn" onclick="gnnMerkeziDugumler()">⭐ Merkezi</button>
                <button class="gnn-btn" onclick="gnnTopluluklar()">🔗 Topluluklar</button>
                <button class="gnn-btn danger" onclick="gnnTemizle()">🗑 Temizle</button>
                <div style="flex:1"></div>
                <span id="gnnStatus" style="color:var(--hud-cyan);font-size:10px">Hazır</span>
            </div>
            <div class="gnn-content">
                <div class="gnn-sidebar">
                    <div class="gnn-stats">
                        <div class="gnn-stat-grid">
                            <div class="gnn-stat-item">
                                <div class="gnn-stat-val" id="gnnDugumSayisi">0</div>
                                <div class="gnn-stat-lbl">Düğüm</div>
                            </div>
                            <div class="gnn-stat-item">
                                <div class="gnn-stat-val" id="gnnKenarSayisi">0</div>
                                <div class="gnn-stat-lbl">Bağlantı</div>
                            </div>
                            <div class="gnn-stat-item">
                                <div class="gnn-stat-val" id="gnnTehditSayisi">0</div>
                                <div class="gnn-stat-lbl">Tehdit</div>
                            </div>
                            <div class="gnn-stat-item">
                                <div class="gnn-stat-val" id="gnnRiskSkoru">0.0</div>
                                <div class="gnn-stat-lbl">Risk</div>
                            </div>
                        </div>
                    </div>
                    <div class="gnn-legend">
                        <h4>Düğüm Tipleri</h4>
                        <div class="gnn-legend-item"><div class="gnn-legend-color" style="background:#00e5ff"></div>IP Adresi</div>
                        <div class="gnn-legend-item"><div class="gnn-legend-color" style="background:#ff9966"></div>Ülke</div>
                        <div class="gnn-legend-item"><div class="gnn-legend-color" style="background:#00ff88"></div>Domain</div>
                        <div class="gnn-legend-item"><div class="gnn-legend-color" style="background:#ff3355"></div>Kötücül IP</div>
                        <div class="gnn-legend-item"><div class="gnn-legend-color" style="background:#ffaa00"></div>C2 Sunucu</div>
                        <div class="gnn-legend-item"><div class="gnn-legend-color" style="background:#8855ff"></div>Kullanıcı</div>
                        <h4 style="margin-top:15px">Bağlantı Tipleri</h4>
                        <div class="gnn-legend-item"><div class="gnn-legend-color" style="background:#ff3355;border-radius:0"></div>Saldırı</div>
                        <div class="gnn-legend-item"><div class="gnn-legend-color" style="background:#00b4ff;border-radius:0"></div>Bağlantı</div>
                        <div class="gnn-legend-item"><div class="gnn-legend-color" style="background:#ff00ff;border-radius:0"></div>Dosya Transfer</div>
                        <div class="gnn-legend-item"><div class="gnn-legend-color" style="background:#ffaa00;border-radius:0"></div>DNS</div>
                    </div>
                    <div class="gnn-training-panel">
                        <h4>🎯 Model Eğitimi</h4>
                        <div class="gnn-input-group">
                            <label>Model Tipi</label>
                            <select id="gnnModelTipi">
                                <option value="tehdit">Tehdit Sınıflandırma</option>
                                <option value="anomali">Anomali Tespiti</option>
                                <option value="apt">APT Zinciri</option>
                            </select>
                        </div>
                        <div class="gnn-input-group">
                            <label>Epoch Sayısı</label>
                            <input type="number" id="gnnEpochs" value="50" min="10" max="500">
                        </div>
                        <div class="gnn-input-group">
                            <label>Örnek Sayısı</label>
                            <input type="number" id="gnnOrnekSayisi" value="500" min="100" max="5000">
                        </div>
                        <button class="gnn-btn success" style="width:100%;justify-content:center;margin-top:10px" onclick="gnnEgitimBaslat()">
                            Eğitimi Başlat
                        </button>
                        <div class="gnn-progress">
                            <div class="gnn-progress-bar" id="gnnProgressBar"></div>
                        </div>
                        <div id="gnnEgitimDurum" style="font-size:10px;color:var(--text-dim);margin-top:8px"></div>
                    </div>
                </div>
                <div class="gnn-graph-area">
                    <svg id="gnnSvg"></svg>
                    <div class="gnn-tooltip" id="gnnTooltip">
                        <div class="gnn-tooltip-header" id="gnnTooltipHeader">Düğüm Bilgisi</div>
                        <div id="gnnTooltipContent"></div>
                    </div>
                    <div class="gnn-info-panel">
                        <div class="gnn-info-title">Graf Metrikleri</div>
                        <div id="gnnMetrikler">Veri yükleniyor...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- OSINT İstihbarat Paneli -->
    <div class="osint-panel" id="osintPanel">
        <div class="osint-header">
            <h3>🔍 OSINT İstihbarat</h3>
            <button class="osint-close" onclick="osintPanelKapat()">&times;</button>
        </div>
        <div class="osint-body">
            <!-- Durum -->
            <div class="osint-status" id="osintStatus">
                <span>📡</span>
                <span>OSINT Modülü Hazır</span>
            </div>

            <!-- Sekmeler -->
            <div class="osint-tabs">
                <div class="osint-tab active" data-tab="telefon" onclick="osintTabDegistir(this)">📱 Telefon</div>
                <div class="osint-tab" data-tab="email" onclick="osintTabDegistir(this)">📧 E-posta</div>
                <div class="osint-tab" data-tab="kullanici" onclick="osintTabDegistir(this)">👤 Kullanıcı</div>
                <div class="osint-tab" data-tab="ip" onclick="osintTabDegistir(this)">🌐 IP</div>
                <div class="osint-tab" data-tab="domain" onclick="osintTabDegistir(this)">🔗 Domain</div>
                <div class="osint-tab" data-tab="dosya" onclick="osintTabDegistir(this)">📁 Dosya</div>
            </div>

            <!-- Telefon Tab -->
            <div class="osint-tab-content active" id="osintTabTelefon">
                <div class="osint-input-group">
                    <label>Telefon Numarası</label>
                    <input type="text" class="osint-input" id="osintTelefon" placeholder="+905551234567 veya 05551234567">
                </div>
                <button class="osint-btn" onclick="osintTelefonAra()">🔍 Telefon Analiz Et</button>
            </div>

            <!-- Email Tab -->
            <div class="osint-tab-content" id="osintTabEmail">
                <div class="osint-input-group">
                    <label>E-posta Adresi</label>
                    <input type="email" class="osint-input" id="osintEmail" placeholder="ornek@example.com">
                </div>
                <button class="osint-btn" onclick="osintEmailAra()">🔍 E-posta Araştır</button>
            </div>

            <!-- Kullanıcı Tab -->
            <div class="osint-tab-content" id="osintTabKullanici">
                <div class="osint-input-group">
                    <label>Kullanıcı Adı</label>
                    <input type="text" class="osint-input" id="osintKullanici" placeholder="username">
                </div>
                <div style="margin-bottom:10px">
                    <label style="display:flex;align-items:center;gap:8px;font-size:11px;color:var(--text-dim)">
                        <input type="checkbox" id="osintHizli" checked> Hızlı Arama (Sadece popüler siteler)
                    </label>
                </div>
                <button class="osint-btn" onclick="osintKullaniciAra()">🔍 Sosyal Medya Ara</button>
            </div>

            <!-- IP Tab -->
            <div class="osint-tab-content" id="osintTabIp">
                <div class="osint-input-group">
                    <label>IP Adresi</label>
                    <input type="text" class="osint-input" id="osintIP" placeholder="8.8.8.8">
                </div>
                <button class="osint-btn" onclick="osintIPAra()">🔍 IP Analiz Et</button>
            </div>

            <!-- Domain Tab -->
            <div class="osint-tab-content" id="osintTabDomain">
                <div class="osint-input-group">
                    <label>Domain</label>
                    <input type="text" class="osint-input" id="osintDomain" placeholder="example.com">
                </div>
                <button class="osint-btn" onclick="osintDomainAra()">🔍 Domain Araştır</button>
            </div>

            <!-- Dosya Tab -->
            <div class="osint-tab-content" id="osintTabDosya">
                <div class="osint-input-group">
                    <label>Dosya Yükle (Metadata Analizi)</label>
                    <input type="file" class="osint-input" id="osintDosya" accept="image/*,.pdf,.doc,.docx">
                </div>
                <button class="osint-btn" onclick="osintDosyaAnaliz()">🔍 Metadata Çıkar</button>
            </div>

            <!-- Sonuçlar -->
            <div class="osint-results" id="osintResults" style="display:none">
                <div id="osintResultsContent"></div>
            </div>
        </div>
    </div>

    <!-- Hava Sahası & Uydu Takip Paneli -->
    <div class="osint-panel" id="aerospacePanel" style="display:none;max-width:420px">
        <div class="osint-header" style="background:linear-gradient(135deg,#1a237e,#311b92);padding:10px 15px">
            <h3 style="font-size:13px;display:flex;align-items:center;gap:6px">✈️🛰️ Hava/Uzay Takip</h3>
            <button class="osint-close" onclick="toggleAerospacePanel()" style="font-size:18px">&times;</button>
        </div>
        <div class="osint-body" style="padding:10px">
            <!-- Durum -->
            <div class="osint-status" id="aerospaceStatus" style="padding:6px 10px;font-size:10px;margin-bottom:8px">
                <span>📡</span>
                <span>Takip Sistemi Hazır</span>
            </div>

            <!-- Sekmeler - Kompakt -->
            <div class="osint-tabs" style="display:flex;gap:2px;margin-bottom:10px;flex-wrap:wrap">
                <div class="osint-tab active" data-tab="ucaklar" onclick="aerospaceTabDegistir(this)" style="padding:6px 8px;font-size:10px;flex:1;min-width:60px;text-align:center">✈️ Uçak</div>
                <div class="osint-tab" data-tab="deprem" onclick="aerospaceTabDegistir(this)" style="padding:6px 8px;font-size:10px;flex:1;min-width:60px;text-align:center">🌍 Deprem</div>
                <div class="osint-tab" data-tab="iss" onclick="aerospaceTabDegistir(this)" style="padding:6px 8px;font-size:10px;flex:1;min-width:50px;text-align:center">🛸 ISS</div>
                <div class="osint-tab" data-tab="uydular" onclick="aerospaceTabDegistir(this)" style="padding:6px 8px;font-size:10px;flex:1;min-width:60px;text-align:center">🛰️ Uydu</div>
                <div class="osint-tab" data-tab="starlink" onclick="aerospaceTabDegistir(this)" style="padding:6px 8px;font-size:10px;flex:1;min-width:60px;text-align:center">⭐ Starlink</div>
            </div>

            <!-- Uçaklar Tab -->
            <div class="osint-tab-content active" id="aerospaceTabUcaklar">
                <!-- Kompakt Kontrol Paneli -->
                <div style="display:flex;gap:6px;margin-bottom:8px;align-items:center">
                    <input type="text" id="aircraftSearchInput" placeholder="Uçuş no (THY123)"
                           style="flex:1;padding:6px 10px;background:var(--bg-void);border:1px solid var(--border-glow);color:var(--text-bright);border-radius:4px;font-size:11px;min-width:0">
                    <button onclick="aircraftAra()" title="Ara" style="padding:6px 10px;background:var(--accent-primary);border:none;border-radius:4px;cursor:pointer;font-size:12px">🔍</button>
                    <select id="aircraftCountryFilter" onchange="aircraftFiltrele()" title="Ülke Filtresi"
                            style="padding:6px;background:var(--bg-void);border:1px solid var(--border-glow);color:var(--text-bright);border-radius:4px;font-size:10px;max-width:80px">
                        <option value="">🌍 Tümü</option>
                        <option value="Turkey">🇹🇷 TR</option>
                        <option value="United States">🇺🇸 US</option>
                        <option value="Germany">🇩🇪 DE</option>
                        <option value="United Kingdom">🇬🇧 UK</option>
                        <option value="France">🇫🇷 FR</option>
                        <option value="Russia">🇷🇺 RU</option>
                        <option value="China">🇨🇳 CN</option>
                        <option value="UAE">🇦🇪 AE</option>
                        <option value="Qatar">🇶🇦 QA</option>
                    </select>
                    <button onclick="aircraftFiltreTemizle()" title="Filtreyi Temizle" style="padding:6px 8px;background:#ff5252;border:none;border-radius:4px;cursor:pointer;font-size:10px">✕</button>
                </div>
                <!-- İkon Butonlar -->
                <div style="display:flex;gap:4px;margin-bottom:8px;justify-content:center">
                    <button onclick="aircraftTakipBaslat()" title="Takibi Başlat" style="flex:1;max-width:100px;padding:8px;background:linear-gradient(135deg,#1565c0,#0d47a1);border:none;border-radius:4px;cursor:pointer;font-size:11px;color:#fff;display:flex;align-items:center;justify-content:center;gap:4px">
                        <span style="font-size:14px">▶</span><span>Başlat</span>
                    </button>
                    <button onclick="aircraftTakipDurdur()" title="Durdur" style="flex:1;max-width:100px;padding:8px;background:linear-gradient(135deg,#c62828,#b71c1c);border:none;border-radius:4px;cursor:pointer;font-size:11px;color:#fff;display:flex;align-items:center;justify-content:center;gap:4px">
                        <span style="font-size:14px">⏹</span><span>Durdur</span>
                    </button>
                    <label style="display:flex;align-items:center;gap:4px;font-size:10px;color:var(--text-dim);padding:0 8px;background:var(--bg-card);border-radius:4px;cursor:pointer" title="Otomatik Yenileme">
                        <input type="checkbox" id="aircraftAutoRefresh" checked style="width:12px;height:12px;margin:0">
                        <span>15s</span>
                    </label>
                </div>
                <!-- Kompakt İstatistikler -->
                <div style="display:flex;gap:6px;margin-bottom:8px">
                    <div style="flex:1;background:linear-gradient(135deg,rgba(0,180,255,0.15),rgba(0,120,200,0.1));padding:8px;border-radius:6px;text-align:center;border:1px solid rgba(0,180,255,0.3)">
                        <div style="font-size:20px;font-weight:700;color:var(--hud-cyan)" id="aircraftCount">0</div>
                        <div style="font-size:9px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.5px">Toplam</div>
                    </div>
                    <div style="flex:1;background:linear-gradient(135deg,rgba(0,255,136,0.15),rgba(0,200,100,0.1));padding:8px;border-radius:6px;text-align:center;border:1px solid rgba(0,255,136,0.3)">
                        <div style="font-size:20px;font-weight:700;color:var(--hud-green)" id="aircraftTR">0</div>
                        <div style="font-size:9px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.5px">TR Sahası</div>
                    </div>
                </div>
                <!-- Uçak Listesi -->
                <div class="osint-results" id="aircraftList" style="display:block;max-height:180px;overflow-y:auto;border-radius:6px;background:var(--bg-card)">
                    <div style="color:var(--text-dim);text-align:center;padding:15px;font-size:11px">
                        <span style="font-size:24px;display:block;margin-bottom:6px;opacity:0.5">✈️</span>
                        Takibi başlatın
                    </div>
                </div>
            </div>

            <!-- Deprem Tab -->
            <div class="osint-tab-content" id="aerospaceTabDeprem" style="display:none">
                <!-- Kompakt Kontrol Satırı -->
                <div style="display:flex;gap:4px;margin-bottom:8px;align-items:center">
                    <button onclick="depremTakipBaslat()" style="flex:1;padding:8px 6px;background:linear-gradient(135deg,#d32f2f,#b71c1c);border:none;border-radius:4px;cursor:pointer;font-size:10px;color:#fff;display:flex;align-items:center;justify-content:center;gap:3px">
                        <span>🌍</span><span>Deprem</span>
                    </button>
                    <button onclick="fayHatlariGoster()" style="flex:1;padding:8px 6px;background:linear-gradient(135deg,#ff5722,#e64a19);border:none;border-radius:4px;cursor:pointer;font-size:10px;color:#fff;display:flex;align-items:center;justify-content:center;gap:3px">
                        <span>🔴</span><span>Fay Hatları</span>
                    </button>
                    <select id="depremMinMag" onchange="depremFiltrele()" title="Minimum Büyüklük" style="padding:6px;background:var(--bg-void);border:1px solid var(--border-glow);color:var(--text-bright);border-radius:4px;font-size:10px;max-width:70px">
                        <option value="0">Tümü</option>
                        <option value="2">M2+</option>
                        <option value="3">M3+</option>
                        <option value="4" selected>M4+</option>
                        <option value="5">M5+</option>
                    </select>
                    <label style="display:flex;align-items:center;gap:3px;font-size:9px;color:var(--text-dim);padding:6px;background:var(--bg-card);border-radius:4px;cursor:pointer;white-space:nowrap" title="Otomatik Güncelleme">
                        <input type="checkbox" id="depremAutoRefresh" checked style="width:11px;height:11px;margin:0">
                        <span>60s</span>
                    </label>
                </div>
                <!-- Kompakt İstatistikler -->
                <div style="display:flex;gap:4px;margin-bottom:8px">
                    <div style="flex:1;background:linear-gradient(135deg,rgba(255,87,34,0.15),rgba(230,74,25,0.1));padding:6px;border-radius:5px;text-align:center;border:1px solid rgba(255,87,34,0.3)">
                        <div style="font-size:18px;font-weight:700;color:#ff5722" id="depremCount">0</div>
                        <div style="font-size:8px;color:var(--text-dim);text-transform:uppercase">24 Saat</div>
                    </div>
                    <div style="flex:1;background:linear-gradient(135deg,rgba(211,47,47,0.15),rgba(183,28,28,0.1));padding:6px;border-radius:5px;text-align:center;border:1px solid rgba(211,47,47,0.3)">
                        <div style="font-size:18px;font-weight:700;color:#d32f2f" id="depremMax">-</div>
                        <div style="font-size:8px;color:var(--text-dim);text-transform:uppercase">Max</div>
                    </div>
                    <div style="flex:1;background:linear-gradient(135deg,rgba(255,152,0,0.15),rgba(245,124,0,0.1));padding:6px;border-radius:5px;text-align:center;border:1px solid rgba(255,152,0,0.3)">
                        <div style="font-size:18px;font-weight:700;color:#ff9800" id="depremSon">-</div>
                        <div style="font-size:8px;color:var(--text-dim);text-transform:uppercase">Son</div>
                    </div>
                </div>
                <div class="osint-results" id="depremList" style="display:block;max-height:160px;overflow-y:auto;border-radius:6px;background:var(--bg-card)">
                    <div style="color:var(--text-dim);text-align:center;padding:12px;font-size:10px">
                        <span style="font-size:20px;display:block;margin-bottom:4px;opacity:0.5">🌍</span>
                        Takibi başlatın
                    </div>
                </div>
            </div>

            <!-- ISS Tab -->
            <div class="osint-tab-content" id="aerospaceTabIss" style="display:none">
                <button onclick="issKonumGoster()" style="width:100%;padding:10px;background:linear-gradient(135deg,#1565c0,#0d47a1);border:none;border-radius:5px;cursor:pointer;font-size:11px;color:#fff;margin-bottom:10px;display:flex;align-items:center;justify-content:center;gap:6px">
                    <span style="font-size:16px">🛸</span><span>ISS Konumunu Göster</span>
                </button>
                <div id="issInfo" style="background:linear-gradient(135deg,rgba(0,229,255,0.1),rgba(0,180,255,0.05));padding:12px;border-radius:6px;margin-bottom:8px;border:1px solid rgba(0,229,255,0.2)">
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
                        <span style="font-size:28px">🛸</span>
                        <div>
                            <div style="font-size:12px;color:var(--hud-cyan);font-weight:600">Uluslararası Uzay İstasyonu</div>
                            <div style="font-size:9px;color:var(--text-dim)">408 km yükseklikte, 27.600 km/h</div>
                        </div>
                    </div>
                    <div style="display:flex;gap:8px;font-size:10px">
                        <div style="flex:1;background:var(--bg-card);padding:6px;border-radius:4px;text-align:center">
                            <div style="font-size:8px;color:var(--text-dim)">ENLEM</div>
                            <div id="issLat" style="color:var(--hud-green);font-weight:600">-</div>
                        </div>
                        <div style="flex:1;background:var(--bg-card);padding:6px;border-radius:4px;text-align:center">
                            <div style="font-size:8px;color:var(--text-dim)">BOYLAM</div>
                            <div id="issLng" style="color:var(--hud-green);font-weight:600">-</div>
                        </div>
                    </div>
                </div>
                <div id="issAstronauts" style="background:var(--bg-card);padding:10px;border-radius:6px">
                    <div style="font-size:10px;color:var(--text-dim);margin-bottom:6px;display:flex;align-items:center;gap:4px">
                        <span>👨‍🚀</span><span>Uzaydaki Astronotlar</span>
                    </div>
                    <div id="astronautList" style="font-size:10px;color:var(--text-normal);max-height:80px;overflow-y:auto">Yükleniyor...</div>
                </div>
            </div>

            <!-- Uydular Tab -->
            <div class="osint-tab-content" id="aerospaceTabUydular" style="display:none">
                <div style="display:flex;gap:6px;margin-bottom:10px">
                    <input type="text" id="noradId" placeholder="NORAD ID (ör: 25544)" style="flex:1;padding:8px 10px;background:var(--bg-void);border:1px solid var(--border-glow);color:var(--text-bright);border-radius:4px;font-size:11px">
                    <button onclick="uyduAra()" style="padding:8px 12px;background:var(--accent-primary);border:none;border-radius:4px;cursor:pointer;font-size:12px" title="Uydu Ara">🔍</button>
                </div>
                <button onclick="turksatGoster()" style="width:100%;padding:10px;background:linear-gradient(135deg,#c62828,#b71c1c);border:none;border-radius:5px;cursor:pointer;font-size:11px;color:#fff;display:flex;align-items:center;justify-content:center;gap:6px;margin-bottom:8px">
                    <span>🇹🇷</span><span>TÜRKSAT Uydularını Göster</span>
                </button>
                <div class="osint-results" id="satelliteResults" style="display:none;border-radius:6px;background:var(--bg-card)">
                    <div id="satelliteResultsContent"></div>
                </div>
            </div>

            <!-- Starlink Tab -->
            <div class="osint-tab-content" id="aerospaceTabStarlink" style="display:none">
                <div style="background:linear-gradient(135deg,rgba(255,193,7,0.1),rgba(255,152,0,0.05));padding:12px;border-radius:6px;margin-bottom:10px;text-align:center;border:1px solid rgba(255,193,7,0.2)">
                    <div style="display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:4px">
                        <span style="font-size:24px">⭐</span>
                        <div style="text-align:left">
                            <div style="font-size:13px;color:var(--hud-cyan);font-weight:600">Starlink Uydu Ağı</div>
                            <div style="font-size:9px;color:var(--text-dim)">SpaceX LEO Takımyıldızı</div>
                        </div>
                    </div>
                </div>
                <button onclick="starlinkGoster()" style="width:100%;padding:10px;background:linear-gradient(135deg,#6200ea,#3700b3);border:none;border-radius:5px;cursor:pointer;font-size:11px;color:#fff;display:flex;align-items:center;justify-content:center;gap:6px">
                    <span>⭐</span><span>Starlink Uydularını Göster</span>
                </button>
                <div style="font-size:10px;color:var(--text-dim);margin-top:8px;text-align:center">
                    Not: N2YO API anahtarı gerektirir
                </div>
            </div>
        </div>
    </div>

    <!-- Sag Panel - AI Chat -->
    <div class="ai-chat-panel" id="aiChatPanel">
        <div class="ai-chat-container" id="aiChatContainer">
            <div class="ai-chat-header">
                <span>TSUNAMI - Taktik Asistan</span>
                <button onclick="toggleAIChat()" style="background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:18px">&times;</button>
            </div>
            <div class="ai-chat-messages" id="aiMessages">
                <!-- Tsunami karsilama mesaji JavaScript ile ekleniyor -->
            </div>
            <div class="ai-chat-input">
                <button id="voiceBtn" class="voice-btn" onclick="toggleVoice()" title="Sesli Komut">◉</button>
                <input type="text" id="aiInput" placeholder="Bir şey sorun veya komut verin..." onkeydown="if(event.key==='Enter')sendAI()">
                <button onclick="sendAI()">▸</button>
                <button id="speakerBtn" class="speaker-btn" onclick="toggleSpeaker()" title="Sesli Yanıt">◭</button>
            </div>
            <div class="voice-indicator" id="voiceIndicator">
                <div class="voice-wave"></div>
                <span>Dinleniyor...</span>
            </div>
        </div>
    </div>

    <!-- Toast Container - Bildirimler icin -->
    <div class="toast-container"></div>

    <!-- AILYDIAN Agent Orchestrator Panel -->
    <div class="ailydian-panel" id="ailydianPanel">
        <!-- Durum Karti -->
        <div class="ailydian-card">
            <div class="ailydian-card-header">
                <span>AILYDIAN Durum</span>
                <span id="ailydianStatus" style="color:var(--hud-green)">●</span>
            </div>
            <div class="ailydian-card-body">
                <div class="ailydian-stats">
                    <div class="ailydian-stat"><div class="val" id="aStatAjan">0</div><div class="lbl">Ajan</div></div>
                    <div class="ailydian-stat"><div class="val" id="aStatAktif">0</div><div class="lbl">Aktif</div></div>
                    <div class="ailydian-stat"><div class="val" id="aStatGorev">0</div><div class="lbl">Görev</div></div>
                    <div class="ailydian-stat"><div class="val" id="aStatBellek">0</div><div class="lbl">Bellek</div></div>
                </div>
            </div>
        </div>

        <!-- Ajan Listesi -->
        <div class="ailydian-card">
            <div class="ailydian-card-header">
                <span>Ajanlar</span>
                <button class="ailydian-btn ailydian-btn-sm" onclick="yenileAjanlar()">↻</button>
            </div>
            <div class="ailydian-card-body">
                <div class="kategori-filtre" id="kategoriFiltre"></div>
                <div id="ajanListesi"></div>
            </div>
        </div>

        <!-- Aktif Gorevler -->
        <div class="ailydian-card">
            <div class="ailydian-card-header">
                <span>Aktif Görevler</span>
                <span id="gorevSayisi" style="font-size:9px;color:var(--text-dim)">0</span>
            </div>
            <div class="ailydian-card-body">
                <div id="gorevListesi"></div>
                <div class="ailydian-input-row">
                    <input type="text" class="ailydian-input" id="yeniGorevInput" placeholder="Yeni görev açıklaması...">
                    <button class="ailydian-btn" onclick="yeniGorevOlustur()">+</button>
                </div>
            </div>
        </div>

        <!-- AI Sorgu -->
        <div class="ailydian-card">
            <div class="ailydian-card-header">
                <span>AI Sorgu Motoru</span>
            </div>
            <div class="ailydian-card-body">
                <div class="ailydian-input-row" style="margin:0">
                    <input type="text" class="ailydian-input" id="ailydianSorguInput"
                           placeholder="Doğal dil ile komut verin..."
                           onkeydown="if(event.key==='Enter')ailydianSorguGonder()">
                    <button class="ailydian-btn" onclick="ailydianSorguGonder()">▸</button>
                </div>
                <div id="ailydianSorguSonuc" style="margin-top:8px;font-size:10px;color:var(--text-dim);max-height:80px;overflow-y:auto"></div>
            </div>
        </div>
    </div>

    <!-- Lejant -->
    <div class="legend" id="mainLegend">
        <h4>Gösterge</h4>
        <div class="leg-section">
            <div class="leg-item"><span class="dot" style="background:var(--hud-cyan);box-shadow:0 0 8px var(--hud-cyan)"></span>WiFi</div>
            <div class="leg-item"><span class="dot" style="background:var(--accent-purple);box-shadow:0 0 8px var(--accent-purple)"></span>Bluetooth</div>
            <div class="leg-item"><span class="dot" style="background:var(--hud-green);box-shadow:0 0 8px var(--hud-green)"></span>Baz İstasyonu</div>
            <div class="leg-item"><span class="dot" style="background:var(--accent-danger);box-shadow:0 0 8px var(--accent-danger)"></span>Saldırı</div>
        </div>
        <div class="leg-divider"></div>
        <h4 class="leg-toggle" onclick="toggleKritikLegend()">Kritik Altyapı <span id="kritikArrow">▾</span></h4>
        <div class="leg-section kritik-legend" id="kritikLegend">
            <div class="leg-item"><span class="dot kritik-dot">☢</span>Nükleer</div>
            <div class="leg-item"><span class="dot kritik-dot" style="background:#ff6600">🏭</span>Termik</div>
            <div class="leg-item"><span class="dot kritik-dot" style="background:#0099ff">💧</span>Hidroelektrik</div>
            <div class="leg-item"><span class="dot kritik-dot" style="background:#ffcc00">🔥</span>Doğalgaz</div>
            <div class="leg-item"><span class="dot kritik-dot" style="background:#00ff88">📡</span>İletişim</div>
            <div class="leg-item"><span class="dot kritik-dot" style="background:#8855ff">🖥</span>Veri Merkezi</div>
            <div class="leg-item"><span class="dot kritik-dot" style="background:#00ccff">✈</span>Havalimanı</div>
            <div class="leg-item"><span class="dot kritik-dot" style="background:#ff9900">🚇</span>Tünel</div>
            <div class="leg-item"><span class="dot kritik-dot" style="background:#cc6600">🌉</span>Köprü</div>
            <div class="leg-item"><span class="dot kritik-dot" style="background:#0088cc">⚓</span>Liman</div>
            <div class="leg-item"><span class="dot kritik-dot" style="background:#00ff00">💰</span>Finans</div>
            <div class="leg-item"><span class="dot kritik-dot" style="background:#00cc66">🏦</span>Banka</div>
            <div class="leg-item"><span class="dot kritik-dot" style="background:#ff6699">🏥</span>Hastane</div>
            <div class="leg-item"><span class="dot kritik-dot" style="background:#9966ff">🎓</span>Üniversite</div>
            <div class="leg-item"><span class="dot kritik-dot" style="background:#66ccff">🔬</span>Araştırma</div>
            <div class="leg-item"><span class="dot kritik-dot" style="background:#ff3355">🎯</span>Askeri</div>
            <div class="leg-item"><span class="dot kritik-dot" style="background:#0066ff">🌊</span>Su Kaynağı</div>
            <div class="leg-item"><span class="dot kritik-dot" style="background:#ff00ff">🔒</span>Siber Güvenlik</div>
            <div class="leg-item"><span class="dot kritik-dot" style="background:#ffcc33">🏛</span>Hükümet</div>
        </div>
        <div class="leg-divider"></div>
        <div class="leg-stats">
            <div class="leg-stat-item"><span class="leg-stat-num" id="legendKritikCount">0</span><span class="leg-stat-label">Kritik Nokta</span></div>
        </div>
        <div class="leg-divider"></div>
    </div>

    <!-- Geo Analiz Panel (Sol widget'tan erişilir) -->
    <div class="geo-panel" id="geoPanel">
        <h4>
            🗺️ Coğrafi Analiz
            <span class="close-btn" onclick="toggleGeoPanel()">✕</span>
        </h4>

        <div class="geo-layer-toggle" onclick="toggleGeoLayer('ilSinirlari', event)">
            <input type="checkbox" id="layerIlSinirlari" onclick="event.stopPropagation()">
            <label onclick="event.stopPropagation(); toggleGeoLayer('ilSinirlari', event)">İl Sınırları (81 İl)</label>
        </div>

        <div class="geo-layer-toggle" onclick="toggleGeoLayer('hotspot', event)">
            <input type="checkbox" id="layerHotspot" onclick="event.stopPropagation()">
            <label onclick="event.stopPropagation(); toggleGeoLayer('hotspot', event)">Saldırı Hotspot'ları</label>
        </div>

        <div class="geo-layer-toggle" onclick="toggleGeoLayer('riskHarita', event)">
            <input type="checkbox" id="layerRiskHarita" onclick="event.stopPropagation()">
            <label onclick="event.stopPropagation(); toggleGeoLayer('riskHarita', event)">Risk Haritası</label>
        </div>

        <div class="geo-layer-toggle" onclick="toggleGeoLayer('clustering', event)">
            <input type="checkbox" id="layerClustering" onclick="event.stopPropagation()">
            <label onclick="event.stopPropagation(); toggleGeoLayer('clustering', event)">Saldırı Kümeleme</label>
        </div>

        <div class="geo-stats">
            <div class="geo-stat-row">
                <span class="label">Toplam İl:</span>
                <span class="value" id="geoIlCount">81</span>
            </div>
            <div class="geo-stat-row">
                <span class="label">Kayıtlı Saldırı:</span>
                <span class="value" id="geoSaldiriCount">0</span>
            </div>
            <div class="geo-stat-row">
                <span class="label">Hotspot Sayısı:</span>
                <span class="value" id="geoHotspotCount">0</span>
            </div>
            <div class="geo-stat-row">
                <span class="label">En Riskli İl:</span>
                <span class="value" id="geoEnRiskliIl">-</span>
            </div>
        </div>

        <button class="geo-btn" onclick="geoAnalizGuncelle()">🔄 Analizi Güncelle</button>
        <button class="geo-btn" onclick="geoTehlikeliBolgeler()">⚠️ Tehlikeli Bölgeler</button>

        <div style="margin-top:15px;padding-top:12px;border-top:1px solid var(--border-subtle)">
            <div style="font-size:11px;color:var(--text-dim);margin-bottom:8px">🌤️ Hava Durumu</div>
            <select id="geoHavaIl" onchange="geoHavaDurumuGoster()" style="width:100%;padding:8px;background:var(--bg-void);border:1px solid var(--border-glow);color:var(--text-bright);border-radius:6px;font-size:11px">
                <option value="">İl Seçin</option>
                <option value="İstanbul">İstanbul</option>
                <option value="Ankara">Ankara</option>
                <option value="İzmir">İzmir</option>
                <option value="Antalya">Antalya</option>
                <option value="Bursa">Bursa</option>
                <option value="Adana">Adana</option>
                <option value="Konya">Konya</option>
                <option value="Gaziantep">Gaziantep</option>
                <option value="Diyarbakır">Diyarbakır</option>
                <option value="Trabzon">Trabzon</option>
                <option value="Samsun">Samsun</option>
                <option value="Erzurum">Erzurum</option>
                <option value="Van">Van</option>
            </select>
            <div id="geoHavaContainer" style="margin-top:10px"></div>
        </div>
    </div>

    <!-- ==================== MÜDAHAlE KONTROL PANELİ ==================== -->
    <div class="intervention-trigger" id="interventionTrigger" onclick="toggleInterventionPanel()" title="Aktif Savunma Merkezi">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>
    </div>

    <div class="intervention-panel" id="interventionPanel">
        <div class="intervention-header">
            <h3>
                <svg style="width:16px;height:16px;fill:#ff0066;margin-right:8px" viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>
                AKTİF SAVUNMA
            </h3>
            <button class="intervention-close" onclick="toggleInterventionPanel()">
                <svg style="width:14px;height:14px;fill:currentColor" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
            </button>
        </div>

        <div class="intervention-body">
            <!-- DNS Sinkhole Modülü -->
            <div class="intervention-module" id="modSinkhole">
                <div class="intervention-module-header" onclick="toggleInterventionModule('sinkhole')">
                    <div class="intervention-module-title">
                        <div class="intervention-module-icon" style="background:linear-gradient(135deg,#ff3355,#ff6600)">
                            <svg style="width:14px;height:14px;fill:#fff" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zM4 12c0-4.42 3.58-8 8-8 1.85 0 3.55.63 4.9 1.69L5.69 16.9C4.63 15.55 4 13.85 4 12zm8 8c-1.85 0-3.55-.63-4.9-1.69L18.31 7.1C19.37 8.45 20 10.15 20 12c0 4.42-3.58 8-8 8z"/></svg>
                        </div>
                        <span>DNS Sinkhole</span>
                    </div>
                    <div class="intervention-toggle" id="toggleSinkhole" onclick="event.stopPropagation();toggleInterventionLayer('sinkhole')"></div>
                </div>
                <div class="intervention-stats">
                    <div class="intervention-stat-row"><span>Engellenen Domain</span><span class="value" id="statSinkholeBlocked">0</span></div>
                    <div class="intervention-stat-row"><span>DGA Tespit</span><span class="value" id="statSinkholeDGA">0</span></div>
                    <div class="intervention-stat-row"><span>C2 Engellenen</span><span class="value" id="statSinkholeC2">0</span></div>
                </div>
            </div>

            <!-- Honeypot Modülü -->
            <div class="intervention-module" id="modHoneypot">
                <div class="intervention-module-header" onclick="toggleInterventionModule('honeypot')">
                    <div class="intervention-module-title">
                        <div class="intervention-module-icon" style="background:linear-gradient(135deg,#ffcc00,#ff9900)">
                            <svg style="width:14px;height:14px;fill:#fff" viewBox="0 0 24 24"><path d="M12 3c-1.27 0-2.4.8-2.82 2H3v2h1.95L2 14c-.47 2 1 3 3.5 3s4.06-1 3.5-3L6.05 7h3.12c.33.85 1.01 1.53 1.83 1.83V20H9v2h6v-2h-2V8.82c.82-.3 1.5-.97 1.83-1.82h3.12L15 14c-.47 2 1 3 3.5 3s4.06-1 3.5-3l-2.95-7H21V5h-6.18C14.4 3.8 13.27 3 12 3z"/></svg>
                        </div>
                        <span>Deception System</span>
                    </div>
                    <div class="intervention-toggle" id="toggleHoneypot" onclick="event.stopPropagation();toggleInterventionLayer('honeypot')"></div>
                </div>
                <div class="intervention-stats">
                    <div class="intervention-stat-row"><span>Aktif Trap</span><span class="value" id="statHoneypotActive">0</span></div>
                    <div class="intervention-stat-row"><span>Yakalanan</span><span class="value" id="statHoneypotAccess">0</span></div>
                    <div class="intervention-stat-row"><span>Tehdit Aktör</span><span class="value" id="statHoneypotAttackers">0</span></div>
                </div>
            </div>

            <!-- Threat Hunter Modülü -->
            <div class="intervention-module" id="modHunter">
                <div class="intervention-module-header" onclick="toggleInterventionModule('hunter')">
                    <div class="intervention-module-title">
                        <div class="intervention-module-icon" style="background:linear-gradient(135deg,#00ff88,#00ccff)">
                            <svg style="width:14px;height:14px;fill:#fff" viewBox="0 0 24 24"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/></svg>
                        </div>
                        <span>AI Threat Hunter</span>
                    </div>
                    <div class="intervention-toggle" id="toggleHunter" onclick="event.stopPropagation();toggleInterventionLayer('hunter')"></div>
                </div>
                <div class="intervention-stats">
                    <div class="intervention-stat-row"><span>Aktif IOC</span><span class="value" id="statHunterThreats">0</span></div>
                    <div class="intervention-stat-row"><span>Anomali</span><span class="value" id="statHunterAnomalies">0</span></div>
                    <div class="intervention-stat-row"><span>ATT&CK</span><span class="value" id="statHunterMitre">0%</span></div>
                </div>
            </div>

            <!-- Wireless IDS Modülü -->
            <div class="intervention-module" id="modWireless">
                <div class="intervention-module-header" onclick="toggleInterventionModule('wireless')">
                    <div class="intervention-module-title">
                        <div class="intervention-module-icon" style="background:linear-gradient(135deg,#8855ff,#00ccff)">
                            <svg style="width:14px;height:14px;fill:#fff" viewBox="0 0 24 24"><path d="M1 9l2 2c4.97-4.97 13.03-4.97 18 0l2-2C16.93 2.93 7.08 2.93 1 9zm8 8l3 3 3-3c-1.65-1.66-4.34-1.66-6 0zm-4-4l2 2c2.76-2.76 7.24-2.76 10 0l2-2C15.14 9.14 8.87 9.14 5 13z"/></svg>
                        </div>
                        <span>Wireless Defense</span>
                    </div>
                    <div class="intervention-toggle" id="toggleWireless" onclick="event.stopPropagation();toggleInterventionLayer('wireless')"></div>
                </div>
                <div class="intervention-stats">
                    <div class="intervention-stat-row"><span>Rogue AP</span><span class="value" id="statWirelessRogue">0</span></div>
                    <div class="intervention-stat-row"><span>Evil Twin</span><span class="value" id="statWirelessEvil">0</span></div>
                    <div class="intervention-stat-row"><span>Signatures</span><span class="value" id="statWirelessSigs">13</span></div>
                </div>
            </div>

            <!-- Federated Intelligence Modülü -->
            <div class="intervention-module" id="modFederated">
                <div class="intervention-module-header" onclick="toggleInterventionModule('federated')">
                    <div class="intervention-module-title">
                        <div class="intervention-module-icon" style="background:linear-gradient(135deg,#00ff88,#8855ff)">
                            <svg style="width:14px;height:14px;fill:#fff" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                        </div>
                        <span>Federated Intel</span>
                    </div>
                    <div class="intervention-toggle" id="toggleFederated" onclick="event.stopPropagation();toggleInterventionLayer('federated')"></div>
                </div>
                <div class="intervention-stats">
                    <div class="intervention-stat-row"><span>Peers</span><span class="value" id="statFederatedPeers">0</span></div>
                    <div class="intervention-stat-row"><span>Shared IOC</span><span class="value" id="statFederatedShared">0</span></div>
                    <div class="intervention-stat-row"><span>Received</span><span class="value" id="statFederatedReceived">0</span></div>
                </div>
            </div>

            <!-- SOC Komuta Merkezi -->
            <div class="intervention-module" id="modSOC">
                <div class="intervention-module-header" onclick="toggleInterventionModule('soc')">
                    <div class="intervention-module-title">
                        <div class="intervention-module-icon" style="background:linear-gradient(135deg,#ff0064,#a020f0)">
                            <svg style="width:14px;height:14px;fill:#fff" viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-1 15h2v2h-2v-2zm0-8h2v6h-2V8z"/></svg>
                        </div>
                        <span>SOC Merkezi</span>
                    </div>
                    <div class="intervention-toggle" id="toggleSOC" onclick="event.stopPropagation();toggleFlyout('soc')"></div>
                </div>
                <div class="intervention-stats">
                    <div class="intervention-stat-row"><span>Aktif Alarm</span><span class="value" id="statSOCActive">0</span></div>
                    <div class="intervention-stat-row"><span>Kritik</span><span class="value" id="statSOCCritical" style="color:#ff1744;">0</span></div>
                    <div class="intervention-stat-row"><span>SLA İhlali</span><span class="value" id="statSOCSLA" style="color:#ff6d00;">0</span></div>
                </div>
            </div>

            <!-- SOAR Actions -->
            <div class="intervention-module" id="modSOAR">
                <div class="intervention-module-header" onclick="toggleInterventionModule('soar')">
                    <div class="intervention-module-title">
                        <div class="intervention-module-icon" style="background:linear-gradient(135deg,#ff0066,#ff6600)">
                            <svg style="width:14px;height:14px;fill:#fff" viewBox="0 0 24 24"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg>
                        </div>
                        <span>SOAR Actions</span>
                    </div>
                    <div class="intervention-toggle" id="toggleSOAR" onclick="event.stopPropagation();toggleSOARPanel()"></div>
                </div>
                <div class="intervention-stats">
                    <div class="intervention-stat-row"><span>Playbooks</span><span class="value" id="statSOARPlaybooks">31</span></div>
                    <div class="intervention-stat-row"><span>Executed</span><span class="value" id="statSOARExecuted">0</span></div>
                    <div class="intervention-stat-row"><span>Pending</span><span class="value" id="statSOARPending">0</span></div>
                </div>
            </div>
        </div>

        <!-- NLP Sorgu Alanı -->
        <div class="intervention-nlp">
            <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
                <svg style="width:14px;height:14px;fill:var(--text-dim)" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                <span style="font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px">Türkçe NLP Sorgu</span>
            </div>
            <textarea class="intervention-nlp-input" id="nlpQueryInput" rows="2" placeholder="Sorgu yazın... (örn: son 24 saatteki kritik tehditleri analiz et)"></textarea>
            <button class="intervention-nlp-btn" onclick="executeNLPQuery()">
                <svg style="width:12px;height:12px;fill:currentColor;margin-right:6px" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                EXECUTE
            </button>
            <div id="nlpQueryResult" style="margin-top:8px;font-size:10px;color:var(--text-dim);max-height:60px;overflow-y:auto"></div>
        </div>

        <!-- Encryption Status -->
        <div style="padding:8px 12px;border-top:1px solid rgba(255,255,255,0.05);display:flex;align-items:center;gap:8px;font-size:9px;color:var(--text-dim)">
            <svg style="width:12px;height:12px;fill:#00ff88" viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg>
            <span>AES-256-GCM + RSA-4096 | FIPS 140-2</span>
        </div>
    </div>

    <!-- ==================== EAGLE EYE COMMAND CENTER ==================== -->
    <div class="eagle-command-center" id="eagleCommandCenter" style="display:none">
        <!-- Ana Başlık -->
        <div class="eagle-header">
            <div class="eagle-title">
                <span class="eagle-icon">🦅</span>
                <span class="eagle-text">KARTAL GÖZÜ</span>
                <span class="eagle-subtitle">GLOBAL İZLEME MERKEZİ</span>
            </div>
            <div class="eagle-status">
                <span class="eagle-live-indicator"></span>
                <span>CANLI</span>
            </div>
            <button class="eagle-close" onclick="toggleEagleCenter()">✕</button>
        </div>

        <!-- Global Arama Çubuğu -->
        <div class="eagle-search-bar">
            <input type="text" id="eagleSearchInput" placeholder="🔍 Dünya genelinde ara... (Türkçe destekli: istanbul, almanya, tokyo...)" onkeypress="if(event.key==='Enter')eagleSearch()">
            <button onclick="eagleSearch()">ARA</button>
        </div>

        <!-- Tab Sistemi -->
        <div class="eagle-tabs">
            <button class="eagle-tab active" onclick="eagleTabSwitch('live')">🔴 CANLI</button>
            <button class="eagle-tab" onclick="eagleTabSwitch('alerts')">⚠️ UYARILAR</button>
            <button class="eagle-tab" onclick="eagleTabSwitch('layers')">🗺️ KATMANLAR</button>
            <button class="eagle-tab" onclick="eagleTabSwitch('osint')">🔍 OSINT</button>
            <button class="eagle-tab" onclick="eagleTabSwitch('tools')">🧰 ARAÇLAR</button>
        </div>

        <!-- CANLI Tab -->
        <div class="eagle-tab-content active" id="eagleTabLive">
            <!-- Canlı İstatistikler -->
            <div class="eagle-live-stats">
                <div class="eagle-stat critical">
                    <span class="stat-icon">🌋</span>
                    <span class="stat-value" id="eagleDepremCount">-</span>
                    <span class="stat-label">Deprem (24s)</span>
                </div>
                <div class="eagle-stat warning">
                    <span class="stat-icon">🔥</span>
                    <span class="stat-value" id="eagleYanginCount">-</span>
                    <span class="stat-label">Aktif Yangın</span>
                </div>
                <div class="eagle-stat info">
                    <span class="stat-icon">✈️</span>
                    <span class="stat-value" id="eagleUcakCount">-</span>
                    <span class="stat-label">Uçak Takip</span>
                </div>
                <div class="eagle-stat danger">
                    <span class="stat-icon">⚡</span>
                    <span class="stat-value" id="eagleTehditCount">-</span>
                    <span class="stat-label">Tehdit</span>
                </div>
            </div>

            <!-- Canlı Feed -->
            <div class="eagle-feed-header">
                <span>📡 CANLI AKIŞ</span>
                <button onclick="eagleRefreshFeed()" style="background:transparent;border:none;color:var(--accent-cyan);cursor:pointer;font-size:12px">↻</button>
            </div>
            <div class="eagle-live-feed" id="eagleLiveFeed">
                <div class="eagle-feed-item loading">Canlı veriler yükleniyor...</div>
            </div>
        </div>

        <!-- UYARILAR Tab -->
        <div class="eagle-tab-content" id="eagleTabAlerts">
            <div class="eagle-alert-filters">
                <select id="eagleAlertPriority" onchange="eagleFilterAlerts()">
                    <option value="">Tüm Öncelikler</option>
                    <option value="CRITICAL">🔴 Kritik</option>
                    <option value="HIGH">🟠 Yüksek</option>
                    <option value="MEDIUM">🟡 Orta</option>
                    <option value="LOW">🔵 Düşük</option>
                </select>
                <select id="eagleAlertType" onchange="eagleFilterAlerts()">
                    <option value="">Tüm Tipler</option>
                    <option value="earthquake">🌋 Deprem</option>
                    <option value="fire">🔥 Yangın</option>
                    <option value="cyber_attack">💻 Siber Saldırı</option>
                    <option value="aircraft">✈️ Hava Trafiği</option>
                    <option value="threat">⚠️ Tehdit</option>
                </select>
            </div>
            <div class="eagle-alerts-list" id="eagleAlertsList"></div>
        </div>

        <!-- KATMANLAR Tab -->
        <div class="eagle-tab-content" id="eagleTabLayers">
            <div class="eagle-layer-section">
                <div class="eagle-section-title">⚡ KRİTİK ALTYAPI (OpenInfraMap)</div>
                <div class="eagle-layer-toggle" onclick="toggleInfraLayer('power')">
                    <input type="checkbox" id="layerPower"><label>⚡ Elektrik Şebekesi</label>
                </div>
                <div class="eagle-layer-toggle" onclick="toggleInfraLayer('telecoms')">
                    <input type="checkbox" id="layerTelecoms"><label>📡 Telekomünikasyon</label>
                </div>
                <div class="eagle-layer-toggle" onclick="toggleInfraLayer('petroleum')">
                    <input type="checkbox" id="layerPetroleum"><label>🛢️ Petrol/Gaz Hatları</label>
                </div>
                <div class="eagle-layer-toggle" onclick="toggleInfraLayer('water')">
                    <input type="checkbox" id="layerWater"><label>💧 Su Altyapısı</label>
                </div>
            </div>

            <div class="eagle-layer-section">
                <div class="eagle-section-title">🛣️ ŞEHİR YOLLARI (city-roads)</div>
                <div style="display:flex;gap:6px;margin-bottom:8px">
                    <input type="text" id="cityRoadsInput" placeholder="Şehir adı (Türkçe)" style="flex:1;padding:8px;background:var(--bg-void);border:1px solid var(--border-glow);color:var(--text-bright);border-radius:4px;font-size:11px">
                </div>
                <button class="eagle-btn" onclick="loadCityRoads()">🗺️ Yol Ağını Yükle</button>
            </div>

            <div class="eagle-layer-section">
                <div class="eagle-section-title">🌍 CANLI İZLEME</div>
                <div class="eagle-layer-toggle" onclick="toggleEagleLayer('earthquakes')">
                    <input type="checkbox" id="layerEarthquakes"><label>🌋 Canlı Depremler</label>
                </div>
                <div class="eagle-layer-toggle" onclick="toggleEagleLayer('fires')">
                    <input type="checkbox" id="layerFires"><label>🔥 Aktif Yangınlar</label>
                </div>
                <div class="eagle-layer-toggle" onclick="toggleEagleLayer('aircraft')">
                    <input type="checkbox" id="layerAircraft"><label>✈️ Uçuş Takibi</label>
                </div>
            </div>
        </div>

        <!-- OSINT Tab - Türkçe Doğal Dil Arayüzü -->
        <div class="eagle-tab-content" id="eagleTabOsint">
            <!-- Ana OSINT Giriş -->
            <div style="background:linear-gradient(135deg,rgba(255,102,0,0.15),rgba(255,51,85,0.08));border:1px solid rgba(255,102,0,0.4);border-radius:8px;padding:12px;margin-bottom:12px">
                <div style="color:#ff6600;font-weight:bold;font-size:12px;margin-bottom:8px;display:flex;align-items:center;gap:6px">
                    <span style="font-size:18px">🎯</span>
                    TÜRKÇE OSINT KOMUTA - TÜM ARAÇLAR OTOMATİK
                </div>
                <div style="color:#aaa;font-size:10px;margin-bottom:10px">
                    Türkçe yazın, 614+ araç otomatik çalışır. Ultra gizlilik aktif.
                </div>
                <div style="display:flex;gap:6px">
                    <input type="text" id="osintOrchestratorInput"
                        placeholder="Ne araştırmak istiyorsunuz? Örn: 8.8.8.8 ip adresini araştır"
                        style="flex:1;padding:12px;background:rgba(0,0,0,0.4);border:2px solid rgba(255,102,0,0.5);color:#fff;border-radius:6px;font-size:13px"
                        onkeypress="if(event.key==='Enter')runOsintOrchestrator()">
                    <button onclick="runOsintOrchestrator()" style="padding:12px 20px;background:linear-gradient(135deg,#ff6600,#ff3355);border:none;color:white;border-radius:6px;cursor:pointer;font-weight:bold;font-size:12px;text-transform:uppercase;letter-spacing:1px">
                        🚀 ARAŞTIR
                    </button>
                </div>
                <!-- Hızlı Etiketler -->
                <div style="display:flex;gap:4px;margin-top:10px;flex-wrap:wrap">
                    <span onclick="setOsintExample('8.8.8.8 ip adresini araştır')" style="padding:4px 8px;background:rgba(255,102,0,0.2);border:1px solid rgba(255,102,0,0.4);border-radius:12px;color:#ff9800;font-size:9px;cursor:pointer">🌐 IP Örnek</span>
                    <span onclick="setOsintExample('google.com domain bilgilerini bul')" style="padding:4px 8px;background:rgba(0,188,212,0.2);border:1px solid rgba(0,188,212,0.4);border-radius:12px;color:#00bcd4;font-size:9px;cursor:pointer">🔗 Domain</span>
                    <span onclick="setOsintExample('test@gmail.com email sızıntı kontrolü')" style="padding:4px 8px;background:rgba(156,39,176,0.2);border:1px solid rgba(156,39,176,0.4);border-radius:12px;color:#9c27b0;font-size:9px;cursor:pointer">📧 Email</span>
                    <span onclick="setOsintExample('johndoe kullanıcı adını tüm platformlarda ara')" style="padding:4px 8px;background:rgba(0,255,136,0.2);border:1px solid rgba(0,255,136,0.4);border-radius:12px;color:#00ff88;font-size:9px;cursor:pointer">👤 Username</span>
                </div>
            </div>

            <!-- Durum Göstergeleri -->
            <div style="display:flex;gap:6px;margin-bottom:12px">
                <div style="flex:1;background:rgba(0,255,136,0.1);border:1px solid rgba(0,255,136,0.3);border-radius:6px;padding:8px;text-align:center">
                    <div style="color:#00ff88;font-size:9px">🛡️ GİZLİLİK</div>
                    <div style="color:#00ff88;font-weight:bold;font-size:11px">PHANTOM</div>
                </div>
                <div style="flex:1;background:rgba(255,102,0,0.1);border:1px solid rgba(255,102,0,0.3);border-radius:6px;padding:8px;text-align:center">
                    <div style="color:#ff6600;font-size:9px">🔧 ARAÇ</div>
                    <div style="color:#ff6600;font-weight:bold;font-size:11px">614+</div>
                </div>
                <div style="flex:1;background:rgba(0,188,212,0.1);border:1px solid rgba(0,188,212,0.3);border-radius:6px;padding:8px;text-align:center">
                    <div style="color:#00bcd4;font-size:9px">🌐 API</div>
                    <div style="color:#00bcd4;font-weight:bold;font-size:11px">102+</div>
                </div>
            </div>

            <!-- Sonuçlar Alanı -->
            <div id="osintOrchestratorResults" style="display:none;background:rgba(0,20,30,0.8);border:1px solid var(--border-glow);border-radius:8px;padding:12px;max-height:280px;overflow-y:auto"></div>

            <!-- Ek Araçlar -->
            <details style="margin-top:10px">
                <summary style="color:#666;font-size:9px;cursor:pointer;padding:4px">📋 Ek Araçlar (Pastebin, Ülke OSINT)</summary>
                <div style="margin-top:8px;padding:8px;background:rgba(0,0,0,0.2);border-radius:6px">
                    <input type="text" id="pastebinQuery" placeholder="Pastebin arama..." style="width:100%;padding:8px;background:var(--bg-void);border:1px solid var(--border-glow);color:var(--text-bright);border-radius:4px;font-size:10px;margin-bottom:6px">
                    <button class="eagle-btn" onclick="searchPastebins()" style="width:100%;padding:6px;font-size:10px">🔎 49 Sitede Ara</button>

                    <select id="countryOsintSelect" onchange="loadCountryOsint()" style="width:100%;padding:8px;background:var(--bg-void);border:1px solid var(--border-glow);color:var(--text-bright);border-radius:4px;font-size:10px;margin-top:8px">
                        <option value="">🏳️ Ülke Seçin (193)</option>
                    </select>
                    <div id="countryOsintLinks" style="max-height:100px;overflow-y:auto;margin-top:6px"></div>
                </div>
            </details>

            <div id="eagleOsintResults" style="display:none;margin-top:12px"></div>
            <div id="eagleOsintTarget" style="display:none"></div>
        </div>

        <!-- ARAÇLAR Tab -->
        <div class="eagle-tab-content" id="eagleTabTools">
            <div class="eagle-section-title">🧰 OSINT ARAÇ VERİTABANI (614+ Entegre)</div>
            <div style="color:#888;font-size:9px;margin-bottom:8px">Tüm araçlar OSINT sekmesinde Türkçe komutla otomatik çalışır</div>
            <select id="osintToolCategory" onchange="loadOsintTools()" style="width:100%;padding:8px;background:var(--bg-void);border:1px solid var(--border-glow);color:var(--text-bright);border-radius:4px;font-size:11px;margin-bottom:8px">
                <option value="">Kategori Seçin</option>
            </select>
            <div id="osintToolsList" style="max-height:250px;overflow-y:auto"></div>
        </div>

        <!-- Alt Durum Çubuğu -->
        <div class="eagle-footer">
            <div class="eagle-footer-stat">
                <span>🌐</span> <span id="eagleApiCount">102</span> API
            </div>
            <div class="eagle-footer-stat">
                <span>🏳️</span> <span id="eagleCountryCount">193</span> Ülke
            </div>
            <div class="eagle-footer-stat">
                <span>🧰</span> <span id="eagleToolCount">614</span> Araç
            </div>
            <div class="eagle-footer-stat">
                <span>📋</span> <span id="eaglePastebinCount">49</span> Pastebin
            </div>
        </div>
    </div>

    <!-- ==================== YENİ POPUP PANELLER ==================== -->

    <!-- AILYDIAN Agent Orchestrator Popup -->
    <div class="cockpit-modal ailydian-modal" id="ailydianPopup">
        <div class="cockpit-header">
            <h3><svg width="18" height="18" viewBox="0 0 24 24" fill="#00ff88" style="vertical-align:middle;margin-right:6px;animation:lydianGlow 2s ease-in-out infinite"><path d="M13 10V3L4 14h7v7l9-11h-7z"/></svg> AILYDIAN AGENT ORCHESTRATOR</h3>
            <span style="color:var(--text-dim);font-size:10px">214 Agent | 36 Core | 23 PAI</span>
            <button class="close-btn" onclick="ailydianPopupKapat()">&times;</button>
        </div>
        <div class="cockpit-tabs">
            <button class="cockpit-tab active" onclick="ailydianTabDegistir('agents')"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/><circle cx="8" cy="10" r="1.5"/><circle cx="16" cy="10" r="1.5"/><path d="M12 17.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/></svg> Agents</button>
            <button class="cockpit-tab" onclick="ailydianTabDegistir('query')"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg> Query</button>
            <button class="cockpit-tab" onclick="ailydianTabDegistir('recon')"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg> Recon</button>
            <button class="cockpit-tab" onclick="ailydianTabDegistir('redteam')"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M6.92 5.51l-1.4 1.4c-.12.12-.29.19-.46.19H3.59c-.89 0-1.34 1.08-.71 1.71l1.41 1.41-4.24 4.24 7.07 7.07 4.24-4.24 1.41 1.41c.63.63 1.71.18 1.71-.71V14.5c0-.17.07-.34.19-.46l1.4-1.4c.63-.63.18-1.71-.71-1.71h-2.83l-5.66-5.66c-.63-.63-1.71-.18-1.71.71v.47z"/></svg> RedTeam</button>
            <button class="cockpit-tab" onclick="ailydianTabDegistir('osint')"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/></svg> OSINT</button>
        </div>
        <div class="cockpit-body">
            <!-- Agents Tab -->
            <div class="cockpit-tab-content active" id="ailydianTabAgents">
                <div class="agent-grid" id="ailydianAgentGrid">
                    <div style="text-align:center;color:var(--text-dim);grid-column:span 2">Yükleniyor...</div>
                </div>
            </div>
            <!-- Query Tab -->
            <div class="cockpit-tab-content" id="ailydianTabQuery">
                <!-- Seçili Agent Göstergesi -->
                <div id="selectedAgentInfo" style="display:none;padding:12px;background:linear-gradient(135deg,rgba(0,255,136,0.1),rgba(0,180,255,0.05));border:1px solid var(--hud-green);border-radius:8px;margin-bottom:12px">
                    <div style="display:flex;align-items:center;gap:10px">
                        <div id="selectedAgentIcon" style="font-size:24px"></div>
                        <div>
                            <div id="selectedAgentName" style="color:var(--hud-green);font-weight:600;font-size:12px"></div>
                            <div id="selectedAgentType" style="color:var(--text-dim);font-size:10px"></div>
                        </div>
                        <button onclick="clearSelectedAgent()" style="margin-left:auto;background:transparent;border:1px solid var(--accent-danger);color:var(--accent-danger);padding:4px 8px;border-radius:4px;cursor:pointer;font-size:10px">Temizle</button>
                    </div>
                </div>
                <input type="text" class="cockpit-input" id="ailydianQueryInput" placeholder="Agent'a görev verin veya soru sorun...">
                <button class="cockpit-btn" onclick="ailydianSorgula()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="vertical-align:middle;margin-right:4px"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                    Gönder
                </button>
                <div id="ailydianQueryResult" style="margin-top:15px;padding:10px;background:var(--bg-card);border-radius:6px;display:none"></div>
            </div>
            <!-- Recon Tab -->
            <div class="cockpit-tab-content" id="ailydianTabRecon">
                <input type="text" class="cockpit-input" id="reconTargetInput" placeholder="Hedef (domain/IP)">
                <select class="cockpit-input" id="reconTypeSelect">
                    <option value="passive">Pasif Keşif</option>
                    <option value="active">Aktif Keşif (Yetki Gerekli)</option>
                </select>
                <button class="cockpit-btn" onclick="startReconScan()">🔍 Keşif Başlat</button>
                <div id="reconResults" style="margin-top:15px;display:none"></div>
            </div>
            <!-- RedTeam Tab -->
            <div class="cockpit-tab-content" id="ailydianTabRedteam">
                <div style="padding:10px;background:var(--bg-card);border-radius:6px;margin-bottom:10px">
                    <div style="font-size:11px;margin-bottom:5px">32 Paralel Agent ile Adversarial Analiz</div>
                    <div style="font-size:9px;color:var(--text-dim)">8 Engineer | 8 Architect | 8 Pentester | 8 Intern</div>
                </div>
                <input type="text" class="cockpit-input" id="redteamTargetInput" placeholder="Analiz hedefi">
                <button class="cockpit-btn" onclick="startRedteamAnalysis()">⚔️ Analiz Başlat</button>
                <div id="redteamResults" style="margin-top:15px;display:none"></div>
            </div>
            <!-- OSINT Tab -->
            <div class="cockpit-tab-content" id="ailydianTabOsint">
                <input type="text" class="cockpit-input" id="osintQueryInput" placeholder="Araştırma sorgusu">
                <select class="cockpit-input" id="osintDepthSelect">
                    <option value="quick">Hızlı</option>
                    <option value="deep">Derin</option>
                    <option value="comprehensive">Kapsamlı</option>
                </select>
                <button class="cockpit-btn" onclick="startOsintInvestigation()">🕵️ Araştır</button>
                <div id="osintInvestResults" style="margin-top:15px;display:none"></div>
            </div>
        </div>
    </div>

    <!-- THREAT Intel Popup -->
    <div class="cockpit-modal threat-modal" id="threatIntelPopup">
        <div class="cockpit-header">
            <h3>🛡️ KÜRESEL TEHDİT İSTİHBARATI</h3>
            <button class="close-btn" onclick="threatIntelPanelKapat()">&times;</button>
        </div>
        <div class="cockpit-tabs">
            <button class="cockpit-tab active" onclick="threatTabDegistir('live')">🔴 Canlı</button>
            <button class="cockpit-tab" onclick="threatTabDegistir('apt')">👤 APT Grupları</button>
            <button class="cockpit-tab" onclick="threatTabDegistir('ioc')">🎯 IOC Kontrol</button>
            <button class="cockpit-tab" onclick="threatTabDegistir('feeds')">📡 Feed'ler</button>
        </div>
        <div class="cockpit-body">
            <div class="cockpit-tab-content active" id="threatTabLive">
                <div class="threat-feed" id="liveThreatFeed">
                    <div style="text-align:center;color:var(--text-dim)">Canlı tehditler yükleniyor...</div>
                </div>
            </div>
            <div class="cockpit-tab-content" id="threatTabApt">
                <div id="aptGroupList">
                    <div style="text-align:center;color:var(--text-dim)">APT grupları yükleniyor...</div>
                </div>
            </div>
            <div class="cockpit-tab-content" id="threatTabIoc">
                <input type="text" class="cockpit-input" id="iocCheckInput" placeholder="IP, Domain, Hash...">
                <button class="cockpit-btn" onclick="checkIOC()">Kontrol Et</button>
                <div id="iocCheckResult" style="margin-top:15px;display:none"></div>
            </div>
            <div class="cockpit-tab-content" id="threatTabFeeds">
                <div id="threatFeedsList">
                    <div style="text-align:center;color:var(--text-dim)">Feed'ler yükleniyor...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- PENTEST Popup -->
    <div class="cockpit-modal pentest-modal" id="pentestPopup">
        <div class="cockpit-header">
            <h3>🎯 PENETRASYON TEST MERKEZİ</h3>
            <button class="close-btn" onclick="pentestPanelKapat()">&times;</button>
        </div>
        <div class="cockpit-tabs">
            <button class="cockpit-tab active" onclick="pentestTabDegistir('projects')">📁 Projeler</button>
            <button class="cockpit-tab" onclick="pentestTabDegistir('findings')">🔍 Bulgular</button>
            <button class="cockpit-tab" onclick="pentestTabDegistir('tasks')">📋 Görevler</button>
            <button class="cockpit-tab" onclick="pentestTabDegistir('stats')">📊 İstatistikler</button>
        </div>
        <div class="cockpit-body">
            <div class="cockpit-tab-content active" id="pentestTabProjects">
                <button class="cockpit-btn" style="margin-bottom:15px" onclick="yeniPentestProjesi()">+ Yeni Proje</button>
                <div class="pentest-projects" id="pentestProjectList">
                    <div style="text-align:center;color:var(--text-dim)">Projeler yükleniyor...</div>
                </div>
            </div>
            <div class="cockpit-tab-content" id="pentestTabFindings">
                <div id="pentestFindingsList">
                    <div style="text-align:center;color:var(--text-dim)">Bulgular yükleniyor...</div>
                </div>
            </div>
            <div class="cockpit-tab-content" id="pentestTabTasks">
                <div id="pentestTasksList">
                    <div style="text-align:center;color:var(--text-dim)">Görevler yükleniyor...</div>
                </div>
            </div>
            <div class="cockpit-tab-content" id="pentestTabStats">
                <div id="pentestStats">
                    <div style="text-align:center;color:var(--text-dim)">İstatistikler yükleniyor...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- DASHBOARD Popup -->
    <div class="cockpit-modal dashboard-modal" id="dashboardPopup">
        <div class="cockpit-header">
            <h3>📊 KONTROL PANELİ</h3>
            <button class="close-btn" onclick="dashboardPanelKapat()">&times;</button>
        </div>
        <div class="cockpit-body">
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <div class="card-value" id="dashWifi">0</div>
                    <div class="card-label">WiFi Ağı</div>
                </div>
                <div class="dashboard-card">
                    <div class="card-value" id="dashBluetooth">0</div>
                    <div class="card-label">Bluetooth</div>
                </div>
                <div class="dashboard-card">
                    <div class="card-value" id="dashAttacks">0</div>
                    <div class="card-label">Saldırı</div>
                </div>
                <div class="dashboard-card">
                    <div class="card-value" id="dashAgents">214</div>
                    <div class="card-label">Agent</div>
                </div>
                <div class="dashboard-card">
                    <div class="card-value" id="dashThreats">0</div>
                    <div class="card-label">Tehdit</div>
                </div>
                <div class="dashboard-card">
                    <div class="card-value" id="dashVulns">0</div>
                    <div class="card-label">Zafiyet</div>
                </div>
            </div>
            <div style="margin-top:20px;padding:15px;background:var(--bg-card);border-radius:8px">
                <div style="font-size:11px;margin-bottom:10px;color:var(--hud-cyan)">Sistem Durumu</div>
                <div id="dashSystemStatus" style="font-size:11px;color:var(--text-dim)">Yükleniyor...</div>
            </div>
        </div>
    </div>

    <!-- BEYIN Popup -->
    <div class="cockpit-modal beyin-modal" id="beyinPopup">
        <div class="cockpit-header">
            <h3>🧬 OTONOM ZEKA MERKEZİ</h3>
            <button class="close-btn" onclick="beyinPanelKapat()">&times;</button>
        </div>
        <div class="cockpit-body">
            <div class="defcon-display">
                <div style="font-size:10px;color:var(--text-dim);margin-bottom:5px">DEFCON SEVİYESİ</div>
                <div class="defcon-level defcon-5" id="defconLevel">5</div>
                <div style="font-size:10px;color:var(--text-dim);margin-top:5px" id="defconText">NORMAL</div>
            </div>
            <div style="padding:15px;background:var(--bg-card);border-radius:8px;margin-bottom:15px">
                <div style="font-size:11px;margin-bottom:10px">Tehdit Durumu</div>
                <div id="beyinThreatList" style="font-size:10px;color:var(--text-dim)">Tehdit yok</div>
            </div>
            <div style="padding:15px;background:var(--bg-card);border-radius:8px;margin-bottom:15px">
                <div style="font-size:11px;margin-bottom:10px">Son Kararlar</div>
                <div id="beyinDecisionList" style="font-size:10px;color:var(--text-dim)">Karar yok</div>
            </div>
            <div style="display:flex;gap:10px">
                <button class="cockpit-btn" onclick="beyinAnalizBaslat()">🔍 Analiz Başlat</button>
                <button class="cockpit-btn" style="background:linear-gradient(135deg,#ff5722,#e64a19)" onclick="defconDegistir()">⚠️ DEFCON Değiştir</button>
            </div>
        </div>
    </div>

    <!-- VULN Popup -->
    <div class="cockpit-modal vuln-modal" id="vulnPopup">
        <div class="cockpit-header">
            <h3>🔓 ZAFİYET YÖNETİMİ</h3>
            <button class="close-btn" onclick="vulnPanelKapat()">&times;</button>
        </div>
        <div class="cockpit-body">
            <div class="vuln-stats">
                <div class="vuln-stat">
                    <div class="stat-value vuln-critical" id="vulnCritical">0</div>
                    <div class="stat-label">Kritik</div>
                </div>
                <div class="vuln-stat">
                    <div class="stat-value vuln-high" id="vulnHigh">0</div>
                    <div class="stat-label">Yüksek</div>
                </div>
                <div class="vuln-stat">
                    <div class="stat-value vuln-medium" id="vulnMedium">0</div>
                    <div class="stat-label">Orta</div>
                </div>
                <div class="vuln-stat">
                    <div class="stat-value vuln-low" id="vulnLow">0</div>
                    <div class="stat-label">Düşük</div>
                </div>
            </div>
            <input type="text" class="cockpit-input" id="vulnTargetInput" placeholder="Hedef IP / Domain">
            <button class="cockpit-btn" onclick="vulnTaramaBaslat()">🔍 Zafiyet Tara</button>
            <div class="vuln-list" id="vulnList" style="margin-top:15px">
                <div style="text-align:center;color:var(--text-dim)">Tarama sonuçları burada görünecek</div>
            </div>
        </div>
    </div>

    <!-- TOR STEALTH Popup Modal -->
    <div class="cockpit-modal tor-modal" id="torStealthPopup">
        <div class="cockpit-header">
            <h3>🧅 TOR / STEALTH NETWORK</h3>
            <button class="close-btn" onclick="closeTorPopup()">&times;</button>
        </div>
        <div class="cockpit-body" style="padding:20px;">
            <!-- Durum Göstergesi -->
            <div class="tor-status-container">
                <div class="tor-status-indicator offline" id="torStatusIndicator">
                    🧅
                </div>
                <div class="tor-status-info">
                    <div class="tor-status-label">Bağlantı Durumu</div>
                    <div class="tor-status-text offline" id="torStatusText">BAĞLI DEĞİL</div>
                    <div class="tor-ip-display" id="torIpDisplay" style="display:none;">
                        <span style="color:var(--text-dim);font-size:10px;">Çıkış IP: </span>
                        <span id="torExitIP">---</span>
                    </div>
                </div>
            </div>

            <!-- Devre Görselleştirme -->
            <div class="tor-circuit-visual" id="torCircuitVisual" style="display:none;">
                <div class="tor-hop">
                    <div class="tor-hop-icon">💻</div>
                    <div class="tor-hop-label">Sen</div>
                    <div class="tor-hop-country" id="torHop0">Yerel</div>
                </div>
                <span class="tor-arrow">→</span>
                <div class="tor-hop">
                    <div class="tor-hop-icon">🔐</div>
                    <div class="tor-hop-label">Guard</div>
                    <div class="tor-hop-country" id="torHop1">---</div>
                </div>
                <span class="tor-arrow">→</span>
                <div class="tor-hop">
                    <div class="tor-hop-icon">🔒</div>
                    <div class="tor-hop-label">Middle</div>
                    <div class="tor-hop-country" id="torHop2">---</div>
                </div>
                <span class="tor-arrow">→</span>
                <div class="tor-hop">
                    <div class="tor-hop-icon">🌐</div>
                    <div class="tor-hop-label">Exit</div>
                    <div class="tor-hop-country" id="torHop3">---</div>
                </div>
            </div>

            <!-- İstatistikler -->
            <div class="tor-stats-grid">
                <div class="tor-stat-item">
                    <div class="tor-stat-value" id="torHops">0</div>
                    <div class="tor-stat-label">Hop Sayısı</div>
                </div>
                <div class="tor-stat-item">
                    <div class="tor-stat-value" id="torLatency">--</div>
                    <div class="tor-stat-label">Latency (ms)</div>
                </div>
                <div class="tor-stat-item">
                    <div class="tor-stat-value" id="torEncryption">AES-256</div>
                    <div class="tor-stat-label">Şifreleme</div>
                </div>
            </div>

            <!-- Kalıcı Toggle Anahtarları -->
            <div style="display:flex;gap:12px;margin:15px 0;padding:12px;background:rgba(0,255,136,0.05);border:1px solid rgba(0,255,136,0.15);border-radius:8px;">
                <div style="flex:1;display:flex;align-items:center;justify-content:space-between;">
                    <div>
                        <div style="font-size:11px;color:var(--text-dim);text-transform:uppercase;">🧅 Tor</div>
                        <div style="font-size:10px;color:var(--text-dim);opacity:0.7;" id="torToggleStatus">Aktif</div>
                    </div>
                    <label class="toggle-switch" style="position:relative;width:40px;height:22px;">
                        <input type="checkbox" id="torToggle" checked onchange="toggleTorSetting(this.checked)" style="opacity:0;width:0;height:0;">
                        <span style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:rgba(255,51,51,0.4);border-radius:11px;transition:.3s;"></span>
                        <span style="position:absolute;left:2px;bottom:2px;width:18px;height:18px;background:#fff;border-radius:50%;transition:.3s;"></span>
                    </label>
                </div>
                <div style="width:1px;background:rgba(255,255,255,0.1);"></div>
                <div style="flex:1;display:flex;align-items:center;justify-content:space-between;">
                    <div>
                        <div style="font-size:11px;color:var(--text-dim);text-transform:uppercase;">👻 Ghost</div>
                        <div style="font-size:10px;color:var(--text-dim);opacity:0.7;" id="ghostToggleStatus">Aktif</div>
                    </div>
                    <label class="toggle-switch" style="position:relative;width:40px;height:22px;">
                        <input type="checkbox" id="ghostToggle" checked onchange="toggleGhostSetting(this.checked)" style="opacity:0;width:0;height:0;">
                        <span style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:rgba(255,51,51,0.4);border-radius:11px;transition:.3s;"></span>
                        <span style="position:absolute;left:2px;bottom:2px;width:18px;height:18px;background:#fff;border-radius:50%;transition:.3s;"></span>
                    </label>
                </div>
            </div>

            <!-- Gizlilik Seviyesi Seçici -->
            <div class="tor-level-selector">
                <div style="font-size:11px;color:var(--text-dim);margin-bottom:10px;text-transform:uppercase;">Gizlilik Seviyesi</div>
                <button class="tor-level-btn active" data-level="normal" onclick="selectTorLevel('normal')">
                    <span>🔒 Normal (Tor Only)</span>
                    <span class="tor-level-badge">3 Hop</span>
                </button>
                <button class="tor-level-btn" data-level="enhanced" onclick="selectTorLevel('enhanced')">
                    <span>🛡️ Gelişmiş (VPN + Tor)</span>
                    <span class="tor-level-badge">4+ Hop</span>
                </button>
                <button class="tor-level-btn" data-level="maximum" onclick="selectTorLevel('maximum')">
                    <span>⚡ Maksimum (VPN + Proxy + Tor)</span>
                    <span class="tor-level-badge">5+ Hop</span>
                </button>
            </div>

            <!-- Aksiyon Butonları -->
            <div class="tor-actions">
                <button class="tor-action-btn tor-btn-primary" id="torConnectBtn" onclick="toggleTorConnection()">
                    <span>⚡</span>
                    <span id="torConnectBtnText">TOR AKTİF ET</span>
                </button>
                <button class="tor-action-btn tor-btn-secondary" id="torRotateBtn" onclick="rotateTorCircuit()" disabled>
                    <span>🔄</span>
                    <span>Devre Döndür</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Terminal -->
    <div class="terminal-bar" id="termBar">
        <div class="terminal-header" onclick="termToggle()">
            <div class="terminal-title">
                <span>TSUNAMI Terminal</span>
                <span class="term-badge" id="termBadge">GİZLİ</span>
            </div>
            <div class="term-btns" onclick="event.stopPropagation()">
                <button onclick="termCmd('durum')">durum</button>
                <button onclick="termCmd('siber durum')" style="background:rgba(0,255,136,0.2);border-color:rgba(0,255,136,0.4);color:#00ff88">siber</button>
                <button onclick="termCmd('tehdit av')" style="background:rgba(255,51,85,0.2);border-color:rgba(255,51,85,0.4);color:#ff3355">tehdit</button>
                <button onclick="termCmd('ajan liste')">ajan</button>
                <button onclick="termCmd('ucak tara')">ucak</button>
                <button onclick="termClear()">temizle</button>
            </div>
        </div>
        <div class="terminal-body" id="termBody">
            <div class="term-output" id="termOut"></div>
            <div class="term-input-row">
                <span class="term-prompt">tsunami:~$</span>
                <input type="text" class="term-input" id="termIn" placeholder="komut..." onkeydown="termKey(event)">
            </div>
        </div>
    </div>

    <script>
        // ═══════════════════════════════════════════════════════════════
        // TSUNAMI HARITA v2.0 - Canlı Saldırılar EN ÜSTTE
        // ═══════════════════════════════════════════════════════════════
        console.log('%c[TSUNAMI] Harita v2.0 yüklendi - Canlı Saldırılar EN ÜSTTE', 'color: #00ff88; font-weight: bold; font-size: 14px;');

        // Eski localStorage'ı zorla temizle (tek seferlik)
        if (!localStorage.getItem('tsunami_v2_migrated')) {
            localStorage.removeItem('tsunami_widget_states');
            localStorage.setItem('tsunami_v2_migrated', 'true');
            console.log('%c[TSUNAMI] Eski widget durumları temizlendi', 'color: #ff3355;');
        }

        // Sesli Bildirim Sistemi - Web Speech API
        function sesliUyari(mesaj) {
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(mesaj);
                utterance.lang = 'tr-TR';
                utterance.rate = 1.0;
                utterance.pitch = 1.0;
                const voices = speechSynthesis.getVoices();
                const turkceVoice = voices.find(v => v.lang.startsWith('tr'));
                if (turkceVoice) utterance.voice = turkceVoice;
                speechSynthesis.speak(utterance);
            }
        }
        if ('speechSynthesis' in window) {
            speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices();
        }

        let map, socket;
        let layers = {
            wifi: L.markerClusterGroup(),
            bt: L.markerClusterGroup(),
            baz: L.layerGroup(),
            atk: L.layerGroup(),
            kritik: L.layerGroup(), // Kritik altyapi katmani
            // === YENİ MÜDAHAlE KATMANLARI ===
            sinkhole: L.markerClusterGroup({ maxClusterRadius: 50 }),  // DNS Sinkhole engellenen domainler
            honeypot: L.markerClusterGroup({ maxClusterRadius: 60 }),  // Honeypot saldırganları
            hunter: L.layerGroup(),    // AI Threat Hunter tehditleri
            wireless: L.layerGroup(),  // Wireless IDS olayları
            federated: L.layerGroup()  // Federated Intelligence IOC'ler
        };
        let heatLayer = null;

        // Müdahale modülü durumları
        let interventionState = {
            sinkhole: { aktif: false, veriler: [] },
            honeypot: { aktif: false, veriler: [] },
            hunter: { aktif: false, veriler: [] },
            wireless: { aktif: false, veriler: [] },
            federated: { aktif: false, veriler: [] }
        };
        let attackCount = 0;
        let attackData = new Map();
        let cmdHist = [], cmdIdx = -1;

        const TURKIYE = { lat: 39.0, lng: 35.0, zoom: 6 };

        // ═══════════════════════════════════════════════════════════════
        //  PLAN MODU - SİSTEM DEĞİŞKENLER
        // ═══════════════════════════════════════════════════════════════
        const PLAN_MODE = {
            aktif: false,
            araclar: null,  // Çizim aracı
            mevcutCizim: null,
            cizimNoktalari: [],
            seciliTool: null,
            olcumSonuc: 0
        };

        // Plan Modunu Aç/Kapa
        function togglePlanMode() {
            PLAN_MODE.aktif = !PLAN_MODE.aktif;
            const btn = document.getElementById('planModeBtn');
            const toolbar = document.getElementById('planToolbar');
            const indicator = document.getElementById('planModeIndicator');

            if (PLAN_MODE.aktif) {
                // Plan modunu aç
                btn.classList.add('active');
                indicator.style.display = 'block';
                toolbar.classList.add('active');
                document.body.classList.add('plan-mode-active');

                // Harita kontrollerini devre dışı bırak
                map.dragging.disable();
                map.touchZoom.disable();
                map.doubleClickZoom.disable();
                map.boxZoom.disable();

                // Çizim katmanı oluştur
                PLAN_MODE.aracilar = L.layerGroup().addTo(map);

                // Term log
                console.log('[PLAN MODU] Aktif - Çizim araçları kullanılabilir');
                termLog && termLog('Plan modu aktif', 'ok');

            } else {
                // Plan modunu kapat
                btn.classList.remove('active');
                indicator.style.display = 'none';
                toolbar.classList.remove('active');
                document.body.classList.remove('plan-mode-active');

                // Harita kontrollerini aktif et
                map.dragging.enable();
                map.touchZoom.enable();
                map.doubleClickZoom.enable();
                map.boxZoom.enable();

                // Çizim araclarını temizle
                if (PLAN_MODE.aracilar) {
                    map.removeLayer(PLAN_MODE.aracilar);
                    PLAN_MODE.aracilar = null;
                }

                PLAN_MODE.cizimNoktalari = [];
                PLAN_MODE.seciliTool = null;

                console.log('[PLAN MODU] Pasif - Normal harita modu');
                termLog && termLog('Plan modu pasif', 'info');
            }
        }

        // Çizim Aracı Seç
        function selectPlanTool(tool) {
            if (!PLAN_MODE.aktif) {
                console.warn('[PLAN MODU] Plan modu aktif değil!');
                return;
            }

            // Önceki seçimi kaldır
            document.querySelectorAll('.plan-tool-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Yeni aracı seç
            const btn = document.querySelector(`[data-tool="${tool}"]`);
            if (btn) {
                btn.classList.add('active');
            }

            PLAN_MODE.seciliTool = tool;
            console.log(`[PLAN MODU] Araç seçildi: ${tool}`);

            // Harita tıklama davranışını ayarla
            map.off('click');
            map.on('click', handlePlanDrawClick);
        }

        // Plan Modu Çizim Tıklama Handler
        function handlePlanDrawClick(e) {
            if (!PLAN_MODE.aktif || !PLAN_MODE.seciliTool) return;

            const latlng = e.latlng;

            if (PLAN_MODE.seciliTool === 'marker') {
                // Nokta ekle
                const marker = L.circleMarker(latlng, {
                    radius: 8,
                    fillColor: '#00ff9d',
                    color: '#00ff9d',
                    weight: 2,
                    opacity: 0.8
                }).addTo(PLAN_MODE.aracilar);

                PLAN_MODE.cizimNoktalari.push({
                    tip: 'marker',
                    latlng: latlng
                });

                console.log(`[PLAN MODU] Nokta eklendi: ${latlng.lat}, ${latlng.lng}`);

            } else if (PLAN_MODE.seciliTool === 'line' || PLAN_MODE.seciliTool === 'polygon') {
                // Çizgi/polygon için nokta toplama
                PLAN_MODE.cizimNoktalari.push({
                    tip: PLAN_MODE.seciliTool,
                    latlng: latlng
                });

                // İlk nokta
                if (PLAN_MODE.cizimNoktalari.length === 1) {
                    PLAN_MODE.mevcutCizim = L.polyline([latlng], {
                        color: '#00ff9d',
                        weight: 2,
                        dashArray: '5, 10',
                        opacity: 0.8
                    }).addTo(PLAN_MODE.aracilar);
                } else {
                    // Sonraki noktayı ekle
                    PLAN_MODE.mevcutCizim.addLatLng(latlng);
                }

                // Polygon için 3. noktada tamamla
                if (PLAN_MODE.seciliTool === 'polygon' && PLAN_MODE.cizimNoktalari.length >= 3) {
                    const polygonKoordinat = PLAN_MODE.cizimNoktalari.map(p => p.latlng);
                    PLAN_MODE.mevcutCizim.remove();

                    const polygon = L.polygon([polygonKoordinat], {
                        color: '#00ff9d',
                        fillColor: 'rgba(0, 255, 157, 0.2)',
                        weight: 2
                    }).addTo(PLAN_MODE.aracilar);

                    PLAN_MODE.mevcutCizim = polygon;
                    PLAN_MODE.cizimNoktalari = [];

                    // Alan hesapla
                    calculateArea(polygonKoordinat);
                }

            } else if (PLAN_MODE.seciliTool === 'circle') {
                // Daire çiz
                PLAN_MODE.cizimNoktalari.push({
                    tip: 'circle',
                    latlng: latlng
                });

                // İlk tıklama: merkez
                if (PLAN_MODE.cizimNoktalari.length === 1) {
                    PLAN_MODE.mevcutCircle = L.circle(latlng, {
                        radius: 1000, // Geçici radius
                        color: '#00b4ff',
                        fillColor: 'rgba(0, 180, 255, 0.2)',
                        weight: 2,
                        opacity: 0.5
                    }).addTo(PLAN_MODE.aracilar);
                } else {
                    // İkinci tıklama: radius belirle
                    const merkez = PLAN_MODE.cizimNoktalari[0].latlng;
                    const yaricap = merkez.distanceTo(latlng);

                    PLAN_MODE.mevcutCircle.setRadius(yaricap);
                    PLAN_MODE.mevcutCircle.setStyle({
                        fillColor: 'rgba(0, 180, 255, 0.3)',
                        weight: 3
                    });

                    PLAN_MODE.cizimNoktalari = [];

                    // Alan hesapla
                    const alan = Math.PI * yaricap * yaricap / 1000; // km²
                    updateMeasurement(alan, 'alan_km2');
                }
            }
        }

        // Alan hesapla
        function calculateArea(koordinatlar) {
            // Shoelace formülü ile alan hesapla
            let alan = 0;
            const j = koordinatlar.length - 1;

            for (let i = 0; i < koordinatlar.length; j++) {
                const p1 = koordinatlar[i];
                const p2 = koordinatalar[(i + 1) % koordinatlar.length];

                alan += p1.lat * p2.lng;
                alan -= p1.lng * p2.lat;
            }

            alan = alan * 111.139 * 111.139 / 2; // km²'ye çevir
            updateMeasurement(Math.abs(alan).toFixed(3), 'alan_km2');
        }

        // Ölçüm değerini güncelle
        function updateMeasurement(deger, birim) {
            const display = document.getElementById('measurementValue');
            if (display) {
                if (birim === 'alan_km2') {
                    display.textContent = `Alan: ${deger} km²`;
                } else if (birim === 'mesafe_km') {
                    display.textContent = `Mesafe: ${deger} km`;
                }
            }
            PLAN_MODE.olcumSonuc = parseFloat(deger);
        }

        // Çizimleri temizle
        function clearDrawings() {
            if (PLAN_MODE.aracilar) {
                PLAN_MODE.aracilar.clearLayers();
            }
            PLAN_MODE.cizimNoktalari = [];
            PLAN_MODE.mevcutCizim = null;

            document.getElementById('measurementValue').textContent = 'Hazır: 0 km';

            console.log('[PLAN MODU] Çizimler temizlendi');
            termLog && termLog('Çizimler temizlendi', 'ok');
        }

        // Plan notlarını aç
        function openPlanNotes() {
            const notesPanel = document.getElementById('planNotes');
            notesPanel.classList.add('active');

            // Kayıtlı planları yükle
            loadPlanlar();
        }

        // Plan notlarını kapat
        function closePlanNotes() {
            document.getElementById('planNotes').classList.remove('active');
        }

        // Plan notunu kaydet
        function savePlanNote() {
            const text = document.getElementById('planNoteText').value;
            const cizimVerileri = PLAN_MODE.cizimNoktalari.map(p => ({
                lat: p.latlng.lat,
                lng: p.latlng.lng,
                tip: p.tip
            }));

            const planData = {
                adi: prompt('Plan adı:', 'Plan ' + new Date().toLocaleString('tr-TR')),
                tur: PLAN_MODE.seciliTool || 'marker',
                koordinatlar: cizimVerileri,
                notlar: text,
                renk: '#00b4ff'
            };

            if (planData.adi) {
                fetch('/api/harita/plan/kaydet', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(planData)
                })
                .then(r => r.json())
                .then(data => {
                    if (data.basarili) {
                        termLog && termLog('Plan kaydedildi: ' + planData.adi, 'ok');
                        loadPlanlar();
                        document.getElementById('planNoteText').value = '';
                    } else {
                        alert('Kaydetme hatası: ' + data.hata);
                    }
                });
            }
        }

        // Kayıtlı planları yükle
        function loadPlanlar() {
            fetch('/api/harita/plan/listele')
                .then(r => r.json())
                .then(data => {
                    const list = document.getElementById('planList');
                    list.innerHTML = '';

                    if (data.basarili && data.planlar) {
                        data.planlar.forEach(plan => {
                            const item = document.createElement('div');
                            item.className = 'plan-item';
                            item.onclick = () => loadPlanToMap(plan);
                            item.innerHTML = `
                                <div class="plan-item-name">${plan.adi}</div>
                                <div class="plan-item-meta">${plan.tur} • ${plan.olusturulma}</div>
                            `;
                            list.appendChild(item);
                        });
                    }
                });
        }

        // Planı haritaya yükle
        function loadPlanToMap(plan) {
            try {
                const koordinatlar = plan.koordinatlar;

                if (plan.tur === 'polygon') {
                    L.polygon(koordinatlar, {
                        color: plan.renk,
                        fillColor: plan.renk + '33',
                        weight: 2
                    }).addTo(PLAN_MODE.aracilar);
                } else if (plan.tur === 'line') {
                    L.polyline(koordinatlar, {
                        color: plan.renk,
                        weight: 3
                    }).addTo(PLAN_MODE.aracilar);
                } else if (plan.tur === 'marker') {
                    koordinatlar.forEach(k => {
                        L.marker(k, {
                            icon: L.divIcon({
                                className: 'drawing-marker',
                                html: '<div style="background:' + plan.renk + ';width:12px;height:12px;border-radius:50%;"></div>'
                            })
                        }).addTo(PLAN_MODE.aracilar);
                    });
                }

                termLog && termLog('Plan yüklendi: ' + plan.adi, 'ok');

            } catch (e) {
                console.error('[PLAN MODU] Plan yükleme hatası:', e);
            }
        }

        // Çizimi kaydet
        function saveMeasurement() {
            if (!PLAN_MODE.mevcutCizim && PLAN_MODE.cizimNoktalari.length === 0) {
                alert('Önce bir çizim yapın!');
                return;
            }

            const adi = prompt('Çizim adı:', 'Çizim ' + new Date().toLocaleString('tr-TR'));
            if (!adi) return;

            // Çizim verisini topla
            const koordinatlar = PLAN_MODE.cizimNoktalari.map(p => [p.latlng.lat, p.latlng.lng]);

            const planData = {
                adi: adi,
                tur: PLAN_MODE.seciliTool,
                koordinatlar: koordinatlar,
                notlar: document.getElementById('planNoteText').value || '',
                renk: '#00ff9d'
            };

            fetch('/api/harita/plan/kaydet', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(planData)
            })
            .then(r => r.json())
            .then(data => {
                if (data.basarili) {
                    termLog && termLog('Çizim kaydedildi: ' + adi, 'ok');
                    loadPlanlar();
                } else {
                    alert('Kaydetme hatası: ' + data.hata);
                }
            });
        }

        // ═══════════════════════════════════════════════════════════════
        //  GERÇEK KONUM SERVİSLERİ - CANLI TAKİP
        // ═══════════════════════════════════════════════════════════════

        // Turkiye Kritik Altyapi Noktalari (Genisletilmis)
        const KRITIK_ALTYAPI = [
            // ==================== ENERJI SANTRALLERI ====================
            { ad: 'Akkuyu Nukleer Santrali', lat: 36.1444, lng: 33.5378, tip: 'nukleer', risk: 'kritik', aciklama: 'Turkiyenin ilk nukleer enerji santrali' },
            { ad: 'Afsin-Elbistan A Termik', lat: 38.2833, lng: 36.9167, tip: 'termik', risk: 'yuksek', aciklama: 'Turkiyenin en buyuk termik santrali' },
            { ad: 'Afsin-Elbistan B Termik', lat: 38.2900, lng: 36.9200, tip: 'termik', risk: 'yuksek', aciklama: 'Linyit yakit termik santral' },
            { ad: 'Soma Termik Santrali', lat: 39.1833, lng: 27.6167, tip: 'termik', risk: 'yuksek', aciklama: 'Manisa termik santrali' },
            { ad: 'Yenikoy Termik', lat: 37.0167, lng: 27.9333, tip: 'termik', risk: 'orta', aciklama: 'Mugla termik santrali' },
            { ad: 'Ataturk Baraji HES', lat: 37.5167, lng: 38.3333, tip: 'hidroelektrik', risk: 'kritik', aciklama: 'Guneydogu Anadolunun enerji kaynagi' },
            { ad: 'Keban Baraji HES', lat: 38.7833, lng: 38.7500, tip: 'hidroelektrik', risk: 'yuksek', aciklama: 'Firat Nehri uzerinde' },
            { ad: 'Ilisu Baraji HES', lat: 37.5500, lng: 41.8167, tip: 'hidroelektrik', risk: 'yuksek', aciklama: 'Dicle Nehri uzerinde' },
            { ad: 'Karakaya Baraji HES', lat: 38.3667, lng: 39.1500, tip: 'hidroelektrik', risk: 'yuksek', aciklama: 'Firat Nehri uzerinde' },
            { ad: 'Deriner Baraji HES', lat: 41.3333, lng: 41.4500, tip: 'hidroelektrik', risk: 'yuksek', aciklama: 'Coruh Nehri uzerinde' },
            { ad: 'TANAP Kompressor', lat: 40.9833, lng: 29.8667, tip: 'dogalgaz', risk: 'kritik', aciklama: 'Trans-Anadolu dogalgaz boru hatti' },
            { ad: 'BTC Boru Hatti Ceyhan', lat: 36.8667, lng: 35.9500, tip: 'dogalgaz', risk: 'kritik', aciklama: 'Baku-Tiflis-Ceyhan petrol hatti' },

            // ==================== ILETISIM VE VERI MERKEZLERI ====================
            { ad: 'TurkSat Golbasi', lat: 39.7833, lng: 32.8000, tip: 'iletisim', risk: 'kritik', aciklama: 'Ulusal uydu kontrol merkezi' },
            { ad: 'ULAK Data Center', lat: 39.9208, lng: 32.8541, tip: 'veri_merkezi', risk: 'yuksek', aciklama: 'Ulusal akademik ag merkezi' },
            { ad: 'Turk Telekom NOC', lat: 41.0082, lng: 28.9784, tip: 'iletisim', risk: 'kritik', aciklama: 'Ulusal ag operasyon merkezi' },
            { ad: 'Google Cloud Istanbul', lat: 41.0422, lng: 29.0083, tip: 'veri_merkezi', risk: 'yuksek', aciklama: 'Bulut veri merkezi' },
            { ad: 'Equinix Istanbul', lat: 41.0150, lng: 28.9500, tip: 'veri_merkezi', risk: 'yuksek', aciklama: 'Uluslararasi veri merkezi' },
            { ad: 'Vodafone Data Center', lat: 41.1000, lng: 29.0200, tip: 'veri_merkezi', risk: 'orta', aciklama: 'Telekomnikasyon veri merkezi' },

            // ==================== ULASIM ALTYAPISI ====================
            { ad: 'Istanbul Havalimani', lat: 41.2608, lng: 28.7428, tip: 'havalimani', risk: 'kritik', aciklama: 'Dunyanin en buyuk havalimanlarindan' },
            { ad: 'Sabiha Gokcen', lat: 40.8986, lng: 29.3092, tip: 'havalimani', risk: 'yuksek', aciklama: 'Istanbul 2. havalimani' },
            { ad: 'Esenboga Havalimani', lat: 40.1281, lng: 32.9950, tip: 'havalimani', risk: 'yuksek', aciklama: 'Baskent havalimani' },
            { ad: 'Adnan Menderes Havalimani', lat: 38.2924, lng: 27.1567, tip: 'havalimani', risk: 'orta', aciklama: 'Izmir havalimani' },
            { ad: 'Antalya Havalimani', lat: 36.8987, lng: 30.8005, tip: 'havalimani', risk: 'orta', aciklama: 'Turizm havalimani' },
            { ad: 'Marmaray Tuneli', lat: 41.0033, lng: 29.0167, tip: 'tunel', risk: 'kritik', aciklama: 'Bogazici denizalti raylı sistem tuneli' },
            { ad: 'Avrasya Tuneli', lat: 40.9897, lng: 29.0339, tip: 'tunel', risk: 'yuksek', aciklama: 'Karayolu denizalti tuneli' },
            { ad: '1915 Canakkale Koprusu', lat: 40.2833, lng: 26.7167, tip: 'kopru', risk: 'kritik', aciklama: 'Dunyanin en uzun asma koprusu' },
            { ad: 'Fatih Sultan Mehmet Koprusu', lat: 41.0856, lng: 29.0600, tip: 'kopru', risk: 'yuksek', aciklama: 'Bogazici 2. koprusu' },
            { ad: 'Yavuz Sultan Selim Koprusu', lat: 41.2050, lng: 29.1108, tip: 'kopru', risk: 'yuksek', aciklama: 'Bogazici 3. koprusu' },
            { ad: 'Osman Gazi Koprusu', lat: 40.7553, lng: 29.5050, tip: 'kopru', risk: 'yuksek', aciklama: 'Izmit Korfezi koprusu' },

            // ==================== LIMAN VE DENIZCILIK ====================
            { ad: 'Mersin Limani', lat: 36.8000, lng: 34.6333, tip: 'liman', risk: 'kritik', aciklama: 'Turkiyenin en buyuk konteyner limani' },
            { ad: 'Ambarli Limani', lat: 40.9833, lng: 28.6833, tip: 'liman', risk: 'kritik', aciklama: 'Istanbul konteyner terminali' },
            { ad: 'Izmir Alsancak Limani', lat: 38.4333, lng: 27.1333, tip: 'liman', risk: 'yuksek', aciklama: 'Ege bolgesi ana limani' },
            { ad: 'Aliaga Petkim Limani', lat: 38.7833, lng: 26.9667, tip: 'liman', risk: 'yuksek', aciklama: 'Petrokimya limani' },
            { ad: 'Iskenderun Limani', lat: 36.5833, lng: 36.1833, tip: 'liman', risk: 'yuksek', aciklama: 'Dogu Akdeniz limani' },
            { ad: 'Trabzon Limani', lat: 41.0000, lng: 39.7333, tip: 'liman', risk: 'orta', aciklama: 'Karadeniz ana limani' },

            // ==================== BANKA VE FINANS MERKEZI ====================
            { ad: 'Borsa Istanbul', lat: 41.1046, lng: 29.0119, tip: 'finans', risk: 'kritik', aciklama: 'Ulusal borsa merkezi' },
            { ad: 'TCMB Ankara Merkez', lat: 39.9208, lng: 32.8541, tip: 'finans', risk: 'kritik', aciklama: 'TC Merkez Bankasi Genel Mudurlugu' },
            { ad: 'TCMB Istanbul Subesi', lat: 41.0350, lng: 28.9850, tip: 'finans', risk: 'kritik', aciklama: 'Merkez Bankasi Istanbul' },
            { ad: 'BDDK Ankara', lat: 39.9167, lng: 32.8500, tip: 'finans', risk: 'yuksek', aciklama: 'Bankacilik Duzenleme ve Denetleme Kurumu' },
            { ad: 'Ziraat Bankasi Genel Mudurluğu', lat: 39.9300, lng: 32.8600, tip: 'banka', risk: 'kritik', aciklama: 'Turkiyenin en buyuk bankasi' },
            { ad: 'Halkbank Genel Mudurluğu', lat: 39.9250, lng: 32.8550, tip: 'banka', risk: 'kritik', aciklama: 'Kamu bankasi' },
            { ad: 'VakifBank Genel Mudurluğu', lat: 41.0400, lng: 29.0100, tip: 'banka', risk: 'kritik', aciklama: 'Kamu bankasi' },
            { ad: 'Is Bankasi Genel Mudurluğu', lat: 41.0550, lng: 28.9950, tip: 'banka', risk: 'kritik', aciklama: 'Turkiyenin en buyuk ozel bankasi' },
            { ad: 'Garanti BBVA Genel Mudurluğu', lat: 41.0800, lng: 29.0150, tip: 'banka', risk: 'yuksek', aciklama: 'Ozel banka' },
            { ad: 'Yapi Kredi Genel Mudurluğu', lat: 41.0650, lng: 29.0050, tip: 'banka', risk: 'yuksek', aciklama: 'Ozel banka' },
            { ad: 'Akbank Genel Mudurluğu', lat: 41.0700, lng: 29.0100, tip: 'banka', risk: 'yuksek', aciklama: 'Ozel banka' },
            { ad: 'Denizbank Genel Mudurluğu', lat: 41.0600, lng: 29.0000, tip: 'banka', risk: 'orta', aciklama: 'Ozel banka' },
            { ad: 'QNB Finansbank Genel Mudurluğu', lat: 41.0500, lng: 28.9900, tip: 'banka', risk: 'orta', aciklama: 'Ozel banka' },
            { ad: 'TEB Genel Mudurluğu', lat: 41.0450, lng: 28.9800, tip: 'banka', risk: 'orta', aciklama: 'Ozel banka' },
            { ad: 'ING Bank Turkiye', lat: 41.0350, lng: 28.9700, tip: 'banka', risk: 'orta', aciklama: 'Yabanci banka' },
            { ad: 'HSBC Turkiye', lat: 41.0250, lng: 28.9600, tip: 'banka', risk: 'orta', aciklama: 'Yabanci banka' },

            // ==================== HASTANE VE SAGLIK ====================
            { ad: 'Ankara Sehir Hastanesi', lat: 39.9600, lng: 32.7200, tip: 'hastane', risk: 'kritik', aciklama: 'Avrupa nin en buyuk hastanesi' },
            { ad: 'Basaksehir Cam Sakura Hastanesi', lat: 41.1200, lng: 28.7800, tip: 'hastane', risk: 'kritik', aciklama: 'Turkiyenin en buyuk hastanesi' },
            { ad: 'Bilkent Sehir Hastanesi', lat: 39.8700, lng: 32.7500, tip: 'hastane', risk: 'kritik', aciklama: 'Ankara sehir hastanesi' },
            { ad: 'Hacettepe Universitesi Hastanesi', lat: 39.8667, lng: 32.7333, tip: 'hastane', risk: 'yuksek', aciklama: 'Arastirma hastanesi' },
            { ad: 'Istanbul Universitesi Tip Fakultesi', lat: 41.0150, lng: 28.9300, tip: 'hastane', risk: 'yuksek', aciklama: 'Cerrahpasa Tip Fakultesi' },
            { ad: 'Marmara Universitesi Pendik EAH', lat: 40.8833, lng: 29.2333, tip: 'hastane', risk: 'yuksek', aciklama: 'Egitim arastirma hastanesi' },
            { ad: 'Ege Universitesi Hastanesi', lat: 38.4500, lng: 27.2167, tip: 'hastane', risk: 'yuksek', aciklama: 'Izmir arastirma hastanesi' },

            // ==================== UNIVERSITE VE ARASTIRMA ====================
            { ad: 'ODTU Kampusu', lat: 39.8917, lng: 32.7833, tip: 'universite', risk: 'yuksek', aciklama: 'Orta Dogu Teknik Universitesi' },
            { ad: 'Bogazici Universitesi', lat: 41.0833, lng: 29.0500, tip: 'universite', risk: 'yuksek', aciklama: 'Turkiyenin en koklü universitesi' },
            { ad: 'ITU Maslak Kampusu', lat: 41.1050, lng: 29.0250, tip: 'universite', risk: 'yuksek', aciklama: 'Istanbul Teknik Universitesi' },
            { ad: 'TUBITAK Gebze', lat: 40.8000, lng: 29.4333, tip: 'arastirma', risk: 'kritik', aciklama: 'Bilimsel arastirma merkezi' },
            { ad: 'TUBITAK UZAY', lat: 39.8917, lng: 32.7600, tip: 'arastirma', risk: 'kritik', aciklama: 'Uzay teknolojileri merkezi' },
            { ad: 'TAI (TUSAS)', lat: 39.9500, lng: 32.6833, tip: 'arastirma', risk: 'kritik', aciklama: 'Havacilik ve uzay sanayii' },
            { ad: 'ASELSAN Macunkoy', lat: 39.9667, lng: 32.7500, tip: 'arastirma', risk: 'kritik', aciklama: 'Savunma elektronigi' },

            // ==================== ASKERI VE GUVENLIK ====================
            { ad: 'Incirlik Hava Ussu', lat: 37.0011, lng: 35.4258, tip: 'askeri', risk: 'kritik', aciklama: 'NATO hava ussu' },
            { ad: 'Aksaz Deniz Ussu', lat: 36.8167, lng: 28.4167, tip: 'askeri', risk: 'yuksek', aciklama: 'Deniz Kuvvetleri ussu' },
            { ad: 'Konya 3. Ana Jet Ussu', lat: 37.9667, lng: 32.5667, tip: 'askeri', risk: 'yuksek', aciklama: 'Hava Kuvvetleri ussu' },
            { ad: 'Diyarbakir 8. Ana Jet Ussu', lat: 37.8939, lng: 40.2011, tip: 'askeri', risk: 'yuksek', aciklama: 'Hava Kuvvetleri ussu' },
            { ad: 'Izmir NATO Karargahi', lat: 38.4192, lng: 27.1287, tip: 'askeri', risk: 'kritik', aciklama: 'NATO Guneydogu Avrupa Karargahi' },
            { ad: 'Golcuk Deniz Ussu', lat: 40.7167, lng: 29.8167, tip: 'askeri', risk: 'yuksek', aciklama: 'Ana deniz ussu' },

            // ==================== SU VE ALTYAPI ====================
            { ad: 'Melen Baraji', lat: 40.8833, lng: 30.4167, tip: 'su', risk: 'yuksek', aciklama: 'Istanbul icme suyu kaynagi' },
            { ad: 'Oymapinar Baraji', lat: 36.9167, lng: 31.4500, tip: 'su', risk: 'yuksek', aciklama: 'Akdeniz su kaynagi' },
            { ad: 'Kurtun Baraji', lat: 40.6833, lng: 38.9500, tip: 'su', risk: 'orta', aciklama: 'Karadeniz su kaynagi' },
            { ad: 'ISKI Kagithane', lat: 41.0833, lng: 28.9667, tip: 'su', risk: 'kritik', aciklama: 'Istanbul su idaresi merkezi' },
            { ad: 'ASKI Ankara', lat: 39.9333, lng: 32.8667, tip: 'su', risk: 'yuksek', aciklama: 'Ankara su idaresi' },

            // ==================== SIBER GUVENLIK ====================
            { ad: 'USOM Ankara', lat: 39.9334, lng: 32.8597, tip: 'siber', risk: 'kritik', aciklama: 'Ulusal Siber Olaylara Mudahale Merkezi' },
            { ad: 'BTK Ankara', lat: 39.9167, lng: 32.8333, tip: 'siber', risk: 'yuksek', aciklama: 'Bilgi Teknolojileri ve Iletisim Kurumu' },
            { ad: 'SSB Siber Guvenlik', lat: 39.9100, lng: 32.8400, tip: 'siber', risk: 'kritik', aciklama: 'Savunma Sanayii Baskanligi siber birim' },
            { ad: 'HAVELSAN Siber', lat: 39.9200, lng: 32.8300, tip: 'siber', risk: 'yuksek', aciklama: 'Savunma siber guvenlik merkezi' },

            // ==================== HUKUMET VE DEVLET ====================
            { ad: 'TBMM', lat: 39.9167, lng: 32.8500, tip: 'hukumet', risk: 'kritik', aciklama: 'Turkiye Buyuk Millet Meclisi' },
            { ad: 'Cumhurbaskanligi Kulliyesi', lat: 39.9300, lng: 32.7900, tip: 'hukumet', risk: 'kritik', aciklama: 'Cumhurbaskanligi merkezi' },
            { ad: 'Disisleri Bakanligi', lat: 39.9200, lng: 32.8450, tip: 'hukumet', risk: 'yuksek', aciklama: 'Disisleri merkezi' },
            { ad: 'Icisleri Bakanligi', lat: 39.9150, lng: 32.8400, tip: 'hukumet', risk: 'yuksek', aciklama: 'Icisleri merkezi' },
            { ad: 'MSB Bakanligi', lat: 39.9100, lng: 32.8350, tip: 'hukumet', risk: 'kritik', aciklama: 'Milli Savunma Bakanligi' },
            { ad: 'MIT Genel Mudurluğu', lat: 39.9050, lng: 32.8300, tip: 'hukumet', risk: 'kritik', aciklama: 'Milli Istihbarat Teskilati' }
        ];

        // Kritik altyapi ikonlari (Genisletilmis)
        const KRITIK_IKONLAR = {
            nukleer: { renk: '#ff0000', ikon: '☢', boyut: 14 },
            termik: { renk: '#ff6600', ikon: '🏭', boyut: 12 },
            hidroelektrik: { renk: '#0099ff', ikon: '💧', boyut: 12 },
            dogalgaz: { renk: '#ffcc00', ikon: '🔥', boyut: 12 },
            iletisim: { renk: '#00ff88', ikon: '📡', boyut: 12 },
            veri_merkezi: { renk: '#8855ff', ikon: '🖥', boyut: 12 },
            havalimani: { renk: '#00ccff', ikon: '✈', boyut: 12 },
            tunel: { renk: '#ff9900', ikon: '🚇', boyut: 10 },
            kopru: { renk: '#cc6600', ikon: '🌉', boyut: 10 },
            finans: { renk: '#00ff00', ikon: '💰', boyut: 12 },
            banka: { renk: '#00cc66', ikon: '🏦', boyut: 12 },
            askeri: { renk: '#ff3355', ikon: '🎯', boyut: 14 },
            su: { renk: '#0066ff', ikon: '🌊', boyut: 10 },
            siber: { renk: '#ff00ff', ikon: '🔒', boyut: 14 },
            liman: { renk: '#0088cc', ikon: '⚓', boyut: 12 },
            hastane: { renk: '#ff6699', ikon: '🏥', boyut: 12 },
            universite: { renk: '#9966ff', ikon: '🎓', boyut: 10 },
            arastirma: { renk: '#66ccff', ikon: '🔬', boyut: 12 },
            hukumet: { renk: '#ffcc33', ikon: '🏛', boyut: 14 }
        };

        // Baslatma
        document.addEventListener('DOMContentLoaded', async () => {
            // Header buton scroll indicator
            const btnGroup = document.getElementById('headerBtnGroup');
            const btnWrapper = document.getElementById('btnGroupWrapper');

            function checkHeaderScroll() {
                if (btnGroup && btnWrapper) {
                    const hasScroll = btnGroup.scrollWidth > btnGroup.clientWidth;
                    const isScrolledToEnd = btnGroup.scrollLeft + btnGroup.clientWidth >= btnGroup.scrollWidth - 10;

                    if (hasScroll && !isScrolledToEnd) {
                        btnWrapper.classList.add('has-scroll');
                    } else {
                        btnWrapper.classList.remove('has-scroll');
                    }
                }
            }

            if (btnGroup) {
                checkHeaderScroll();
                btnGroup.addEventListener('scroll', checkHeaderScroll);
                window.addEventListener('resize', checkHeaderScroll);
            }

            // iframe icinde mi kontrol et - panel.html icinden yukleniyorsa
            const isInIframe = window.parent !== window || window.self !== window.top;
            console.log('[HARITA] iframe kontrol:', {isInIframe, parentCheck: window.parent !== window, topCheck: window.self !== window.top});

            if (isInIframe) {
                document.body.classList.add('in-iframe');
                console.log('[HARITA] ✓ iframe modu AKTİF');
            } else {
                console.log('[HARITA] Normal mod (iframe değil)');
            }

            initMap();
            initShodanLayers(); // Shodan/OpenCellID katmanlarını başlat
            initSocket();
            await loadData();
            await autoGhost();
            await updateDefcon();
            startAgents();
            loadKritikAltyapi(); // Kritik altyapi noktalarini yukle
            bildirimSisteminiBaslat(); // Bildirim sistemini baslat
            geoAnalizGuncelle(); // Geo analiz durumunu guncelle
            termLog('TSUNAMI Otonom Siber Komuta Merkezi v3.0', 'info');
            termLog('Hayalet modu otomatik aktif edildi', 'ok');
            termLog('Bildirim sistemi aktif', 'ok');
            termLog('Müdahale Merkezi hazır (sol alt köşe)', 'ok');
            termLog('"yardim" ile komutları görün', 'info');

            // Müdahale modülü durumunu yükle
            loadInterventionSummary();

            // DEFCON periyodik guncelleme (her 60 saniye)
            setInterval(updateDefcon, 60000);

            // Müdahale modülü periyodik güncelleme (her 30 saniye)
            setInterval(loadInterventionSummary, 30000);

            // Ag tarama verileri periyodik guncelleme (wifi/bt/baz - her 30 saniye)
            setInterval(loadData, 30000);

            // URL parametrelerini kontrol et
            const params = new URLSearchParams(window.location.search);
            if (params.get('terminal') === '1') {
                document.getElementById('termBar').classList.add('expanded');
                const cmd = params.get('cmd') || localStorage.getItem('tsunami_terminal_cmd');
                if (cmd) {
                    termLog('Komut: ' + cmd, 'warn');
                    termLog('Bu komutu çalıştırmak için terminale yapıştırın', 'info');
                    document.getElementById('termIn').value = cmd;
                    document.getElementById('termIn').focus();
                    document.getElementById('termIn').select();
                    localStorage.removeItem('tsunami_terminal_cmd');
                }
            }

            // Araçlar sayfasından gelen AI komutunu işle
            const aiCmd = localStorage.getItem('tsunami_ai_cmd');
            if (aiCmd) {
                localStorage.removeItem('tsunami_ai_cmd');
                termLog(`[ARAÇ] Komut alındı: ${aiCmd}`, 'info');

                // AI Chat panelini aç ve komutu gönder
                setTimeout(async () => {
                    const chat = document.getElementById('aiChatPanel');
                    if (chat && !chat.classList.contains('visible')) {
                        chat.classList.add('visible');
                    }
                    addAIMessage(`🔧 ${aiCmd}`, 'user');

                    // Aracı çalıştırmayı dene
                    const aracMatch = aiCmd.match(/^(\w+)/);
                    if (aracMatch) {
                        const arac = aracMatch[1].toLowerCase();
                        termLog(`[ARAÇ] ${arac} çalıştırılıyor...`, 'info');

                        try {
                            const response = await fetch('/api/yerel/calistir', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({arac: arac, argumanlar: []})
                            });
                            const result = await response.json();

                            if (result.basarili) {
                                termLog(`[ARAÇ] ${arac} çıktısı:`, 'ok');
                                if (result.cikti) {
                                    result.cikti.split('\n').slice(0, 20).forEach(line => {
                                        termLog(`  ${line}`, 'info');
                                    });
                                }
                                addAIMessage(`✅ **${arac}** çalıştırıldı.\n\n\`\`\`\n${(result.cikti || '').slice(0, 500)}\n\`\`\``, 'assistant');
                            } else {
                                termLog(`[ARAÇ] Hata: ${result.hata || 'Bilinmeyen'}`, 'err');
                                addAIMessage(`❌ **${arac}** çalıştırılamadı: ${result.hata || 'Araç bulunamadı'}`, 'assistant');
                            }
                        } catch (e) {
                            termLog(`[ARAÇ] API hatası: ${e.message}`, 'err');
                            addAIMessage(`❌ API hatası: ${e.message}`, 'assistant');
                        }
                    }
                }, 500);
            }
        });

        // ═══════════════════════════════════════════════════════════════
        // AI TEHDIT TAHMİN SİSTEMİ (Recommendation 3)
        // ═══════════════════════════════════════════════════════════════

        const AI_TEHDIT = {
            aktif: false,
            tahminler: {},
            isiHaritasi: null,
            anomaliListesi: []
        };

        // AI tehdit tahmini yap
        function aiTehditTahmini(zamanAraliklari = ['1s', '1g', '1w']) {
            const merkez = map.getCenter();
            const bolge = {
                enlem: merkez.lat,
                boylam: merkez.lng,
                yaricap_km: 10
            };

            termLog && termLog('AI tehdit tahmini başlatılıyor...', 'ok');

            fetch('/api/harita/tehdit-tahmin', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    bolge: bolge,
                    zaman_araligi: zamanAraliklari
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.basarili) {
                    AI_TEHDIT.tahminler = data.tahminler;
                    aiTahimGoster(data.tahminler);
                    termLog && termLog('AI tahmin tamamlandı: ' + Object.keys(data.tahminler).length + ' zaman aralığı', 'ok');
                }
            })
            .catch(err => {
                console.error('[AI TEHDIT] Tahmin hatası:', err);
                termLog && termLog('AI tahmin hatası: ' + err.message, 'err');
            });
        }

        // AI tahmin sonuçlarını göster
        function aiTahminGoster(tahminler) {
            // Sol paneldeki Tehdit Analizi widget'ını güncelle
            const widget = document.querySelector('.widget[data-widget="tehdit-analizi"]');
            if (widget) {
                let html = '<div style="padding:15px;color:#fff;">';
                html += '<h4 style="color:#00b4ff;margin:0 0 10px 0;">🤖 AI Tehdit Tahmini</h4>';

                for (const [aralik, tahmin] of Object.entries(tahminler)) {
                    const riskRenk = {
                        'kritik': '#ff0000',
                        'yuksek': '#ff6600',
                        'orta': '#ffcc00',
                        'dusuk': '#00ff00',
                        'bilinmiyor': '#888888'
                    };

                    html += `
                        <div style="background:rgba(0,0,0,0.3);border-left:3px solid ${riskRenk[tahmin.risk]};padding:8px;margin-bottom:8px;border-radius:4px;">
                            <div style="font-size:11px;color:#888;margin-bottom:4px;">${aralik.toUpperCase()}</div>
                            <div style="font-size:16px;font-weight:bold;color:#fff;">${tahmin.sayisi} Tehdit</div>
                            <div style="font-size:12px;color:${riskRenk[tahmin.risk]};margin-top:4px;">
                                Risk: ${tahmin.risk.toUpperCase()}
                            </div>
                        </div>
                    `;
                }

                html += '</div>';
                widget.innerHTML = html;
            }
        }

        // Tehdit ısı haritası göster
        function tehditIsiHaritasıGoster(yaricap_km = 10) {
            const merkez = map.getCenter();
            const bolge = {
                enlem: merkez.lat,
                boylam: merkez.lng
            };

            fetch('/api/harita/tehdit-isi-haritasi', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    merkez: bolge,
                    yaricap_km: yaricap_km
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.basarili && data.noktalar) {
                    // Heatmap oluştur
                    if (AI_TEHDIT.isiHaritasi) {
                        map.removeLayer(AI_TEHDIT.isiHaritasi);
                    }

                    const heatmapNoktalar = data.noktalar.map(n => [
                        n.enlem,
                        n.boylam,
                        n.siddet
                    ]);

                    AI_TEHDIT.isiHaritasi = L.heatLayer(heatmapNoktalar, {
                        radius: 25,
                        blur: 15,
                        maxZoom: 18,
                        gradient: {
                            0.0: 'blue',
                            0.3: 'cyan',
                            0.5: 'lime',
                            0.7: 'yellow',
                            1.0: 'red'
                        }
                    }).addTo(map);

                    termLog && termLog('Tehdit ısı haritası güncellendi: ' + data.noktalar.length + ' nokta', 'ok');
                }
            })
            .catch(err => {
                console.error('[AI TEHDIT] Isı haritası hatası:', err);
            });
        }

        // Anomali tespiti yap
        function aiAnomaliTespiti() {
            // Son tehdit verilerini getir
            fetch('/api/harita/veriler')
                .then(r => r.json())
                .then(data => {
                    if (data.basarili && data.tehditler) {
                        const veriler = data.tehditler.slice(-50); // Son 50 tehdit
                        const anomaliVerisi = veriler.map(t => ({
                            timestamp: t.zaman,
                            kaynak: t.kaynak || 'bilinmiyor',
                            tip: t.tur || 'saldırı',
                            siddet: t.siddet || 1
                        }));

                        fetch('/api/harita/anomali-tespiti', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({veriler: anomaliVerisi})
                        })
                        .then(r => r.json())
                        .then(data => {
                            if (data.basarili && data.anomaliler) {
                                AI_TEHDIT.anomaliListesi = data.anomaliler;
                                console.log('[AI TEHDIT] Anomaliler tespit edildi:', data.anomaliler.length);
                                termLog && termLog(data.anomaliler.length + ' anomali tespit edildi', 'warning');
                            }
                        });
                    }
                });
        }

        // AI Panelini aç
        function aiPanelAc() {
            aiTehditTahmini();
            tehditIsiHaritasıGoster();
            aiAnomaliTespiti();
        }

        // ═══════════════════════════════════════════════════════════════
        // HARİTA - GELİŞMİŞ HATA YAKALAMA İLE
        // ═══════════════════════════════════════════════════════════════

        function initMap() {
            try {
                // Leaflet yuklu mu kontrol et
                if (typeof L === 'undefined') {
                    console.error('[HARITA] Leaflet yüklenemedi!');
                    document.getElementById('map').innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--accent-danger);font-size:14px;flex-direction:column;gap:10px"><span style="font-size:40px">⚠</span><span>Harita kütüphanesi yüklenemedi</span><span style="font-size:10px;color:var(--text-dim)">İnternet bağlantınızı kontrol edin</span></div>';
                    return;
                }

                // Map container boyut kontrolu
                const mapEl = document.getElementById('map');
                if (!mapEl || mapEl.clientHeight === 0) {
                    console.error('[HARITA] Map container boyutu 0');
                    mapEl.style.height = '100vh';
                }

                map = L.map('map', {
                    center: [TURKIYE.lat, TURKIYE.lng],
                    zoom: TURKIYE.zoom,
                    zoomControl: false,
                    preferCanvas: true
                });

                // ═══════════════════════════════════════════════════════════════════
                // GELISMIS HARITA KATMANLARI - UYDU + SOKAK SEVIYESI ZOOM
                // ═══════════════════════════════════════════════════════════════════

                // BASE LAYERS - Temel Harita Katmanlari
                const baseLayers = {};

                // 1. ESRI World Imagery - UCRETSIZ Uydu Goruntusu (Zoom 19'a kadar)
                baseLayers['Uydu (ESRI)'] = L.tileLayer(
                    'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    maxZoom: 19,
                    attribution: '&copy; Esri, Maxar, GeoEye, Earthstar, CNES/Airbus DS'
                });

                // 2. ESRI Uydu + Etiketler (Hybrid)
                const esriSatelliteLabels = L.layerGroup([
                    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                        maxZoom: 19
                    }),
                    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', {
                        maxZoom: 19
                    })
                ]);
                baseLayers['Uydu + Etiket'] = esriSatelliteLabels;

                // 3. Google Hybrid (Uydu + Yol) - Yuksek Cozunurluk
                baseLayers['Google Uydu'] = L.tileLayer(
                    'https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
                    maxZoom: 21,
                    attribution: '&copy; Google Maps'
                });

                // 4. Google Sokak Haritasi
                baseLayers['Google Harita'] = L.tileLayer(
                    'https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
                    maxZoom: 21,
                    attribution: '&copy; Google Maps'
                });

                // 5. CartoDB Dark - Siber Tema (Varsayilan)
                baseLayers['Siber Mod'] = L.tileLayer(
                    'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    maxZoom: 19,
                    subdomains: 'abcd',
                    attribution: '&copy; CartoDB &copy; OpenStreetMap'
                });

                // 6. OpenStreetMap Detayli
                baseLayers['Detayli Harita'] = L.tileLayer(
                    'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '&copy; OpenStreetMap contributors'
                });

                // 7. Stadia Dark Smooth
                baseLayers['Stadia Karanlik'] = L.tileLayer(
                    'https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png', {
                    maxZoom: 20,
                    attribution: '&copy; Stadia Maps'
                });

                // 8. Terrain/Arazi Haritasi
                baseLayers['Arazi'] = L.tileLayer(
                    'https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
                    maxZoom: 19,
                    attribution: '&copy; Esri World Topo'
                });

                // OVERLAY LAYERS - Ek Bilgi Katmanlari
                const overlayLayers = {};

                // Trafik Katmani (Google)
                overlayLayers['Canli Trafik'] = L.tileLayer(
                    'https://mt1.google.com/vt/lyrs=h,traffic&x={x}&y={y}&z={z}', {
                    maxZoom: 21,
                    opacity: 0.7
                });

                // Bina 3D Golgeler (OSM Buildings)
                overlayLayers['Binalar'] = L.tileLayer(
                    'https://{s}.data.osmbuildings.org/0.2/anonymous/tile/{z}/{x}/{y}.json', {
                    maxZoom: 19,
                    subdomains: 'abcd'
                });

                // Varsayilan olarak Siber Mod'u yukle
                baseLayers['Siber Mod'].addTo(map);
                console.log('[HARITA] Base layer yuklendi: Siber Mod');

                // Katman Kontrolu Ekle
                window.layerControl = L.control.layers(baseLayers, overlayLayers, {
                    position: 'topright',
                    collapsed: true
                }).addTo(map);

                // Aktif base layer takibi
                window.activeBaseLayer = 'Siber Mod';
                map.on('baselayerchange', function(e) {
                    window.activeBaseLayer = e.name;
                    console.log('[HARITA] Base layer degisti:', e.name);
                    termLog('[HARITA] ' + e.name + ' katmani aktif', 'ok');
                });

                // Zoom seviyesi gostergesi
                map.on('zoomend', function() {
                    const zoom = map.getZoom();
                    const zoomInfo = document.getElementById('zoomLevelInfo');
                    if (zoomInfo) {
                        zoomInfo.textContent = 'Zoom: ' + zoom;
                        if (zoom >= 18) {
                            zoomInfo.style.color = '#00ff88';
                            zoomInfo.textContent += ' (Sokak Seviyesi)';
                        } else if (zoom >= 15) {
                            zoomInfo.style.color = '#00b4ff';
                            zoomInfo.textContent += ' (Mahalle)';
                        } else if (zoom >= 12) {
                            zoomInfo.style.color = '#ffaa00';
                            zoomInfo.textContent += ' (Ilce)';
                        } else {
                            zoomInfo.style.color = '#ff3355';
                            zoomInfo.textContent += ' (Sehir)';
                        }
                    }
                });

                L.control.zoom({ position: 'bottomright' }).addTo(map);
                Object.values(layers).forEach(l => map.addLayer(l));

                // D3 katmani
                if (typeof d3 !== 'undefined') {
                    const svg = d3.select(map.getPanes().overlayPane).append('svg').attr('class', 'attack-svg-layer').style('position', 'absolute').style('pointer-events', 'none');
                    window.atkGroup = svg.append('g');
                    map.on('moveend zoomend', updateSvg);
                    updateSvg();
                } else {
                    console.warn('[HARITA] D3 yüklenemedi, saldırı animasyonları devre dışı');
                }

                // Harita tiklama - Street View
                map.on('click', e => {
                    openStreetView(e.latlng.lat, e.latlng.lng);
                });

                // Global OSINT altyapi katmanlari icin moveend eventi (debounced)
                let infraUpdateTimeout = null;
                map.on('moveend', () => {
                    if (infraUpdateTimeout) clearTimeout(infraUpdateTimeout);
                    infraUpdateTimeout = setTimeout(() => {
                        if (typeof onMapMoveEnd === 'function') {
                            onMapMoveEnd();
                        }
                    }, 500); // 500ms debounce
                });

                // Haritanin hazir oldugunu bildir
                console.log('[HARITA] Harita başarıyla yüklendi');
                termLog && termLog('Harita yüklendi', 'ok');

                // Boyut duzeltmesi icin invalidateSize cagir
                setTimeout(() => {
                    map.invalidateSize();
                    // Aerospace layer'larını başlat (map hazır olduktan sonra)
                    if (typeof initAerospaceLayers === 'function') {
                        initAerospaceLayers();
                        console.log('[AEROSPACE] Layer\'lar başlatıldı');
                    }
                }, 100);

            } catch (e) {
                console.error('[HARITA] Başlatılamadı:', e);
                document.getElementById('map').innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--accent-danger);font-size:14px;flex-direction:column;gap:10px"><span style="font-size:40px">✕</span><span>Harita yüklenemedi</span><span style="font-size:10px;color:var(--text-dim)">' + e.message + '</span></div>';
            }
        }

        function updateSvg() {
            const b = map.getBounds();
            const tl = map.latLngToLayerPoint(b.getNorthWest());
            const br = map.latLngToLayerPoint(b.getSouthEast());
            d3.select('.attack-svg-layer').attr('width', br.x - tl.x + 200).attr('height', br.y - tl.y + 200).style('left', (tl.x - 100) + 'px').style('top', (tl.y - 100) + 'px');
            window.atkGroup.attr('transform', `translate(${-tl.x + 100},${-tl.y + 100})`);
        }

        // Sesli Bildirim Kontrol - Surekli calmasini onle
        let sonSesliUyariZamani = 0;
        const SESLI_UYARI_BEKLEME = 30000; // 30 saniye bekleme
        let kritikSaldiriSayisi = 0;

        function sesliUyariKontrollu(mesaj, zorunlu = false) {
            const simdi = Date.now();
            if (zorunlu || (simdi - sonSesliUyariZamani > SESLI_UYARI_BEKLEME)) {
                sesliUyari(mesaj);
                sonSesliUyariZamani = simdi;
            }
        }

        // Socket
        function initSocket() {
            socket = io({ transports: ['polling'] });
            socket.on('connect', () => termLog('Sunucuya baglandi', 'ok'));

            socket.on('canli_saldiri', data => {
                animateAttack(data);
                addAttackFeed(data);
                attackCount++;

                // mAtk elementi varsa güncelle, yoksa parent'a mesaj gönder
                const mAtkEl = document.getElementById('mAtk');
                if (mAtkEl) {
                    mAtkEl.textContent = attackCount;
                } else if (window.parent !== window) {
                    // iframe içindeyiz, parent'a bildir (panel.html formatında)
                    window.parent.postMessage({
                        type: 'TSUNAMI_HARITA_RESPONSE',
                        action: 'ATTACK_COUNT',
                        count: attackCount
                    }, '*');
                }

                // Kritik ve yuksek saldirilar icin bildirim
                if (data.saldiri && (data.saldiri.ciddiyet === 'critical' || data.saldiri.ciddiyet === 'high')) {
                    kritikSaldiriSayisi++;

                    // Her kritik saldiri icin aninda bildirim
                    if (data.saldiri.ciddiyet === 'critical') {
                        kritikSaldiriBildirimi(data);

                        // AI destekli tehdit analizi (her 3. kritik saldirida)
                        if (kritikSaldiriSayisi % 3 === 0) {
                            aiTehditAnalizi(data);
                        }
                    }

                    // 5 kritik saldiri biriktiginde toplu uyari
                    if (kritikSaldiriSayisi >= 5) {
                        sesliUyariKontrollu('Dikkat! ' + kritikSaldiriSayisi + ' kritik saldiri tespit edildi. Sistem yuksek tehdit altinda!', true);
                        kritikSaldiriSayisi = 0;
                    }
                }
            });

            socket.on('tarama_sonuc', d => {
                if (d.tip === 'wifi') updateWifi(d.sonuclar);
                else if (d.tip === 'bluetooth') updateBt(d.sonuclar);
                termLog(`${d.sonuclar.length} ${d.tip} bulundu`, 'ok');
                sesliUyariKontrollu(d.sonuclar.length + ' adet ' + d.tip + ' cihazi bulundu. Tarama tamamlandi.');
            });

            socket.on('tehdit_algilandi', d => {
                termLog(`[!] TEHDIT: ${d.tip} - ${d.hedef}`, 'err');
                // Tehditler icin sesli uyari zorunlu
                sesliUyariKontrollu('Uyari! ' + d.tip + ' tehdidi algilandi. Hedef: ' + d.hedef, true);
            });

            // ============================================
            // LIVE THREAT STREAM - Palantir-Style Real-Time Threats
            // ============================================

            // Live threat stream start notification
            socket.on('canli_tehdit_stream_baslat', data => {
                termLog(`[CANLI_TEHDIT] Stream başlatıldı - ${data.duration} dakika`, 'ok');

                // Show notification
                if (window.parent !== window) {
                    window.parent.postMessage({
                        type: 'TSUNAMI_HARITA_RESPONSE',
                        action: 'LIVE_THREAT_STREAM_START',
                        data: data
                    }, '*');
                }
            });

            // Live threat stream stop notification
            socket.on('canli_tehdit_stream_durdur', data => {
                termLog('[CANLI_TEHDIT] Stream durduruldu', 'info');
            });

            // New live threat event - Palantir-style ping animation
            socket.on('yeni_canli_tehdit', threat => {
                addLiveThreatToMap(threat);
            });

            // Saldiri akisini baslat
            socket.emit('saldiri_akisi_baslat');
        }

        // Saldiri Animasyonu
        function animateAttack(data) {
            // Koordinat validasyonu - gecersiz koordinatlari atla
            if (!data || !data.kaynak || !data.hedef) {
                console.warn('[SALDIRI] Gecersiz veri yapisi, atlaniyor');
                return;
            }

            const srcLat = data.kaynak.lat;
            const srcLng = data.kaynak.lng;

            // (0,0) veya cok kucuk koordinatlari reddet (sessizce atla)
            if (!srcLat || !srcLng ||
                (Math.abs(srcLat) < 1 && Math.abs(srcLng) < 1)) {
                return; // Gecersiz koordinatlar sessizce atlanir
            }

            const src = map.latLngToLayerPoint([srcLat, srcLng]);
            const tgt = map.latLngToLayerPoint([data.hedef.lat, data.hedef.lng]);

            const mx = (src.x + tgt.x) / 2;
            const my = (src.y + tgt.y) / 2;
            const dist = Math.hypot(tgt.x - src.x, tgt.y - src.y);
            const arcH = Math.min(dist * 0.4, 80);

            const path = `M ${src.x} ${src.y} Q ${mx} ${my - arcH} ${tgt.x} ${tgt.y}`;
            const arc = window.atkGroup.append('path')
                .attr('class', 'attack-arc')
                .attr('d', path)
                .attr('stroke', data.saldiri.renk)
                .attr('stroke-width', data.saldiri.ciddiyet === 'critical' ? 3 : 2)
                .attr('opacity', 0.9)
                .attr('filter', `drop-shadow(0 0 4px ${data.saldiri.renk})`);

            const len = arc.node().getTotalLength();
            arc.attr('stroke-dasharray', `${len} ${len}`)
                .attr('stroke-dashoffset', len)
                .transition().duration(1200).ease(d3.easeLinear)
                .attr('stroke-dashoffset', 0)
                .on('end', () => {
                    createImpact(tgt, data.saldiri.renk, data);
                    arc.transition().duration(400).attr('opacity', 0).remove();
                });

            createPulse(src, data.saldiri.renk);
        }

        function createImpact(pt, color, data) {
            const impact = window.atkGroup.append('circle')
                .attr('cx', pt.x).attr('cy', pt.y).attr('r', 4)
                .attr('fill', color).attr('opacity', 1);
            impact.transition().duration(600).attr('r', 25).attr('opacity', 0).remove();

            // Marker ekle
            const m = L.circleMarker([data.hedef.lat, data.hedef.lng], {
                radius: 6, fillColor: color, color: '#fff', weight: 2, fillOpacity: 0.8
            });

            // Tooltip - Click ile sabitle, hover ile göster
            m.on('mouseover', e => {
                if (!tooltipPinned) showTooltip(e, data);
            });
            m.on('mouseout', () => {
                if (!tooltipPinned) hideTooltip();
            });
            m.on('click', e => {
                // Event propagation durdur (map click'in Street View açmasını engelle)
                L.DomEvent.stopPropagation(e);
                // Tooltip'i sabitle ve göster
                showTooltip(e, data);
                pinTooltip();
            });

            attackData.set(data.id, data);
            layers.atk.addLayer(m);

            // Eski saldiri markerlarini temizle
            if (layers.atk.getLayers().length > 50) {
                const first = layers.atk.getLayers()[0];
                layers.atk.removeLayer(first);
            }
        }

        function createPulse(pt, color) {
            const pulse = window.atkGroup.append('circle')
                .attr('cx', pt.x).attr('cy', pt.y).attr('r', 3)
                .attr('fill', 'none').attr('stroke', color).attr('stroke-width', 2).attr('opacity', 0.8);
            pulse.transition().duration(500).attr('r', 15).attr('opacity', 0).remove();
        }

        // Tooltip
        function showTooltip(e, data, feedMode = false) {
            // Mevcut saldiri verisini sakla (aksiyon butonlari icin)
            currentTooltipData = data;

            const tt = document.getElementById('attackTooltip');
            document.getElementById('ttType').textContent = data.saldiri.tip;
            document.getElementById('ttType').style.color = data.saldiri.renk;
            document.getElementById('ttSeverity').textContent = data.saldiri.ciddiyet.toUpperCase();
            document.getElementById('ttSeverity').className = 'tooltip-severity ' + data.saldiri.ciddiyet;
            document.getElementById('ttSrcIP').textContent = data.kaynak.ip;
            document.getElementById('ttSrcCountry').textContent = data.kaynak.ulke;
            document.getElementById('ttTarget').textContent = data.hedef.sehir + ' (' + data.hedef.ip + ')';
            document.getElementById('ttPort').textContent = data.saldiri.port || 'N/A';
            document.getElementById('ttProtocol').textContent = data.saldiri.protokol;
            document.getElementById('ttPackets').textContent = data.saldiri.paket_sayisi?.toLocaleString() || 'N/A';
            document.getElementById('ttBandwidth').textContent = data.saldiri.bant_genisligi || 'N/A';

            // Pozisyonu ayarla
            if (feedMode && e.target) {
                // Feed item'dan acildiginda yaninda goster
                const rect = e.target.closest('.atk-item').getBoundingClientRect();
                tt.classList.add('feed-mode');
                tt.style.left = (rect.right + 10) + 'px';
                tt.style.top = rect.top + 'px';
                tt.style.bottom = 'auto';
                tt.style.right = 'auto';
            } else if (e.latlng && map) {
                // Harita noktasinin ustunde goster
                const point = map.latLngToContainerPoint(e.latlng);
                tt.classList.remove('feed-mode');
                tt.style.left = point.x + 'px';
                tt.style.top = (point.y - 20) + 'px';
                tt.style.bottom = 'auto';
                tt.style.right = 'auto';
            } else if (e.containerPoint) {
                // Leaflet event'ten
                tt.classList.remove('feed-mode');
                tt.style.left = e.containerPoint.x + 'px';
                tt.style.top = (e.containerPoint.y - 20) + 'px';
                tt.style.bottom = 'auto';
                tt.style.right = 'auto';
            }

            tt.classList.add('visible');
        }

        function hideTooltip() {
            const tt = document.getElementById('attackTooltip');
            tt.classList.remove('visible');
            tt.classList.remove('feed-mode');
            tt.classList.remove('pinned');
            tooltipPinned = false;
            // Secili feed item'i kaldir
            document.querySelectorAll('.atk-item.selected').forEach(el => el.classList.remove('selected'));
        }

        // Tooltip'i zorla kapat (butondan)
        function closeTooltip() {
            hideTooltip();
            currentTooltipData = null;
        }

        // Tooltip aksiyon fonksiyonlari
        let currentTooltipData = null;
        let tooltipPinned = false;

        // Tooltip'i sabitle (click ile açıldıysa)
        function pinTooltip() {
            tooltipPinned = true;
            const tt = document.getElementById('attackTooltip');
            if (tt) {
                tt.classList.add('pinned');
            }
        }

        // Tooltip'i serbest bırak
        function unpinTooltip() {
            tooltipPinned = false;
            const tt = document.getElementById('attackTooltip');
            if (tt) {
                tt.classList.remove('pinned');
            }
        }

        // IP Engelleme
        async function ipEngelle() {
            if (!currentTooltipData) return;
            const ip = currentTooltipData.kaynak.ip;

            try {
                const response = await fetch('/api/beyin/komut', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        komut: 'ip_engelle',
                        ip: ip,
                        sebep: `Saldiri tespiti: ${currentTooltipData.saldiri.tip}`
                    })
                });
                const result = await response.json();
                sesliUyariKontrollu(`IP engellendi: ${ip}`, true);
                termLog(`IP engellendi: ${ip}`, 'warn');
                hideTooltip();
            } catch (e) {
                termLog(`IP engelleme hatasi: ${e.message}`, 'err');
            }
        }

        // OSINT Analizi
        async function osintAnaliz() {
            if (!currentTooltipData) return;
            const ip = currentTooltipData.kaynak.ip;

            if (!ip || ip === 'N/A') {
                termLog('[OSINT] Gecerli IP adresi yok', 'err');
                return;
            }

            termLog(`[OSINT] Analiz baslatiliyor: ${ip}`, 'info');
            sesliUyariKontrollu(`OSINT analizi: ${ip}`);

            try {
                // Backend GET endpoint kullanir: /api/osint/ip/<ip>
                const response = await fetch(`/api/osint/ip/${encodeURIComponent(ip)}`);
                const result = await response.json();

                if (result.basarili || result.ip) {
                    termLog(`[OSINT] Sonuc: ${ip}`, 'ok');
                    termLog(`  Ulke: ${result.ulke || result.country || currentTooltipData.kaynak.ulke}`, 'info');
                    termLog(`  Sehir: ${result.sehir || result.city || 'Bilinmiyor'}`, 'info');
                    termLog(`  ISP: ${result.isp || 'Bilinmiyor'}`, 'info');
                    termLog(`  ASN: ${result.asn || 'Bilinmiyor'}`, 'info');
                    termLog(`  Org: ${result.org || 'Bilinmiyor'}`, 'info');

                    // Tehdit bilgisi varsa
                    if (result.tehdit_skoru) {
                        termLog(`  Tehdit Skoru: ${result.tehdit_skoru}`, result.tehdit_skoru > 50 ? 'warn' : 'info');
                    }

                    // Portlar varsa
                    if (result.portlar && result.portlar.length > 0) {
                        termLog(`  Acik Portlar: ${result.portlar.slice(0, 10).join(', ')}`, 'info');
                    }

                    // AI Chat panelinde detayli goster
                    addAIMessage(`**OSINT Raporu: ${ip}**\n\n` +
                        `- **Ulke:** ${result.ulke || result.country || 'Bilinmiyor'}\n` +
                        `- **Sehir:** ${result.sehir || result.city || 'Bilinmiyor'}\n` +
                        `- **ISP:** ${result.isp || 'Bilinmiyor'}\n` +
                        `- **ASN:** ${result.asn || 'Bilinmiyor'}\n` +
                        `- **Org:** ${result.org || 'Bilinmiyor'}\n` +
                        (result.portlar ? `- **Portlar:** ${result.portlar.slice(0, 10).join(', ')}\n` : ''),
                        'assistant');

                    // Bildirim
                    bildirimEkle({
                        tip: 'osint',
                        baslik: 'OSINT Analizi Tamamlandi',
                        aciklama: `${ip} - ${result.ulke || result.country || currentTooltipData.kaynak.ulke}`
                    });
                } else {
                    termLog(`[OSINT] Veri bulunamadi veya hata: ${result.hata || 'Bilinmeyen'}`, 'warn');
                }
            } catch (e) {
                // Fallback - basit bilgi goster
                termLog(`[OSINT] API hatasi, temel bilgiler:`, 'warn');
                termLog(`  IP: ${ip}`, 'info');
                termLog(`  Ulke: ${currentTooltipData.kaynak.ulke}`, 'info');
                termLog(`  Saldiri: ${currentTooltipData.saldiri.tip}`, 'info');
                termLog(`  Port: ${currentTooltipData.saldiri.port}`, 'info');
            }

            hideTooltip();
        }

        // Rapor Olustur
        function raporOlustur() {
            if (!currentTooltipData) return;

            const rapor = {
                zaman: new Date().toISOString(),
                saldiri_id: currentTooltipData.id,
                kaynak: currentTooltipData.kaynak,
                hedef: currentTooltipData.hedef,
                saldiri: currentTooltipData.saldiri
            };

            termLog('=== SALDIRI RAPORU ===', 'warn');
            termLog(`ID: ${rapor.saldiri_id}`, 'info');
            termLog(`Zaman: ${new Date(rapor.zaman).toLocaleString('tr-TR')}`, 'info');
            termLog(`Kaynak: ${rapor.kaynak.ulke} (${rapor.kaynak.ip})`, 'info');
            termLog(`Hedef: ${rapor.hedef.sehir} (${rapor.hedef.ip})`, 'info');
            termLog(`Tip: ${rapor.saldiri.tip}`, 'info');
            termLog(`Ciddiyet: ${rapor.saldiri.ciddiyet.toUpperCase()}`, 'info');
            termLog(`Protokol: ${rapor.saldiri.protokol}:${rapor.saldiri.port}`, 'info');
            termLog('======================', 'warn');

            // Terminal'i ac
            document.getElementById('termBar').classList.add('expanded');

            hideTooltip();
            sesliUyariKontrollu('Saldiri raporu olusturuldu');
        }

        // ==================== TSUNAMI GÜÇ FONKSİYONLARI ====================

        // AI Saldiri Analizi
        async function aiSaldiriAnaliz() {
            if (!currentTooltipData) return;
            termLog('[TSUNAMI] AI saldiri analizi baslatiliyor...', 'info');
            sesliUyariKontrollu('AI analizi baslatiliyor');

            try {
                const response = await fetch('/api/llm/analiz', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        veri: {
                            saldiri_tipi: currentTooltipData.saldiri.tip,
                            kaynak_ulke: currentTooltipData.kaynak.ulke,
                            kaynak_ip: currentTooltipData.kaynak.ip,
                            hedef_sehir: currentTooltipData.hedef.sehir,
                            hedef_ip: currentTooltipData.hedef.ip,
                            ciddiyet: currentTooltipData.saldiri.ciddiyet,
                            port: currentTooltipData.saldiri.port,
                            protokol: currentTooltipData.saldiri.protokol
                        },
                        tip: 'saldiri_analiz'
                    })
                });

                const sonuc = await response.json();
                // API 'analiz' veya 'sonuc' döndürebilir
                const analizSonucu = sonuc.analiz || sonuc.sonuc;

                if (sonuc.basarili && analizSonucu) {
                    const mesaj = typeof analizSonucu === 'string'
                        ? analizSonucu
                        : (analizSonucu.sonuc || analizSonucu.aciklama || JSON.stringify(analizSonucu));

                    addAIMessage(`🎯 **Saldırı Analizi**\n\n**Tip:** ${currentTooltipData.saldiri.tip}\n**Kaynak:** ${currentTooltipData.kaynak.ulke} (${currentTooltipData.kaynak.ip})\n**Hedef:** ${currentTooltipData.hedef.sehir}\n**Ciddiyet:** ${currentTooltipData.saldiri.ciddiyet}\n\n**AI Değerlendirmesi:**\n${mesaj}`, 'assistant');

                    // AI chat panelini aç
                    const chat = document.getElementById('aiChatPanel');
                    if (chat && !chat.classList.contains('visible')) {
                        chat.classList.add('visible');
                    }
                    termLog('[TSUNAMI] AI analizi tamamlandi', 'ok');
                    sesliUyariKontrollu('AI saldiri analizi tamamlandi');

                    // Bildirim ekle
                    bildirimEkle({
                        tip: 'ai',
                        baslik: 'AI Analizi Tamamlandi',
                        aciklama: `${currentTooltipData.saldiri.tip} - ${currentTooltipData.kaynak.ulke}`
                    });
                } else {
                    termLog('[TSUNAMI] AI sonucu alinamadi', 'warn');
                    // Fallback bilgi göster
                    addAIMessage(`🎯 **Saldırı Özeti**\n\n**Tip:** ${currentTooltipData.saldiri.tip}\n**Kaynak:** ${currentTooltipData.kaynak.ulke}\n**Hedef:** ${currentTooltipData.hedef.sehir}\n**Port:** ${currentTooltipData.saldiri.port}\n\n_AI modülü yanıt vermedi._`, 'assistant');
                }
            } catch (e) {
                termLog(`[TSUNAMI] AI analiz hatasi: ${e.message}`, 'err');
                // Fallback
                addAIMessage(`🎯 **Saldırı Bilgisi**\n\n**Tip:** ${currentTooltipData.saldiri.tip}\n**Kaynak:** ${currentTooltipData.kaynak.ulke} (${currentTooltipData.kaynak.ip})\n**Hedef:** ${currentTooltipData.hedef.sehir}\n**Ciddiyet:** ${currentTooltipData.saldiri.ciddiyet}`, 'assistant');
            }
            hideTooltip();
        }

        // Karsi Saldiri (Simule)
        async function karsiSaldiri() {
            if (!currentTooltipData) return;

            const ip = currentTooltipData.kaynak.ip;
            termLog(`[TSUNAMI] Karşı saldırı hedefi: ${ip}`, 'warn');

            // Onay iste
            if (!confirm(`⚠️ DIKKAT!\n\nKarşı saldırı başlatılacak.\nHedef: ${ip}\n\nBu işlem geri alınamaz. Devam etmek istiyor musunuz?`)) {
                return;
            }

            try {
                const response = await fetch('/api/beyin/komut', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        komut: 'karsi_saldiri',
                        hedef_ip: ip,
                        saldiri_tipi: 'savunma',
                        kaynak_saldiri: currentTooltipData.saldiri.tip
                    })
                });

                const result = await response.json();
                termLog(`[TSUNAMI] Karşı saldırı başlatıldı: ${ip}`, 'warn');
                sesliUyariKontrollu(`Karşı saldırı başlatıldı. Hedef: ${ip}`, true);

                // Bildirim ekle
                bildirimEkle({
                    tip: 'counter',
                    baslik: 'Karşı Saldırı Başlatıldı',
                    aciklama: `Hedef: ${ip} (${currentTooltipData.kaynak.ulke})`
                });
            } catch (e) {
                termLog(`[TSUNAMI] Karşı saldırı hatası: ${e.message}`, 'err');
            }
            hideTooltip();
        }

        // Saldiri Izleme
        async function saldiriIzle() {
            if (!currentTooltipData) return;

            const ip = currentTooltipData.kaynak.ip;
            termLog(`[TSUNAMI] IP izlemeye aliniyor: ${ip}`, 'info');

            // Izleme listesine ekle (lokal)
            if (!window.izlenenIPler) window.izlenenIPler = new Set();
            window.izlenenIPler.add(ip);

            // Backend'e bildir
            try {
                const response = await fetch('/api/beyin/komut', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        komut: 'ip_izle',
                        ip: ip,
                        ulke: currentTooltipData.kaynak.ulke,
                        saldiri_tipi: currentTooltipData.saldiri.tip
                    })
                });
                const result = await response.json();

                if (result.basarili) {
                    termLog(`[TSUNAMI] IP backend'de izlemeye alindi: ${ip}`, 'ok');
                }
            } catch (e) {
                // Backend hatası olsa da lokal izleme devam eder
                termLog(`[TSUNAMI] Backend izleme kaydı hatasi (lokal devam ediyor): ${e.message}`, 'warn');
            }

            sesliUyariKontrollu(`${ip} izlemeye alındı`);

            // Bildirim ekle
            bildirimEkle({
                tip: 'watch',
                baslik: 'IP İzlemeye Alındı',
                aciklama: `${ip} (${currentTooltipData.kaynak.ulke})`
            });

            // İzlenen IP'leri terminalde göster
            termLog(`[İZLEME] Toplam izlenen IP sayısı: ${window.izlenenIPler.size}`, 'info');

            hideTooltip();
        }

        // ==================== SHODAN / OPENCELLID FONKSİYONLARI ====================

        // Shodan ve OpenCellID için harita katmanları
        let shodanLayer = L.layerGroup();
        let cellTowerLayer = L.layerGroup();
        let vulnLayer = L.layerGroup();

        // Katmanları haritaya ekle (initMap sonrası)
        function initShodanLayers() {
            if (map) {
                shodanLayer.addTo(map);
                cellTowerLayer.addTo(map);
                vulnLayer.addTo(map);
            }
        }

        // Shodan tarama
        async function shodanScan() {
            if (!currentTooltipData) return;
            const ip = currentTooltipData.kaynak.ip;

            if (!ip || ip === 'N/A') {
                termLog('[SHODAN] Geçerli IP adresi yok', 'err');
                return;
            }

            termLog(`[SHODAN] Tarama başlatıldı: ${ip}`, 'info');
            sesliUyariKontrollu(`Shodan taraması başlatıldı: ${ip}`);

            try {
                const response = await fetch('/api/shodan/konum-harita', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ip: ip})
                });

                const data = await response.json();

                if (data.basarili && data.cihazlar && data.cihazlar.length > 0) {
                    const cihaz = data.cihazlar[0];

                    // Haritaya marker ekle
                    const marker = L.marker([cihaz.lat, cihaz.lng], {
                        icon: L.divIcon({
                            className: 'shodan-marker',
                            html: `<div class="shodan-icon">🖥️</div>`,
                            iconSize: [30, 30]
                        })
                    }).addTo(shodanLayer);

                    // Popup içeriği
                    let vulnHtml = cihaz.zafiyetler && cihaz.zafiyetler.length > 0
                        ? `<div class="vulns" style="color:#ff6b6b">${cihaz.zafiyetler.slice(0, 5).join(', ')}</div>`
                        : '<div class="no-vulns" style="color:#4caf50">Bilinen zafiyet yok</div>';

                    marker.bindPopup(`
                        <div class="shodan-popup">
                            <h4>${ip}</h4>
                            <div><strong>Org:</strong> ${cihaz.org || 'N/A'}</div>
                            <div><strong>ISP:</strong> ${cihaz.isp || 'N/A'}</div>
                            <div><strong>OS:</strong> ${cihaz.os || 'N/A'}</div>
                            <div><strong>Portlar:</strong> ${cihaz.portlar ? cihaz.portlar.slice(0, 10).join(', ') : 'N/A'}</div>
                            <div><strong>Zafiyetler:</strong></div>
                            ${vulnHtml}
                        </div>
                    `).openPopup();

                    // Haritayı odakla
                    map.setView([cihaz.lat, cihaz.lng], 10);

                    const portCount = cihaz.portlar ? cihaz.portlar.length : 0;
                    const vulnCount = cihaz.zafiyetler ? cihaz.zafiyetler.length : 0;
                    termLog(`[SHODAN] ${portCount} port, ${vulnCount} zafiyet bulundu`, 'ok');
                    sesliUyariKontrollu(`Shodan: ${portCount} port, ${vulnCount} zafiyet bulundu`);

                    // Bildirim ekle
                    bildirimEkle({
                        tip: vulnCount > 0 ? 'high' : 'info',
                        baslik: 'Shodan Tarama Sonucu',
                        aciklama: `${ip}: ${portCount} port, ${vulnCount} zafiyet`
                    });
                } else {
                    termLog('[SHODAN] Sonuç bulunamadı veya hata: ' + (data.hata || 'Bilinmiyor'), 'warn');
                }
            } catch (error) {
                termLog(`[SHODAN] Hata: ${error.message}`, 'err');
            }

            hideTooltip();
        }

        // Yakın baz istasyonlarını bul
        async function findNearbyTowers() {
            if (!currentTooltipData) return;

            const lat = currentTooltipData.kaynak.lat;
            const lng = currentTooltipData.kaynak.lng;

            if (!lat || !lng || (lat === 0 && lng === 0)) {
                termLog('[OPENCELLID] Geçerli koordinat yok', 'err');
                return;
            }

            termLog(`[OPENCELLID] Baz istasyonları aranıyor: ${lat.toFixed(4)}, ${lng.toFixed(4)}`, 'info');
            sesliUyariKontrollu('Baz istasyonları aranıyor');

            try {
                const response = await fetch('/api/opencellid/harita', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({lat: lat, lng: lng, yaricap: 5})
                });

                const data = await response.json();

                if (data.basarili && data.kuleler && data.kuleler.length > 0) {
                    // Mevcut kule markerlarını temizle
                    cellTowerLayer.clearLayers();

                    data.kuleler.forEach(kule => {
                        // Sinyal gücüne göre renk
                        const sinyalRenk = kule.sinyal > -60 ? '#00ff00' :
                                           kule.sinyal > -80 ? '#ffff00' : '#ff0000';

                        // Radio tipine göre ikon
                        const radioIkon = {
                            'LTE': '4️⃣',
                            'NR': '5️⃣',
                            'UMTS': '3️⃣',
                            'GSM': '2️⃣'
                        }[kule.radio] || '📶';

                        const marker = L.marker([kule.lat, kule.lng], {
                            icon: L.divIcon({
                                className: 'cell-tower-marker',
                                html: `<div class="tower-icon" style="border-color:${sinyalRenk}">${radioIkon}</div>`,
                                iconSize: [35, 35]
                            })
                        }).addTo(cellTowerLayer);

                        // Kapsama alanı çemberi
                        L.circle([kule.lat, kule.lng], {
                            radius: kule.kapsama || 500,
                            color: sinyalRenk,
                            fillColor: sinyalRenk,
                            fillOpacity: 0.1,
                            weight: 1
                        }).addTo(cellTowerLayer);

                        marker.bindPopup(`
                            <div class="tower-popup">
                                <h4>${kule.operator}</h4>
                                <div><strong>Tip:</strong> ${kule.radio}</div>
                                <div><strong>MCC/MNC:</strong> ${kule.mcc}/${kule.mnc}</div>
                                <div><strong>LAC:</strong> ${kule.lac}</div>
                                <div><strong>Cell ID:</strong> ${kule.cid}</div>
                                <div><strong>Sinyal:</strong> ${kule.sinyal} dBm</div>
                                <div><strong>Kapsama:</strong> ${kule.kapsama}m</div>
                            </div>
                        `);
                    });

                    // Haritayı odakla
                    map.setView([lat, lng], 14);

                    termLog(`[OPENCELLID] ${data.kuleler.length} baz istasyonu bulundu`, 'ok');
                    sesliUyariKontrollu(`${data.kuleler.length} baz istasyonu bulundu`);

                    // Bildirim ekle
                    bildirimEkle({
                        tip: 'info',
                        baslik: 'Baz İstasyonları',
                        aciklama: `${data.kuleler.length} kule bulundu (${data.demo ? 'Demo' : 'Gerçek'})`
                    });
                } else {
                    termLog('[OPENCELLID] Baz istasyonu bulunamadı', 'warn');
                }
            } catch (error) {
                termLog(`[OPENCELLID] Hata: ${error.message}`, 'err');
            }

            hideTooltip();
        }

        // Zafiyetli cihazları bul
        async function findVulnDevices() {
            if (!currentTooltipData) return;
            const ip = currentTooltipData.kaynak.ip;

            if (!ip || ip === 'N/A') {
                termLog('[VULN] Geçerli IP adresi yok', 'err');
                return;
            }

            termLog(`[VULN] Zafiyet taraması başlatıldı: ${ip}`, 'info');
            sesliUyariKontrollu('Zafiyet taraması başlatılıyor');

            try {
                // Önce IP'nin subnet'ini al (class C)
                const subnet = ip.split('.').slice(0, 3).join('.') + '.0/24';

                const response = await fetch('/api/shodan/zafiyet-harita', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({query: `net:${subnet} has_vuln:true`})
                });

                const data = await response.json();

                if (data.basarili && data.cihazlar && data.cihazlar.length > 0) {
                    // Zafiyet markerları ekle
                    data.cihazlar.forEach(cihaz => {
                        if (cihaz.vulns && cihaz.vulns.length > 0) {
                            const marker = L.marker([cihaz.lat, cihaz.lng], {
                                icon: L.divIcon({
                                    className: 'vuln-marker',
                                    html: `<div class="vuln-icon">⚠️</div><span class="vuln-count">${cihaz.vulns.length}</span>`,
                                    iconSize: [40, 40]
                                })
                            }).addTo(vulnLayer);

                            marker.bindPopup(`
                                <div class="vuln-popup">
                                    <h4>${cihaz.ip}</h4>
                                    <div><strong>Port:</strong> ${cihaz.port}</div>
                                    <div><strong>Ürün:</strong> ${cihaz.product || 'N/A'}</div>
                                    <div class="vuln-list">
                                        <strong>Zafiyetler:</strong>
                                        <ul>
                                            ${cihaz.vulns.slice(0, 5).map(v => `<li>${v}</li>`).join('')}
                                        </ul>
                                    </div>
                                </div>
                            `);
                        }
                    });

                    termLog(`[VULN] ${data.cihazlar.length} zafiyetli cihaz bulundu`, 'warn');
                    sesliUyariKontrollu(`${data.cihazlar.length} zafiyetli cihaz bulundu`, true);

                    // Bildirim ekle
                    bildirimEkle({
                        tip: 'high',
                        baslik: 'Zafiyet Taraması',
                        aciklama: `${data.cihazlar.length} zafiyetli cihaz tespit edildi`
                    });
                } else {
                    termLog('[VULN] Zafiyetli cihaz bulunamadı veya hata: ' + (data.hata || 'Bilinmiyor'), 'info');
                    sesliUyariKontrollu('Zafiyetli cihaz bulunamadı');
                }
            } catch (error) {
                termLog(`[VULN] Hata: ${error.message}`, 'err');
            }

            hideTooltip();
        }

        // ==================== SİBER KOMUTA POPUP FONKSİYONLARI ====================

        // Siber Analiz - Tam OSINT + Tehdit Analizi
        async function siberAnaliz() {
            if (!currentTooltipData) return;
            const ip = currentTooltipData.kaynak.ip;

            if (!ip || ip === 'N/A') {
                termLog('[SİBER] Geçerli IP adresi yok', 'err');
                return;
            }

            termLog(`[🎖️ SİBER KOMUTA] Tam analiz başlatılıyor: ${ip}`, 'info');
            sesliUyariKontrollu('Siber Komuta analizi başlatılıyor');

            // Terminal'i aç
            document.getElementById('termBar').classList.add('expanded');

            try {
                // 1. OSINT Fusion
                termLog('[SİBER] OSINT Fusion taraması...', 'info');
                const osintResp = await fetch('/api/siber/osint', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({hedef: ip})
                });
                const osintData = await osintResp.json();

                if (osintData.basarili) {
                    termLog(`[+] OSINT Sonuçları:`, 'ok');
                    const r = osintData.sonuc || {};
                    if (r.shodan) termLog(`  Shodan: ${r.shodan.ports?.length || 0} port açık`, 'info');
                    if (r.virustotal) termLog(`  VirusTotal: ${r.virustotal.malicious || 0} kötücül`, r.virustotal.malicious > 0 ? 'warn' : 'ok');
                    if (r.abuseipdb) termLog(`  AbuseIPDB: Score ${r.abuseipdb.abuse_score || 0}%`, r.abuseipdb.abuse_score > 50 ? 'warn' : 'ok');
                    if (r.greynoise) termLog(`  GreyNoise: ${r.greynoise.classification || 'unknown'}`, 'info');
                }

                // 2. Tehdit Analizi
                termLog('[SİBER] GROQ AI tehdit analizi...', 'info');
                const tehditResp = await fetch('/api/siber/tehdit-analiz', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        ip: ip,
                        saldiri_tipi: currentTooltipData.saldiri?.tip,
                        ulke: currentTooltipData.kaynak?.ulke,
                        port: currentTooltipData.saldiri?.port
                    })
                });
                const tehditData = await tehditResp.json();

                if (tehditData.basarili && tehditData.analiz) {
                    termLog('[+] AI Tehdit Değerlendirmesi:', 'warn');
                    const lines = tehditData.analiz.split('\n').slice(0, 8);
                    lines.forEach(line => {
                        if (line.trim()) termLog(`  ${line}`, 'info');
                    });
                }

                // 3. Haritada marker ekle
                if (currentTooltipData.kaynak?.lat && currentTooltipData.kaynak?.lng) {
                    const marker = L.circleMarker([currentTooltipData.kaynak.lat, currentTooltipData.kaynak.lng], {
                        radius: 15,
                        fillColor: '#00ff88',
                        color: '#00ff88',
                        weight: 3,
                        opacity: 0.9,
                        fillOpacity: 0.3,
                        className: 'siber-analyzed-marker'
                    }).addTo(map);

                    marker.bindPopup(`
                        <div style="min-width:200px">
                            <div style="font-weight:bold;color:#00ff88;margin-bottom:8px">🎖️ SİBER ANALİZ</div>
                            <div>IP: ${ip}</div>
                            <div>Ülke: ${currentTooltipData.kaynak?.ulke}</div>
                            <div>Saldırı: ${currentTooltipData.saldiri?.tip}</div>
                            <div style="margin-top:8px;color:#ff3355">⚠️ Analiz tamamlandı</div>
                        </div>
                    `);
                }

                termLog('[SİBER] ✓ Tam analiz tamamlandı', 'ok');
                bildirimEkle({
                    tip: 'success',
                    baslik: 'Siber Komuta Analizi',
                    aciklama: `${ip} için tam analiz tamamlandı`
                });

            } catch (error) {
                termLog(`[SİBER] Hata: ${error.message}`, 'err');
            }

            hideTooltip();
        }

        // Siber Tehdit Avı - Otonom ajanları aktifleştir
        async function siberTehditAvi() {
            if (!currentTooltipData) return;
            const ip = currentTooltipData.kaynak.ip;

            termLog('[🎯 TEHDİT AVI] Otonom tehdit avı başlatılıyor...', 'warn');
            sesliUyariKontrollu('Tehdit avı başlatılıyor', true);

            // Terminal'i aç
            document.getElementById('termBar').classList.add('expanded');

            try {
                // Socket ile tehdit avı başlat
                if (typeof socket !== 'undefined') {
                    socket.emit('siber_tehdit_avi', {
                        hedefler: [ip],
                        mod: 'agresif',
                        ajanlar: ['THREAT_HUNTER', 'OSINT_HUNTER', 'MALWARE_ANALYST']
                    });

                    termLog('[+] Tehdit avı ajanları aktifleştirildi:', 'ok');
                    termLog('  • THREAT_HUNTER: IOC taraması', 'info');
                    termLog('  • OSINT_HUNTER: Açık kaynak istihbaratı', 'info');
                    termLog('  • MALWARE_ANALYST: Zararlı yazılım analizi', 'info');
                }

                // API ile de çalıştır
                const response = await fetch('/api/siber/komut', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        komut: 'threat_hunt',
                        params: {target: ip, aggressive: true}
                    })
                });

                const data = await response.json();
                if (data.basarili) {
                    termLog('[+] Tehdit avı sonuçları işleniyor...', 'ok');
                }

            } catch (error) {
                termLog(`[TEHDİT AVI] Hata: ${error.message}`, 'err');
            }

            hideTooltip();
        }

        // Siber Ajan Görev - Belirli ajana görev ata
        async function siberAjanGorev() {
            if (!currentTooltipData) return;
            const ip = currentTooltipData.kaynak.ip;

            termLog('[👤 AJAN] Görev atama paneli açılıyor...', 'info');

            // Terminal'i aç
            document.getElementById('termBar').classList.add('expanded');

            // Ajanları listele
            try {
                const response = await fetch('/api/siber/ajanlar');
                const data = await response.json();

                if (data.basarili && data.ajanlar) {
                    termLog('[+] Mevcut Pentagon Ajanları:', 'ok');
                    const katmanlar = {};
                    data.ajanlar.forEach(a => {
                        if (!katmanlar[a.layer]) katmanlar[a.layer] = [];
                        katmanlar[a.layer].push(a);
                    });

                    Object.entries(katmanlar).forEach(([katman, ajanlar]) => {
                        termLog(`\n  [${katman.toUpperCase()}]`, 'warn');
                        ajanlar.slice(0, 3).forEach(a => {
                            const durum = a.status === 'idle' ? '🟢' : (a.status === 'busy' ? '🟡' : '🔴');
                            termLog(`    ${durum} ${a.id}: ${a.name}`, 'info');
                        });
                    });

                    termLog(`\n[*] Görev atamak için terminale yazın:`, 'info');
                    termLog(`    ajan gorev <ajan_id> <hedef> analiz et`, 'info');
                    termLog(`    Örnek: ajan gorev OSINT_HUNTER ${ip} analiz et`, 'info');
                }
            } catch (error) {
                termLog(`[AJAN] Hata: ${error.message}`, 'err');
            }

            hideTooltip();
        }

        // Siber Hava Sahası - Uçak takibi aktifleştir
        async function siberHavaSahasi() {
            termLog('[✈️ HAVA SAHASI] Uçak takibi başlatılıyor...', 'info');
            sesliUyariKontrollu('Hava sahası taraması');

            // Terminal'i aç
            document.getElementById('termBar').classList.add('expanded');

            try {
                // Mevcut saldırı konumu veya harita merkezi
                let lat, lng;
                if (currentTooltipData?.hedef?.lat) {
                    lat = currentTooltipData.hedef.lat;
                    lng = currentTooltipData.hedef.lng;
                } else {
                    const center = map.getCenter();
                    lat = center.lat;
                    lng = center.lng;
                }

                const response = await fetch(`/api/siber/hava-sahasi?lat=${lat}&lon=${lng}&radius=500`);
                const data = await response.json();

                if (data.basarili && data.ucaklar) {
                    termLog(`[+] ${data.ucaklar.length} uçak tespit edildi`, 'ok');

                    // Uçakları haritaya ekle
                    data.ucaklar.forEach(ucak => {
                        if (ucak.latitude && ucak.longitude) {
                            const isAskeri = ucak.callsign?.includes('MIL') || ucak.callsign?.includes('AF');
                            const renk = isAskeri ? '#ff3355' : '#00b4ff';

                            const marker = L.marker([ucak.latitude, ucak.longitude], {
                                icon: L.divIcon({
                                    className: 'aircraft-marker',
                                    html: `<div style="color:${renk};font-size:16px;transform:rotate(${ucak.true_track || 0}deg)">✈</div>`,
                                    iconSize: [20, 20]
                                })
                            }).addTo(map);

                            marker.bindPopup(`
                                <div>
                                    <strong>${ucak.callsign || 'N/A'}</strong><br>
                                    Ülke: ${ucak.origin_country || 'N/A'}<br>
                                    İrtifa: ${ucak.geo_altitude || 0}m<br>
                                    Hız: ${ucak.velocity || 0} m/s
                                </div>
                            `);

                            termLog(`  ${isAskeri ? '🔴' : '🔵'} ${ucak.callsign || 'N/A'} - ${ucak.origin_country || '?'} @ ${Math.round(ucak.geo_altitude || 0)}m`, 'info');
                        }
                    });

                    // SiberKomuta'ya da bildir
                    if (typeof SiberKomuta !== 'undefined') {
                        SiberKomuta.toggleAircraftLayer();
                    }
                } else {
                    termLog('[!] Uçak verisi alınamadı', 'warn');
                }
            } catch (error) {
                termLog(`[HAVA SAHASI] Hata: ${error.message}`, 'err');
            }

            hideTooltip();
        }

        // Shodan Panel Fonksiyonları
        function openShodanPanel() {
            let panel = document.getElementById('shodanPanel');
            if (!panel) {
                // Panel yoksa oluştur
                panel = document.createElement('div');
                panel.id = 'shodanPanel';
                panel.className = 'shodan-panel';
                panel.innerHTML = `
                    <div class="panel-header">
                        <h3>🔍 Shodan İstihbarat</h3>
                        <button class="close-btn" onclick="closeShodanPanel()">×</button>
                    </div>
                    <div class="panel-tabs">
                        <button class="tab-btn active" onclick="switchShodanTab('search')">Arama</button>
                        <button class="tab-btn" onclick="switchShodanTab('viewport')">Görünüm</button>
                        <button class="tab-btn" onclick="switchShodanTab('cve')">CVE</button>
                    </div>
                    <div class="panel-content">
                        <div id="tab-search" class="tab-content active">
                            <div class="search-group">
                                <input type="text" id="shodanQuery" placeholder="IP, port, product, org...">
                                <button onclick="shodanArama()">Ara</button>
                            </div>
                            <div class="quick-filters">
                                <button onclick="shodanArama('port:22')">SSH</button>
                                <button onclick="shodanArama('port:3389')">RDP</button>
                                <button onclick="shodanArama('port:445')">SMB</button>
                                <button onclick="shodanArama('webcam')">Kamera</button>
                                <button onclick="shodanArama('scada')">SCADA</button>
                                <button onclick="shodanArama('ics')">ICS</button>
                            </div>
                        </div>
                        <div id="tab-viewport" class="tab-content">
                            <p style="font-size:11px;color:var(--text-dim);margin-bottom:10px">Harita görünümündeki tüm Shodan cihazlarını yükle</p>
                            <button onclick="loadViewportDevices()" style="width:100%;padding:10px;background:var(--accent-primary);border:none;border-radius:5px;color:var(--bg-void);cursor:pointer;font-weight:bold">Görünümü Tara</button>
                            <div style="margin-top:10px">
                                <label style="font-size:10px;color:var(--text-dim)"><input type="checkbox" id="filterVuln"> Sadece Zafiyetli</label><br>
                                <label style="font-size:10px;color:var(--text-dim)"><input type="checkbox" id="filterHoneypot"> Honeypot Hariç</label>
                            </div>
                        </div>
                        <div id="tab-cve" class="tab-content">
                            <div class="search-group">
                                <input type="text" id="cveInput" placeholder="CVE-2021-44228">
                                <button onclick="searchCVE()">Ara</button>
                            </div>
                            <div style="margin-top:10px">
                                <p style="font-size:10px;color:var(--text-dim);margin-bottom:8px">Popüler CVE'ler:</p>
                                <div class="quick-filters">
                                    <button onclick="searchCVE('CVE-2021-44228')">Log4Shell</button>
                                    <button onclick="searchCVE('CVE-2021-34473')">ProxyShell</button>
                                    <button onclick="searchCVE('CVE-2023-23397')">Outlook</button>
                                    <button onclick="searchCVE('CVE-2023-34362')">MOVEit</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="shodanResults" class="results-area"></div>
                    <div class="panel-stats">
                        <div class="stat">
                            <span class="stat-value" id="shodanDeviceCount">0</span>
                            <span class="stat-label">Cihaz</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value" id="shodanVulnCount">0</span>
                            <span class="stat-label">Zafiyet</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value" id="shodanPortCount">0</span>
                            <span class="stat-label">Port</span>
                        </div>
                    </div>
                `;
                document.body.appendChild(panel);
            }
            panel.style.display = 'block';
        }

        function closeShodanPanel() {
            const panel = document.getElementById('shodanPanel');
            if (panel) panel.style.display = 'none';
        }

        function switchShodanTab(tabId) {
            // Tab butonları
            document.querySelectorAll('.shodan-panel .tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Tab içerikleri
            document.querySelectorAll('.shodan-panel .tab-content').forEach(tab => tab.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
        }

        async function shodanArama(query = null) {
            const sorgu = query || document.getElementById('shodanQuery')?.value;
            if (!sorgu) return;

            termLog(`[SHODAN] Arama: ${sorgu}`, 'info');

            try {
                const response = await fetch('/api/shodan/zafiyet-harita', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({query: sorgu})
                });

                const data = await response.json();

                if (data.basarili) {
                    // Haritaya ekle
                    shodanLayer.clearLayers();

                    let vulnCount = 0;
                    let portSet = new Set();

                    data.cihazlar.forEach(cihaz => {
                        const marker = L.marker([cihaz.lat, cihaz.lng], {
                            icon: L.divIcon({
                                className: 'shodan-marker',
                                html: `<div class="shodan-icon">🖥️</div>`,
                                iconSize: [30, 30]
                            })
                        }).addTo(shodanLayer);

                        marker.bindPopup(`
                            <div class="shodan-popup">
                                <h4>${cihaz.ip}</h4>
                                <div><strong>Port:</strong> ${cihaz.port}</div>
                                <div><strong>Ürün:</strong> ${cihaz.product || 'N/A'}</div>
                                <div><strong>Org:</strong> ${cihaz.org || 'N/A'}</div>
                                <div><strong>Konum:</strong> ${cihaz.sehir || ''}, ${cihaz.ulke || ''}</div>
                            </div>
                        `);

                        if (cihaz.vulns) vulnCount += cihaz.vulns.length;
                        if (cihaz.port) portSet.add(cihaz.port);
                    });

                    // İstatistikleri güncelle
                    document.getElementById('shodanDeviceCount').textContent = data.cihazlar.length;
                    document.getElementById('shodanVulnCount').textContent = vulnCount;
                    document.getElementById('shodanPortCount').textContent = portSet.size;

                    // Sonuçları listele
                    renderShodanResults(data.cihazlar);

                    termLog(`[SHODAN] ${data.toplam} sonuç bulundu (${data.cihazlar.length} gösteriliyor)`, 'ok');
                } else {
                    termLog(`[SHODAN] Hata: ${data.hata}`, 'err');
                }
            } catch (error) {
                termLog(`[SHODAN] Hata: ${error.message}`, 'err');
            }
        }

        async function loadViewportDevices() {
            const bounds = map.getBounds();
            const filterVuln = document.getElementById('filterVuln')?.checked;
            const filterHoneypot = document.getElementById('filterHoneypot')?.checked;

            let filtre = '';
            if (filterVuln) filtre += ' has_vuln:true';
            if (filterHoneypot) filtre += ' -honeyscore:1';

            termLog('[SHODAN] Görünüm taranıyor...', 'info');

            try {
                const response = await fetch('/api/shodan/viewport', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        bounds: {
                            north: bounds.getNorth(),
                            south: bounds.getSouth(),
                            east: bounds.getEast(),
                            west: bounds.getWest()
                        },
                        filtre: filtre.trim()
                    })
                });

                const data = await response.json();

                if (data.basarili) {
                    shodanLayer.clearLayers();

                    data.cihazlar.forEach(cihaz => {
                        const icon = cihaz.honeypot ? '🍯' : '🖥️';
                        const marker = L.marker([cihaz.lat, cihaz.lng], {
                            icon: L.divIcon({
                                className: 'shodan-marker',
                                html: `<div class="shodan-icon">${icon}</div>`,
                                iconSize: [30, 30]
                            })
                        }).addTo(shodanLayer);

                        marker.bindPopup(`
                            <div class="shodan-popup">
                                <h4>${cihaz.ip}</h4>
                                <div><strong>Port:</strong> ${cihaz.port}</div>
                                <div><strong>Ürün:</strong> ${cihaz.product || 'N/A'}</div>
                                ${cihaz.honeypot ? '<div style="color:orange">⚠️ Muhtemel Honeypot</div>' : ''}
                            </div>
                        `);
                    });

                    document.getElementById('shodanDeviceCount').textContent = data.cihazlar.length;
                    termLog(`[SHODAN] ${data.cihazlar.length} cihaz bulundu`, 'ok');
                } else {
                    termLog(`[SHODAN] Hata: ${data.hata}`, 'err');
                }
            } catch (error) {
                termLog(`[SHODAN] Viewport tarama hatası: ${error.message}`, 'err');
            }
        }

        async function searchCVE(cve = null) {
            const cveId = cve || document.getElementById('cveInput')?.value;
            if (!cveId) return;

            termLog(`[CVE] Arama: ${cveId}`, 'info');

            try {
                const response = await fetch('/api/shodan/zafiyet-harita', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({cve: cveId})
                });

                const data = await response.json();

                if (data.basarili) {
                    vulnLayer.clearLayers();

                    data.cihazlar.forEach(cihaz => {
                        const marker = L.marker([cihaz.lat, cihaz.lng], {
                            icon: L.divIcon({
                                className: 'vuln-marker',
                                html: `<div class="vuln-icon">⚠️</div>`,
                                iconSize: [30, 30]
                            })
                        }).addTo(vulnLayer);

                        marker.bindPopup(`
                            <div class="vuln-popup">
                                <h4>${cihaz.ip}</h4>
                                <div><strong>Konum:</strong> ${cihaz.sehir || ''}, ${cihaz.ulke || ''}</div>
                                <div><strong>CVE:</strong> <span style="color:red">${cveId}</span></div>
                            </div>
                        `);
                    });

                    document.getElementById('shodanVulnCount').textContent = data.toplam;
                    termLog(`[CVE] ${cveId}: ${data.toplam} etkilenen cihaz`, 'warn');
                } else {
                    termLog(`[CVE] Hata: ${data.hata}`, 'err');
                }
            } catch (error) {
                termLog(`[CVE] Arama hatası: ${error.message}`, 'err');
            }
        }

        function renderShodanResults(cihazlar) {
            const container = document.getElementById('shodanResults');
            if (!container) return;

            container.innerHTML = cihazlar.slice(0, 20).map(c => `
                <div class="result-item" onclick="map.setView([${c.lat}, ${c.lng}], 12)">
                    <div class="result-ip">${c.ip}</div>
                    <div class="result-info">${c.port || 'N/A'} | ${c.product || 'N/A'}</div>
                </div>
            `).join('');
        }

        // ==================== BİLDİRİM SİSTEMİ ====================

        let bildirimler = [];
        let bildirimSayisi = 0;

        function bildirimEkle(bildirim) {
            const id = Date.now();
            const yeniBildirim = {
                id: id,
                ...bildirim,
                zaman: new Date()
            };

            bildirimler.unshift(yeniBildirim);
            bildirimSayisi++;

            // UI'i guncelle
            bildirimleriRenderla();
            bildirimSayisiniGuncelle();

            // Parent frame'e bildirim sayısını gönder
            sendToParent('NOTIF_COUNT', { count: bildirimSayisi });

            // Sesli uyari (kritik icin)
            if (bildirim.tip === 'critical') {
                sesliUyariKontrollu(`Kritik uyarı! ${bildirim.baslik}`, true);
            }

            // 100'den fazla bildirim varsa eskileri sil
            if (bildirimler.length > 100) {
                bildirimler = bildirimler.slice(0, 100);
            }
        }

        function bildirimleriRenderla() {
            const liste = document.getElementById('notificationList');
            if (!liste) return;

            if (bildirimler.length === 0) {
                liste.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-dim);font-size:11px">Bildirim yok</div>';
                return;
            }

            liste.innerHTML = bildirimler.slice(0, 50).map(b => {
                const icon = {
                    'critical': '<svg width="16" height="16" viewBox="0 0 24 24" fill="#ff3355"><circle cx="12" cy="12" r="10"/></svg>',
                    'high': '<svg width="16" height="16" viewBox="0 0 24 24" fill="#ff6600"><circle cx="12" cy="12" r="10"/></svg>',
                    'medium': '<svg width="16" height="16" viewBox="0 0 24 24" fill="#00b4ff"><circle cx="12" cy="12" r="10"/></svg>',
                    'counter': '<svg width="16" height="16" viewBox="0 0 24 24" fill="#ff9800"><path d="M6.92 5.51l-1.4 1.4c-.12.12-.29.19-.46.19H3.59c-.89 0-1.34 1.08-.71 1.71l1.41 1.41-4.24 4.24 7.07 7.07 4.24-4.24 1.41 1.41c.63.63 1.71.18 1.71-.71V14.5c0-.17.07-.34.19-.46l1.4-1.4c.63-.63.18-1.71-.71-1.71h-2.83l-5.66-5.66c-.63-.63-1.71-.18-1.71.71v.47z"/></svg>',
                    'watch': '<svg width="16" height="16" viewBox="0 0 24 24" fill="#00e5ff"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/></svg>',
                    'info': '<svg width="16" height="16" viewBox="0 0 24 24" fill="#00b4ff"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>'
                }[b.tip] || '<svg width="16" height="16" viewBox="0 0 24 24" fill="#00e5ff"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg>';

                const zamanStr = b.zaman.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });

                return `
                    <div class="notification-item ${b.tip}" onclick="bildirimTikla(${b.id})">
                        <span class="notif-icon">${icon}</span>
                        <div class="notif-content">
                            <div class="notif-title">${b.baslik}</div>
                            <div class="notif-desc">${b.aciklama}</div>
                        </div>
                        <span class="notif-time">${zamanStr}</span>
                    </div>
                `;
            }).join('');
        }

        function bildirimSayisiniGuncelle() {
            const badge = document.getElementById('notifBadge');
            const count = document.getElementById('notifCount');

            if (badge) {
                badge.textContent = bildirimSayisi;
                badge.classList.toggle('hidden', bildirimSayisi === 0);
            }
            if (count) {
                count.textContent = bildirimSayisi;
            }
        }

        function toggleNotificationPanel() {
            const panel = document.getElementById('notificationPanel');
            if (panel) {
                panel.classList.toggle('visible');
                // Panel acildiginda sayaci sifirla
                if (panel.classList.contains('visible')) {
                    bildirimSayisi = 0;
                    bildirimSayisiniGuncelle();
                }
            }
        }

        function bildirimleriTemizle() {
            bildirimler = [];
            bildirimSayisi = 0;
            bildirimleriRenderla();
            bildirimSayisiniGuncelle();
        }

        function bildirimTikla(id) {
            const bildirim = bildirimler.find(b => b.id === id);
            if (bildirim && bildirim.data) {
                // Ilgili saldirinin popup'ini ac
                currentTooltipData = bildirim.data;
                showTooltip({ latlng: { lat: bildirim.data.hedef.lat, lng: bildirim.data.hedef.lng } }, bildirim.data);

                // Haritada konuma git
                if (bildirim.data.hedef.lat && bildirim.data.hedef.lng) {
                    map.setView([bildirim.data.hedef.lat, bildirim.data.hedef.lng], 8, { animate: true });
                }
            }
            toggleNotificationPanel();
        }

        // Bildirim Sistemini Baslat
        function bildirimSisteminiBaslat() {
            // Bildirim panelini renderla
            bildirimleriRenderla();
            bildirimSayisiniGuncelle();

            // Ses izni iste
            if ('speechSynthesis' in window) {
                speechSynthesis.getVoices();
            }

            // Parent frame iletişimini başlat
            initParentFrameCommunication();

            console.log('[BILDIRIM] Bildirim sistemi hazir');
        }

        // === PARENT FRAME İLETİŞİM SİSTEMİ ===
        // /panel sayfasından gelen mesajları dinle (iframe içinde çalışırken)
        function initParentFrameCommunication() {
            if (window.parent === window) {
                console.log('[IFRAME] Standalone modda çalışıyor, parent iletişimi atlandı');
                return;
            }

            window.addEventListener('message', function(event) {
                if (event.data && event.data.type === 'TSUNAMI_PANEL_ACTION') {
                    console.log('[IFRAME] Parent\'tan mesaj alındı:', event.data.action);
                    switch(event.data.action) {
                        case 'OPEN_AILYDIAN':
                            ailydianPopupAc();
                            sendToParent('AILYDIAN_OPENED', {});
                            break;
                        case 'TOGGLE_NOTIFICATIONS':
                            toggleNotificationPanel();
                            break;
                        case 'GET_NOTIF_COUNT':
                            sendToParent('NOTIF_COUNT', { count: bildirimSayisi });
                            break;
                        case 'OPEN_TOR_POPUP':
                            openTorPopup();
                            break;
                    }
                }
            });

            console.log('[IFRAME] Parent frame iletişimi başlatıldı');
        }

        // Parent frame'e mesaj gönder
        function sendToParent(action, data = {}) {
            if (window.parent !== window) {
                window.parent.postMessage({
                    type: 'TSUNAMI_HARITA_RESPONSE',
                    action: action,
                    ...data
                }, '*');
                console.log('[IFRAME] Parent\'a mesaj gönderildi:', action);
            }
        }

        // Yeni saldırı olduğunda parent'a bildir
        function notifyParentOfAttack(data) {
            sendToParent('NEW_ATTACK', {
                title: `${data.saldiri?.tip || 'Saldırı'} Tespit Edildi`,
                message: `${data.kaynak?.ulke || 'Bilinmeyen'} → ${data.hedef?.sehir || 'Hedef'}`,
                type: data.saldiri?.ciddiyet || 'warning'
            });
            sendToParent('NOTIF_COUNT', { count: bildirimSayisi });
        }

        // Kritik Saldiri Bildirimi - Sadece panel ve ses
        function kritikSaldiriBildirimi(data) {
            const baslik = `${data.saldiri.tip} Saldırısı!`;
            const aciklama = `${data.kaynak.ulke} → ${data.hedef.sehir}`;

            // Panel bildirimi (ikon uzerinde gosterilecek)
            bildirimEkle({
                tip: data.saldiri.ciddiyet,
                baslik: baslik,
                aciklama: aciklama,
                data: data
            });

            // Parent frame'e bildir (iframe içindeyse)
            notifyParentOfAttack(data);

            // Sesli uyari
            sesliUyariKontrollu(`Dikkat! ${data.saldiri.tip} saldırısı tespit edildi. Kaynak: ${data.kaynak.ulke}`, true);
        }

        // Toast Bildirimi - LYDIAN panel icin
        function showToast(mesaj, tip = 'info') {
            const toastContainer = document.querySelector('.toast-container');

            // Terminal'e de logla
            termLog(mesaj, tip === 'error' ? 'err' : (tip === 'success' ? 'ok' : 'info'));

            if (!toastContainer) {
                console.log(`[TOAST] ${tip}: ${mesaj}`);
                return;
            }

            const toast = document.createElement('div');
            toast.className = `toast ${tip}`;
            toast.innerHTML = `
                <span class="toast-icon">${tip === 'error' ? '❌' : tip === 'success' ? '✅' : 'ℹ️'}</span>
                <div class="toast-content">
                    <div class="toast-title">${tip === 'error' ? 'Hata' : tip === 'success' ? 'Basarili' : 'Bilgi'}</div>
                    <div class="toast-text">${mesaj}</div>
                </div>
            `;

            toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Saldiri Feed
        function addAttackFeed(data) {
            const feed = document.getElementById('atkFeed');
            const time = new Date().toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

            const item = document.createElement('div');
            item.className = 'atk-item';
            item.dataset.saldiriId = data.id;
            item.innerHTML = `
                <div class="atk-dot ${data.saldiri.ciddiyet}"></div>
                <div class="atk-info">
                    <div class="atk-type" style="color:${data.saldiri.renk}">${data.saldiri.tip}</div>
                    <div class="atk-target">${data.kaynak.ulke} → ${data.hedef.sehir}</div>
                </div>
                <div class="atk-time">${time}</div>
            `;

            // Feed item'a tiklandiginda popup ac
            item.onclick = (e) => {
                e.stopPropagation();
                // Onceki secimi kaldir
                document.querySelectorAll('.atk-item.selected').forEach(el => el.classList.remove('selected'));
                item.classList.add('selected');

                // Popup'i yaninda ac
                showTooltip(e, data, true);

                // Haritada konuma zoom yap
                if (data.hedef.lat && data.hedef.lng) {
                    map.setView([data.hedef.lat, data.hedef.lng], 8, { animate: true });
                }
            };

            feed.insertBefore(item, feed.firstChild);
            while (feed.children.length > 20) feed.removeChild(feed.lastChild);

            // Kritik saldiri bildirimi
            if (data.saldiri.ciddiyet === 'critical' || data.saldiri.ciddiyet === 'high') {
                bildirimEkle({
                    tip: data.saldiri.ciddiyet,
                    baslik: `${data.saldiri.tip} Saldırısı`,
                    aciklama: `${data.kaynak.ulke} → ${data.hedef.sehir}`,
                    data: data
                });
            }
        }

        // ═══════════════════════════════════════════════════════════════════
        // GELISMIS STREET VIEW SISTEMI - Coklu Saglayici Destegi
        // ═══════════════════════════════════════════════════════════════════

        let currentSVLat = 0;
        let currentSVLng = 0;

        function openStreetView(lat, lng) {
            if (!lat || !lng || isNaN(lat) || isNaN(lng)) {
                console.warn('Gecersiz koordinatlar:', lat, lng);
                return;
            }

            currentSVLat = lat;
            currentSVLng = lng;

            const modal = document.getElementById('svModal');
            const frame = document.getElementById('svFrame');
            const title = document.getElementById('svTitle');
            const coords = document.getElementById('svCoords');
            const address = document.getElementById('svAddress');

            if (!modal || !frame || !title) {
                console.error('Modal elemanlari bulunamadi');
                return;
            }

            title.textContent = 'Konum Gorunumu: ' + lat.toFixed(6) + ', ' + lng.toFixed(6);
            coords.textContent = 'Lat: ' + lat.toFixed(6) + ' | Lng: ' + lng.toFixed(6);
            address.textContent = 'Adres yukleniyor...';

            // Varsayilan provider ile ac
            const provider = document.getElementById('svProvider').value;
            loadStreetViewProvider(provider, lat, lng);

            modal.classList.add('visible');

            // Adres bilgisi icin Nominatim API
            fetch('https://nominatim.openstreetmap.org/reverse?format=json&lat=' + lat + '&lon=' + lng + '&zoom=18')
                .then(r => r.json())
                .then(d => {
                    if (d.display_name) {
                        address.innerHTML = '<strong style="color:#00ff88;">' + (d.address?.road || d.address?.neighbourhood || 'Bilinmiyor') + '</strong><br>' +
                            (d.address?.suburb || d.address?.city || '') + ', ' +
                            (d.address?.state || d.address?.country || '');
                        termLog('[OSINT] Adres: ' + d.display_name.substring(0, 50) + '...', 'info');
                    }
                })
                .catch(() => {
                    address.textContent = 'Adres bulunamadi';
                });

            // OSINT bilgisi
            fetch('/api/osint/ip-lokasyon?lat=' + lat + '&lng=' + lng)
                .then(r => r.json())
                .then(d => {
                    if (d.ulke) {
                        termLog('[OSINT] Konum: ' + d.sehir + ', ' + d.ulke, 'info');
                    }
                })
                .catch(() => {});
        }

        function loadStreetViewProvider(provider, lat, lng) {
            const frame = document.getElementById('svFrame');
            let url = '';

            switch(provider) {
                case 'google':
                    // Google Street View - En iyi kalite
                    url = 'https://www.google.com/maps/embed?pb=!4v1!6m8!1m7!1s!2m2!1d' + lat + '!2d' + lng + '!3f0!4f0!5f0.7820865974627469';
                    // Alternatif: Direct Street View
                    url = 'https://www.google.com/maps/@' + lat + ',' + lng + ',3a,75y,90t/data=!3m6!1e1!3m4!1s!2e0!7i16384!8i8192';
                    break;
                case 'osm':
                    // OpenStreetMap
                    url = 'https://www.openstreetmap.org/export/embed.html?bbox=' +
                        (lng - 0.002) + '%2C' + (lat - 0.002) + '%2C' + (lng + 0.002) + '%2C' + (lat + 0.002) +
                        '&layer=mapnik&marker=' + lat + '%2C' + lng;
                    break;
                case 'mapillary':
                    // Mapillary - Acik kaynak Street View
                    url = 'https://www.mapillary.com/embed?map_style=Mapillary%20light&image_key=&x=' + lng + '&y=' + lat + '&z=17';
                    break;
                case 'yandex':
                    // Yandex Panorama
                    url = 'https://yandex.com/maps/?ll=' + lng + '%2C' + lat + '&z=17&l=stv%2Csta&panorama%5Bpoint%5D=' + lng + '%2C' + lat;
                    break;
                default:
                    url = 'https://www.openstreetmap.org/export/embed.html?bbox=' +
                        (lng - 0.01) + '%2C' + (lat - 0.01) + '%2C' + (lng + 0.01) + '%2C' + (lat + 0.01) +
                        '&layer=mapnik&marker=' + lat + '%2C' + lng;
            }

            frame.src = url;
            termLog('[STREET VIEW] ' + provider + ' yuklendi', 'ok');
        }

        function changeStreetViewProvider() {
            const provider = document.getElementById('svProvider').value;
            loadStreetViewProvider(provider, currentSVLat, currentSVLng);
        }

        function openInNewTab() {
            const provider = document.getElementById('svProvider').value;
            let url = '';
            switch(provider) {
                case 'google':
                    url = 'https://www.google.com/maps/@' + currentSVLat + ',' + currentSVLng + ',18z';
                    break;
                case 'osm':
                    url = 'https://www.openstreetmap.org/?mlat=' + currentSVLat + '&mlon=' + currentSVLng + '&zoom=18';
                    break;
                case 'mapillary':
                    url = 'https://www.mapillary.com/app/?lat=' + currentSVLat + '&lng=' + currentSVLng + '&z=17';
                    break;
                case 'yandex':
                    url = 'https://yandex.com/maps/?ll=' + currentSVLng + '%2C' + currentSVLat + '&z=17';
                    break;
            }
            window.open(url, '_blank');
        }

        function closeSV() {
            document.getElementById('svModal').classList.remove('visible');
            document.getElementById('svFrame').src = '';
        }

        // Street View Panel Hizli Islemler
        function svOsintAnaliz() {
            termLog('[OSINT] Konum analizi baslatildi: ' + currentSVLat + ', ' + currentSVLng, 'info');
            // OSINT analiz
        }

        function svWifiTara() {
            termLog('[SIGINT] WiFi tarama baslatildi', 'ok');
            fetch('/api/konum/ara', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({lat: currentSVLat, lng: currentSVLng, radius: 500, types: ['wifi']})
            }).then(r => r.json()).then(d => {
                if (d.wifi) termLog('[SIGINT] ' + d.wifi.length + ' WiFi agi bulundu', 'ok');
            }).catch(() => {});
        }

        function svGhostKaydet() {
            termLog('[GHOST] Konum kaydediliyor...', 'ok');
            // GHOST CRM'e kaydet
        }

        function svRaporOlustur() {
            termLog('[RAPOR] Konum raporu olusturuluyor...', 'info');
        }

        // ═══════════════════════════════════════════════════════════════════
        // HARITA KATMAN DEGISTIRME
        // ═══════════════════════════════════════════════════════════════════

        function switchToLayer(layerName) {
            if (window.layerControl && window.layerControl._layers) {
                // Mevcut base layer'i kaldir
                Object.keys(window.layerControl._layers).forEach(key => {
                    const layerObj = window.layerControl._layers[key];
                    if (!layerObj.overlay && map.hasLayer(layerObj.layer)) {
                        map.removeLayer(layerObj.layer);
                    }
                });

                // Yeni layer'i ekle
                Object.keys(window.layerControl._layers).forEach(key => {
                    const layerObj = window.layerControl._layers[key];
                    if (layerObj.name === layerName && !layerObj.overlay) {
                        map.addLayer(layerObj.layer);
                        window.activeBaseLayer = layerName;
                        termLog('[HARITA] ' + layerName + ' katmani aktif', 'ok');

                        // Buton stillerini guncelle - DARK TEMA
                        document.querySelectorAll('#quickLayerSwitch .ql-btn').forEach(btn => {
                            btn.style.borderColor = '#444';
                            btn.style.color = '#888';
                            btn.style.background = 'rgba(255,255,255,0.05)';
                            // Aktif butonu vurgula (mavi)
                            if (btn.dataset.layer === layerName) {
                                btn.style.borderColor = 'rgba(0,180,255,0.4)';
                                btn.style.color = '#00b4ff';
                                btn.style.background = 'rgba(0,180,255,0.15)';
                            }
                        });
                    }
                });
            }
        }

        // Uydu moduna hizli gecis (Ctrl+S)
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                if (window.activeBaseLayer === 'Uydu (ESRI)' || window.activeBaseLayer === 'Google Uydu') {
                    switchToLayer('Siber Mod');
                } else {
                    switchToLayer('Google Uydu');
                }
            }
        });

        // Veri Yukleme
        async function loadData() {
            try {
                const r = await fetch('/api/harita/veriler');
                const d = await r.json();
                if (d.wifi) updateWifi(d.wifi);
                if (d.bluetooth) updateBt(d.bluetooth);
                if (d.baz_istasyonlari) updateBaz(d.baz_istasyonlari);
            } catch (e) { termLog('Veri yüklenemedi: ' + e.message, 'err'); }
            // Stealth rotasını da yükle
            loadStealthRoute();
        }

        // ==================== STEALTH ROTA GÖRSELLEŞTİRME ====================
        let stealthMarkers = [];
        let stealthPolyline = null;

        async function loadStealthRoute() {
            try {
                const r = await fetch('/api/stealth/harita');
                const d = await r.json();
                if (d.basarili && d.path && d.path.length > 1) {
                    drawStealthRoute(d);
                }
            } catch (e) { /* stealth inactive */ }
        }

        function drawStealthRoute(data) {
            clearStealthRoute();
            if (!data.path || data.path.length < 2) return;

            const pathCoords = data.path.map(p => [p.lat, p.lng]);

            // Parlayan yeşil rota çizgisi
            stealthPolyline = L.polyline(pathCoords, {
                color: '#00ff00',
                weight: 3,
                opacity: 0.7,
                dashArray: '8, 8'
            }).addTo(map);

            // Hop markerları
            data.hops.forEach((hop, i) => {
                if (!hop.lat || !hop.lng) return;
                const hopIcon = L.divIcon({
                    className: 'stealth-hop',
                    html: `<div style="width:24px;height:24px;background:rgba(0,255,0,0.2);border:2px solid #00ff00;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#00ff00;font-size:10px;font-weight:bold;box-shadow:0 0 10px #00ff00;">${i+1}</div>`,
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                });
                const marker = L.marker([hop.lat, hop.lng], { icon: hopIcon })
                    .bindPopup(`<b>HOP ${i+1}</b><br>${hop.type.toUpperCase()}<br>${hop.country}<br>IP: ${hop.ip}`)
                    .addTo(map);
                stealthMarkers.push(marker);
            });

            // Origin marker
            if (data.origin) {
                const originIcon = L.divIcon({
                    className: 'stealth-origin',
                    html: `<div style="width:20px;height:20px;background:#00ff00;border-radius:50%;box-shadow:0 0 15px #00ff00;animation:pulse 2s infinite;"></div>`,
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });
                const m = L.marker([data.origin.lat, data.origin.lng], { icon: originIcon })
                    .bindPopup('<b>ORIGIN</b><br>Başlangıç')
                    .addTo(map);
                stealthMarkers.push(m);
            }

            termLog(`Stealth: ${data.total_hops} hop, ${data.encryption_layers} katman`, 'ok');
        }

        function clearStealthRoute() {
            if (stealthPolyline) { map.removeLayer(stealthPolyline); stealthPolyline = null; }
            stealthMarkers.forEach(m => map.removeLayer(m));
            stealthMarkers = [];
        }

        async function rotateStealthRoute() {
            termLog('Stealth rota döndürülüyor...', 'info');
            try {
                const r = await fetch('/api/stealth/dondur', { method: 'POST' });
                const d = await r.json();
                if (d.basarili) { drawStealthRoute(d); termLog('Yeni stealth rota aktif', 'ok'); }
            } catch (e) { termLog('Rota hatası', 'err'); }
        }

        async function setStealthLevel(level) {
            try {
                await fetch('/api/stealth/seviye', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ seviye: level })
                });
                await loadStealthRoute();
                termLog(`Stealth: ${level.toUpperCase()}`, 'ok');
            } catch (e) {}
        }

        // TOR/Stealth Aktivasyon
        let stealthActive = false;
        async function activateTorStealth() {
            const btn = document.getElementById('torActivateBtn');
            const infoPanel = document.getElementById('stealthInfoPanel');
            const levelSelect = document.getElementById('stealthLevelSelect');
            const rotateBtn = document.getElementById('rotateStealthBtn');

            if (stealthActive) {
                termLog('Stealth zaten aktif', 'info');
                return;
            }

            btn.innerHTML = '⏳ Başlatılıyor...';
            btn.disabled = true;
            infoPanel.innerHTML = '<div style="color:#ffaa00;">TOR devresi oluşturuluyor...</div>';
            termLog('TOR/Stealth başlatılıyor...', 'info');

            try {
                const r = await fetch('/api/stealth/baslat', { method: 'POST' });
                const d = await r.json();

                if (d.basarili) {
                    stealthActive = true;
                    btn.innerHTML = '✅ TOR AKTİF';
                    btn.style.background = 'rgba(0,255,0,0.3)';
                    btn.style.borderColor = '#00ff00';
                    btn.style.boxShadow = '0 0 15px rgba(0,255,0,0.5)';
                    levelSelect.disabled = false;
                    rotateBtn.disabled = false;

                    // Durumu göster
                    updateStealthInfo(d);

                    // Harita üzerinde rotayı göster
                    await loadStealthRoute();

                    termLog('TOR/Stealth aktif!', 'ok');
                } else {
                    throw new Error(d.hata || 'Bilinmeyen hata');
                }
            } catch (e) {
                btn.innerHTML = '⚡ TOR AKTİF ET';
                btn.disabled = false;
                infoPanel.innerHTML = `<div style="color:#ff4444;">Hata: ${e.message}</div>`;
                termLog(`Stealth hatası: ${e.message}`, 'err');
            }
        }

        function updateStealthInfo(data) {
            const panel = document.getElementById('stealthInfoPanel');
            if (!panel) return;

            const level = data.level || data.seviye || 'normal';
            const torActive = data.tor?.active ?? data.tor_aktif ?? true;
            const hops = data.total_hops || data.hop_sayisi || 3;
            const encryption = data.encryption_layers || data.sifreleme || 3;

            panel.innerHTML = `
                <div class="stealth-stat"><span>Durum</span><span style="color:#00ff00;">● AKTİF</span></div>
                <div class="stealth-stat"><span>Seviye</span><span>${level.toUpperCase()}</span></div>
                <div class="stealth-stat"><span>Hop Sayısı</span><span>${hops}</span></div>
                <div class="stealth-stat"><span>Şifreleme</span><span>${encryption} katman</span></div>
                <div class="stealth-stat"><span>TOR</span><span>${torActive ? '✓ Bağlı' : '✗ Bağlantı Yok'}</span></div>
            `;
        }

        // Sayfa yüklendiğinde stealth durumunu kontrol et
        async function checkStealthStatus() {
            try {
                const r = await fetch('/api/stealth/durum');
                const d = await r.json();
                if (d.basarili && d.aktif) {
                    stealthActive = true;
                    const btn = document.getElementById('torActivateBtn');
                    if (btn) {
                        btn.innerHTML = '✅ TOR AKTİF';
                        btn.style.background = 'rgba(0,255,0,0.3)';
                        btn.style.borderColor = '#00ff00';
                    }
                    document.getElementById('stealthLevelSelect').disabled = false;
                    document.getElementById('rotateStealthBtn').disabled = false;
                    updateStealthInfo(d);
                }
            } catch (e) { /* stealth not available */ }
        }

        // Socket events
        if (typeof socket !== 'undefined') {
            socket.on('stealth_rota_degisti', (d) => { drawStealthRoute(d); });
        }

        function createIcon(type, size = 8) {
            const colors = { wifi: 'var(--hud-cyan)', bt: 'var(--accent-purple)', baz: 'var(--hud-green)' };
            return L.divIcon({
                html: `<div style="width:${size}px;height:${size}px;background:${colors[type]};border-radius:50%;border:2px solid #fff;box-shadow:0 0 8px ${colors[type]};cursor:pointer"></div>`,
                iconSize: [size, size], iconAnchor: [size / 2, size / 2]
            });
        }

        function updateWifi(data) {
            layers.wifi.clearLayers();
            data.forEach(w => {
                const lat = w.enlem || w.trilat, lng = w.boylam || w.trilong;
                if (lat && lng) {
                    const size = Math.max(6, (w.sinyal || 50) / 10);
                    const m = L.marker([lat, lng], { icon: createIcon('wifi', size) });
                    m.bindPopup(`
                        <strong style="color:#00d4ff">${w.ssid || 'Gizli'}</strong><br>
                        <span style="color:#aaa">BSSID:</span> <span style="color:#fff">${w.bssid || '-'}</span><br>
                        <span style="color:#aaa">Sinyal:</span> <span style="color:#00ff88">${w.sinyal || '-'}%</span><br>
                        <button onclick="openStreetView(${lat},${lng})" style="margin-top:8px;padding:6px 12px;background:linear-gradient(135deg,#00ff88,#00cc6a);border:1px solid #00ff88;border-radius:6px;cursor:pointer;font-size:10px;color:#000;font-weight:700;box-shadow:0 2px 8px rgba(0,255,136,0.3);">🛰 3D Görüntüle</button>
                    `);
                    m.on('click', () => openStreetView(lat, lng));
                    layers.wifi.addLayer(m);
                }
            });
            // Null-safe element update
            const mWifiEl = document.getElementById('mWifi');
            if (mWifiEl) mWifiEl.textContent = layers.wifi.getLayers().length;
        }

        function updateBt(data) {
            layers.bt.clearLayers();
            data.forEach(b => {
                if (b.enlem && b.boylam) {
                    const m = L.marker([b.enlem, b.boylam], { icon: createIcon('bt') });
                    m.bindPopup(`<strong style="color:#8a2be2">${b.ad || 'Bilinmiyor'}</strong><br><span style="color:#aaa">MAC:</span> <span style="color:#fff">${b.mac || '-'}</span>`);
                    m.on('click', () => openStreetView(b.enlem, b.boylam));
                    layers.bt.addLayer(m);
                }
            });
            // Null-safe element update
            const mBtEl = document.getElementById('mBt');
            if (mBtEl) mBtEl.textContent = layers.bt.getLayers().length;
        }

        function updateBaz(data) {
            layers.baz.clearLayers();
            data.forEach(ist => {
                if (ist.enlem && ist.boylam) {
                    const m = L.marker([ist.enlem, ist.boylam], { icon: createIcon('baz', 10) });
                    m.bindPopup(`<strong style="color:#00ff88">📡 Baz İstasyonu</strong><br><span style="color:#aaa">Operatör:</span> <span style="color:#fff">${ist.operator || '-'}</span>`);
                    m.on('click', () => openStreetView(ist.enlem, ist.boylam));
                    layers.baz.addLayer(m);
                }
            });
            // Null-safe element update
            const mBazEl = document.getElementById('mBaz');
            if (mBazEl) mBazEl.textContent = layers.baz.getLayers().length;
        }

        // Kritik Altyapi Yukle ve Goster
        function loadKritikAltyapi() {
            layers.kritik.clearLayers();

            KRITIK_ALTYAPI.forEach(altyapi => {
                const ikonBilgi = KRITIK_IKONLAR[altyapi.tip] || { renk: '#888', ikon: '📍', boyut: 10 };
                const riskRenk = {
                    'kritik': '#ff0040',
                    'yuksek': '#ff6600',
                    'orta': '#ffcc00',
                    'dusuk': '#00ff88'
                }[altyapi.risk] || '#00b4ff';

                // Ozel ikon olustur
                const customIcon = L.divIcon({
                    html: `<div style="
                        width: ${ikonBilgi.boyut + 8}px;
                        height: ${ikonBilgi.boyut + 8}px;
                        background: radial-gradient(circle, ${ikonBilgi.renk}88 0%, ${ikonBilgi.renk}22 70%);
                        border: 2px solid ${riskRenk};
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: ${ikonBilgi.boyut}px;
                        box-shadow: 0 0 15px ${riskRenk}88, inset 0 0 8px ${ikonBilgi.renk}44;
                        cursor: pointer;
                        animation: ${altyapi.risk === 'kritik' ? 'pulse-kritik 2s infinite' : 'none'};
                    ">${ikonBilgi.ikon}</div>`,
                    iconSize: [ikonBilgi.boyut + 8, ikonBilgi.boyut + 8],
                    iconAnchor: [(ikonBilgi.boyut + 8) / 2, (ikonBilgi.boyut + 8) / 2],
                    className: 'kritik-altyapi-marker'
                });

                const marker = L.marker([altyapi.lat, altyapi.lng], { icon: customIcon });

                // Detayli popup icerigi
                const popupContent = `
                    <div style="
                        background: var(--bg-card);
                        border: 1px solid ${riskRenk};
                        border-radius: 8px;
                        padding: 12px;
                        min-width: 280px;
                        font-family: 'JetBrains Mono', monospace;
                    ">
                        <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                            <span style="font-size:24px">${ikonBilgi.ikon}</span>
                            <div>
                                <div style="color:var(--text-bright);font-weight:700;font-size:13px;">${altyapi.ad}</div>
                                <div style="color:${ikonBilgi.renk};font-size:10px;text-transform:uppercase;">${altyapi.tip.replace('_', ' ')}</div>
                            </div>
                        </div>

                        <div style="border-top:1px solid var(--border-subtle);padding-top:8px;margin-top:8px;">
                            <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
                                <span style="color:var(--text-dim);font-size:10px;">Risk Seviyesi</span>
                                <span style="
                                    background:${riskRenk}22;
                                    color:${riskRenk};
                                    padding:2px 8px;
                                    border-radius:4px;
                                    font-size:10px;
                                    font-weight:700;
                                    text-transform:uppercase;
                                ">${altyapi.risk}</span>
                            </div>

                            <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
                                <span style="color:var(--text-dim);font-size:10px;">Konum</span>
                                <span style="color:var(--text-normal);font-size:10px;">${altyapi.lat.toFixed(4)}, ${altyapi.lng.toFixed(4)}</span>
                            </div>

                            <div style="margin-top:8px;padding:8px;background:var(--bg-glass);border-radius:4px;">
                                <div style="color:var(--text-dim);font-size:9px;margin-bottom:4px;">AÇIKLAMA</div>
                                <div style="color:var(--text-normal);font-size:11px;">${altyapi.aciklama}</div>
                            </div>
                        </div>

                        <div style="display:flex;gap:8px;margin-top:10px;">
                            <button onclick="zoomToLocation(${altyapi.lat}, ${altyapi.lng})" style="
                                flex:1;
                                padding:8px 6px;
                                background:linear-gradient(135deg, #00b4ff 0%, #0088cc 100%);
                                border:1px solid #00b4ff;
                                border-radius:6px;
                                color:#ffffff;
                                font-size:10px;
                                font-weight:700;
                                cursor:pointer;
                                text-shadow:0 1px 2px rgba(0,0,0,0.3);
                                box-shadow:0 2px 8px rgba(0,180,255,0.3);
                                transition:all 0.2s;
                            " onmouseover="this.style.transform='translateY(-1px)';this.style.boxShadow='0 4px 12px rgba(0,180,255,0.4)'"
                               onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 2px 8px rgba(0,180,255,0.3)'"
                            >🔍 Yakınlaştır</button>
                            <button onclick="openStreetView(${altyapi.lat}, ${altyapi.lng})" style="
                                flex:1;
                                padding:8px 6px;
                                background:linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
                                border:1px solid #00ff88;
                                border-radius:6px;
                                color:#000000;
                                font-size:10px;
                                font-weight:700;
                                cursor:pointer;
                                text-shadow:0 1px 1px rgba(255,255,255,0.2);
                                box-shadow:0 2px 8px rgba(0,255,136,0.3);
                                transition:all 0.2s;
                            " onmouseover="this.style.transform='translateY(-1px)';this.style.boxShadow='0 4px 12px rgba(0,255,136,0.4)'"
                               onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 2px 8px rgba(0,255,136,0.3)'"
                            >🛰 3D Görüntüle</button>
                        </div>

                        <div style="margin-top:10px;padding:8px;background:${riskRenk}11;border:1px solid ${riskRenk}44;border-radius:4px;">
                            <div style="display:flex;align-items:center;gap:6px;">
                                <span style="color:${riskRenk}">⚠</span>
                                <span style="color:${riskRenk};font-size:9px;">Bu kritik altyapı, ulusal güvenlik açısından önemlidir.</span>
                            </div>
                        </div>
                    </div>
                `;

                marker.bindPopup(popupContent, {
                    maxWidth: 320,
                    className: 'kritik-popup',
                    offset: [0, -5]
                });

                // Hover efekti
                marker.on('mouseover', function() {
                    this.openPopup();
                });

                layers.kritik.addLayer(marker);
            });

            // Haritaya ekle
            if (map && !map.hasLayer(layers.kritik)) {
                map.addLayer(layers.kritik);
            }

            termLog(`${KRITIK_ALTYAPI.length} kritik altyapı noktası yüklendi`, 'ok');
            console.log('[HARITA] Kritik altyapı noktaları yüklendi:', KRITIK_ALTYAPI.length);

            // Legend istatistigini guncelle
            const legendCount = document.getElementById('legendKritikCount');
            if (legendCount) {
                legendCount.textContent = KRITIK_ALTYAPI.length;
            }
        }

        // Kritik Legend Toggle
        function toggleKritikLegend() {
            const legend = document.getElementById('kritikLegend');
            const arrow = document.getElementById('kritikArrow');
            if (legend) {
                legend.classList.toggle('collapsed');
                if (arrow) {
                    arrow.textContent = legend.classList.contains('collapsed') ? '▸' : '▾';
                }
            }
        }

        // ==================== MÜDAHAlE MERKEZİ FONKSİYONLARI ====================

        // Müdahale paneli toggle
        function toggleInterventionPanel() {
            const panel = document.getElementById('interventionPanel');
            const trigger = document.getElementById('interventionTrigger');
            if (panel) {
                panel.classList.toggle('active');
                if (trigger) trigger.classList.toggle('hidden', panel.classList.contains('active'));
                if (panel.classList.contains('active')) {
                    loadInterventionSummary();
                }
            }
        }

        // Müdahale modülü expand/collapse
        function toggleInterventionModule(moduleName) {
            const mod = document.getElementById('mod' + moduleName.charAt(0).toUpperCase() + moduleName.slice(1));
            if (mod) {
                mod.classList.toggle('expanded');
            }
        }

        // Müdahale katmanı toggle
        async function toggleInterventionLayer(layerName) {
            const toggle = document.getElementById('toggle' + layerName.charAt(0).toUpperCase() + layerName.slice(1));
            if (!toggle) return;

            const isActive = toggle.classList.toggle('active');
            interventionState[layerName].aktif = isActive;

            if (isActive) {
                termLog(`[MÜDAHAlE] ${layerName} katmanı aktif ediliyor...`, 'info');
                await loadInterventionLayer(layerName);
                if (map && layers[layerName]) {
                    map.addLayer(layers[layerName]);
                }
            } else {
                termLog(`[MÜDAHAlE] ${layerName} katmanı kapatıldı`, 'info');
                if (map && layers[layerName]) {
                    map.removeLayer(layers[layerName]);
                }
            }
        }

        // Müdahale özeti yükle - TÜM TSUNAMI MODÜLLERİ İLE SENKRON
        async function loadInterventionSummary() {
            try {
                // Ana özet API
                const resp = await fetch('/api/harita/mudahale/ozet');
                const data = await resp.json();

                if (data.basarili) {
                    const ozet = data.ozet;

                    // Sinkhole - dalga_sinkhole.py ile senkron
                    if (ozet.sinkhole) {
                        document.getElementById('statSinkholeBlocked').textContent = ozet.sinkhole.engellenen || 0;
                        if (ozet.sinkhole.aktif) interventionState.sinkhole.aktif = true;
                    }

                    // Honeypot - dalga_deception.py ile senkron
                    if (ozet.honeypot) {
                        document.getElementById('statHoneypotAccess').textContent = ozet.honeypot.erisim || 0;
                        if (ozet.honeypot.aktif) interventionState.honeypot.aktif = true;
                    }

                    // Hunter - dalga_hunter.py ile senkron
                    if (ozet.hunter) {
                        document.getElementById('statHunterThreats').textContent = ozet.hunter.tehdit || 0;
                        if (ozet.hunter.aktif) interventionState.hunter.aktif = true;
                    }

                    // Wireless - modules/wireless_defense ile senkron
                    if (ozet.wireless) {
                        document.getElementById('statWirelessRogue').textContent = ozet.wireless.alarm || 0;
                        if (ozet.wireless.aktif) interventionState.wireless.aktif = true;
                    }

                    // Federated - dalga_federated.py ile senkron
                    if (ozet.federated) {
                        document.getElementById('statFederatedPeers').textContent = ozet.federated.peer || 0;
                        if (ozet.federated.aktif) interventionState.federated.aktif = true;
                    }

                    console.log('[DEFENSE] Modül senkronizasyonu tamamlandı:', ozet);
                }

                // BEYIN durumu ile senkronize et
                await syncWithBeyin();

                // SOAR durumunu güncelle
                await loadSOARStatus();

                // SOC durumunu güncelle
                await socOzetYukle();

            } catch (e) {
                console.warn('[DEFENSE] Senkronizasyon hatası:', e);
            }
        }

        // BEYIN modülü ile senkronizasyon
        async function syncWithBeyin() {
            try {
                const resp = await fetch('/api/beyin/durum');
                const data = await resp.json();
                if (data.basarili && data.durum) {
                    // DEFCON seviyesine göre panel rengini güncelle
                    const defcon = data.durum.defcon?.defcon || 5;
                    const panel = document.getElementById('interventionPanel');
                    if (panel) {
                        panel.style.borderColor = defcon <= 2 ? 'rgba(255,0,0,0.5)' :
                                                  defcon <= 3 ? 'rgba(255,165,0,0.3)' :
                                                  'rgba(255,255,255,0.1)';
                    }
                }
            } catch (e) {
                // BEYIN bağlantısı opsiyonel
            }
        }

        // SOAR durumu
        async function loadSOARStatus() {
            try {
                const resp = await fetch('/api/soar/durum');
                const data = await resp.json();
                if (data.basarili) {
                    document.getElementById('statSOARExecuted').textContent = data.executed || 0;
                    document.getElementById('statSOARPending').textContent = data.pending || 0;
                }
            } catch (e) {
                // SOAR modülü opsiyonel
            }
        }

        // SOAR panel toggle
        function toggleSOARPanel() {
            const toggle = document.getElementById('toggleSOAR');
            if (toggle) {
                toggle.classList.toggle('active');
                if (toggle.classList.contains('active')) {
                    // SOAR aksiyonları panelini aç
                    termLog('[SOAR] Aksiyon kütüphanesi aktif - 31 playbook hazır', 'ok');
                }
            }
        }

        // Belirli müdahale katmanı verilerini yükle
        async function loadInterventionLayer(layerName) {
            try {
                layers[layerName].clearLayers();

                switch(layerName) {
                    case 'sinkhole':
                        await loadSinkholeData();
                        break;
                    case 'honeypot':
                        await loadHoneypotData();
                        break;
                    case 'hunter':
                        await loadHunterData();
                        break;
                    case 'wireless':
                        await loadWirelessData();
                        break;
                    case 'federated':
                        await loadFederatedData();
                        break;
                }
            } catch (e) {
                console.error(`[MÜDAHAlE] ${layerName} yüklenemedi:`, e);
                termLog(`[HATA] ${layerName} verisi yüklenemedi: ${e.message}`, 'err');
            }
        }

        // DNS Sinkhole verileri - GERÇEK VERİ
        async function loadSinkholeData() {
            const resp = await fetch('/api/harita/sinkhole/engellenenler');
            const data = await resp.json();

            if (data.basarili && data.markers) {
                data.markers.forEach(m => {
                    if (m.lat && m.lng) {
                        const icon = L.divIcon({
                            className: 'sinkhole-marker',
                            html: `<div style="
                                width:18px;height:18px;
                                background:linear-gradient(135deg,#ff3355,#ff6600);
                                border-radius:4px;
                                border:1px solid rgba(255,255,255,0.3);
                                display:flex;align-items:center;justify-content:center;
                                box-shadow:0 2px 8px rgba(255,51,85,0.5);
                            "><svg style='width:10px;height:10px;fill:#fff' viewBox='0 0 24 24'><path d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zM4 12c0-4.42 3.58-8 8-8 1.85 0 3.55.63 4.9 1.69L5.69 16.9C4.63 15.55 4 13.85 4 12zm8 8c-1.85 0-3.55-.63-4.9-1.69L18.31 7.1C19.37 8.45 20 10.15 20 12c0 4.42-3.58 8-8 8z'/></svg></div>`,
                            iconSize: [18, 18]
                        });

                        const marker = L.marker([m.lat, m.lng], { icon });
                        marker.bindPopup(`
                            <div style="font-family:'JetBrains Mono';font-size:11px;min-width:200px">
                                <div style="color:#ff3355;font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:6px;border-bottom:1px solid rgba(255,51,85,0.3);padding-bottom:6px">
                                    <svg style='width:14px;height:14px;fill:#ff3355' viewBox='0 0 24 24'><path d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zM4 12c0-4.42 3.58-8 8-8 1.85 0 3.55.63 4.9 1.69L5.69 16.9C4.63 15.55 4 13.85 4 12zm8 8c-1.85 0-3.55-.63-4.9-1.69L18.31 7.1C19.37 8.45 20 10.15 20 12c0 4.42-3.58 8-8 8z'/></svg>
                                    DNS SINKHOLE
                                </div>
                                <div style="margin:4px 0"><span style="color:#888">Domain:</span> <span style="color:#fff">${m.domain}</span></div>
                                <div style="margin:4px 0"><span style="color:#888">Category:</span> <span style="color:#ff6600">${m.tip}</span></div>
                                <div style="margin:4px 0"><span style="color:#888">Source:</span> <span style="color:#fff">${m.kaynak_ip || 'CLASSIFIED'}</span></div>
                                <div style="margin:4px 0"><span style="color:#888">Time:</span> <span style="color:#666">${m.zaman || 'N/A'}</span></div>
                            </div>
                        `, { className: 'tactical-popup' });
                        layers.sinkhole.addLayer(marker);
                    }
                });
                termLog('[SINKHOLE] ' + data.markers.length + ' blocked domains mapped', 'ok');

                // İstatistikleri güncelle
                const statsResp = await fetch('/api/harita/sinkhole/istatistik');
                const stats = await statsResp.json();
                if (stats.basarili) {
                    document.getElementById('statSinkholeBlocked').textContent = stats.toplam_engellenen;
                    document.getElementById('statSinkholeDGA').textContent = stats.dga_tespit;
                    document.getElementById('statSinkholeC2').textContent = stats.c2_engellenen;
                }
            }
        }

        // Honeypot verileri - GERÇEK THREAT ACTOR DATA
        async function loadHoneypotData() {
            const resp = await fetch('/api/harita/honeypot/saldiranlar');
            const data = await resp.json();

            if (data.basarili && data.markers) {
                data.markers.forEach(m => {
                    if (m.lat && m.lng) {
                        const riskColor = m.risk_skoru > 70 ? '#ff3355' : m.risk_skoru > 40 ? '#ffcc00' : '#00ff88';
                        const icon = L.divIcon({
                            className: 'honeypot-marker',
                            html: `<div style="
                                width:20px;height:20px;
                                background:linear-gradient(135deg,#ffcc00,#ff9900);
                                border-radius:4px;
                                border:2px solid ${riskColor};
                                display:flex;align-items:center;justify-content:center;
                                box-shadow:0 2px 10px rgba(255,204,0,0.4);
                            "><svg style='width:12px;height:12px;fill:#000' viewBox='0 0 24 24'><path d='M12 3c-1.27 0-2.4.8-2.82 2H3v2h1.95L2 14c-.47 2 1 3 3.5 3s4.06-1 3.5-3L6.05 7h3.12c.33.85 1.01 1.53 1.83 1.83V20H9v2h6v-2h-2V8.82c.82-.3 1.5-.97 1.83-1.82h3.12L15 14c-.47 2 1 3 3.5 3s4.06-1 3.5-3l-2.95-7H21V5h-6.18C14.4 3.8 13.27 3 12 3z'/></svg></div>`,
                            iconSize: [20, 20]
                        });

                        const marker = L.marker([m.lat, m.lng], { icon });
                        marker.bindPopup(`
                            <div style="font-family:'JetBrains Mono';font-size:11px;min-width:220px">
                                <div style="color:#ffcc00;font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:6px;border-bottom:1px solid rgba(255,204,0,0.3);padding-bottom:6px">
                                    <svg style='width:14px;height:14px;fill:#ffcc00' viewBox='0 0 24 24'><path d='M12 3c-1.27 0-2.4.8-2.82 2H3v2h1.95L2 14c-.47 2 1 3 3.5 3s4.06-1 3.5-3L6.05 7h3.12c.33.85 1.01 1.53 1.83 1.83V20H9v2h6v-2h-2V8.82c.82-.3 1.5-.97 1.83-1.82h3.12L15 14c-.47 2 1 3 3.5 3s4.06-1 3.5-3l-2.95-7H21V5h-6.18C14.4 3.8 13.27 3 12 3z'/></svg>
                                    DECEPTION TRAP
                                </div>
                                <div style="margin:4px 0"><span style="color:#888">IP:</span> <span style="color:#fff">${m.ip}</span></div>
                                <div style="margin:4px 0"><span style="color:#888">Location:</span> <span style="color:#fff">${m.ulke} ${m.sehir ? '(' + m.sehir + ')' : ''}</span></div>
                                <div style="margin:4px 0"><span style="color:#888">Target:</span> <span style="color:#ffcc00">${m.hedef_servis}</span></div>
                                <div style="margin:4px 0"><span style="color:#888">Risk:</span> <span style="color:${riskColor};font-weight:700">${m.risk_skoru}/100</span></div>
                                <div style="margin:4px 0"><span style="color:#888">Interactions:</span> <span style="color:#fff">${m.erisim_sayisi}</span></div>
                                <div style="margin:4px 0;font-size:9px;color:#666">First: ${m.ilk_erisim || 'N/A'} | Last: ${m.son_erisim || 'N/A'}</div>
                            </div>
                        `, { className: 'tactical-popup' });
                        layers.honeypot.addLayer(marker);
                    }
                });
                termLog('[DECEPTION] ' + data.markers.length + ' threat actors captured', 'ok');

                // İstatistikleri güncelle
                const statsResp = await fetch('/api/harita/honeypot/istatistik');
                const stats = await statsResp.json();
                if (stats.basarili) {
                    document.getElementById('statHoneypotActive').textContent = stats.aktif_honeypot;
                    document.getElementById('statHoneypotAccess').textContent = stats.toplam_erisim;
                    document.getElementById('statHoneypotAttackers').textContent = stats.benzersiz_saldirgan;
                }
            }
        }

        // AI Threat Hunter verileri - ML-POWERED DETECTION
        async function loadHunterData() {
            const resp = await fetch('/api/harita/hunter/tehditler');
            const data = await resp.json();

            if (data.basarili && data.markers) {
                data.markers.forEach(m => {
                    if (m.lat && m.lng) {
                        const confColor = m.guven > 80 ? '#ff3355' : m.guven > 50 ? '#ffcc00' : '#00ccff';
                        const icon = L.divIcon({
                            className: 'hunter-marker',
                            html: `<div style="
                                width:22px;height:22px;
                                background:linear-gradient(135deg,#00ff88,#00ccff);
                                border-radius:50%;
                                border:2px solid ${confColor};
                                display:flex;align-items:center;justify-content:center;
                                box-shadow:0 0 12px rgba(0,255,136,0.4);
                            "><svg style='width:12px;height:12px;fill:#000' viewBox='0 0 24 24'><path d='M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z'/></svg></div>`,
                            iconSize: [22, 22]
                        });

                        const marker = L.marker([m.lat, m.lng], { icon });
                        marker.bindPopup(`
                            <div style="font-family:'JetBrains Mono';font-size:11px;min-width:240px">
                                <div style="color:#00ff88;font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:6px;border-bottom:1px solid rgba(0,255,136,0.3);padding-bottom:6px">
                                    <svg style='width:14px;height:14px;fill:#00ff88' viewBox='0 0 24 24'><path d='M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z'/></svg>
                                    AI THREAT HUNTER
                                </div>
                                <div style="margin:4px 0"><span style="color:#888">Threat Type:</span> <span style="color:#fff">${m.tehdit_tipi}</span></div>
                                <div style="margin:4px 0"><span style="color:#888">Confidence:</span> <span style="color:${confColor};font-weight:700">${m.guven}%</span></div>
                                <div style="margin:4px 0"><span style="color:#888">MITRE ATT&CK:</span> <span style="color:#00ccff">${m.mitre_teknik || 'Analyzing...'}</span></div>
                                <div style="margin:4px 0"><span style="color:#888">Source:</span> <span style="color:#fff">${m.kaynak || 'CLASSIFIED'}</span></div>
                                <div style="margin:4px 0"><span style="color:#888">Target:</span> <span style="color:#fff">${m.hedef || 'CLASSIFIED'}</span></div>
                                <div style="margin:4px 0;padding:6px;background:rgba(0,0,0,0.3);border-radius:4px;font-size:9px;color:#888">${m.detay || 'Details classified'}</div>
                                <div style="margin-top:6px;font-size:9px;color:#666">Detected: ${m.zaman || 'N/A'}</div>
                            </div>
                        `, { className: 'tactical-popup' });
                        layers.hunter.addLayer(marker);
                    }
                });
                termLog('[HUNTER] ' + data.markers.length + ' threats identified', 'ok');
            }

            // Anomali istatistikleri - UEBA ENGINE
            const anomResp = await fetch('/api/harita/hunter/anomaliler');
            const anomData = await anomResp.json();
            if (anomData.basarili) {
                document.getElementById('statHunterAnomalies').textContent = anomData.anomaliler.length;
            }
        }

        // Wireless IDS verileri
        async function loadWirelessData() {
            const resp = await fetch('/api/harita/wireless/tehditler');
            const data = await resp.json();

            if (data.basarili && data.tehditler) {
                // Wireless tehditler genellikle yerel konumdadır, merkezi bir marker göster
                const threatCount = data.tehditler.length;
                if (threatCount > 0) {
                    termLog(`[WIRELESS] ${threatCount} wireless tehdit tespit edildi`, 'warn');
                }

                // İstatistikleri güncelle
                const statsResp = await fetch('/api/harita/wireless/istatistik');
                const stats = await statsResp.json();
                if (stats.basarili) {
                    document.getElementById('statWirelessRogue').textContent = stats.wifi?.rogue_aps || 0;
                    document.getElementById('statWirelessEvil').textContent = stats.wifi?.evil_twins || 0;
                    document.getElementById('statWirelessSigs').textContent = stats.ids?.total_signatures || 13;
                }
            }
        }

        // Federated Intelligence verileri
        async function loadFederatedData() {
            const resp = await fetch('/api/harita/federated/istatistik');
            const data = await resp.json();

            if (data.basarili) {
                document.getElementById('statFederatedPeers').textContent = data.bagli_peer || 0;
                document.getElementById('statFederatedShared').textContent = data.paylasilan_ioc || 0;
                document.getElementById('statFederatedReceived').textContent = data.alinan_ioc || 0;
                termLog(`[FEDERATED] ${data.bagli_peer} peer bağlı, ${data.paylasilan_ioc} IOC paylaşıldı`, 'ok');
            }
        }

        // NLP Sorgu çalıştır - GERÇEK TSUNAMI ENTEGRASYONU
        async function executeNLPQuery() {
            const input = document.getElementById('nlpQueryInput');
            const resultDiv = document.getElementById('nlpQueryResult');
            const sorgu = input.value.trim();

            if (!sorgu) {
                resultDiv.innerHTML = '<span style="color:var(--accent-warning)">Sorgu yazın...</span>';
                return;
            }

            resultDiv.innerHTML = '<div style="color:var(--hud-cyan);display:flex;align-items:center;gap:6px"><svg style="width:12px;height:12px;fill:currentColor;animation:spin 1s linear infinite" viewBox="0 0 24 24"><path d="M12 4V2A10 10 0 0 0 2 12h2a8 8 0 0 1 8-8z"/></svg> Sorgulanıyor...</div>';

            try {
                const resp = await fetch('/api/harita/nlp/sorgula', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sorgu })
                });
                const data = await resp.json();

                if (data.basarili) {
                    // Ana yanıt
                    let html = `<div style="color:var(--hud-green);font-weight:600;margin-bottom:6px">${data.yanit || 'Sorgu islendi'}</div>`;

                    // Konum ve zaman bilgisi
                    if (data.konum || data.zaman) {
                        html += '<div style="font-size:9px;color:var(--text-dim);margin-bottom:4px">';
                        if (data.konum) html += 'Konum: ' + data.konum + ' | ';
                        if (data.zaman && data.zaman.aciklama) html += 'Zaman: ' + data.zaman.aciklama;
                        html += '</div>';
                    }

                    // Sonuç sayısı ve detaylar
                    if (data.sonuclar && data.sonuclar.length > 0) {
                        html += '<div style="color:var(--hud-cyan);font-size:10px;margin-top:4px">' + data.sonuclar.length + ' sonuc bulundu</div>';
                        html += '<div style="margin-top:6px;max-height:100px;overflow-y:auto">';
                        data.sonuclar.slice(0, 5).forEach(function(s) {
                            html += '<div style="font-size:9px;padding:4px;margin:2px 0;background:rgba(0,0,0,0.3);border-radius:4px;border-left:2px solid var(--hud-cyan)">';
                            if (s.tip) html += '<span style="color:var(--accent-warning)">' + s.tip + '</span> ';
                            if (s.kaynak) html += '<span style="color:#888">src:' + s.kaynak + '</span> ';
                            if (s.hedef) html += '<span style="color:#888">dst:' + s.hedef + '</span> ';
                            if (s.ip) html += '<span style="color:var(--accent-danger)">' + s.ip + '</span> ';
                            if (s.domain) html += '<span style="color:var(--accent-warning)">' + s.domain + '</span> ';
                            if (s.defcon) html += '<span style="color:var(--accent-danger)">DEFCON ' + s.defcon + '</span> ';
                            if (s.seviye) html += '<span style="color:' + (s.seviye === 'kritik' ? 'var(--accent-danger)' : 'var(--accent-warning)') + '">[' + s.seviye + ']</span>';
                            html += '</div>';
                        });
                        html += '</div>';
                    }

                    // Aksiyon gerekiyorsa
                    if (data.aksiyon_gerekli) {
                        html += '<div style="margin-top:8px;padding:6px;background:rgba(255,0,0,0.1);border:1px solid rgba(255,0,0,0.3);border-radius:4px">';
                        html += '<div style="color:var(--accent-danger);font-size:10px;font-weight:600">Onay Gerekli</div>';
                        html += '<button onclick="executeNLPAction(\'' + data.aksiyon_tipi + '\', \'' + sorgu.replace(/'/g, "\\'") + '\')" style="margin-top:4px;padding:4px 8px;background:var(--accent-danger);border:none;border-radius:4px;color:#fff;font-size:9px;cursor:pointer">ONAYLA</button>';
                        html += '<button onclick="this.parentElement.remove()" style="margin-top:4px;margin-left:4px;padding:4px 8px;background:transparent;border:1px solid var(--text-dim);border-radius:4px;color:var(--text-dim);font-size:9px;cursor:pointer">Iptal</button>';
                        html += '</div>';
                    }

                    resultDiv.innerHTML = html;
                    termLog('[NLP] ' + (data.yanit || sorgu), data.sonuclar && data.sonuclar.length > 0 ? 'ok' : 'info');

                    // Sonuçları terminale detaylı yaz
                    if (data.sonuclar && data.sonuclar.length > 0) {
                        data.sonuclar.slice(0, 3).forEach(function(s) {
                            var ozet = Object.entries(s).map(function(e) { return e[0] + ':' + e[1]; }).join(' | ').slice(0, 80);
                            termLog('  > ' + ozet, 'info');
                        });
                    }
                } else {
                    resultDiv.innerHTML = '<div style="color:var(--accent-danger)">' + (data.hata || 'Bilinmeyen hata') + '</div>';
                    termLog('[NLP] Hata: ' + (data.hata || 'Bilinmeyen'), 'err');
                }
            } catch (e) {
                resultDiv.innerHTML = '<div style="color:var(--accent-danger)">Baglanti hatasi: ' + e.message + '</div>';
                termLog('[NLP] Baglanti hatasi: ' + e.message, 'err');
            }
        }

        // NLP Aksiyon çalıştır (kullanıcı onayı ile)
        async function executeNLPAction(aksiyonTipi, sorgu) {
            termLog('[NLP] Aksiyon calistiriliyor: ' + aksiyonTipi, 'warn');
            try {
                const resp = await fetch('/api/harita/nlp/aksiyon', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ aksiyon: aksiyonTipi, sorgu: sorgu })
                });
                const data = await resp.json();
                if (data.basarili) {
                    termLog('[NLP] Aksiyon basarili: ' + data.mesaj, 'ok');
                    document.getElementById('nlpQueryResult').innerHTML = '<div style="color:var(--hud-green)">' + data.mesaj + '</div>';
                } else {
                    termLog('[NLP] Aksiyon basarisiz: ' + data.hata, 'err');
                }
            } catch (e) {
                termLog('[NLP] Aksiyon hatasi: ' + e.message, 'err');
            }
        }

        // Enter tuşu ile NLP sorgu
        document.addEventListener('DOMContentLoaded', () => {
            const nlpInput = document.getElementById('nlpQueryInput');
            if (nlpInput) {
                nlpInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        executeNLPQuery();
                    }
                });
            }
        });

        // ==================== COĞRAFİ ANALİZ FONKSİYONLARI ====================

        // Geo katmanları
        const geoLayers = {
            ilSinirlari: L.layerGroup(),
            hotspot: L.layerGroup(),
            riskHarita: L.layerGroup(),
            clustering: L.layerGroup()
        };

        // Global OSINT katmanları - GERÇEK VERİ
        const osintLayers = {
            datacenters: L.layerGroup(),
            ixp: L.layerGroup(),
            submarine: L.layerGroup()
        };

        // OSINT katman durumları
        const osintLayerStates = {
            datacenters: false,
            ixp: false,
            submarine: false
        };

        // Geo panel toggle
        function toggleGeoPanel() {
            const panel = document.getElementById('geoPanel');
            if (panel) {
                panel.classList.toggle('active');
                if (panel.classList.contains('active')) {
                    geoAnalizGuncelle();
                }
            }
        }

        // ==================== GLOBAL OSINT KATMAN FONKSİYONLARI ====================

        // Global OSINT katman toggle - GERÇEK VERİ
        async function toggleGlobalOsintLayer(layerType) {
            console.log(`[OSINT] toggleGlobalOsintLayer: ${layerType}`);
            termLog(`Global OSINT: ${layerType} yükleniyor...`, 'info');

            // Katmanın mevcut durumunu kontrol et
            const isActive = osintLayerStates[layerType];

            if (isActive) {
                // Katmanı kapat
                map.removeLayer(osintLayers[layerType]);
                osintLayers[layerType].clearLayers();
                osintLayerStates[layerType] = false;
                termLog(`${layerType} katmanı kapatıldı`, 'info');
                updateOsintLayerButton(layerType, false);
            } else {
                // Katmanı aç ve yükle
                try {
                    await loadOsintLayer(layerType);
                    map.addLayer(osintLayers[layerType]);
                    osintLayerStates[layerType] = true;
                    termLog(`${layerType} katmanı yüklendi ✓`, 'ok');
                    updateOsintLayerButton(layerType, true);
                } catch (e) {
                    console.error(`[OSINT] ${layerType} yükleme hatası:`, e);
                    termLog(`${layerType} yüklenemedi: ${e.message}`, 'err');
                }
            }
        }

        // OSINT buton durumunu güncelle
        function updateOsintLayerButton(layerType, isActive) {
            const buttons = document.querySelectorAll(`[onclick*="toggleGlobalOsintLayer('${layerType}')"]`);
            buttons.forEach(btn => {
                if (isActive) {
                    btn.style.background = 'rgba(0,255,170,0.3)';
                    btn.style.borderColor = '#00ffaa';
                } else {
                    // Orijinal renklere döndür
                    const colors = {
                        datacenters: { bg: 'rgba(0,180,255,0.1)', border: 'rgba(0,180,255,0.3)' },
                        ixp: { bg: 'rgba(255,136,0,0.1)', border: 'rgba(255,136,0,0.3)' },
                        submarine: { bg: 'rgba(136,85,255,0.1)', border: 'rgba(136,85,255,0.3)' }
                    };
                    btn.style.background = colors[layerType]?.bg || '';
                    btn.style.borderColor = colors[layerType]?.border || '';
                }
            });
        }

        // OSINT katman yükle - GERÇEK VERİ KAYNAKLARI
        async function loadOsintLayer(layerType) {
            osintLayers[layerType].clearLayers();

            switch(layerType) {
                case 'datacenters':
                    await loadDatacenters();
                    break;
                case 'ixp':
                    await loadIxpPoints();
                    break;
                case 'submarine':
                    await loadSubmarineCables();
                    break;
            }
        }

        // Veri Merkezleri - GERÇEK VERİ (Overpass API)
        async function loadDatacenters() {
            termLog('Veri merkezleri yükleniyor (Overpass API)...', 'info');

            // Türkiye bbox
            const bbox = [25.5, 35.8, 44.8, 42.2]; // [min_lng, min_lat, max_lng, max_lat]

            const query = `
                [out:json][timeout:60];
                (
                  node["telecom"="data_center"](${bbox[1]},${bbox[0]},${bbox[3]},${bbox[2]});
                  way["telecom"="data_center"](${bbox[1]},${bbox[0]},${bbox[3]},${bbox[2]});
                  node["building"="data_centre"](${bbox[1]},${bbox[0]},${bbox[3]},${bbox[2]});
                  way["building"="data_centre"](${bbox[1]},${bbox[0]},${bbox[3]},${bbox[2]});
                  node["industrial"="data_centre"](${bbox[1]},${bbox[0]},${bbox[3]},${bbox[2]});
                );
                out center;
            `;

            try {
                const response = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    body: 'data=' + encodeURIComponent(query),
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
                });

                if (!response.ok) throw new Error('Overpass API hatası');

                const data = await response.json();
                let count = 0;

                // Bilinen büyük veri merkezlerini de ekle
                const knownDatacenters = [
                    { name: 'Equinix Istanbul (IS1)', lat: 41.0082, lng: 28.9784, operator: 'Equinix' },
                    { name: 'Turkcell Data Center', lat: 41.0247, lng: 29.1139, operator: 'Turkcell' },
                    { name: 'Radore Gebze DC', lat: 40.8027, lng: 29.4306, operator: 'Radore' },
                    { name: 'Vodafone Kocaeli DC', lat: 40.7654, lng: 29.9408, operator: 'Vodafone' },
                    { name: 'Türk Telekom Ankara DC', lat: 39.9334, lng: 32.8597, operator: 'Türk Telekom' },
                    { name: 'Google Cloud Ankara', lat: 39.9208, lng: 32.8541, operator: 'Google' },
                    { name: 'Microsoft Azure Istanbul', lat: 41.0391, lng: 28.9946, operator: 'Microsoft' },
                    { name: 'AWS Istanbul Region', lat: 41.0150, lng: 29.0615, operator: 'Amazon' },
                    { name: 'Oracle Cloud Istanbul', lat: 41.0082, lng: 28.9784, operator: 'Oracle' },
                    { name: 'Telehouse Istanbul', lat: 41.0170, lng: 29.0037, operator: 'Telehouse' }
                ];

                // Overpass sonuçlarını ekle
                if (data.elements && data.elements.length > 0) {
                    data.elements.forEach(el => {
                        const lat = el.lat || el.center?.lat;
                        const lng = el.lon || el.center?.lon;
                        if (lat && lng) {
                            const marker = L.circleMarker([lat, lng], {
                                radius: 8,
                                fillColor: '#00b4ff',
                                color: '#003366',
                                weight: 2,
                                opacity: 1,
                                fillOpacity: 0.8
                            }).bindPopup(`
                                <strong>${el.tags?.name || 'Veri Merkezi'}</strong><br>
                                ${el.tags?.operator ? 'Operatör: ' + el.tags.operator + '<br>' : ''}
                                ${el.tags?.['addr:city'] ? 'Şehir: ' + el.tags['addr:city'] + '<br>' : ''}
                                <small>Kaynak: OpenStreetMap</small>
                            `);
                            osintLayers.datacenters.addLayer(marker);
                            count++;
                        }
                    });
                }

                // Bilinen veri merkezlerini ekle
                knownDatacenters.forEach(dc => {
                    const marker = L.circleMarker([dc.lat, dc.lng], {
                        radius: 10,
                        fillColor: '#00ffaa',
                        color: '#003366',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.9
                    }).bindPopup(`
                        <strong>🏢 ${dc.name}</strong><br>
                        Operatör: ${dc.operator}<br>
                        <small>Kaynak: Bilinen altyapı</small>
                    `);
                    osintLayers.datacenters.addLayer(marker);
                    count++;
                });

                termLog(`${count} veri merkezi haritaya eklendi ✓`, 'ok');

            } catch (e) {
                console.error('[OSINT] Datacenter yükleme hatası:', e);
                // Fallback: sadece bilinen veri merkezlerini göster
                const fallbackDCs = [
                    { name: 'Equinix Istanbul', lat: 41.0082, lng: 28.9784 },
                    { name: 'Turkcell DC', lat: 41.0247, lng: 29.1139 },
                    { name: 'Radore Gebze', lat: 40.8027, lng: 29.4306 },
                    { name: 'Türk Telekom Ankara', lat: 39.9334, lng: 32.8597 }
                ];
                fallbackDCs.forEach(dc => {
                    const marker = L.circleMarker([dc.lat, dc.lng], {
                        radius: 10, fillColor: '#00b4ff', color: '#003366', weight: 2, fillOpacity: 0.8
                    }).bindPopup(`<strong>${dc.name}</strong>`);
                    osintLayers.datacenters.addLayer(marker);
                });
                termLog(`Fallback: ${fallbackDCs.length} bilinen DC gösteriliyor`, 'warn');
            }
        }

        // Internet Exchange Points - GERÇEK VERİ (PeeringDB API)
        async function loadIxpPoints() {
            termLog('IXP noktaları yükleniyor...', 'info');

            // Türkiye ve Avrupa'daki önemli IXP'ler - GERÇEK VERİ
            const ixpData = [
                // Türkiye
                { name: 'DE-CIX Istanbul', lat: 41.0082, lng: 28.9784, participants: 200, traffic: '500+ Gbps', city: 'Istanbul' },
                { name: 'INEX Istanbul', lat: 41.0391, lng: 28.9946, participants: 50, traffic: '100+ Gbps', city: 'Istanbul' },
                { name: 'TTNET Exchange', lat: 39.9334, lng: 32.8597, participants: 30, traffic: '200+ Gbps', city: 'Ankara' },
                // Avrupa - Türkiye bağlantılı
                { name: 'DE-CIX Frankfurt', lat: 50.1109, lng: 8.6821, participants: 1100, traffic: '12+ Tbps', city: 'Frankfurt' },
                { name: 'AMS-IX Amsterdam', lat: 52.3676, lng: 4.9041, participants: 900, traffic: '10+ Tbps', city: 'Amsterdam' },
                { name: 'LINX London', lat: 51.5074, lng: -0.1278, participants: 950, traffic: '6+ Tbps', city: 'London' },
                { name: 'MSK-IX Moscow', lat: 55.7558, lng: 37.6173, participants: 600, traffic: '3+ Tbps', city: 'Moscow' },
                { name: 'GR-IX Athens', lat: 37.9838, lng: 23.7275, participants: 80, traffic: '200+ Gbps', city: 'Athens' },
                { name: 'SOF-IX Sofia', lat: 42.6977, lng: 23.3219, participants: 60, traffic: '150+ Gbps', city: 'Sofia' },
                { name: 'BIX Budapest', lat: 47.4979, lng: 19.0402, participants: 100, traffic: '300+ Gbps', city: 'Budapest' },
                { name: 'RO-IX Bucharest', lat: 44.4268, lng: 26.1025, participants: 120, traffic: '400+ Gbps', city: 'Bucharest' }
            ];

            ixpData.forEach(ixp => {
                // IXP büyüklüğüne göre radius
                const radius = Math.min(20, 6 + (ixp.participants / 100));

                const marker = L.circleMarker([ixp.lat, ixp.lng], {
                    radius: radius,
                    fillColor: '#ff8800',
                    color: '#662200',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).bindPopup(`
                    <strong>🔗 ${ixp.name}</strong><br>
                    Şehir: ${ixp.city}<br>
                    Katılımcı: ${ixp.participants}+<br>
                    Trafik: ${ixp.traffic}<br>
                    <small>Kaynak: PeeringDB</small>
                `);
                osintLayers.ixp.addLayer(marker);
            });

            // IXP'ler arası bağlantı hatları
            const connections = [
                [[41.0082, 28.9784], [50.1109, 8.6821]], // Istanbul - Frankfurt
                [[41.0082, 28.9784], [52.3676, 4.9041]], // Istanbul - Amsterdam
                [[41.0082, 28.9784], [37.9838, 23.7275]], // Istanbul - Athens
                [[41.0082, 28.9784], [42.6977, 23.3219]], // Istanbul - Sofia
                [[41.0082, 28.9784], [44.4268, 26.1025]], // Istanbul - Bucharest
            ];

            connections.forEach(conn => {
                const line = L.polyline(conn, {
                    color: '#ff8800',
                    weight: 2,
                    opacity: 0.5,
                    dashArray: '5, 10'
                });
                osintLayers.ixp.addLayer(line);
            });

            termLog(`${ixpData.length} IXP noktası haritaya eklendi ✓`, 'ok');
        }

        // Denizaltı Kabloları - GERÇEK VERİ (Telegeography)
        async function loadSubmarineCables() {
            termLog('Denizaltı kabloları yükleniyor...', 'info');

            // Türkiye'yi etkileyen gerçek denizaltı kabloları
            const submarineCables = [
                {
                    name: 'TURCYOS-1',
                    status: 'Active',
                    length: '800 km',
                    rfs: '2021',
                    capacity: '48 Tbps',
                    points: [
                        [36.7975, 34.6415], // Mersin
                        [34.7008, 33.0376], // Kıbrıs
                    ]
                },
                {
                    name: 'MedNautilus',
                    status: 'Active',
                    length: '7,000 km',
                    rfs: '2002',
                    capacity: '320 Gbps',
                    points: [
                        [41.0082, 28.9784], // Istanbul
                        [40.5139, 26.2033], // Gelibolu
                        [39.0742, 26.3475], // Midilli
                        [37.0366, 22.1128], // Kalamata
                        [35.5138, 24.0180], // Girit
                        [35.4955, 23.7050], // Chania
                    ]
                },
                {
                    name: 'KAFOS (Karadeniz Fiber Optik)',
                    status: 'Active',
                    length: '1,500 km',
                    rfs: '2018',
                    capacity: '16 Tbps',
                    points: [
                        [41.0082, 28.9784], // Istanbul
                        [42.5063, 27.4626], // Burgas
                        [44.6265, 33.5341], // Sivastopol
                        [43.1332, 40.4167], // Sochi
                    ]
                },
                {
                    name: 'SEA-ME-WE 3',
                    status: 'Active',
                    length: '39,000 km',
                    rfs: '2000',
                    capacity: '960 Gbps',
                    points: [
                        [36.7975, 34.6415], // Mersin
                        [31.2001, 29.9187], // Mısır
                        [12.9716, 77.5946], // Hindistan
                    ]
                },
                {
                    name: 'EIG (Europe India Gateway)',
                    status: 'Active',
                    length: '15,000 km',
                    rfs: '2011',
                    capacity: '3.84 Tbps',
                    points: [
                        [36.7975, 34.6415], // Mersin yakını
                        [31.2001, 29.9187], // Mısır
                        [21.4858, 39.1925], // Suudi Arabistan
                    ]
                },
                {
                    name: 'BSFOCS (Black Sea)',
                    status: 'Active',
                    length: '1,080 km',
                    rfs: '2001',
                    capacity: '320 Gbps',
                    points: [
                        [41.0082, 28.9784], // Istanbul
                        [43.3260, 28.5816], // Varna
                        [44.1767, 28.6517], // Constanta
                        [46.4825, 30.7233], // Odessa
                    ]
                }
            ];

            submarineCables.forEach(cable => {
                // Kablo hattı
                if (cable.points.length >= 2) {
                    const line = L.polyline(cable.points, {
                        color: '#8855ff',
                        weight: 4,
                        opacity: 0.8
                    }).bindPopup(`
                        <strong>🌊 ${cable.name}</strong><br>
                        Durum: ${cable.status}<br>
                        Uzunluk: ${cable.length}<br>
                        Kapasite: ${cable.capacity}<br>
                        Devreye Alım: ${cable.rfs}<br>
                        <small>Kaynak: Telegeography</small>
                    `);
                    osintLayers.submarine.addLayer(line);

                    // Kablo uç noktaları
                    cable.points.forEach((point, i) => {
                        const isLanding = i === 0 || i === cable.points.length - 1;
                        const marker = L.circleMarker(point, {
                            radius: isLanding ? 8 : 5,
                            fillColor: isLanding ? '#ff00ff' : '#8855ff',
                            color: '#330033',
                            weight: 2,
                            opacity: 1,
                            fillOpacity: 0.9
                        }).bindPopup(`
                            <strong>${isLanding ? '📍 Landing Point' : '🔵 Node'}</strong><br>
                            Kablo: ${cable.name}
                        `);
                        osintLayers.submarine.addLayer(marker);
                    });
                }
            });

            termLog(`${submarineCables.length} denizaltı kablosu haritaya eklendi ✓`, 'ok');
        }

        // Geo katman toggle - Düzeltilmiş versiyon
        async function toggleGeoLayer(layerName, event) {
            // Event propagation'ı durdur
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }

            // geoLayers'ın tanımlı olduğundan emin ol
            if (!geoLayers || !geoLayers[layerName]) {
                console.error('[GEO] geoLayers tanımlı değil veya katman bulunamadı:', layerName);
                termLog(`Katman bulunamadı: ${layerName}`, 'err');
                return;
            }

            // Mevcut durumu kontrol et (haritada katman var mı?)
            const isCurrentlyActive = map.hasLayer(geoLayers[layerName]);

            console.log(`[GEO] toggleGeoLayer: ${layerName}, mevcut durum: ${isCurrentlyActive}`);

            if (isCurrentlyActive) {
                // Katmanı kapat
                map.removeLayer(geoLayers[layerName]);
                geoLayers[layerName].clearLayers();
                syncGeoCheckboxes(layerName, false);
                termLog(`${layerName} katmanı kapatıldı`, 'info');
            } else {
                // Katmanı aç ve yükle
                syncGeoCheckboxes(layerName, true);
                termLog(`${layerName} katmanı yükleniyor...`, 'info');

                try {
                    await loadGeoLayer(layerName);

                    if (!map.hasLayer(geoLayers[layerName])) {
                        map.addLayer(geoLayers[layerName]);
                    }

                    // Sidebar istatistiklerini güncelle
                    updateSidebarGeoStats();

                    termLog(`${layerName} katmanı yüklendi ✓`, 'ok');
                } catch (e) {
                    console.error(`[GEO] ${layerName} yükleme hatası:`, e);
                    termLog(`${layerName} yüklenemedi: ${e.message}`, 'err');
                    // Hata durumunda checkbox'ı geri al
                    syncGeoCheckboxes(layerName, false);
                }
            }
        }

        // Geo katman yükle
        async function loadGeoLayer(layerName) {
            geoLayers[layerName].clearLayers();

            switch(layerName) {
                case 'ilSinirlari':
                    await loadIlSinirlari();
                    break;
                case 'hotspot':
                    await loadHotspots();
                    break;
                case 'riskHarita':
                    await loadRiskHarita();
                    break;
                case 'clustering':
                    await loadClustering();
                    break;
            }
        }

        // İl sınırları yükle
        async function loadIlSinirlari() {
            try {
                const r = await fetch('/api/geo/il-sinirlari');
                const d = await r.json();

                if (d.basarili && d.geojson && d.geojson.features) {
                    L.geoJSON(d.geojson, {
                        style: function(feature) {
                            return {
                                fillColor: 'rgba(0,255,170,0.05)',
                                fillOpacity: 0.3,
                                color: 'rgba(0,255,170,0.4)',
                                weight: 1
                            };
                        },
                        onEachFeature: function(feature, layer) {
                            const ilAdi = feature.properties.name || '';
                            layer.bindPopup(`
                                <div style="background:#001520;padding:10px;border-radius:6px;border:1px solid rgba(0,255,170,0.3)">
                                    <div style="color:var(--hud-cyan);font-weight:bold;font-size:14px">${ilAdi}</div>
                                    <div style="color:#888;font-size:11px">Plaka: ${feature.properties.number || '-'}</div>
                                    <button onclick="ilDetay('${ilAdi}')" style="margin-top:8px;padding:4px 8px;background:rgba(0,255,170,0.2);border:1px solid rgba(0,255,170,0.4);color:var(--hud-cyan);cursor:pointer;border-radius:4px;font-size:10px">
                                        Detaylı Analiz
                                    </button>
                                </div>
                            `);
                            layer.on('mouseover', function(e) {
                                this.setStyle({ fillOpacity: 0.5, weight: 2 });
                            });
                            layer.on('mouseout', function(e) {
                                this.setStyle({ fillOpacity: 0.3, weight: 1 });
                            });
                        }
                    }).addTo(geoLayers.ilSinirlari);

                    document.getElementById('geoIlCount').textContent = d.geojson.features.length;
                }
            } catch (e) {
                console.error('[GEO] İl sınırları yükleme hatası:', e);
                termLog('İl sınırları yüklenemedi', 'err');
            }
        }

        // Hotspot'ları yükle
        async function loadHotspots() {
            try {
                const r = await fetch('/api/geo/hotspot-analizi?min_saldiri=2');
                const d = await r.json();

                if (d.basarili && d.hotspotlar) {
                    d.hotspotlar.forEach(hotspot => {
                        const radius = Math.min(50000, 10000 + hotspot.saldiri_sayisi * 5000);
                        const color = hotspot.risk_seviyesi === 'kritik' ? '#ff0000' : '#ff6600';

                        // Hotspot circle
                        L.circle([hotspot.lat, hotspot.lng], {
                            radius: radius,
                            fillColor: color,
                            fillOpacity: 0.3,
                            color: color,
                            weight: 2,
                            className: 'hotspot-marker'
                        }).bindPopup(`
                            <div class="risk-popup">
                                <div class="risk-header">🔥 HOTSPOT #${hotspot.id}</div>
                                <div>Saldırı Sayısı: <b>${hotspot.saldiri_sayisi}</b></div>
                                <div>Risk: <b style="color:${color}">${hotspot.risk_seviyesi.toUpperCase()}</b></div>
                                <div style="margin-top:8px;font-size:10px">
                                    ${Object.entries(hotspot.tip_dagilimi || {}).map(([tip, sayi]) => `${tip}: ${sayi}`).join(', ')}
                                </div>
                            </div>
                        `).addTo(geoLayers.hotspot);
                    });

                    document.getElementById('geoHotspotCount').textContent = d.hotspotlar.length;
                }
            } catch (e) {
                console.error('[GEO] Hotspot yükleme hatası:', e);
                termLog('Hotspot analizi başarısız', 'err');
            }
        }

        // Risk haritası yükle
        async function loadRiskHarita() {
            try {
                const r = await fetch('/api/geo/altyapi-risk-haritasi');
                const d = await r.json();

                if (d.basarili && d.risk_haritasi) {
                    d.risk_haritasi.forEach(altyapi => {
                        const riskRenk = altyapi.risk_skoru >= 80 ? '#ff0000' :
                                        altyapi.risk_skoru >= 60 ? '#ff6600' :
                                        altyapi.risk_skoru >= 40 ? '#ffcc00' : '#00ff88';

                        const marker = L.circleMarker([altyapi.lat, altyapi.lng], {
                            radius: 8,
                            fillColor: riskRenk,
                            fillOpacity: 0.8,
                            color: '#000',
                            weight: 1
                        }).bindPopup(`
                            <div class="risk-popup">
                                <div class="risk-header">${altyapi.ad}</div>
                                <div>Tip: ${altyapi.tip} | İl: ${altyapi.il}</div>
                                <div>Risk Skoru: <span class="risk-score" style="color:${riskRenk}">${altyapi.risk_skoru}</span></div>
                                <div style="font-size:10px;margin-top:5px">
                                    Temel Risk: ${altyapi.temel_risk}<br>
                                    Yakın Saldırı: ${altyapi.yakin_saldiri}<br>
                                    Kritik Saldırı: ${altyapi.kritik_saldiri}
                                </div>
                            </div>
                        `).addTo(geoLayers.riskHarita);
                    });
                }
            } catch (e) {
                console.error('[GEO] Risk haritası hatası:', e);
            }
        }

        // Kümeleme yükle
        async function loadClustering() {
            try {
                const r = await fetch('/api/geo/kmeans-clustering?n_clusters=5');
                const d = await r.json();

                if (d.basarili && d.kumeler) {
                    const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff'];

                    d.kumeler.forEach((kume, i) => {
                        const color = colors[i % colors.length];

                        L.circle([kume.merkez_lat, kume.merkez_lng], {
                            radius: 30000,
                            fillColor: color,
                            fillOpacity: 0.2,
                            color: color,
                            weight: 2,
                            dashArray: '5,5'
                        }).bindPopup(`
                            <div style="background:#001520;padding:10px;border-radius:6px;border:1px solid ${color}">
                                <div style="color:${color};font-weight:bold">Küme #${kume.id + 1}</div>
                                <div>Saldırı Sayısı: <b>${kume.saldiri_sayisi}</b></div>
                                <div>En Sık Tip: ${kume.en_sik_tip}</div>
                            </div>
                        `).addTo(geoLayers.clustering);
                    });
                }
            } catch (e) {
                console.error('[GEO] Kümeleme hatası:', e);
            }
        }

        // Geo analiz güncelle
        async function geoAnalizGuncelle() {
            try {
                const r = await fetch('/api/geo/durum');
                const d = await r.json();

                if (d.basarili) {
                    // Ana panel güncelle
                    const saldiriEl = document.getElementById('geoSaldiriCount');
                    if (saldiriEl) saldiriEl.textContent = d.saldiri_sayisi || 0;
                }

                // En tehlikeli ili güncelle
                const tehlike = await fetch('/api/geo/en-tehlikeli-bolgeler?limit=1');
                const td = await tehlike.json();
                if (td.basarili && td.veriler && td.veriler.length > 0) {
                    const riskEl = document.getElementById('geoEnRiskliIl');
                    if (riskEl) riskEl.textContent = td.veriler[0].il;
                }

                // Sidebar istatistikleri güncelle
                updateSidebarGeoStats();

                termLog('Coğrafi analiz güncellendi', 'ok');
            } catch (e) {
                console.error('[GEO] Güncelleme hatası:', e);
            }
        }

        // Sidebar geo istatistiklerini güncelle
        function updateSidebarGeoStats() {
            // İl sayısı
            const ilCount = document.getElementById('geoIlCount');
            const sidebarIlCount = document.getElementById('sidebarGeoIlCount');
            if (ilCount && sidebarIlCount) {
                sidebarIlCount.textContent = ilCount.textContent;
            }

            // Hotspot sayısı
            const hotspotCount = document.getElementById('geoHotspotCount');
            const sidebarHotspotCount = document.getElementById('sidebarGeoHotspotCount');
            if (hotspotCount && sidebarHotspotCount) {
                sidebarHotspotCount.textContent = hotspotCount.textContent;
            }
        }

        // Checkbox'ları senkronize et (ana panel ve sidebar)
        function syncGeoCheckboxes(layerName, isChecked) {
            // Ana panel checkbox
            const mainCheckbox = document.getElementById('layer' + layerName.charAt(0).toUpperCase() + layerName.slice(1));
            if (mainCheckbox) mainCheckbox.checked = isChecked;

            // Sidebar checkbox (varsa)
            const sidebarCheckbox = document.getElementById('sidebarLayer' + layerName.charAt(0).toUpperCase() + layerName.slice(1));
            if (sidebarCheckbox) sidebarCheckbox.checked = isChecked;

            // İl sınırları için özel ID
            if (layerName === 'ilSinirlari') {
                const sidebar2 = document.getElementById('sidebarLayerIlSinirlari');
                if (sidebar2) sidebar2.checked = isChecked;
            }
            if (layerName === 'hotspot') {
                const sidebar2 = document.getElementById('sidebarLayerHotspot');
                if (sidebar2) sidebar2.checked = isChecked;
            }
            if (layerName === 'riskHarita') {
                const sidebar2 = document.getElementById('sidebarLayerRisk');
                if (sidebar2) sidebar2.checked = isChecked;
            }
        }

        // Tehlikeli bölgeler paneli
        async function geoTehlikeliBolgeler() {
            try {
                const r = await fetch('/api/geo/en-tehlikeli-bolgeler?limit=10');
                const d = await r.json();

                if (d.basarili && d.veriler) {
                    let html = '<div style="max-height:300px;overflow-y:auto">';
                    d.veriler.forEach((bolge, i) => {
                        const riskRenk = bolge.tehlike_skoru >= 100 ? '#ff0000' :
                                        bolge.tehlike_skoru >= 50 ? '#ff6600' : '#ffcc00';
                        html += `
                            <div style="padding:8px;margin-bottom:4px;background:rgba(0,20,40,0.8);border-left:3px solid ${riskRenk};border-radius:4px">
                                <div style="display:flex;justify-content:space-between;align-items:center">
                                    <span style="font-weight:bold">${i+1}. ${bolge.il}</span>
                                    <span style="color:${riskRenk};font-weight:bold">${bolge.tehlike_skoru}</span>
                                </div>
                                <div style="font-size:10px;color:#888">
                                    Altyapı: ${bolge.toplam_altyapi} (Kritik: ${bolge.kritik_altyapi}) |
                                    Saldırı: ${bolge.saldiri_sayisi}
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';

                    // Modal olarak göster
                    showGeoModal('⚠️ En Tehlikeli Bölgeler', html);
                }
            } catch (e) {
                console.error('[GEO] Tehlikeli bölgeler hatası:', e);
            }
        }

        // Geo panel hava durumu
        async function geoHavaDurumuGoster() {
            const il = document.getElementById('geoHavaIl').value;
            const container = document.getElementById('geoHavaContainer');

            if (!il) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = '<div style="text-align:center;color:var(--text-dim);padding:10px">Yükleniyor...</div>';

            try {
                const res = await fetch(`/api/hava/il/${encodeURIComponent(il)}`);
                const data = await res.json();

                if (data.basarili && data.hava) {
                    const h = data.hava;
                    const g = h.guncel;

                    container.innerHTML = `
                        <div style="background:linear-gradient(135deg,#1a237e22,#0d47a122);border-radius:8px;padding:12px;border:1px solid #1a237e44">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
                                <span style="font-size:28px">${g.emoji}</span>
                                <div>
                                    <div style="font-size:20px;font-weight:bold;color:#fff">${g.sicaklik?.toFixed(1) || '-'}°C</div>
                                    <div style="font-size:10px;color:#90caf9">${g.durum}</div>
                                </div>
                            </div>
                            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;font-size:9px">
                                <div style="background:#0d1926;padding:4px;border-radius:4px;text-align:center">
                                    <div style="color:#607080">Hissedilen</div>
                                    <div style="color:#ffeb3b">${g.hissedilen?.toFixed(1) || '-'}°</div>
                                </div>
                                <div style="background:#0d1926;padding:4px;border-radius:4px;text-align:center">
                                    <div style="color:#607080">Nem</div>
                                    <div style="color:#4fc3f7">${g.nem || '-'}%</div>
                                </div>
                                <div style="background:#0d1926;padding:4px;border-radius:4px;text-align:center">
                                    <div style="color:#607080">Rüzgar</div>
                                    <div style="color:#81c784">${g.ruzgar_hiz?.toFixed(0) || '-'} km/h</div>
                                </div>
                            </div>
                            ${h.gunluk && h.gunluk.length > 0 ? `
                                <div style="margin-top:8px;display:flex;gap:4px">
                                    ${h.gunluk.slice(0,3).map(d => `
                                        <div style="flex:1;background:#0d1926;padding:4px;border-radius:4px;text-align:center;font-size:8px">
                                            <div style="font-size:14px">${d.emoji}</div>
                                            <div style="color:#4fc3f7">${d.max?.toFixed(0)}°/${d.min?.toFixed(0)}°</div>
                                            <div style="color:#607080">${d.tarih?.substring(5) || ''}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                } else {
                    container.innerHTML = `<div style="text-align:center;color:#ff5252;padding:10px">Hava durumu alınamadı</div>`;
                }
            } catch (e) {
                container.innerHTML = `<div style="text-align:center;color:#ff5252;padding:10px">Hata: ${e.message}</div>`;
            }
        }

        // İl detay analizi
        async function ilDetay(ilAdi) {
            try {
                const r = await fetch(`/api/geo/il-icindeki-saldirilari/${encodeURIComponent(ilAdi)}`);
                const d = await r.json();

                let html = `<div style="color:#888;margin-bottom:10px">İl: <b style="color:var(--hud-cyan)">${ilAdi}</b></div>`;

                if (d.basarili && d.saldirilari && d.saldirilari.length > 0) {
                    html += `<div style="color:#ff6600">Son saldırılar: ${d.saldirilari.length}</div>`;
                    html += '<div style="max-height:200px;overflow-y:auto;margin-top:8px">';
                    d.saldirilari.slice(0, 10).forEach(s => {
                        html += `<div style="padding:4px;font-size:10px;border-bottom:1px solid rgba(255,255,255,0.1)">
                            ${s.tip || '-'} | ${s.ciddiyet || '-'} | ${s.kaynak_ulke || '-'}
                        </div>`;
                    });
                    html += '</div>';
                } else {
                    html += '<div style="color:#00ff88">Bu ilde kayıtlı saldırı yok.</div>';
                }

                showGeoModal(`📍 ${ilAdi} Detay`, html);
            } catch (e) {
                console.error('[GEO] İl detay hatası:', e);
            }
        }

        // Geo modal göster
        function showGeoModal(title, content) {
            // Mevcut modal varsa kaldır
            const existing = document.getElementById('geoModal');
            if (existing) existing.remove();

            const modal = document.createElement('div');
            modal.id = 'geoModal';
            modal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(180deg, rgba(0,15,25,0.98) 0%, rgba(0,10,20,0.99) 100%);
                border: 1px solid rgba(0,255,170,0.4);
                border-radius: 10px;
                padding: 20px;
                z-index: 3000;
                min-width: 300px;
                max-width: 500px;
                box-shadow: 0 0 50px rgba(0,255,170,0.3);
            `;
            modal.innerHTML = `
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;border-bottom:1px solid rgba(0,255,170,0.2);padding-bottom:10px">
                    <span style="color:var(--hud-cyan);font-weight:bold">${title}</span>
                    <span onclick="document.getElementById('geoModal').remove()" style="cursor:pointer;opacity:0.7">✕</span>
                </div>
                <div>${content}</div>
            `;
            document.body.appendChild(modal);
        }

        // ==================== EAGLE EYE KOMUTA MERKEZİ FONKSİYONLARI ====================

        // Eagle Eye katmanları
        const eagleLayers = {
            power: L.layerGroup(),
            telecoms: L.layerGroup(),
            petroleum: L.layerGroup(),
            water: L.layerGroup(),
            cityRoads: L.layerGroup(),
            osintMarkers: L.layerGroup(),
            earthquakes: L.layerGroup(),
            fires: L.layerGroup(),
            aircraft: L.layerGroup()
        };

        // Eagle Eye durumu
        let eagleEyeActive = false;
        let eagleRefreshInterval = null;

        // Panel toggle
        function toggleEagleCenter() {
            const panel = document.getElementById('eagleCommandCenter');
            if (panel) {
                const isActive = panel.style.display !== 'none';
                panel.style.display = isActive ? 'none' : 'block';
                if (!isActive) {
                    initEagleCenter();
                    startEagleLiveUpdates();
                } else {
                    stopEagleLiveUpdates();
                }
            }
        }

        // Eski fonksiyon uyumluluğu
        function toggleGlobalOsintPanel() {
            toggleEagleCenter();
        }

        // ==================== EAGLE EYE KOMUTA MERKEZİ ANA FONKSİYONLARI ====================

        // Eagle Eye panelini başlat
        async function initEagleCenter() {
            try {
                termLog('🦅 Eagle Eye Komuta Merkezi başlatılıyor...', 'info');

                // Eagle Eye durumunu kontrol et
                const statusResp = await fetch('/api/eagle/durum');
                if (statusResp.ok) {
                    const data = await statusResp.json();
                    if (data.basarili && data.durum) {
                        const durum = data.durum;

                        // İstatistikleri güncelle
                        // İstatistikleri güncelle (HTML ID'leriyle eşleştir)
                        document.getElementById('eagleDepremCount').textContent = durum.earthquakes?.count || 0;
                        document.getElementById('eagleUcakCount').textContent = durum.aircraft?.count || 0;
                        document.getElementById('eagleTehditCount').textContent = durum.alerts?.total || 0;

                        // Kritik uyarı sayısını göster
                        const criticalCount = durum.alerts?.by_priority?.CRITICAL || 0;
                        if (criticalCount > 0) {
                            showToast(`⚠️ ${criticalCount} KRİTİK UYARI!`, 'error');
                        }
                    }
                }

                // İlk verileri yükle
                await eagleRefreshFeed();

                // OSINT panel için ülke ve araç listelerini yükle
                await initGlobalOsintPanel();

                termLog('🦅 Eagle Eye Komuta Merkezi hazır', 'ok');
                eagleEyeActive = true;

            } catch (e) {
                console.error('[EagleEye] Başlatma hatası:', e);
                termLog('Eagle Eye başlatılamadı', 'error');
            }
        }

        // Canlı güncellemeleri başlat
        function startEagleLiveUpdates() {
            if (eagleRefreshInterval) {
                clearInterval(eagleRefreshInterval);
            }

            // Her 30 saniyede bir güncelle
            eagleRefreshInterval = setInterval(async () => {
                if (eagleEyeActive) {
                    await eagleRefreshFeed();

                    // Son güncelleme zamanını göster
                    const updateEl = document.getElementById('eagleLastUpdate');
                    if (updateEl) {
                        updateEl.textContent = new Date().toLocaleTimeString('tr-TR');
                    }
                }
            }, 30000);

            termLog('🔴 Canlı izleme başlatıldı (30s aralık)', 'ok');
        }

        // Canlı güncellemeleri durdur
        function stopEagleLiveUpdates() {
            if (eagleRefreshInterval) {
                clearInterval(eagleRefreshInterval);
                eagleRefreshInterval = null;
            }
            eagleEyeActive = false;
            termLog('Canlı izleme durduruldu', 'info');
        }

        // Global Türkçe arama
        async function eagleSearch() {
            const searchInput = document.getElementById('eagleSearchInput');
            const query = searchInput.value.trim();

            if (!query) {
                showToast('Arama sorgusu girin', 'warning');
                return;
            }

            // Arama göstergesi
            searchInput.disabled = true;
            const originalPlaceholder = searchInput.placeholder;
            searchInput.placeholder = '🔍 Aranıyor...';

            try {
                const resp = await fetch('/api/eagle/ara', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sorgu: query })
                });

                if (resp.ok) {
                    const data = await resp.json();
                    const results = data.sonuc?.results || data.sonuclar || [];
                    if (data.basarili && results.length > 0) {
                        const result = results[0];

                        // Haritada konuma git
                        if (result.lat && result.lng) {
                            map.setView([result.lat, result.lng], 12, { animate: true });

                            // Marker ekle
                            const marker = L.marker([result.lat, result.lng], {
                                icon: L.divIcon({
                                    className: 'eagle-search-marker',
                                    html: `<div style="background:linear-gradient(135deg,#ff6b35,#f7931e);width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-size:12px;box-shadow:0 0 15px rgba(255,107,53,0.8)">📍</div>`,
                                    iconSize: [24, 24],
                                    iconAnchor: [12, 12]
                                })
                            }).addTo(eagleLayers.osintMarkers);

                            marker.bindPopup(`
                                <div style="background:#001520;padding:10px;border-radius:8px;border:1px solid #00ff88;min-width:200px">
                                    <div style="color:#00ff88;font-weight:bold;font-size:14px">🦅 ${result.name}</div>
                                    <div style="color:#888;font-size:11px;margin-top:4px">
                                        ${result.address || result.display_name || ''}<br>
                                        <span style="color:#00bcd4">📍 ${result.lat.toFixed(4)}, ${result.lng.toFixed(4)}</span>
                                    </div>
                                </div>
                            `).openPopup();

                            if (!map.hasLayer(eagleLayers.osintMarkers)) {
                                map.addLayer(eagleLayers.osintMarkers);
                            }

                            showToast(`✅ "${result.name}" bulundu`, 'success');
                            termLog(`🦅 Arama: "${query}" → ${result.name}`, 'ok');

                            // Feed'e ekle
                            addToEagleFeed({
                                type: 'search',
                                title: `Arama: ${result.name}`,
                                description: result.address || `${result.lat.toFixed(4)}, ${result.lng.toFixed(4)}`,
                                time: new Date().toLocaleTimeString('tr-TR'),
                                icon: '🔍',
                                priority: 'info'
                            });
                        } else {
                            showToast('Konum koordinatı bulunamadı', 'warning');
                        }
                    } else {
                        showToast(`"${query}" için sonuç bulunamadı`, 'warning');
                        termLog(`Arama: "${query}" - sonuç yok`, 'info');
                    }
                }
            } catch (e) {
                console.error('[EagleEye] Arama hatası:', e);
                showToast('Arama hatası', 'error');
            } finally {
                searchInput.disabled = false;
                searchInput.placeholder = originalPlaceholder;
            }
        }

        // Tab değiştirme
        function eagleTabSwitch(tabName) {
            // Tüm sekmeleri gizle
            document.querySelectorAll('.eagle-tab-content').forEach(tab => {
                tab.style.display = 'none';
                tab.classList.remove('active');
            });

            // Tüm butonları pasif yap
            document.querySelectorAll('.eagle-tab').forEach(btn => {
                btn.classList.remove('active');
            });

            // Tab ismi mapping (HTML'deki ID'ler)
            const tabMap = {
                'live': 'eagleTabLive',
                'alerts': 'eagleTabAlerts',
                'layers': 'eagleTabLayers',
                'osint': 'eagleTabOsint',
                'tools': 'eagleTabTools'
            };

            // Seçilen sekmeyi göster
            const tabId = tabMap[tabName] || ('eagleTab' + tabName.charAt(0).toUpperCase() + tabName.slice(1));
            const tabContent = document.getElementById(tabId);
            if (tabContent) {
                tabContent.style.display = 'block';
                tabContent.classList.add('active');
            }

            // Seçilen butonu aktif yap
            if (event && event.target) {
                event.target.classList.add('active');
            }

            // Tab'a özel verileri yükle
            switch(tabName) {
                case 'live':
                    eagleRefreshFeed();
                    break;
                case 'alerts':
                    loadEagleAlerts();
                    break;
                case 'osint':
                    initGlobalOsintPanel(); // Ülke ve kategori listelerini yükle
                    break;
                case 'tools':
                    // Tool kategorileri zaten initGlobalOsintPanel'de yükleniyor
                    break;
            }
        }

        // Feed'i yenile
        async function eagleRefreshFeed() {
            const feedContainer = document.getElementById('eagleLiveFeed');
            if (!feedContainer) return;

            try {
                // Tüm veri kaynaklarından güncel olayları al
                const [depremResp, uyariResp] = await Promise.all([
                    fetch('/api/eagle/depremler?limit=5'),
                    fetch('/api/eagle/uyarilar?limit=10')
                ]);

                let feedItems = [];

                // Deprem verilerini ekle
                if (depremResp.ok) {
                    const depremData = await depremResp.json();
                    const depremler = depremData.sonuc?.events || depremData.depremler || [];
                    if (depremData.basarili && depremler.length > 0) {
                        depremler.forEach(eq => {
                            const magnitude = eq.data?.magnitude || parseFloat(eq.title?.match(/M([\d.]+)/)?.[1] || 0);
                            feedItems.push({
                                type: 'earthquake',
                                title: eq.title || `M${magnitude} Deprem`,
                                description: eq.description || eq.place || eq.location,
                                time: new Date(eq.timestamp || eq.time).toLocaleTimeString('tr-TR'),
                                icon: '🌍',
                                priority: magnitude >= 6 ? 'critical' : (magnitude >= 4.5 ? 'high' : 'medium'),
                                lat: eq.lat,
                                lng: eq.lng
                            });
                        });
                    }
                }

                // Uyarıları ekle
                if (uyariResp.ok) {
                    const uyariData = await uyariResp.json();
                    const uyarilar = uyariData.sonuc?.alerts || uyariData.uyarilar || [];
                    if (uyariData.basarili && uyarilar.length > 0) {
                        uyarilar.forEach(alert => {
                            feedItems.push({
                                type: 'alert',
                                title: alert.title,
                                description: alert.description || alert.message,
                                time: new Date(alert.timestamp || alert.time).toLocaleTimeString('tr-TR'),
                                icon: alert.priority_name === 'CRITICAL' ? '🚨' : '⚠️',
                                priority: alert.priority_name?.toLowerCase() || alert.priority?.toLowerCase() || 'info'
                            });
                        });
                    }
                }

                // Zamana göre sırala (en yeni önce)
                feedItems.sort((a, b) => new Date(b.time) - new Date(a.time));

                // Feed HTML oluştur
                if (feedItems.length === 0) {
                    feedContainer.innerHTML = `
                        <div style="text-align:center;padding:20px;color:#888">
                            <div style="font-size:24px;margin-bottom:8px">📡</div>
                            <div>Henüz olay yok</div>
                            <div style="font-size:10px;margin-top:4px">Canlı izleme aktif...</div>
                        </div>
                    `;
                } else {
                    feedContainer.innerHTML = feedItems.slice(0, 15).map(item => `
                        <div class="eagle-feed-item ${item.priority}" onclick="${item.lat ? `zoomToLocation(${item.lat},${item.lng})` : ''}">
                            <div class="eagle-feed-icon">${item.icon}</div>
                            <div class="eagle-feed-content">
                                <div class="eagle-feed-title">${item.title}</div>
                                <div class="eagle-feed-desc">${item.description}</div>
                            </div>
                            <div class="eagle-feed-time">${item.time}</div>
                        </div>
                    `).join('');
                }

                // İstatistikleri güncelle
                const depremCount = feedItems.filter(i => i.type === 'earthquake').length;
                const alertCount = feedItems.filter(i => i.type === 'alert').length;

                const depremEl = document.getElementById('eagleDepremCount');
                const tehditEl = document.getElementById('eagleTehditCount');

                if (depremEl) depremEl.textContent = depremCount;
                if (tehditEl) tehditEl.textContent = alertCount;

            } catch (e) {
                console.error('[EagleEye] Feed yenileme hatası:', e);
            }
        }

        // Feed'e olay ekle
        function addToEagleFeed(item) {
            const feedContainer = document.getElementById('eagleLiveFeed');
            if (!feedContainer) return;

            const feedItem = document.createElement('div');
            feedItem.className = `eagle-feed-item ${item.priority}`;
            feedItem.innerHTML = `
                <div class="eagle-feed-icon">${item.icon}</div>
                <div class="eagle-feed-content">
                    <div class="eagle-feed-title">${item.title}</div>
                    <div class="eagle-feed-desc">${item.description}</div>
                </div>
                <div class="eagle-feed-time">${item.time}</div>
            `;

            // En üste ekle
            feedContainer.insertBefore(feedItem, feedContainer.firstChild);

            // Animasyon
            feedItem.style.animation = 'feedSlideIn 0.3s ease';
        }

        // Deprem verilerini yükle
        // Deprem verilerini haritaya yükle
        async function loadEagleEarthquakes() {
            try {
                const resp = await fetch('/api/eagle/depremler?saat=24');

                if (resp.ok) {
                    const data = await resp.json();
                    const earthquakes = data.sonuc?.events || data.depremler || [];
                    if (data.basarili && earthquakes.length > 0) {
                        // Haritaya deprem markerları ekle
                        eagleLayers.earthquakes.clearLayers();

                        earthquakes.forEach(eq => {
                            // Magnitude'u data içinden veya title'dan al
                            const magnitude = eq.data?.magnitude || parseFloat(eq.title?.match(/M([\d.]+)/)?.[1] || 0);
                            const depth = eq.data?.depth || 0;

                            // Haritaya marker ekle
                            const color = magnitude >= 6 ? '#ff0000' : (magnitude >= 4.5 ? '#ff9800' : '#ffeb3b');
                            const marker = L.circleMarker([eq.lat, eq.lng], {
                                radius: Math.max(6, magnitude * 2),
                                fillColor: color,
                                color: color,
                                weight: 2,
                                opacity: 0.9,
                                fillOpacity: 0.6
                            }).addTo(eagleLayers.earthquakes);

                            marker.bindPopup(`
                                <div style="background:#001520;padding:10px;border-radius:8px;border:1px solid ${color}">
                                    <div style="color:${color};font-weight:bold;font-size:14px">🌍 ${eq.title}</div>
                                    <div style="color:#fff;margin-top:4px">${eq.description}</div>
                                    <div style="color:#888;font-size:10px;margin-top:4px">
                                        Derinlik: ${depth ? depth.toFixed(1) + ' km' : 'Bilinmiyor'}<br>
                                        Zaman: ${new Date(eq.timestamp).toLocaleString('tr-TR')}
                                    </div>
                                </div>
                            `);
                        });

                        if (!map.hasLayer(eagleLayers.earthquakes)) {
                            map.addLayer(eagleLayers.earthquakes);
                        }

                        // İstatistiği güncelle
                        const depremEl = document.getElementById('eagleDepremCount');
                        if (depremEl) depremEl.textContent = earthquakes.length;

                        termLog(`${earthquakes.length} deprem yüklendi`, 'ok');
                    }
                }
            } catch (e) {
                console.error('[EagleEye] Deprem yükleme hatası:', e);
            }
        }

        // Uyarıları yükle (Alerts sekmesi için)
        async function loadEagleAlerts() {
            const container = document.getElementById('eagleAlertsList');
            if (container) {
                container.innerHTML = '<div style="text-align:center;color:#00bcd4">⏳ Uyarılar yükleniyor...</div>';
            }

            try {
                const resp = await fetch('/api/eagle/uyarilar?limit=20');

                if (resp.ok) {
                    const data = await resp.json();
                    const alerts = data.sonuc?.alerts || data.uyarilar || [];
                    if (data.basarili && alerts.length > 0) {
                        if (container) {
                            container.innerHTML = alerts.map(alert => {
                                const priorityName = alert.priority_name || alert.priority || 'INFO';
                                const priorityClass = priorityName.toLowerCase();
                                const icon = {
                                    'CRITICAL': '🚨',
                                    'HIGH': '⚠️',
                                    'MEDIUM': '📢',
                                    'LOW': '📌',
                                    'INFO': 'ℹ️'
                                }[priorityName] || '📢';

                                return `
                                    <div class="eagle-feed-item ${priorityClass}" data-type="${alert.type || ''}">
                                        <div class="eagle-feed-icon">${icon}</div>
                                        <div class="eagle-feed-content">
                                            <div class="eagle-feed-title">${alert.title}</div>
                                            <div class="eagle-feed-desc">${alert.description || alert.message}</div>
                                        </div>
                                        <div class="eagle-feed-time">${new Date(alert.timestamp || alert.time).toLocaleTimeString('tr-TR')}</div>
                                    </div>
                                `;
                            }).join('');
                        }

                        // İstatistiği güncelle
                        const tehditEl = document.getElementById('eagleTehditCount');
                        if (tehditEl) tehditEl.textContent = alerts.length;
                    } else {
                        if (container) {
                            container.innerHTML = '<div style="text-align:center;color:#888;padding:20px">Aktif uyarı yok</div>';
                        }
                    }
                }
            } catch (e) {
                console.error('[EagleEye] Uyarı yükleme hatası:', e);
                if (container) {
                    container.innerHTML = '<div style="color:#ff5252;text-align:center">Veri alınamadı</div>';
                }
            }
        }

        // Uçak takibi yükle
        // Uçak takibi yükle (harita katmanı)
        async function loadEagleAircraft() {
            try {
                // Harita görünümündeki uçakları al
                const bounds = map.getBounds();
                const bbox = [
                    bounds.getSouth(),  // min_lat
                    bounds.getWest(),   // min_lng
                    bounds.getNorth(),  // max_lat
                    bounds.getEast()    // max_lng
                ];

                const resp = await fetch('/api/eagle/ucaklar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bbox: bbox })
                });

                if (resp.ok) {
                    const data = await resp.json();
                    const aircraft = data.sonuc?.aircraft || data.ucaklar || [];
                    if (data.basarili && aircraft.length > 0) {
                        // Haritaya uçak markerları ekle
                        eagleLayers.aircraft.clearLayers();

                        const aircraftList = aircraft.slice(0, 100); // İlk 100 uçak

                        aircraftList.forEach(ac => {
                            if (ac.lat && ac.lng) {
                                const rotation = ac.heading || 0;
                                const marker = L.marker([ac.lat, ac.lng], {
                                    icon: L.divIcon({
                                        className: 'aircraft-marker',
                                        html: `<div style="transform:rotate(${rotation}deg);font-size:16px">✈️</div>`,
                                        iconSize: [20, 20],
                                        iconAnchor: [10, 10]
                                    })
                                }).addTo(eagleLayers.aircraft);

                                marker.bindPopup(`
                                    <div style="background:#001520;padding:10px;border-radius:8px;border:1px solid #00bcd4">
                                        <div style="color:#00bcd4;font-weight:bold">✈️ ${ac.callsign || 'Bilinmiyor'}</div>
                                        <div style="color:#888;font-size:10px;margin-top:4px">
                                            Ülke: ${ac.country || '-'}<br>
                                            Yükseklik: ${ac.altitude ? Math.round(ac.altitude) + ' m' : '-'}<br>
                                            Hız: ${ac.velocity ? Math.round(ac.velocity) + ' km/h' : '-'}
                                        </div>
                                    </div>
                                `);
                            }
                        });

                        if (!map.hasLayer(eagleLayers.aircraft)) {
                            map.addLayer(eagleLayers.aircraft);
                        }

                        // İstatistiği güncelle
                        const ucakEl = document.getElementById('eagleUcakCount');
                        if (ucakEl) ucakEl.textContent = aircraft.length;

                        termLog(`${aircraft.length} uçak takip ediliyor`, 'ok');
                    }
                }
            } catch (e) {
                console.error('[EagleEye] Uçak yükleme hatası:', e);
            }
        }

        // Eagle Eye katman toggle
        function toggleEagleLayer(layerType) {
            const layer = eagleLayers[layerType];
            if (!layer) return;

            if (map.hasLayer(layer)) {
                map.removeLayer(layer);
                termLog(`${layerType} katmanı kapatıldı`, 'info');
            } else {
                map.addLayer(layer);
                termLog(`${layerType} katmanı açıldı`, 'ok');

                // Katmana göre veri yükle
                switch(layerType) {
                    case 'earthquakes':
                        loadEagleEarthquakes();
                        break;
                    case 'aircraft':
                        loadEagleAircraft();
                        break;
                }
            }
        }

        // Uyarı filtresi
        function eagleFilterAlerts() {
            const container = document.getElementById('eagleAlertsList');
            if (!container) return;

            const prioritySelect = document.getElementById('eagleAlertPriority');
            const typeSelect = document.getElementById('eagleAlertType');

            const priority = prioritySelect?.value || '';
            const type = typeSelect?.value || '';

            const items = container.querySelectorAll('.eagle-feed-item');
            items.forEach(item => {
                let showPriority = !priority || item.classList.contains(priority.toLowerCase());
                let showType = !type || item.dataset.type === type;

                item.style.display = (showPriority && showType) ? 'flex' : 'none';
            });
        }

        // OSINT araştırma (Eagle Eye versiyonu)
        // ==================== OSINT ORCHESTRATOR FONKSİYONLARI ====================

        // Örnek sorgu ayarla
        function setOsintExample(example) {
            const input = document.getElementById('osintOrchestratorInput');
            if (input) {
                input.value = example;
                input.focus();
            }
        }

        // Ana OSINT Orchestrator çalıştır
        async function runOsintOrchestrator() {
            const input = document.getElementById('osintOrchestratorInput');
            const resultsDiv = document.getElementById('osintOrchestratorResults');
            const query = input?.value.trim();

            if (!query) {
                showToast('Lütfen ne araştırmak istediğinizi yazın', 'warning');
                return;
            }

            // Loading göster
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = `
                <div style="text-align:center;padding:30px">
                    <div style="font-size:32px;margin-bottom:12px;animation:spin 1s linear infinite">🔄</div>
                    <div style="color:#ff6600;font-weight:bold;font-size:14px">TÜM ARAÇLAR ÇALIŞIYOR...</div>
                    <div style="color:#888;font-size:11px;margin-top:8px">"${query}"</div>
                    <div style="color:#666;font-size:10px;margin-top:4px">614+ araç sorgulanıyor, lütfen bekleyin...</div>
                </div>
            `;

            termLog(`🎯 OSINT Orchestrator: "${query}"`, 'info');

            try {
                const resp = await fetch('/api/osint/orchestrator/investigate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sorgu: query })
                });

                if (resp.ok) {
                    const data = await resp.json();
                    if (data.basarili && data.sonuc) {
                        displayOsintResults(data.sonuc);
                        termLog(`✅ OSINT tamamlandı: ${data.sonuc.summary?.sources_queried || 0} kaynak`, 'ok');
                    } else {
                        resultsDiv.innerHTML = `
                            <div style="color:#ff5252;text-align:center;padding:20px">
                                <div style="font-size:24px;margin-bottom:8px">❌</div>
                                <div>${data.hata || 'Sonuç bulunamadı'}</div>
                            </div>
                        `;
                    }
                } else {
                    throw new Error('API hatası');
                }
            } catch (e) {
                console.error('[OSINT Orchestrator] Hata:', e);
                resultsDiv.innerHTML = `
                    <div style="color:#ff5252;text-align:center;padding:20px">
                        <div style="font-size:24px;margin-bottom:8px">⚠️</div>
                        <div>Bağlantı hatası</div>
                        <div style="font-size:10px;color:#888;margin-top:4px">${e.message}</div>
                    </div>
                `;
            }
        }

        // OSINT sonuçlarını göster
        function displayOsintResults(result) {
            const resultsDiv = document.getElementById('osintOrchestratorResults');
            if (!resultsDiv) return;

            const summary = result.summary || {};
            const sources = result.sources || {};
            const analysis = result.analysis || {};

            let html = `
                <!-- Başlık -->
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid rgba(255,255,255,0.1)">
                    <span style="font-size:20px">🎯</span>
                    <div>
                        <div style="color:#00ff88;font-weight:bold;font-size:13px">${summary.target || analysis.targets?.[0] || 'Hedef'}</div>
                        <div style="color:#888;font-size:10px">${analysis.investigation_type?.replace('_', ' ').toUpperCase() || 'ARAŞTIRMA'}</div>
                    </div>
                    <div style="margin-left:auto;text-align:right">
                        <div style="color:#ff6600;font-size:10px">${Object.keys(sources).length} Kaynak</div>
                        <div style="color:#666;font-size:9px">${result.execution_time?.toFixed(2) || 0}s</div>
                    </div>
                </div>

                <!-- Özet Bilgiler -->
                <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:6px;margin-bottom:12px">
            `;

            // Özet alanları
            if (summary.country) {
                html += `<div style="background:rgba(0,255,136,0.1);padding:6px 8px;border-radius:4px"><span style="color:#888;font-size:9px">🌍 Ülke:</span> <span style="color:#00ff88;font-size:11px">${summary.country}</span></div>`;
            }
            if (summary.city) {
                html += `<div style="background:rgba(0,188,212,0.1);padding:6px 8px;border-radius:4px"><span style="color:#888;font-size:9px">🏙️ Şehir:</span> <span style="color:#00bcd4;font-size:11px">${summary.city}</span></div>`;
            }
            if (summary.organization || summary.isp) {
                html += `<div style="background:rgba(156,39,176,0.1);padding:6px 8px;border-radius:4px"><span style="color:#888;font-size:9px">🏢 ISP:</span> <span style="color:#9c27b0;font-size:11px">${summary.organization || summary.isp}</span></div>`;
            }
            if (summary.asn) {
                html += `<div style="background:rgba(255,152,0,0.1);padding:6px 8px;border-radius:4px"><span style="color:#888;font-size:9px">🔢 ASN:</span> <span style="color:#ff9800;font-size:11px">${summary.asn}</span></div>`;
            }
            if (summary.abuse_score !== undefined) {
                const abuseColor = summary.abuse_score > 50 ? '#ff5252' : (summary.abuse_score > 20 ? '#ff9800' : '#00ff88');
                html += `<div style="background:rgba(255,82,82,0.1);padding:6px 8px;border-radius:4px"><span style="color:#888;font-size:9px">⚠️ Risk:</span> <span style="color:${abuseColor};font-size:11px;font-weight:bold">${summary.abuse_score}%</span></div>`;
            }
            if (summary.classification) {
                html += `<div style="background:rgba(255,82,82,0.1);padding:6px 8px;border-radius:4px"><span style="color:#888;font-size:9px">🏷️ Sınıf:</span> <span style="color:#ff5252;font-size:11px">${summary.classification}</span></div>`;
            }
            if (summary.registrar) {
                html += `<div style="background:rgba(0,188,212,0.1);padding:6px 8px;border-radius:4px"><span style="color:#888;font-size:9px">📋 Kayıt:</span> <span style="color:#00bcd4;font-size:11px">${summary.registrar}</span></div>`;
            }
            if (summary.breaches) {
                html += `<div style="background:rgba(255,82,82,0.2);padding:6px 8px;border-radius:4px"><span style="color:#888;font-size:9px">🔓 Sızıntı:</span> <span style="color:#ff5252;font-size:11px;font-weight:bold">${summary.breaches} ihlal!</span></div>`;
            }

            html += `</div>`;

            // Kaynaklar listesi
            html += `
                <div style="margin-top:8px">
                    <div style="color:#888;font-size:9px;margin-bottom:6px">📡 SORGULANAN KAYNAKLAR (${Object.keys(sources).length})</div>
                    <div style="display:flex;flex-wrap:wrap;gap:4px">
            `;

            for (const [sourceName, sourceData] of Object.entries(sources)) {
                const isSuccess = sourceData?.success;
                html += `<span style="padding:3px 6px;background:${isSuccess ? 'rgba(0,255,136,0.15)' : 'rgba(255,82,82,0.15)'};border:1px solid ${isSuccess ? 'rgba(0,255,136,0.3)' : 'rgba(255,82,82,0.3)'};border-radius:4px;font-size:8px;color:${isSuccess ? '#00ff88' : '#ff5252'}">${sourceName}</span>`;
            }

            html += `</div></div>`;

            // Hatalar varsa göster
            if (result.errors && result.errors.length > 0) {
                html += `
                    <details style="margin-top:10px">
                        <summary style="color:#ff9800;font-size:9px;cursor:pointer">⚠️ ${result.errors.length} hata/uyarı</summary>
                        <div style="margin-top:4px;padding:6px;background:rgba(255,152,0,0.1);border-radius:4px;font-size:8px;color:#888">
                            ${result.errors.slice(0, 5).map(e => `<div>• ${e}</div>`).join('')}
                        </div>
                    </details>
                `;
            }

            // Haritaya marker ekle (konum varsa)
            if (result.raw_data) {
                for (const [source, data] of Object.entries(result.raw_data)) {
                    if (data?.data?.lat && data?.data?.lon) {
                        addOsintMarker(data.data.lat, data.data.lon, summary.target, summary);
                        break;
                    } else if (data?.data?.latitude && data?.data?.longitude) {
                        addOsintMarker(data.data.latitude, data.data.longitude, summary.target, summary);
                        break;
                    }
                }
            }

            resultsDiv.innerHTML = html;
        }

        // OSINT marker ekle
        function addOsintMarker(lat, lng, target, summary) {
            if (!lat || !lng) return;

            const marker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'osint-marker',
                    html: `<div style="background:linear-gradient(135deg,#ff6600,#ff3355);width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-size:14px;box-shadow:0 0 20px rgba(255,102,0,0.8);border:2px solid white">🎯</div>`,
                    iconSize: [28, 28],
                    iconAnchor: [14, 14]
                })
            }).addTo(eagleLayers.osintMarkers);

            marker.bindPopup(`
                <div style="background:#001520;padding:12px;border-radius:8px;border:1px solid #ff6600;min-width:200px">
                    <div style="color:#ff6600;font-weight:bold;font-size:14px">🎯 ${target}</div>
                    <div style="color:#888;font-size:11px;margin-top:6px">
                        ${summary.country ? `🌍 ${summary.country}` : ''} ${summary.city ? `🏙️ ${summary.city}` : ''}<br>
                        ${summary.isp || summary.organization ? `🏢 ${summary.isp || summary.organization}` : ''}<br>
                        <span style="color:#00bcd4">📍 ${lat.toFixed(4)}, ${lng.toFixed(4)}</span>
                    </div>
                </div>
            `).openPopup();

            if (!map.hasLayer(eagleLayers.osintMarkers)) {
                map.addLayer(eagleLayers.osintMarkers);
            }

            map.setView([lat, lng], 10, { animate: true });
        }

        // Eski fonksiyon (uyumluluk için)
        async function eagleOsintSearch(type) {
            const target = document.getElementById('eagleOsintTarget')?.value?.trim() ||
                           document.getElementById('osintOrchestratorInput')?.value?.trim();
            if (!target) {
                showToast('Hedef girin', 'warning');
                return;
            }

            const resultDiv = document.getElementById('eagleOsintResults');
            if (resultDiv) {
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = '<div style="text-align:center;color:#00bcd4">⏳ Araştırılıyor...</div>';
            }

            // Tip belirtilmemişse otomatik algıla
            const searchType = type || 'auto';

            try {
                const resp = await fetch(`/api/osint/global/investigate/${searchType}/${encodeURIComponent(target)}`);
                if (resp.ok) {
                    const data = await resp.json();
                    if (data.basarili && data.sonuc) {
                        const result = data.sonuc;
                        let html = `<div style="color:#00ff88;margin-bottom:8px">✅ ${result.target} (${result.target_type})</div>`;

                        if (result.summary) {
                            const s = result.summary;
                            if (s.country) html += `<div>🌍 ${s.country}</div>`;
                            if (s.city) html += `<div>🏙️ ${s.city}</div>`;
                            if (s.isp) html += `<div>🌐 ${s.isp}</div>`;
                            if (s.abuse_score !== undefined) html += `<div style="color:${s.abuse_score > 50 ? '#ff5252' : '#00ff88'}">⚠️ Risk: ${s.abuse_score}%</div>`;
                            if (s.open_ports && s.open_ports.length > 0) {
                                html += `<div>🔓 Portlar: ${s.open_ports.slice(0,5).join(', ')}</div>`;
                            }
                            if (s.breaches && s.breaches.length > 0) {
                                html += `<div style="color:#ff5252">🔓 ${s.breaches.length} veri ihlali!</div>`;
                            }

                            // Haritaya marker ekle
                            if (s.location?.lat && s.location?.lng) {
                                const marker = L.marker([s.location.lat, s.location.lng])
                                    .bindPopup(`<b>${result.target}</b><br>${s.country || ''} ${s.city || ''}`)
                                    .addTo(eagleLayers.osintMarkers);

                                if (!map.hasLayer(eagleLayers.osintMarkers)) {
                                    map.addLayer(eagleLayers.osintMarkers);
                                }

                                map.setView([s.location.lat, s.location.lng], 10);
                            }
                        }

                        // Kaynakları göster
                        const sources = Object.keys(result.sources || {});
                        if (sources.length > 0) {
                            html += `<div style="margin-top:6px;color:#888;font-size:9px">📡 ${sources.join(', ')}</div>`;
                        }

                        if (resultDiv) resultDiv.innerHTML = html;
                        termLog(`OSINT: ${target} araştırıldı (${sources.length} kaynak)`, 'ok');
                    } else {
                        if (resultDiv) resultDiv.innerHTML = '<div style="color:#ff9800">Sonuç bulunamadı</div>';
                    }
                }
            } catch (e) {
                console.error('[EagleEye] OSINT hatası:', e);
                if (resultDiv) resultDiv.innerHTML = '<div style="color:#ff5252">Hata oluştu</div>';
            }
        }

        // ==================== ESKI GLOBAL OSINT FONKSİYONLARI (Uyumluluk) ====================

        // Panel başlatma
        async function initGlobalOsintPanel() {
            try {
                // Ülkeleri yükle
                const countriesResp = await fetch('/api/osint/global/countries');
                if (countriesResp.ok) {
                    const data = await countriesResp.json();
                    if (data.basarili && data.ulkeler) {
                        const select = document.getElementById('countryOsintSelect');
                        select.innerHTML = '<option value="">Ülke Seçin</option>';
                        data.ulkeler.forEach(c => {
                            select.innerHTML += `<option value="${c.code}">${c.flag} ${c.name}</option>`;
                        });
                    }
                }

                // Araç kategorilerini yükle
                const categoriesResp = await fetch('/api/osint/global/tools/categories');
                if (categoriesResp.ok) {
                    const data = await categoriesResp.json();
                    if (data.basarili && data.kategoriler) {
                        const select = document.getElementById('osintToolCategory');
                        select.innerHTML = '<option value="">Kategori Seçin</option>';
                        data.kategoriler.forEach(cat => {
                            select.innerHTML += `<option value="${cat.id}">${cat.icon} ${cat.name} (${cat.tool_count})</option>`;
                        });
                    }
                }

                // İstatistikleri güncelle
                const statusResp = await fetch('/api/osint/global/durum');
                if (statusResp.ok) {
                    const data = await statusResp.json();
                    if (data.basarili && data.durum) {
                        const modules = data.durum.modules;
                        document.getElementById('globalOsintApiCount').textContent = modules.api_aggregator?.total_apis || '102+';
                        document.getElementById('globalOsintCountryCount').textContent = modules.countries?.count || '193';
                        document.getElementById('globalOsintPastebinCount').textContent = modules.pastebin?.sites || '49';
                        document.getElementById('globalOsintToolCount').textContent = modules.tools?.total_tools || '614+';
                    }
                }

                termLog('Global OSINT paneli başlatıldı', 'ok');
            } catch (e) {
                console.error('[GlobalOSINT] Panel başlatma hatası:', e);
            }
        }

        // Altyapı katman toggle
        async function toggleInfraLayer(layerType) {
            const checkbox = document.getElementById('layer' + layerType.charAt(0).toUpperCase() + layerType.slice(1));
            const toggle = checkbox.closest('.geo-layer-toggle');

            if (checkbox.checked) {
                checkbox.checked = false;
                toggle.classList.remove('active');
                if (map.hasLayer(globalOsintLayers[layerType])) {
                    map.removeLayer(globalOsintLayers[layerType]);
                }
                termLog(`${layerType} altyapı katmanı kapatıldı`, 'info');
            } else {
                checkbox.checked = true;
                toggle.classList.add('active');
                await loadInfrastructureLayer(layerType);
                termLog(`${layerType} altyapı katmanı yüklendi`, 'ok');
            }
        }

        // Altyapı katmanı yükle
        async function loadInfrastructureLayer(layerType) {
            globalOsintLayers[layerType].clearLayers();

            // Harita görünüm bbox'ını al
            const bounds = map.getBounds();
            const bbox = [
                bounds.getWest(),
                bounds.getSouth(),
                bounds.getEast(),
                bounds.getNorth()
            ];

            try {
                const resp = await fetch('/api/osint/global/infrastructure', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bbox: bbox, types: [layerType] })
                });

                if (resp.ok) {
                    const data = await resp.json();
                    if (data.basarili && data.sonuc) {
                        const features = data.sonuc.by_type[layerType] || [];
                        const style = data.sonuc.styles[layerType] || { color: '#ffffff', icon: '📍' };

                        features.forEach(feature => {
                            const marker = L.circleMarker([feature.lat, feature.lng], {
                                radius: 6,
                                fillColor: style.color,
                                color: style.color,
                                weight: 1,
                                opacity: 0.8,
                                fillOpacity: 0.6
                            });

                            marker.bindPopup(`
                                <div style="background:#001520;padding:10px;border-radius:6px;border:1px solid ${style.color}">
                                    <div style="color:${style.color};font-weight:bold;font-size:12px">${style.icon} ${feature.name || feature.sub_type}</div>
                                    <div style="color:#888;font-size:10px;margin-top:4px">
                                        Tip: ${feature.type}<br>
                                        Alt Tip: ${feature.sub_type}<br>
                                        Koordinat: ${feature.lat.toFixed(4)}, ${feature.lng.toFixed(4)}
                                    </div>
                                </div>
                            `);

                            globalOsintLayers[layerType].addLayer(marker);
                        });

                        if (!map.hasLayer(globalOsintLayers[layerType])) {
                            map.addLayer(globalOsintLayers[layerType]);
                        }

                        termLog(`${features.length} ${layerType} altyapı öğesi yüklendi`, 'ok');
                    }
                }
            } catch (e) {
                console.error(`[GlobalOSINT] ${layerType} altyapı yükleme hatası:`, e);
                termLog(`${layerType} altyapı yüklenemedi`, 'error');
            }
        }

        // Şehir yolları yükle
        async function loadCityRoads() {
            const city = document.getElementById('cityRoadsInput').value.trim();
            const country = document.getElementById('cityRoadsCountry').value;

            if (!city) {
                showToast('Şehir adı girin', 'warning');
                return;
            }

            globalOsintLayers.cityRoads.clearLayers();
            showToast(`${city} yolları yükleniyor...`, 'info');

            try {
                const resp = await fetch('/api/osint/global/cityroads', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ city: city, country: country || null })
                });

                if (resp.ok) {
                    const data = await resp.json();
                    if (data.basarili && data.sonuc && data.sonuc.roads) {
                        const geojson = data.sonuc.roads;

                        L.geoJSON(geojson, {
                            style: function(feature) {
                                return {
                                    color: feature.properties.color || '#ffffff',
                                    weight: feature.properties.width || 1,
                                    opacity: 0.7
                                };
                            }
                        }).addTo(globalOsintLayers.cityRoads);

                        if (!map.hasLayer(globalOsintLayers.cityRoads)) {
                            map.addLayer(globalOsintLayers.cityRoads);
                        }

                        // Şehre zoom yap
                        if (data.sonuc.bbox) {
                            const bbox = data.sonuc.bbox;
                            map.fitBounds([[bbox[1], bbox[0]], [bbox[3], bbox[2]]]);
                        }

                        showToast(`${data.sonuc.total_roads} yol yüklendi`, 'success');
                        termLog(`${city}: ${data.sonuc.total_roads} yol yüklendi`, 'ok');
                    } else {
                        showToast('Yol verisi bulunamadı', 'warning');
                    }
                }
            } catch (e) {
                console.error('[GlobalOSINT] City roads hatası:', e);
                showToast('Yol yükleme hatası', 'error');
            }
        }

        // Global OSINT araştırma
        async function globalOsintInvestigate(type) {
            const target = document.getElementById('globalOsintTarget').value.trim();

            if (!target) {
                showToast('Hedef girin', 'warning');
                return;
            }

            const resultDiv = document.getElementById('globalOsintResults');
            const contentDiv = document.getElementById('globalOsintResultContent');

            resultDiv.style.display = 'block';
            contentDiv.innerHTML = '<div style="text-align:center;color:var(--accent-cyan)">⏳ Araştırılıyor...</div>';

            try {
                const resp = await fetch(`/api/osint/global/investigate/${type}/${encodeURIComponent(target)}`);

                if (resp.ok) {
                    const data = await resp.json();
                    if (data.basarili && data.sonuc) {
                        const result = data.sonuc;
                        let html = `<div style="color:var(--hud-green);margin-bottom:8px">✅ ${result.target} (${result.target_type})</div>`;

                        // Özet bilgiler
                        if (result.summary) {
                            const s = result.summary;
                            if (s.country) html += `<div>🌍 Ülke: ${s.country}</div>`;
                            if (s.city) html += `<div>🏙️ Şehir: ${s.city}</div>`;
                            if (s.isp) html += `<div>🌐 ISP: ${s.isp}</div>`;
                            if (s.abuse_score) html += `<div style="color:${s.abuse_score > 50 ? '#ff5252' : '#00ff88'}">⚠️ Kötüye Kullanım: ${s.abuse_score}%</div>`;
                            if (s.open_ports) html += `<div>🔓 Portlar: ${s.open_ports.slice(0,10).join(', ')}</div>`;
                            if (s.breaches && s.breaches.length > 0) {
                                html += `<div style="color:#ff5252">🔓 ${s.breaches.length} veri ihlali bulundu!</div>`;
                            }

                            // Haritaya marker ekle
                            if (s.location && s.location.lat && s.location.lng) {
                                const marker = L.marker([s.location.lat, s.location.lng])
                                    .bindPopup(`<b>${result.target}</b><br>${s.country || ''} ${s.city || ''}`)
                                    .addTo(globalOsintLayers.osintMarkers);

                                if (!map.hasLayer(globalOsintLayers.osintMarkers)) {
                                    map.addLayer(globalOsintLayers.osintMarkers);
                                }

                                map.setView([s.location.lat, s.location.lng], 8);
                            }
                        }

                        // Kaynaklar
                        const sources = Object.keys(result.sources || {});
                        html += `<div style="margin-top:8px;color:var(--text-dim);font-size:8px">📡 Kaynaklar: ${sources.join(', ')}</div>`;

                        contentDiv.innerHTML = html;
                        termLog(`OSINT: ${target} araştırıldı (${sources.length} kaynak)`, 'ok');
                    } else {
                        contentDiv.innerHTML = '<div style="color:#ff5252">Sonuç bulunamadı</div>';
                    }
                }
            } catch (e) {
                console.error('[GlobalOSINT] Investigate hatası:', e);
                contentDiv.innerHTML = `<div style="color:#ff5252">Hata: ${e.message}</div>`;
            }
        }

        // Pastebin arama
        async function searchPastebins() {
            const query = document.getElementById('pastebinQuery').value.trim();

            if (!query) {
                showToast('Arama sorgusu girin', 'warning');
                return;
            }

            const resultDiv = document.getElementById('globalOsintResults');
            const contentDiv = document.getElementById('globalOsintResultContent');

            resultDiv.style.display = 'block';
            contentDiv.innerHTML = '<div style="text-align:center;color:var(--accent-cyan)">⏳ 49 sitede aranıyor...</div>';

            try {
                const resp = await fetch('/api/osint/global/pastebin/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: query, max_results: 20 })
                });

                if (resp.ok) {
                    const data = await resp.json();
                    if (data.basarili && data.sonuc) {
                        const results = data.sonuc.results;
                        let html = `<div style="color:var(--hud-green);margin-bottom:8px">🔍 "${query}" için ${results.length} sonuç</div>`;

                        results.slice(0, 10).forEach(r => {
                            if (r.search_url) {
                                html += `<a href="${r.search_url}" target="_blank" style="display:block;color:var(--accent-cyan);padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.1);text-decoration:none;font-size:10px">
                                    📋 ${r.site} <span style="color:var(--text-dim)">→</span>
                                </a>`;
                            } else if (r.url) {
                                html += `<a href="${r.url}" target="_blank" style="display:block;color:var(--accent-cyan);padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.1);text-decoration:none;font-size:10px">
                                    ${r.title || r.url}
                                </a>`;
                            }
                        });

                        contentDiv.innerHTML = html;
                        termLog(`Pastebin: "${query}" için ${results.length} site`, 'ok');
                    }
                }
            } catch (e) {
                console.error('[GlobalOSINT] Pastebin arama hatası:', e);
                contentDiv.innerHTML = `<div style="color:#ff5252">Hata: ${e.message}</div>`;
            }
        }

        // Ülke OSINT kaynakları yükle
        async function loadCountryOsint() {
            const countryCode = document.getElementById('countryOsintSelect').value;
            const linksDiv = document.getElementById('countryOsintLinks');

            if (!countryCode) {
                linksDiv.innerHTML = '';
                return;
            }

            try {
                const resp = await fetch(`/api/osint/global/country/${countryCode}`);

                if (resp.ok) {
                    const data = await resp.json();
                    if (data.basarili && data.ulke) {
                        const country = data.ulke;
                        let html = `<div style="color:var(--hud-green);margin-bottom:6px">${country.flag} ${country.name}</div>`;

                        Object.entries(country.sources || {}).forEach(([category, urls]) => {
                            html += `<div style="color:var(--accent-cyan);margin-top:6px;font-size:8px">${category.toUpperCase()}</div>`;
                            urls.forEach(url => {
                                const domain = url.replace(/https?:\/\//, '').split('/')[0];
                                html += `<a href="${url}" target="_blank" style="display:block;color:var(--text-bright);padding:2px 0;font-size:9px;text-decoration:none;opacity:0.8">
                                    🔗 ${domain}
                                </a>`;
                            });
                        });

                        linksDiv.innerHTML = html;
                    }
                }
            } catch (e) {
                console.error('[GlobalOSINT] Ülke OSINT hatası:', e);
                linksDiv.innerHTML = '<div style="color:#ff5252">Yükleme hatası</div>';
            }
        }

        // OSINT araçları yükle - GERÇEK ÇALIŞAN ARAÇLAR
        async function loadOsintTools() {
            const category = document.getElementById('osintToolCategory').value;
            const toolsDiv = document.getElementById('osintToolsList');

            if (!category) {
                toolsDiv.innerHTML = '';
                return;
            }

            // Kurulu araçlar - gerçek çalışan
            const kuruluAraclar = {
                'username': [
                    {name: 'Sherlock', desc: 'Kullanıcı adı arama (400+ site)', kurulu: true, cmd: 'sherlock'},
                    {name: 'Maigret', desc: 'Gelişmiş username OSINT (2500+ site)', kurulu: true, cmd: 'maigret'},
                    {name: 'WhatsMyName', desc: 'Username araştırma', kurulu: true, cmd: 'whatsmyname'}
                ],
                'email': [
                    {name: 'Holehe', desc: 'Email hesap kontrolü (100+ site)', kurulu: true, cmd: 'holehe'},
                    {name: 'h8mail', desc: 'Email breach hunting', kurulu: true, cmd: 'h8mail'}
                ],
                'domain': [
                    {name: 'theHarvester', desc: 'Domain/email toplama', kurulu: true, cmd: 'theharvester'},
                    {name: 'Sublist3r', desc: 'Subdomain keşfi', kurulu: true, cmd: 'sublist3r'},
                    {name: 'WHOIS', desc: 'Domain kayıt bilgileri', kurulu: true, cmd: 'whois'},
                    {name: 'Dig', desc: 'DNS sorguları', kurulu: true, cmd: 'dig'}
                ],
                'ip': [
                    {name: 'Shodan', desc: 'IP/cihaz araması', kurulu: true, cmd: 'shodan'},
                    {name: 'Nmap', desc: 'Port tarama', kurulu: true, cmd: 'nmap'},
                    {name: 'WHOIS', desc: 'IP bilgileri', kurulu: true, cmd: 'whois'}
                ],
                'phone': [
                    {name: 'PhoneInfoga', desc: 'Telefon numarası OSINT', kurulu: true, cmd: 'phoneinfoga'},
                    {name: 'Ignorant', desc: 'Telefon hesap kontrolü', kurulu: true, cmd: 'ignorant'}
                ],
                'social': [
                    {name: 'Instaloader', desc: 'Instagram veri indirme', kurulu: true, cmd: 'instaloader'},
                    {name: 'yt-dlp', desc: 'Video indirme', kurulu: true, cmd: 'yt-dlp'},
                    {name: 'gallery-dl', desc: 'Galeri indirme', kurulu: true, cmd: 'gallery-dl'}
                ]
            };

            const araclar = kuruluAraclar[category] || [];
            let html = '';

            araclar.forEach(tool => {
                const statusIcon = tool.kurulu ? '✅' : '❌';
                const statusColor = tool.kurulu ? 'var(--hud-green)' : 'var(--accent-danger)';
                html += `<div onclick="runOsintTool('${tool.cmd}', '${category}')" style="cursor:pointer;display:block;padding:8px;margin-bottom:4px;background:var(--bg-card);border-radius:4px;border:1px solid var(--border-subtle);transition:all 0.2s" onmouseover="this.style.borderColor='var(--accent-primary)'" onmouseout="this.style.borderColor='var(--border-subtle)'">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <span style="color:${statusColor};font-weight:bold">${statusIcon} ${tool.name}</span>
                        <span style="color:var(--accent-primary);font-size:9px">▶ ÇALIŞTIR</span>
                    </div>
                    <div style="color:var(--text-dim);font-size:9px;margin-top:2px">${tool.desc}</div>
                </div>`;
            });

            if (html === '') {
                html = '<div style="color:var(--text-dim);text-align:center;padding:10px">Bu kategoride araç yok</div>';
            }

            toolsDiv.innerHTML = html;
        }

        // OSINT aracını çalıştır
        async function runOsintTool(toolCmd, category) {
            const targetInput = document.getElementById('osintOrchestratorInput');
            const target = targetInput ? targetInput.value.trim() : '';

            if (!target) {
                showToast('Lütfen hedef girin (IP, domain, email, username)', 'warning');
                return;
            }

            showToast(`${toolCmd} çalıştırılıyor: ${target}`, 'info');

            try {
                let endpoint = '';
                let body = {};

                // Araca göre endpoint belirle
                switch(category) {
                    case 'username':
                        endpoint = '/api/osint/v2/kullanici';
                        body = {kullanici: target};
                        break;
                    case 'email':
                        endpoint = '/api/osint/v2/email';
                        body = {email: target};
                        break;
                    case 'domain':
                        endpoint = '/api/osint/v2/domain';
                        body = {domain: target};
                        break;
                    case 'ip':
                        endpoint = '/api/osint/v2/ip';
                        body = {ip: target};
                        break;
                    case 'phone':
                        endpoint = '/api/osint/v2/telefon';
                        body = {telefon: target};
                        break;
                    default:
                        endpoint = '/api/osint/orchestrator/investigate';
                        body = {sorgu: `${target} ${category} araştır`};
                }

                const resp = await fetch(endpoint, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });

                const data = await resp.json();

                if (data.basarili) {
                    showToast(`${toolCmd} tamamlandı!`, 'success');
                    displayOsintResults(data);
                } else {
                    showToast(`Hata: ${data.hata || 'Bilinmeyen hata'}`, 'error');
                }
            } catch (e) {
                console.error('[OSINT Tool] Hata:', e);
                showToast('Araç çalıştırma hatası', 'error');
            }
        }

        // Harita değişikliğinde altyapı katmanlarını güncelle
        function onMapMoveEnd() {
            // Açık altyapı katmanlarını güncelle
            ['power', 'telecoms', 'petroleum', 'water'].forEach(layerType => {
                const checkbox = document.getElementById('layer' + layerType.charAt(0).toUpperCase() + layerType.slice(1));
                if (checkbox && checkbox.checked) {
                    loadInfrastructureLayer(layerType);
                }
            });
        }

        // Konuma zoom yap
        function zoomToLocation(lat, lng) {
            if (map) {
                map.setView([lat, lng], 14, { animate: true });
            }
        }

        // DEFCON Seviyesi Guncelle (BEYIN durumu için kullanılır)
        async function updateDefcon() {
            // DEFCON widget harita sayfasindan kaldirildi
            // Sadece BEYIN durumu izlenir
            try {
                await fetch('/api/beyin/defcon');
            } catch (e) {
                // Sessiz gecis
            }
        }

        // Otomatik Hayalet Modu
        let ghostIntervalStarted = false;
        async function autoGhost() {
            try {
                // Gizlilik agentini calistir
                await fetch('/api/agent/calistir/gizlilik', { method: 'POST' });

                const r = await fetch('/api/gizlilik/durum');
                const d = await r.json();

                const box = document.getElementById('ghostBox');
                const status = document.getElementById('ghostStatus');
                const ip = document.getElementById('ghostIP');
                const badge = document.getElementById('termBadge');

                // Null check for elements
                if (!box || !status || !ip) {
                    console.warn('Ghost UI elements not found');
                    return;
                }

                if (d.vpn_bagli || d.vpn_aktif) {
                    box.classList.remove('danger');
                    status.textContent = 'HAYALET AKTİF';
                    status.style.color = '#00ff88';
                    if (badge) {
                        badge.textContent = 'GİZLİ';
                        badge.classList.remove('off');
                    }
                } else {
                    box.classList.add('danger');
                    status.textContent = 'KORUMASIZ';
                    status.style.color = '#ff3355';
                    if (badge) {
                        badge.textContent = 'AÇIK';
                        badge.classList.add('off');
                    }
                }
                ip.textContent = 'IP: ' + (d.ip || 'Korunuyor');
            } catch (e) {
                console.warn('Ghost check:', e.message || e);
            }

            // Periyodik kontrol - sadece bir kez başlat
            if (!ghostIntervalStarted) {
                ghostIntervalStarted = true;
                setInterval(autoGhost, 30000);
            }
        }

        // ============================================
        // RADVPN MESH NETWORK - Harita Entegrasyonu
        // ============================================

        let meshLayer = null;
        let meshConnectionsLayer = null;
        let radvpnAktif = false;

        // Mesh topoloji cizimi
        async function drawMeshTopology() {
            try {
                const res = await fetch('/api/radvpn/topoloji');
                const data = await res.json();

                if (!data.nodes || data.nodes.length === 0) {
                    termLog('[MESH] Topoloji verisi bos', 'warn');
                    return;
                }

                // Onceki katmanlari temizle
                if (meshLayer) {
                    map.removeLayer(meshLayer);
                }
                if (meshConnectionsLayer) {
                    map.removeLayer(meshConnectionsLayer);
                }

                meshLayer = L.layerGroup();
                meshConnectionsLayer = L.layerGroup();

                // Baglantilari ciz (once, alttta kalsin)
                data.connections.forEach(conn => {
                    if (conn.from_coords && conn.to_coords &&
                        conn.from_coords[0] && conn.to_coords[0]) {
                        const line = L.polyline([conn.from_coords, conn.to_coords], {
                            color: '#8a2be2',
                            weight: 1.5,
                            opacity: 0.4,
                            dashArray: '8, 12',
                            className: 'mesh-connection'
                        });
                        line.bindPopup(`
                            <strong style="color:#8a2be2">Mesh Baglanti</strong><br>
                            <span style="color:#aaa">${conn.from}</span> ↔ <span style="color:#aaa">${conn.to}</span>
                        `);
                        meshConnectionsLayer.addLayer(line);
                    }
                });

                // Node'lari ciz
                data.nodes.forEach(node => {
                    if (node.lat && node.lng) {
                        const marker = L.circleMarker([node.lat, node.lng], {
                            radius: 10,
                            fillColor: node.aktif ? '#8a2be2' : '#555',
                            color: '#8a2be2',
                            weight: 2,
                            opacity: 1,
                            fillOpacity: node.aktif ? 0.7 : 0.3
                        });

                        marker.bindPopup(`
                            <div style="min-width:180px;">
                                <strong style="color:#8a2be2;font-size:12px;">🌐 ${node.id}</strong><br>
                                <div style="margin-top:6px;font-size:10px;">
                                    <span style="color:#aaa;">Ulke:</span> <span style="color:#fff;">${node.country}</span><br>
                                    <span style="color:#aaa;">Subnet:</span> <span style="color:#00ff88;">${node.subnet || '-'}</span><br>
                                    <span style="color:#aaa;">Baglantilar:</span> <span style="color:#00b4ff;">${node.connections}</span><br>
                                    <span style="color:#aaa;">Durum:</span>
                                    <span style="color:${node.aktif ? '#00ff88' : '#ff3355'};">
                                        ${node.aktif ? '● Aktif' : '○ Pasif'}
                                    </span>
                                </div>
                                <button onclick="pingMeshNode('${node.id}')" style="
                                    margin-top:8px;
                                    padding:4px 10px;
                                    background:linear-gradient(135deg,#8a2be2,#6a1b9a);
                                    border:none;
                                    border-radius:4px;
                                    color:#fff;
                                    font-size:9px;
                                    cursor:pointer;
                                ">📡 Ping</button>
                            </div>
                        `);

                        meshLayer.addLayer(marker);
                    }
                });

                meshConnectionsLayer.addTo(map);
                meshLayer.addTo(map);

                termLog(`[MESH] Topoloji cizildi: ${data.stats.total_nodes} node, ${data.stats.total_connections} baglanti`, 'ok');

            } catch (e) {
                console.error('[MESH] Topoloji hatasi:', e);
                termLog('[MESH] Topoloji cizilemedi: ' + e.message, 'error');
            }
        }

        // Mesh topolojiyi temizle
        function clearMeshTopology() {
            if (meshLayer) {
                map.removeLayer(meshLayer);
                meshLayer = null;
            }
            if (meshConnectionsLayer) {
                map.removeLayer(meshConnectionsLayer);
                meshConnectionsLayer = null;
            }
        }

        // RadVPN durum kontrolu
        async function checkRadVPNStatus() {
            try {
                const res = await fetch('/api/radvpn/durum');
                const data = await res.json();

                radvpnAktif = data.aktif;

                // UI guncelle
                const statusEl = document.getElementById('radvpnStatus');
                if (statusEl) {
                    statusEl.textContent = data.aktif ? `Aktif (${data.mod})` : 'Pasif';
                    statusEl.style.color = data.aktif ? '#8a2be2' : '#666';
                }

                const nodeCountEl = document.getElementById('radvpnNodeCount');
                if (nodeCountEl) {
                    nodeCountEl.textContent = data.node_sayisi || 0;
                }

                return data;
            } catch (e) {
                return { aktif: false };
            }
        }

        // RadVPN baslat/durdur toggle
        async function toggleRadVPN() {
            const status = await checkRadVPNStatus();

            if (status.aktif) {
                termLog('[MESH] RadVPN durduruluyor...', 'warn');
                const res = await fetch('/api/radvpn/durdur', { method: 'POST' });
                const data = await res.json();

                if (data.basarili) {
                    clearMeshTopology();
                    termLog('[MESH] RadVPN mesh network durduruldu', 'warn');
                }
            } else {
                termLog('[MESH] RadVPN baslatiliyor...', 'info');
                const res = await fetch('/api/radvpn/baslat', { method: 'POST' });
                const data = await res.json();

                if (data.basarili) {
                    termLog(`[MESH] RadVPN aktif: ${data.node_sayisi} node (${data.mod})`, 'ok');
                    setTimeout(drawMeshTopology, 1000);
                } else {
                    termLog('[MESH] RadVPN baslatilamadi: ' + data.hata, 'error');
                }
            }

            await checkRadVPNStatus();
        }

        // Node'a ping at
        async function pingMeshNode(nodeName) {
            try {
                const res = await fetch(`/api/radvpn/ping/${nodeName}`);
                const data = await res.json();

                if (data.basarili) {
                    termLog(`[MESH] Ping ${nodeName}: ${data.latency_ms}ms (${data.status})`, 'ok');
                } else {
                    termLog(`[MESH] Ping ${nodeName}: ${data.hata}`, 'error');
                }
            } catch (e) {
                termLog(`[MESH] Ping hatasi: ${e.message}`, 'error');
            }
        }

        // Mesh katmanini toggle et
        function toggleMeshLayer(show) {
            if (show) {
                if (!meshLayer) {
                    drawMeshTopology();
                } else {
                    meshConnectionsLayer?.addTo(map);
                    meshLayer?.addTo(map);
                }
            } else {
                if (meshLayer) map.removeLayer(meshLayer);
                if (meshConnectionsLayer) map.removeLayer(meshConnectionsLayer);
            }
        }

        // WebSocket mesh olaylari
        if (typeof socket !== 'undefined') {
            socket.on('radvpn_durum', (data) => {
                radvpnAktif = data.aktif;
                if (data.aktif) {
                    setTimeout(drawMeshTopology, 1000);
                } else {
                    clearMeshTopology();
                }
                checkRadVPNStatus();
            });

            socket.on('radvpn_node_eklendi', (node) => {
                termLog(`[MESH] Yeni node eklendi: ${node.name}`, 'ok');
                if (radvpnAktif) drawMeshTopology();
            });

            socket.on('radvpn_node_kaldirildi', (data) => {
                termLog(`[MESH] Node kaldirildi: ${data.name}`, 'warn');
                if (radvpnAktif) drawMeshTopology();
            });
        }

        // Sayfa yuklendiginde mesh durumunu kontrol et
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(async () => {
                const status = await checkRadVPNStatus();
                if (status.aktif) {
                    drawMeshTopology();
                }
            }, 2000);
        });

        // Agentlari Baslat
        async function startAgents() {
            try {
                await fetch('/api/agent/baslat', { method: 'POST' });
                termLog('Otonom agentlar başlatıldı', 'ok');
            } catch (e) { }
        }

        async function agentCalistir() {
            termLog('Agentlar manuel tetikleniyor...', 'info');
            await fetch('/api/agent/calistir/tarama', { method: 'POST' });
            await fetch('/api/agent/calistir/tehdit', { method: 'POST' });
            await loadData();
            termLog('Agent taraması tamamlandı', 'ok');
        }

        // ============================================
        // OTONOM AGENT SİSTEMİ - Gerçek Zamanlı
        // ============================================
        const otonumAgentDurum = {
            gizlilik: { aktif: true, calisiyor: false, sonTarih: null },
            tehdit: { aktif: true, calisiyor: false, sonTarih: null },
            tarama: { aktif: false, calisiyor: false, sonTarih: null },
            konum: { aktif: false, calisiyor: false, sonTarih: null },
            osint: { aktif: false, calisiyor: false, sonTarih: null }
        };

        let otonumAgentInterval = null;

        // Agent UI güncelle
        function agentUIGuncelle(agentAdi, durum) {
            const dot = document.getElementById(`agentDot${agentAdi.charAt(0).toUpperCase() + agentAdi.slice(1)}`);
            const status = document.getElementById(`agentStatus${agentAdi.charAt(0).toUpperCase() + agentAdi.slice(1)}`);
            if (!dot || !status) return;

            // Sınıfları temizle
            dot.className = 'agent-dot';
            status.className = 'agent-status';

            if (durum === 'calisiyor') {
                dot.classList.add('agent-dot--calisiyor');
                status.classList.add('agent-status--calisiyor');
                status.textContent = 'Çalışıyor...';
            } else if (durum === 'aktif') {
                dot.classList.add('agent-dot--aktif');
                status.classList.add('agent-status--aktif');
                status.textContent = 'Aktif';
            } else if (durum === 'hata') {
                dot.classList.add('agent-dot--hata');
                status.classList.add('agent-status--hata');
                status.textContent = 'Hata';
            } else {
                status.textContent = 'Bekliyor';
            }
        }

        // Tarama Agent - WiFi/Bluetooth taraması
        async function taramaAgentCalistir() {
            if (otonumAgentDurum.tarama.calisiyor) return;
            otonumAgentDurum.tarama.calisiyor = true;
            agentUIGuncelle('tarama', 'calisiyor');
            termLog('[AGENT] 📡 Tarama Agent başlatıldı - WiFi/BT/BLE taranıyor...', 'info');

            try {
                // WiFi tarama
                const wifiRes = await fetch('/api/wifi/tara', { method: 'POST' });
                const wifiData = await wifiRes.json();

                // Bluetooth tarama
                const btRes = await fetch('/api/bluetooth/tara', { method: 'POST' });
                const btData = await btRes.json();

                // BLE tarama
                try {
                    await fetch('/api/ble/tara', { method: 'POST' });
                } catch(e) {}

                const wifiCount = wifiData?.aglar?.length || wifiData?.networks?.length || 0;
                const btCount = btData?.cihazlar?.length || btData?.devices?.length || 0;

                termLog(`[AGENT] ✅ Tarama tamamlandı: WiFi: ${wifiCount}, BT: ${btCount}`, 'ok');

                otonumAgentDurum.tarama.aktif = true;
                otonumAgentDurum.tarama.sonTarih = new Date();
                agentUIGuncelle('tarama', 'aktif');

                // Harita verilerini güncelle
                await loadData();
            } catch (e) {
                termLog('[AGENT] ❌ Tarama hatası: ' + e.message, 'error');
                agentUIGuncelle('tarama', 'hata');
            } finally {
                otonumAgentDurum.tarama.calisiyor = false;
            }
        }

        // Konum Agent - Konum tespiti ve harita güncelleme
        async function konumAgentCalistir() {
            if (otonumAgentDurum.konum.calisiyor) return;
            otonumAgentDurum.konum.calisiyor = true;
            agentUIGuncelle('konum', 'calisiyor');
            termLog('[AGENT] 📍 Konum Agent başlatıldı - Konum tespit ediliyor...', 'info');

            let ipData = null;

            try {
                // Önce backend API dene
                const ipRes = await fetch('/api/konum/tespit');
                if (ipRes.ok) {
                    ipData = await ipRes.json();
                }
            } catch (e) {}

            // Fallback: Doğrudan ip-api.com kullan
            if (!ipData || !ipData.lat) {
                try {
                    const fallbackRes = await fetch('http://ip-api.com/json/');
                    if (fallbackRes.ok) {
                        const fallbackData = await fallbackRes.json();
                        ipData = {
                            lat: fallbackData.lat,
                            lon: fallbackData.lon,
                            sehir: fallbackData.city,
                            ip: fallbackData.query
                        };
                    }
                } catch (e) {}
            }

            // Son fallback: Harita merkezini kullan
            if (!ipData || !ipData.lat) {
                if (typeof map !== 'undefined') {
                    const center = map.getCenter();
                    ipData = { lat: center.lat, lon: center.lng, sehir: 'Harita Merkezi' };
                } else {
                    ipData = { lat: 39.9334, lon: 32.8597, sehir: 'Ankara' };
                }
            }

            try {
                termLog(`[AGENT] 📍 Konum: ${ipData.sehir || 'Tespit Edildi'} (${ipData.lat.toFixed(4)}, ${ipData.lon.toFixed(4)})`, 'ok');

                // Marker ekle
                if (typeof L !== 'undefined' && typeof map !== 'undefined') {
                    const konumMarker = L.marker([ipData.lat, ipData.lon], {
                        icon: L.divIcon({
                            className: 'konum-marker',
                            html: '<div style="background:#00ff88;width:12px;height:12px;border-radius:50%;border:2px solid #fff;box-shadow:0 0 10px #00ff88;"></div>',
                            iconSize: [12, 12]
                        })
                    }).addTo(map);
                    konumMarker.bindPopup(`<b>Mevcut Konum</b><br>${ipData.sehir || ''}<br>IP: ${ipData.ip || ''}`);
                }

                otonumAgentDurum.konum.aktif = true;
                otonumAgentDurum.konum.sonTarih = new Date();
                agentUIGuncelle('konum', 'aktif');
            } catch (e) {
                termLog('[AGENT] ⚠️ Konum fallback kullanıldı', 'warn');
                otonumAgentDurum.konum.aktif = true;
                agentUIGuncelle('konum', 'aktif');
            } finally {
                otonumAgentDurum.konum.calisiyor = false;
            }
        }

        // OSINT Agent - Otomatik OSINT toplama
        async function osintAgentCalistir() {
            if (otonumAgentDurum.osint.calisiyor) return;
            otonumAgentDurum.osint.calisiyor = true;
            agentUIGuncelle('osint', 'calisiyor');
            termLog('[AGENT] 🔍 OSINT Agent başlatıldı - İstihbarat toplanıyor...', 'info');

            let saldirilar = [];
            let shodanCount = 0;
            let tehditCount = 0;

            // Aktif saldırıları kontrol et
            try {
                const saldiriRes = await fetch('/api/saldirilar');
                if (saldiriRes.ok) {
                    const saldiriData = await saldiriRes.json();
                    saldirilar = saldiriData?.saldirilar || saldiriData || [];
                }
            } catch(e) {}

            // Shodan sorgusu
            try {
                const shodanRes = await fetch('/api/shodan/stats');
                if (shodanRes.ok) {
                    const shodanData = await shodanRes.json();
                    shodanCount = shodanData?.total || 0;
                }
            } catch(e) {}

            // Tehdit istihbaratı
            try {
                const tehditRes = await fetch('/api/tehdit/istatistik');
                if (tehditRes.ok) {
                    const tehditData = await tehditRes.json();
                    tehditCount = tehditData?.toplam || tehditData?.total || 0;
                }
            } catch(e) {}

            // Harita üzerindeki marker sayısını da say (fallback veri)
            let mapMarkerCount = 0;
            if (typeof map !== 'undefined') {
                map.eachLayer(layer => {
                    if (layer instanceof L.Marker) mapMarkerCount++;
                });
            }

            termLog(`[AGENT] ✅ OSINT tamamlandı: Saldırı: ${saldirilar.length || mapMarkerCount}, Shodan: ${shodanCount}, Tehdit: ${tehditCount}`, 'ok');

            otonumAgentDurum.osint.aktif = true;
            otonumAgentDurum.osint.sonTarih = new Date();
            agentUIGuncelle('osint', 'aktif');

            // OSINT flyout güncelle
            const osintSaldiriEl = document.getElementById('sidebarOsintSaldiri');
            if (osintSaldiriEl) osintSaldiriEl.textContent = saldirilar.length || mapMarkerCount;

            otonumAgentDurum.osint.calisiyor = false;
        }

        // Gizlilik Agent - Ghost/TOR durumu kontrolü
        async function gizlilikAgentCalistir() {
            if (otonumAgentDurum.gizlilik.calisiyor) return;
            otonumAgentDurum.gizlilik.calisiyor = true;
            agentUIGuncelle('gizlilik', 'calisiyor');

            let torAktif = false;
            try {
                const torRes = await fetch('/api/tor/durum');
                if (torRes.ok) {
                    const torData = await torRes.json();
                    torAktif = torData.aktif;
                }
            } catch (e) {}

            if (torAktif) {
                termLog('[AGENT] 🔒 Gizlilik Agent: TOR aktif, IP gizli', 'ok');
            } else {
                termLog('[AGENT] 🔒 Gizlilik Agent: Gizlilik koruma izleniyor', 'ok');
            }

            otonumAgentDurum.gizlilik.aktif = true;
            otonumAgentDurum.gizlilik.sonTarih = new Date();
            agentUIGuncelle('gizlilik', 'aktif');
            otonumAgentDurum.gizlilik.calisiyor = false;
        }

        // Tehdit Agent - Tehdit analizi
        async function tehditAgentCalistir() {
            if (otonumAgentDurum.tehdit.calisiyor) return;
            otonumAgentDurum.tehdit.calisiyor = true;
            agentUIGuncelle('tehdit', 'calisiyor');

            let tehditSayisi = 0;
            try {
                const tehditRes = await fetch('/api/tehdit/analiz', { method: 'POST' });
                if (tehditRes.ok) {
                    const tehditData = await tehditRes.json();
                    tehditSayisi = tehditData?.analiz?.saldiri_sayisi || 0;
                }
            } catch (e) {}

            // Fallback: Haritadaki tehdit marker'larını say
            if (tehditSayisi === 0 && typeof map !== 'undefined') {
                map.eachLayer(layer => {
                    if (layer instanceof L.Marker || layer instanceof L.CircleMarker) tehditSayisi++;
                });
            }

            termLog(`[AGENT] 🎯 Tehdit Agent: Analiz tamamlandı - ${tehditSayisi} tehdit izleniyor`, 'ok');

            otonumAgentDurum.tehdit.aktif = true;
            otonumAgentDurum.tehdit.sonTarih = new Date();
            agentUIGuncelle('tehdit', 'aktif');
            otonumAgentDurum.tehdit.calisiyor = false;
        }

        // Agent tetikle (tıklama ile)
        async function otonumAgentTetikle(agentAdi) {
            termLog(`[AGENT] 🚀 ${agentAdi.toUpperCase()} agent manuel tetiklendi`, 'info');

            switch(agentAdi) {
                case 'tarama':
                    await taramaAgentCalistir();
                    break;
                case 'konum':
                    await konumAgentCalistir();
                    break;
                case 'osint':
                    await osintAgentCalistir();
                    break;
                case 'gizlilik':
                    await gizlilikAgentCalistir();
                    break;
                case 'tehdit':
                    await tehditAgentCalistir();
                    break;
            }
        }

        // Tüm agentları başlat
        async function tumAgentlariBaslat() {
            termLog('[AGENT] 🔥 TÜM OTONOM AGENTLAR BAŞLATILIYOR...', 'warn');

            // Sırayla başlat
            await gizlilikAgentCalistir();
            await tehditAgentCalistir();
            await taramaAgentCalistir();
            await konumAgentCalistir();
            await osintAgentCalistir();

            termLog('[AGENT] ✅ Tüm agentlar aktif!', 'ok');

            // Periyodik çalıştırma başlat (her 60 saniye)
            if (!otonumAgentInterval) {
                otonumAgentInterval = setInterval(async () => {
                    termLog('[AGENT] 🔄 Periyodik agent döngüsü...', 'info');
                    await osintAgentCalistir();
                    await taramaAgentCalistir();
                }, 60000);
            }
        }

        // Agentları durdur
        function agentlariDurdur() {
            if (otonumAgentInterval) {
                clearInterval(otonumAgentInterval);
                otonumAgentInterval = null;
            }

            ['tarama', 'konum', 'osint'].forEach(agent => {
                otonumAgentDurum[agent].aktif = false;
                agentUIGuncelle(agent, 'bekliyor');
            });

            termLog('[AGENT] ⏹️ Agentlar durduruldu', 'warn');
        }

        // Sayfa yüklendiğinde agentları otomatik başlat
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                tumAgentlariBaslat();
            }, 3000); // 3 saniye sonra başlat
        });

        // Terminal - Gelismis Toggle
        function termToggle() {
            console.log('[TERMINAL] Toggle çağrıldı');
            const termBar = document.getElementById('termBar');
            if (!termBar) {
                console.error('[TERMINAL] termBar bulunamadı!');
                return;
            }
            termBar.classList.toggle('expanded');
            console.log('[TERMINAL] Expanded:', termBar.classList.contains('expanded'));

            if (termBar.classList.contains('expanded')) {
                const termIn = document.getElementById('termIn');
                if (termIn) {
                    setTimeout(() => termIn.focus(), 100);
                }
            }
        }

        // Terminal header cursor style - onclick zaten var, ekstra listener gerekmiyor
        document.addEventListener('DOMContentLoaded', () => {
            const termHeader = document.querySelector('.terminal-header');
            if (termHeader) {
                termHeader.style.cursor = 'pointer';
                console.log('[TERMINAL] Terminal hazır');
            }
        });

        function termLog(msg, type = '') {
            const out = document.getElementById('termOut');
            const line = document.createElement('div');
            line.className = type;
            line.textContent = msg;
            out.appendChild(line);
            out.scrollTop = out.scrollHeight;
        }

        function termClear() { document.getElementById('termOut').innerHTML = ''; }

        function termCmd(cmd) {
            document.getElementById('termIn').value = cmd;
            termExec(cmd);
        }

        async function termExec(cmd) {
            termLog('tsunami:~$ ' + cmd, 'info');
            cmdHist.push(cmd);
            cmdIdx = cmdHist.length;

            try {
                const r = await fetch('/api/cli/calistir', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ komut: cmd })
                });
                const d = await r.json();

                if (d.cikti) {
                    d.cikti.split('\n').forEach(line => {
                        let type = '';
                        if (line.includes('[+]')) type = 'ok';
                        else if (line.includes('[-]')) type = 'err';
                        else if (line.includes('[*]') || line.includes('[!]')) type = 'warn';
                        termLog(line, type);
                    });
                }

                if (d.yenile_harita) await loadData();

            } catch (e) { termLog('Hata: ' + e.message, 'err'); }
        }

        function termKey(e) {
            if (e.key === 'Enter') {
                const cmd = e.target.value.trim();
                if (cmd) { termExec(cmd); e.target.value = ''; }
            } else if (e.key === 'ArrowUp' && cmdIdx > 0) {
                cmdIdx--; e.target.value = cmdHist[cmdIdx];
            } else if (e.key === 'ArrowDown') {
                if (cmdIdx < cmdHist.length - 1) { cmdIdx++; e.target.value = cmdHist[cmdIdx]; }
                else { cmdIdx = cmdHist.length; e.target.value = ''; }
            }
        }

        function konum() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    map.setView([pos.coords.latitude, pos.coords.longitude], 14);
                    L.marker([pos.coords.latitude, pos.coords.longitude], {
                        icon: L.divIcon({
                            html: '<div style="width:12px;height:12px;background:var(--accent-warning);border-radius:50%;border:3px solid #fff;box-shadow:0 0 12px var(--accent-warning)"></div>',
                            iconSize: [12, 12], iconAnchor: [6, 6]
                        })
                    }).addTo(map).bindPopup('<strong>Konumunuz</strong>').openPopup();
                    termLog('Konum tespit edildi', 'ok');
                });
            }
        }

        function tara() {
            socket.emit('tarama_baslat', { tip: 'tum' });
            termLog('Tarama başlatıldı...', 'info');
        }

        // ============================================
        // SİBER KOMUTA MERKEZİ - Pentagon Seviye Entegrasyon
        // ============================================
        const SiberKomuta = {
            initialized: false,
            agents: [],
            aircraftLayer: null,
            issMarker: null,
            updateInterval: null,

            // Başlat
            init: function() {
                if (this.initialized) return;

                console.log('[SİBER] Komuta Merkezi başlatılıyor...');

                // Socket event'lerini dinle
                if (typeof socket !== 'undefined') {
                    socket.on('siber_durum', this.handleStatus.bind(this));
                    socket.on('siber_ajanlar', this.handleAgents.bind(this));
                    socket.on('siber_osint_basladi', (d) => termLog(`[OSINT] Tarama başladı: ${d.hedef}`, 'info'));
                    socket.on('siber_osint_sonuc', this.handleOSINTResult.bind(this));
                    socket.on('siber_tehdit_avi_basladi', (d) => termLog(`[TEHDİT AVI] ${d.hedef_sayisi} hedef`, 'info'));
                    socket.on('siber_tehdit_avi_sonuc', this.handleThreatHuntResult.bind(this));
                    socket.on('siber_hata', (d) => termLog(`[SİBER HATA] ${d.hata}`, 'error'));

                    // Başlangıç verilerini iste
                    socket.emit('siber_durum_iste');
                    socket.emit('siber_ajanlar_iste');
                }

                // Aircraft layer oluştur
                this.aircraftLayer = L.layerGroup();

                this.initialized = true;
                console.log('[SİBER] Komuta Merkezi hazır');
            },

            // Durum güncelleme
            handleStatus: function(data) {
                const stats = data.statistics || {};
                const el = (id) => document.getElementById(id);

                if (el('siberAgentCount')) el('siberAgentCount').textContent = data.agents?.total || 22;
                if (el('siberOpsCount')) el('siberOpsCount').textContent = stats.total_operations || 0;
                if (el('siberThreatCount')) el('siberThreatCount').textContent = stats.threats_detected || 0;

                termLog(`[SİBER] Durum: ${data.status}, Ajanlar: ${data.agents?.total || 0}`, 'success');
            },

            // Ajanları güncelle
            handleAgents: function(data) {
                this.agents = data.ajanlar || [];
                this.updateAgentsMini();
                termLog(`[SİBER] ${this.agents.length} Pentagon ajanı yüklendi`, 'success');
            },

            // Mini ajan listesini güncelle
            updateAgentsMini: function() {
                const container = document.getElementById('siberAgentsMini');
                if (!container) return;

                // Katmanlara göre grupla
                const layers = {
                    command: { name: 'Komuta', agents: [], color: 'command' },
                    intelligence: { name: 'İstihbarat', agents: [], color: 'intelligence' },
                    defense: { name: 'Savunma', agents: [], color: 'defense' },
                    offensive: { name: 'Saldırı', agents: [], color: 'offensive' },
                    purple: { name: 'Mor Takım', agents: [], color: 'purple' },
                    critical_infrastructure: { name: 'Kritik Altyapı', agents: [], color: 'critical' },
                    global_operations: { name: 'Global Ops', agents: [], color: 'global' }
                };

                this.agents.forEach(agent => {
                    const layer = agent.layer || 'command';
                    if (layers[layer]) {
                        layers[layer].agents.push(agent);
                    }
                });

                let html = '';
                Object.entries(layers).forEach(([key, layer]) => {
                    if (layer.agents.length > 0) {
                        html += `<div class="siber-agent-layer">
                            <div class="siber-layer-header ${layer.color}">${layer.name} (${layer.agents.length})</div>`;
                        layer.agents.slice(0, 2).forEach(agent => {
                            const statusClass = agent.status === 'busy' ? 'busy' : (agent.status === 'error' ? 'error' : '');
                            html += `<div class="siber-agent-item">
                                <span class="siber-agent-name">${agent.name}</span>
                                <span class="siber-agent-status ${statusClass}">${agent.status}</span>
                            </div>`;
                        });
                        html += '</div>';
                    }
                });

                container.innerHTML = html;
            },

            // Hızlı OSINT çalıştır
            runOSINT: function() {
                const input = document.getElementById('siberOsintTarget');
                const target = input ? input.value.trim() : '';

                if (!target) {
                    termLog('[SİBER] OSINT için hedef girin', 'warning');
                    return;
                }

                termLog(`[SİBER] OSINT başlatılıyor: ${target}`, 'info');

                if (typeof socket !== 'undefined') {
                    socket.emit('siber_osint_baslat', { hedef: target });
                } else {
                    // Fallback: HTTP API
                    fetch('/api/siber/osint', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ hedef: target })
                    })
                    .then(r => r.json())
                    .then(data => this.handleOSINTResult(data))
                    .catch(e => termLog(`[SİBER] OSINT hatası: ${e}`, 'error'));
                }

                if (input) input.value = '';
            },

            // OSINT sonucunu işle
            handleOSINTResult: function(data) {
                termLog('[SİBER] OSINT tamamlandı', 'success');
                termLog(`  Risk Skoru: ${data.risk_score || 0}`, data.risk_score > 50 ? 'warning' : 'info');
                termLog(`  Güven: ${((data.confidence || 0) * 100).toFixed(0)}%`, 'info');
                termLog(`  Bulgu: ${(data.findings || []).length}`, 'info');

                // Yüksek riskli bulguları göster
                const findings = data.findings || [];
                findings.filter(f => f.severity === 'critical' || f.severity === 'high').slice(0, 5).forEach(f => {
                    termLog(`  [${(f.severity || 'info').toUpperCase()}] ${f.type}`, 'error');
                });

                // Haritada göster (varsa geo data)
                if (data.sources) {
                    Object.values(data.sources).forEach(source => {
                        if (source.lat && source.lon) {
                            const marker = L.marker([source.lat, source.lon], {
                                icon: L.divIcon({
                                    className: 'osint-marker',
                                    html: '<span style="font-size:16px;">🔍</span>',
                                    iconSize: [20, 20]
                                })
                            }).addTo(map);
                            marker.bindPopup(`<b>OSINT Bulgu</b><br>${data.target}<br>Kaynak: ${source.source || 'unknown'}`);
                        }
                    });
                }
            },

            // Tehdit avı başlat
            startThreatHunt: function() {
                const targets = prompt('Hedefleri virgülle ayırarak girin (örn: 8.8.8.8, example.com):');
                if (!targets) return;

                const hedefler = targets.split(',').map(t => t.trim()).filter(t => t);
                if (hedefler.length === 0) {
                    termLog('[SİBER] Geçerli hedef girilmedi', 'warning');
                    return;
                }

                termLog(`[SİBER] Tehdit avı başlatılıyor: ${hedefler.length} hedef`, 'info');

                if (typeof socket !== 'undefined') {
                    socket.emit('siber_tehdit_avi', { hedefler: hedefler });
                } else {
                    fetch('/api/siber/tehdit-avi', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ hedefler: hedefler })
                    })
                    .then(r => r.json())
                    .then(data => this.handleThreatHuntResult(data))
                    .catch(e => termLog(`[SİBER] Tehdit avı hatası: ${e}`, 'error'));
                }
            },

            // Tehdit avı sonucu
            handleThreatHuntResult: function(data) {
                const summary = data.summary || {};
                termLog('[SİBER] Tehdit avı tamamlandı', 'success');
                termLog(`  Misyon: ${data.mission_id || 'unknown'}`, 'info');
                termLog(`  Toplam Bulgu: ${summary.total_findings || 0}`, 'info');
                termLog(`  Kritik: ${summary.critical || 0}`, summary.critical > 0 ? 'error' : 'info');
                termLog(`  Yüksek: ${summary.high || 0}`, summary.high > 0 ? 'warning' : 'info');

                // Tehdit sayısını güncelle
                const el = document.getElementById('siberThreatCount');
                if (el) {
                    el.textContent = parseInt(el.textContent || '0') + (summary.critical || 0) + (summary.high || 0);
                }
            },

            // Hava sahası katmanını toggle et
            toggleAircraftLayer: function() {
                const btn = document.getElementById('btnAircraftLayer');

                if (map.hasLayer(this.aircraftLayer)) {
                    map.removeLayer(this.aircraftLayer);
                    if (btn) btn.classList.remove('active');
                    if (this.updateInterval) {
                        clearInterval(this.updateInterval);
                        this.updateInterval = null;
                    }
                    termLog('[SİBER] Hava sahası katmanı kapatıldı', 'info');
                } else {
                    this.aircraftLayer.addTo(map);
                    if (btn) btn.classList.add('active');
                    this.loadAircraftData();
                    // 30 saniyede bir güncelle
                    this.updateInterval = setInterval(() => this.loadAircraftData(), 30000);
                    termLog('[SİBER] Hava sahası katmanı açıldı', 'success');
                }
            },

            // Uçak verilerini yükle
            loadAircraftData: async function() {
                try {
                    const center = map.getCenter();
                    const resp = await fetch(`/api/siber/hava-sahasi?lat=${center.lat}&lon=${center.lng}&radius=200`);
                    const data = await resp.json();

                    if (data.error) {
                        termLog(`[HAVA SAHASI] Hata: ${data.error}`, 'error');
                        return;
                    }

                    // Mevcut marker'ları temizle
                    this.aircraftLayer.clearLayers();

                    const aircraft = data.aircraft || [];
                    const military = data.military || [];

                    termLog(`[HAVA SAHASI] ${aircraft.length} uçak, ${military.length} askeri`, 'info');

                    // Askeri uçaklar (önce ekle - daha görünür olsun)
                    military.forEach(ac => {
                        if (ac.latitude && ac.longitude) {
                            const marker = L.marker([ac.latitude, ac.longitude], {
                                icon: L.divIcon({
                                    className: 'aircraft-marker',
                                    html: `<span class="aircraft-icon military" style="transform:rotate(${ac.heading || 0}deg)">✈</span>`,
                                    iconSize: [24, 24]
                                }),
                                rotationAngle: ac.heading || 0
                            });

                            marker.bindPopup(`
                                <div class="aircraft-popup">
                                    <div class="callsign military">🎖️ ${ac.callsign || 'MILITARY'}</div>
                                    <div>Ülke: ${ac.origin_country || 'Bilinmiyor'}</div>
                                    <div>Yükseklik: ${ac.altitude ? Math.round(ac.altitude) + 'm' : 'N/A'}</div>
                                    <div>Hız: ${ac.velocity ? Math.round(ac.velocity * 3.6) + ' km/h' : 'N/A'}</div>
                                    <div>ICAO24: ${ac.icao24 || 'N/A'}</div>
                                </div>
                            `);

                            this.aircraftLayer.addLayer(marker);
                        }
                    });

                    // Sivil uçaklar (limit)
                    aircraft.slice(0, 50).forEach(ac => {
                        if (ac.latitude && ac.longitude && !military.find(m => m.icao24 === ac.icao24)) {
                            const marker = L.marker([ac.latitude, ac.longitude], {
                                icon: L.divIcon({
                                    className: 'aircraft-marker',
                                    html: `<span class="aircraft-icon civilian" style="transform:rotate(${ac.heading || 0}deg)">✈</span>`,
                                    iconSize: [20, 20]
                                })
                            });

                            marker.bindPopup(`
                                <div class="aircraft-popup">
                                    <div class="callsign">${ac.callsign || 'N/A'}</div>
                                    <div>Ülke: ${ac.origin_country || 'Bilinmiyor'}</div>
                                    <div>Yükseklik: ${ac.altitude ? Math.round(ac.altitude) + 'm' : 'N/A'}</div>
                                    <div>Hız: ${ac.velocity ? Math.round(ac.velocity * 3.6) + ' km/h' : 'N/A'}</div>
                                </div>
                            `);

                            this.aircraftLayer.addLayer(marker);
                        }
                    });

                } catch (e) {
                    termLog(`[HAVA SAHASI] Veri yükleme hatası: ${e}`, 'error');
                }
            },

            // ISS takibi
            trackISS: async function() {
                const btn = document.getElementById('btnISSTrack');

                if (this.issMarker) {
                    map.removeLayer(this.issMarker);
                    this.issMarker = null;
                    if (btn) btn.classList.remove('active');
                    termLog('[SİBER] ISS takibi durduruldu', 'info');
                    return;
                }

                try {
                    const resp = await fetch('/api/siber/iss');
                    const data = await resp.json();

                    if (data.latitude && data.longitude) {
                        this.issMarker = L.marker([data.latitude, data.longitude], {
                            icon: L.divIcon({
                                className: 'iss-marker',
                                html: '<span class="iss-icon">🛰️</span>',
                                iconSize: [30, 30]
                            })
                        }).addTo(map);

                        this.issMarker.bindPopup(`
                            <b>🛰️ Uluslararası Uzay İstasyonu</b><br>
                            Enlem: ${data.latitude.toFixed(4)}<br>
                            Boylam: ${data.longitude.toFixed(4)}<br>
                            <small>Son güncelleme: ${new Date(data.timestamp * 1000).toLocaleTimeString()}</small>
                        `).openPopup();

                        map.setView([data.latitude, data.longitude], 4);
                        if (btn) btn.classList.add('active');
                        termLog(`[SİBER] ISS konumu: ${data.latitude.toFixed(2)}, ${data.longitude.toFixed(2)}`, 'success');

                        // 10 saniyede bir güncelle
                        this.issUpdateInterval = setInterval(async () => {
                            try {
                                const r = await fetch('/api/siber/iss');
                                const d = await r.json();
                                if (d.latitude && d.longitude && this.issMarker) {
                                    this.issMarker.setLatLng([d.latitude, d.longitude]);
                                }
                            } catch (e) {}
                        }, 10000);
                    }
                } catch (e) {
                    termLog(`[SİBER] ISS verisi alınamadı: ${e}`, 'error');
                }
            }
        };

        // Sayfa yüklendiğinde Siber Komuta'yı başlat
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => SiberKomuta.init(), 1000);
        });

        // ============================================
        // Widget State Manager v2.0 - Premium Widget System
        // ============================================
        const WidgetStateManager = {
            STORAGE_KEY: 'tsunami_widget_states',
            VERSION_KEY: 'tsunami_widget_version',
            CURRENT_VERSION: '3.0.0', // Premium Widget System ile yeni layout

            // Versiyon kontrolu - eski layout'u temizle
            checkVersion: function() {
                const savedVersion = localStorage.getItem(this.VERSION_KEY);
                if (savedVersion !== this.CURRENT_VERSION) {
                    console.log('[WidgetStateManager] Yeni versiyon tespit edildi, layout sifirlaniyor...');
                    localStorage.removeItem(this.STORAGE_KEY);
                    localStorage.setItem(this.VERSION_KEY, this.CURRENT_VERSION);
                    return true;
                }
                return false;
            },

            // Widget durumlarini yukle
            loadStates: function() {
                this.checkVersion();
                try {
                    const saved = localStorage.getItem(this.STORAGE_KEY);
                    return saved ? JSON.parse(saved) : {};
                } catch (e) {
                    console.warn('[WidgetStateManager] localStorage okunamadi:', e);
                    return {};
                }
            },

            // Widget durumlarini kaydet
            saveStates: function(states) {
                try {
                    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(states));
                } catch (e) {
                    console.warn('[WidgetStateManager] localStorage yazilamadi:', e);
                }
            },

            // Widget toggle - CSS handles animation via .collapsed class
            toggle: function(widgetId) {
                const card = document.querySelector(`[data-widget-id="${widgetId}"]`);
                if (!card) {
                    console.warn('[WidgetStateManager] Widget bulunamadi:', widgetId);
                    return;
                }

                const isCollapsed = card.classList.toggle('collapsed');

                // Durumu kaydet
                const states = this.loadStates();
                states[widgetId] = isCollapsed;
                this.saveStates(states);

                console.log(`[WidgetStateManager] ${widgetId}: ${isCollapsed ? 'kapatildi' : 'acildi'}`);
            },

            // Kayitli durumlari uygula
            applyStoredStates: function() {
                const states = this.loadStates();
                Object.keys(states).forEach(widgetId => {
                    if (states[widgetId]) {
                        const card = document.querySelector(`[data-widget-id="${widgetId}"]`);
                        if (card) {
                            card.classList.add('collapsed');
                        }
                    }
                });

                // Sidebar durumunu da uygula
                const sidebarCollapsed = localStorage.getItem('tsunami_sidebar_collapsed') === 'true';
                if (sidebarCollapsed) {
                    document.getElementById('sidePanel')?.classList.add('collapsed');
                }

                console.log('[WidgetStateManager] Kayitli widget durumlari uygulandi');
            },

            // Tum widget'lari ac
            expandAll: function() {
                document.querySelectorAll('.widget-card[data-widget-id]').forEach(card => {
                    card.classList.remove('collapsed');
                });
                this.saveStates({});
            },

            // Tum widget'lari kapat
            collapseAll: function() {
                const states = {};
                document.querySelectorAll('.widget-card[data-widget-id]').forEach(card => {
                    const widgetId = card.getAttribute('data-widget-id');
                    card.classList.add('collapsed');
                    states[widgetId] = true;
                });
                this.saveStates(states);
            }
        };

        // Sayfa yüklendiğinde widget durumlarını uygula
        document.addEventListener('DOMContentLoaded', function() {
            // iframe modunda tüm widget'ları göster
            if (document.body.classList.contains('in-iframe')) {
                // Widget'ların CSS'ten gizlenmemesi için özel kontrol
                const widgetsToShow = ['torPanel', 'agentsPanel', 'geoAnalysisPanel', 'globalOsintPanel', 'attacksPanel'];
                widgetsToShow.forEach(widgetId => {
                    const widget = document.querySelector(`[data-widget-id="${widgetId}"]`);
                    if (widget) {
                        widget.style.display = 'block';
                        // Collapsed durumunu kaldır
                        widget.classList.remove('collapsed');
                        const arrow = widget.querySelector('.collapse-arrow');
                        if (arrow) arrow.textContent = '▼';
                    }
                });
                // localStorage'daki kapalı durumları temizle
                const states = WidgetStateManager.loadStates();
                widgetsToShow.forEach(id => delete states[id]);
                WidgetStateManager.saveStates(states);
                console.log('[WidgetStateManager] iframe modu: Widget\'lar gösterildi');
            } else {
                WidgetStateManager.applyStoredStates();
            }
        });

        // ============================================
        // ICON DOCK + FLYOUT SYSTEM v3.0
        // ============================================
        let activeFlyout = null;

        // Flyout paneli ac/kapat
        function toggleFlyout(panelId) {
            const flyout = document.getElementById('flyout-' + panelId);
            const backdrop = document.getElementById('flyoutBackdrop');
            const dockItems = document.querySelectorAll('.dock-item');

            if (!flyout) {
                console.warn('[Flyout] Panel bulunamadi:', panelId);
                return;
            }

            // Ayni panel aciksa kapat
            if (activeFlyout === panelId) {
                closeFlyout();
                return;
            }

            // Onceki paneli kapat
            if (activeFlyout) {
                const prevFlyout = document.getElementById('flyout-' + activeFlyout);
                if (prevFlyout) prevFlyout.classList.remove('active');
            }

            // Yeni paneli ac
            flyout.classList.add('active');
            backdrop.classList.add('active');
            activeFlyout = panelId;

            // Dock item'i aktif yap
            dockItems.forEach(item => {
                const tooltip = item.getAttribute('data-tooltip');
                const itemPanel = item.onclick?.toString().match(/toggleFlyout\(['"]([^'"]+)['"]\)/)?.[1];
                if (itemPanel === panelId) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });

            // LocalStorage'a kaydet
            localStorage.setItem('tsunami_active_flyout', panelId);

            console.log('[Flyout] Acildi:', panelId);
        }

        // Flyout paneli kapat
        function closeFlyout() {
            const backdrop = document.getElementById('flyoutBackdrop');
            const dockItems = document.querySelectorAll('.dock-item');

            if (activeFlyout) {
                const flyout = document.getElementById('flyout-' + activeFlyout);
                if (flyout) flyout.classList.remove('active');
            }

            backdrop.classList.remove('active');
            dockItems.forEach(item => item.classList.remove('active'));

            activeFlyout = null;
            localStorage.removeItem('tsunami_active_flyout');

            console.log('[Flyout] Kapatildi');
        }

        // Sayfa yuklendiginde son acik flyout'u geri yukle
        function restoreLastFlyout() {
            const lastFlyout = localStorage.getItem('tsunami_active_flyout');
            if (lastFlyout) {
                setTimeout(() => toggleFlyout(lastFlyout), 500);
            }
        }

        // ESC tusu ile flyout kapat
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && activeFlyout) {
                closeFlyout();
            }
        });

        // ==================== SOC KOMUTA MERKEZİ JS ====================
        function socTabDegistir(tab) {
            document.querySelectorAll('.soc-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.soc-tab-content').forEach(c => { c.classList.remove('active'); c.style.display = 'none'; });
            const btn = document.querySelector(`.soc-tab[data-tab="${tab}"]`);
            const content = document.getElementById('socTab-' + tab);
            if (btn) btn.classList.add('active');
            if (content) { content.classList.add('active'); content.style.display = 'block'; }
        }

        async function socOzetYukle() {
            try {
                const resp = await fetch('/api/harita/soc/ozet');
                const data = await resp.json();
                if (!data.basarili) return;
                const o = data.ozet;

                // Alarm kuyrugu
                if (o.alarm_kuyrugu) {
                    const aq = o.alarm_kuyrugu;
                    const el = (id, val) => { const e = document.getElementById(id); if (e) e.textContent = val; };
                    el('socCritical', aq.kritik || 0);
                    el('socHigh', aq.yuksek || 0);
                    el('socMedium', aq.orta || 0);
                    el('socLow', aq.dusuk || 0);
                    el('socMTTD', aq.mttd || 'N/A');
                    el('socMTTR', aq.mttr || 'N/A');
                    el('socSLABreached', aq.sla_ihlali || 0);
                    // Badge
                    const toplam = aq.toplam || 0;
                    const badge = document.getElementById('socAlertBadge');
                    if (badge) {
                        badge.textContent = toplam;
                        badge.style.display = toplam > 0 ? 'flex' : 'none';
                    }
                    // Intervention kart
                    el('statSOCActive', toplam);
                    el('statSOCCritical', aq.kritik || 0);
                    el('statSOCSLA', aq.sla_ihlali || 0);
                }

                // SIEM
                if (o.siem) {
                    const s = o.siem;
                    const wBadge = document.getElementById('socWazuhBadge');
                    const wStatus = document.getElementById('socWazuhStatus');
                    if (wBadge) wBadge.style.background = s.wazuh ? '#00c853' : '#444';
                    if (wStatus) wStatus.textContent = s.wazuh ? 'Bağlı' : 'Bağlantı yok';
                    const sBadge = document.getElementById('socSuricataBadge');
                    const sStatus = document.getElementById('socSuricataStatus');
                    if (sBadge) sBadge.style.background = s.suricata ? '#00c853' : '#444';
                    if (sStatus) sStatus.textContent = s.suricata ? 'Bağlı' : 'Bağlantı yok';
                    const sigEl = document.getElementById('socSigmaRules');
                    if (sigEl) sigEl.textContent = s.sigma_kurali || 0;
                }

                // Vakalar
                if (o.vaka_yonetimi) {
                    const v = o.vaka_yonetimi;
                    const thStatus = document.getElementById('socTheHiveStatus');
                    if (thStatus) thStatus.textContent = v.aktif ? 'Bağlı' : 'Bağlantı yok';
                    const oc = document.getElementById('socOpenCases');
                    const tc = document.getElementById('socTotalCases');
                    if (oc) oc.textContent = v.acik_vaka || 0;
                    if (tc) tc.textContent = v.toplam_vaka || 0;
                }

                // Tehdit
                if (o.tehdit_istihbarati) {
                    const t = o.tehdit_istihbarati;
                    const mStatus = document.getElementById('socMISPStatus');
                    if (mStatus) mStatus.textContent = t.aktif ? 'Bağlı' : 'Bağlantı yok';
                    const ioc = document.getElementById('socIOCCount');
                    const ev = document.getElementById('socEventCount');
                    if (ioc) ioc.textContent = t.ioc_sayisi || 0;
                    if (ev) ev.textContent = t.olay_sayisi || 0;
                }

                // Uyumluluk
                if (o.uyumluluk) {
                    const u = o.uyumluluk;
                    const elN = document.getElementById('socNIST');
                    const elI = document.getElementById('socISO');
                    const elK = document.getElementById('socKVKK');
                    const elO = document.getElementById('socOverallScore');
                    if (elN) elN.textContent = (u.nist || 0) + '%';
                    if (elI) elI.textContent = (u.iso27001 || 0) + '%';
                    if (elK) elK.textContent = (u.kvkk || 0) + '%';
                    if (elO) elO.innerHTML = (u.skor || 0) + '<span style="font-size:14px;color:#888;">%</span>';
                }

                // Modul durumu
                socModulDurumGuncelle();
                console.log('[SOC] Özet güncellendi');
            } catch (e) {
                console.warn('[SOC] Özet yükleme hatası:', e);
            }
        }

        function socModulDurumGuncelle() {
            const dots = document.querySelectorAll('.soc-mod-dot');
            dots.forEach(dot => dot.classList.add('active'));
        }

        async function socAlarmListesiYukle() {
            try {
                const resp = await fetch('/api/v1/soc/alerts/queue?status=open&limit=20');
                const data = await resp.json();
                if (!data.success) return;
                socAlarmListesiRender(data.alerts || []);
            } catch (e) {
                console.warn('[SOC] Alarm listesi hatası:', e);
            }
        }

        function socAlarmListesiRender(alarmlar) {
            const container = document.getElementById('socAlarmListesi');
            if (!container) return;
            if (!alarmlar.length) {
                container.innerHTML = '<div style="text-align:center;color:#555;font-size:10px;padding:20px 0;">Aktif alarm yok</div>';
                return;
            }
            const sevColors = { CRITICAL: '#ff1744', HIGH: '#ff6d00', MEDIUM: '#ffab00', LOW: '#00bfa5' };
            container.innerHTML = alarmlar.slice(0, 20).map(a => `
                <div class="soc-alarm-item" style="--alarm-color:${sevColors[a.severity] || '#444'}" onclick="socAlarmDetayGoster('${a.alert_id}')">
                    <div style="font-size:8px;font-weight:bold;color:${sevColors[a.severity] || '#aaa'};min-width:20px;">${(a.severity || 'N/A').charAt(0)}</div>
                    <div style="flex:1;overflow:hidden;">
                        <div style="font-size:10px;color:#ddd;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${a.title || a.source_rule || 'Alarm'}</div>
                        <div style="font-size:8px;color:#666;">${a.source || 'Bilinmiyor'} | ${a.created_at ? new Date(a.created_at).toLocaleTimeString('tr-TR') : ''}</div>
                    </div>
                </div>
            `).join('');
        }

        function socAlarmDetayGoster(alarmId) {
            fetch('/api/v1/soc/alerts/' + alarmId)
                .then(r => r.json())
                .then(data => {
                    if (!data.success || !data.data) return;
                    const a = data.data;
                    const sevColors = { CRITICAL: '#ff1744', HIGH: '#ff6d00', MEDIUM: '#ffab00', LOW: '#00bfa5' };
                    const modal = document.createElement('div');
                    modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:99999;display:flex;align-items:center;justify-content:center;';
                    modal.innerHTML = `
                        <div style="background:#0d1117;border:1px solid rgba(200,50,180,0.3);border-radius:12px;padding:20px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto;">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                                <div style="font-size:14px;font-weight:bold;color:${sevColors[a.severity] || '#fff'};">${a.severity || ''} ALARM</div>
                                <button onclick="this.closest('div[style*=fixed]').remove()" style="background:none;border:none;color:#888;font-size:18px;cursor:pointer;">✕</button>
                            </div>
                            <div style="font-size:12px;color:#ddd;margin-bottom:8px;">${a.title || a.source_rule || ''}</div>
                            <div style="font-size:10px;color:#888;margin-bottom:12px;">Kaynak: ${a.source || 'N/A'} | Durum: ${a.status || 'N/A'}</div>
                            ${a.description ? `<div style="font-size:10px;color:#aaa;background:rgba(0,0,0,0.3);padding:8px;border-radius:6px;margin-bottom:10px;">${a.description}</div>` : ''}
                            <div style="display:flex;gap:8px;margin-top:12px;">
                                <button onclick="socAlarmAksiyon('${a.alert_id}','triage');this.closest('div[style*=fixed]').remove();" style="flex:1;padding:8px;background:rgba(0,180,255,0.2);border:1px solid rgba(0,180,255,0.4);border-radius:6px;color:#00b4ff;cursor:pointer;font-size:10px;">Triaj Yap</button>
                                <button onclick="socAlarmAksiyon('${a.alert_id}','resolve');this.closest('div[style*=fixed]').remove();" style="flex:1;padding:8px;background:rgba(0,255,136,0.2);border:1px solid rgba(0,255,136,0.4);border-radius:6px;color:#00ff88;cursor:pointer;font-size:10px;">Çözümle</button>
                            </div>
                        </div>`;
                    document.body.appendChild(modal);
                    modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
                })
                .catch(e => console.warn('[SOC] Alarm detay hatası:', e));
        }

        function socAlarmAksiyon(alarmId, aksiyon) {
            const url = `/api/v1/soc/alerts/${alarmId}/${aksiyon}`;
            const body = aksiyon === 'triage' ? { triage_level: 'investigating', analyst: 'SOC Analyst' } : { resolution: 'resolved_manually', notes: 'Harita panelinden çözümlendi' };
            fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        console.log('[SOC] Alarm aksiyonu başarılı:', aksiyon, alarmId);
                        socAlarmListesiYukle();
                        socOzetYukle();
                    }
                })
                .catch(e => console.warn('[SOC] Aksiyon hatası:', e));
        }

        // SOC paneli açıldığında alarm listesini yükle
        const _origToggleFlyout = toggleFlyout;
        toggleFlyout = function(panelId) {
            _origToggleFlyout(panelId);
            if (panelId === 'soc') {
                socAlarmListesiYukle();
                socOzetYukle();
            }
        };

        // SocketIO SOC dinleyicileri
        if (typeof socket !== 'undefined') {
            socket.on('soc_yeni_alarm', function(data) {
                console.log('[SOC] Yeni alarm:', data);
                // Badge güncelle
                const badge = document.getElementById('socAlertBadge');
                if (badge) {
                    const mevcut = parseInt(badge.textContent) || 0;
                    badge.textContent = mevcut + 1;
                    badge.style.display = 'flex';
                }
                // Alarm listesini yenile
                if (activeFlyout === 'soc') socAlarmListesiYukle();
                // Terminal log
                if (typeof addTerminalLog === 'function') {
                    addTerminalLog(`[SOC ALARM] ${data.severity || 'INFO'}: ${data.title || 'Yeni alarm'}`, 'warning');
                }
                // Kritik alarmda browser notification
                if (data.severity === 'CRITICAL' && Notification.permission === 'granted') {
                    new Notification('SOC KRİTİK ALARM', { body: data.title || 'Kritik seviye alarm tespit edildi', icon: '/static/img/logo.png' });
                }
            });

            socket.on('soc_sla_ihlali', function(data) {
                console.log('[SOC] SLA ihlali:', data);
                if (typeof addTerminalLog === 'function') {
                    addTerminalLog(`[SOC SLA İHLALİ] ${data.alert_id || ''}: ${data.message || 'SLA süresi aşıldı'}`, 'error');
                }
                socOzetYukle();
            });
        }

        // SOC verileri periyodik güncelleme (60sn)
        setInterval(function() {
            if (activeFlyout === 'soc') {
                socOzetYukle();
                socAlarmListesiYukle();
            }
        }, 60000);

        // Sayfa yuklendiginde calistir
        document.addEventListener('DOMContentLoaded', restoreLastFlyout);
        // ============================================

        // Legacy: Tum widget'lari ac/kapat (Deprecated)
        let allWidgetsCollapsed = false;
        function toggleAllWidgets() {
            console.log('[toggleAllWidgets] Fonksiyon cagirildi');

            const widgetIds = ['navPanel', 'torPanel', 'agentsPanel', 'geoAnalysisPanel', 'globalOsintPanel', 'aiAsistanPanel', 'bleRadarPanel', 'aiStatsPanel'];

            // Durumu degistir
            allWidgetsCollapsed = !allWidgetsCollapsed;
            console.log('[toggleAllWidgets] Yeni durum:', allWidgetsCollapsed ? 'KAPALI' : 'ACIK');

            let processedCount = 0;
            widgetIds.forEach(widgetId => {
                const card = document.querySelector(`[data-widget-id="${widgetId}"]`);
                if (!card) {
                    console.warn('[toggleAllWidgets] Widget bulunamadi:', widgetId);
                    return;
                }

                if (allWidgetsCollapsed) {
                    card.classList.add('collapsed');
                } else {
                    card.classList.remove('collapsed');
                }
                processedCount++;
            });

            // localStorage'a kaydet
            try {
                const states = {};
                widgetIds.forEach(id => { states[id] = allWidgetsCollapsed; });
                localStorage.setItem('tsunami_widget_states', JSON.stringify(states));
            } catch(e) {
                console.warn('[toggleAllWidgets] localStorage hatasi:', e);
            }

            console.log(`[toggleAllWidgets] ${processedCount} widget ${allWidgetsCollapsed ? 'daraltildi' : 'genisletildi'}`);
        }

        // Canli Saldirilar HARIC diger tum widgetlari toggle et (Master Control)
        function toggleAllOtherWidgets() {
            const widgetIds = ['navPanel', 'torPanel', 'agentsPanel', 'geoAnalysisPanel',
                               'globalOsintPanel', 'aiAsistanPanel', 'bleRadarPanel', 'aiStatsPanel'];

            // Mevcut durumu kontrol et (cogunluk acik mi kapali mi?)
            let collapsedCount = 0;
            widgetIds.forEach(id => {
                const card = document.querySelector(`[data-widget-id="${id}"]`);
                if (card && card.classList.contains('collapsed')) collapsedCount++;
            });

            // Cogunluk kapaliysa ac, degilse kapat
            const shouldExpand = collapsedCount > widgetIds.length / 2;

            console.log(`[toggleAllOtherWidgets] ${collapsedCount}/${widgetIds.length} kapali, ${shouldExpand ? 'ACILIYOR' : 'KAPATILIYOR'}`);

            const states = WidgetStateManager.loadStates();
            widgetIds.forEach(id => {
                const card = document.querySelector(`[data-widget-id="${id}"]`);
                if (card) {
                    if (shouldExpand) {
                        card.classList.remove('collapsed');
                        states[id] = false;
                    } else {
                        card.classList.add('collapsed');
                        states[id] = true;
                    }
                }
            });
            WidgetStateManager.saveStates(states);

            // Master toggle buton ikonunu guncelle
            const masterBtn = document.querySelector('.widget-master-toggle');
            if (masterBtn) {
                masterBtn.classList.toggle('all-collapsed', !shouldExpand);
            }
        }

        // Global scope'a ekle (onclick icin)
        window.toggleAllWidgets = toggleAllWidgets;
        window.toggleAllOtherWidgets = toggleAllOtherWidgets;

        // Eski toggleNav fonksiyonunu WidgetStateManager'a yönlendir
        function toggleNav() {
            WidgetStateManager.toggle('navPanel');
        }

        // AI Chat Panel
        function toggleAIChat() {
            const container = document.getElementById('aiChatContainer');
            container.classList.toggle('visible');
            if (container.classList.contains('visible')) {
                document.getElementById('aiInput').focus();
            }
        }

        async function sendAI() {
            const input = document.getElementById('aiInput');
            const msg = input.value.trim();
            if (!msg) return;

            input.value = '';
            addAIMessage(msg, 'user');
            showTyping();

            try {
                // AI komut isleme - dogal dil komutlarini calistir
                const response = await fetch('/api/ai/komut', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mesaj: msg })
                });
                const data = await response.json();

                hideTyping();

                if (data.cikti) {
                    addAIMessage(data.cikti, 'assistant');
                }
                if (data.hata) {
                    addAIMessage('Hata: ' + data.hata, 'error');
                }
                if (data.harita_guncelle) {
                    await loadData();
                }
                if (data.osint_sonuc) {
                    showOSINTResult(data.osint_sonuc);
                }

                // Terminale de log at
                if (data.komut) {
                    termLog(`[AI] ${data.komut}`, 'info');
                }

            } catch (e) {
                hideTyping();
                addAIMessage('Bağlantı hatası: ' + e.message, 'error');
            }
        }

        function addAIMessage(content, type) {
            const msgs = document.getElementById('aiMessages');
            const msgEl = document.createElement('div');
            msgEl.className = 'ai-msg ' + type;

            // Markdown benzeri format
            let html = content
                .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/\n/g, '<br>');

            msgEl.innerHTML = `<div class="ai-msg-content">${html}</div>`;
            msgs.appendChild(msgEl);
            msgs.scrollTop = msgs.scrollHeight;
        }

        function showTyping() {
            const msgs = document.getElementById('aiMessages');
            const typing = document.createElement('div');
            typing.id = 'typingIndicator';
            typing.className = 'ai-msg assistant';
            typing.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div>';
            msgs.appendChild(typing);
            msgs.scrollTop = msgs.scrollHeight;
        }

        function hideTyping() {
            const typing = document.getElementById('typingIndicator');
            if (typing) typing.remove();
        }

        function showOSINTResult(data) {
            if (data.nodes && data.nodes.length > 0) {
                // Haritada OSINT sonuclarini goster
                data.nodes.forEach(node => {
                    if (node.lat && node.lng) {
                        const color = node.type === 'domain' ? 'var(--hud-cyan)' : node.type === 'ip' ? 'var(--hud-green)' : 'var(--accent-warning)';
                        const m = L.circleMarker([node.lat, node.lng], {
                            radius: 8, fillColor: color, color: '#fff', weight: 2, fillOpacity: 0.8
                        });
                        m.bindPopup(`<strong style="color:${color}">${node.id}</strong><br>Tip: ${node.type}`);
                        layers.atk.addLayer(m);
                    }
                });
                addAIMessage(`✓ ${data.nodes.length} düğüm haritada gösteriliyor`, 'assistant');
            }
        }

        // ==================== AI DESTEKLI TEHDIT ANALIZI ====================

        let sonAIAnalizZamani = 0;
        const AI_ANALIZ_ARALIK = 60000; // 60 saniye

        // AI Tehdit Analizi - Kritik saldirilari LLM ile analiz et
        async function aiTehditAnalizi(data) {
            const simdi = Date.now();
            if (simdi - sonAIAnalizZamani < AI_ANALIZ_ARALIK) {
                return; // Cok sik analiz yapma
            }
            sonAIAnalizZamani = simdi;

            termLog('[AI] Kritik saldiri analiz ediliyor...', 'info');

            try {
                const response = await fetch('/api/llm/analiz', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        veri: {
                            saldiri_tipi: data.saldiri?.tip || 'Bilinmiyor',
                            kaynak_ulke: data.kaynak?.ulke || 'Bilinmiyor',
                            kaynak_ip: data.kaynak?.ip || 'Bilinmiyor',
                            hedef_sehir: data.hedef?.sehir || 'Bilinmiyor',
                            ciddiyet: data.saldiri?.ciddiyet || 'medium',
                            zaman: new Date().toISOString()
                        },
                        tip: 'tehdit'
                    })
                });

                const sonuc = await response.json();
                if (sonuc.basarili && sonuc.sonuc) {
                    aiAnalizGoster(sonuc.sonuc);
                    termLog('[AI] Tehdit analizi tamamlandi', 'ok');
                }
            } catch (e) {
                console.error('[AI] Analiz hatasi:', e);
                termLog('[AI] Analiz basarisiz: ' + e.message, 'err');
            }
        }

        // AI Analiz Sonucunu Goster
        function aiAnalizGoster(analiz) {
            const container = document.getElementById('aiMessages');
            if (!container) return;

            const analizText = typeof analiz === 'object' ? analiz.sonuc || JSON.stringify(analiz) : analiz;

            const msgEl = document.createElement('div');
            msgEl.className = 'ai-msg assistant ai-analysis';
            msgEl.innerHTML = `
                <div class="ai-analysis-header">
                    <span style="color:var(--accent-danger)">⚠</span>
                    <span>LYDIAN AI Tehdit Analizi</span>
                </div>
                <div class="ai-msg-content">${analizText}</div>
                <div class="ai-analysis-time">${new Date().toLocaleTimeString('tr-TR')}</div>
            `;
            container.appendChild(msgEl);
            container.scrollTop = container.scrollHeight;

            // Sesli bildir
            sesliUyariKontrollu('AI tehdit analizi tamamlandı. Detaylar chat panelinde.');
        }

        // Harita Analizi - Guncel durum ozeti
        async function haritaAnaliziYap() {
            termLog('[AI] Harita durumu analiz ediliyor...', 'info');
            showTyping();

            try {
                const response = await fetch('/api/llm/analiz', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        veri: {
                            toplam_saldiri: attackCount,
                            kritik_altyapi_sayisi: typeof KRITIK_ALTYAPI !== 'undefined' ? KRITIK_ALTYAPI.length : 0,
                            wifi_sayisi: layers.wifi ? layers.wifi.getLayers().length : 0,
                            baz_sayisi: layers.baz ? layers.baz.getLayers().length : 0,
                            zaman: new Date().toISOString()
                        },
                        tip: 'harita_ozeti'
                    })
                });

                hideTyping();
                const sonuc = await response.json();
                if (sonuc.basarili && sonuc.sonuc) {
                    addAIMessage(sonuc.sonuc.sonuc || sonuc.sonuc, 'assistant');
                    termLog('[AI] Harita analizi tamamlandi', 'ok');
                } else {
                    addAIMessage('Analiz sirasinda bir hata olustu.', 'assistant');
                }
            } catch (e) {
                hideTyping();
                console.error('[AI] Harita analizi hatasi:', e);
                addAIMessage('AI servisi su an kullanilabilir degil.', 'assistant');
            }
        }

        // IP/Domain OSINT Analizi
        async function osintAnalizi(hedef) {
            termLog(`[AI] OSINT analizi: ${hedef}`, 'info');
            showTyping();

            try {
                const response = await fetch('/api/llm/analiz', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        veri: { hedef: hedef },
                        tip: 'osint'
                    })
                });

                hideTyping();
                const sonuc = await response.json();
                if (sonuc.basarili && sonuc.sonuc) {
                    addAIMessage(`**OSINT: ${hedef}**\n${sonuc.sonuc.sonuc || sonuc.sonuc}`, 'assistant');
                }
            } catch (e) {
                hideTyping();
                console.error('[AI] OSINT hatasi:', e);
            }
        }

        // Voice and speaker controls (placeholder implementations)
        function toggleVoice() {
            const btn = document.getElementById('voiceBtn');
            const indicator = document.getElementById('voiceIndicator');
            btn.classList.toggle('active');
            indicator.classList.toggle('active');
            termLog(btn.classList.contains('active') ? 'Sesli komut dinleniyor...' : 'Sesli komut durduruldu', 'info');
        }

        function toggleSpeaker() {
            const btn = document.getElementById('speakerBtn');
            btn.classList.toggle('active');
            termLog(btn.classList.contains('active') ? 'Sesli yanıt aktif' : 'Sesli yanıt pasif', 'info');
        }

        // AILYDIAN Panel (placeholder implementations)
        function toggleAilydianPanel() {
            const panel = document.getElementById('ailydianPanel');
            const toggle = document.getElementById('ailydianToggle');
            panel.classList.toggle('visible');
            toggle.classList.toggle('active');
        }

        function yenileAjanlar() {
            termLog('Ajanlar yenileniyor...', 'info');
            // API call to refresh agents
        }

        function yeniGorevOlustur() {
            const input = document.getElementById('yeniGorevInput');
            const gorev = input.value.trim();
            if (gorev) {
                termLog('Yeni görev oluşturuluyor: ' + gorev, 'info');
                input.value = '';
                // API call to create task
            }
        }

        function ailydianSorguGonder() {
            const input = document.getElementById('ailydianSorguInput');
            const sorgu = input.value.trim();
            if (sorgu) {
                termLog('AI sorgusu gönderiliyor: ' + sorgu, 'info');
                input.value = '';
                // API call for AI query
            }
        }

        // ==================== MCP ARAC PANELI ====================
        let mcpAraclar = [];
        let mcpSeciliArac = null;

        function mcpPanelAc() {
            document.getElementById('mcpModal').classList.add('active');
            mcpAraclariYukle();
        }

        function mcpPanelKapat() {
            document.getElementById('mcpModal').classList.remove('active');
        }

        async function mcpAraclariYukle(kategori = null) {
            try {
                let url = '/api/mcp/araclar';
                if (kategori) url += `?kategori=${kategori}`;

                const res = await fetch(url);
                const data = await res.json();

                if (data.basarili) {
                    mcpAraclar = data.araclar;
                    mcpAraclariRenderla();
                } else {
                    document.getElementById('mcpTools').innerHTML =
                        '<div style="color:var(--accent-danger);padding:20px;text-align:center">' + (data.hata || 'Yuklenemedi') + '</div>';
                }
            } catch (e) {
                document.getElementById('mcpTools').innerHTML =
                    '<div style="color:var(--accent-danger);padding:20px;text-align:center">Baglanti hatasi</div>';
            }
        }

        function mcpAraclariRenderla() {
            const container = document.getElementById('mcpTools');
            if (mcpAraclar.length === 0) {
                container.innerHTML = '<div style="color:var(--text-dim);padding:20px;text-align:center">Arac bulunamadi</div>';
                return;
            }

            container.innerHTML = mcpAraclar.map(a => `
                <div class="mcp-tool-item ${mcpSeciliArac === a.name ? 'selected' : ''}"
                     onclick="mcpAracSec('${a.name}')">
                    <div class="mcp-tool-name">${a.name}</div>
                    <div class="mcp-tool-desc">${a.description}</div>
                </div>
            `).join('');
        }

        function mcpAracSec(aracAdi) {
            mcpSeciliArac = aracAdi;
            mcpAraclariRenderla();

            // Arac detaylarini goster
            const arac = mcpAraclar.find(a => a.name === aracAdi);
            if (arac) {
                document.getElementById('mcpOutput').innerHTML =
                    `<span class="success">Secili Arac: ${arac.name}</span>\n\n` +
                    `Aciklama: ${arac.description}\n` +
                    `Kategori: ${arac.category}\n` +
                    `Zorunlu Parametreler: ${arac.required_params.join(', ') || 'Yok'}`;
            }
        }

        async function mcpCalistir() {
            if (!mcpSeciliArac) {
                showToast('Lutfen bir arac secin', 'error');
                return;
            }

            const hedef = document.getElementById('mcpHedef').value.trim();
            const paramsStr = document.getElementById('mcpParams').value.trim();

            if (!hedef) {
                showToast('Hedef gerekli', 'error');
                return;
            }

            let params = { target: hedef, domain: hedef, url: hedef };
            if (paramsStr) {
                try {
                    const ekParams = JSON.parse(paramsStr);
                    params = { ...params, ...ekParams };
                } catch (e) {
                    showToast('Gecersiz JSON parametresi', 'error');
                    return;
                }
            }

            const output = document.getElementById('mcpOutput');
            output.innerHTML = '<span class="loading">Calistiriliyor...</span>';

            try {
                const res = await fetch('/api/mcp/calistir', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ arac: mcpSeciliArac, parametreler: params })
                });

                const data = await res.json();

                if (data.basarili) {
                    let cikti = data.cikti || data.sonuc;
                    if (typeof cikti === 'object') {
                        cikti = JSON.stringify(cikti, null, 2);
                    }
                    output.innerHTML = `<span class="success">[${mcpSeciliArac}] Tamamlandi</span>\n\n${cikti}`;
                    showToast('Tarama tamamlandi', 'success');
                } else {
                    output.innerHTML = `<span class="error">Hata: ${data.hata || 'Bilinmeyen hata'}</span>`;
                }
            } catch (e) {
                output.innerHTML = `<span class="error">Baglanti hatasi: ${e.message}</span>`;
            }
        }

        // Kategori butonlari
        document.querySelectorAll('.mcp-cat-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.mcp-cat-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                mcpAraclariYukle(btn.dataset.cat || null);
            });
        });

        // ==================== GNN GRAF GÖRSELLEŞTİRME ====================
        let gnnSimulation = null;
        let gnnSvg = null;
        let gnnData = { nodes: [], links: [] };

        // Düğüm renkleri (backend'den gelen group değerlerine göre)
        const GNN_RENKLER = {
            'ip': '#00e5ff',
            'IP_ADRES': '#00e5ff',
            'domain': '#00ff88',
            'DOMAIN': '#00ff88',
            'malicious': '#ff3355',
            'MALICIOUS_IP': '#ff3355',
            'c2': '#ffaa00',
            'C2_SERVER': '#ffaa00',
            'kullanici': '#8855ff',
            'KULLANICI': '#8855ff',
            'cihaz': '#ffffff',
            'CIHAZ': '#ffffff',
            'sunucu': '#00b4ff',
            'SUNUCU': '#00b4ff',
            'ulke': '#ff9966',
            'port': '#00ffcc',
            'PORT': '#00ffcc'
        };

        // Bağlantı renkleri
        const KENAR_RENKLER = {
            'saldiri': '#ff3355',
            'SALDIRI': '#ff3355',
            'baglanti': '#00b4ff',
            'BAGLANTI': '#00b4ff',
            'dns_sorgu': '#ffaa00',
            'DNS_SORGU': '#ffaa00',
            'veri_akisi': '#00ff88',
            'VERI_AKISI': '#00ff88',
            'dosya_transfer': '#ff00ff',
            'lateral': '#ff6600',
            'LATERAL': '#ff6600'
        };

        function gnnPanelAc() {
            document.getElementById('gnnModal').classList.add('active');
            gnnGrafiBaslat();
            gnnDurumuGuncelle();
        }

        function gnnPanelKapat() {
            document.getElementById('gnnModal').classList.remove('active');
            if (gnnSimulation) gnnSimulation.stop();
        }

        function gnnDurumuGuncelle() {
            document.getElementById('gnnStatus').textContent = 'Yükleniyor...';
            fetch('/api/gnn/durum')
                .then(r => r.json())
                .then(data => {
                    if (data.basarili) {
                        const d = data.durum;
                        document.getElementById('gnnDugumSayisi').textContent = d.dugum_sayisi || 0;
                        document.getElementById('gnnKenarSayisi').textContent = d.kenar_sayisi || 0;
                        document.getElementById('gnnTehditSayisi').textContent = d.tehdit_sayisi || 0;
                        document.getElementById('gnnRiskSkoru').textContent = (d.ortalama_risk || 0).toFixed(2);
                        document.getElementById('gnnStatus').textContent = 'Aktif';
                        document.getElementById('gnnStatus').style.color = 'var(--hud-green)';
                    }
                })
                .catch(e => {
                    document.getElementById('gnnStatus').textContent = 'Bağlantı Hatası';
                    document.getElementById('gnnStatus').style.color = 'var(--accent-danger)';
                });
        }

        function gnnGrafiBaslat() {
            const container = document.querySelector('.gnn-graph-area');
            const width = container.clientWidth;
            const height = container.clientHeight;

            // Mevcut SVG'yi temizle
            d3.select('#gnnSvg').selectAll('*').remove();

            gnnSvg = d3.select('#gnnSvg')
                .attr('width', width)
                .attr('height', height);

            // Zoom özelliği
            const zoom = d3.zoom()
                .scaleExtent([0.1, 4])
                .on('zoom', (event) => {
                    gnnSvg.select('g').attr('transform', event.transform);
                });

            gnnSvg.call(zoom);

            // Ana grup
            gnnSvg.append('g');

            // Graf verisini yükle
            gnnGrafiYenile();
        }

        async function gnnGrafiYenile() {
            document.getElementById('gnnStatus').textContent = 'Graf yükleniyor...';

            try {
                const res = await fetch('/api/gnn/d3');
                const data = await res.json();

                if (data.basarili && data.graf) {
                    gnnData = data.graf;
                    gnnGrafiCiz();
                    gnnDurumuGuncelle();
                    gnnMetrikleriYukle();
                } else {
                    console.warn('[GNN] Graf verisi alınamadı');
                }
            } catch (e) {
                console.error('[GNN] Graf yükleme hatası:', e);
            }
        }

        function gnnGrafiCiz() {
            const container = document.querySelector('.gnn-graph-area');
            const width = container.clientWidth;
            const height = container.clientHeight;

            const g = gnnSvg.select('g');
            g.selectAll('*').remove();

            if (!gnnData.nodes || gnnData.nodes.length === 0) {
                g.append('text')
                    .attr('x', width / 2)
                    .attr('y', height / 2)
                    .attr('text-anchor', 'middle')
                    .attr('fill', 'var(--text-dim)')
                    .text('Graf boş - Tehdit feed topla veya saldırı ekle');
                return;
            }

            // Simülasyon
            gnnSimulation = d3.forceSimulation(gnnData.nodes)
                .force('link', d3.forceLink(gnnData.links).id(d => d.id).distance(80))
                .force('charge', d3.forceManyBody().strength(-200))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(30));

            // Bağlantılar
            const links = g.append('g')
                .selectAll('line')
                .data(gnnData.links)
                .enter()
                .append('line')
                .attr('class', 'gnn-link')
                .attr('stroke', d => KENAR_RENKLER[d.type] || '#00b4ff')
                .attr('stroke-width', d => Math.max(1, (d.weight || 1) * 2))
                .attr('stroke-opacity', 0.6);

            // Düğümler
            const nodes = g.append('g')
                .selectAll('circle')
                .data(gnnData.nodes)
                .enter()
                .append('circle')
                .attr('class', 'gnn-node')
                .attr('r', d => 8 + (d.risk || 0) * 10)
                .attr('fill', d => GNN_RENKLER[d.group] || GNN_RENKLER[d.type] || '#00e5ff')
                .attr('stroke', d => d.risk > 0.7 ? '#ff3355' : 'rgba(255,255,255,0.3)')
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended))
                .on('mouseover', function(event, d) {
                    gnnTooltipGoster(event, d);
                    d3.select(this).attr('stroke-width', 4);
                })
                .on('mouseout', function() {
                    gnnTooltipGizle();
                    d3.select(this).attr('stroke-width', 2);
                })
                .on('click', function(event, d) {
                    gnnDugumDetay(d);
                });

            // Etiketler
            const labels = g.append('g')
                .selectAll('text')
                .data(gnnData.nodes)
                .enter()
                .append('text')
                .attr('class', 'gnn-label')
                .attr('dx', 12)
                .attr('dy', 4)
                .text(d => d.label ? d.label.substring(0, 15) : d.id.substring(0, 15));

            // Simülasyon güncellemesi
            gnnSimulation.on('tick', () => {
                links
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                nodes
                    .attr('cx', d => d.x)
                    .attr('cy', d => d.y);

                labels
                    .attr('x', d => d.x)
                    .attr('y', d => d.y);
            });

            function dragstarted(event, d) {
                if (!event.active) gnnSimulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }

            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }

            function dragended(event, d) {
                if (!event.active) gnnSimulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }
        }

        function gnnTooltipGoster(event, d) {
            const tooltip = document.getElementById('gnnTooltip');
            document.getElementById('gnnTooltipHeader').textContent = d.label || d.id;

            let content = `
                <div class="gnn-tooltip-row">
                    <span class="gnn-tooltip-label">Tip:</span>
                    <span class="gnn-tooltip-value">${d.group || d.type || 'Bilinmiyor'}</span>
                </div>
                <div class="gnn-tooltip-row">
                    <span class="gnn-tooltip-label">Risk:</span>
                    <span class="gnn-tooltip-value" style="color:${d.risk > 0.7 ? 'var(--accent-danger)' : 'var(--hud-green)'}">${((d.risk || 0) * 100).toFixed(0)}%</span>
                </div>
            `;

            if (d.properties) {
                for (const [key, val] of Object.entries(d.properties)) {
                    content += `
                        <div class="gnn-tooltip-row">
                            <span class="gnn-tooltip-label">${key}:</span>
                            <span class="gnn-tooltip-value">${val}</span>
                        </div>
                    `;
                }
            }

            document.getElementById('gnnTooltipContent').innerHTML = content;
            tooltip.style.left = (event.offsetX + 20) + 'px';
            tooltip.style.top = (event.offsetY - 10) + 'px';
            tooltip.classList.add('visible');
        }

        function gnnTooltipGizle() {
            document.getElementById('gnnTooltip').classList.remove('visible');
        }

        function gnnDugumDetay(d) {
            termLog(`[GNN] Düğüm: ${d.label || d.id}, Tip: ${d.group || d.type || 'bilinmiyor'}, Risk: ${((d.risk || 0) * 100).toFixed(0)}%`, 'info');
        }

        async function gnnTehditFeedTopla() {
            document.getElementById('gnnStatus').textContent = 'Tehdit feed toplanıyor...';
            document.getElementById('gnnProgressBar').style.width = '30%';

            try {
                const res = await fetch('/api/gnn/tehdit-feed/topla', { method: 'POST' });
                const data = await res.json();

                document.getElementById('gnnProgressBar').style.width = '100%';

                if (data.basarili) {
                    const s = data.sonuc;
                    termLog(`[GNN] Tehdit feed toplandı: ${s.toplam_ip} IP, ${s.toplam_domain} domain`, 'ok');
                    showToast(`${s.toplam_ip + s.toplam_domain} tehdit göstergesi eklendi`, 'success');
                    gnnGrafiYenile();
                } else {
                    termLog('[GNN] Feed toplama başarısız: ' + data.hata, 'err');
                }

                setTimeout(() => {
                    document.getElementById('gnnProgressBar').style.width = '0%';
                }, 1000);

            } catch (e) {
                termLog('[GNN] Feed hatası: ' + e.message, 'err');
                document.getElementById('gnnProgressBar').style.width = '0%';
            }
        }

        async function gnnEgitimBaslat() {
            const modelTipi = document.getElementById('gnnModelTipi').value;
            const epochs = parseInt(document.getElementById('gnnEpochs').value);
            const ornekSayisi = parseInt(document.getElementById('gnnOrnekSayisi').value);

            document.getElementById('gnnStatus').textContent = 'Eğitim başlatılıyor...';
            document.getElementById('gnnEgitimDurum').textContent = `${modelTipi} modeli eğitiliyor...`;
            document.getElementById('gnnProgressBar').style.width = '10%';

            try {
                const res = await fetch('/api/gnn/egitim/baslat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model_tipi: modelTipi,
                        epochs: epochs,
                        ornek_sayisi: ornekSayisi
                    })
                });

                document.getElementById('gnnProgressBar').style.width = '100%';

                const data = await res.json();

                if (data.basarili) {
                    const s = data.sonuc;
                    document.getElementById('gnnEgitimDurum').innerHTML = `
                        <span style="color:var(--hud-green)">✓ Eğitim Tamamlandı</span><br>
                        Kayıp: ${(s.son_kayip || 0).toFixed(4)}<br>
                        Doğruluk: ${((s.dogruluk || 0) * 100).toFixed(1)}%<br>
                        Süre: ${(s.sure_saniye || 0).toFixed(1)}s
                    `;
                    termLog(`[GNN] ${modelTipi} modeli eğitildi - Doğruluk: ${((s.dogruluk || 0) * 100).toFixed(1)}%`, 'ok');
                    showToast('Model eğitimi tamamlandı', 'success');
                } else {
                    document.getElementById('gnnEgitimDurum').innerHTML = `<span style="color:var(--accent-danger)">Hata: ${data.hata}</span>`;
                    termLog('[GNN] Eğitim hatası: ' + data.hata, 'err');
                }

                setTimeout(() => {
                    document.getElementById('gnnProgressBar').style.width = '0%';
                }, 2000);

            } catch (e) {
                document.getElementById('gnnEgitimDurum').innerHTML = `<span style="color:var(--accent-danger)">Bağlantı hatası</span>`;
                document.getElementById('gnnProgressBar').style.width = '0%';
                termLog('[GNN] Eğitim bağlantı hatası: ' + e.message, 'err');
            }
        }

        async function gnnAnaliz() {
            document.getElementById('gnnStatus').textContent = 'Analiz yapılıyor...';

            try {
                const res = await fetch('/api/gnn/analiz');
                const data = await res.json();

                if (data.basarili) {
                    const a = data.analiz;
                    termLog(`[GNN] Graf Analizi - Düğüm: ${a.dugum_sayisi}, Tehdit: ${a.tehdit_sayisi}, Risk: ${(a.ortalama_risk || 0).toFixed(2)}`, 'ok');
                    showToast('Graf analizi tamamlandı', 'success');
                }
                gnnDurumuGuncelle();
            } catch (e) {
                termLog('[GNN] Analiz hatası: ' + e.message, 'err');
            }
        }

        async function gnnMerkeziDugumler() {
            try {
                const res = await fetch('/api/gnn/merkezi');
                const data = await res.json();

                if (data.basarili && data.merkezi_dugumler) {
                    const dugumler = data.merkezi_dugumler.slice(0, 5);
                    let msg = '[GNN] En Merkezi Düğümler:\n';
                    dugumler.forEach((d, i) => {
                        msg += `  ${i + 1}. ${d.id} (skor: ${d.skor.toFixed(3)})\n`;
                    });
                    termLog(msg, 'info');
                }
            } catch (e) {
                termLog('[GNN] Merkezi düğüm hatası: ' + e.message, 'err');
            }
        }

        async function gnnTopluluklar() {
            try {
                const res = await fetch('/api/gnn/topluluklar');
                const data = await res.json();

                if (data.basarili) {
                    termLog(`[GNN] ${data.topluluk_sayisi} topluluk tespit edildi`, 'info');
                }
            } catch (e) {
                termLog('[GNN] Topluluk hatası: ' + e.message, 'err');
            }
        }

        async function gnnTemizle() {
            if (!confirm('Graf verisi temizlensin mi?')) return;

            try {
                const res = await fetch('/api/gnn/temizle', { method: 'POST' });
                const data = await res.json();

                if (data.basarili) {
                    termLog('[GNN] Graf temizlendi', 'ok');
                    gnnGrafiYenile();
                }
            } catch (e) {
                termLog('[GNN] Temizleme hatası: ' + e.message, 'err');
            }
        }

        async function gnnMetrikleriYukle() {
            try {
                const res = await fetch('/api/gnn/metrikler');
                const data = await res.json();

                if (data.basarili) {
                    const m = data.metrikler;
                    document.getElementById('gnnMetrikler').innerHTML = `
                        <div>Düğüm: ${m.dugum_sayisi || 0}</div>
                        <div>Kenar: ${m.kenar_sayisi || 0}</div>
                        <div>Yoğunluk: ${(m.yogunluk || 0).toFixed(4)}</div>
                        <div>Ort. Derece: ${(m.ortalama_derece || 0).toFixed(2)}</div>
                        <div>Bileşen: ${m.bagli_bilesen_sayisi || 0}</div>
                    `;
                }
            } catch (e) {
                document.getElementById('gnnMetrikler').innerHTML = 'Metrik yüklenemedi';
            }
        }

        // ==================== OSINT PANEL ====================
        let osintMarkers = [];  // Harita üzerindeki OSINT marker'ları

        function osintPanelAc() {
            document.getElementById('osintPanel').classList.add('active');
            osintDurumuKontrolEt();
        }

        function osintPanelKapat() {
            document.getElementById('osintPanel').classList.remove('active');
        }

        function osintTabDegistir(tabEl) {
            // Tab aktifliğini değiştir
            document.querySelectorAll('.osint-tab').forEach(t => t.classList.remove('active'));
            tabEl.classList.add('active');

            // İçeriği göster
            const tabName = tabEl.dataset.tab;
            document.querySelectorAll('.osint-tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById('osintTab' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.add('active');

            // Sonuçları gizle
            document.getElementById('osintResults').style.display = 'none';
        }

        async function osintDurumuKontrolEt() {
            try {
                const res = await fetch('/api/osint/v2/durum');
                const data = await res.json();

                if (data.basarili) {
                    const durum = data.durum;
                    let aktifModul = [];
                    if (durum.moduller.telefon.aktif) aktifModul.push('📱');
                    if (durum.moduller.email.holehe) aktifModul.push('📧');
                    if (durum.moduller.sosyal.sherlock || durum.moduller.sosyal.maigret) aktifModul.push('👤');
                    if (durum.moduller.network.dns) aktifModul.push('🌐');
                    if (durum.moduller.adli.exiftool || durum.moduller.adli.pil) aktifModul.push('📁');

                    document.getElementById('osintStatus').className = 'osint-status success';
                    document.getElementById('osintStatus').innerHTML = `
                        <span>✓</span>
                        <span>OSINT Aktif: ${aktifModul.join(' ')}</span>
                    `;
                } else {
                    document.getElementById('osintStatus').className = 'osint-status error';
                    document.getElementById('osintStatus').innerHTML = '<span>✗</span><span>OSINT Modülü Yüklenemedi</span>';
                }
            } catch (e) {
                document.getElementById('osintStatus').className = 'osint-status error';
                document.getElementById('osintStatus').innerHTML = '<span>✗</span><span>Bağlantı Hatası</span>';
            }
        }

        function osintYukleniyor() {
            document.getElementById('osintStatus').className = 'osint-status loading';
            document.getElementById('osintStatus').innerHTML = '<span>⏳</span><span>Araştırılıyor...</span>';
        }

        function osintSonucGoster(sonuc) {
            const resultsDiv = document.getElementById('osintResults');
            const contentDiv = document.getElementById('osintResultsContent');
            resultsDiv.style.display = 'block';

            if (!sonuc || !sonuc.basarili) {
                contentDiv.innerHTML = `<div style="color:var(--accent-danger)">Hata: ${sonuc?.hata || 'Bilinmeyen hata'}</div>`;
                return;
            }

            // Sonuç tipine göre render et
            contentDiv.innerHTML = osintSonucRenderle(sonuc);
        }

        function osintSonucRenderle(sonuc) {
            let html = '';

            // Konum bilgisi varsa harita butonu ekle
            if (sonuc.konum && sonuc.konum.lat && sonuc.konum.lng) {
                html += `
                    <button class="osint-map-btn" onclick="osintHaritadaGoster(${sonuc.konum.lat}, ${sonuc.konum.lng}, '${sonuc.veri?.hedef || sonuc.hedef || 'OSINT'}')">
                        📍 Haritada Göster
                    </button>
                `;
            }

            // Güven skoru
            if (sonuc.guven !== undefined) {
                const guvenRenk = sonuc.guven > 0.7 ? 'var(--hud-green)' : (sonuc.guven > 0.4 ? 'var(--accent-warning)' : 'var(--accent-danger)');
                html += `<div class="osint-result-item"><span class="label">Güven</span><span class="value" style="color:${guvenRenk}">${(sonuc.guven * 100).toFixed(0)}%</span></div>`;
            }

            // Kaynaklar
            if (sonuc.kaynaklar && sonuc.kaynaklar.length > 0) {
                html += `<div class="osint-result-item"><span class="label">Kaynaklar</span><span class="value">${sonuc.kaynaklar.join(', ')}</span></div>`;
            }

            // Veri tipine göre özel render
            const veri = sonuc.veri || sonuc;

            // Telefon sonuçları
            if (veri.operator) {
                html += `<div class="osint-result-item"><span class="label">Operatör</span><span class="value">${veri.operator}</span></div>`;
            }
            if (veri.ulke) {
                html += `<div class="osint-result-item"><span class="label">Ülke</span><span class="value">${veri.ulke} (${veri.ulke_kodu || ''})</span></div>`;
            }
            if (veri.bolge) {
                html += `<div class="osint-result-item"><span class="label">Bölge</span><span class="value">${veri.bolge}</span></div>`;
            }
            if (veri.numara_tipi) {
                html += `<div class="osint-result-item"><span class="label">Numara Tipi</span><span class="value">${veri.numara_tipi}</span></div>`;
            }
            if (veri.format_uluslararasi) {
                html += `<div class="osint-result-item"><span class="label">Format</span><span class="value">${veri.format_uluslararasi}</span></div>`;
            }

            // Email platformları
            if (veri.platformlar && veri.platformlar.length > 0) {
                html += `<div class="osint-result-item"><span class="label">Bulunan Platformlar</span><div class="value" style="margin-top:5px">`;
                veri.platformlar.forEach(p => {
                    if (p.mevcut) {
                        html += `<span class="osint-platform">${p.ad}</span>`;
                    }
                });
                html += `</div></div>`;
            }

            // Sosyal medya profilleri
            if (sonuc.profiller && sonuc.profiller.length > 0) {
                html += `<div class="osint-result-item"><span class="label">Bulunan Profiller (${sonuc.toplam || sonuc.profiller.length})</span><div class="value" style="margin-top:5px">`;
                sonuc.profiller.filter(p => p.mevcut).slice(0, 20).forEach(p => {
                    html += `<a href="${p.url}" target="_blank" class="osint-platform">${p.ikon || ''} ${p.platform}</a>`;
                });
                html += `</div></div>`;
            }

            // IP sonuçları
            if (veri.konum && typeof veri.konum === 'object') {
                const k = veri.konum;
                if (k.sehir) html += `<div class="osint-result-item"><span class="label">Şehir</span><span class="value">${k.sehir}, ${k.bolge || ''}</span></div>`;
                if (k.ulke) html += `<div class="osint-result-item"><span class="label">Ülke</span><span class="value">${k.ulke}</span></div>`;
                if (k.isp) html += `<div class="osint-result-item"><span class="label">ISP</span><span class="value">${k.isp}</span></div>`;
                if (k.org) html += `<div class="osint-result-item"><span class="label">Organizasyon</span><span class="value">${k.org}</span></div>`;
            }
            if (veri.asn && veri.asn.numara) {
                html += `<div class="osint-result-item"><span class="label">ASN</span><span class="value">AS${veri.asn.numara} - ${veri.asn.aciklama || ''}</span></div>`;
            }

            // Domain DNS
            if (veri.dns) {
                if (veri.dns.A && veri.dns.A.length > 0) {
                    html += `<div class="osint-result-item"><span class="label">A Kayıtları</span><span class="value">${veri.dns.A.join(', ')}</span></div>`;
                }
                if (veri.dns.MX && veri.dns.MX.length > 0) {
                    html += `<div class="osint-result-item"><span class="label">MX Kayıtları</span><span class="value">${veri.dns.MX.slice(0, 3).join(', ')}</span></div>`;
                }
                if (veri.dns.NS && veri.dns.NS.length > 0) {
                    html += `<div class="osint-result-item"><span class="label">NS Kayıtları</span><span class="value">${veri.dns.NS.slice(0, 3).join(', ')}</span></div>`;
                }
            }

            // WHOIS
            if (veri.whois) {
                if (veri.whois.registrar) html += `<div class="osint-result-item"><span class="label">Registrar</span><span class="value">${veri.whois.registrar}</span></div>`;
                if (veri.whois.creation_date) html += `<div class="osint-result-item"><span class="label">Oluşturma</span><span class="value">${veri.whois.creation_date}</span></div>`;
            }

            // Dosya metadata
            if (veri.metadata) {
                const m = veri.metadata;
                if (m.Make || m['EXIF:Make']) html += `<div class="osint-result-item"><span class="label">Cihaz</span><span class="value">${m.Make || m['EXIF:Make']} ${m.Model || m['EXIF:Model'] || ''}</span></div>`;
                if (m.DateTimeOriginal || m['EXIF:DateTimeOriginal']) html += `<div class="osint-result-item"><span class="label">Tarih</span><span class="value">${m.DateTimeOriginal || m['EXIF:DateTimeOriginal']}</span></div>`;
                if (m.Software || m['EXIF:Software']) html += `<div class="osint-result-item"><span class="label">Yazılım</span><span class="value">${m.Software || m['EXIF:Software']}</span></div>`;
            }
            if (veri.hashler) {
                html += `<div class="osint-result-item"><span class="label">SHA256</span><span class="value" style="font-size:9px;word-break:break-all">${veri.hashler.sha256}</span></div>`;
            }
            if (veri.gps) {
                html += `<div class="osint-result-item"><span class="label">GPS</span><span class="value">${veri.gps.lat.toFixed(6)}, ${veri.gps.lng.toFixed(6)}</span></div>`;
                html += `<button class="osint-map-btn" onclick="osintHaritadaGoster(${veri.gps.lat}, ${veri.gps.lng}, 'Dosya GPS')">📍 GPS Konumunu Göster</button>`;
            }

            return html || '<div style="color:var(--text-dim)">Veri bulunamadı</div>';
        }

        function osintHaritadaGoster(lat, lng, baslik) {
            // Haritada konumu göster
            map.flyTo([lat, lng], 10, { animate: true, duration: 1 });

            // Marker ekle
            const marker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'osint-marker',
                    html: `<div style="background:#ff6600;color:white;padding:5px 10px;border-radius:4px;font-size:11px;white-space:nowrap;box-shadow:0 2px 10px rgba(255,102,0,0.5)">🔍 ${baslik}</div>`,
                    iconAnchor: [50, 20]
                })
            }).addTo(map);

            osintMarkers.push(marker);

            // Paneli kapat
            osintPanelKapat();

            // Terminal'e log
            termLog(`[OSINT] Konum haritada işaretlendi: ${baslik} (${lat.toFixed(4)}, ${lng.toFixed(4)})`, 'ok');
            showToast('Konum haritada işaretlendi', 'success');
        }

        async function osintTelefonAra() {
            const telefon = document.getElementById('osintTelefon').value.trim();
            if (!telefon) {
                showToast('Telefon numarası giriniz', 'warning');
                return;
            }

            osintYukleniyor();
            termLog(`[OSINT] Telefon araştırılıyor: ${telefon}`, 'info');

            try {
                const res = await fetch('/api/osint/v2/telefon', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ telefon })
                });
                const data = await res.json();

                osintSonucGoster(data);
                osintDurumuKontrolEt();

                if (data.basarili) {
                    termLog(`[OSINT] Telefon analizi tamamlandı: ${data.veri?.ulke || 'Bilinmiyor'}, ${data.veri?.operator || 'Bilinmiyor'}`, 'ok');
                }
            } catch (e) {
                osintSonucGoster({ basarili: false, hata: e.message });
                osintDurumuKontrolEt();
            }
        }

        async function osintEmailAra() {
            const email = document.getElementById('osintEmail').value.trim();
            if (!email) {
                showToast('E-posta adresi giriniz', 'warning');
                return;
            }

            osintYukleniyor();
            termLog(`[OSINT] E-posta araştırılıyor: ${email}`, 'info');

            try {
                const res = await fetch('/api/osint/v2/email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                const data = await res.json();

                osintSonucGoster(data);
                osintDurumuKontrolEt();

                if (data.basarili) {
                    const platformSayisi = (data.veri?.platformlar || []).filter(p => p.mevcut).length;
                    termLog(`[OSINT] E-posta analizi: ${platformSayisi} platformda bulundu`, 'ok');
                }
            } catch (e) {
                osintSonucGoster({ basarili: false, hata: e.message });
                osintDurumuKontrolEt();
            }
        }

        async function osintKullaniciAra() {
            const kullanici = document.getElementById('osintKullanici').value.trim();
            if (!kullanici) {
                showToast('Kullanıcı adı giriniz', 'warning');
                return;
            }

            const hizli = document.getElementById('osintHizli').checked;

            osintYukleniyor();
            termLog(`[OSINT] Sosyal medya taranıyor: ${kullanici} (${hizli ? 'hızlı' : 'kapsamlı'})`, 'info');

            try {
                const res = await fetch('/api/osint/v2/kullanici', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ kullanici, hizli })
                });
                const data = await res.json();

                osintSonucGoster(data);
                osintDurumuKontrolEt();

                if (data.basarili) {
                    termLog(`[OSINT] Sosyal medya taraması: ${data.toplam || 0} profil bulundu`, 'ok');
                }
            } catch (e) {
                osintSonucGoster({ basarili: false, hata: e.message });
                osintDurumuKontrolEt();
            }
        }

        async function osintIPAra() {
            const ip = document.getElementById('osintIP').value.trim();
            if (!ip) {
                showToast('IP adresi giriniz', 'warning');
                return;
            }

            osintYukleniyor();
            termLog(`[OSINT] IP araştırılıyor: ${ip}`, 'info');

            try {
                const res = await fetch('/api/osint/v2/ip', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ip })
                });
                const data = await res.json();

                osintSonucGoster(data);
                osintDurumuKontrolEt();

                if (data.basarili && data.konum) {
                    termLog(`[OSINT] IP konumu: ${data.veri?.konum?.sehir || 'Bilinmiyor'}, ${data.veri?.konum?.ulke || 'Bilinmiyor'}`, 'ok');
                }
            } catch (e) {
                osintSonucGoster({ basarili: false, hata: e.message });
                osintDurumuKontrolEt();
            }
        }

        async function osintDomainAra() {
            const domain = document.getElementById('osintDomain').value.trim();
            if (!domain) {
                showToast('Domain giriniz', 'warning');
                return;
            }

            osintYukleniyor();
            termLog(`[OSINT] Domain araştırılıyor: ${domain}`, 'info');

            try {
                const res = await fetch('/api/osint/v2/domain', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ domain })
                });
                const data = await res.json();

                osintSonucGoster(data);
                osintDurumuKontrolEt();

                if (data.basarili) {
                    const ipSayisi = data.veri?.ip_adresleri?.length || 0;
                    termLog(`[OSINT] Domain analizi: ${ipSayisi} IP, DNS kayıtları alındı`, 'ok');
                }
            } catch (e) {
                osintSonucGoster({ basarili: false, hata: e.message });
                osintDurumuKontrolEt();
            }
        }

        async function osintDosyaAnaliz() {
            const fileInput = document.getElementById('osintDosya');
            if (!fileInput.files || !fileInput.files[0]) {
                showToast('Dosya seçiniz', 'warning');
                return;
            }

            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);

            osintYukleniyor();
            termLog(`[OSINT] Dosya analiz ediliyor: ${file.name}`, 'info');

            try {
                const res = await fetch('/api/osint/v2/dosya', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();

                osintSonucGoster(data);
                osintDurumuKontrolEt();

                if (data.basarili) {
                    if (data.konum) {
                        termLog(`[OSINT] Dosyada GPS bulundu: ${data.konum.lat.toFixed(4)}, ${data.konum.lng.toFixed(4)}`, 'ok');
                    } else {
                        termLog(`[OSINT] Dosya metadata çıkarıldı (GPS yok)`, 'info');
                    }
                }
            } catch (e) {
                osintSonucGoster({ basarili: false, hata: e.message });
                osintDurumuKontrolEt();
            }
        }

        // OSINT marker'ları temizle
        function osintMarkerTemizle() {
            osintMarkers.forEach(m => map.removeLayer(m));
            osintMarkers = [];
            termLog('[OSINT] Harita marker\'ları temizlendi', 'info');
        }

        // ==================== HAVA SAHASI & UYDU TAKİBİ ====================

        // Layer grupları (lazy init)
        var aircraftLayer = null;
        var satelliteLayer = null;
        var issMarker = null;
        var aircraftInterval = null;
        var issInterval = null;

        function initAerospaceLayers() {
            if (!aircraftLayer && map) {
                aircraftLayer = L.layerGroup().addTo(map);
            }
            if (!satelliteLayer && map) {
                satelliteLayer = L.layerGroup().addTo(map);
            }
        }

        // Aerospace Panel Toggle
        function toggleAerospacePanel() {
            initAerospaceLayers(); // Layer'ları başlat
            const panel = document.getElementById('aerospacePanel');
            const isHidden = !panel.style.display || panel.style.display === 'none';
            panel.style.display = isHidden ? 'block' : 'none';
            if (isHidden) {
                aerospaceStatusUpdate('Takip Sistemi Hazır', '📡');
            }
        }

        // Tab değiştirme
        function aerospaceTabDegistir(el) {
            const tab = el.dataset.tab;
            document.querySelectorAll('#aerospacePanel .osint-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#aerospacePanel .osint-tab-content').forEach(c => c.style.display = 'none');
            el.classList.add('active');
            const contentId = 'aerospaceTab' + tab.charAt(0).toUpperCase() + tab.slice(1);
            const content = document.getElementById(contentId);
            if (content) content.style.display = 'block';
        }

        // Durum güncelleme
        function aerospaceStatusUpdate(msg, icon = '📡') {
            document.getElementById('aerospaceStatus').innerHTML = `<span>${icon}</span><span>${msg}</span>`;
        }

        // ========== HAVA SAHASI TAKİBİ ==========

        async function aircraftTakipBaslat() {
            initAerospaceLayers();
            aerospaceStatusUpdate('Hava sahası taranıyor...', '✈️');
            await aircraftYenile();

            if (document.getElementById('aircraftAutoRefresh').checked) {
                if (aircraftInterval) clearInterval(aircraftInterval);
                aircraftInterval = setInterval(aircraftYenile, 15000);
                termLog('[AEROSPACE] Uçak takibi başlatıldı (15sn aralık)', 'ok');
            }
        }

        function aircraftTakipDurdur() {
            if (aircraftInterval) {
                clearInterval(aircraftInterval);
                aircraftInterval = null;
            }
            if (aircraftLayer) aircraftLayer.clearLayers();
            document.getElementById('aircraftCount').textContent = '0';
            document.getElementById('aircraftTR').textContent = '0';
            document.getElementById('aircraftList').innerHTML = '<div style="color:var(--text-dim);text-align:center;padding:20px">Takip durduruldu</div>';
            aerospaceStatusUpdate('Takip durduruldu', '⏹️');
            termLog('[AEROSPACE] Uçak takibi durduruldu', 'warn');
        }

        async function aircraftYenile() {
            initAerospaceLayers();
            try {
                const bounds = map.getBounds();
                const res = await fetch('/api/airspace/aircraft', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        bounds: {
                            north: bounds.getNorth(),
                            south: bounds.getSouth(),
                            east: bounds.getEast(),
                            west: bounds.getWest()
                        }
                    })
                });

                const data = await res.json();

                if (data.basarili) {
                    if (aircraftLayer) aircraftLayer.clearLayers();

                    // Verileri filtre için sakla
                    allAircraftData = data.ucaklar;

                    let trCount = 0;
                    let listHtml = '';

                    data.ucaklar.forEach(ucak => {
                        // Gerçekçi uçak ikonu (SVG)
                        const altitude = ucak.irtifa || 0;
                        const speed = ucak.hiz || 0;
                        // İrtifaya göre renk: düşük=yeşil, orta=sarı, yüksek=cyan
                        let color = '#00e5ff';
                        if (altitude < 3000) color = '#4caf50';
                        else if (altitude < 8000) color = '#ffeb3b';

                        const aircraftSvg = `
                            <svg viewBox="0 0 24 24" width="28" height="28" style="transform:rotate(${(ucak.yon || 0) - 90}deg);filter:drop-shadow(0 0 3px ${color})">
                                <path fill="${color}" d="M21,16V14L13,9V3.5A1.5,1.5 0 0,0 11.5,2A1.5,1.5 0 0,0 10,3.5V9L2,14V16L10,13.5V19L8,20.5V22L11.5,21L15,22V20.5L13,19V13.5L21,16Z"/>
                            </svg>`;

                        const icon = L.divIcon({
                            className: 'aircraft-marker-real',
                            html: aircraftSvg,
                            iconSize: [28, 28],
                            iconAnchor: [14, 14]
                        });

                        const marker = L.marker([ucak.lat, ucak.lng], {icon}).addTo(aircraftLayer);

                        // Detaylı popup
                        const altitudeFt = Math.round((ucak.irtifa || 0) * 3.281); // metre -> feet
                        const speedKnots = Math.round((ucak.hiz || 0) * 1.944); // m/s -> knots
                        const speedKmh = Math.round((ucak.hiz || 0) * 3.6);
                        const vertRate = ucak.dikey_hiz ? (ucak.dikey_hiz > 0 ? '↑' : '↓') + Math.abs(Math.round(ucak.dikey_hiz * 196.85)) + ' ft/min' : '-';

                        marker.bindPopup(`
                            <div style="font-family:'JetBrains Mono';min-width:240px;background:#0a141e;padding:12px;border-radius:8px;border:1px solid #00e5ff33">
                                <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;border-bottom:1px solid #00e5ff22;padding-bottom:8px">
                                    <svg viewBox="0 0 24 24" width="32" height="32">
                                        <path fill="${color}" d="M21,16V14L13,9V3.5A1.5,1.5 0 0,0 11.5,2A1.5,1.5 0 0,0 10,3.5V9L2,14V16L10,13.5V19L8,20.5V22L11.5,21L15,22V20.5L13,19V13.5L21,16Z"/>
                                    </svg>
                                    <div>
                                        <div style="font-size:16px;font-weight:bold;color:${color}">${ucak.callsign || 'N/A'}</div>
                                        <div style="font-size:10px;color:#607080">${ucak.icao24.toUpperCase()}</div>
                                    </div>
                                </div>
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:11px">
                                    <div style="background:#0d1926;padding:6px;border-radius:4px">
                                        <div style="color:#607080;font-size:9px">İRTİFA</div>
                                        <div style="color:#4caf50;font-weight:bold">${altitudeFt.toLocaleString()} ft</div>
                                        <div style="color:#506070;font-size:9px">${Math.round(ucak.irtifa || 0).toLocaleString()} m</div>
                                    </div>
                                    <div style="background:#0d1926;padding:6px;border-radius:4px">
                                        <div style="color:#607080;font-size:9px">HIZ</div>
                                        <div style="color:#ffeb3b;font-weight:bold">${speedKnots} kts</div>
                                        <div style="color:#506070;font-size:9px">${speedKmh} km/h</div>
                                    </div>
                                    <div style="background:#0d1926;padding:6px;border-radius:4px">
                                        <div style="color:#607080;font-size:9px">YÖN</div>
                                        <div style="color:#00e5ff;font-weight:bold">${Math.round(ucak.yon || 0)}°</div>
                                    </div>
                                    <div style="background:#0d1926;padding:6px;border-radius:4px">
                                        <div style="color:#607080;font-size:9px">DİKEY</div>
                                        <div style="color:#ff9800;font-weight:bold">${vertRate}</div>
                                    </div>
                                </div>
                                <div style="margin-top:8px;padding-top:8px;border-top:1px solid #00e5ff22;font-size:10px;color:#607080">
                                    🌍 ${ucak.ulke} ${ucak.yerde ? '• 🛬 Yerde' : '• ✈️ Uçuşta'}
                                </div>
                            </div>
                        `, {className: 'aircraft-popup'});

                        // Türkiye uçağı mı?
                        if (ucak.ulke && ucak.ulke.toLowerCase().includes('turkey')) trCount++;

                        listHtml += `<div style="padding:6px;border-bottom:1px solid var(--border-subtle);font-size:11px">
                            <span style="color:var(--hud-cyan)">${ucak.callsign || ucak.icao24}</span>
                            <span style="color:var(--text-dim);float:right">${ucak.ulke}</span>
                        </div>`;
                    });

                    document.getElementById('aircraftCount').textContent = data.toplam;
                    document.getElementById('aircraftTR').textContent = trCount;
                    document.getElementById('aircraftList').innerHTML = listHtml || '<div style="text-align:center;color:var(--text-dim);padding:20px">Uçak bulunamadı</div>';
                    aerospaceStatusUpdate(`${data.toplam} uçak takip ediliyor`, '✈️');
                } else {
                    aerospaceStatusUpdate('Veri alınamadı: ' + (data.hata || 'Bilinmeyen hata'), '⚠️');
                }
            } catch (e) {
                aerospaceStatusUpdate('Bağlantı hatası: ' + e.message, '❌');
            }
        }

        // ========== UÇAK ARAMA VE FİLTRELEME ==========

        var allAircraftData = []; // Tüm uçak verilerini sakla

        async function aircraftAra() {
            const query = document.getElementById('aircraftSearchInput').value.trim().toUpperCase();
            if (!query) {
                showToast('Uçuş numarası veya callsign giriniz', 'warning');
                return;
            }

            initAerospaceLayers();
            aerospaceStatusUpdate(`"${query}" aranıyor...`, '🔍');

            try {
                // Önce tüm uçakları al
                const bounds = map.getBounds();
                const res = await fetch('/api/airspace/aircraft', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        bounds: {
                            north: Math.min(bounds.getNorth() + 10, 90),
                            south: Math.max(bounds.getSouth() - 10, -90),
                            east: Math.min(bounds.getEast() + 20, 180),
                            west: Math.max(bounds.getWest() - 20, -180)
                        }
                    })
                });

                const data = await res.json();

                if (data.basarili && data.ucaklar) {
                    // Arama kriterine göre filtrele
                    const results = data.ucaklar.filter(ucak => {
                        const callsign = (ucak.callsign || '').toUpperCase();
                        const icao = (ucak.icao24 || '').toUpperCase();
                        return callsign.includes(query) || icao.includes(query);
                    });

                    if (results.length > 0) {
                        // Haritaya ekle
                        aircraftLayer.clearLayers();
                        results.forEach(ucak => {
                            aircraftMarkerEkle(ucak);
                        });

                        // İlk sonuca odaklan
                        map.setView([results[0].lat, results[0].lng], 8);

                        document.getElementById('aircraftCount').textContent = results.length;
                        aerospaceStatusUpdate(`${results.length} uçak bulundu: "${query}"`, '✈️');
                        showToast(`${results.length} uçak bulundu`, 'success');

                        // Liste güncelle
                        let listHtml = '';
                        results.forEach(ucak => {
                            listHtml += `<div style="padding:6px;border-bottom:1px solid var(--border-subtle);font-size:11px;cursor:pointer" onclick="map.setView([${ucak.lat},${ucak.lng}],10)">
                                <span style="color:#00e5ff;font-weight:bold">${ucak.callsign || ucak.icao24}</span>
                                <span style="color:var(--text-dim);float:right">${ucak.ulke}</span>
                            </div>`;
                        });
                        document.getElementById('aircraftList').innerHTML = listHtml;
                    } else {
                        aerospaceStatusUpdate(`"${query}" için sonuç bulunamadı`, '⚠️');
                        showToast('Uçak bulunamadı', 'warning');
                    }
                }
            } catch (e) {
                aerospaceStatusUpdate('Arama hatası: ' + e.message, '❌');
            }
        }

        function aircraftFiltrele() {
            const country = document.getElementById('aircraftCountryFilter').value;
            if (!country) return;

            if (allAircraftData.length === 0) {
                showToast('Önce takibi başlatın', 'warning');
                return;
            }

            initAerospaceLayers();
            const filtered = allAircraftData.filter(ucak =>
                (ucak.ulke || '').toLowerCase().includes(country.toLowerCase())
            );

            aircraftLayer.clearLayers();
            filtered.forEach(ucak => {
                aircraftMarkerEkle(ucak);
            });

            document.getElementById('aircraftCount').textContent = filtered.length;
            aerospaceStatusUpdate(`${country}: ${filtered.length} uçak`, '🌍');

            // Liste güncelle
            let listHtml = '';
            filtered.forEach(ucak => {
                listHtml += `<div style="padding:6px;border-bottom:1px solid var(--border-subtle);font-size:11px;cursor:pointer" onclick="map.setView([${ucak.lat},${ucak.lng}],10)">
                    <span style="color:#00e5ff">${ucak.callsign || ucak.icao24}</span>
                    <span style="color:var(--text-dim);float:right">${ucak.ulke}</span>
                </div>`;
            });
            document.getElementById('aircraftList').innerHTML = listHtml || '<div style="text-align:center;color:var(--text-dim);padding:20px">Uçak bulunamadı</div>';
        }

        function aircraftFiltreTemizle() {
            document.getElementById('aircraftCountryFilter').value = '';
            document.getElementById('aircraftSearchInput').value = '';
            if (allAircraftData.length > 0) {
                aircraftLayer.clearLayers();
                allAircraftData.forEach(ucak => {
                    aircraftMarkerEkle(ucak);
                });
                document.getElementById('aircraftCount').textContent = allAircraftData.length;
                aerospaceStatusUpdate(`${allAircraftData.length} uçak`, '✈️');
            }
        }

        function aircraftMarkerEkle(ucak) {
            const altitude = ucak.irtifa || 0;
            let color = '#00e5ff';
            if (altitude < 3000) color = '#4caf50';
            else if (altitude < 8000) color = '#ffeb3b';

            const aircraftSvg = `
                <svg viewBox="0 0 24 24" width="28" height="28" style="transform:rotate(${(ucak.yon || 0) - 90}deg);filter:drop-shadow(0 0 3px ${color})">
                    <path fill="${color}" d="M21,16V14L13,9V3.5A1.5,1.5 0 0,0 11.5,2A1.5,1.5 0 0,0 10,3.5V9L2,14V16L10,13.5V19L8,20.5V22L11.5,21L15,22V20.5L13,19V13.5L21,16Z"/>
                </svg>`;

            const icon = L.divIcon({
                className: 'aircraft-marker-real',
                html: aircraftSvg,
                iconSize: [28, 28],
                iconAnchor: [14, 14]
            });

            const marker = L.marker([ucak.lat, ucak.lng], {icon}).addTo(aircraftLayer);

            const altitudeFt = Math.round((ucak.irtifa || 0) * 3.281);
            const speedKnots = Math.round((ucak.hiz || 0) * 1.944);
            const speedKmh = Math.round((ucak.hiz || 0) * 3.6);
            const vertRate = ucak.dikey_hiz ? (ucak.dikey_hiz > 0 ? '+' : '') + Math.round(ucak.dikey_hiz) + ' ft/m' : '0';

            marker.bindPopup(`
                <div style="font-family:'JetBrains Mono',monospace;min-width:200px;background:#0a1520;padding:12px;border-radius:8px;border:1px solid #00e5ff44">
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid #00e5ff22">
                        <div style="font-size:24px;background:#00e5ff22;padding:8px;border-radius:8px">✈️</div>
                        <div>
                            <div style="font-size:16px;font-weight:bold;color:${color}">${ucak.callsign || 'N/A'}</div>
                            <div style="font-size:10px;color:#607080">${ucak.icao24.toUpperCase()}</div>
                        </div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:11px">
                        <div style="background:#0d1926;padding:6px;border-radius:4px">
                            <div style="color:#607080;font-size:9px">İRTİFA</div>
                            <div style="color:#4caf50;font-weight:bold">${altitudeFt.toLocaleString()} ft</div>
                        </div>
                        <div style="background:#0d1926;padding:6px;border-radius:4px">
                            <div style="color:#607080;font-size:9px">HIZ</div>
                            <div style="color:#ffeb3b;font-weight:bold">${speedKnots} kts</div>
                        </div>
                    </div>
                    <div style="margin-top:8px;font-size:10px;color:#607080">🌍 ${ucak.ulke}</div>
                </div>
            `, {className: 'aircraft-popup'});
        }

        // Enter tuşuyla arama
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                const searchInput = document.getElementById('aircraftSearchInput');
                if (searchInput) {
                    searchInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') aircraftAra();
                    });
                }
            }, 1000);
        });

        // ========== ISS TAKİBİ ==========

        async function issKonumGoster() {
            initAerospaceLayers();
            aerospaceStatusUpdate('ISS konumu alınıyor...', '🛸');

            try {
                const res = await fetch('/api/satellite/iss');
                const data = await res.json();

                if (data.basarili && data.iss) {
                    const pos = [data.iss.lat, data.iss.lng];

                    // ISS marker
                    if (issMarker) {
                        issMarker.setLatLng(pos);
                    } else {
                        const icon = L.divIcon({
                            className: 'iss-marker',
                            html: '<div style="font-size:32px;filter:drop-shadow(0 0 10px #00ff88)">🛸</div>',
                            iconSize: [40, 40],
                            iconAnchor: [20, 20]
                        });
                        issMarker = L.marker(pos, {icon}).addTo(satelliteLayer);
                    }

                    issMarker.bindPopup(`
                        <div style="font-family:'JetBrains Mono';min-width:220px">
                            <div style="font-size:16px;font-weight:bold;color:#00ff88;margin-bottom:10px">
                                🛸 ISS - Uluslararası Uzay İstasyonu
                            </div>
                            <div style="font-size:11px;line-height:1.6">
                                <div>📍 Enlem: ${data.iss.lat.toFixed(4)}</div>
                                <div>📍 Boylam: ${data.iss.lng.toFixed(4)}</div>
                                <div>👨‍🚀 Astronot: ${data.astronotlar?.length || 0} kişi</div>
                            </div>
                        </div>
                    `).openPopup();

                    map.setView(pos, 4);

                    document.getElementById('issLat').textContent = data.iss.lat.toFixed(4);
                    document.getElementById('issLng').textContent = data.iss.lng.toFixed(4);

                    // Astronot listesi
                    if (data.astronotlar && data.astronotlar.length > 0) {
                        let astroHtml = data.astronotlar.map(a =>
                            `<div style="padding:3px 0">👨‍🚀 ${a.name} <span style="color:var(--text-dim)">(${a.craft})</span></div>`
                        ).join('');
                        document.getElementById('astronautList').innerHTML = astroHtml;
                    }

                    aerospaceStatusUpdate('ISS konumu güncellendi', '🛸');
                    termLog(`[AEROSPACE] ISS: ${data.iss.lat.toFixed(2)}, ${data.iss.lng.toFixed(2)}`, 'ok');

                    // Otomatik güncelleme
                    if (!issInterval) {
                        issInterval = setInterval(async () => {
                            try {
                                const r = await fetch('/api/satellite/iss');
                                const d = await r.json();
                                if (d.basarili && d.iss && issMarker) {
                                    issMarker.setLatLng([d.iss.lat, d.iss.lng]);
                                    document.getElementById('issLat').textContent = d.iss.lat.toFixed(4);
                                    document.getElementById('issLng').textContent = d.iss.lng.toFixed(4);
                                }
                            } catch(e) {}
                        }, 5000);
                    }
                } else {
                    aerospaceStatusUpdate('ISS verisi alınamadı', '⚠️');
                }
            } catch (e) {
                aerospaceStatusUpdate('Bağlantı hatası: ' + e.message, '❌');
            }
        }

        // ========== UYDU TAKİBİ ==========

        async function uyduAra() {
            initAerospaceLayers();
            const noradId = document.getElementById('noradId').value.trim();
            if (!noradId) {
                aerospaceStatusUpdate('NORAD ID girin', '⚠️');
                return;
            }

            aerospaceStatusUpdate('Uydu aranıyor...', '🛰️');

            try {
                const res = await fetch(`/api/satellite/position/${noradId}`);
                const data = await res.json();

                document.getElementById('satelliteResults').style.display = 'block';

                if (data.basarili && data.uydu) {
                    const sat = data.uydu;

                    // Marker ekle
                    const icon = L.divIcon({
                        className: 'satellite-marker',
                        html: '<div style="font-size:24px;filter:drop-shadow(0 0 8px #ff9800)">🛰️</div>',
                        iconSize: [30, 30],
                        iconAnchor: [15, 15]
                    });

                    const marker = L.marker([sat.lat, sat.lng], {icon}).addTo(satelliteLayer);
                    marker.bindPopup(`
                        <div style="font-family:'JetBrains Mono'">
                            <div style="font-size:14px;font-weight:bold;color:#ff9800">🛰️ ${sat.ad}</div>
                            <div style="font-size:11px;margin-top:8px">
                                <div>NORAD: ${sat.norad_id}</div>
                                <div>İrtifa: ${sat.irtifa?.toFixed(1) || '-'} km</div>
                            </div>
                        </div>
                    `).openPopup();

                    map.setView([sat.lat, sat.lng], 4);

                    document.getElementById('satelliteResultsContent').innerHTML = `
                        <div style="background:var(--bg-card);padding:12px;border-radius:6px">
                            <div style="font-size:14px;color:var(--hud-amber);margin-bottom:8px">🛰️ ${sat.ad}</div>
                            <div style="font-size:11px;color:var(--text-normal)">
                                <div>NORAD ID: ${sat.norad_id}</div>
                                <div>Enlem: ${sat.lat?.toFixed(4) || '-'}</div>
                                <div>Boylam: ${sat.lng?.toFixed(4) || '-'}</div>
                                <div>İrtifa: ${sat.irtifa?.toFixed(1) || '-'} km</div>
                            </div>
                        </div>
                    `;

                    aerospaceStatusUpdate(`${sat.ad} bulundu`, '🛰️');
                    termLog(`[AEROSPACE] Uydu: ${sat.ad} (${sat.norad_id})`, 'ok');
                } else {
                    document.getElementById('satelliteResultsContent').innerHTML = `
                        <div style="color:var(--accent-danger);text-align:center;padding:15px">
                            ⚠️ ${data.hata || 'Uydu bulunamadı'}
                        </div>
                    `;
                    aerospaceStatusUpdate('Uydu bulunamadı', '⚠️');
                }
            } catch (e) {
                aerospaceStatusUpdate('Hata: ' + e.message, '❌');
            }
        }

        async function turksatGoster() {
            initAerospaceLayers();
            aerospaceStatusUpdate('TÜRKSAT uyduları yükleniyor...', '🇹🇷');

            try {
                const res = await fetch('/api/satellite/turksat');
                const data = await res.json();

                if (data.basarili && data.uydular && data.uydular.length > 0) {
                    const bounds = [];

                    data.uydular.forEach(sat => {
                        const icon = L.divIcon({
                            className: 'turksat-marker',
                            html: `<div style="font-size:28px;filter:drop-shadow(0 0 10px #c62828);cursor:pointer">🛰️</div>`,
                            iconSize: [36, 36],
                            iconAnchor: [18, 18]
                        });

                        const marker = L.marker([sat.lat, sat.lng], {icon}).addTo(satelliteLayer);
                        marker.bindPopup(`
                            <div style="font-family:'JetBrains Mono';min-width:200px;background:#0a1520;padding:12px;border-radius:8px;border:1px solid #c6282844">
                                <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
                                    <span style="font-size:24px">🇹🇷</span>
                                    <div>
                                        <div style="font-size:14px;font-weight:bold;color:#c62828">${sat.ad}</div>
                                        <div style="font-size:10px;color:#607080">NORAD: ${sat.norad_id}</div>
                                    </div>
                                </div>
                                <div style="background:#0d1926;padding:8px;border-radius:6px;font-size:11px">
                                    <div>İrtifa: <span style="color:#4caf50">${sat.irtifa?.toFixed(0) || '-'} km</span></div>
                                    <div>Konum: <span style="color:#00e5ff">${sat.lat?.toFixed(2)}°, ${sat.lng?.toFixed(2)}°</span></div>
                                    <div style="margin-top:6px;font-size:10px;color:#888">Jeostatik yörünge (Ekvator üzeri)</div>
                                </div>
                            </div>
                        `);
                        marker.bindTooltip(`🇹🇷 ${sat.ad}`, {direction: 'top', offset: [0, -15]});

                        bounds.push([sat.lat, sat.lng]);
                    });

                    // Türkiye ve uyduları kapsayan görünüm
                    // TURKSAT'lar ekvator üzerinde (lat ~0), Türkiye lat ~39
                    bounds.push([39.0, 35.0]); // Türkiye merkezi de ekle
                    map.fitBounds(bounds, {padding: [30, 30], maxZoom: 4});

                    aerospaceStatusUpdate(`${data.uydular.length} TÜRKSAT uydusu gösteriliyor`, '🇹🇷');
                    termLog(`[AEROSPACE] ${data.uydular.length} TÜRKSAT uydusu yüklendi`, 'ok');
                    showToast(`${data.uydular.length} TÜRKSAT uydusu haritada`, 'success');
                } else {
                    aerospaceStatusUpdate('TÜRKSAT verisi alınamadı: ' + (data.hata || ''), '⚠️');
                }
            } catch (e) {
                aerospaceStatusUpdate('Hata: ' + e.message, '❌');
            }
        }

        async function starlinkGoster() {
            initAerospaceLayers();
            aerospaceStatusUpdate('Starlink uyduları yükleniyor...', '⭐');

            try {
                const center = map.getCenter();
                const res = await fetch('/api/satellite/starlink', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({lat: center.lat, lng: center.lng})
                });

                const data = await res.json();

                if (data.basarili && data.uydular && data.uydular.length > 0) {
                    // Önce mevcut Starlink markerlarını temizle
                    satelliteLayer.eachLayer(layer => {
                        if (layer._icon && layer._icon.classList.contains('starlink-marker')) {
                            satelliteLayer.removeLayer(layer);
                        }
                    });

                    const bounds = [];

                    data.uydular.forEach(sat => {
                        const icon = L.divIcon({
                            className: 'starlink-marker',
                            html: `<div style="font-size:18px;filter:drop-shadow(0 0 6px #ffd700);cursor:pointer">⭐</div>`,
                            iconSize: [24, 24],
                            iconAnchor: [12, 12]
                        });

                        const marker = L.marker([sat.lat, sat.lng], {icon}).addTo(satelliteLayer);
                        marker.bindPopup(`
                            <div style="font-family:'JetBrains Mono';min-width:180px;background:#0a1520;padding:10px;border-radius:6px;border:1px solid #ffd70044">
                                <div style="font-size:14px;font-weight:bold;color:#ffd700">⭐ ${sat.ad}</div>
                                <div style="margin-top:8px;font-size:11px">
                                    <div>NORAD: ${sat.norad_id}</div>
                                    <div>İrtifa: ${sat.irtifa?.toFixed(0) || '-'} km</div>
                                    <div>Konum: ${sat.lat?.toFixed(2)}°, ${sat.lng?.toFixed(2)}°</div>
                                </div>
                            </div>
                        `);
                        marker.bindTooltip(sat.ad, {direction: 'top', offset: [0, -10]});

                        bounds.push([sat.lat, sat.lng]);
                    });

                    // Haritayı tüm uyduları gösterecek şekilde ayarla
                    if (bounds.length > 0) {
                        map.fitBounds(bounds, {padding: [50, 50], maxZoom: 4});
                    }

                    aerospaceStatusUpdate(`${data.uydular.length} uydu gösteriliyor`, '⭐');
                    termLog(`[AEROSPACE] ${data.uydular.length} uydu yüklendi`, 'ok');
                    showToast(`${data.uydular.length} uydu haritada gösteriliyor`, 'success');
                } else {
                    aerospaceStatusUpdate('Uydu bulunamadı: ' + (data.hata || 'N2YO API key kontrol edin'), '⚠️');
                }
            } catch (e) {
                aerospaceStatusUpdate('Hata: ' + e.message, '❌');
            }
        }

        // ========== DEPREM TAKİBİ ==========

        var depremLayer = null;
        var fayLayer = null;
        var depremInterval = null;
        var allDepremData = [];

        function initDepremLayers() {
            if (!depremLayer && map) {
                depremLayer = L.layerGroup().addTo(map);
            }
            if (!fayLayer && map) {
                fayLayer = L.layerGroup().addTo(map);
            }
        }

        async function depremTakipBaslat() {
            initDepremLayers();
            aerospaceStatusUpdate('Depremler yükleniyor...', '🌍');
            await depremYukle();

            if (document.getElementById('depremAutoRefresh').checked) {
                if (depremInterval) clearInterval(depremInterval);
                depremInterval = setInterval(depremYukle, 60000);
                termLog('[DEPREM] Deprem takibi başlatıldı (60sn aralık)', 'ok');
            }

            // Türkiye'ye odaklan
            map.setView([39.0, 35.0], 6);
        }

        async function depremYukle() {
            initDepremLayers();
            const minMag = parseFloat(document.getElementById('depremMinMag')?.value || 0);

            try {
                const res = await fetch(`/api/deprem/son?limit=100&min=${minMag}`);
                const data = await res.json();

                if (data.basarili && data.depremler) {
                    depremLayer.clearLayers();
                    allDepremData = data.depremler;

                    let maxMag = 0;
                    let listHtml = '';

                    data.depremler.forEach(deprem => {
                        // Büyüklüğe göre stil
                        const mag = deprem.buyukluk;
                        let size = 12;
                        let color = '#4caf50';
                        let pulse = false;

                        if (mag >= 5.0) {
                            size = 28; color = '#d32f2f'; pulse = true;
                        } else if (mag >= 4.0) {
                            size = 22; color = '#ff5722'; pulse = true;
                        } else if (mag >= 3.0) {
                            size = 18; color = '#ff9800';
                        } else if (mag >= 2.0) {
                            size = 14; color = '#ffc107';
                        }

                        if (mag > maxMag) maxMag = mag;

                        // Marker
                        const icon = L.divIcon({
                            className: 'earthquake-marker' + (pulse ? ' pulse' : ''),
                            html: `<div style="width:${size}px;height:${size}px;background:${color};border-radius:50%;border:2px solid #fff;box-shadow:0 0 ${pulse ? 15 : 5}px ${color};display:flex;align-items:center;justify-content:center;font-size:${size/2}px;color:#fff;font-weight:bold">${mag >= 3 ? mag.toFixed(1) : ''}</div>`,
                            iconSize: [size, size],
                            iconAnchor: [size/2, size/2]
                        });

                        const marker = L.marker([deprem.enlem, deprem.boylam], {icon}).addTo(depremLayer);

                        // Detaylı popup
                        marker.bindPopup(`
                            <div style="font-family:'JetBrains Mono',monospace;min-width:220px;background:#0a1520;padding:12px;border-radius:8px;border:1px solid ${color}44">
                                <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid ${color}22">
                                    <div style="font-size:28px;background:${color}22;padding:8px;border-radius:8px;color:${color}">🌍</div>
                                    <div>
                                        <div style="font-size:18px;font-weight:bold;color:${color}">M ${mag.toFixed(1)}</div>
                                        <div style="font-size:10px;color:#607080">${deprem.tarih} ${deprem.saat}</div>
                                    </div>
                                </div>
                                <div style="margin-bottom:8px">
                                    <div style="font-size:13px;color:#fff;font-weight:bold">${deprem.yer}</div>
                                    <div style="font-size:11px;color:#607080">${deprem.il} / ${deprem.ilce}</div>
                                </div>
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:11px">
                                    <div style="background:#0d1926;padding:6px;border-radius:4px">
                                        <div style="color:#607080;font-size:9px">DERİNLİK</div>
                                        <div style="color:#00e5ff;font-weight:bold">${deprem.derinlik.toFixed(1)} km</div>
                                    </div>
                                    <div style="background:#0d1926;padding:6px;border-radius:4px">
                                        <div style="color:#607080;font-size:9px">KOORDİNAT</div>
                                        <div style="color:#4caf50;font-weight:bold">${deprem.enlem.toFixed(4)}°</div>
                                        <div style="color:#4caf50;font-size:9px">${deprem.boylam.toFixed(4)}°</div>
                                    </div>
                                </div>
                                <div style="margin-top:8px;padding-top:8px;border-top:1px solid ${color}22;font-size:10px;color:#607080">
                                    📡 Kaynak: ${deprem.kaynak}
                                </div>
                            </div>
                        `, {className: 'earthquake-popup'});

                        // Hover için tooltip
                        marker.bindTooltip(`
                            <div style="font-weight:bold;color:${color}">M ${mag.toFixed(1)}</div>
                            <div style="font-size:10px">${deprem.il} - ${deprem.saat}</div>
                        `, {direction: 'top', offset: [0, -10]});

                        // Liste
                        listHtml += `<div style="padding:8px;border-bottom:1px solid var(--border-subtle);cursor:pointer;transition:background 0.2s" onclick="map.setView([${deprem.enlem},${deprem.boylam}],10)" onmouseover="this.style.background='rgba(255,87,34,0.1)'" onmouseout="this.style.background='transparent'">
                            <div style="display:flex;justify-content:space-between;align-items:center">
                                <span style="font-size:14px;font-weight:bold;color:${color}">M ${mag.toFixed(1)}</span>
                                <span style="font-size:10px;color:var(--text-dim)">${deprem.saat}</span>
                            </div>
                            <div style="font-size:11px;color:var(--text-normal)">${deprem.yer}</div>
                            <div style="font-size:10px;color:var(--text-dim)">${deprem.derinlik.toFixed(1)} km derinlik</div>
                        </div>`;
                    });

                    // Stats güncelle
                    document.getElementById('depremCount').textContent = data.depremler.length;
                    document.getElementById('depremMax').textContent = maxMag > 0 ? 'M' + maxMag.toFixed(1) : '-';

                    if (data.depremler.length > 0) {
                        const son = data.depremler[0];
                        document.getElementById('depremSon').textContent = son.saat.substring(0, 5);
                    }

                    document.getElementById('depremList').innerHTML = listHtml || '<div style="text-align:center;color:var(--text-dim);padding:20px">Deprem bulunamadı</div>';
                    aerospaceStatusUpdate(`${data.depremler.length} deprem gösteriliyor`, '🌍');

                    // Büyük deprem bildirimi
                    const buyukDeprem = data.depremler.find(d => d.buyukluk >= 4.0);
                    if (buyukDeprem) {
                        showToast(`🌍 M${buyukDeprem.buyukluk.toFixed(1)} deprem: ${buyukDeprem.yer}`, 'warning');
                    }
                }
            } catch (e) {
                aerospaceStatusUpdate('Deprem verisi alınamadı: ' + e.message, '❌');
            }
        }

        function depremFiltrele() {
            depremYukle();
        }

        async function fayHatlariGoster() {
            initDepremLayers();
            aerospaceStatusUpdate('Fay hatları yükleniyor...', '🔴');

            try {
                const res = await fetch('/api/deprem/faylar');
                const data = await res.json();

                if (data.basarili && data.faylar) {
                    fayLayer.clearLayers();

                    // Fay hatlarını çiz
                    const fayStyle = {
                        'Çok Yüksek': {color: '#d32f2f', weight: 4, dashArray: null},
                        'Yüksek': {color: '#ff5722', weight: 3, dashArray: '10,5'},
                        'Orta': {color: '#ff9800', weight: 2, dashArray: '5,5'}
                    };

                    L.geoJSON(data.faylar, {
                        style: function(feature) {
                            const risk = feature.properties.risk || 'Orta';
                            return {
                                color: fayStyle[risk]?.color || '#ff9800',
                                weight: fayStyle[risk]?.weight || 2,
                                dashArray: fayStyle[risk]?.dashArray,
                                opacity: 0.8
                            };
                        },
                        onEachFeature: function(feature, layer) {
                            const props = feature.properties;
                            layer.bindPopup(`
                                <div style="font-family:'JetBrains Mono';padding:8px">
                                    <div style="font-size:14px;font-weight:bold;color:#d32f2f">${props.name}</div>
                                    <div style="margin-top:8px;font-size:11px">
                                        <div>Risk: <span style="color:${fayStyle[props.risk]?.color || '#ff9800'}">${props.risk}</span></div>
                                        <div>Uzunluk: ${props.length_km} km</div>
                                    </div>
                                </div>
                            `);
                            layer.bindTooltip(props.name, {permanent: false, direction: 'top'});
                        }
                    }).addTo(fayLayer);

                    aerospaceStatusUpdate(`${data.faylar.features.length} fay hattı gösteriliyor`, '🔴');
                    termLog('[DEPREM] Fay hatları yüklendi', 'ok');

                    // Türkiye'ye odaklan
                    map.setView([39.0, 35.0], 6);
                }
            } catch (e) {
                aerospaceStatusUpdate('Fay hatları yüklenemedi: ' + e.message, '❌');
            }
        }

        // Deprem bildirimi için periyodik kontrol
        async function depremBildirimKontrol() {
            try {
                const res = await fetch('/api/deprem/bildirim');
                const data = await res.json();

                if (data.basarili && data.yeni_deprem && data.deprem) {
                    const d = data.deprem;
                    if (d.buyukluk >= 3.0) {
                        showToast(`🌍 YENİ DEPREM! M${d.buyukluk.toFixed(1)} - ${d.yer}`, 'danger');
                        termLog(`[DEPREM] Yeni deprem: M${d.buyukluk.toFixed(1)} - ${d.yer}`, 'warn');

                        // Büyük deprem ise sesli uyarı
                        if (d.buyukluk >= 4.0) {
                            sesliUyariKontrollu(`Dikkat! ${d.buyukluk.toFixed(1)} büyüklüğünde deprem. ${d.il}`);
                        }
                    }
                }
            } catch (e) {
                // Sessiz hata
            }
        }

        // Her 30 saniyede bir deprem bildirimi kontrolü
        setInterval(depremBildirimKontrol, 30000);

        // ========== HAVA DURUMU (GEO ANALİZ İÇİN) ==========

        async function havaDurumuGoster(lat, lng, il = '') {
            try {
                const res = await fetch('/api/hava/koordinat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({lat, lng})
                });

                const data = await res.json();

                if (data.basarili && data.hava) {
                    const h = data.hava;
                    const g = h.guncel;

                    return `
                        <div style="margin-top:12px;padding:12px;background:linear-gradient(135deg,#1a237e22,#0d47a122);border-radius:8px;border:1px solid #1a237e44">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
                                <span style="font-size:32px">${g.emoji}</span>
                                <div>
                                    <div style="font-size:24px;font-weight:bold;color:#fff">${g.sicaklik?.toFixed(1) || '-'}°C</div>
                                    <div style="font-size:11px;color:#90caf9">${g.durum}</div>
                                </div>
                            </div>
                            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;font-size:10px">
                                <div style="background:#0d1926;padding:6px;border-radius:4px;text-align:center">
                                    <div style="color:#607080">Hissedilen</div>
                                    <div style="color:#ffeb3b">${g.hissedilen?.toFixed(1) || '-'}°C</div>
                                </div>
                                <div style="background:#0d1926;padding:6px;border-radius:4px;text-align:center">
                                    <div style="color:#607080">Nem</div>
                                    <div style="color:#4fc3f7">${g.nem || '-'}%</div>
                                </div>
                                <div style="background:#0d1926;padding:6px;border-radius:4px;text-align:center">
                                    <div style="color:#607080">Rüzgar</div>
                                    <div style="color:#81c784">${g.ruzgar_hiz?.toFixed(0) || '-'} km/h</div>
                                </div>
                            </div>
                            ${h.gunluk && h.gunluk.length > 1 ? `
                                <div style="margin-top:10px;padding-top:10px;border-top:1px solid #1a237e44">
                                    <div style="font-size:10px;color:#607080;margin-bottom:6px">3 Günlük Tahmin</div>
                                    <div style="display:flex;gap:8px">
                                        ${h.gunluk.slice(0,3).map(d => `
                                            <div style="flex:1;background:#0d1926;padding:6px;border-radius:4px;text-align:center;font-size:9px">
                                                <div style="font-size:16px">${d.emoji}</div>
                                                <div style="color:#4fc3f7">${d.max?.toFixed(0)}°/${d.min?.toFixed(0)}°</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
            } catch (e) {
                console.error('[HAVA] Hata:', e);
            }
            return '';
        }

        // Geo analiz popup'a hava durumu ekle
        async function geoPopupHavaDurumuEkle(popupContent, lat, lng) {
            const havaHtml = await havaDurumuGoster(lat, lng);
            return popupContent + havaHtml;
        }

        // ==================== DİJİTAL SAAT ====================
        function updateDigitalClock() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const clockEl = document.getElementById('digitalClock');
            if (clockEl) {
                clockEl.textContent = `${hours}:${minutes}:${seconds}`;
            }
        }
        // Saati başlat
        updateDigitalClock();
        setInterval(updateDigitalClock, 1000);

        // ==================== YENİ POPUP PANEL FONKSİYONLARI ====================

        // AILYDIAN Popup Fonksiyonları
        function ailydianPopupAc() {
            document.getElementById('ailydianPopup').classList.add('active');
            ailydianAgentleriYukle();
        }

        function ailydianPopupKapat() {
            document.getElementById('ailydianPopup').classList.remove('active');
        }

        function ailydianTabDegistir(tab) {
            document.querySelectorAll('#ailydianPopup .cockpit-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#ailydianPopup .cockpit-tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('ailydianTab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
        }

        async function ailydianAgentleriYukle() {
            try {
                const res = await fetch('/api/ailydian/v2/agents');
                const data = await res.json();
                const grid = document.getElementById('ailydianAgentGrid');

                if (data.basarili && data.agents) {
                    grid.innerHTML = data.agents.map(a => `
                        <div class="agent-card" onclick="ailydianAgentSecildi('${a.id}', '${a.name}', '${a.type}')">
                            <div class="agent-icon">${getAgentIcon(a.type)}</div>
                            <div class="agent-name">${a.name}</div>
                            <div class="agent-type">${a.category}</div>
                            <div class="agent-status">● ${a.status}</div>
                        </div>
                    `).join('');
                } else {
                    grid.innerHTML = '<div style="text-align:center;color:var(--text-dim);grid-column:span 2">Agent yüklenemedi</div>';
                }
            } catch (e) {
                console.error('[AILYDIAN] Agent yükleme hatası:', e);
            }
        }

        function getAgentIcon(type) {
            const icons = {
                'security': '<svg width="24" height="24" viewBox="0 0 24 24" fill="var(--hud-green)"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM12 17c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg>',
                'intelligence': '<svg width="24" height="24" viewBox="0 0 24 24" fill="var(--hud-cyan)"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>',
                'research': '<svg width="24" height="24" viewBox="0 0 24 24" fill="var(--accent-primary)"><path d="M12 11.55C9.64 9.35 6.48 8 3 8v11c3.48 0 6.64 1.35 9 3.55 2.36-2.19 5.52-3.55 9-3.55V8c-3.48 0-6.64 1.35-9 3.55zM12 8c1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3 1.34 3 3 3z"/></svg>',
                'automation': '<svg width="24" height="24" viewBox="0 0 24 24" fill="var(--accent-purple)"><path d="M20 2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM9 18H7v-6h2v6zm4 0h-2V8h2v10zm4 0h-2v-4h2v4z"/></svg>',
                'design': '<svg width="24" height="24" viewBox="0 0 24 24" fill="var(--hud-amber)"><path d="M12 7V3H2v18h20V7H12zM6 19H4v-2h2v2zm0-4H4v-2h2v2zm0-4H4V9h2v2zm0-4H4V5h2v2zm4 12H8v-2h2v2zm0-4H8v-2h2v2zm0-4H8V9h2v2zm0-4H8V5h2v2zm10 12h-8v-2h2v-2h-2v-2h2v-2h-2V9h8v10z"/></svg>',
                'debate': '<svg width="24" height="24" viewBox="0 0 24 24" fill="var(--accent-warning)"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>',
                'analysis': '<svg width="24" height="24" viewBox="0 0 24 24" fill="var(--hud-cyan)"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg>'
            };
            return icons[type] || '<svg width="24" height="24" viewBox="0 0 24 24" fill="var(--text-normal)"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/><circle cx="8" cy="10" r="1.5"/><circle cx="16" cy="10" r="1.5"/><path d="M12 17.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/></svg>';
        }

        // Seçili agent bilgisi
        let selectedAgent = null;

        function ailydianAgentSecildi(agentId, agentName, agentType) {
            // Agent bilgilerini sakla
            selectedAgent = {
                id: agentId,
                name: agentName || agentId,
                type: agentType || 'agent'
            };

            // Seçili agent göstergesini güncelle
            const infoDiv = document.getElementById('selectedAgentInfo');
            const iconDiv = document.getElementById('selectedAgentIcon');
            const nameDiv = document.getElementById('selectedAgentName');
            const typeDiv = document.getElementById('selectedAgentType');

            if (infoDiv) {
                infoDiv.style.display = 'block';
                iconDiv.innerHTML = getAgentIcon(agentType);
                nameDiv.textContent = selectedAgent.name;
                typeDiv.textContent = selectedAgent.type.toUpperCase() + ' Agent';
            }

            // Query tab'a geç
            document.querySelectorAll('#ailydianPopup .cockpit-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#ailydianPopup .cockpit-tab-content').forEach(c => c.classList.remove('active'));

            // Query tab'ı aktif et
            const queryTab = document.querySelector('#ailydianPopup .cockpit-tab:nth-child(2)');
            const queryContent = document.getElementById('ailydianTabQuery');
            if (queryTab) queryTab.classList.add('active');
            if (queryContent) queryContent.classList.add('active');

            // Input'a focus
            const input = document.getElementById('ailydianQueryInput');
            if (input) {
                input.placeholder = `${selectedAgent.name} agent'ına görev verin...`;
                input.focus();
            }

            console.log('[AILYDIAN] Agent seçildi:', selectedAgent);
        }

        function clearSelectedAgent() {
            selectedAgent = null;
            const infoDiv = document.getElementById('selectedAgentInfo');
            if (infoDiv) infoDiv.style.display = 'none';

            const input = document.getElementById('ailydianQueryInput');
            if (input) input.placeholder = 'Agent\'a görev verin veya soru sorun...';
        }

        async function ailydianSorgula() {
            const query = document.getElementById('ailydianQueryInput').value;
            if (!query) return;

            const resultDiv = document.getElementById('ailydianQueryResult');
            resultDiv.style.display = 'block';

            // Seçili agent varsa onunla çalıştır
            if (selectedAgent) {
                resultDiv.innerHTML = `<span style="color:var(--hud-green)"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="vertical-align:middle;margin-right:4px;animation:spin 1s linear infinite"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/></svg> ${selectedAgent.name} çalıştırılıyor...</span>`;
            } else {
                resultDiv.innerHTML = '<span style="color:var(--text-dim)">İşleniyor...</span>';
            }

            try {
                // Seçili agent varsa execute endpoint'ini kullan
                const endpoint = selectedAgent ? '/api/ailydian/v2/execute' : '/api/ailydian/v2/query';
                const payload = selectedAgent
                    ? { agent_id: selectedAgent.id, task: query, parameters: {} }
                    : { query };

                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await res.json();

                if (data.basarili || data.success) {
                    const resultData = data.sonuc || data.result || data;
                    const agentInfo = selectedAgent ? `<div style="color:var(--hud-green);margin-bottom:8px;font-size:11px"><svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor" style="vertical-align:middle;margin-right:4px"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg> ${selectedAgent.name} tamamladı</div>` : '';
                    resultDiv.innerHTML = `${agentInfo}<pre style="color:var(--text-normal);font-size:10px;white-space:pre-wrap;overflow-x:auto">${typeof resultData === 'string' ? resultData : JSON.stringify(resultData, null, 2)}</pre>`;
                } else {
                    resultDiv.innerHTML = `<div style="color:var(--accent-danger)"><svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor" style="vertical-align:middle;margin-right:4px"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg> ${data.hata || data.error || 'Hata oluştu'}</div>`;
                }
            } catch (e) {
                resultDiv.innerHTML = `<div style="color:var(--accent-danger)"><svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor" style="vertical-align:middle;margin-right:4px"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg> Bağlantı hatası</div>`;
            }
        }

        async function startReconScan() {
            const target = document.getElementById('reconTargetInput').value;
            const type = document.getElementById('reconTypeSelect').value;
            if (!target) return alert('Hedef gerekli');

            const resultDiv = document.getElementById('reconResults');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div style="color:var(--text-dim)">Keşif başlatılıyor...</div>';

            try {
                const res = await fetch('/api/ailydian/v2/recon', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({target, type})
                });
                const data = await res.json();
                resultDiv.innerHTML = `<pre style="font-size:10px;color:var(--text-normal);overflow-x:auto">${JSON.stringify(data, null, 2)}</pre>`;
            } catch (e) {
                resultDiv.innerHTML = '<div style="color:var(--accent-danger)">Hata oluştu</div>';
            }
        }

        async function startRedteamAnalysis() {
            const target = document.getElementById('redteamTargetInput').value;
            if (!target) return alert('Hedef gerekli');

            const resultDiv = document.getElementById('redteamResults');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div style="color:var(--text-dim)">32 paralel agent çalıştırılıyor...</div>';

            try {
                const res = await fetch('/api/ailydian/v2/redteam', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({target, scope: 'full'})
                });
                const data = await res.json();
                resultDiv.innerHTML = `<pre style="font-size:10px;color:var(--text-normal);overflow-x:auto">${JSON.stringify(data, null, 2)}</pre>`;
            } catch (e) {
                resultDiv.innerHTML = '<div style="color:var(--accent-danger)">Hata oluştu</div>';
            }
        }

        async function startOsintInvestigation() {
            const query = document.getElementById('osintQueryInput').value;
            const depth = document.getElementById('osintDepthSelect').value;
            if (!query) return alert('Sorgu gerekli');

            const resultDiv = document.getElementById('osintInvestResults');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div style="color:var(--text-dim)">OSINT araştırması başlatılıyor...</div>';

            try {
                const res = await fetch('/api/ailydian/v2/osint', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({query, depth})
                });
                const data = await res.json();
                resultDiv.innerHTML = `<pre style="font-size:10px;color:var(--text-normal);overflow-x:auto">${JSON.stringify(data, null, 2)}</pre>`;
            } catch (e) {
                resultDiv.innerHTML = '<div style="color:var(--accent-danger)">Hata oluştu</div>';
            }
        }

        // THREAT Intel Popup Fonksiyonları
        function threatIntelPanelAc() {
            document.getElementById('threatIntelPopup').classList.add('active');
            loadLiveThreats();
        }

        function threatIntelPanelKapat() {
            document.getElementById('threatIntelPopup').classList.remove('active');
        }

        // ============================================
        // CANLI TEHDİT HARİTASI - Global Threat Map
        // ============================================
        let threatMapInstance = null;
        let threatMarkers = [];

        function openThreatMapModal() {
            document.getElementById('threatMapModal').style.display = 'block';
            initThreatMap();
            loadThreatData('TR');
        }

        function closeThreatMapModal() {
            document.getElementById('threatMapModal').style.display = 'none';
        }

        // Attack lines layer group
        let attackLinesLayer = null;
        let attackAnimationInterval = null;

        function initThreatMap() {
            if (threatMapInstance) return;

            const container = document.getElementById('threatMapContainer');
            if (!container) return;

            // Mini map oluştur
            const mapDiv = document.createElement('div');
            mapDiv.id = 'threatMiniMap';
            mapDiv.style.cssText = 'width:100%;height:100%;';
            container.appendChild(mapDiv);

            threatMapInstance = L.map('threatMiniMap', {
                center: [39.0, 35.0],
                zoom: 6,
                zoomControl: true,
                worldCopyJump: true
            });

            // Dark tile layer
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                maxZoom: 19,
                attribution: '© CartoDB'
            }).addTo(threatMapInstance);

            // Attack lines layer
            attackLinesLayer = L.layerGroup().addTo(threatMapInstance);

            // Add CSS for animated attack lines
            if (!document.getElementById('attackLineStyles')) {
                const style = document.createElement('style');
                style.id = 'attackLineStyles';
                style.textContent = `
                    .attack-line { stroke-dasharray: 10, 10; animation: attackDash 1s linear infinite; }
                    .attack-line-critical { stroke: #ff3355; filter: drop-shadow(0 0 4px #ff3355); }
                    .attack-line-high { stroke: #ff8800; filter: drop-shadow(0 0 3px #ff8800); }
                    .attack-line-medium { stroke: #ffc800; }
                    .attack-line-low { stroke: #00ff88; }
                    @keyframes attackDash { to { stroke-dashoffset: -20; } }
                    .pulse-marker { animation: markerPulse 1.5s ease-in-out infinite; }
                    @keyframes markerPulse { 0%,100% { opacity: 0.6; transform: scale(1); } 50% { opacity: 1; transform: scale(1.2); } }
                `;
                document.head.appendChild(style);
            }

            document.getElementById('threatMapLoading').style.display = 'none';
        }

        // Draw attack line from source to target
        function drawAttackLine(sourceLat, sourceLng, targetLat, targetLng, severity) {
            if (!attackLinesLayer) return;

            const colorClass = `attack-line attack-line-${severity || 'medium'}`;
            const colors = { critical: '#ff3355', high: '#ff8800', medium: '#ffc800', low: '#00ff88' };

            // Create curved line (great circle approximation)
            const midLat = (sourceLat + targetLat) / 2;
            const midLng = (sourceLng + targetLng) / 2;
            const offset = Math.abs(sourceLng - targetLng) * 0.15;

            const line = L.polyline([
                [sourceLat, sourceLng],
                [midLat + offset, midLng],
                [targetLat, targetLng]
            ], {
                color: colors[severity] || '#ffc800',
                weight: 2,
                opacity: 0.8,
                dashArray: '10, 10',
                className: colorClass
            }).addTo(attackLinesLayer);

            // Auto-remove after animation
            setTimeout(() => {
                if (attackLinesLayer) attackLinesLayer.removeLayer(line);
            }, 5000);

            return line;
        }

        // World view with animated attacks
        function showWorldView() {
            if (!threatMapInstance) return;
            threatMapInstance.setView([20, 0], 2);

            // Clear and restart attack animations
            if (attackAnimationInterval) clearInterval(attackAnimationInterval);

            attackAnimationInterval = setInterval(() => {
                // Random attack sources (common threat origins)
                const sources = [
                    { lat: 55.7, lng: 37.6, name: 'Moscow' },
                    { lat: 39.9, lng: 116.4, name: 'Beijing' },
                    { lat: 37.5, lng: 127.0, name: 'Seoul' },
                    { lat: 35.7, lng: 139.7, name: 'Tokyo' },
                    { lat: 40.7, lng: -74.0, name: 'New York' },
                    { lat: 51.5, lng: -0.1, name: 'London' },
                    { lat: 52.5, lng: 13.4, name: 'Berlin' },
                    { lat: -23.5, lng: -46.6, name: 'São Paulo' },
                    { lat: 28.6, lng: 77.2, name: 'Delhi' },
                    { lat: 1.3, lng: 103.8, name: 'Singapore' }
                ];

                // Target is Turkey (Ankara)
                const target = { lat: 39.9, lng: 32.9 };

                const source = sources[Math.floor(Math.random() * sources.length)];
                const severities = ['critical', 'high', 'medium', 'low'];
                const severity = severities[Math.floor(Math.random() * severities.length)];

                drawAttackLine(source.lat, source.lng, target.lat, target.lng, severity);
            }, 800);
        }

        // Turkey focused view
        function showTurkeyView() {
            if (!threatMapInstance) return;
            threatMapInstance.setView([39.0, 35.0], 6);

            // Stop world attack animations
            if (attackAnimationInterval) {
                clearInterval(attackAnimationInterval);
                attackAnimationInterval = null;
            }
            if (attackLinesLayer) attackLinesLayer.clearLayers();
        }

        async function loadThreatData(region) {
            try {
                const endpoint = region === 'TR' ? '/api/threats/turkey' : '/api/threats/live';
                const response = await fetch(endpoint);
                const geojson = await response.json();

                // Clear old markers
                threatMarkers.forEach(m => threatMapInstance.removeLayer(m));
                threatMarkers = [];

                // Stats
                let stats = { critical: 0, high: 0, medium: 0, low: 0, total: 0 };

                // Add markers
                if (geojson.features) {
                    geojson.features.forEach(feature => {
                        const props = feature.properties || {};
                        const coords = feature.geometry?.coordinates;
                        if (!coords) return;

                        const severity = props.severity || 'medium';
                        stats[severity] = (stats[severity] || 0) + 1;
                        stats.total++;

                        const colors = {
                            critical: '#ff3355',
                            high: '#ff8800',
                            medium: '#ffc800',
                            low: '#00ff88'
                        };

                        const marker = L.circleMarker([coords[1], coords[0]], {
                            radius: severity === 'critical' ? 12 : severity === 'high' ? 10 : 8,
                            fillColor: colors[severity] || '#888',
                            color: '#fff',
                            weight: 1,
                            opacity: 0.8,
                            fillOpacity: 0.6
                        }).addTo(threatMapInstance);

                        marker.bindPopup(`
                            <div style="font-family:'Courier New',monospace;">
                                <strong style="color:${colors[severity]}">${props.category || 'Unknown'}</strong><br>
                                <span style="color:#888">Severity:</span> ${severity}<br>
                                <span style="color:#888">Source:</span> ${props.source || 'N/A'}<br>
                                <span style="color:#888">IP:</span> ${props.ip || 'N/A'}
                            </div>
                        `);

                        threatMarkers.push(marker);
                    });
                }

                // Update stats
                document.getElementById('threatStatCritical').textContent = stats.critical;
                document.getElementById('threatStatHigh').textContent = stats.high;
                document.getElementById('threatStatMedium').textContent = stats.medium;
                document.getElementById('threatStatLow').textContent = stats.low;
                document.getElementById('threatStatTotal').textContent = stats.total;

                // Update feed
                updateThreatFeed(geojson.features || []);

            } catch (e) {
                console.error('[THREAT] Veri yüklenemedi:', e);
                termLog('[THREAT] Veri yüklenemedi: ' + e.message, 'err');
            }
        }

        async function simulateThreatData() {
            try {
                const response = await fetch('/api/threats/live?count=100');
                const geojson = await response.json();

                // Same processing as loadThreatData
                threatMarkers.forEach(m => threatMapInstance.removeLayer(m));
                threatMarkers = [];

                let stats = { critical: 0, high: 0, medium: 0, low: 0, total: 0 };

                if (geojson.features) {
                    geojson.features.forEach(feature => {
                        const props = feature.properties || {};
                        const coords = feature.geometry?.coordinates;
                        if (!coords) return;

                        const severity = props.severity || 'medium';
                        stats[severity] = (stats[severity] || 0) + 1;
                        stats.total++;

                        const colors = {
                            critical: '#ff3355',
                            high: '#ff8800',
                            medium: '#ffc800',
                            low: '#00ff88'
                        };

                        const marker = L.circleMarker([coords[1], coords[0]], {
                            radius: severity === 'critical' ? 12 : severity === 'high' ? 10 : 8,
                            fillColor: colors[severity] || '#888',
                            color: '#fff',
                            weight: 1,
                            opacity: 0.8,
                            fillOpacity: 0.6
                        }).addTo(threatMapInstance);

                        threatMarkers.push(marker);
                    });
                }

                document.getElementById('threatStatCritical').textContent = stats.critical;
                document.getElementById('threatStatHigh').textContent = stats.high;
                document.getElementById('threatStatMedium').textContent = stats.medium;
                document.getElementById('threatStatLow').textContent = stats.low;
                document.getElementById('threatStatTotal').textContent = stats.total;

                updateThreatFeed(geojson.features || []);
                termLog('[THREAT] Simülasyon verileri yüklendi: ' + stats.total + ' tehdit', 'ok');

            } catch (e) {
                console.error('[THREAT] Simülasyon hatası:', e);
            }
        }

        function refreshThreatData() {
            loadThreatData('TR');
            termLog('[THREAT] Veriler yenileniyor...', 'info');
        }

        function updateThreatFeed(features) {
            const feed = document.getElementById('threatFeed');
            if (!feed) return;

            if (!features.length) {
                feed.innerHTML = '<div style="color:#666;text-align:center;padding:20px;">Tehdit verisi bulunamadı</div>';
                return;
            }

            const colors = { critical: '#ff3355', high: '#ff8800', medium: '#ffc800', low: '#00ff88' };

            feed.innerHTML = features.slice(0, 20).map(f => {
                const p = f.properties || {};
                return `
                    <div style="padding:8px;border-bottom:1px solid #222;display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <span style="color:${colors[p.severity] || '#888'};font-weight:bold;">${p.category || 'Unknown'}</span>
                            <span style="color:#666;margin-left:10px;font-size:11px;">${p.ip || 'N/A'}</span>
                        </div>
                        <span style="color:#444;font-size:10px;">${p.source || ''}</span>
                    </div>
                `;
            }).join('');
        }

        // ============================================
        // LIVE THREAT STREAM - Palantir-Style Real-Time
        // ============================================

        // Global threat layer for live threats
        let liveThreatLayer = null;
        let liveThreatMarkers = [];
        let liveThreatStreamActive = false;
        let liveThreatUpdateInterval = null;

        /**
         * Start live threat stream - Palantir-style real-time visualization
         * @param {number} duration - Duration in minutes (default: 60)
         * @param {number} rate - Threats per minute (default: 10)
         */
        async function startLiveThreatStream(duration = 60, rate = 10) {
            try {
                const response = await fetch('/api/harita/canli-tehditler/baslat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        duration: duration,
                        rate: rate
                    })
                });

                const result = await response.json();
                if (result.basarili) {
                    liveThreatStreamActive = true;

                    // Initialize live threat layer if not exists
                    if (!liveThreatLayer) {
                        liveThreatLayer = L.layerGroup().addTo(map);
                    }

                    // Start polling for new threats
                    liveThreatUpdateInterval = setInterval(async () => {
                        if (!liveThreatStreamActive) return;

                        const zoomLevel = map.getZoom();
                        const response = await fetch(`/api/harita/canli-tehditler?zoom=${zoomLevel}`);
                        const data = await response.json();

                        if (data.basarili && data.tehditler) {
                            updateLiveThreats(data.tehditler);
                        }
                    }, 3000); // Update every 3 seconds

                    termLog(`[CANLI_TEHDIT] Stream başlatıldı - ${duration} dakika`, 'ok');
                }
            } catch (e) {
                console.error('[CANLI_TEHDIT] Stream başlatma hatası:', e);
                termLog('[CANLI_TEHDIT] Başlatma hatası: ' + e.message, 'err');
            }
        }

        /**
         * Stop live threat stream
         */
        async function stopLiveThreatStream() {
            try {
                await fetch('/api/harita/canli-tehditler/durdur', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                liveThreatStreamActive = false;

                if (liveThreatUpdateInterval) {
                    clearInterval(liveThreatUpdateInterval);
                    liveThreatUpdateInterval = null;
                }

                termLog('[CANLI_TEHDIT] Stream durduruldu', 'info');
            } catch (e) {
                console.error('[CANLI_TEHDIT] Durdurma hatası:', e);
            }
        }

        /**
         * Add live threat to map with Palantir-style ping animation
         * @param {Object} threat - Threat event object
         */
        function addLiveThreatToMap(threat) {
            if (!liveThreatLayer || !threat) return;

            const coords = [threat.latitude, threat.longitude];

            // Severity colors
            const colors = {
                critical: { main: '#ff3355', glow: 'rgba(255, 51, 85, 0.6)' },
                high: { main: '#ff8800', glow: 'rgba(255, 136, 0, 0.6)' },
                medium: { main: '#ffc800', glow: 'rgba(255, 200, 0, 0.6)' },
                low: { main: '#00ff88', glow: 'rgba(0, 255, 136, 0, 6)' }
            };

            const severityColors = colors[threat.severity] || colors.medium;

            // Create pulsing marker
            const marker = L.circleMarker(coords, {
                radius: threat.severity === 'critical' ? 15 : threat.severity === 'high' ? 12 : 10,
                fillColor: severityColors.main,
                color: '#fff',
                weight: 2,
                opacity: 0.9,
                fillOpacity: 0.7,
                className: 'live-threat-marker pulse-marker'
            }).addTo(liveThreatLayer);

            // Add pulse animation
            let pulseRadius = 0;
            let maxPulseRadius = threat.severity === 'critical' ? 30 : 25;
            const pulseInterval = setInterval(() => {
                if (!marker._map) {
                    clearInterval(pulseInterval);
                    return;
                }

                pulseRadius += 2;
                if (pulseRadius > maxPulseRadius) {
                    pulseRadius = 0;
                }

                marker.setStyle({
                    radius: (threat.severity === 'critical' ? 15 : threat.severity === 'high' ? 12 : 10) + pulseRadius,
                    opacity: 0.9 - (pulseRadius / maxPulseRadius) * 0.5
                });
            }, 100);

            // Detailed popup
            const popupContent = `
                <div style="font-family:'Courier New',monospace;color:#fff;min-width:250px;">
                    <div style="border-bottom:1px solid #444;padding-bottom:8px;margin-bottom:8px;">
                        <strong style="color:${severityColors.main};font-size:14px;">
                            ${threat.type.toUpperCase()}
                        </strong>
                        <span style="float:right;background:${severityColors.main};padding:2px 8px;border-radius:3px;font-size:11px;">
                            ${threat.severity.toUpperCase()}
                        </span>
                    </div>
                    <div style="font-size:12px;line-height:1.6;">
                        <div style="color:#888;margin-bottom:4px;">${threat.description}</div>
                        <div><span style="color:#666;">Kaynak:</span> ${threat.source_ip}</div>
                        <div><span style="color:#666;">Hedef:</span> ${threat.target_ip}</div>
                        <div><span style="color:#666;">Konum:</span> ${threat.city || 'TR'}</div>
                        <div><span style="color:#666;">Confidence:</span> ${(threat.confidence * 100).toFixed(0)}%</div>
                        <div><span style="color:#666;">Zaman:</span> ${new Date(threat.timestamp).toLocaleTimeString('tr-TR')}</div>
                    </div>
                </div>
            `;

            marker.bindPopup(popupContent);

            // Auto-remove after 30 seconds
            setTimeout(() => {
                if (marker._map) {
                    liveThreatLayer.removeLayer(marker);
                }
                clearInterval(pulseInterval);
            }, 30000);

            // Log to terminal
            termLog(`[CANLI_TEHDIT] ${threat.type.toUpperCase()} - ${threat.city} (${threat.latitude.toFixed(4)}, ${threat.longitude.toFixed(4)})`, threat.severity === 'critical' ? 'err' : 'info');
        }

        /**
         * Update all live threats based on current zoom level
         * @param {Array} threats - Array of threat objects
         */
        function updateLiveThreats(threats) {
            if (!liveThreatLayer) return;

            // Clear old markers
            liveThreatMarkers.forEach(marker => {
                if (marker._map) {
                    liveThreatLayer.removeLayer(marker);
                }
            });
            liveThreatMarkers = [];

            // Add new threats
            threats.forEach(threat => {
                addLiveThreatToMap(threat);
            });
        }

        /**
         * UI Button Handler - Start Live Threat Stream
         * Called from "Başlat" button in Siber Komuta panel
         */
        function startLiveThreatStreamFromUI() {
            // Default values: 60 minutes duration, 10 threats per minute
            const duration = 60;
            const rate = 10;

            startLiveThreatStream(duration, rate);
            termLog(`[CANLI_TEHDIT] Başlatıldı - UI butonu üzerinden (${duration} dakika, ${rate} tehdit/dakika)`, 'ok');

            // Update button states
            document.querySelectorAll('.stream-start-btn').forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.5';
            });
            document.querySelectorAll('.stream-stop-btn').forEach(btn => {
                btn.disabled = false;
                btn.style.opacity = '1';
            });
        }

        /**
         * UI Button Handler - Stop Live Threat Stream
         * Called from "Durdur" button in Siber Komuta panel
         */
        function stopLiveThreatStreamFromUI() {
            stopLiveThreatStream();
            termLog('[CANLI_TEHDIT] Durduruldu - UI butonu üzerinden', 'info');

            // Update button states
            document.querySelectorAll('.stream-start-btn').forEach(btn => {
                btn.disabled = false;
                btn.style.opacity = '1';
            });
            document.querySelectorAll('.stream-stop-btn').forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.5';
            });
        }

        // ============================================
        // AI THREAT PREDICTION - Palantir-Style Predictive Analytics
        // ============================================

        /**
         * AI Threat Prediction - Single Region Forecast
         * Predicts threats for the current map center region
         */
        async function aiTahminGoster() {
            try {
                const center = map.getCenter();
                const zoom = map.getZoom();

                // Calculate region radius based on zoom level
                const yaricap_km = Math.max(10, Math.round(200 / Math.pow(2, zoom - 4)));

                termLog(`[AI_TAHMIN] Bölge tahmini başlatılıyor... (Zoom: ${zoom}, Yarıçap: ${yaricap_km}km)`, 'info');

                const response = await fetch('/api/harita/tahmin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        enlem: center.lat,
                        boylam: center.lng,
                        zaman_araligi: '1s',
                        yaricap_km: yaricap_km
                    })
                });

                const result = await response.json();

                if (result.basarili) {
                    const tahmin = result.tahmin;
                    const riskLabels = {
                        'kritik': 'KRİTİK',
                        'yuksek': 'YÜKSEK',
                        'orta': 'ORTA',
                        'dusuk': 'DÜŞÜK'
                    };
                    const riskColors = {
                        'kritik': '#ff3355',
                        'yuksek': '#ff8800',
                        'orta': '#ffc800',
                        'dusuk': '#00ff88'
                    };

                    termLog(`[AI_TAHMIN] Tahmin tamamlandı - Risk: ${riskLabels[tahmin.risk] || tahmin.risk}, Sayı: ${tahmin.sayisi}`, 'ok');

                    // Visualize prediction on map
                    const predictionCircle = L.circle([center.lat, center.lng], {
                        radius: yaricap_km * 1000, // Convert km to meters
                        fillColor: riskColors[tahmin.risk] || '#888',
                        color: riskColors[tahmin.risk] || '#888',
                        weight: 2,
                        opacity: 0.3,
                        fillOpacity: 0.2
                    }).addTo(map);

                    // Add popup with prediction details
                    const popupContent = `
                        <div style="min-width:200px;">
                            <h4 style="margin:0 0 10px 0;color:${riskColors[tahmin.risk]}">AI Tehdit Tahmini</h4>
                            <div><strong>Risk Seviyesi:</strong> <span style="color:${riskColors[tahmin.risk]}">${riskLabels[tahmin.risk] || tahmin.risk}</span></div>
                            <div><strong>Tahmini Sayı:</strong> ${tahmin.sayisi}</div>
                            <div><strong>Güven Aralığı:</strong> ${tahmin.guven_araligi?.min || 0} - ${tahmin.guven_araligi?.max || 0}</div>
                            <div><strong>Tahmin Tarihi:</strong> ${new Date().toLocaleString('tr-TR')}</div>
                        </div>
                    `;
                    predictionCircle.bindPopup(popupContent).openPopup();

                    // Auto-remove after 30 seconds
                    setTimeout(() => {
                        map.removeLayer(predictionCircle);
                    }, 30000);

                } else {
                    termLog(`[AI_TAHMIN] Hata: ${result.mesaj || 'Bilinmeyen hata'}`, 'error');
                }
            } catch (error) {
                console.error('[AI_TAHMIN] İstek hatası:', error);
                termLog('[AI_TAHMIN] Bağlantı hatası - Sunucu yanıt vermedi', 'error');
            }
        }

        /**
         * AI Multi-Horizon Threat Prediction
         * Shows predictions for multiple time periods
         */
        async function aiCokluTahminGoster() {
            try {
                const center = map.getCenter();
                const zoom = map.getZoom();
                const yaricap_km = Math.max(10, Math.round(200 / Math.pow(2, zoom - 4)));

                termLog(`[AI_TAHMIN] Çoklu horizon tahmini başlatılıyor...`, 'info');

                const response = await fetch('/api/harita/tahmin/coklu', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        enlem: center.lat,
                        boylam: center.lng,
                        zaman_araliklari: ['1s', '1g', '1w'],
                        yaricap_km: yaricap_km
                    })
                });

                const result = await response.json();

                if (result.basarili) {
                    const tahminler = result.tahminler || [];
                    termLog(`[AI_TAHMIN] Çoklu tahmin tamamlandı - ${tahminler.length} zaman aralığı`, 'ok');

                    // Create prediction circles for each time horizon
                    const colors = {
                        '1s': '#00b4ff',  // Blue - short term
                        '1g': '#ff8800',  // Orange - medium term
                        '1w': '#ff3355'   // Red - long term
                    };

                    const labels = {
                        '1s': '1 Saat',
                        '1g': '1 Gün',
                        '1w': '1 Hafta'
                    };

                    tahminler.forEach((tahmin, index) => {
                        const radius = yaricap_km * 1000 * (1 + index * 0.3); // Expanding circles

                        const predictionCircle = L.circle([center.lat, center.lng], {
                            radius: radius,
                            fillColor: colors[tahmin.zaman_araligi] || '#888',
                            color: colors[tahmin.zaman_araligi] || '#888',
                            weight: 2,
                            opacity: 0.2,
                            fillOpacity: 0.1,
                            dashArray: '10, 10'
                        }).addTo(map);

                        // Popup with multi-horizon details
                        const popupContent = `
                            <div style="min-width:200px;">
                                <h4 style="margin:0 0 10px 0;color:${colors[tahmin.zaman_araligi]}">${labels[tahmin.zaman_araligi]} Tahmini</h4>
                                <div><strong>Tahmini Sayı:</strong> ${tahmin.sayisi || 0}</div>
                                <div><strong>Risk Seviyesi:</strong> ${tahmin.risk || 'N/A'}</div>
                                <div><strong>Trend:</strong> ${tahmin.trend || 'stabil'}</div>
                            </div>
                        `;
                        predictionCircle.bindPopup(popupContent);

                        // Remove after 45 seconds
                        setTimeout(() => {
                            map.removeLayer(predictionCircle);
                        }, 45000);
                    });

                    // Log summary to terminal
                    const summary = tahminler.map(t =>
                        `${labels[t.zaman_araligi]}: ${t.sayisi} (${t.risk})`
                    ).join(' | ');
                    termLog(`[AI_TAHMIN] Özet: ${summary}`, 'ok');

                } else {
                    termLog(`[AI_TAHMIN] Hata: ${result.mesaj || 'Bilinmeyen hata'}`, 'error');
                }
            } catch (error) {
                console.error('[AI_TAHMIN] Çoklu tahmin hatası:', error);
                termLog('[AI_TAHMIN] Bağlantı hatası - Sunucu yanıt vermedi', 'error');
            }
        }

        // ============================================
        // WAF CHECKER - Web Application Firewall Test
        // ============================================
        function openWafCheckerModal() {
            document.getElementById('wafCheckerModal').style.display = 'block';
        }

        function closeWafCheckerModal() {
            document.getElementById('wafCheckerModal').style.display = 'none';
        }

        async function detectWaf() {
            const url = document.getElementById('wafTargetUrl').value.trim();
            if (!url) {
                alert('Lütfen hedef URL girin');
                return;
            }

            const resultDiv = document.getElementById('wafDetectionResult');
            const contentDiv = document.getElementById('wafResultContent');

            resultDiv.style.display = 'block';
            contentDiv.innerHTML = '<div style="text-align:center;padding:20px;"><div style="width:30px;height:30px;border:3px solid #333;border-top-color:#00b4ff;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto;"></div><div style="color:#00b4ff;margin-top:10px;">WAF tespit ediliyor...</div></div>';

            try {
                const response = await fetch('/api/waf/detect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });

                const data = await response.json();

                if (data.basarili) {
                    const wafColor = data.waf_detected ? '#ff8800' : '#00ff88';
                    contentDiv.innerHTML = `
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                            <div>
                                <div style="color:#888;font-size:11px;margin-bottom:5px;">WAF Durumu</div>
                                <div style="color:${wafColor};font-size:18px;font-weight:bold;">${data.waf_detected ? 'TESPİT EDİLDİ' : 'TESPİT EDİLMEDİ'}</div>
                            </div>
                            <div>
                                <div style="color:#888;font-size:11px;margin-bottom:5px;">WAF Tipi</div>
                                <div style="color:#00b4ff;font-size:18px;font-weight:bold;">${data.waf_type || 'Bilinmiyor'}</div>
                            </div>
                            <div>
                                <div style="color:#888;font-size:11px;margin-bottom:5px;">Güven Skoru</div>
                                <div style="color:#ffc800;font-size:18px;font-weight:bold;">${Math.round((data.confidence || 0) * 100)}%</div>
                            </div>
                            <div>
                                <div style="color:#888;font-size:11px;margin-bottom:5px;">Tespit Metodu</div>
                                <div style="color:#8a2be2;font-size:14px;">${data.detection_method || 'N/A'}</div>
                            </div>
                        </div>
                    `;

                    // Show bypass suggestions if WAF detected
                    if (data.waf_detected && data.bypass_suggestions?.length) {
                        showBypassSuggestions(data.bypass_suggestions);
                    }

                    termLog('[WAF] ' + url + ' - ' + (data.waf_type || 'No WAF'), 'ok');
                } else {
                    contentDiv.innerHTML = `<div style="color:#ff3355;">Hata: ${data.hata}</div>`;
                }
            } catch (e) {
                contentDiv.innerHTML = `<div style="color:#ff3355;">Bağlantı hatası: ${e.message}</div>`;
            }
        }

        async function testWafPayloads() {
            const url = document.getElementById('wafTargetUrl').value.trim();
            if (!url) {
                alert('Lütfen hedef URL girin');
                return;
            }

            const categories = [];
            if (document.getElementById('wafCatSql').checked) categories.push('sql_injection');
            if (document.getElementById('wafCatXss').checked) categories.push('xss');
            if (document.getElementById('wafCatCmd').checked) categories.push('command_injection');
            if (document.getElementById('wafCatPath').checked) categories.push('path_traversal');

            if (!categories.length) {
                alert('En az bir kategori seçin');
                return;
            }

            const resultDiv = document.getElementById('wafTestResults');
            const contentDiv = document.getElementById('wafTestContent');

            resultDiv.style.display = 'block';
            contentDiv.innerHTML = '<div style="text-align:center;padding:20px;"><div style="width:30px;height:30px;border:3px solid #333;border-top-color:#ff8800;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto;"></div><div style="color:#ff8800;margin-top:10px;">Payload testi yapılıyor...</div></div>';

            try {
                const response = await fetch('/api/waf/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url, categories })
                });

                const data = await response.json();

                if (data.basarili) {
                    const blockRate = data.total_tests > 0 ? Math.round((data.blocked / data.total_tests) * 100) : 0;
                    const blockColor = blockRate > 80 ? '#00ff88' : blockRate > 50 ? '#ffc800' : '#ff3355';

                    contentDiv.innerHTML = `
                        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-bottom:20px;">
                            <div style="text-align:center;">
                                <div style="color:#00b4ff;font-size:24px;font-weight:bold;">${data.total_tests}</div>
                                <div style="color:#888;font-size:11px;">Toplam Test</div>
                            </div>
                            <div style="text-align:center;">
                                <div style="color:#ff3355;font-size:24px;font-weight:bold;">${data.blocked}</div>
                                <div style="color:#888;font-size:11px;">Engellenen</div>
                            </div>
                            <div style="text-align:center;">
                                <div style="color:${blockColor};font-size:24px;font-weight:bold;">${blockRate}%</div>
                                <div style="color:#888;font-size:11px;">Koruma Oranı</div>
                            </div>
                        </div>
                        <div style="max-height:200px;overflow-y:auto;">
                            ${data.results.map(r => `
                                <div style="padding:8px;border-bottom:1px solid #222;display:flex;justify-content:space-between;font-size:11px;">
                                    <span style="color:#888;">${r.category}</span>
                                    <span style="color:${r.blocked ? '#ff3355' : '#00ff88'};">${r.blocked ? 'BLOCKED' : 'PASSED'}</span>
                                    <span style="color:#666;">${r.status_code}</span>
                                </div>
                            `).join('')}
                        </div>
                    `;

                    termLog('[WAF] Test tamamlandı: ' + data.blocked + '/' + data.total_tests + ' engellendi', 'ok');
                } else {
                    contentDiv.innerHTML = `<div style="color:#ff3355;">Hata: ${data.hata}</div>`;
                }
            } catch (e) {
                contentDiv.innerHTML = `<div style="color:#ff3355;">Test hatası: ${e.message}</div>`;
            }
        }

        function showBypassSuggestions(suggestions) {
            const section = document.getElementById('wafBypassSection');
            const content = document.getElementById('wafBypassContent');

            section.style.display = 'block';
            content.innerHTML = suggestions.map(s => `
                <div style="padding:10px;border-bottom:1px solid #333;">
                    <div style="color:#8a2be2;font-weight:bold;margin-bottom:5px;">${s.technique || s.name}</div>
                    <div style="color:#888;font-size:12px;">${s.description || ''}</div>
                    ${s.example ? `<code style="display:block;margin-top:5px;padding:8px;background:rgba(0,0,0,0.3);border-radius:4px;color:#ffc800;font-size:11px;">${s.example}</code>` : ''}
                </div>
            `).join('');
        }

        // ============================================
        // TOR STEALTH POPUP - Gerçek Tor Yönetimi
        // ============================================
        const TorStateManager = {
            state: {
                connected: false,
                connecting: false,
                level: 'normal',
                exitIP: null,
                hops: [],
                latency: 0
            },

            STORAGE_KEY: 'tsunami_tor_state',

            loadState: function() {
                try {
                    const saved = localStorage.getItem(this.STORAGE_KEY);
                    if (saved) {
                        this.state = { ...this.state, ...JSON.parse(saved) };
                    }
                } catch (e) {
                    console.warn('[TorStateManager] Durum yüklenemedi:', e);
                }
            },

            saveState: function() {
                try {
                    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(this.state));
                } catch (e) {
                    console.warn('[TorStateManager] Durum kaydedilemedi:', e);
                }
            },

            broadcast: function() {
                window.dispatchEvent(new CustomEvent('tor-state-changed', { detail: this.state }));
                // Panel iframe'e bildir
                if (window.parent !== window) {
                    window.parent.postMessage({ type: 'tor-state', state: this.state }, '*');
                }
            }
        };

        // Sayfa yüklendiğinde Tor durumunu kontrol et
        document.addEventListener('DOMContentLoaded', function() {
            TorStateManager.loadState();
            updateTorUI();
            checkTorStatus();
        });

        // Tor popup aç/kapat
        function openTorPopup() {
            document.getElementById('torStealthPopup').classList.add('active');
            checkTorStatus();
        }

        function closeTorPopup() {
            document.getElementById('torStealthPopup').classList.remove('active');
        }

        // Tor durumunu kontrol et (gerçek API çağrısı)
        async function checkTorStatus() {
            try {
                const res = await fetch('/api/stealth/durum');
                const data = await res.json();

                if (data.basarili && data.aktif) {
                    TorStateManager.state.connected = true;
                    TorStateManager.state.connecting = false;
                    TorStateManager.state.exitIP = data.cikis_ip || data.exit_ip;
                    TorStateManager.state.hops = data.devre || [];
                    TorStateManager.state.latency = data.latency || Math.floor(Math.random() * 200) + 100;
                } else {
                    TorStateManager.state.connected = false;
                    TorStateManager.state.connecting = false;
                    TorStateManager.state.exitIP = null;
                }

                TorStateManager.saveState();
                TorStateManager.broadcast();
                updateTorUI();
            } catch (e) {
                console.error('[TOR] Durum kontrol hatası:', e);
                TorStateManager.state.connected = false;
                TorStateManager.state.connecting = false;
                updateTorUI();
            }
        }

        // UI güncelle
        function updateTorUI() {
            const state = TorStateManager.state;
            const indicator = document.getElementById('torStatusIndicator');
            const statusText = document.getElementById('torStatusText');
            const ipDisplay = document.getElementById('torIpDisplay');
            const exitIP = document.getElementById('torExitIP');
            const circuitVisual = document.getElementById('torCircuitVisual');
            const connectBtn = document.getElementById('torConnectBtn');
            const connectBtnText = document.getElementById('torConnectBtnText');
            const rotateBtn = document.getElementById('torRotateBtn');
            const hopsValue = document.getElementById('torHops');
            const latencyValue = document.getElementById('torLatency');

            // Durum indicator
            indicator.className = 'tor-status-indicator';
            statusText.className = 'tor-status-text';

            if (state.connecting) {
                indicator.classList.add('connecting');
                statusText.classList.add('connecting');
                statusText.textContent = 'BAĞLANIYOR...';
                connectBtnText.textContent = 'BAĞLANIYOR...';
                ipDisplay.style.display = 'none';
                circuitVisual.style.display = 'none';
            } else if (state.connected) {
                indicator.classList.add('connected');
                statusText.classList.add('connected');
                statusText.textContent = 'BAĞLI';
                connectBtnText.textContent = 'TOR KAPAT';
                connectBtn.className = 'tor-action-btn tor-btn-danger';
                ipDisplay.style.display = 'block';
                exitIP.textContent = state.exitIP || '---';
                circuitVisual.style.display = 'flex';
                rotateBtn.disabled = false;
                hopsValue.textContent = state.hops.length || 3;
                latencyValue.textContent = state.latency || '--';

                // Devre görselini güncelle
                if (state.hops.length > 0) {
                    state.hops.forEach((hop, i) => {
                        const el = document.getElementById('torHop' + (i + 1));
                        if (el) el.textContent = hop.country || hop.ulke || '🔒';
                    });
                }
            } else {
                indicator.classList.add('offline');
                statusText.classList.add('offline');
                statusText.textContent = 'BAĞLI DEĞİL';
                connectBtnText.textContent = 'TOR AKTİF ET';
                connectBtn.className = 'tor-action-btn tor-btn-primary';
                ipDisplay.style.display = 'none';
                circuitVisual.style.display = 'none';
                rotateBtn.disabled = true;
                hopsValue.textContent = '0';
                latencyValue.textContent = '--';
            }

            // Sidebar widget'ı da güncelle
            const stealthInfoPanel = document.getElementById('stealthInfoPanel');
            if (stealthInfoPanel) {
                if (state.connected) {
                    stealthInfoPanel.innerHTML = `
                        <div style="color:#00ff88;font-weight:bold;">✓ TOR BAĞLI</div>
                        <div style="color:var(--text-dim);font-size:10px;margin-top:4px;">Çıkış: ${state.exitIP || '---'}</div>
                    `;
                } else {
                    stealthInfoPanel.innerHTML = `<div style="color:var(--text-dim);">Başlatılmadı</div>`;
                }
            }
        }

        // Tor bağlantısını aç/kapa
        async function toggleTorConnection() {
            const state = TorStateManager.state;

            if (state.connecting) return;

            if (state.connected) {
                // Tor'u kapat
                TorStateManager.state.connecting = true;
                updateTorUI();

                try {
                    const res = await fetch('/api/stealth/durdur', { method: 'POST' });
                    const data = await res.json();

                    if (data.basarili) {
                        TorStateManager.state.connected = false;
                        TorStateManager.state.exitIP = null;
                        TorStateManager.state.hops = [];
                        termLog('TOR bağlantısı kapatıldı', 'warn');
                    } else {
                        termLog('TOR kapatılamadı: ' + (data.hata || 'Bilinmeyen hata'), 'err');
                    }
                } catch (e) {
                    console.error('[TOR] Kapatma hatası:', e);
                    termLog('TOR kapatma hatası', 'err');
                }

                TorStateManager.state.connecting = false;
            } else {
                // Tor'u başlat
                TorStateManager.state.connecting = true;
                updateTorUI();
                termLog('TOR bağlantısı başlatılıyor...', 'info');

                try {
                    const res = await fetch('/api/stealth/baslat', { method: 'POST' });
                    const data = await res.json();

                    if (data.basarili) {
                        TorStateManager.state.connected = true;
                        TorStateManager.state.exitIP = data.cikis_ip || data.exit_ip;
                        TorStateManager.state.hops = data.devre || [];
                        TorStateManager.state.latency = data.latency || Math.floor(Math.random() * 200) + 100;
                        termLog('TOR BAĞLANDI - Çıkış IP: ' + TorStateManager.state.exitIP, 'ok');
                        sesliUyari('Tor bağlantısı başarılı');
                    } else {
                        termLog('TOR başlatılamadı: ' + (data.hata || 'Bilinmeyen hata'), 'err');
                    }
                } catch (e) {
                    console.error('[TOR] Başlatma hatası:', e);
                    termLog('TOR başlatma hatası', 'err');
                }

                TorStateManager.state.connecting = false;
            }

            TorStateManager.saveState();
            TorStateManager.broadcast();
            updateTorUI();
        }

        // ========== KALICI TOGGLE FONKSİYONLARI ==========

        async function toggleTorSetting(enabled) {
            const statusEl = document.getElementById('torToggleStatus');
            if (statusEl) statusEl.textContent = enabled ? 'Aktif ediliyor...' : 'Kapatılıyor...';
            try {
                const res = await fetch('/api/settings/tor', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({enabled: enabled})
                });
                const data = await res.json();
                if (data.basarili) {
                    if (statusEl) statusEl.textContent = enabled ? 'Aktif' : 'Deaktif';
                    termLog(`TOR ${enabled ? 'AKTİF' : 'DEAKTİF'} edildi (kalıcı)`, enabled ? 'ok' : 'warn');
                    if (enabled) {
                        // UI'da da bağlantıyı göster
                        setTimeout(() => checkStealthStatus(), 2000);
                    }
                } else {
                    if (statusEl) statusEl.textContent = 'Hata!';
                    document.getElementById('torToggle').checked = !enabled;
                    termLog('TOR ayar değişikliği başarısız', 'err');
                }
            } catch (e) {
                console.error('[TOGGLE] Tor toggle hatası:', e);
                if (statusEl) statusEl.textContent = 'Hata!';
                document.getElementById('torToggle').checked = !enabled;
                termLog('TOR ayar değişikliği hatası', 'err');
            }
        }

        async function toggleGhostSetting(enabled) {
            const statusEl = document.getElementById('ghostToggleStatus');
            if (statusEl) statusEl.textContent = enabled ? 'Aktif ediliyor...' : 'Kapatılıyor...';
            try {
                const res = await fetch('/api/settings/ghost', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({enabled: enabled})
                });
                const data = await res.json();
                if (data.basarili) {
                    if (statusEl) statusEl.textContent = enabled ? 'Aktif' : 'Deaktif';
                    termLog(`GHOST MODE ${enabled ? 'AKTİF' : 'DEAKTİF'} edildi (kalıcı)`, enabled ? 'ok' : 'warn');
                } else {
                    if (statusEl) statusEl.textContent = 'Hata!';
                    document.getElementById('ghostToggle').checked = !enabled;
                    termLog('Ghost Mode ayar değişikliği başarısız', 'err');
                }
            } catch (e) {
                console.error('[TOGGLE] Ghost toggle hatası:', e);
                if (statusEl) statusEl.textContent = 'Hata!';
                document.getElementById('ghostToggle').checked = !enabled;
                termLog('Ghost Mode ayar değişikliği hatası', 'err');
            }
        }

        // Sayfa yüklenince toggle durumlarını senkronize et
        async function syncToggleStates() {
            try {
                const res = await fetch('/api/settings/stealth');
                const data = await res.json();
                if (data.basarili) {
                    const torToggle = document.getElementById('torToggle');
                    const ghostToggle = document.getElementById('ghostToggle');
                    const torStatus = document.getElementById('torToggleStatus');
                    const ghostStatus = document.getElementById('ghostToggleStatus');

                    if (torToggle) torToggle.checked = data.tor.enabled;
                    if (ghostToggle) ghostToggle.checked = data.ghost.enabled;
                    if (torStatus) torStatus.textContent = data.tor.running ? 'Aktif' : (data.tor.enabled ? 'Bekleniyor' : 'Deaktif');
                    if (ghostStatus) ghostStatus.textContent = data.ghost.active ? 'Aktif' : (data.ghost.enabled ? 'Bekleniyor' : 'Deaktif');
                }
            } catch (e) {
                console.warn('[TOGGLE] Senkronizasyon hatası:', e);
            }
        }

        // Devre döndür (yeni çıkış IP'si al)
        async function rotateTorCircuit() {
            if (!TorStateManager.state.connected) return;

            termLog('TOR devresi yenileniyor...', 'info');

            try {
                const res = await fetch('/api/stealth/dondur', { method: 'POST' });
                const data = await res.json();

                if (data.basarili) {
                    TorStateManager.state.exitIP = data.yeni_ip || data.cikis_ip;
                    TorStateManager.state.hops = data.devre || TorStateManager.state.hops;
                    TorStateManager.state.latency = data.latency || Math.floor(Math.random() * 200) + 100;
                    TorStateManager.saveState();
                    TorStateManager.broadcast();
                    updateTorUI();
                    termLog('TOR devresi yenilendi - Yeni IP: ' + TorStateManager.state.exitIP, 'ok');
                } else {
                    termLog('Devre yenilenemedi: ' + (data.hata || 'Bilinmeyen hata'), 'err');
                }
            } catch (e) {
                console.error('[TOR] Devre döndürme hatası:', e);
                termLog('TOR devre döndürme hatası', 'err');
            }
        }

        // Gizlilik seviyesi seç
        function selectTorLevel(level) {
            document.querySelectorAll('.tor-level-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.level === level);
            });
            TorStateManager.state.level = level;
            TorStateManager.saveState();

            // Sidebar select'i de güncelle
            const sidebarSelect = document.getElementById('stealthLevelSelect');
            if (sidebarSelect) sidebarSelect.value = level;
        }

        // postMessage ile panel'den gelen mesajları dinle
        window.addEventListener('message', function(e) {
            if (e.data && e.data.type === 'open-tor-popup') {
                openTorPopup();
            } else if (e.data && e.data.type === 'request-tor-state') {
                TorStateManager.broadcast();
            }
        });

        // Sidebar'daki TOR aktivasyon fonksiyonu - GERÇEK BAĞLANTI
        async function activateTorStealth() {
            // Popup'ı aç
            openTorPopup();

            // Eğer zaten bağlı değilse, otomatik bağlan
            if (!TorStateManager.state.connected && !TorStateManager.state.connecting) {
                await toggleTorConnection();
            }
        }

        function threatTabDegistir(tab) {
            document.querySelectorAll('#threatIntelPopup .cockpit-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#threatIntelPopup .cockpit-tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('threatTab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');

            if (tab === 'apt') loadAPTGroups();
            else if (tab === 'feeds') loadThreatFeeds();
        }

        async function loadLiveThreats() {
            try {
                const res = await fetch('/api/threat-intel/status');
                const data = await res.json();
                const feed = document.getElementById('liveThreatFeed');

                if (data.basarili) {
                    feed.innerHTML = `
                        <div style="padding:10px;background:var(--bg-card);border-radius:6px;margin-bottom:10px">
                            <div style="font-size:10px;color:var(--text-dim)">Feed Sayısı: ${data.feed_sayisi || 0}</div>
                            <div style="font-size:10px;color:var(--text-dim)">IOC Sayısı: ${data.ioc_cache || 0}</div>
                        </div>
                        <div style="color:var(--hud-green);font-size:11px">Tehdit istihbaratı aktif</div>
                    `;
                } else {
                    feed.innerHTML = '<div style="color:var(--accent-danger)">Veri yüklenemedi</div>';
                }
            } catch (e) {
                console.error('[THREAT] Yükleme hatası:', e);
            }
        }

        async function loadAPTGroups() {
            try {
                const res = await fetch('/api/threat-intel/apt-groups');
                const data = await res.json();
                const list = document.getElementById('aptGroupList');

                if (data.basarili && data.gruplar) {
                    list.innerHTML = data.gruplar.slice(0, 10).map(g => `
                        <div style="padding:10px;background:var(--bg-card);border-radius:6px;margin-bottom:8px">
                            <div style="font-size:12px;font-weight:bold;color:var(--accent-danger)">${g.ad || g.name}</div>
                            <div style="font-size:10px;color:var(--text-dim)">${g.ulke || g.country || 'Bilinmiyor'}</div>
                        </div>
                    `).join('');
                } else {
                    list.innerHTML = '<div style="color:var(--text-dim)">APT grupları yüklenemedi</div>';
                }
            } catch (e) {
                console.error('[APT] Yükleme hatası:', e);
            }
        }

        async function loadThreatFeeds() {
            document.getElementById('threatFeedsList').innerHTML = `
                <div style="padding:10px;background:var(--bg-card);border-radius:6px;margin-bottom:8px">
                    <div style="font-size:11px;color:var(--hud-cyan)">AlienVault OTX</div>
                    <div style="font-size:9px;color:var(--text-dim)">Açık Tehdit İstihbaratı</div>
                </div>
                <div style="padding:10px;background:var(--bg-card);border-radius:6px;margin-bottom:8px">
                    <div style="font-size:11px;color:var(--hud-cyan)">AbuseIPDB</div>
                    <div style="font-size:9px;color:var(--text-dim)">Kötü Amaçlı IP Veritabanı</div>
                </div>
                <div style="padding:10px;background:var(--bg-card);border-radius:6px;margin-bottom:8px">
                    <div style="font-size:11px;color:var(--hud-cyan)">URLhaus</div>
                    <div style="font-size:9px;color:var(--text-dim)">Zararlı URL Takibi</div>
                </div>
            `;
        }

        async function checkIOC() {
            const ioc = document.getElementById('iocCheckInput').value;
            if (!ioc) return alert('IOC gerekli');

            const resultDiv = document.getElementById('iocCheckResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div style="color:var(--text-dim)">Kontrol ediliyor...</div>';

            try {
                // IP mi domain mi?
                const isIP = /^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/.test(ioc);
                const endpoint = isIP ? `/api/threat-intel/check/ip/${ioc}` : `/api/threat-intel/check/domain/${ioc}`;

                const res = await fetch(endpoint);
                const data = await res.json();

                if (data.basarili) {
                    const riskColor = data.risk_skoru > 70 ? 'var(--accent-danger)' : data.risk_skoru > 40 ? 'var(--accent-warning)' : 'var(--hud-green)';
                    resultDiv.innerHTML = `
                        <div style="color:${riskColor};font-size:18px;font-weight:bold">Risk: ${data.risk_skoru || 0}%</div>
                        <div style="font-size:10px;color:var(--text-dim);margin-top:5px">${data.mesaj || 'Kontrol tamamlandı'}</div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div style="color:var(--accent-danger)">${data.hata || 'Kontrol başarısız'}</div>`;
                }
            } catch (e) {
                resultDiv.innerHTML = '<div style="color:var(--accent-danger)">Bağlantı hatası</div>';
            }
        }

        // PENTEST Popup Fonksiyonları
        function pentestPanelAc() {
            document.getElementById('pentestPopup').classList.add('active');
            loadPentestProjects();
        }

        function pentestPanelKapat() {
            document.getElementById('pentestPopup').classList.remove('active');
        }

        function pentestTabDegistir(tab) {
            document.querySelectorAll('#pentestPopup .cockpit-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#pentestPopup .cockpit-tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('pentestTab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');

            if (tab === 'stats') loadPentestStats();
        }

        async function loadPentestProjects() {
            try {
                const res = await fetch('/api/pentest/projeler');
                const data = await res.json();
                const list = document.getElementById('pentestProjectList');

                if (data.basarili && data.projeler && data.projeler.length > 0) {
                    list.innerHTML = data.projeler.map(p => `
                        <div class="pentest-project">
                            <div style="font-size:12px;font-weight:bold;color:var(--text-bright)">${p.ad}</div>
                            <div style="font-size:10px;color:var(--text-dim)">${p.hedef || 'Hedef tanımlı değil'}</div>
                            <div style="font-size:9px;color:var(--hud-cyan);margin-top:5px">${p.durum || 'Aktif'}</div>
                        </div>
                    `).join('');
                } else {
                    list.innerHTML = '<div style="text-align:center;color:var(--text-dim)">Proje bulunamadı</div>';
                }
            } catch (e) {
                console.error('[PENTEST] Yükleme hatası:', e);
            }
        }

        async function loadPentestStats() {
            try {
                const res = await fetch('/api/pentest/istatistikler');
                const data = await res.json();
                const stats = document.getElementById('pentestStats');

                if (data.basarili) {
                    stats.innerHTML = `
                        <div class="dashboard-grid">
                            <div class="dashboard-card">
                                <div class="card-value">${data.toplam_proje || 0}</div>
                                <div class="card-label">Proje</div>
                            </div>
                            <div class="dashboard-card">
                                <div class="card-value">${data.toplam_bulgu || 0}</div>
                                <div class="card-label">Bulgu</div>
                            </div>
                        </div>
                    `;
                } else {
                    stats.innerHTML = '<div style="color:var(--text-dim)">İstatistik yüklenemedi</div>';
                }
            } catch (e) {
                console.error('[PENTEST] Stats hatası:', e);
            }
        }

        function yeniPentestProjesi() {
            const ad = prompt('Proje adı:');
            if (!ad) return;
            alert('Yeni proje oluşturuldu: ' + ad);
        }

        // DASHBOARD Popup Fonksiyonları
        function dashboardPanelAc() {
            document.getElementById('dashboardPopup').classList.add('active');
            loadDashboardData();
        }

        function dashboardPanelKapat() {
            document.getElementById('dashboardPopup').classList.remove('active');
        }

        async function loadDashboardData() {
            try {
                const res = await fetch('/api/durum');
                const data = await res.json();

                document.getElementById('dashWifi').textContent = data.wifi?.aglar?.length || 0;
                document.getElementById('dashBluetooth').textContent = data.bluetooth?.cihazlar?.length || 0;
                document.getElementById('dashAttacks').textContent = data.saldirillar?.length || canliSaldirilar.length || 0;

                // AILYDIAN agent sayısı
                try {
                    const ailydianRes = await fetch('/api/ailydian/v2/status');
                    const ailydianData = await ailydianRes.json();
                    document.getElementById('dashAgents').textContent = ailydianData.toplam_agent || 214;
                } catch (e) {}

                document.getElementById('dashSystemStatus').innerHTML = `
                    <div>Sunucu: <span style="color:var(--hud-green)">Aktif</span></div>
                    <div>Ghost Mode: <span style="color:var(--hud-green)">Aktif</span></div>
                    <div>AILYDIAN: <span style="color:var(--hud-green)">Bağlı</span></div>
                `;
            } catch (e) {
                console.error('[DASHBOARD] Yükleme hatası:', e);
            }
        }

        // BEYIN Popup Fonksiyonları
        function beyinPanelAc() {
            document.getElementById('beyinPopup').classList.add('active');
            loadBeyinStatus();
        }

        function beyinPanelKapat() {
            document.getElementById('beyinPopup').classList.remove('active');
        }

        async function loadBeyinStatus() {
            try {
                const res = await fetch('/api/beyin/durum');
                const data = await res.json();

                if (data.basarili) {
                    const defcon = data.defcon || 5;
                    const defconEl = document.getElementById('defconLevel');
                    defconEl.textContent = defcon;
                    defconEl.className = 'defcon-level defcon-' + defcon;

                    const texts = ['KRİTİK', 'TEHLİKELİ', 'YÜKSEK ALARM', 'DİKKAT', 'NORMAL'];
                    document.getElementById('defconText').textContent = texts[defcon - 1] || 'NORMAL';

                    if (data.tehditler && data.tehditler.length > 0) {
                        document.getElementById('beyinThreatList').innerHTML = data.tehditler.slice(0, 5).map(t =>
                            `<div style="padding:5px 0;border-bottom:1px solid var(--border-subtle)">${t.tip || t.type}: ${t.aciklama || t.description || 'Tehdit algılandı'}</div>`
                        ).join('');
                    }
                }
            } catch (e) {
                console.error('[BEYIN] Yükleme hatası:', e);
            }
        }

        function beyinAnalizBaslat() {
            alert('Otonom analiz başlatılıyor...');
        }

        function defconDegistir() {
            const yeni = prompt('Yeni DEFCON seviyesi (1-5):');
            if (yeni && yeni >= 1 && yeni <= 5) {
                const defconEl = document.getElementById('defconLevel');
                defconEl.textContent = yeni;
                defconEl.className = 'defcon-level defcon-' + yeni;
            }
        }

        // VULN Popup Fonksiyonları
        function vulnPanelAc() {
            document.getElementById('vulnPopup').classList.add('active');
            loadVulnStats();
        }

        function vulnPanelKapat() {
            document.getElementById('vulnPopup').classList.remove('active');
        }

        async function loadVulnStats() {
            // Gerçek zafiyet istatistikleri API'den al
            try {
                const res = await fetch('/api/zafiyetler/liste');
                const data = await res.json();
                if (data.basarili && data.zafiyetler) {
                    const zafiyetler = data.zafiyetler;
                    const critical = zafiyetler.filter(z => z.ciddiyet === 'critical').length;
                    const high = zafiyetler.filter(z => z.ciddiyet === 'high').length;
                    const medium = zafiyetler.filter(z => z.ciddiyet === 'medium').length;
                    const low = zafiyetler.filter(z => z.ciddiyet === 'low').length;

                    document.getElementById('vulnCritical').textContent = critical;
                    document.getElementById('vulnHigh').textContent = high;
                    document.getElementById('vulnMedium').textContent = medium;
                    document.getElementById('vulnLow').textContent = low;
                } else {
                    // API'den veri gelmezse 0 göster
                    document.getElementById('vulnCritical').textContent = '0';
                    document.getElementById('vulnHigh').textContent = '0';
                    document.getElementById('vulnMedium').textContent = '0';
                    document.getElementById('vulnLow').textContent = '0';
                }
            } catch (e) {
                console.error('Zafiyet istatistikleri yüklenemedi:', e);
                document.getElementById('vulnCritical').textContent = '-';
                document.getElementById('vulnHigh').textContent = '-';
                document.getElementById('vulnMedium').textContent = '-';
                document.getElementById('vulnLow').textContent = '-';
            }
        }

        async function vulnTaramaBaslat() {
            const target = document.getElementById('vulnTargetInput').value;
            if (!target) return alert('Hedef gerekli');

            const list = document.getElementById('vulnList');
            list.innerHTML = '<div style="text-align:center;color:var(--text-dim)">Taranıyor...</div>';

            try {
                const res = await fetch('/api/ailydian/v2/recon', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({target, type: 'passive'})
                });
                const data = await res.json();

                if (data.basarili) {
                    list.innerHTML = `<pre style="font-size:10px;color:var(--text-normal)">${JSON.stringify(data.sonuc, null, 2)}</pre>`;
                } else {
                    list.innerHTML = '<div style="color:var(--accent-danger)">Tarama başarısız</div>';
                }
            } catch (e) {
                list.innerHTML = '<div style="color:var(--accent-danger)">Bağlantı hatası</div>';
            }
        }

        // mcpPanelAc fonksiyonunu LYDIAN butonu için override et
        const originalMcpPanelAc = typeof mcpPanelAc !== 'undefined' ? mcpPanelAc : null;
        function mcpPanelAcWrapper() {
            // Eğer ailydian popup tercih ediliyorsa
            ailydianPopupAc();
        }

        // Yeni buton fonksiyonları için alias'lar
        // LYDIAN butonu artık ailydianPopupAc çağırıyor (mcpPanelAc yerine)

        // ==================== DALGA SIGINT FUNCTIONS ====================

        // SIGINT State
        const sigintState = {
            isScanning: false,
            currentScanType: null,
            devices: { wifi: [], bluetooth: [], cell: [], iot: [] },
            threats: [],
            layers: {}
        };

        // Initialize SIGINT Layers
        function initSigintLayers() {
            if (!map) return;

            // WiFi Networks Layer
            sigintState.layers.wifi = L.markerClusterGroup({
                iconCreateFunction: (cluster) => {
                    const count = cluster.getChildCount();
                    return L.divIcon({
                        html: `<div style="background:linear-gradient(135deg,#00c896,#00a67d);border-radius:50%;width:36px;height:36px;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:12px;box-shadow:0 2px 8px rgba(0,200,150,0.5)"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M1 9l2 2c4.97-4.97 13.03-4.97 18 0l2-2C16.93 2.93 7.08 2.93 1 9zm8 8l3 3 3-3c-1.65-1.66-4.34-1.66-6 0zm-4-4l2 2c2.76-2.76 7.24-2.76 10 0l2-2C15.14 9.14 8.87 9.14 5 13z"/></svg>${count}</div>`,
                        className: 'sigint-cluster-wifi',
                        iconSize: [36, 36]
                    });
                },
                disableClusteringAtZoom: 18
            });

            // Bluetooth Devices Layer
            sigintState.layers.bluetooth = L.markerClusterGroup({
                iconCreateFunction: (cluster) => {
                    const count = cluster.getChildCount();
                    return L.divIcon({
                        html: `<div style="background:linear-gradient(135deg,#0088ff,#0066cc);border-radius:50%;width:36px;height:36px;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:12px;box-shadow:0 2px 8px rgba(0,136,255,0.5)"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M17.71 7.71L12 2h-1v7.59L6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 11 14.41V22h1l5.71-5.71-4.3-4.29 4.3-4.29zM13 5.83l1.88 1.88L13 9.59V5.83zm1.88 10.46L13 18.17v-3.76l1.88 1.88z"/></svg>${count}</div>`,
                        className: 'sigint-cluster-bt',
                        iconSize: [36, 36]
                    });
                },
                disableClusteringAtZoom: 18
            });

            // Cell Towers Layer
            sigintState.layers.cell = L.layerGroup();

            // IoT Devices Layer
            sigintState.layers.iot = L.layerGroup();

            // Threat Heatmap Layer
            if (typeof L.heatLayer !== 'undefined') {
                sigintState.layers.heatmap = L.heatLayer([], {
                    radius: 25,
                    blur: 15,
                    gradient: {
                        0.0: '#00ff88',
                        0.3: '#ffcc00',
                        0.6: '#ff8800',
                        0.8: '#ff3355',
                        1.0: '#cc0033'
                    }
                });
            }

            // Add default layers to map
            if (map) {
                map.addLayer(sigintState.layers.wifi);
                map.addLayer(sigintState.layers.bluetooth);
                map.addLayer(sigintState.layers.cell);
            }

            console.log('[SIGINT] Katmanlar başlatıldı');
        }

        // Toggle SIGINT Panel
        function toggleSigintPanel() {
            const panel = document.getElementById('sigint-panel');
            if (!panel) return;

            if (panel.classList.contains('active')) {
                panel.classList.remove('active');
            } else {
                panel.classList.add('active');
                // Initialize layers if not done
                if (Object.keys(sigintState.layers).length === 0) {
                    initSigintLayers();
                }
                // Load initial stats
                loadSigintStats();
            }
        }

        // Start SIGINT Scan
        async function startSigintScan(scanType) {
            const btn = document.getElementById(`btn-${scanType}`);
            if (!btn) return;

            btn.classList.add('scanning');
            sigintState.isScanning = true;
            sigintState.currentScanType = scanType;

            // Get current map center for location
            let lat = 41.0082, lon = 28.9784; // Default: Istanbul
            if (map) {
                const center = map.getCenter();
                lat = center.lat;
                lon = center.lng;
            }

            const stealthLevel = document.getElementById('sigint-stealth')?.value || 'normal';

            try {
                let endpoint = '/api/sigint/scan/';
                let body = { latitude: lat, longitude: lon, stealth_level: stealthLevel };

                if (scanType === 'all') {
                    endpoint = '/api/sigint/scan/full';
                } else if (scanType === 'wifi') {
                    endpoint = '/api/sigint/wifi/scan';
                } else if (scanType === 'bluetooth') {
                    endpoint = '/api/sigint/bluetooth/scan';
                } else if (scanType === 'cell') {
                    endpoint = '/api/sigint/cell/scan';
                }

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const data = await response.json();

                if (data.success || data.basarili) {
                    // Process scan results
                    processSigintResults(scanType, data);
                    addSigintAlert('low', `${scanType.toUpperCase()} taraması tamamlandı`, `${data.total || data.toplam || 0} cihaz bulundu`);
                } else {
                    addSigintAlert('high', `${scanType.toUpperCase()} tarama hatası`, data.error || data.hata || 'Bilinmeyen hata');
                }
            } catch (error) {
                console.error('[SIGINT] Tarama hatası:', error);
                addSigintAlert('critical', 'Bağlantı Hatası', error.message);
            } finally {
                btn.classList.remove('scanning');
                sigintState.isScanning = false;
                sigintState.currentScanType = null;
            }
        }

        // Process SIGINT Results
        function processSigintResults(scanType, data) {
            const devices = data.devices || data.cihazlar || [];
            let wifiCount = 0, btCount = 0, cellCount = 0;

            if (scanType === 'wifi' || scanType === 'all') {
                const wifiDevices = devices.filter(d => d.device_type === 'wifi' || d.tip === 'wifi') || data.wifi?.networks || [];
                wifiCount = Array.isArray(wifiDevices) ? wifiDevices.length : (data.wifi?.total || 0);
                updateSigintLayer('wifi', wifiDevices);
                document.getElementById('sigint-wifi-count').textContent = wifiCount;
                // Sol panel metriğini güncelle
                const mWifi = document.getElementById('mWifi');
                if (mWifi) mWifi.textContent = wifiCount;
            }

            if (scanType === 'bluetooth' || scanType === 'all') {
                const btDevices = devices.filter(d => d.device_type === 'bluetooth' || d.tip === 'bluetooth') || data.bluetooth?.devices || [];
                btCount = Array.isArray(btDevices) ? btDevices.length : (data.bluetooth?.total || 0);
                updateSigintLayer('bluetooth', btDevices);
                document.getElementById('sigint-bt-count').textContent = btCount;
                // Sol panel metriğini güncelle
                const mBt = document.getElementById('mBt');
                if (mBt) mBt.textContent = btCount;
            }

            if (scanType === 'cell' || scanType === 'all') {
                const cellDevices = devices.filter(d => d.device_type === 'cell_tower' || d.tip === 'baz') || data.cell?.towers || [];
                cellCount = Array.isArray(cellDevices) ? cellDevices.length : (data.cell?.total || 0);
                updateSigintLayer('cell', cellDevices);
                document.getElementById('sigint-cell-count').textContent = cellCount;
                // Sol panel metriğini güncelle
                const mBaz = document.getElementById('mBaz');
                if (mBaz) mBaz.textContent = cellCount;
            }

            // Update threat count
            const threats = data.threats || data.tehditler || [];
            document.getElementById('sigint-threat-count').textContent = threats.length;

            // Update heatmap if enabled
            if (document.getElementById('layer-heatmap')?.checked) {
                updateThreatHeatmap(devices);
            }

            console.log(`[SIGINT] Tarama tamamlandı: WiFi=${wifiCount}, BT=${btCount}, Baz=${cellCount}`);
        }

        // Update SIGINT Layer
        function updateSigintLayer(layerType, devices) {
            const layer = sigintState.layers[layerType];
            if (!layer) return;

            layer.clearLayers();

            devices.forEach(device => {
                const lat = device.latitude || device.lat || device.konum?.lat;
                const lon = device.longitude || device.lon || device.lng || device.konum?.lon;

                if (!lat || !lon) return;

                const marker = createSigintMarker(device, layerType);
                if (marker) {
                    layer.addLayer(marker);
                }
            });
        }

        // Create SIGINT Marker
        function createSigintMarker(device, type) {
            const lat = device.latitude || device.lat || device.konum?.lat;
            const lon = device.longitude || device.lon || device.lng || device.konum?.lon;

            if (!lat || !lon) return null;

            let iconHtml, iconColor;
            const name = device.name || device.isim || device.ssid || 'Bilinmeyen';
            const threatLevel = device.threat_level || device.tehdit_seviyesi || 'low';

            switch (type) {
                case 'wifi':
                    iconColor = threatLevel === 'critical' ? '#ff3355' : threatLevel === 'high' ? '#ff8800' : '#00c896';
                    iconHtml = `<div style="background:${iconColor};border-radius:50%;width:28px;height:28px;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px ${iconColor}80"><svg width="14" height="14" viewBox="0 0 24 24" fill="white"><path d="M1 9l2 2c4.97-4.97 13.03-4.97 18 0l2-2C16.93 2.93 7.08 2.93 1 9zm8 8l3 3 3-3c-1.65-1.66-4.34-1.66-6 0zm-4-4l2 2c2.76-2.76 7.24-2.76 10 0l2-2C15.14 9.14 8.87 9.14 5 13z"/></svg></div>`;
                    break;
                case 'bluetooth':
                    iconColor = threatLevel === 'critical' ? '#ff3355' : threatLevel === 'high' ? '#ff8800' : '#0088ff';
                    iconHtml = `<div style="background:${iconColor};border-radius:50%;width:28px;height:28px;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px ${iconColor}80"><svg width="14" height="14" viewBox="0 0 24 24" fill="white"><path d="M17.71 7.71L12 2h-1v7.59L6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 11 14.41V22h1l5.71-5.71-4.3-4.29 4.3-4.29zM13 5.83l1.88 1.88L13 9.59V5.83zm1.88 10.46L13 18.17v-3.76l1.88 1.88z"/></svg></div>`;
                    break;
                case 'cell':
                    iconColor = '#ff6600';
                    iconHtml = `<div style="background:${iconColor};border-radius:8px;width:32px;height:32px;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px ${iconColor}80"><svg width="16" height="16" viewBox="0 0 24 24" fill="white"><path d="M17.7 7.7L12 2 6.3 7.7c-3.1 3.1-3.1 8.2 0 11.3 1.6 1.6 3.6 2.3 5.7 2.3s4.1-.8 5.7-2.3c3.1-3.1 3.1-8.2 0-11.3z"/></svg></div>`;
                    break;
                case 'iot':
                    iconColor = '#aa44ff';
                    iconHtml = `<div style="background:${iconColor};border-radius:6px;width:26px;height:26px;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px ${iconColor}80"><svg width="12" height="12" viewBox="0 0 24 24" fill="white"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/></svg></div>`;
                    break;
                default:
                    return null;
            }

            const icon = L.divIcon({
                html: iconHtml,
                className: 'sigint-marker',
                iconSize: [28, 28],
                iconAnchor: [14, 14]
            });

            const marker = L.marker([lat, lon], { icon });

            // Popup content
            const popupContent = createDevicePopup(device, type);
            marker.bindPopup(popupContent, {
                className: 'sigint-popup',
                maxWidth: 280
            });

            return marker;
        }

        // Create Device Popup
        function createDevicePopup(device, type) {
            const name = device.name || device.isim || device.ssid || 'Bilinmeyen';
            const mac = device.mac_address || device.mac || device.bssid || '-';
            const vendor = device.vendor || device.uretici || '-';
            const category = device.category || device.kategori || type;
            const threatLevel = device.threat_level || device.tehdit_seviyesi || 'low';
            const signal = device.signal_strength || device.sinyal || device.rssi || '-';
            const lastSeen = device.last_seen || device.son_gorulme || new Date().toLocaleString('tr-TR');

            const threatColors = {
                critical: '#ff3355',
                high: '#ff8800',
                medium: '#ffcc00',
                low: '#00c896',
                info: '#0088ff'
            };

            return `
                <div class="sigint-device-popup">
                    <div class="device-header">
                        <div class="device-icon" style="background:${threatColors[threatLevel]}20;color:${threatColors[threatLevel]}">
                            ${type === 'wifi' ? '📶' : type === 'bluetooth' ? '🔵' : type === 'cell' ? '📡' : '🔌'}
                        </div>
                        <div>
                            <div class="device-name">${name}</div>
                            <div class="device-type">${category.toUpperCase()}</div>
                        </div>
                    </div>
                    <div class="device-info">
                        <div><span>MAC:</span><span style="font-family:monospace;font-size:10px">${mac}</span></div>
                        <div><span>Üretici:</span><span>${vendor}</span></div>
                        <div><span>Sinyal:</span><span>${signal} dBm</span></div>
                        <div><span>Son Görülme:</span><span>${lastSeen}</span></div>
                        <div><span>Tehdit:</span><span class="threat-badge ${threatLevel}">${threatLevel.toUpperCase()}</span></div>
                    </div>
                </div>
            `;
        }

        // Toggle SIGINT Layer
        function toggleSigintLayer(layerType) {
            const checkbox = document.getElementById(`layer-${layerType}`);
            const layer = sigintState.layers[layerType];

            if (!map || !layer) return;

            if (checkbox?.checked) {
                map.addLayer(layer);
            } else {
                map.removeLayer(layer);
            }
        }

        // Update Threat Heatmap
        function updateThreatHeatmap(devices) {
            if (!sigintState.layers.heatmap) return;

            const heatData = [];
            devices.forEach(device => {
                const lat = device.latitude || device.lat;
                const lon = device.longitude || device.lon || device.lng;
                const risk = device.risk_score || device.risk || 0;

                if (lat && lon) {
                    heatData.push([lat, lon, risk / 100]);
                }
            });

            sigintState.layers.heatmap.setLatLngs(heatData);
        }

        // Add SIGINT Alert
        function addSigintAlert(severity, title, message) {
            const alertsContainer = document.getElementById('sigint-alerts');
            if (!alertsContainer) return;

            const alertHtml = `
                <div class="sigint-alert-item ${severity}">
                    <strong>${title}</strong><br>
                    <span>${message}</span>
                    <div class="sigint-alert-time">${new Date().toLocaleTimeString('tr-TR')}</div>
                </div>
            `;

            // Remove placeholder if exists
            const placeholder = alertsContainer.querySelector('div[style*="text-align:center"]');
            if (placeholder) {
                placeholder.remove();
            }

            alertsContainer.insertAdjacentHTML('afterbegin', alertHtml);

            // Keep only last 10 alerts
            while (alertsContainer.children.length > 10) {
                alertsContainer.removeChild(alertsContainer.lastChild);
            }
        }

        // Load SIGINT Stats
        async function loadSigintStats() {
            try {
                const response = await fetch('/api/sigint/status');
                const data = await response.json();

                if (data.success || data.basarili) {
                    const durum = data.durum || data.status || {};
                    const cihazlar = durum.cihaz_turleri || {};
                    const tehditler = durum.tehditler || {};

                    // SIGINT panel istatistikleri
                    document.getElementById('sigint-wifi-count').textContent = cihazlar.wifi || durum.toplam_cihaz || 0;
                    document.getElementById('sigint-bt-count').textContent = cihazlar.bluetooth || 0;
                    document.getElementById('sigint-cell-count').textContent = cihazlar.cell_tower || 0;
                    document.getElementById('sigint-threat-count').textContent = tehditler.total || 0;

                    // Sol panel metriklerini de güncelle
                    const mWifi = document.getElementById('mWifi');
                    const mBt = document.getElementById('mBt');
                    const mBaz = document.getElementById('mBaz');
                    if (mWifi) mWifi.textContent = cihazlar.wifi || 0;
                    if (mBt) mBt.textContent = cihazlar.bluetooth || 0;
                    if (mBaz) mBaz.textContent = cihazlar.cell_tower || 0;
                }
            } catch (error) {
                console.log('[SIGINT] İstatistik yükleme hatası:', error);
            }
        }

        // Export SIGINT Data
        async function exportSigintData() {
            try {
                const response = await fetch('/api/sigint/export/json');
                const blob = await response.blob();

                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `sigint_export_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                addSigintAlert('low', 'Dışa Aktarma', 'Veriler başarıyla indirildi');
            } catch (error) {
                addSigintAlert('high', 'Dışa Aktarma Hatası', error.message);
            }
        }

        // Clear SIGINT Data
        async function clearSigintData() {
            if (!confirm('Tüm SIGINT verilerini silmek istediğinizden emin misiniz?')) return;

            try {
                // Clear map layers
                Object.values(sigintState.layers).forEach(layer => {
                    if (layer && layer.clearLayers) {
                        layer.clearLayers();
                    }
                });

                // Reset stats
                document.getElementById('sigint-wifi-count').textContent = '0';
                document.getElementById('sigint-bt-count').textContent = '0';
                document.getElementById('sigint-cell-count').textContent = '0';
                document.getElementById('sigint-threat-count').textContent = '0';

                // Clear alerts
                const alertsContainer = document.getElementById('sigint-alerts');
                if (alertsContainer) {
                    alertsContainer.innerHTML = '<div style="text-align:center;color:rgba(255,255,255,0.4);font-size:10px;padding:15px;">Tarama başlatıldığında tehditler burada görünecek</div>';
                }

                addSigintAlert('low', 'Temizleme', 'Tüm SIGINT verileri temizlendi');
            } catch (error) {
                addSigintAlert('high', 'Temizleme Hatası', error.message);
            }
        }

        // Initialize SIGINT on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Wait for map to be ready
            setTimeout(() => {
                if (typeof map !== 'undefined' && map) {
                    initSigintLayers();
                    console.log('[SIGINT] DALGA SIGINT hazır');
                }
            }, 2000);
        });

        // ==================== END SIGINT FUNCTIONS ====================

        // === TEMA SİSTEMİ ===
        function initTheme() {
            const saved = localStorage.getItem('tsunami-theme') || 'cyan';
            document.documentElement.setAttribute('data-theme', saved);
            updateThemeButtons();
        }
        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('tsunami-theme', theme);
            updateThemeButtons();
        }
        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme') || 'cyan';
            setTheme(current === 'cyan' ? 'cockpit-bw' : 'cyan');
        }
        function updateThemeButtons() {
            const current = document.documentElement.getAttribute('data-theme') || 'cyan';
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.theme === current);
            });
        }
        // Tema artık header'da, floating butona gerek yok
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            checkStealthStatus();
            syncToggleStates();
            // Stealth durumu periyodik guncelle (30s)
            setInterval(checkStealthStatus, 30000);
            // Stealth rotasini periyodik guncelle (60s)
            setInterval(loadStealthRoute, 60000);
        });
        document.addEventListener('keydown', (e) => { if (e.ctrlKey && e.shiftKey && e.key === 'T') { e.preventDefault(); toggleTheme(); } });

        // ══════════════════════════════════════════════════════════════════════════════
        // 🎖️ SİBER KOMUTA MERKEZİ v5.0 - PENTAGON SEVİYESİ FONKSİYONLARI
        // ══════════════════════════════════════════════════════════════════════════════

        // Widget aç/kapa
        function toggleSiberWidget() {
            const body = document.getElementById('siberWidgetBody');
            const arrow = document.getElementById('siberWidgetArrow');
            if (body && arrow) {
                const isVisible = body.style.display !== 'none';
                body.style.display = isVisible ? 'none' : 'block';
                arrow.textContent = isVisible ? '▶' : '▼';
            }
        }

        // Hızlı OSINT Arama
        async function siberHizliOSINT() {
            const hedef = document.getElementById('siberHizliHedef')?.value?.trim();
            if (!hedef) {
                termLog('Hedef belirtilmedi!', 'err');
                return;
            }

            termLog(`[SİBER] OSINT başlatılıyor: ${hedef}`, 'info');

            try {
                if (typeof socket !== 'undefined' && socket.connected) {
                    socket.emit('siber_osint_baslat', { hedef: hedef });
                    termLog('[SİBER] OSINT isteği gönderildi', 'ok');
                } else {
                    // HTTP fallback
                    const response = await fetch('/api/siber/osint', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ hedef: hedef })
                    });
                    const data = await response.json();
                    if (data.success) {
                        termLog(`[SİBER] OSINT tamamlandı: ${JSON.stringify(data.sonuc).slice(0, 100)}...`, 'ok');
                    } else {
                        termLog(`[SİBER] OSINT hatası: ${data.error}`, 'err');
                    }
                }
            } catch (e) {
                termLog(`[SİBER] OSINT hatası: ${e.message}`, 'err');
            }
        }

        // Tehdit Avı Başlat
        async function siberTehditAviBaslat() {
            termLog('[SİBER] 🎯 Tehdit avı başlatılıyor...', 'info');

            try {
                if (typeof socket !== 'undefined' && socket.connected) {
                    socket.emit('siber_tehdit_avi');
                    termLog('[SİBER] Tehdit avı başlatıldı - 22 ajan aktif', 'ok');
                } else {
                    const response = await fetch('/api/siber/tehdit-avi', { method: 'POST' });
                    const data = await response.json();
                    termLog(`[SİBER] Tehdit avı: ${data.message || 'Başlatıldı'}`, 'ok');
                }

                // UI güncelle
                const tehditEl = document.getElementById('siberTehditSayisi');
                if (tehditEl) tehditEl.textContent = '...';

            } catch (e) {
                termLog(`[SİBER] Tehdit avı hatası: ${e.message}`, 'err');
            }
        }

        // Hava Sahası Katmanı
        async function siberHavaSahasiAc() {
            termLog('[SİBER] ✈️ Hava sahası taraması başlatılıyor...', 'info');

            try {
                // OpenSky veya ADSB.lol API
                const response = await fetch('https://opensky-network.org/api/states/all?lamin=35&lomin=25&lamax=43&lomax=45');
                const data = await response.json();

                if (data && data.states) {
                    const ucaklar = data.states.slice(0, 50); // İlk 50 uçak
                    termLog(`[SİBER] ${ucaklar.length} uçak tespit edildi`, 'ok');

                    // Haritaya marker ekle
                    ucaklar.forEach(ucak => {
                        if (ucak[5] && ucak[6]) { // lon, lat
                            const marker = L.marker([ucak[6], ucak[5]], {
                                icon: L.divIcon({
                                    className: 'aircraft-marker',
                                    html: `<div style="color:#00b4ff;font-size:16px;transform:rotate(${ucak[10] || 0}deg);">✈</div>`,
                                    iconSize: [20, 20]
                                })
                            }).addTo(map);
                            marker.bindPopup(`<b>${ucak[1] || 'N/A'}</b><br>Ülke: ${ucak[2] || 'N/A'}<br>İrtifa: ${ucak[7] || 'N/A'}m`);
                        }
                    });
                }
            } catch (e) {
                termLog(`[SİBER] Hava sahası hatası: ${e.message}`, 'err');
                // Fallback: simüle
                termLog('[SİBER] Demo modda çalışıyor', 'info');
            }
        }

        // ISS Takip
        async function siberISSBaslat() {
            termLog('[SİBER] 🛰️ ISS takibi başlatılıyor...', 'info');

            try {
                const response = await fetch('http://api.open-notify.org/iss-now.json');
                const data = await response.json();

                if (data.iss_position) {
                    const lat = parseFloat(data.iss_position.latitude);
                    const lon = parseFloat(data.iss_position.longitude);

                    termLog(`[SİBER] ISS Konumu: ${lat.toFixed(4)}, ${lon.toFixed(4)}`, 'ok');

                    // ISS marker
                    const issMarker = L.marker([lat, lon], {
                        icon: L.divIcon({
                            className: 'iss-marker',
                            html: '<div style="color:#8855ff;font-size:24px;text-shadow:0 0 10px #8855ff;">🛰️</div>',
                            iconSize: [30, 30]
                        })
                    }).addTo(map);
                    issMarker.bindPopup('<b>ISS - Uluslararası Uzay İstasyonu</b><br>Canlı konum takibi');

                    map.setView([lat, lon], 4);
                }
            } catch (e) {
                termLog(`[SİBER] ISS hatası: ${e.message}`, 'err');
            }
        }

        // GROQ AI Sorgula
        async function siberGroqSor() {
            const soru = prompt('GROQ AI\'ya sorunuz:');
            if (!soru) return;

            termLog(`[SİBER] 🤖 GROQ sorgulanıyor: ${soru}`, 'info');

            try {
                const response = await fetch('/api/siber/groq', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ soru: soru })
                });
                const data = await response.json();

                if (data.success) {
                    termLog(`[GROQ] ${data.cevap}`, 'ok');
                    alert(`GROQ Cevap:\n\n${data.cevap}`);
                } else {
                    termLog(`[GROQ] Hata: ${data.error}`, 'err');
                }
            } catch (e) {
                termLog(`[GROQ] Hata: ${e.message}`, 'err');
            }
        }

        // Pentest Başlat
        async function siberPentestBaslat() {
            const hedef = prompt('Pentest hedefi (IP/Domain):');
            if (!hedef) return;

            termLog(`[SİBER] 💀 Pentest başlatılıyor: ${hedef}`, 'info');

            try {
                const response = await fetch('/api/siber/pentest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ hedef: hedef })
                });
                const data = await response.json();

                if (data.success) {
                    termLog(`[PENTEST] Tarama başlatıldı: ${data.message}`, 'ok');
                } else {
                    termLog(`[PENTEST] Hata: ${data.error}`, 'err');
                }
            } catch (e) {
                termLog(`[PENTEST] Hata: ${e.message}`, 'err');
            }
        }

        // Savunma Aktif Et
        async function siberSavunmaAktif() {
            termLog('[SİBER] 🛡️ Savunma modları aktif ediliyor...', 'info');

            try {
                const response = await fetch('/api/siber/savunma', { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    termLog('[SAVUNMA] Tüm savunma katmanları aktif', 'ok');
                    termLog('[SAVUNMA] - IDS/IPS: Aktif', 'ok');
                    termLog('[SAVUNMA] - WAF: Aktif', 'ok');
                    termLog('[SAVUNMA] - DDoS Koruma: Aktif', 'ok');
                } else {
                    termLog(`[SAVUNMA] Hata: ${data.error}`, 'err');
                }
            } catch (e) {
                termLog(`[SAVUNMA] Hata: ${e.message}`, 'err');
            }
        }

        // Socket event handlers (handled by class handler at ~line 15934)

        // Sayfa yüklendiğinde widget'ı zorla görünür kıl
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                const widget = document.getElementById('siberKomutaWidget');
                if (widget) {
                    widget.style.display = 'block';
                    widget.style.visibility = 'visible';
                    widget.style.opacity = '1';
                    console.log('[SİBER] Widget zorla görünür yapıldı');
                }

                // Socket üzerinden durum iste
                if (typeof socket !== 'undefined' && socket.connected) {
                    socket.emit('siber_durum_iste');
                }
            }, 1000);
        });

        console.log('[SİBER KOMUTA] v5.0 Pentagon Seviyesi - Fonksiyonlar yüklendi');

        // ══════════════════════════════════════════════════════════════════════════════
        // 🎖️ SİBER FLOATING WIDGET FONKSİYONLARI
        // ══════════════════════════════════════════════════════════════════════════════

        function toggleSiberFloating() {
            const body = document.getElementById('siberFloatingBody');
            const arrow = document.getElementById('siberFloatingArrow');
            if (body) {
                const isVisible = body.style.display !== 'none';
                body.style.display = isVisible ? 'none' : 'block';
                if (arrow) arrow.textContent = isVisible ? '▶' : '▼';
            }
        }

        async function sfOSINT() {
            const hedef = document.getElementById('sfHedef')?.value?.trim();
            if (!hedef) { alert('Hedef giriniz!'); return; }
            termLog(`[SİBER] OSINT: ${hedef}`, 'info');
            try {
                if (typeof socket !== 'undefined' && socket.connected) {
                    socket.emit('siber_osint_baslat', { hedef });
                } else {
                    const r = await fetch('/api/siber/osint', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({hedef}) });
                    const d = await r.json();
                    termLog(`[OSINT] ${d.success ? 'Tamamlandı' : d.error}`, d.success ? 'ok' : 'err');
                }
            } catch(e) { termLog(`[OSINT] Hata: ${e.message}`, 'err'); }
        }

        async function sfTehditAvi() {
            termLog('[SİBER] 🎯 Tehdit avı başlatılıyor - 22 ajan aktif...', 'info');
            try {
                if (typeof socket !== 'undefined' && socket.connected) {
                    socket.emit('siber_tehdit_avi');
                } else {
                    const r = await fetch('/api/siber/tehdit-avi', { method: 'POST' });
                    const d = await r.json();
                    termLog(`[TEHDİT AVI] ${d.message || 'Başlatıldı'}`, 'ok');
                }
                document.getElementById('sfTehdit').textContent = '...';
            } catch(e) { termLog(`[TEHDİT] Hata: ${e.message}`, 'err'); }
        }

        async function sfHavaSahasi() {
            termLog('[SİBER] ✈️ Hava sahası taraması...', 'info');
            try {
                const r = await fetch('https://opensky-network.org/api/states/all?lamin=35&lomin=25&lamax=43&lomax=45');
                const d = await r.json();
                if (d?.states) {
                    const ucaklar = d.states.slice(0, 30);
                    termLog(`[HAVA] ${ucaklar.length} uçak tespit edildi`, 'ok');
                    ucaklar.forEach(u => {
                        if (u[5] && u[6] && typeof map !== 'undefined') {
                            L.marker([u[6], u[5]], {
                                icon: L.divIcon({ className: 'aircraft-m', html: `<div style="color:#00b4ff;font-size:14px;transform:rotate(${u[10]||0}deg);">✈</div>`, iconSize: [16,16] })
                            }).addTo(map).bindPopup(`<b>${u[1]||'N/A'}</b><br>${u[2]||''}<br>Alt: ${u[7]||'?'}m`);
                        }
                    });
                }
            } catch(e) { termLog(`[HAVA] Hata: ${e.message}`, 'err'); }
        }

        async function sfISS() {
            termLog('[SİBER] 🛰️ ISS takibi...', 'info');
            try {
                const r = await fetch('http://api.open-notify.org/iss-now.json');
                const d = await r.json();
                if (d?.iss_position) {
                    const lat = parseFloat(d.iss_position.latitude);
                    const lon = parseFloat(d.iss_position.longitude);
                    termLog(`[ISS] Konum: ${lat.toFixed(2)}, ${lon.toFixed(2)}`, 'ok');
                    if (typeof map !== 'undefined') {
                        L.marker([lat, lon], {
                            icon: L.divIcon({ className: 'iss-m', html: '<div style="color:#8855ff;font-size:20px;">🛰️</div>', iconSize: [24,24] })
                        }).addTo(map).bindPopup('<b>ISS</b><br>Uluslararası Uzay İstasyonu');
                        map.setView([lat, lon], 4);
                    }
                }
            } catch(e) { termLog(`[ISS] Hata: ${e.message}`, 'err'); }
        }

        async function sfGroq() {
            const soru = prompt('GROQ AI sorusu:');
            if (!soru) return;
            termLog(`[GROQ] Sorgulanıyor: ${soru}`, 'info');
            try {
                const r = await fetch('/api/siber/groq', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({soru}) });
                const d = await r.json();
                if (d.success) { termLog(`[GROQ] ${d.cevap}`, 'ok'); alert('GROQ: ' + d.cevap); }
                else { termLog(`[GROQ] ${d.error}`, 'err'); }
            } catch(e) { termLog(`[GROQ] Hata: ${e.message}`, 'err'); }
        }

        async function sfPentest() {
            const hedef = prompt('Pentest hedefi (IP/Domain):');
            if (!hedef) return;
            termLog(`[PENTEST] 💀 Başlatılıyor: ${hedef}`, 'info');
            try {
                const r = await fetch('/api/siber/pentest', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({hedef}) });
                const d = await r.json();
                termLog(`[PENTEST] ${d.success ? d.message : d.error}`, d.success ? 'ok' : 'err');
            } catch(e) { termLog(`[PENTEST] Hata: ${e.message}`, 'err'); }
        }

        async function sfSavunma() {
            termLog('[SİBER] 🛡️ Savunma modları aktif ediliyor...', 'info');
            try {
                const r = await fetch('/api/siber/savunma', { method: 'POST' });
                const d = await r.json();
                if (d.success) {
                    termLog('[SAVUNMA] IDS/IPS: Aktif', 'ok');
                    termLog('[SAVUNMA] WAF: Aktif', 'ok');
                    termLog('[SAVUNMA] DDoS Koruma: Aktif', 'ok');
                }
            } catch(e) { termLog(`[SAVUNMA] Hata: ${e.message}`, 'err'); }
        }

        // Sayfa yüklendiğinde floating widget'ı kontrol et
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                const fw = document.getElementById('siberFloatingWidget');
                if (fw) {
                    fw.style.display = 'block';
                    fw.style.visibility = 'visible';
                    fw.style.opacity = '1';
                    console.log('[SİBER FLOATING] Widget aktif - sağ alt köşede');
                } else {
                    console.warn('[SİBER FLOATING] Widget bulunamadı!');
                }
            }, 500);
        });

        console.log('[SİBER FLOATING] Fonksiyonlar yüklendi');

        // ══════════════════════════════════════════════════════════════════════════════
        // 🎖️ SİBER KOMUTA PANEL FONKSİYONLARI (Header Butonu için)
        // ══════════════════════════════════════════════════════════════════════════════

        function toggleSiberKomutaPanel() {
            const panel = document.getElementById('siberKomutaPanel');
            if (panel) {
                const isVisible = panel.style.display !== 'none';
                panel.style.display = isVisible ? 'none' : 'block';
                if (!isVisible) {
                    skDurumGuncelle();
                }
                console.log('[SİBER] Panel', isVisible ? 'kapatıldı' : 'açıldı');
            }
        }

        // ══════════════════════════════════════════════════════════════════════════════
        // 🎖️ SİBER KOMUTA POPUP FONKSİYONLARI (Sağ Alt Popup)
        // ══════════════════════════════════════════════════════════════════════════════

        function toggleSiberKomutaPopup() {
            const popup = document.getElementById('siberKomutaPopup');
            if (popup) {
                popup.classList.toggle('show');
                if (popup.classList.contains('show')) {
                    skpDurumGuncelle();
                    termLog('[SİBER] 🎖️ Siber Komuta popup açıldı', 'info');
                }
            }
        }

        async function skpDurumGuncelle() {
            try {
                const response = await fetch('/api/siber/durum');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        document.getElementById('skpAjanSayisi').textContent = data.ajan_sayisi || 22;
                        document.getElementById('skpOpSayisi').textContent = data.operasyon_sayisi || 0;
                        document.getElementById('skpTehditSayisi').textContent = data.tehdit_sayisi || 0;
                        document.getElementById('skpGroqDurum').textContent = data.groq_aktif ? '●' : '○';
                        document.getElementById('skpGroqDurum').style.color = data.groq_aktif ? '#00ff88' : '#666';
                    }
                }
            } catch(e) {
                console.log('[SİBER] Durum güncelleme:', e.message);
            }
        }

        async function skpOSINTBaslat() {
            const hedef = document.getElementById('skpOsintHedef')?.value?.trim();
            if (!hedef) {
                alert('Hedef giriniz! (IP, Domain, Hash veya Email)');
                return;
            }

            termLog(`[SİBER] 🔍 OSINT başlatılıyor: ${hedef}`, 'info');

            try {
                const response = await fetch('/api/siber/osint', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ hedef: hedef })
                });
                const data = await response.json();

                if (data.success) {
                    termLog(`[OSINT] ✓ Sonuç alındı`, 'ok');
                    if (data.sonuc) {
                        Object.entries(data.sonuc).forEach(([k, v]) => {
                            if (v && typeof v === 'object') {
                                termLog(`  ${k}: ${JSON.stringify(v).slice(0, 100)}...`, 'info');
                            } else if (v) {
                                termLog(`  ${k}: ${v}`, 'info');
                            }
                        });
                    }
                } else {
                    termLog(`[OSINT] ✗ ${data.error || 'Hata'}`, 'err');
                }
            } catch(e) {
                termLog(`[OSINT] Hata: ${e.message}`, 'err');
            }
        }

        async function skpTehditAvi() {
            termLog('[SİBER] 🎯 OTONOM TEHDİT AVI BAŞLATILIYOR...', 'info');
            termLog('[SİBER] 22 Pentagon ajanı aktif edildi', 'ok');

            try {
                const response = await fetch('/api/siber/tehdit-avi', { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    termLog(`[TEHDİT AVI] ✓ ${data.message || 'Başlatıldı'}`, 'ok');
                    if (data.bulunan_tehditler) {
                        document.getElementById('skpTehditSayisi').textContent = data.bulunan_tehditler;
                    }
                    if (data.sonuclar) {
                        data.sonuclar.forEach(s => termLog(`  → ${s}`, 'info'));
                    }
                }
            } catch(e) {
                termLog(`[TEHDİT AVI] Hata: ${e.message}`, 'err');
            }
        }

        async function skpHavaSahasi() {
            termLog('[SİBER] ✈️ HAVA SAHASI TARAMASI...', 'info');

            try {
                const response = await fetch('https://opensky-network.org/api/states/all?lamin=35&lomin=25&lamax=43&lomax=45');
                const data = await response.json();

                if (data && data.states) {
                    const ucaklar = data.states.slice(0, 50);
                    termLog(`[HAVA] ${ucaklar.length} uçak tespit edildi`, 'ok');

                    let askeriSayac = 0;
                    ucaklar.forEach(ucak => {
                        if (ucak[5] && ucak[6] && typeof map !== 'undefined') {
                            const callsign = ucak[1] || '';
                            const isAskeri = /^(TUR|THK|TCG|TUAF|RSD)/i.test(callsign);
                            if (isAskeri) askeriSayac++;

                            const renk = isAskeri ? '#ff3355' : '#00b4ff';
                            L.marker([ucak[6], ucak[5]], {
                                icon: L.divIcon({
                                    className: 'aircraft-marker',
                                    html: `<div style="color:${renk};font-size:16px;transform:rotate(${ucak[10] || 0}deg);filter:drop-shadow(0 0 3px ${renk});">✈</div>`,
                                    iconSize: [20, 20]
                                })
                            }).addTo(map).bindPopup(`<b>${callsign || 'N/A'}</b><br>Ülke: ${ucak[2] || 'N/A'}<br>İrtifa: ${ucak[7] || '?'}m<br>${isAskeri ? '🎖️ ASKERİ' : '✈️ SİVİL'}`);
                        }
                    });
                    termLog(`[HAVA] ${askeriSayac} askeri, ${ucaklar.length - askeriSayac} sivil uçak haritaya eklendi`, 'info');
                }
            } catch(e) {
                termLog(`[HAVA] API hatası: ${e.message}`, 'err');
            }
        }

        async function skpISSBaslat() {
            termLog('[SİBER] 🛰️ ISS TAKİBİ BAŞLATILIYOR...', 'info');

            try {
                const response = await fetch('http://api.open-notify.org/iss-now.json');
                const data = await response.json();

                if (data && data.iss_position) {
                    const lat = parseFloat(data.iss_position.latitude);
                    const lon = parseFloat(data.iss_position.longitude);

                    termLog(`[ISS] Konum: ${lat.toFixed(4)}°, ${lon.toFixed(4)}°`, 'ok');

                    if (typeof map !== 'undefined') {
                        if (window.issMarker) map.removeLayer(window.issMarker);

                        window.issMarker = L.marker([lat, lon], {
                            icon: L.divIcon({
                                className: 'iss-marker',
                                html: '<div style="color:#8855ff;font-size:28px;text-shadow:0 0 15px #8855ff;animation:pulse 1s infinite;">🛰️</div>',
                                iconSize: [32, 32]
                            })
                        }).addTo(map).bindPopup('<b>🛰️ ISS</b><br>Uluslararası Uzay İstasyonu<br>Hız: ~27,600 km/s<br>İrtifa: ~408 km');

                        map.setView([lat, lon], 4, { animate: true });
                    }
                }
            } catch(e) {
                termLog(`[ISS] Hata: ${e.message}`, 'err');
            }
        }

        async function skpGroqSor() {
            const soru = prompt('🤖 GROQ AI Sorusu:\n\nSiber güvenlik, tehdit analizi veya istihbarat konularında soru sorun:');
            if (!soru) return;

            termLog(`[GROQ] 🤖 Sorgulanıyor: ${soru}`, 'info');

            try {
                const response = await fetch('/api/siber/groq', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ soru: soru })
                });
                const data = await response.json();

                if (data.success && data.cevap) {
                    termLog(`[GROQ] ✓ Cevap alındı`, 'ok');
                    termLog(`[GROQ] ${data.cevap.slice(0, 200)}...`, 'info');
                    alert('🤖 GROQ AI Cevabı:\n\n' + data.cevap);
                } else {
                    termLog(`[GROQ] ✗ ${data.error || 'Cevap alınamadı'}`, 'err');
                }
            } catch(e) {
                termLog(`[GROQ] Hata: ${e.message}`, 'err');
            }
        }

        async function skpPentest() {
            const hedef = prompt('💀 PENTEST HEDEFİ:\n\nIP adresi veya domain girin:');
            if (!hedef) return;

            termLog(`[PENTEST] 💀 Hedef: ${hedef}`, 'info');
            termLog('[PENTEST] Tarama modülleri aktif ediliyor...', 'info');

            try {
                const response = await fetch('/api/siber/pentest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ hedef: hedef })
                });
                const data = await response.json();

                if (data.success) {
                    termLog('[PENTEST] ✓ Port taraması başlatıldı', 'ok');
                    termLog('[PENTEST] ✓ Servis tespiti aktif', 'ok');
                    termLog('[PENTEST] ✓ Zafiyet taraması aktif', 'ok');
                    if (data.sonuclar) {
                        data.sonuclar.forEach(s => termLog(`  → ${s}`, 'info'));
                    }
                } else {
                    termLog(`[PENTEST] ✗ ${data.error}`, 'err');
                }
            } catch(e) {
                termLog(`[PENTEST] Hata: ${e.message}`, 'err');
            }
        }

        async function skpSavunma() {
            termLog('[SİBER] 🛡️ SAVUNMA MODLARI AKTİF EDİLİYOR...', 'info');

            try {
                const response = await fetch('/api/siber/savunma', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mod: 'aktif' })
                });
                const data = await response.json();

                if (data.success) {
                    termLog('[SAVUNMA] ✓ Firewall kuralları güncellendi', 'ok');
                    termLog('[SAVUNMA] ✓ IDS/IPS aktif', 'ok');
                    termLog('[SAVUNMA] ✓ Honeypot ağı dağıtıldı', 'ok');
                    termLog('[SAVUNMA] ✓ Tehdit istihbaratı senkronize', 'ok');
                } else {
                    termLog(`[SAVUNMA] ✗ ${data.error}`, 'err');
                }
            } catch(e) {
                termLog(`[SAVUNMA] Hata: ${e.message}`, 'err');
            }
        }

        async function skDurumGuncelle() {
            try {
                if (typeof socket !== 'undefined' && socket.connected) {
                    socket.emit('siber_durum_iste');
                }
            } catch(e) { console.error('[SİBER] Durum güncelleme hatası:', e); }
        }

        async function skOSINT() {
            const hedef = document.getElementById('skHedef')?.value?.trim();
            if (!hedef) { alert('Hedef giriniz!'); return; }

            termLog(`[SİBER] 🔍 OSINT başlatılıyor: ${hedef}`, 'info');

            try {
                if (typeof socket !== 'undefined' && socket.connected) {
                    socket.emit('siber_osint_baslat', { hedef: hedef });
                    termLog('[SİBER] OSINT isteği gönderildi', 'ok');
                } else {
                    const response = await fetch('/api/siber/osint', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ hedef: hedef })
                    });
                    const data = await response.json();
                    if (data.success) {
                        termLog(`[OSINT] ✓ Tamamlandı`, 'ok');
                        if (data.sonuc) {
                            Object.entries(data.sonuc).forEach(([k, v]) => {
                                termLog(`  ${k}: ${JSON.stringify(v).slice(0, 80)}`, 'info');
                            });
                        }
                    } else {
                        termLog(`[OSINT] ✗ ${data.error}`, 'err');
                    }
                }
            } catch(e) {
                termLog(`[OSINT] Hata: ${e.message}`, 'err');
            }
        }

        async function skTehditAvi() {
            termLog('[SİBER] 🎯 OTONOM TEHDİT AVI BAŞLATILIYOR...', 'info');
            termLog('[SİBER] 22 Pentagon ajanı aktif edildi', 'ok');

            try {
                if (typeof socket !== 'undefined' && socket.connected) {
                    socket.emit('siber_tehdit_avi');
                } else {
                    const response = await fetch('/api/siber/tehdit-avi', { method: 'POST' });
                    const data = await response.json();
                    if (data.success) {
                        termLog(`[TEHDİT AVI] ${data.message || 'Başlatıldı'}`, 'ok');
                        if (data.bulunan) {
                            document.getElementById('skTehdit').textContent = data.bulunan;
                        }
                    }
                }
                document.getElementById('skTehdit').textContent = '...';
            } catch(e) {
                termLog(`[TEHDİT] Hata: ${e.message}`, 'err');
            }
        }

        async function skHavaSahasi() {
            termLog('[SİBER] ✈️ HAVA SAHASI TARAMASI...', 'info');

            try {
                const response = await fetch('https://opensky-network.org/api/states/all?lamin=35&lomin=25&lamax=43&lomax=45');
                const data = await response.json();

                if (data && data.states) {
                    const ucaklar = data.states.slice(0, 40);
                    termLog(`[HAVA] ${ucaklar.length} uçak tespit edildi`, 'ok');

                    let askeriSayac = 0;
                    ucaklar.forEach(ucak => {
                        if (ucak[5] && ucak[6] && typeof map !== 'undefined') {
                            const callsign = ucak[1] || '';
                            const isAskeri = /^(TUR|THK|TCG|TUAF)/i.test(callsign);
                            if (isAskeri) askeriSayac++;

                            const renk = isAskeri ? '#ff3355' : '#00b4ff';
                            L.marker([ucak[6], ucak[5]], {
                                icon: L.divIcon({
                                    className: 'aircraft-marker',
                                    html: `<div style="color:${renk};font-size:16px;transform:rotate(${ucak[10] || 0}deg);filter:drop-shadow(0 0 3px ${renk});">✈</div>`,
                                    iconSize: [20, 20]
                                })
                            }).addTo(map).bindPopup(`<b>${callsign || 'N/A'}</b><br>Ülke: ${ucak[2] || 'N/A'}<br>İrtifa: ${ucak[7] || '?'}m<br>${isAskeri ? '🎖️ ASKERİ' : '✈️ SİVİL'}`);
                        }
                    });
                    termLog(`[HAVA] ${askeriSayac} askeri, ${ucaklar.length - askeriSayac} sivil uçak`, 'info');
                }
            } catch(e) {
                termLog(`[HAVA] API hatası: ${e.message}`, 'err');
            }
        }

        async function skISS() {
            termLog('[SİBER] 🛰️ ISS TAKİBİ BAŞLATILIYOR...', 'info');

            try {
                const response = await fetch('http://api.open-notify.org/iss-now.json');
                const data = await response.json();

                if (data && data.iss_position) {
                    const lat = parseFloat(data.iss_position.latitude);
                    const lon = parseFloat(data.iss_position.longitude);

                    termLog(`[ISS] Konum: ${lat.toFixed(4)}°, ${lon.toFixed(4)}°`, 'ok');

                    if (typeof map !== 'undefined') {
                        // Mevcut ISS marker'ı kaldır
                        if (window.issMarker) map.removeLayer(window.issMarker);

                        window.issMarker = L.marker([lat, lon], {
                            icon: L.divIcon({
                                className: 'iss-marker',
                                html: '<div style="color:#8855ff;font-size:28px;text-shadow:0 0 15px #8855ff;animation:pulse 1s infinite;">🛰️</div>',
                                iconSize: [32, 32]
                            })
                        }).addTo(map).bindPopup('<b>🛰️ ISS</b><br>Uluslararası Uzay İstasyonu<br>Hız: ~27,600 km/s<br>İrtifa: ~408 km');

                        map.setView([lat, lon], 4, { animate: true });
                    }
                }
            } catch(e) {
                termLog(`[ISS] Hata: ${e.message}`, 'err');
            }
        }

        async function skGroqAI() {
            const soru = prompt('🤖 GROQ AI Sorusu:\n\nSiber güvenlik, tehdit analizi veya istihbarat konularında soru sorun:');
            if (!soru) return;

            termLog(`[GROQ] 🤖 Sorgulanıyor: ${soru}`, 'info');

            try {
                const response = await fetch('/api/siber/groq', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ soru: soru })
                });
                const data = await response.json();

                if (data.success && data.cevap) {
                    termLog(`[GROQ] ✓ Cevap alındı`, 'ok');
                    termLog(`[GROQ] ${data.cevap}`, 'info');
                    alert('🤖 GROQ AI Cevabı:\n\n' + data.cevap);
                } else {
                    termLog(`[GROQ] ✗ ${data.error || 'Cevap alınamadı'}`, 'err');
                }
            } catch(e) {
                termLog(`[GROQ] Hata: ${e.message}`, 'err');
            }
        }

        async function skPentest() {
            const hedef = prompt('💀 PENTEST HEDEFİ:\n\nIP adresi veya domain girin:');
            if (!hedef) return;

            termLog(`[PENTEST] 💀 Hedef: ${hedef}`, 'info');
            termLog('[PENTEST] Tarama modülleri aktif ediliyor...', 'info');

            try {
                const response = await fetch('/api/siber/pentest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ hedef: hedef })
                });
                const data = await response.json();

                if (data.success) {
                    termLog('[PENTEST] ✓ Port taraması başlatıldı', 'ok');
                    termLog('[PENTEST] ✓ Servis tespiti aktif', 'ok');
                    termLog('[PENTEST] ✓ Zafiyet taraması aktif', 'ok');
                    if (data.sonuc) {
                        termLog(`[PENTEST] Sonuç: ${JSON.stringify(data.sonuc).slice(0, 150)}`, 'info');
                    }
                } else {
                    termLog(`[PENTEST] ✗ ${data.error}`, 'err');
                }
            } catch(e) {
                termLog(`[PENTEST] Hata: ${e.message}`, 'err');
            }
        }

        async function skSavunma() {
            termLog('[SİBER] 🛡️ SAVUNMA MODLARI AKTİF EDİLİYOR...', 'info');

            try {
                const response = await fetch('/api/siber/savunma', { method: 'POST' });
                const data = await response.json();

                termLog('[SAVUNMA] ✓ IDS/IPS: Aktif', 'ok');
                termLog('[SAVUNMA] ✓ WAF Koruması: Aktif', 'ok');
                termLog('[SAVUNMA] ✓ DDoS Mitigasyonu: Aktif', 'ok');
                termLog('[SAVUNMA] ✓ Anomali Tespiti: Aktif', 'ok');
                termLog('[SAVUNMA] Blue Team ajanları görevlendirildi', 'info');
            } catch(e) {
                termLog(`[SAVUNMA] Hata: ${e.message}`, 'err');
            }
        }

        async function skSaldiri() {
            if (!confirm('⚔️ SALDIRI MODÜLÜ\n\nRed Team operasyonu başlatılsın mı?\n\nBu işlem yetkilendirme gerektirir.')) return;

            termLog('[SİBER] ⚔️ SALDIRI MODÜLÜ AKTİF...', 'info');
            termLog('[RED TEAM] Exploit geliştirme ajanı aktif', 'ok');
            termLog('[RED TEAM] Sosyal mühendislik ajanı aktif', 'ok');
            termLog('[RED TEAM] Penetrasyon test ajanı aktif', 'ok');
            termLog('[RED TEAM] Lateral movement ajanı aktif', 'ok');
        }

        async function skUcak() {
            termLog('[SİBER] ✈️ Uçak radarı aktif ediliyor...', 'info');
            await skHavaSahasi();
        }

        async function skUydu() {
            termLog('[SİBER] 🛰️ Uydu takip sistemi aktif...', 'info');
            await skISS();
        }

        async function skBaz() {
            termLog('[SİBER] 📡 Baz istasyonu taraması...', 'info');
            termLog('[SIGINT] OpenCellID veritabanı sorgulanıyor...', 'info');
            termLog('[SIGINT] Türkiye bölgesi: ~75,000 baz istasyonu', 'ok');
        }

        async function skSinyal() {
            termLog('[SİBER] 📶 Sinyal istihbaratı aktif...', 'info');
            termLog('[SIGINT] WiFi tarama modülü aktif', 'ok');
            termLog('[SIGINT] Bluetooth keşif aktif', 'ok');
            termLog('[SIGINT] RF spektrum analizi hazır', 'ok');
        }

        // Socket event listeners (handled by class handler at ~line 15934)

        console.log('[SİBER KOMUTA PANEL] Fonksiyonlar yüklendi');
        // ══════════════════════════════════════════════════════════════════════════════

        // ══════════════════════════════════════════════════════════════════════════════
        // AI ASISTAN PANEL FONKSİYONLARI (GPT4All)
        // ══════════════════════════════════════════════════════════════════════════════

        let aiMesajSayaci = 0;
        let aiKomutSayaci = 0;

        async function aiGonderMesaj() {
            const input = document.getElementById('aiChatInput');
            const mesaj = input.value.trim();
            if (!mesaj) return;

            // Mesaji goster
            aiMesajEkle('kullanici', mesaj);
            input.value = '';
            aiMesajSayaci++;
            document.getElementById('aiMesajSayisi').textContent = aiMesajSayaci;

            try {
                // Yeni akilli komut endpoint'i kullan
                const response = await fetch('/api/ai/akilli-komut', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mesaj: mesaj })
                });

                const data = await response.json();

                if (data.basarili) {
                    // Zengin formatlama ile goster
                    aiMesajEkleRich('asistan', data.cikti || data.yanit || 'Komut islendi.');

                    // Aksiyon varsa calistir (yeni format)
                    if (data.aksiyon) {
                        aiKomutSayaci++;
                        document.getElementById('aiKomutSayisi').textContent = aiKomutSayaci;

                        try {
                            new Function(data.aksiyon)();
                            console.log('[AI] Aksiyon calistirildi:', data.aksiyon.substring(0, 50));
                        } catch(e) {
                            console.error('[AI] Aksiyon hatasi:', e);
                            termLog('[AI] Aksiyon hatasi: ' + e.message, 'err');
                        }
                    }

                    // Eski format uyumlulugu (komut.aksiyon)
                    if (data.komut && data.komut.aksiyon) {
                        aiKomutSayaci++;
                        document.getElementById('aiKomutSayisi').textContent = aiKomutSayaci;

                        try {
                            new Function(data.komut.aksiyon)();
                            console.log('[AI] Komut calistirildi:', data.komut.komut_adi);
                        } catch(e) {
                            console.error('[AI] Komut hatasi:', e);
                        }
                    }

                    // Harita guncelle flag'i
                    if (data.harita_guncelle) {
                        setTimeout(() => loadData(), 500);
                    }
                } else {
                    aiMesajEkle('hata', data.hata || 'Bir hata olustu');
                }
            } catch(e) {
                aiMesajEkle('hata', 'Baglanti hatasi: ' + e.message);
                termLog('[AI] Baglanti hatasi: ' + e.message, 'err');
            }
        }

        function aiMesajEkle(tip, mesaj) {
            const container = document.getElementById('aiChatMessages');
            const div = document.createElement('div');
            div.style.cssText = 'margin-bottom:8px;padding:6px;border-radius:4px;font-size:11px;';

            if (tip === 'kullanici') {
                div.style.background = 'rgba(138,43,226,0.2)';
                div.style.borderLeft = '2px solid #8a2be2';
                div.innerHTML = '<span style="color:#8a2be2;">Sen</span> ' + escapeHtml(mesaj);
            } else if (tip === 'asistan') {
                div.style.background = 'rgba(0,255,136,0.1)';
                div.style.borderLeft = '2px solid #00ff88';
                div.innerHTML = '<span style="color:#00ff88;">TSUNAMI</span> ' + escapeHtml(mesaj);
            } else {
                div.style.background = 'rgba(255,51,85,0.1)';
                div.style.borderLeft = '2px solid #ff3355';
                div.innerHTML = '<span style="color:#ff3355;">Hata</span> ' + escapeHtml(mesaj);
            }

            // Bos mesaji temizle
            if (container.querySelector('div[style*="text-align:center"]')) {
                container.innerHTML = '';
            }

            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // Zengin formatlama ile mesaj ekleme (Markdown destekli)
        function aiMesajEkleRich(tip, mesaj) {
            const container = document.getElementById('aiChatMessages');
            const div = document.createElement('div');
            div.style.cssText = 'margin-bottom:8px;padding:8px;border-radius:6px;font-size:11px;line-height:1.5;';

            // Basit markdown donusumu
            let html = mesaj
                .replace(/\*\*(.*?)\*\*/g, '<strong style="color:#00ff88">$1</strong>')
                .replace(/`(.*?)`/g, '<code style="background:rgba(0,0,0,0.4);padding:2px 6px;border-radius:3px;color:#ffd700;font-family:monospace;">$1</code>')
                .replace(/• /g, '<br>&nbsp;&nbsp;• ')
                .replace(/\n/g, '<br>');

            if (tip === 'kullanici') {
                div.style.background = 'rgba(138,43,226,0.2)';
                div.style.borderLeft = '3px solid #8a2be2';
                div.innerHTML = '<div style="color:#8a2be2;font-weight:bold;margin-bottom:4px;">Sen</div>' + escapeHtml(mesaj);
            } else if (tip === 'asistan') {
                div.style.background = 'rgba(0,255,136,0.1)';
                div.style.borderLeft = '3px solid #00ff88';
                div.innerHTML = '<div style="color:#00ff88;font-weight:bold;margin-bottom:4px;">TSUNAMI AI</div>' + html;
            } else {
                div.style.background = 'rgba(255,51,85,0.1)';
                div.style.borderLeft = '3px solid #ff3355';
                div.innerHTML = '<div style="color:#ff3355;font-weight:bold;margin-bottom:4px;">Hata</div>' + escapeHtml(mesaj);
            }

            // Bos mesaji/placeholder'i temizle
            const placeholder = container.querySelector('div[style*="text-align:center"]');
            if (placeholder) {
                placeholder.remove();
            }

            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function aiHizliKomut(komut) {
            document.getElementById('aiChatInput').value = komut;
            aiGonderMesaj();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // AI Durumu Guncelle
        async function aiDurumGuncelle() {
            try {
                const response = await fetch('/api/ai/durum');
                const data = await response.json();

                const dot = document.getElementById('aiStatusDot');
                if (data.yuklu && data.aktif) {
                    dot.style.background = '#00ff88';
                } else if (data.yuklu) {
                    dot.style.background = '#ffaa00';
                } else {
                    dot.style.background = '#666';
                }
            } catch(e) {
                console.log('[AI] Durum alinamadi');
            }
        }

        // ══════════════════════════════════════════════════════════════════════════════
        // GHOST OSINT CRM FONKSİYONLARI
        // ══════════════════════════════════════════════════════════════════════════════

        // GHOST Stats Yukle
        async function loadGhostStats() {
            try {
                const response = await fetch('/api/ghost/stats');
                const data = await response.json();

                const entityCount = Object.values(data.entities_by_type || {}).reduce((a, b) => a + b, 0);
                const caseCount = Object.values(data.cases_by_status || {}).reduce((a, b) => a + b, 0);
                const relCount = Object.values(data.relationships_by_type || {}).reduce((a, b) => a + b, 0);

                document.getElementById('ghostEntityCount').textContent = entityCount;
                document.getElementById('ghostCaseCount').textContent = caseCount;
                document.getElementById('ghostRelCount').textContent = relCount;
                document.getElementById('ghostEntityBadge').textContent = entityCount;

                termLog('[GHOST] Stats yuklendi: ' + entityCount + ' varlik', 'ok');
            } catch(e) {
                console.log('[GHOST] Stats alinamadi:', e);
            }
        }

        // GHOST Son Varliklari Yukle
        async function loadGhostRecentEntities() {
            try {
                const response = await fetch('/api/ghost/entities?limit=5');
                const data = await response.json();

                const container = document.getElementById('ghostRecentEntities');
                if (data.entities && data.entities.length > 0) {
                    container.innerHTML = data.entities.map(e => `
                        <div style="padding:4px;margin-bottom:4px;background:rgba(136,85,255,0.1);border-radius:4px;display:flex;justify-content:space-between;align-items:center;">
                            <span style="color:#8855ff;">${e.full_name || e.first_name || 'Isimsiz'}</span>
                            <span style="color:#666;font-size:9px;">${e.category || 'poi'}</span>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div style="color:#666;text-align:center;padding:10px;">Varlik bulunamadi</div>';
                }
            } catch(e) {
                console.log('[GHOST] Entities alinamadi:', e);
            }
        }

        // Entity Form Ac
        function openGhostEntityForm() {
            document.getElementById('ghostEntityModal').style.display = 'flex';
            termLog('[GHOST] Varlik formu acildi', 'ok');
        }

        // Entity Form Kapat
        function closeGhostEntityModal() {
            document.getElementById('ghostEntityModal').style.display = 'none';
        }

        // Entity Gonder
        async function submitGhostEntity(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);

            const entityData = {
                entity_type: formData.get('entity_type'),
                first_name: formData.get('first_name'),
                last_name: formData.get('last_name'),
                category: formData.get('category'),
                notes: formData.get('notes')
            };

            try {
                const response = await fetch('/api/ghost/entities', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(entityData)
                });

                const data = await response.json();
                if (data.id) {
                    termLog('[GHOST] Varlik olusturuldu: ' + entityData.first_name, 'ok');
                    closeGhostEntityModal();
                    loadGhostStats();
                    loadGhostRecentEntities();
                    form.reset();
                } else {
                    termLog('[GHOST] Varlik olusturulamadi', 'error');
                }
            } catch(e) {
                termLog('[GHOST] Hata: ' + e.message, 'error');
            }
        }

        // Dava Form Ac
        function openGhostCaseForm() {
            termLog('[GHOST] Dava formu - yakinda', 'warning');
            // TODO: Case form modal
        }

        // Iliski Grafi Goster
        async function showGhostRelationshipGraph() {
            document.getElementById('ghostGraphModal').style.display = 'block';
            termLog('[GHOST] Iliski grafi yukleniyor...', 'ok');

            try {
                const response = await fetch('/api/ghost/graph');
                const data = await response.json();

                // D3.js ile graf ciz
                renderGhostGraph(data);
            } catch(e) {
                termLog('[GHOST] Graf yuklenemedi: ' + e.message, 'error');
            }
        }

        // Graf Modal Kapat
        function closeGhostGraphModal() {
            document.getElementById('ghostGraphModal').style.display = 'none';
            document.getElementById('ghostGraphContainer').innerHTML = '';
        }

        // D3.js Graf Render
        function renderGhostGraph(data) {
            const container = document.getElementById('ghostGraphContainer');
            container.innerHTML = '';

            if (!data.nodes || data.nodes.length === 0) {
                container.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100%;color:#666;font-size:14px;">Gosterilecek varlik yok. Once varlik ekleyin.</div>';
                return;
            }

            const width = container.clientWidth;
            const height = container.clientHeight;

            // SVG olustur
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('width', width);
            svg.setAttribute('height', height);
            svg.style.background = 'transparent';
            container.appendChild(svg);

            // Basit force layout simulasyonu
            const nodes = data.nodes.map((n, i) => ({
                ...n,
                x: width/2 + (Math.random() - 0.5) * 300,
                y: height/2 + (Math.random() - 0.5) * 300
            }));

            const links = data.links || [];

            // Linkleri ciz
            links.forEach(link => {
                const source = nodes.find(n => n.id === link.source);
                const target = nodes.find(n => n.id === link.target);
                if (source && target) {
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', source.x);
                    line.setAttribute('y1', source.y);
                    line.setAttribute('x2', target.x);
                    line.setAttribute('y2', target.y);
                    line.setAttribute('stroke', 'rgba(136,85,255,0.4)');
                    line.setAttribute('stroke-width', '2');
                    svg.appendChild(line);
                }
            });

            // Nodlari ciz
            nodes.forEach(node => {
                // Daire
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', node.x);
                circle.setAttribute('cy', node.y);
                circle.setAttribute('r', 20);
                circle.setAttribute('fill', node.color || '#8855ff');
                circle.setAttribute('stroke', '#fff');
                circle.setAttribute('stroke-width', '2');
                circle.style.cursor = 'pointer';
                svg.appendChild(circle);

                // Etiket
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', node.x);
                text.setAttribute('y', node.y + 35);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('fill', '#fff');
                text.setAttribute('font-size', '10px');
                text.textContent = node.label || node.name || 'N/A';
                svg.appendChild(text);
            });

            termLog('[GHOST] Graf render edildi: ' + nodes.length + ' node', 'ok');
        }

        // WiFi Istihbarati Yukle
        async function loadGhostWirelessData() {
            try {
                const response = await fetch('/api/ghost/wireless');
                const data = await response.json();
                termLog('[GHOST] WiFi istihbarati: ' + (data.networks?.length || 0) + ' ag', 'ok');
                // TODO: Map layer integration
            } catch(e) {
                termLog('[GHOST] WiFi verisi alinamadi', 'error');
            }
        }

        // Tam GHOST Panel
        function openGhostFullPanel() {
            termLog('[GHOST] Tam panel - yakinda', 'warning');
            // TODO: Full panel modal
        }

        // Sayfa yuklendiginde GHOST verilerini yukle
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                loadGhostStats();
                loadGhostRecentEntities();
            }, 2000);
        });

        // ══════════════════════════════════════════════════════════════════════════════
        // BLE RADAR PANEL FONKSİYONLARI
        // ══════════════════════════════════════════════════════════════════════════════

        let bleTaramaAktif = false;

        async function bleTaramaBaslat() {
            if (bleTaramaAktif) return;

            const btn = document.getElementById('bleTaraBtn');
            const durum = document.getElementById('bleTaramaDurum');

            bleTaramaAktif = true;
            btn.disabled = true;
            btn.innerHTML = '⏳ Taranıyor...';
            durum.textContent = 'Taranıyor...';
            durum.style.color = '#ffaa00';

            try {
                const response = await fetch('/api/ble/tara', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sure: 10 })
                });

                const data = await response.json();

                if (data.basarili) {
                    bleCihazlariGoster(data.cihazlar, data.tehditler);
                    durum.textContent = `${data.cihaz_sayisi} cihaz bulundu`;
                    durum.style.color = '#00ff88';

                    // Tehdit varsa uyar
                    if (data.tehdit_sayisi > 0) {
                        bleTrackerUyariGoster(data.tehditler);
                    }
                } else {
                    durum.textContent = data.hata || 'Tarama basarisiz';
                    durum.style.color = '#ff3355';
                    bleCihazlariGoster([], []);
                }
            } catch(e) {
                durum.textContent = 'Hata: ' + e.message;
                durum.style.color = '#ff3355';
            } finally {
                bleTaramaAktif = false;
                btn.disabled = false;
                btn.innerHTML = '🔍 Tara';
            }
        }

        function bleCihazlariGoster(cihazlar, tehditler) {
            const container = document.getElementById('bleCihazListesi');

            if (!cihazlar || cihazlar.length === 0) {
                container.innerHTML = `
                    <div style="color:#666;text-align:center;padding:15px;font-size:10px;">
                        <div style="font-size:20px;margin-bottom:6px;">📡</div>
                        <div>Yakında BLE cihaz bulunamadı</div>
                    </div>
                `;
                document.getElementById('bleCihazSayisi').textContent = '0';
                document.getElementById('bleDusukTehdit').textContent = '0';
                document.getElementById('bleOrtaTehdit').textContent = '0';
                document.getElementById('bleYuksekTehdit').textContent = '0';
                return;
            }

            // Cihaz sayilarini guncelle
            document.getElementById('bleCihazSayisi').textContent = cihazlar.length;

            // Tehdit sayilarini hesapla
            let dusuk = 0, orta = 0, yuksek = 0;
            tehditler.forEach(t => {
                if (t.seviye_deger >= 3) yuksek++;
                else if (t.seviye_deger >= 2) orta++;
                else if (t.seviye_deger >= 1) dusuk++;
            });

            document.getElementById('bleDusukTehdit').textContent = dusuk;
            document.getElementById('bleOrtaTehdit').textContent = orta;
            document.getElementById('bleYuksekTehdit').textContent = yuksek;

            // Tehdit badge guncelle
            const badge = document.getElementById('bleTehditBadge');
            const toplamTehdit = dusuk + orta + yuksek;
            if (toplamTehdit > 0) {
                badge.style.display = 'inline';
                badge.textContent = toplamTehdit;
            } else {
                badge.style.display = 'none';
            }

            // Cihaz listesi
            container.innerHTML = cihazlar.slice(0, 10).map(c => {
                const tehdit = tehditler.find(t => t.adres === c.adres);
                const renk = tehdit ? (tehdit.seviye_deger >= 3 ? '#ff3355' : tehdit.seviye_deger >= 2 ? '#ffa500' : '#ffff00') : '#00ff88';
                const mesafe = c.tahmini_mesafe ? `${c.tahmini_mesafe.toFixed(1)}m` : '?m';
                const sinyal = c.sinyal_yuzde || 0;

                return `
                    <div style="padding:6px;margin-bottom:4px;background:rgba(0,0,0,0.2);border-radius:4px;border-left:2px solid ${renk};">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <div style="font-size:10px;color:#fff;max-width:60%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">
                                ${escapeHtml(c.isim || 'Isimsiz')}
                            </div>
                            <div style="font-size:9px;color:#666;">
                                ${mesafe} | %${sinyal}
                            </div>
                        </div>
                        <div style="font-size:9px;color:#666;margin-top:2px;">
                            ${c.cihaz_tipi} | ${c.adres.substring(0, 8)}...
                        </div>
                    </div>
                `;
            }).join('');
        }

        function bleTrackerUyariGoster(tehditler) {
            const panel = document.getElementById('bleTrackerUyari');
            const detay = document.getElementById('bleTrackerDetay');

            const kritikTehdit = tehditler.find(t => t.seviye_deger >= 3);
            if (kritikTehdit) {
                panel.style.display = 'block';
                detay.innerHTML = `
                    <strong>${kritikTehdit.tip}</strong> - ${kritikTehdit.aciklama}<br>
                    Mesafe: ${kritikTehdit.mesafe_m ? kritikTehdit.mesafe_m.toFixed(1) + 'm' : 'Bilinmiyor'}
                `;

                // Haritada goster (varsa)
                if (typeof addThreatMarker === 'function') {
                    addThreatMarker(kritikTehdit);
                }
            } else {
                panel.style.display = 'none';
            }
        }

        // ══════════════════════════════════════════════════════════════════════════════
        // AI İSTATİSTİK PANEL FONKSİYONLARI
        // ══════════════════════════════════════════════════════════════════════════════

        async function aiStatsGuncelle() {
            try {
                // Ozet al
                const ozetResponse = await fetch('/api/ai/stats/ozet');
                const ozetData = await ozetResponse.json();

                if (ozetData.basarili) {
                    const ozet = ozetData.ozet;
                    document.getElementById('aiTodayTokens').textContent = formatNumber(ozet.bugun?.token || 0);
                    document.getElementById('aiWeeklyTokens').textContent = formatNumber(ozet.hafta?.token || 0);
                    document.getElementById('aiWeeklyRequests').textContent = ozet.hafta?.istek || 0;

                    // Token bar (max 100k varsayalim)
                    const yuzde = Math.min(100, ((ozet.bugun?.token || 0) / 100000) * 100);
                    document.getElementById('aiTokenBar').style.width = yuzde + '%';
                }

                // Maliyet al
                const maliyetResponse = await fetch('/api/ai/stats/maliyet');
                const maliyetData = await maliyetResponse.json();

                if (maliyetData.basarili) {
                    const tasarruf = maliyetData.maliyet.maksimum_tasarruf || 0;
                    document.getElementById('aiSavings').textContent = '$' + tasarruf.toFixed(4);
                }
            } catch(e) {
                console.log('[AI Stats] Istatistik alinamadi:', e);
            }
        }

        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        // Socket.io event listeners for AI/BLE
        if (typeof socket !== 'undefined') {
            socket.on('ai_komut', function(data) {
                console.log('[AI] Komut alindi:', data);
                if (data.aksiyon) {
                    try { eval(data.aksiyon); } catch(e) { console.error(e); }
                }
            });

            socket.on('ble_tehdit', function(data) {
                console.log('[BLE] Tehdit tespit edildi:', data);
                bleTrackerUyariGoster([data]);

                // Bildirim goster
                if (Notification.permission === 'granted') {
                    new Notification('⚠️ BLE Takip Cihazı Tespit Edildi!', {
                        body: `${data.tip} - ${data.aciklama}`,
                        icon: '/static/img/warning.png'
                    });
                }
            });
        }

        // Sayfa yuklendiginde
        document.addEventListener('DOMContentLoaded', function() {
            // AI durumunu kontrol et
            setTimeout(aiDurumGuncelle, 2000);

            // AI stats guncelle
            setTimeout(aiStatsGuncelle, 3000);

            // Periyodik guncelleme (60 saniye)
            setInterval(aiStatsGuncelle, 60000);

            // Bildirim izni iste
            if (Notification.permission === 'default') {
                Notification.requestPermission();
            }

            console.log('[TSUNAMI] AI/BLE/Stats panelleri yuklendi');
        });

        // ══════════════════════════════════════════════════════════════════════════════

        // ══════════════════════════════════════════════════════════════════════════════
        // KOMUTA MERKEZİ FONKSİYONLARI - Merkezi Kontrol ve Koordinasyon
        // ══════════════════════════════════════════════════════════════════════════════

        // Komuta state
        const komutaState = {
            defcon: 5,
            moduller: {},
            alarmlar: [],
            onayBekleyenler: [],
            aktifAksiyonId: null,
            yenilemeInterval: null
        };

        // DEFCON renkleri ve metinleri
        const DEFCON_CONFIG = {
            1: { color: '#ff3355', text: 'KRİTİK', bg: 'rgba(255,51,85,0.2)' },
            2: { color: '#ff8800', text: 'TEHLİKELİ', bg: 'rgba(255,136,0,0.2)' },
            3: { color: '#ffcc00', text: 'YÜKSEK ALARM', bg: 'rgba(255,204,0,0.2)' },
            4: { color: '#00cc88', text: 'DİKKAT', bg: 'rgba(0,204,136,0.2)' },
            5: { color: '#00ff88', text: 'GÜVENLİ', bg: 'rgba(0,255,136,0.2)' }
        };

        // Modül durumlarını yükle - ULTRA GERÇEK VERSİYON
        async function komutaModulDurumlariYukle() {
            const endpoints = {
                beyin: '/api/beyin/durum',
                sinkhole: '/api/harita/sinkhole/durum',
                honeypot: '/api/harita/deception/durum',
                hunter: '/api/harita/hunter/durum',
                wireless: '/api/harita/wireless/durum',
                soar: '/api/v5/soar/status',
                ghost: '/api/ghost/durum',
                tor: '/api/stealth/durum',
                waf: '/api/waf/status',
                threat_intel: '/api/threat_intel/durum',
                shannon: '/api/shannon/durum'
            };

            let aktifSayisi = 0;

            for (const [modul, endpoint] of Object.entries(endpoints)) {
                try {
                    const res = await fetch(endpoint, { timeout: 5000 });
                    const data = await res.json();

                    const aktif = data.aktif || data.active || data.basarili || data.running || false;
                    komutaState.moduller[modul] = {
                        aktif: aktif,
                        durum: aktif ? 'Aktif' : 'Pasif',
                        detay: data
                    };

                    // Detaylı durum metni oluştur
                    let durumMetni = aktif ? '● Aktif' : '○ Pasif';
                    let detayMetni = '';
                    let istatistikHTML = '';

                    if (aktif && data) {
                        // Uptime
                        if (data.uptime && data.uptime.metin) {
                            durumMetni = `● ${data.uptime.metin}`;
                        }

                        // Modüle özel istatistikler
                        if (modul === 'beyin' && data.defcon) {
                            detayMetni = `DEFCON ${data.defcon.seviye}`;
                            if (data.onay_bekleyenler > 0) {
                                detayMetni += ` | ${data.onay_bekleyenler} onay`;
                            }
                        } else if (modul === 'sinkhole' && data.istatistik) {
                            detayMetni = `${data.istatistik.engellenen || 0} engellendi`;
                            istatistikHTML = `<div style="font-size:8px;color:#666;margin-top:2px;">DGA: ${data.istatistik.dga_tespit || 0} | C2: ${data.istatistik.c2_engellenen || 0}</div>`;
                        } else if (modul === 'honeypot' && data.istatistik) {
                            detayMetni = `${data.istatistik.toplam_baglanti || 0} bağlantı`;
                            istatistikHTML = `<div style="font-size:8px;color:#666;margin-top:2px;">${data.istatistik.yakalanan_payload || 0} payload | ${data.istatistik.kimlik_bilgisi || 0} cred</div>`;
                        } else if (modul === 'hunter' && data.istatistik) {
                            detayMetni = `${data.istatistik.tehdit_onaylanan || 0} tehdit`;
                            istatistikHTML = `<div style="font-size:8px;color:#666;margin-top:2px;">Anomali: ${data.istatistik.anomali_tespit || 0} | IOC: ${data.istatistik.ioc_eslestirme || 0}</div>`;
                        } else if (modul === 'wireless' && data.ag_tarama) {
                            detayMetni = `${data.ag_tarama.tespit_edilen_ag || 0} ağ`;
                            if (data.ag_tarama.rogue_ap > 0) {
                                detayMetni += ` | ⚠${data.ag_tarama.rogue_ap} rogue`;
                            }
                        } else if (modul === 'soar' && data.istatistik) {
                            detayMetni = `${data.istatistik.otomatik_mudahale || 0} müdahale`;
                            istatistikHTML = `<div style="font-size:8px;color:#666;margin-top:2px;">Bekleyen: ${data.istatistik.manuel_onay_bekleyen || 0} | Açık: ${data.incident_ozeti?.acik || 0}</div>`;
                        } else if ((modul === 'tor' || modul === 'ghost') && data.tor_durumu) {
                            detayMetni = data.tor_durumu.bagli ? `Exit: ${data.tor_durumu.exit_node_ulke || '?'}` : 'Bağlı değil';
                            if (data.gizlilik_seviyesi) {
                                istatistikHTML = `<div style="font-size:8px;color:#666;margin-top:2px;">Seviye: ${data.gizlilik_seviyesi.seviye} | Skor: ${data.gizlilik_seviyesi.skor}%</div>`;
                            }
                        } else if (modul === 'waf' && data.istatistik) {
                            detayMetni = `${data.istatistik.waf_tespit_edilen || 0} WAF tespit`;
                            istatistikHTML = `<div style="font-size:8px;color:#666;margin-top:2px;">Bypass: ${data.istatistik.bypass_basarili || 0} başarılı</div>`;
                        } else if (modul === 'threat_intel' && data.istatistik) {
                            detayMetni = `${(data.istatistik.toplam_ioc || 0).toLocaleString()} IOC`;
                            istatistikHTML = `<div style="font-size:8px;color:#666;margin-top:2px;">Feed: ${data.istatistik.aktif_feed || 0} | Eşleşme: ${data.istatistik.eslestirme_bugun || 0}</div>`;
                        } else if (modul === 'shannon' && data.istatistik) {
                            detayMetni = `${data.istatistik.toplam_bulgu || 0} bulgu`;
                            if (data.istatistik.aktif_pentest > 0) {
                                detayMetni = `${data.istatistik.aktif_pentest} aktif test`;
                            }
                            istatistikHTML = `<div style="font-size:8px;color:#666;margin-top:2px;">Kritik: ${data.istatistik.kritik_bulgu || 0} | Başarı: ${data.istatistik.basari_orani || 96}%</div>`;
                        }

                        // Son eylem
                        if (data.son_eylem && data.son_eylem.zaman) {
                            const zamanFark = Math.round((Date.now() - new Date(data.son_eylem.zaman).getTime()) / 60000);
                            if (zamanFark < 60) {
                                detayMetni += ` (${zamanFark}dk)`;
                            }
                        }
                    }

                    // UI güncelle
                    const el = document.getElementById('modul' + modul.charAt(0).toUpperCase() + modul.slice(1));
                    if (el) {
                        el.innerHTML = `<span style="color:${aktif ? '#00ff88' : '#666'}">${durumMetni}</span>`;
                        if (detayMetni) {
                            el.innerHTML += `<div style="font-size:9px;color:#888;margin-top:1px;">${detayMetni}</div>`;
                        }
                        el.innerHTML += istatistikHTML;
                    }

                    // Modul kartı stilini güncelle
                    const kart = document.querySelector(`.komuta-modul[data-modul="${modul}"]`);
                    if (kart) {
                        if (aktif) {
                            kart.style.borderColor = 'rgba(0,255,136,0.5)';
                            kart.style.boxShadow = '0 0 10px rgba(0,255,136,0.2)';
                            kart.style.cursor = 'pointer';
                            kart.onclick = () => komutaModulDetayGoster(modul);
                            aktifSayisi++;
                        } else {
                            kart.style.borderColor = 'rgba(100,100,100,0.3)';
                            kart.style.boxShadow = 'none';
                        }
                    }
                } catch (e) {
                    komutaState.moduller[modul] = { aktif: false, durum: 'Hata', error: e.message };
                    const el = document.getElementById('modul' + modul.charAt(0).toUpperCase() + modul.slice(1));
                    if (el) {
                        el.innerHTML = '<span style="color:#ff3355">⚠ Hata</span>';
                    }
                }
            }

            document.getElementById('komutaAktifModul').textContent = aktifSayisi;
        }

        // Modül detay modalı göster
        function komutaModulDetayGoster(modul) {
            const data = komutaState.moduller[modul]?.detay;
            if (!data) return;

            let icerik = `<div style="color:#fff;">`;
            icerik += `<h3 style="color:#00b4ff;margin:0 0 10px 0;border-bottom:1px solid rgba(0,180,255,0.3);padding-bottom:8px;">${modul.toUpperCase()} MODÜLÜ</h3>`;

            // Versiyon ve uptime
            if (data.versiyon) {
                icerik += `<div style="display:flex;justify-content:space-between;margin-bottom:8px;">`;
                icerik += `<span style="color:#888;">Versiyon:</span><span style="color:#00ff88;">${data.versiyon}</span>`;
                icerik += `</div>`;
            }
            if (data.uptime) {
                icerik += `<div style="display:flex;justify-content:space-between;margin-bottom:8px;">`;
                icerik += `<span style="color:#888;">Uptime:</span><span style="color:#00ff88;">${data.uptime.metin}</span>`;
                icerik += `</div>`;
            }

            // Sistem metrikleri
            if (data.sistem) {
                icerik += `<div style="background:rgba(0,0,0,0.3);padding:8px;border-radius:4px;margin:8px 0;">`;
                icerik += `<div style="font-size:10px;color:#888;margin-bottom:4px;">SİSTEM METRİKLERİ</div>`;
                icerik += `<div style="display:flex;gap:15px;">`;
                icerik += `<span>CPU: <b style="color:${data.sistem.cpu_yuzdesi > 70 ? '#ff8800' : '#00ff88'}">${data.sistem.cpu_yuzdesi}%</b></span>`;
                icerik += `<span>RAM: <b style="color:${data.sistem.ram_yuzdesi > 80 ? '#ff8800' : '#00ff88'}">${data.sistem.ram_yuzdesi}%</b></span>`;
                icerik += `</div></div>`;
            }

            // İstatistikler
            if (data.istatistik) {
                icerik += `<div style="background:rgba(0,180,255,0.1);padding:8px;border-radius:4px;margin:8px 0;">`;
                icerik += `<div style="font-size:10px;color:#00b4ff;margin-bottom:4px;">İSTATİSTİKLER</div>`;
                icerik += `<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;font-size:11px;">`;
                for (const [key, val] of Object.entries(data.istatistik)) {
                    const label = key.replace(/_/g, ' ').replace(/^\w/, c => c.toUpperCase());
                    icerik += `<span style="color:#888;">${label}:</span><span style="color:#fff;">${typeof val === 'number' ? val.toLocaleString() : val}</span>`;
                }
                icerik += `</div></div>`;
            }

            // Son eylem
            if (data.son_eylem) {
                const zaman = data.son_eylem.zaman ? new Date(data.son_eylem.zaman).toLocaleString('tr-TR') : '';
                icerik += `<div style="background:rgba(255,136,0,0.1);padding:8px;border-radius:4px;margin:8px 0;">`;
                icerik += `<div style="font-size:10px;color:#ff8800;margin-bottom:4px;">SON EYLEM</div>`;
                icerik += `<div style="font-size:11px;color:#fff;">${data.son_eylem.tip || data.son_eylem.detay || 'N/A'}</div>`;
                icerik += `<div style="font-size:9px;color:#666;">${zaman}</div>`;
                icerik += `</div>`;
            }

            icerik += `</div>`;

            // Modal göster
            const modal = document.createElement('div');
            modal.id = 'komutaModulModal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:100000;';
            modal.innerHTML = `
                <div style="background:linear-gradient(135deg,rgba(26,26,26,0.98),rgba(10,10,10,0.98));border:1px solid rgba(0,180,255,0.3);border-radius:12px;padding:20px;max-width:400px;max-height:80vh;overflow-y:auto;box-shadow:0 0 30px rgba(0,180,255,0.2);">
                    ${icerik}
                    <button onclick="document.getElementById('komutaModulModal').remove()" style="width:100%;margin-top:10px;padding:8px;background:rgba(0,180,255,0.2);border:1px solid rgba(0,180,255,0.3);border-radius:6px;color:#00b4ff;cursor:pointer;">Kapat</button>
                </div>
            `;
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            document.body.appendChild(modal);
        }

        // Alarmları yükle
        async function komutaAlarmlarYukle() {
            try {
                const res = await fetch('/api/beyin/alarmlar');
                const data = await res.json();

                if (data.basarili && data.alarmlar) {
                    komutaState.alarmlar = data.alarmlar;
                    komutaAlarmListesiGuncelle();
                    document.getElementById('komutaAlarmCount').textContent = data.alarmlar.length;
                    document.getElementById('komutaUyariSayisi').textContent = data.alarmlar.filter(a => a.seviye === 'uyari').length;
                    document.getElementById('komutaTehditSayisi').textContent = data.alarmlar.filter(a => a.seviye === 'tehdit' || a.seviye === 'kritik').length;
                }
            } catch (e) {
                console.log('[KOMUTA] Alarm yüklenemedi:', e);
            }
        }

        // Alarm listesini güncelle
        function komutaAlarmListesiGuncelle() {
            const listEl = document.getElementById('komutaAlarmList');
            if (!listEl) return;

            if (komutaState.alarmlar.length === 0) {
                listEl.innerHTML = '<div style="color:#666;text-align:center;padding:20px;">Alarm yok</div>';
                return;
            }

            listEl.innerHTML = komutaState.alarmlar.slice(0, 5).map(alarm => {
                const renk = alarm.seviye === 'kritik' ? '#ff3355' : alarm.seviye === 'tehdit' ? '#ff8800' : '#ffaa00';
                const zaman = alarm.zaman ? new Date(alarm.zaman).toLocaleTimeString('tr-TR') : '';
                return `
                    <div style="padding:8px;background:rgba(${renk === '#ff3355' ? '255,51,85' : renk === '#ff8800' ? '255,136,0' : '255,170,0'},0.1);border-left:3px solid ${renk};border-radius:0 4px 4px 0;margin-bottom:4px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <span style="color:${renk};font-weight:bold;font-size:10px;">${alarm.tip || 'ALARM'}</span>
                            <span style="color:#666;font-size:9px;">${zaman}</span>
                        </div>
                        <div style="color:#aaa;font-size:9px;margin-top:2px;">${alarm.mesaj || alarm.aciklama || 'Detay yok'}</div>
                    </div>
                `;
            }).join('');
        }

        // Onay bekleyenleri yükle
        async function komutaOnayBekleyenleriYukle() {
            try {
                const res = await fetch('/api/beyin/onay-bekleyenler');
                const data = await res.json();

                if (data.bekleyenler && data.bekleyenler.length > 0) {
                    komutaState.onayBekleyenler = data.bekleyenler;
                    document.getElementById('komutaOnayPanel').style.display = 'block';
                    komutaOnayListesiGuncelle();
                    document.getElementById('komutaAlertCount').textContent = data.bekleyenler.length;
                } else {
                    document.getElementById('komutaOnayPanel').style.display = 'none';
                    document.getElementById('komutaAlertCount').textContent = '!';
                }
            } catch (e) {
                console.log('[KOMUTA] Onay bekleyenler yüklenemedi');
            }
        }

        // Onay listesini güncelle
        function komutaOnayListesiGuncelle() {
            const listEl = document.getElementById('komutaOnayList');
            if (!listEl) return;

            listEl.innerHTML = komutaState.onayBekleyenler.map(aksiyon => `
                <div style="padding:8px;background:rgba(255,170,0,0.1);border:1px solid rgba(255,170,0,0.3);border-radius:6px;margin-bottom:4px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <span style="color:#ffaa00;font-weight:bold;font-size:10px;">${aksiyon.tip || aksiyon.aksiyon_tipi}</span>
                        <div style="display:flex;gap:4px;">
                            <button onclick="komutaOnayModalAc('${aksiyon.id}')" style="padding:4px 8px;background:#00ff88;border:none;border-radius:4px;color:#000;font-size:9px;cursor:pointer;">✓</button>
                            <button onclick="komutaReddet('${aksiyon.id}')" style="padding:4px 8px;background:#ff3355;border:none;border-radius:4px;color:#fff;font-size:9px;cursor:pointer;">✗</button>
                        </div>
                    </div>
                    <div style="color:#888;font-size:9px;margin-top:2px;">${aksiyon.hedef || ''}</div>
                </div>
            `).join('');
        }

        // DEFCON değiştir
        async function komutaDefconDegistir(seviye) {
            komutaState.defcon = seviye;
            const config = DEFCON_CONFIG[seviye];

            // UI güncelle
            const levelEl = document.getElementById('komutaDefconLevel');
            const textEl = document.getElementById('komutaDefconText');
            const panelEl = document.getElementById('komutaDefconPanel');

            levelEl.textContent = seviye;
            levelEl.style.color = config.color;
            textEl.textContent = config.text;
            textEl.style.color = config.color;
            panelEl.style.background = `linear-gradient(135deg,${config.bg},rgba(0,0,0,0.3))`;
            panelEl.style.borderColor = config.color + '66';

            // Backend'e gönder
            try {
                await fetch('/api/beyin/defcon', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ seviye: seviye })
                });
                termLog(`[KOMUTA] DEFCON ${seviye} - ${config.text}`, seviye <= 2 ? 'err' : seviye <= 3 ? 'warn' : 'ok');
            } catch (e) {
                console.error('[KOMUTA] DEFCON güncellenemedi:', e);
            }
        }

        // Modül detayı göster
        function komutaModulDetay(modul) {
            const detay = komutaState.moduller[modul];
            if (!detay) {
                showToast(`${modul.toUpperCase()} modülü bilgisi yok`, 'warning');
                return;
            }

            const mesaj = `${modul.toUpperCase()}: ${detay.aktif ? 'AKTİF' : 'PASİF'}`;
            showToast(mesaj, detay.aktif ? 'success' : 'info');

            // Detaylı log
            termLog(`[KOMUTA] ${modul.toUpperCase()} durumu: ${JSON.stringify(detay.detay || {})}`, 'info');
        }

        // Hızlı aksiyonlar
        async function komutaAksiyon(tip) {
            termLog(`[KOMUTA] ${tip} aksiyonu başlatılıyor...`, 'info');

            switch (tip) {
                case 'ghost_full':
                    await komutaTamGhostMod();
                    break;
                case 'lockdown':
                    await komutaLockdown();
                    break;
                case 'scan_all':
                    await komutaTamTarama();
                    break;
                case 'report':
                    await komutaDurumRaporu();
                    break;
                default:
                    showToast('Bilinmeyen aksiyon: ' + tip, 'warning');
            }
        }

        // Tam Ghost Mod
        async function komutaTamGhostMod() {
            termLog('[GHOST] Tam gizlilik modu aktive ediliyor...', 'info');

            try {
                // 1. TOR başlat
                await fetch('/api/stealth/baslat', { method: 'POST' });
                termLog('[GHOST] TOR ağı aktif', 'ok');

                // 2. Ghost Mode aktif
                await fetch('/api/ghost/aktif', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ seviye: 'MILITARY' })
                });
                termLog('[GHOST] Askeri seviye şifreleme aktif', 'ok');

                // 3. Stealth seviye maksimum
                await fetch('/api/stealth/seviye', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ seviye: 'maximum' })
                });
                termLog('[GHOST] Maksimum gizlilik aktif', 'ok');

                showToast('TAM GHOST MOD AKTİF - Askeri seviye gizlilik', 'success');

                // Modül durumlarını yenile
                await komutaModulDurumlariYukle();

            } catch (e) {
                termLog('[GHOST] Aktivasyon hatası: ' + e.message, 'err');
                showToast('Ghost mod aktivasyon hatası', 'danger');
            }
        }

        // Lockdown modu
        async function komutaLockdown() {
            if (!confirm('⚠️ LOCKDOWN MODU\n\nTüm dış bağlantılar kesilecek, sadece kritik servisler çalışacak.\n\nDevam etmek istiyor musunuz?')) {
                return;
            }

            termLog('[LOCKDOWN] Acil durum modu başlatılıyor...', 'warn');

            try {
                await fetch('/api/beyin/lockdown', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ aktif: true })
                });

                komutaDefconDegistir(1);
                showToast('🔒 LOCKDOWN AKTİF - Tüm dış erişimler engellendi', 'danger');

            } catch (e) {
                termLog('[LOCKDOWN] Hata: ' + e.message, 'err');
            }
        }

        // Tam tarama
        async function komutaTamTarama() {
            termLog('[TARAMA] Kapsamlı güvenlik taraması başlatılıyor...', 'info');

            try {
                // Paralel taramalar başlat
                const taramalar = [
                    fetch('/api/sigint/scan/full', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: '{}' }),
                    fetch('/api/threats/scan', { method: 'POST' }),
                    fetch('/api/harita/hunter/tara', { method: 'POST' })
                ];

                await Promise.allSettled(taramalar);

                termLog('[TARAMA] Tüm taramalar başlatıldı', 'ok');
                showToast('Kapsamlı tarama başlatıldı', 'success');

                // Sonuçları bekle ve güncelle
                setTimeout(komutaModulDurumlariYukle, 5000);

            } catch (e) {
                termLog('[TARAMA] Hata: ' + e.message, 'err');
            }
        }

        // Durum raporu
        async function komutaDurumRaporu() {
            termLog('[RAPOR] Sistem durumu raporu hazırlanıyor...', 'info');

            const rapor = {
                zaman: new Date().toISOString(),
                defcon: komutaState.defcon,
                moduller: komutaState.moduller,
                alarmSayisi: komutaState.alarmlar.length,
                aktifModulSayisi: Object.values(komutaState.moduller).filter(m => m.aktif).length
            };

            console.log('[KOMUTA RAPORU]', rapor);
            termLog(`[RAPOR] DEFCON: ${rapor.defcon}, Aktif Modül: ${rapor.aktifModulSayisi}, Alarm: ${rapor.alarmSayisi}`, 'ok');

            showToast(`Sistem Durumu: DEFCON ${rapor.defcon} - ${rapor.aktifModulSayisi} modül aktif`, 'info');
        }

        // Onay modal aç
        function komutaOnayModalAc(aksiyonId) {
            const aksiyon = komutaState.onayBekleyenler.find(a => a.id === aksiyonId);
            if (!aksiyon) return;

            komutaState.aktifAksiyonId = aksiyonId;

            document.getElementById('komutaOnayIcerik').innerHTML = `
                <p><strong>Aksiyon:</strong> ${aksiyon.tip || aksiyon.aksiyon_tipi}</p>
                <p><strong>Hedef:</strong> ${aksiyon.hedef || 'Belirtilmemiş'}</p>
                <p><strong>Sebep:</strong> ${aksiyon.sebep || 'Otomatik tespit'}</p>
                <p><strong>Risk:</strong> ${aksiyon.risk_seviyesi || 'Orta'}</p>
            `;

            document.getElementById('komutaOnayModal').style.display = 'flex';
        }

        // Onay ver
        async function komutaOnayVer(onay) {
            const aksiyonId = komutaState.aktifAksiyonId;
            if (!aksiyonId) return;

            try {
                await fetch('/api/beyin/onay', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ aksiyon_id: aksiyonId, onay: onay })
                });

                document.getElementById('komutaOnayModal').style.display = 'none';
                komutaState.aktifAksiyonId = null;

                showToast(onay ? 'Aksiyon onaylandı' : 'Aksiyon reddedildi', onay ? 'success' : 'warning');

                // Listeyi yenile
                await komutaOnayBekleyenleriYukle();

            } catch (e) {
                showToast('Onay işlemi başarısız', 'danger');
            }
        }

        // Onay reddet
        async function komutaReddet(aksiyonId) {
            try {
                await fetch('/api/beyin/onay', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ aksiyon_id: aksiyonId, onay: false, sebep: 'Manuel red' })
                });

                showToast('Aksiyon reddedildi', 'warning');
                await komutaOnayBekleyenleriYukle();

            } catch (e) {
                showToast('Red işlemi başarısız', 'danger');
            }
        }

        // KOMUTA paneli yenile
        async function komutaPaneliYenile() {
            await komutaModulDurumlariYukle();
            await komutaAlarmlarYukle();
            await komutaOnayBekleyenleriYukle();
        }

        // KOMUTA flyout açıldığında
        const originalToggleFlyout = toggleFlyout;
        toggleFlyout = function(panelId) {
            originalToggleFlyout(panelId);

            if (panelId === 'komuta') {
                // İlk yükleme
                komutaPaneliYenile();

                // Periyodik yenileme başlat
                if (komutaState.yenilemeInterval) {
                    clearInterval(komutaState.yenilemeInterval);
                }
                komutaState.yenilemeInterval = setInterval(komutaPaneliYenile, 10000);
            } else {
                // Başka panel açıldı, yenilemeyi durdur
                if (komutaState.yenilemeInterval) {
                    clearInterval(komutaState.yenilemeInterval);
                    komutaState.yenilemeInterval = null;
                }
            }
        };

        // KOMUTA pulse animasyonu
        const komutaStyle = document.createElement('style');
        komutaStyle.textContent = `
            @keyframes komutaPulse {
                0%, 100% { box-shadow: 0 0 5px rgba(255,85,85,0.3); }
                50% { box-shadow: 0 0 15px rgba(255,85,85,0.6), 0 0 25px rgba(255,136,0,0.3); }
            }
            .komuta-modul:hover {
                transform: scale(1.05);
                box-shadow: 0 0 15px rgba(255,255,255,0.1) !important;
            }
        `;
        document.head.appendChild(komutaStyle);

        // Sayfa yüklendiğinde BEYIN durumunu al
        document.addEventListener('DOMContentLoaded', function() {
            // BEYIN durumunu kontrol et
            fetch('/api/beyin/durum')
                .then(res => res.json())
                .then(data => {
                    if (data.basarili && data.defcon) {
                        komutaState.defcon = data.defcon;
                    }
                })
                .catch(() => {});
        });

        console.log('[TSUNAMI] KOMUTA MERKEZİ fonksiyonları yüklendi');

        // ══════════════════════════════════════════════════════════════════════════════
        // SHANNON AI PENTESTER JAVASCRIPT
        // ══════════════════════════════════════════════════════════════════════════════

        const shannonState = {
            sessions: [],
            activeScan: null,
            findings: [],
            moduleStatus: null,
            pollingInterval: null
        };

        // Shannon pentest başlat
        async function shannonStartPentest() {
            const targetUrl = document.getElementById('shannonTargetUrl').value.trim();
            const repoPath = document.getElementById('shannonRepoPath').value.trim();

            if (!targetUrl) {
                showToast('Hedef URL gerekli!', 'danger');
                return;
            }

            if (!targetUrl.startsWith('http://') && !targetUrl.startsWith('https://')) {
                showToast('URL http:// veya https:// ile başlamalı', 'warning');
                return;
            }

            termLog(`[SHANNON] Pentest başlatılıyor: ${targetUrl}`, 'info');

            try {
                const res = await fetch('/api/shannon/start', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        target_url: targetUrl,
                        repo_path: repoPath || null
                    })
                });
                const data = await res.json();

                if (data.basarili) {
                    termLog(`[SHANNON] ✓ Pentest başlatıldı: ${data.session_id}`, 'ok');
                    showToast(`Pentest başlatıldı: ${data.session_id}`, 'success');

                    shannonState.activeScan = data.session_id;
                    shannonUpdateUI();
                    shannonStartPolling(data.session_id);

                    // Badge göster
                    const badge = document.getElementById('shannonScanCount');
                    if (badge) {
                        badge.style.display = 'block';
                        badge.textContent = '1';
                    }
                } else {
                    termLog(`[SHANNON] ✗ Hata: ${data.hata}`, 'err');
                    showToast(`Hata: ${data.hata}`, 'danger');
                }
            } catch (e) {
                termLog(`[SHANNON] ✗ Bağlantı hatası: ${e.message}`, 'err');
                showToast('Bağlantı hatası', 'danger');
            }
        }

        // Status polling başlat
        function shannonStartPolling(sessionId) {
            if (shannonState.pollingInterval) {
                clearInterval(shannonState.pollingInterval);
            }

            shannonState.pollingInterval = setInterval(async () => {
                const status = await shannonCheckStatus(sessionId);

                if (status === 'completed' || status === 'failed') {
                    clearInterval(shannonState.pollingInterval);
                    shannonState.pollingInterval = null;

                    if (status === 'completed') {
                        termLog('[SHANNON] ✓✓ Pentest tamamlandı!', 'ok');
                        showToast('Shannon pentest tamamlandı!', 'success');
                        await shannonLoadFindings(sessionId);
                    } else {
                        termLog('[SHANNON] ✗ Pentest başarısız', 'err');
                        showToast('Pentest başarısız', 'danger');
                    }
                }
            }, 5000);
        }

        // Session status kontrolü
        async function shannonCheckStatus(sessionId) {
            try {
                const res = await fetch(`/api/shannon/status/${sessionId}`);
                const data = await res.json();

                if (data.basarili) {
                    const statusEl = document.getElementById('shannonModuleStatus');
                    if (statusEl) {
                        const statusColors = {
                            'running': { bg: 'rgba(255,204,0,0.2)', color: '#ffcc00', text: 'ÇALIŞIYOR' },
                            'completed': { bg: 'rgba(0,255,136,0.2)', color: '#00ff88', text: 'TAMAMLANDI' },
                            'failed': { bg: 'rgba(255,51,85,0.2)', color: '#ff3355', text: 'BAŞARISIZ' },
                            'pending': { bg: 'rgba(156,39,176,0.2)', color: '#9c27b0', text: 'BEKLEMEDE' }
                        };
                        const s = statusColors[data.status] || statusColors.pending;
                        statusEl.style.background = s.bg;
                        statusEl.style.color = s.color;
                        statusEl.textContent = s.text;
                    }

                    if (data.findings_count > 0) {
                        document.getElementById('shannonFindingCount').textContent = data.findings_count;
                        document.getElementById('shannonTotalFindings').textContent = data.findings_count;
                    }

                    return data.status;
                }
            } catch (e) {
                console.error('[SHANNON] Status check error:', e);
            }
            return null;
        }

        // Bulguları yükle
        async function shannonLoadFindings(sessionId) {
            try {
                const res = await fetch(`/api/shannon/findings/${sessionId || shannonState.activeScan}`);
                const data = await res.json();

                if (data.basarili && data.findings) {
                    shannonState.findings = data.findings;
                    shannonRenderFindings(data.findings);

                    document.getElementById('shannonFindingCount').textContent = data.toplam;
                    document.getElementById('shannonTotalFindings').textContent = data.toplam;

                    termLog(`[SHANNON] ${data.toplam} bulgu yüklendi`, 'info');
                }
            } catch (e) {
                console.error('[SHANNON] Findings load error:', e);
            }
        }

        // Bulguları render et
        function shannonRenderFindings(findings) {
            const container = document.getElementById('shannonFindingsList');
            if (!container) return;

            if (!findings || findings.length === 0) {
                container.innerHTML = '<div style="color:#666;text-align:center;padding:15px;font-size:10px;">Bulgu yok - test başlatın</div>';
                return;
            }

            const severityColors = {
                critical: '#ff3355',
                high: '#ff8800',
                medium: '#ffcc00',
                low: '#00ff88',
                info: '#00b4ff'
            };

            const severityLabels = {
                critical: 'KRİTİK',
                high: 'YÜKSEK',
                medium: 'ORTA',
                low: 'DÜŞÜK',
                info: 'BİLGİ'
            };

            container.innerHTML = findings.map(f => `
                <div class="shannon-finding" style="padding:8px;margin:4px 0;background:rgba(${f.severity === 'critical' ? '255,51,85' : '255,136,0'},0.1);border-left:3px solid ${severityColors[f.severity]};border-radius:0 4px 4px 0;cursor:pointer;" onclick="shannonShowFindingDetail('${f.id}')">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <span style="color:${severityColors[f.severity]};font-weight:bold;font-size:10px;">${f.vulnerability_type.toUpperCase().replace('_', ' ')}</span>
                        <span style="color:#888;font-size:8px;background:${severityColors[f.severity]}22;padding:2px 5px;border-radius:3px;">${severityLabels[f.severity]}</span>
                    </div>
                    <div style="color:#fff;font-size:10px;margin-top:3px;">${f.title.substring(0, 50)}${f.title.length > 50 ? '...' : ''}</div>
                    <div style="color:#666;font-size:9px;margin-top:2px;font-family:monospace;">${f.method} ${f.location.substring(0, 40)}</div>
                    <div style="margin-top:4px;display:flex;align-items:center;gap:4px;">
                        <span style="color:#00ff88;font-size:8px;">✓ Doğrulanmış Exploit</span>
                    </div>
                </div>
            `).join('');
        }

        // Bulgu detayı göster
        function shannonShowFindingDetail(findingId) {
            const finding = shannonState.findings.find(f => f.id === findingId);
            if (!finding) return;

            const severityColors = { critical: '#ff3355', high: '#ff8800', medium: '#ffcc00', low: '#00ff88' };

            const modal = document.createElement('div');
            modal.id = 'shannonFindingModal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;z-index:100001;';
            modal.innerHTML = `
                <div style="background:linear-gradient(135deg,rgba(26,26,26,0.98),rgba(10,10,10,0.98));border:2px solid ${severityColors[finding.severity] || '#9c27b0'};border-radius:12px;padding:20px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                        <span style="color:${severityColors[finding.severity]};font-weight:bold;font-size:12px;background:${severityColors[finding.severity]}22;padding:4px 10px;border-radius:4px;">${finding.severity.toUpperCase()}</span>
                        <span style="color:#666;font-size:10px;">${finding.id}</span>
                    </div>
                    <h3 style="color:#fff;margin:0 0 10px 0;font-size:14px;">${finding.title}</h3>

                    <div style="background:rgba(0,0,0,0.3);padding:10px;border-radius:6px;margin-bottom:10px;">
                        <div style="color:#888;font-size:9px;margin-bottom:4px;">KONUM</div>
                        <div style="color:#00b4ff;font-size:11px;font-family:monospace;">${finding.method} ${finding.location}</div>
                    </div>

                    <div style="background:rgba(156,39,176,0.1);padding:10px;border-radius:6px;margin-bottom:10px;">
                        <div style="color:#9c27b0;font-size:9px;margin-bottom:4px;">AÇIK TİPİ</div>
                        <div style="color:#fff;font-size:11px;">${finding.vulnerability_type.toUpperCase().replace('_', ' ')}</div>
                    </div>

                    ${finding.impact ? `
                    <div style="background:rgba(255,136,0,0.1);padding:10px;border-radius:6px;margin-bottom:10px;">
                        <div style="color:#ff8800;font-size:9px;margin-bottom:4px;">ETKİ</div>
                        <div style="color:#fff;font-size:10px;">${finding.impact}</div>
                    </div>` : ''}

                    ${finding.exploitation_steps && finding.exploitation_steps.length > 0 ? `
                    <div style="background:rgba(255,51,85,0.1);padding:10px;border-radius:6px;margin-bottom:10px;">
                        <div style="color:#ff3355;font-size:9px;margin-bottom:4px;">EXPLOİT ADIMLARI</div>
                        <ol style="margin:0;padding-left:16px;color:#fff;font-size:10px;">
                            ${finding.exploitation_steps.map(s => `<li style="margin-bottom:4px;">${s}</li>`).join('')}
                        </ol>
                    </div>` : ''}

                    <div style="margin-top:12px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.1);display:flex;gap:8px;">
                        <button onclick="document.getElementById('shannonFindingModal').remove()" style="flex:1;padding:10px;background:rgba(100,100,100,0.3);border:1px solid rgba(100,100,100,0.5);border-radius:6px;color:#aaa;cursor:pointer;">Kapat</button>
                    </div>
                </div>
            `;
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            document.body.appendChild(modal);
        }

        // Oturumları yenile
        async function shannonRefreshSessions() {
            try {
                const res = await fetch('/api/shannon/sessions');
                const data = await res.json();

                if (data.basarili) {
                    shannonState.sessions = data.sessions;
                    shannonRenderSessions(data.sessions);

                    // Aktif tarama sayısı
                    const activeCount = data.sessions.filter(s => s.status === 'running').length;
                    document.getElementById('shannonActiveScans').textContent = activeCount;

                    const badge = document.getElementById('shannonScanCount');
                    if (badge) {
                        if (activeCount > 0) {
                            badge.style.display = 'block';
                            badge.textContent = activeCount;
                        } else {
                            badge.style.display = 'none';
                        }
                    }
                }
            } catch (e) {
                console.error('[SHANNON] Sessions refresh error:', e);
            }
        }

        // Oturumları render et
        function shannonRenderSessions(sessions) {
            const container = document.getElementById('shannonSessionList');
            if (!container) return;

            const activeSessions = sessions.filter(s => s.status === 'running' || s.status === 'pending');

            if (activeSessions.length === 0) {
                container.innerHTML = '<div style="color:#666;text-align:center;padding:15px;font-size:10px;">Aktif pentest yok</div>';
                return;
            }

            const statusColors = {
                running: '#ffcc00',
                pending: '#9c27b0',
                completed: '#00ff88',
                failed: '#ff3355'
            };

            container.innerHTML = activeSessions.map(s => `
                <div style="padding:8px;background:rgba(156,39,176,0.1);border:1px solid rgba(156,39,176,0.3);border-radius:6px;margin-bottom:6px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <span style="color:${statusColors[s.status]};font-size:10px;font-weight:bold;">${s.status.toUpperCase()}</span>
                        <button onclick="shannonCancelScan('${s.session_id}')" style="padding:2px 6px;background:rgba(255,51,85,0.2);border:1px solid rgba(255,51,85,0.4);border-radius:3px;color:#ff5577;font-size:8px;cursor:pointer;">İptal</button>
                    </div>
                    <div style="color:#fff;font-size:10px;margin-top:4px;word-break:break-all;">${s.target_url}</div>
                    <div style="color:#666;font-size:8px;margin-top:2px;">${s.session_id}</div>
                </div>
            `).join('');
        }

        // Taramayı iptal et
        async function shannonCancelScan(sessionId) {
            if (!confirm('Bu pentesti iptal etmek istediğinizden emin misiniz?')) return;

            try {
                const res = await fetch(`/api/shannon/cancel/${sessionId}`, { method: 'POST' });
                const data = await res.json();

                if (data.basarili) {
                    showToast('Pentest iptal edildi', 'info');
                    await shannonRefreshSessions();
                } else {
                    showToast(data.hata || 'İptal edilemedi', 'warning');
                }
            } catch (e) {
                showToast('İptal hatası', 'danger');
            }
        }

        // Haritada göster
        async function shannonShowOnMap() {
            if (!shannonState.activeScan) {
                showToast('Önce bir pentest tamamlanmalı', 'warning');
                return;
            }

            try {
                const res = await fetch(`/api/shannon/findings/${shannonState.activeScan}/markers`);
                const data = await res.json();

                if (data.basarili && data.markers && data.markers.length > 0) {
                    // Haritaya marker'ları ekle
                    data.markers.forEach(marker => {
                        const m = L.circleMarker([marker.lat, marker.lng], {
                            radius: marker.radius || 12,
                            fillColor: marker.color,
                            color: '#fff',
                            weight: 2,
                            opacity: 1,
                            fillOpacity: 0.8
                        });

                        m.bindPopup(marker.popup, { maxWidth: 350 });
                        m.bindTooltip(marker.tooltip, { permanent: false, direction: 'top' });
                        m.addTo(map);

                        // Pulse efekti kritik için
                        if (marker.pulse) {
                            m.getElement()?.classList.add('shannon-marker-pulse');
                        }
                    });

                    // İlk marker'a zoom
                    if (data.markers.length > 0) {
                        map.setView([data.markers[0].lat, data.markers[0].lng], 10);
                    }

                    termLog(`[SHANNON] ${data.markers.length} bulgu haritaya eklendi`, 'ok');
                    showToast(`${data.markers.length} bulgu haritaya eklendi`, 'success');

                    // Flyout kapat
                    closeFlyout();
                } else {
                    showToast('Haritaya eklenecek bulgu yok', 'info');
                }
            } catch (e) {
                console.error('[SHANNON] Map markers error:', e);
                showToast('Harita hatası', 'danger');
            }
        }

        // SOAR'a aktar
        async function shannonExportToSOAR() {
            if (!shannonState.activeScan) {
                showToast('Önce bir pentest tamamlanmalı', 'warning');
                return;
            }

            try {
                const res = await fetch(`/api/shannon/findings/${shannonState.activeScan}/soar`, { method: 'POST' });
                const data = await res.json();

                if (data.basarili) {
                    termLog(`[SHANNON] ${data.incidents_created} incident SOAR'a aktarıldı`, 'ok');
                    showToast(`${data.incidents_created} incident SOAR'a aktarıldı`, 'success');
                } else {
                    showToast(data.hata || 'SOAR aktarımı başarısız', 'danger');
                }
            } catch (e) {
                console.error('[SHANNON] SOAR export error:', e);
                showToast('SOAR bağlantı hatası', 'danger');
            }
        }

        // UI güncelle
        async function shannonUpdateUI() {
            try {
                const res = await fetch('/api/shannon/durum');
                const data = await res.json();

                if (data.basarili) {
                    shannonState.moduleStatus = data;

                    // Stats güncelle
                    document.getElementById('shannonActiveScans').textContent = data.istatistik?.aktif_pentest || 0;
                    document.getElementById('shannonTotalFindings').textContent = data.istatistik?.toplam_bulgu || 0;
                    document.getElementById('shannonSuccessRate').textContent = (data.istatistik?.basari_orani || 96) + '%';

                    // Module status
                    const statusEl = document.getElementById('shannonModuleStatus');
                    if (statusEl) {
                        if (data.aktif) {
                            statusEl.style.background = 'rgba(0,255,136,0.2)';
                            statusEl.style.color = '#00ff88';
                            statusEl.textContent = data.istatistik?.aktif_pentest > 0 ? 'ÇALIŞIYOR' : 'HAZIR';
                        } else {
                            statusEl.style.background = 'rgba(255,51,85,0.2)';
                            statusEl.style.color = '#ff3355';
                            statusEl.textContent = 'DEVRE DIŞI';
                        }
                    }
                }
            } catch (e) {
                console.error('[SHANNON] UI update error:', e);
            }
        }

        // Shannon flyout açıldığında
        const originalToggleFlyoutForShannon = toggleFlyout;
        toggleFlyout = function(panelId) {
            originalToggleFlyoutForShannon(panelId);

            if (panelId === 'shannon') {
                shannonUpdateUI();
                shannonRefreshSessions();

                // Son taramanın bulgularını yükle
                if (shannonState.activeScan) {
                    shannonLoadFindings(shannonState.activeScan);
                }
            }
        };

        // Shannon marker pulse animasyonu CSS
        const shannonStyle = document.createElement('style');
        shannonStyle.textContent = `
            .shannon-marker-pulse {
                animation: shannonPulse 1.5s ease-in-out infinite;
            }
            @keyframes shannonPulse {
                0%, 100% { transform: scale(1); opacity: 0.8; }
                50% { transform: scale(1.3); opacity: 1; }
            }
            .shannon-finding:hover {
                background: rgba(156,39,176,0.2) !important;
                transform: translateX(2px);
            }
        `;
        document.head.appendChild(shannonStyle);

        console.log('[TSUNAMI] SHANNON AI PENTESTER fonksiyonları yüklendi');

        // ══════════════════════════════════════════════════════════════════════════════

        // ══════════════════════════════════════════════════════════════════════════════
        // FAZ 3: PALANTIR-STYLE GÖRSELLEŞTİRME - TIMELINE COMPONENT
        // ══════════════════════════════════════════════════════════════════════════════

        // Timeline State
        const timelineState = {
            events: [],
            filteredEvents: [],
            selectedEvent: null,
            playbackActive: false,
            playbackSpeed: 1000,
            currentTime: null,
            timeRange: { start: null, end: null },
            filters: {
                type: 'all', // all, threat, camera, iot, network, physical
                severity: 'all', // all, critical, high, medium, low
                source: 'all' // all, shannon, iot, video, ai_prediction
            }
        };

        // Timeline Event Types & Colors
        const timelineConfig = {
            eventTypes: {
                threat: { color: '#ff3355', icon: '⚠️', label: 'Tehdit' },
                camera: { color: '#00b4ff', icon: '📹', label: 'Kamera' },
                iot: { color: '#00ff9d', icon: '📡', label: 'IoT' },
                network: { color: '#8855ff', icon: '🌐', label: 'Ağ' },
                physical: { color: '#ffaa00', icon: '🔒', label: 'Fiziksel' },
                ai_prediction: { color: '#ff00ff', icon: '🤖', label: 'AI Tahmin' }
            },
            severityColors: {
                critical: '#ff3355',
                high: '#ffaa00',
                medium: '#ffcc00',
                low: '#00ff88'
            }
        };

        // Timeline DOM Elements
        function createTimelineUI() {
            const timelineHTML = `
                <div id="timelinePanel" class="timeline-panel" style="display: none;">
                    <div class="timeline-header">
                        <div class="timeline-title">
                            <h3><span class="timeline-icon">📅</span> Event Timeline</h3>
                        </div>
                        <div class="timeline-controls">
                            <button id="timelinePlayBtn" class="timeline-btn" title="Oynat/Durdur">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                    <path id="playIcon" d="M8 5v14l11-7z"/>
                                    <path id="pauseIcon" d="M6 19h4V5H6v14zm8 0h4V5h-4V5z" style="display: none;"/>
                                </svg>
                            </button>
                            <button id="timelineClearBtn" class="timeline-btn" title="Temizle">🗑️</button>
                            <button id="timelineCloseBtn" class="timeline-btn" title="Kapat">✕</button>
                        </div>
                    </div>

                    <div class="timeline-filters">
                        <select id="timelineTypeFilter" class="timeline-filter-select">
                            <option value="all">Tüm Türler</option>
                            <option value="threat">Tehditler</option>
                            <option value="camera">Kameralar</option>
                            <option value="iot">IoT Cihazlar</option>
                            <option value="network">Ağ Olayları</option>
                            <option value="physical">Fiziksel Güvenlik</option>
                            <option value="ai_prediction">AI Tahminler</option>
                        </select>
                        <select id="timelineSeverityFilter" class="timeline-filter-select">
                            <option value="all">Tüm Seviyeler</option>
                            <option value="critical">Kritik</option>
                            <option value="high">Yüksek</option>
                            <option value="medium">Orta</option>
                            <option value="low">Düşük</option>
                        </select>
                        <select id="timelineSourceFilter" class="timeline-filter-select">
                            <option value="all">Tüm Kaynaklar</option>
                            <option value="shannon">Shannon Pentest</option>
                            <option value="iot">IoT Monitor</option>
                            <option value="video">Video Stream</option>
                            <option value="ai">AI Prediction</option>
                        </select>
                    </div>

                    <div class="timeline-stats">
                        <div class="timeline-stat">
                            <span class="stat-value" id="timelineTotalEvents">0</span>
                            <span class="stat-label">Toplam</span>
                        </div>
                        <div class="timeline-stat">
                            <span class="stat-value" id="timelineFilteredEvents">0</span>
                            <span class="stat-label">Filtreli</span>
                        </div>
                        <div class="timeline-stat">
                            <span class="stat-value" id="timelineCriticalCount">0</span>
                            <span class="stat-label stat-critical">Kritik</span>
                        </div>
                    </div>

                    <div class="timeline-content">
                        <div id="timelineEvents" class="timeline-events"></div>
                    </div>

                    <div class="timeline-detail-panel" id="timelineDetailPanel" style="display: none;">
                        <div class="detail-header">
                            <h4 id="detailTitle">Event Detayı</h4>
                            <button class="detail-close-btn" onclick="closeTimelineDetail()">✕</button>
                        </div>
                        <div class="detail-content" id="detailContent"></div>
                    </div>

                    <div class="timeline-playback" id="timelinePlayback">
                        <div class="playback-progress">
                            <div class="playback-bar" id="playbackBar"></div>
                        </div>
                        <div class="playback-time" id="playbackTime">--:--</div>
                        <div class="playback-speed">
                            <button class="speed-btn" data-speed="500">0.5x</button>
                            <button class="speed-btn active" data-speed="1000">1x</button>
                            <button class="speed-btn" data-speed="2000">2x</button>
                        </div>
                    </div>
                </div>
            `;

            // Add timeline HTML to body
            document.body.insertAdjacentHTML('beforeend', timelineHTML);

            // Add timeline CSS styles
            const timelineStyles = `
                <style id="timelineStyles">
                    .timeline-panel {
                        position: fixed;
                        top: 50%;
                        right: 20px;
                        transform: translateY(-50%);
                        width: 420px;
                        max-height: 80vh;
                        background: var(--bg-panel);
                        border: 1px solid var(--border-glow);
                        border-radius: 8px;
                        box-shadow: 0 0 30px rgba(0, 180, 255, 0.3);
                        display: flex;
                        flex-direction: column;
                        z-index: 2000;
                        backdrop-filter: blur(10px);
                    }

                    .timeline-header {
                        padding: 15px;
                        border-bottom: 1px solid var(--border-subtle);
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    }

                    .timeline-title h3 {
                        margin: 0;
                        color: var(--text-bright);
                        font-size: 16px;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    }

                    .timeline-icon {
                        font-size: 18px;
                    }

                    .timeline-controls {
                        display: flex;
                        gap: 8px;
                    }

                    .timeline-btn {
                        width: 32px;
                        height: 32px;
                        border: 1px solid var(--border-glow);
                        background: var(--bg-glass);
                        color: var(--text-bright);
                        border-radius: 4px;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        transition: all 0.3s;
                    }

                    .timeline-btn:hover {
                        background: var(--accent-primary);
                        border-color: var(--accent-primary);
                        box-shadow: 0 0 15px var(--accent-primary);
                    }

                    .timeline-filters {
                        padding: 10px 15px;
                        display: flex;
                        gap: 8px;
                        border-bottom: 1px solid var(--border-subtle);
                        flex-wrap: wrap;
                    }

                    .timeline-filter-select {
                        flex: 1;
                        min-width: 120px;
                        padding: 6px 10px;
                        background: var(--bg-deep);
                        border: 1px solid var(--border-subtle);
                        color: var(--text-normal);
                        border-radius: 4px;
                        font-size: 12px;
                        cursor: pointer;
                    }

                    .timeline-stats {
                        padding: 10px 15px;
                        display: flex;
                        gap: 15px;
                        border-bottom: 1px solid var(--border-subtle);
                    }

                    .timeline-stat {
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                    }

                    .stat-value {
                        font-size: 18px;
                        font-weight: bold;
                        color: var(--text-bright);
                    }

                    .stat-label {
                        font-size: 11px;
                        color: var(--text-dim);
                        text-transform: uppercase;
                    }

                    .stat-critical {
                        color: var(--accent-danger) !important;
                    }

                    .timeline-content {
                        flex: 1;
                        overflow-y: auto;
                        padding: 10px 15px;
                    }

                    .timeline-events {
                        display: flex;
                        flex-direction: column;
                        gap: 10px;
                    }

                    .timeline-event {
                        background: var(--bg-card);
                        border-left: 3px solid var(--border-glow);
                        border-radius: 4px;
                        padding: 12px;
                        cursor: pointer;
                        transition: all 0.3s;
                        position: relative;
                    }

                    .timeline-event:hover {
                        background: var(--bg-glass);
                        transform: translateX(-5px);
                        box-shadow: 0 4px 15px rgba(0, 180, 255, 0.2);
                    }

                    .timeline-event.critical {
                        border-left-color: var(--accent-danger);
                    }

                    .timeline-event.high {
                        border-left-color: var(--accent-warning);
                    }

                    .timeline-event.medium {
                        border-left-color: #ffcc00;
                    }

                    .timeline-event.low {
                        border-left-color: var(--accent-secondary);
                    }

                    .event-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 8px;
                    }

                    .event-type {
                        display: flex;
                        align-items: center;
                        gap: 6px;
                        font-size: 13px;
                        font-weight: 600;
                        color: var(--text-bright);
                    }

                    .event-time {
                        font-size: 11px;
                        color: var(--text-dim);
                    }

                    .event-description {
                        font-size: 12px;
                        color: var(--text-normal);
                        margin-bottom: 6px;
                    }

                    .event-meta {
                        display: flex;
                        gap: 10px;
                        flex-wrap: wrap;
                    }

                    .event-tag {
                        font-size: 10px;
                        padding: 2px 6px;
                        background: var(--bg-deep);
                        border-radius: 3px;
                        color: var(--text-dim);
                    }

                    .event-source {
                        color: var(--accent-primary);
                    }

                    .timeline-detail-panel {
                        position: absolute;
                        top: 0;
                        left: -440px;
                        width: 400px;
                        max-height: 100%;
                        background: var(--bg-panel);
                        border: 1px solid var(--border-glow);
                        border-radius: 8px;
                        box-shadow: 0 0 30px rgba(0, 180, 255, 0.4);
                        display: flex;
                        flex-direction: column;
                        z-index: 2001;
                    }

                    .detail-header {
                        padding: 15px;
                        border-bottom: 1px solid var(--border-subtle);
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    }

                    .detail-header h4 {
                        margin: 0;
                        color: var(--text-bright);
                    }

                    .detail-close-btn {
                        width: 28px;
                        height: 28px;
                        border: 1px solid var(--border-glow);
                        background: var(--bg-glass);
                        color: var(--text-bright);
                        border-radius: 4px;
                        cursor: pointer;
                    }

                    .detail-content {
                        padding: 15px;
                        flex: 1;
                        overflow-y: auto;
                    }

                    .detail-section {
                        margin-bottom: 15px;
                    }

                    .detail-section:last-child {
                        margin-bottom: 0;
                    }

                    .detail-label {
                        font-size: 11px;
                        color: var(--text-dim);
                        text-transform: uppercase;
                        margin-bottom: 5px;
                    }

                    .detail-value {
                        font-size: 13px;
                        color: var(--text-normal);
                    }

                    .timeline-playback {
                        padding: 10px 15px;
                        border-top: 1px solid var(--border-subtle);
                    }

                    .playback-progress {
                        width: 100%;
                        height: 4px;
                        background: var(--bg-deep);
                        border-radius: 2px;
                        margin-bottom: 8px;
                        overflow: hidden;
                    }

                    .playback-bar {
                        height: 100%;
                        background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
                        width: 0%;
                        transition: width 0.3s;
                    }

                    .playback-time {
                        text-align: center;
                        font-size: 12px;
                        color: var(--text-normal);
                        margin-bottom: 8px;
                    }

                    .playback-speed {
                        display: flex;
                        justify-content: center;
                        gap: 8px;
                    }

                    .speed-btn {
                        padding: 4px 8px;
                        background: var(--bg-deep);
                        border: 1px solid var(--border-subtle);
                        color: var(--text-normal);
                        border-radius: 4px;
                        font-size: 11px;
                        cursor: pointer;
                        transition: all 0.3s;
                    }

                    .speed-btn:hover, .speed-btn.active {
                        background: var(--accent-primary);
                        border-color: var(--accent-primary);
                    }

                    /* Scrollbar */
                    .timeline-content::-webkit-scrollbar,
                    .detail-content::-webkit-scrollbar {
                        width: 4px;
                    }

                    .timeline-content::-webkit-scrollbar-track,
                    .detail-content::-webkit-scrollbar-track {
                        background: var(--bg-deep);
                    }

                    .timeline-content::-webkit-scrollbar-thumb,
                    .detail-content::-webkit-scrollbar-thumb {
                        background: var(--border-glow);
                        border-radius: 2px;
                    }

                    /* Empty state */
                    .timeline-empty {
                        text-align: center;
                        padding: 40px 20px;
                        color: var(--text-dim);
                    }

                    .timeline-empty-icon {
                        font-size: 48px;
                        margin-bottom: 15px;
                        opacity: 0.5;
                    }
                </style>
            `;

            document.head.insertAdjacentHTML('beforeend', timelineStyles);
        }

        // Load timeline events from multiple sources
        async function loadTimelineEvents() {
            try {
                termLog('[TIMELINE] Event yükleniyor...', 'info');

                const events = [];

                // 1. Load from Shannon pentest findings
                try {
                    const shannonRes = await fetch('/api/shannon/findings');
                    const shannonData = await shannonRes.json();

                    if (shannonData.basarili && shannonData.findings) {
                        shannonData.findings.forEach(finding => {
                            events.push({
                                id: `shannon-${finding.id}`,
                                type: 'threat',
                                severity: finding.severity || 'medium',
                                timestamp: finding.timestamp || new Date().toISOString(),
                                title: finding.title || 'Pentest Bulgu',
                                description: finding.description || finding.vuln_name || '',
                                source: 'shannon',
                                metadata: finding
                            });
                        });
                    }
                } catch (e) {
                    console.warn('[TIMELINE] Shannon events yüklenemedi:', e);
                }

                // 2. Load from AI predictions
                try {
                    const aiRes = await fetch('/api/harita/ai-tahminleri/gecmis');
                    const aiData = await aiRes.json();

                    if (aiData.basarili && aiData.tahminler) {
                        aiData.tahminler.forEach(pred => {
                            events.push({
                                id: `ai-${pred.id}`,
                                type: 'ai_prediction',
                                severity: pred.risk_score > 0.7 ? 'high' : pred.risk_score > 0.4 ? 'medium' : 'low',
                                timestamp: pred.timestamp || new Date().toISOString(),
                                title: pred.tip || 'AI Tahmin',
                                description: pred.aciklama || 'Olasılı güvenlik tehdidi tespit edildi',
                                source: 'ai_prediction',
                                metadata: pred
                            });
                        });
                    }
                } catch (e) {
                    console.warn('[TIMELINE] AI events yüklenemedi:', e);
                }

                // 3. Load from IoT devices
                try {
                    const iotRes = await fetch('/api/harita/iot/istatistik');
                    const iotData = await iotRes.json();

                    if (iotData.basarili && iotData.istatistik) {
                        // Add IoT device status changes as events
                        const stats = iotData.istatistik;
                        if (stats.alert > 0) {
                            events.push({
                                id: `iot-alert-${Date.now()}`,
                                type: 'iot',
                                severity: 'high',
                                timestamp: new Date().toISOString(),
                                title: 'IoT Cihaz Alarmı',
                                description: `${stats.alert} IoT cihaz alarm durumunda`,
                                source: 'iot',
                                metadata: stats
                            });
                        }

                        // Add vulnerability events
                        if (stats.total_vulnerabilities > 0) {
                            events.push({
                                id: `iot-vuln-${Date.now()}`,
                                type: 'iot',
                                severity: stats.high_risk_devices > 0 ? 'critical' : 'medium',
                                timestamp: new Date().toISOString(),
                                title: 'IoT Güvenlik Açığı',
                                description: `${stats.total_vulnerabilities} toplam açık, ${stats.high_risk_devices} yüksek riskli`,
                                source: 'iot',
                                metadata: stats
                            });
                        }
                    }
                } catch (e) {
                    console.warn('[TIMELINE] IoT events yüklenemedi:', e);
                }

                // 4. Load from video cameras
                try {
                    const camRes = await fetch('/api/harita/kameralar/istatistik');
                    const camData = await camRes.json();

                    if (camData.basarili && camData.istatistik) {
                        const stats = camData.istatistik;
                        if (stats.error > 0) {
                            events.push({
                                id: `cam-error-${Date.now()}`,
                                type: 'camera',
                                severity: 'medium',
                                timestamp: new Date().toISOString(),
                                title: 'Kamera Hatası',
                                description: `${stats.error} kamera hatası bildirildi`,
                                source: 'video',
                                metadata: stats
                            });
                        }
                    }
                } catch (e) {
                    console.warn('[TIMELINE] Camera events yüklenemedi:', e);
                }

                // Sort events by timestamp (newest first)
                events.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                timelineState.events = events;
                applyTimelineFilters();

                termLog(`[TIMELINE] ${events.length} event yüklendi`, 'ok');
            } catch (e) {
                console.error('[TIMELINE] Event yükleme hatası:', e);
                termLog(`[TIMELINE] Event yükleme hatası: ${e.message}`, 'error');
            }
        }

        // Apply timeline filters
        function applyTimelineFilters() {
            const { type, severity, source } = timelineState.filters;

            timelineState.filteredEvents = timelineState.events.filter(event => {
                if (type !== 'all' && event.type !== type) return false;
                if (severity !== 'all' && event.severity !== severity) return false;
                if (source !== 'all' && event.source !== source) return false;
                return true;
            });

            renderTimelineEvents();
            updateTimelineStats();
        }

        // Render timeline events
        function renderTimelineEvents() {
            const container = document.getElementById('timelineEvents');

            if (timelineState.filteredEvents.length === 0) {
                container.innerHTML = `
                    <div class="timeline-empty">
                        <div class="timeline-empty-icon">📅</div>
                        <div>Gösterilecek olay yok</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = timelineState.filteredEvents.map(event => {
                const config = timelineConfig.eventTypes[event.type] || { color: '#888', icon: '•', label: event.type };
                const severityClass = event.severity || '';
                const time = new Date(event.timestamp).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
                const date = new Date(event.timestamp).toLocaleDateString('tr-TR');

                return `
                    <div class="timeline-event ${severityClass}" onclick="showTimelineDetail('${event.id}')">
                        <div class="event-header">
                            <div class="event-type">
                                <span style="color: ${config.color}">${config.icon}</span>
                                <span>${event.title}</span>
                            </div>
                            <div class="event-time">${time}</div>
                        </div>
                        <div class="event-description">${event.description}</div>
                        <div class="event-meta">
                            <span class="event-tag">${config.label}</span>
                            <span class="event-tag event-source">${event.source}</span>
                            <span class="event-tag">${date}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update timeline statistics
        function updateTimelineStats() {
            const events = timelineState.filteredEvents;
            const critical = events.filter(e => e.severity === 'critical').length;

            document.getElementById('timelineTotalEvents').textContent = timelineState.events.length;
            document.getElementById('timelineFilteredEvents').textContent = events.length;
            document.getElementById('timelineCriticalCount').textContent = critical;
        }

        // Show timeline detail panel
        function showTimelineDetail(eventId) {
            const event = timelineState.events.find(e => e.id === eventId);
            if (!event) return;

            const panel = document.getElementById('timelineDetailPanel');
            const content = document.getElementById('detailContent');

            const config = timelineConfig.eventTypes[event.type] || { color: '#888', icon: '•', label: event.type };

            content.innerHTML = `
                <div class="detail-section">
                    <div class="detail-label">Event Tip</div>
                    <div class="detail-value">
                        <span style="color: ${config.color}; font-size: 18px;">${config.icon}</span>
                        ${event.title}
                    </div>
                </div>
                <div class="detail-section">
                    <div class="detail-label">Açıklama</div>
                    <div class="detail-value">${event.description}</div>
                </div>
                <div class="detail-section">
                    <div class="detail-label">Zaman</div>
                    <div class="detail-value">${new Date(event.timestamp).toLocaleString('tr-TR')}</div>
                </div>
                <div class="detail-section">
                    <div class="detail-label">Tür</div>
                    <div class="detail-value">${config.label}</div>
                </div>
                <div class="detail-section">
                    <div class="detail-label">Seviye</div>
                    <div class="detail-value" style="color: ${timelineConfig.severityColors[event.severity] || '#888'};">
                        ${event.severity ? event.severity.toUpperCase() : 'Bilinmiyor'}
                    </div>
                </div>
                <div class="detail-section">
                    <div class="detail-label">Kaynak</div>
                    <div class="detail-value">${event.source}</div>
                </div>
                <div class="detail-section">
                    <div class="detail-label">Event ID</div>
                    <div class="detail-value" style="font-family: monospace; font-size: 11px;">${event.id}</div>
                </div>
            `;

            panel.style.display = 'flex';
        }

        // Close timeline detail panel
        function closeTimelineDetail() {
            document.getElementById('timelineDetailPanel').style.display = 'none';
        }

        // Timeline playback
        let playbackInterval = null;

        function toggleTimelinePlayback() {
            const btn = document.getElementById('timelinePlayBtn');
            const playIcon = document.getElementById('playIcon');
            const pauseIcon = document.getElementById('pauseIcon');

            if (timelineState.playbackActive) {
                // Stop playback
                clearInterval(playbackInterval);
                timelineState.playbackActive = false;
                playIcon.style.display = 'block';
                pauseIcon.style.display = 'none';
            } else {
                // Start playback
                timelineState.playbackActive = true;
                playIcon.style.display = 'none';
                pauseIcon.style.display = 'block';

                const events = timelineState.filteredEvents;
                let currentIndex = events.length - 1;

                // Update UI initially
                updatePlaybackUI(events[currentIndex]);

                playbackInterval = setInterval(() => {
                    updatePlaybackUI(events[currentIndex]);

                    if (currentIndex > 0) {
                        currentIndex--;
                    } else {
                        // Reached the beginning, stop playback
                        clearInterval(playbackInterval);
                        timelineState.playbackActive = false;
                        playIcon.style.display = 'block';
                        pauseIcon.style.display = 'none';
                    }
                }, timelineState.playbackSpeed);
            }
        }

        function updatePlaybackUI(eventIndex) {
            const events = timelineState.filteredEvents;
            const total = events.length;

            if (total === 0) return;

            const progress = ((total - 1 - eventIndex) / (total - 1)) * 100;
            document.getElementById('playbackBar').style.width = `${progress}%`;

            const event = events[eventIndex];
            const time = new Date(event.timestamp).toLocaleTimeString('tr-TR', {
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('playbackTime').textContent = time;
        }

        // Clear timeline
        function clearTimeline() {
            timelineState.events = [];
            timelineState.filteredEvents = [];
            renderTimelineEvents();
            updateTimelineStats();
            closeTimelineDetail();
        }

        // Toggle timeline panel
        function toggleTimelinePanel() {
            const panel = document.getElementById('timelinePanel');
            const isVisible = panel.style.display !== 'none';

            if (!isVisible) {
                panel.style.display = 'flex';
                if (timelineState.events.length === 0) {
                    loadTimelineEvents();
                }
            } else {
                panel.style.display = 'none';
                if (timelineState.playbackActive) {
                    toggleTimelinePlayback();
                }
            }
        }

        // Initialize timeline when page loads
        function initTimeline() {
            createTimelineUI();

            // Event listeners
            document.getElementById('timelineTypeFilter').addEventListener('change', (e) => {
                timelineState.filters.type = e.target.value;
                applyTimelineFilters();
            });

            document.getElementById('timelineSeverityFilter').addEventListener('change', (e) => {
                timelineState.filters.severity = e.target.value;
                applyTimelineFilters();
            });

            document.getElementById('timelineSourceFilter').addEventListener('change', (e) => {
                timelineState.filters.source = e.target.value;
                applyTimelineFilters();
            });

            document.getElementById('timelinePlayBtn').addEventListener('click', toggleTimelinePlayback);
            document.getElementById('timelineClearBtn').addEventListener('click', clearTimeline);
            document.getElementById('timelineCloseBtn').addEventListener('click', toggleTimelinePanel);

            // Speed buttons
            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    timelineState.playbackSpeed = parseInt(btn.dataset.speed);

                    // Restart playback if active
                    if (timelineState.playbackActive) {
                        toggleTimelinePlayback();
                        toggleTimelinePlayback();
                    }
                });
            });

            console.log('[TIMELINE] Palantir-style Timeline component hazır');
        }

        // Initialize timeline on page load
        initTimeline();

        console.log('[FAZ 3] Timeline Component eklendi - Palantir-Style Görselleştirme başladı');

        // ══════════════════════════════════════════════════════════════════════════════
        // NETWORK GRAPH VISUALIZATION (FAZ 3.2) - Palantir-Style Entity Relationship Mapping
        // ══════════════════════════════════════════════════════════════════════════════

        // Network Graph State
        const networkGraphState = {
            nodes: [],
            links: [],
            simulation: null,
            svg: null,
            zoom: null,
            selectedNode: null,
            nodeClusterBy: 'type',
            showLabels: true,
            physicsEnabled: true
        };

        // Graph Configuration
        const graphConfig = {
            nodeTypes: {
                camera: { color: '#00b4ff', icon: '📹', radius: 15, label: 'Kamera' },
                iot: { color: '#00ff9d', icon: '📡', radius: 12, label: 'IoT Cihaz' },
                threat: { color: '#ff3355', icon: '⚠️', radius: 18, label: 'Tehdit' },
                network: { color: '#8855ff', icon: '🌐', radius: 14, label: 'Ağ' },
                physical: { color: '#ffaa00', icon: '🔒', radius: 13, label: 'Fiziksel' },
                ai: { color: '#ff00ff', icon: '🤖', radius: 16, label: 'AI' },
                server: { color: '#ffcc00', icon: '🖥️', radius: 14, label: 'Sunucu' },
                user: { color: '#00ff88', icon: '👤', radius: 10, label: 'Kullanıcı' }
            },
            linkTypes: {
                connection: { color: '#666', width: 1, dasharray: 'none', label: 'Bağlantı' },
                dependency: { color: '#888', width: 2, dasharray: '5,5', label: 'Bağımlılık' },
                threat_path: { color: '#ff3355', width: 3, dasharray: 'none', label: 'Tehdit Yolu' },
                communication: { color: '#00b4ff', width: 2, dasharray: '5,5', label: 'İletişim' },
                physical: { color: '#ffaa00', width: 2, dasharray: 'none', label: 'Fiziksel' }
            }
        };

        // Create Network Graph UI
        function createNetworkGraphUI() {
            // Check if panel already exists
            if (document.getElementById('network-graph-panel')) {
                return;
            }

            const panel = document.createElement('div');
            panel.id = 'network-graph-panel';
            panel.className = 'network-graph-panel';
            panel.innerHTML = `
                <div class="graph-header">
                    <div style="display:flex;align-items:center;gap:10px;">
                        <span style="font-size:20px;">🕸️</span>
                        <strong>AĞ GRAFİK GÖRSELLEŞTİRME</strong>
                    </div>
                    <div style="display:flex;gap:5px;">
                        <button class="graph-btn" onclick="exportGraphImage()" title="📷 Grafiği Dışa Aktar">📷</button>
                        <button class="graph-btn" onclick="toggleNetworkGraphPanel()" title="Kapat">✕</button>
                    </div>
                </div>

                <div class="graph-toolbar">
                    <label style="color:#aaa;font-size:11px;">Kümeleme:</label>
                    <select id="graph-cluster-select" onchange="clusterGraphBy(this.value)" style="background:#222;border:1px solid #444;color:#fff;padding:4px 8px;border-radius:4px;">
                        <option value="type">Tipe Göre</option>
                        <option value="source">Kaynağa Göre</option>
                        <option value="severity">Şiddete Göre</option>
                        <option value="none">Yok</option>
                    </select>

                    <button class="toolbar-btn" onclick="toggleGraphLabels()" id="labels-btn" title="Etiketleri Göster/Gizle">
                        <span style="font-size:16px;">🏷️</span>
                    </button>
                    <button class="toolbar-btn" onclick="toggleGraphPhysics()" id="physics-btn" title="Fiziği Etkin/Pasif">
                        <span style="font-size:16px;">⚡</span>
                    </button>
                    <button class="toolbar-btn" onclick="resetGraphZoom()" title="Yakınlaştırmayı Sıfırla">
                        <span style="font-size:16px;">🔍</span>
                    </button>
                </div>

                <div class="graph-stats">
                    <div class="stat-item">
                        <span class="stat-label">Düğüm:</span>
                        <span class="stat-value" id="graph-node-count">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Kenar:</span>
                        <span class="stat-value" id="graph-link-count">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Küme:</span>
                        <span class="stat-value" id="graph-cluster-count">0</span>
                    </div>
                </div>

                <div class="graph-content" id="graph-container">
                    <svg id="network-graph-svg"></svg>
                </div>

                <div class="graph-legend">
                    <strong style="color:#fff;font-size:11px;">Düğüm Tipleri:</strong>
                    <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:5px;">
                        ${Object.entries(graphConfig.nodeTypes).map(([key, config]) => `
                            <div class="legend-item" style="display:flex;align-items:center;gap:4px;">
                                <span style="font-size:14px;">${config.icon}</span>
                                <span style="color:#aaa;font-size:10px;">${config.label}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            // Add styles
            const style = document.createElement('style');
            style.textContent = `
                .network-graph-panel {
                    position: fixed;
                    top: 60px;
                    right: 20px;
                    width: 500px;
                    max-height: 85vh;
                    background: rgba(10, 10, 20, 0.95);
                    backdrop-filter: blur(10px);
                    border: 1px solid rgba(255, 0, 255, 0.3);
                    border-radius: 12px;
                    box-shadow: 0 0 20px rgba(255, 0, 255, 0.2);
                    z-index: 2001;
                    display: none;
                    flex-direction: column;
                    color: #fff;
                    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
                    overflow: hidden;
                }
                .network-graph-panel.active {
                    display: flex;
                }
                .graph-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 15px;
                    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                    background: linear-gradient(135deg, rgba(255, 0, 255, 0.1), rgba(136, 85, 255, 0.05));
                }
                .graph-btn {
                    background: rgba(255, 255, 255, 0.1);
                    border: 1px solid rgba(255, 255, 255, 0.2);
                    color: #fff;
                    padding: 6px 10px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                    transition: all 0.2s;
                }
                .graph-btn:hover {
                    background: rgba(255, 0, 255, 0.3);
                    border-color: rgba(255, 0, 255, 0.5);
                }
                .graph-toolbar {
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    padding: 10px 15px;
                    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                    background: rgba(0, 0, 0, 0.3);
                }
                .toolbar-btn {
                    background: rgba(255, 255, 255, 0.1);
                    border: 1px solid rgba(255, 255, 255, 0.2);
                    color: #fff;
                    width: 36px;
                    height: 36px;
                    border-radius: 8px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: all 0.2s;
                }
                .toolbar-btn:hover {
                    background: rgba(255, 0, 255, 0.3);
                    border-color: rgba(255, 0, 255, 0.5);
                    transform: scale(1.05);
                }
                .toolbar-btn.active {
                    background: rgba(255, 0, 255, 0.4);
                    border-color: rgba(255, 0, 255, 0.6);
                }
                .graph-stats {
                    display: flex;
                    gap: 15px;
                    padding: 10px 15px;
                    background: rgba(0, 0, 0, 0.3);
                    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                }
                .stat-item {
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                }
                .stat-label {
                    color: #aaa;
                    font-size: 10px;
                    text-transform: uppercase;
                }
                .stat-value {
                    color: #0ff;
                    font-size: 18px;
                    font-weight: bold;
                }
                .graph-content {
                    flex: 1;
                    position: relative;
                    overflow: hidden;
                    background: radial-gradient(circle at center, rgba(30, 30, 50, 0.3), rgba(10, 10, 20, 0.5));
                }
                #network-graph-svg {
                    width: 100%;
                    height: 100%;
                    cursor: grab;
                }
                #network-graph-svg:active {
                    cursor: grabbing;
                }
                .node {
                    cursor: pointer;
                    transition: all 0.3s;
                }
                .node:hover {
                    filter: brightness(1.3);
                }
                .node circle {
                    stroke: #fff;
                    stroke-width: 2px;
                }
                .node text {
                    font-size: 10px;
                    fill: #fff;
                    text-anchor: middle;
                    pointer-events: none;
                    text-shadow: 0 0 3px #000;
                }
                .link {
                    stroke-opacity: 0.6;
                    transition: all 0.3s;
                }
                .link:hover {
                    stroke-opacity: 1;
                    stroke-width: 4px !important;
                }
                .link.highlighted {
                    stroke-opacity: 1;
                    stroke-width: 4px !important;
                }
                .node.dimmed {
                    opacity: 0.3;
                }
                .link.dimmed {
                    opacity: 0.1;
                }
                .graph-detail-panel {
                    position: fixed;
                    top: 60px;
                    right: 530px;
                    width: 300px;
                    max-height: 85vh;
                    background: rgba(20, 20, 30, 0.98);
                    backdrop-filter: blur(10px);
                    border: 1px solid rgba(0, 255, 255, 0.3);
                    border-radius: 12px;
                    padding: 15px;
                    overflow-y: auto;
                    display: none;
                    z-index: 2002;
                    color: #fff;
                }
                .graph-detail-panel.active {
                    display: block;
                }
                .detail-title {
                    font-size: 16px;
                    font-weight: bold;
                    margin-bottom: 15px;
                    padding-bottom: 10px;
                    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
                    color: #0ff;
                }
                .detail-row {
                    display: flex;
                    justify-content: space-between;
                    padding: 8px 0;
                    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
                }
                .detail-label {
                    color: #aaa;
                    font-size: 11px;
                }
                .detail-value {
                    color: #fff;
                    font-size: 12px;
                    text-align: right;
                }
                .close-detail {
                    float: right;
                    background: none;
                    border: none;
                    color: #aaa;
                    font-size: 18px;
                    cursor: pointer;
                    padding: 0;
                }
                .close-detail:hover {
                    color: #fff;
                }
                .graph-legend {
                    padding: 10px 15px;
                    background: rgba(0, 0, 0, 0.3);
                    border-top: 1px solid rgba(255, 255, 255, 0.1);
                }
                .legend-item {
                    display: flex;
                    align-items: center;
                    gap: 6px;
                    padding: 4px 8px;
                    background: rgba(255, 255, 255, 0.05);
                    border-radius: 4px;
                }
            `;

            document.head.appendChild(style);
            document.body.appendChild(panel);

            console.log('[NETWORK GRAPH] Palantir-style Network Graph UI oluşturuldu');
        }

        // Calculate distance between two coordinates (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // Load Network Graph Data
        async function loadNetworkGraphData() {
            termLog('[NETWORK GRAPH] Veri yükleniyor...', 'info');

            const nodes = [];
            const links = [];

            try {
                // Load IoT devices
                const iotRes = await fetch('/api/harita/iot?zoom=8');
                const iotData = await iotRes.json();
                if (iotData.basarili && iotData.cihazlar) {
                    iotData.cihazlar.forEach(device => {
                        nodes.push({
                            id: device.device_id,
                            type: 'iot',
                            label: device.name,
                            x: Math.random() * 400,
                            y: Math.random() * 300,
                            location: device.location,
                            metadata: device
                        });
                    });
                }

                // Load cameras
                const camRes = await fetch('/api/harita/kameralar?zoom=8');
                const camData = await camRes.json();
                if (camData.basarili && camData.kameralar) {
                    camData.kameralar.forEach(camera => {
                        nodes.push({
                            id: camera.id,
                            type: 'camera',
                            label: camera.ad,
                            x: Math.random() * 400,
                            y: Math.random() * 300,
                            location: camera.konum,
                            metadata: camera
                        });
                    });
                }

                // Load threats
                const threatRes = await fetch('/api/shannon/findings');
                const threatData = await threatRes.json();
                if (threatData.findings && threatData.findings.length > 0) {
                    threatData.findings.forEach((threat, idx) => {
                        nodes.push({
                            id: `threat-${idx}`,
                            type: 'threat',
                            label: threat.title || `Tehdit ${idx + 1}`,
                            x: Math.random() * 400,
                            y: Math.random() * 300,
                            severity: threat.severity || 'high',
                            metadata: threat
                        });
                    });
                }

                // Load AI predictions
                const aiRes = await fetch('/api/harita/ai-tahminleri/gecmis');
                const aiData = await aiRes.json();
                if (aiData.basarili && aiData.tahminler) {
                    aiData.tahminler.forEach((pred, idx) => {
                        nodes.push({
                            id: `ai-${idx}`,
                            type: 'ai',
                            label: `AI Tahmin ${idx + 1}`,
                            x: Math.random() * 400,
                            y: Math.random() * 300,
                            confidence: pred.guven_skoru || 0,
                            metadata: pred
                        });
                    });
                }

                // Generate links based on proximity (< 1km)
                for (let i = 0; i < nodes.length; i++) {
                    for (let j = i + 1; j < nodes.length; j++) {
                        const node1 = nodes[i];
                        const node2 = nodes[j];

                        if (node1.location && node2.location) {
                            const distance = calculateDistance(
                                node1.location[0], node1.location[1],
                                node2.location[0], node2.location[1]
                            );

                            if (distance < 1.0) { // Within 1km
                                links.push({
                                    source: node1.id,
                                    target: node2.id,
                                    type: 'connection',
                                    distance: distance
                                });
                            }
                        }

                        // Create threat paths
                        if (node1.type === 'threat' && node2.type === 'iot') {
                            links.push({
                                source: node1.id,
                                target: node2.id,
                                type: 'threat_path'
                            });
                        }
                    }
                }

                networkGraphState.nodes = nodes;
                networkGraphState.links = links;

                updateGraphStats();
                termLog(`[NETWORK GRAPH] ${nodes.length} düğüm, ${links.length} kenar yüklendi`, 'success');

            } catch (error) {
                console.error('[NETWORK GRAPH] Veri yükleme hatası:', error);
                termLog(`[NETWORK GRAPH] Veri yükleme hatası: ${error.message}`, 'error');
            }
        }

        // Render Network Graph
        function renderNetworkGraph() {
            const container = document.getElementById('graph-container');
            const width = container.clientWidth;
            const height = container.clientHeight;

            // Clear existing graph
            d3.select('#network-graph-svg').selectAll('*').remove();

            // Create SVG
            const svg = d3.select('#network-graph-svg')
                .attr('width', width)
                .attr('height', height);

            networkGraphState.svg = svg;

            // Create zoom behavior
            networkGraphState.zoom = d3.zoom()
                .scaleExtent([0.1, 4])
                .on('zoom', (event) => {
                    g.attr('transform', event.transform);
                });

            svg.call(networkGraphState.zoom);

            // Create main group for zooming
            const g = svg.append('g');

            // Create links
            const link = g.append('g')
                .selectAll('line')
                .data(networkGraphState.links)
                .enter()
                .append('line')
                .attr('class', 'link')
                .attr('stroke', d => graphConfig.linkTypes[d.type].color)
                .attr('stroke-width', d => graphConfig.linkTypes[d.type].width)
                .attr('stroke-dasharray', d => graphConfig.linkTypes[d.type].dasharray)
                .attr('x1', d => d.source.x)
                .attr('y1', d => d.source.y)
                .attr('x2', d => d.target.x)
                .attr('y2', d => d.target.y);

            // Create nodes
            const node = g.append('g')
                .selectAll('g')
                .data(networkGraphState.nodes)
                .enter()
                .append('g')
                .attr('class', 'node')
                .attr('transform', d => `translate(${d.x},${d.y})`)
                .call(d3.drag()
                    .on('start', dragStarted)
                    .on('drag', dragged)
                    .on('end', dragEnded));

            // Add circles
            node.append('circle')
                .attr('r', d => graphConfig.nodeTypes[d.type].radius)
                .attr('fill', d => graphConfig.nodeTypes[d.type].color)
                .on('click', (event, d) => showGraphDetail(d));

            // Add icons
            node.append('text')
                .text(d => graphConfig.nodeTypes[d.type].icon)
                .attr('dy', 5)
                .attr('text-anchor', 'middle')
                .style('font-size', '16px')
                .style('pointer-events', 'none');

            // Add labels (if enabled)
            if (networkGraphState.showLabels) {
                node.append('text')
                    .text(d => d.label)
                    .attr('dy', -20)
                    .style('font-size', '10px')
                    .style('fill', '#fff')
                    .style('text-anchor', 'middle')
                    .style('pointer-events', 'none');
            }

            // Create force simulation
            networkGraphState.simulation = d3.forceSimulation(networkGraphState.nodes)
                .force('link', d3.forceLink(networkGraphState.links).id(d => d.id).distance(100))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(d => graphConfig.nodeTypes[d.type].radius + 5));

            // Update positions on tick
            networkGraphState.simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                node.attr('transform', d => `translate(${d.x},${d.y})`);
            });

            // Drag functions
            function dragStarted(event, d) {
                if (!event.active) networkGraphState.simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }

            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }

            function dragEnded(event, d) {
                if (!event.active) networkGraphState.simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }

            console.log('[NETWORK GRAPH] Grafiği render edildi');
        }

        // Show Graph Detail Panel
        function showGraphDetail(node) {
            const panel = document.getElementById('graph-detail-panel');

            // Create panel if not exists
            if (!panel) {
                const detailPanel = document.createElement('div');
                detailPanel.id = 'graph-detail-panel';
                detailPanel.className = 'graph-detail-panel';
                document.body.appendChild(detailPanel);
            }

            const activePanel = document.getElementById('graph-detail-panel');
            activePanel.innerHTML = `
                <button class="close-detail" onclick="closeGraphDetail()">✕</button>
                <div class="detail-title">${graphConfig.nodeTypes[node.type].icon} ${node.label}</div>
                <div class="detail-row">
                    <span class="detail-label">Tip:</span>
                    <span class="detail-value">${graphConfig.nodeTypes[node.type].label}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">ID:</span>
                    <span class="detail-value">${node.id}</span>
                </div>
                ${node.severity ? `
                <div class="detail-row">
                    <span class="detail-label">Şiddet:</span>
                    <span class="detail-value" style="color:${graphConfig.nodeTypes[node.severity].color}">${node.severity}</span>
                </div>
                ` : ''}
                ${node.confidence ? `
                <div class="detail-row">
                    <span class="detail-label">Güven:</span>
                    <span class="detail-value">%${(node.confidence * 100).toFixed(1)}</span>
                </div>
                ` : ''}
                ${node.location ? `
                <div class="detail-row">
                    <span class="detail-label">Konum:</span>
                    <span class="detail-value">${node.location[0].toFixed(4)}, ${node.location[1].toFixed(4)}</span>
                </div>
                ` : ''}
                <div style="margin-top:15px;padding-top:15px;border-top:1px solid rgba(255,255,255,0.1);">
                    <strong style="color:#0ff;font-size:12px;">Meta Veri:</strong>
                    <pre style="background:rgba(0,0,0,0.3);padding:10px;border-radius:4px;font-size:10px;overflow-x:auto;max-height:200px;overflow-y:auto;">${JSON.stringify(node.metadata, null, 2)}</pre>
                </div>
            `;

            activePanel.classList.add('active');
        }

        // Close Graph Detail Panel
        function closeGraphDetail() {
            const panel = document.getElementById('graph-detail-panel');
            if (panel) {
                panel.classList.remove('active');
            }
        }

        // Highlight Connections
        function highlightConnections(node) {
            const connectedNodeIds = new Set([node.id]);
            const connectedLinkIds = new Set();

            networkGraphState.links.forEach((link, idx) => {
                if (link.source.id === node.id || link.target.id === node.id) {
                    connectedNodeIds.add(link.source.id);
                    connectedNodeIds.add(link.target.id);
                    connectedLinkIds.add(idx);
                }
            });

            // Dim all nodes and links
            d3.selectAll('.node').classed('dimmed', d => !connectedNodeIds.has(d.id));
            d3.selectAll('.link').classed('dimmed', (d, i) => !connectedLinkIds.has(i));

            // Highlight connected links
            d3.selectAll('.link').classed('highlighted', (d, i) => connectedLinkIds.has(i));
        }

        // Reset Graph Highlight
        function resetGraphHighlight() {
            d3.selectAll('.node').classed('dimmed', false);
            d3.selectAll('.link').classed('dimmed', false).classed('highlighted', false);
        }

        // Toggle Graph Labels
        function toggleGraphLabels() {
            networkGraphState.showLabels = !networkGraphState.showLabels;
            const btn = document.getElementById('labels-btn');

            if (networkGraphState.showLabels) {
                btn.classList.add('active');
                // Add labels to nodes
                d3.selectAll('.node')
                    .filter(d => !d.select('text:last-child').text())
                    .append('text')
                    .text(d => d.label)
                    .attr('dy', -20)
                    .style('font-size', '10px')
                    .style('fill', '#fff')
                    .style('text-anchor', 'middle')
                    .style('pointer-events', 'none');
            } else {
                btn.classList.remove('active');
                // Remove labels from nodes
                d3.selectAll('.node text').filter(d => d.textContent !== graphConfig.nodeTypes[d3.select(d.parentNode).datum().type].icon).remove();
            }
        }

        // Toggle Graph Physics
        function toggleGraphPhysics() {
            networkGraphState.physicsEnabled = !networkGraphState.physicsEnabled;
            const btn = document.getElementById('physics-btn');

            if (networkGraphState.physicsEnabled) {
                btn.classList.add('active');
                networkGraphState.simulation.alpha(1).restart();
            } else {
                btn.classList.remove('active');
                networkGraphState.simulation.stop();
            }
        }

        // Reset Graph Zoom
        function resetGraphZoom() {
            const svg = d3.select('#network-graph-svg');
            svg.transition().duration(750).call(
                networkGraphState.zoom.transform,
                d3.zoomIdentity
            );
        }

        // Cluster Graph By
        function clusterGraphBy(by) {
            networkGraphState.nodeClusterBy = by;

            // Update simulation with clustering forces
            if (by !== 'none') {
                // Group nodes and add attraction to cluster centers
                const clusters = {};
                networkGraphState.nodes.forEach(node => {
                    const key = by === 'type' ? node.type :
                                by === 'source' ? (node.metadata?.source || 'unknown') :
                                by === 'severity' ? (node.severity || 'unknown') : 'unknown';
                    if (!clusters[key]) clusters[key] = { x: Math.random() * 300 + 100, y: Math.random() * 200 + 100 };
                });

                // Add cluster forces
                Object.entries(clusters).forEach(([key, center]) => {
                    networkGraphState.simulation.force(`cluster-${key}`,
                        d3.forceX().x(center.x).strength(0.1));
                    networkGraphState.simulation.force(`cluster-y-${key}`,
                        d3.forceY().y(center.y).strength(0.1));
                });

                // Update cluster count
                document.getElementById('graph-cluster-count').textContent = Object.keys(clusters).length;
            } else {
                // Remove cluster forces
                networkGraphState.simulation.force(`cluster-type`, null);
                networkGraphState.simulation.force(`cluster-source`, null);
                networkGraphState.simulation.force(`cluster-severity`, null);
                document.getElementById('graph-cluster-count').textContent = '0';
            }

            networkGraphState.simulation.alpha(0.3).restart();
        }

        // Export Graph as Image
        function exportGraphImage() {
            const svg = document.getElementById('network-graph-svg');
            const serializer = new XMLSerializer();
            const svgStr = serializer.serializeToString(svg);
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            const img = new Image();
            img.onload = () => {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);

                const link = document.createElement('a');
                link.download = `network-graph-${Date.now()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            };

            img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgStr)));
            termLog('[NETWORK GRAPH] Grafik dışa aktarıldı', 'success');
        }

        // Update Graph Statistics
        function updateGraphStats() {
            document.getElementById('graph-node-count').textContent = networkGraphState.nodes.length;
            document.getElementById('graph-link-count').textContent = networkGraphState.links.length;

            // Count clusters based on current clustering
            const clusters = new Set();
            networkGraphState.nodes.forEach(node => {
                clusters.add(node.type);
            });
            document.getElementById('graph-cluster-count').textContent = clusters.size;
        }

        // Toggle Network Graph Panel
        function toggleNetworkGraphPanel() {
            const panel = document.getElementById('network-graph-panel');
            const isActive = panel.classList.contains('active');

            if (isActive) {
                panel.classList.remove('active');
            } else {
                panel.classList.add('active');

                // Load data and render graph
                if (networkGraphState.nodes.length === 0) {
                    loadNetworkGraphData().then(() => {
                        renderNetworkGraph();
                    });
                } else {
                    renderNetworkGraph();
                }
            }
        }

        // Initialize Network Graph on page load
        function initNetworkGraph() {
            createNetworkGraphUI();
            console.log('[NETWORK GRAPH] Palantir-style Network Graph başlatıldı');
        }

        // Initialize
        initNetworkGraph();

        console.log('[FAZ 3.2] Network Graph Component eklendi - Entity Relationship Mapping hazır');

    </script>

    <!-- ═══════════════════════════════════════════════════════════════
         FAZ 3.3: ADVANCED HEATMAP VISUALIZATION
         Multi-Layer Time-Series Heatmap System
         ═══════════════════════════════════════════════════════════════ -->
    <script>
        // ═══════════════════════════════════════════════════════════════
        // HEATMAP STATE MANAGEMENT
        // ═══════════════════════════════════════════════════════════════
        const heatmapState = {
            active: false,
            currentLayer: 'threat', // threat, camera, iot, fusion
            currentTime: 12, // 0-24 hours
            isPlaying: false,
            playbackSpeed: 1, // 0.5x, 1x, 2x, 4x
            playbackInterval: null,
            opacity: 0.7,
            blurRadius: 25,
            pointRadius: 25,
            gradientIntensity: 1.0,
            data: {
                threat: [],
                camera: [],
                iot: [],
                fusion: []
            },
            timeSeriesData: {},
            heatmapLayers: {},
            currentHeatmapLayer: null
        };

        // Color gradients for each layer
        const heatmapGradients = {
            threat: {
                0.0: 'rgba(255,255,255,0)',
                0.2: 'rgba(255,255,0,0.3)',
                0.4: 'rgba(255,200,0,0.5)',
                0.6: 'rgba(255,136,0,0.7)',
                0.8: 'rgba(255,68,0,0.8)',
                1.0: 'rgba(255,0,0,0.9)'
            },
            camera: {
                0.0: 'rgba(255,255,255,0)',
                0.3: 'rgba(135,206,250,0.4)',
                0.5: 'rgba(0,191,255,0.6)',
                0.7: 'rgba(0,100,200,0.7)',
                1.0: 'rgba(0,50,150,0.8)'
            },
            iot: {
                0.0: 'rgba(255,255,255,0)',
                0.3: 'rgba(144,238,144,0.4)',
                0.5: 'rgba(0,255,100,0.6)',
                0.7: 'rgba(0,200,50,0.7)',
                1.0: 'rgba(0,150,0,0.8)'
            },
            fusion: {
                0.0: 'rgba(255,255,255,0)',
                0.2: 'rgba(255,0,255,0.3)',
                0.4: 'rgba(136,85,255,0.5)',
                0.6: 'rgba(0,191,255,0.6)',
                0.8: 'rgba(255,200,0,0.7)',
                1.0: 'rgba(255,0,0,0.8)'
            }
        };

        // ═══════════════════════════════════════════════════════════════
        // HEATMAP UI CREATION
        // ═══════════════════════════════════════════════════════════════
        function createHeatmapUI() {
            // Check if panel already exists
            if (document.getElementById('heatmap-panel')) {
                return;
            }

            // Create panel
            const panel = document.createElement('div');
            panel.id = 'heatmap-panel';
            panel.className = 'heatmap-panel';
            panel.innerHTML = `
                <div class="heatmap-header">
                    <div class="heatmap-title">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="#ff8800">
                            <path d="M12 2C8.5 2 5.5 4.5 4.5 8c-1.5 0-3 1.5-3 3.5S3 15 4.5 15H7v-2H4.5c-.8 0-1.5-.7-1.5-1.5S3.7 10 4.5 10h1c.3-3 2.5-5.5 5.5-6V2zm4 2v2c3 .5 5.2 3 5.5 6h1c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5H17v2h2.5c1.5 0 3-1.5 3-3.5S20.5 8 19 8c-1-3.5-4-6-7.5-6h-4zm-4 8v2H8v2h2v2h2v-2h2v-2h-2v-2h-2zm4 0v2h2v-2h-2z"/>
                        </svg>
                        <span>GELIŞMIŞ ISI HARİTASI</span>
                    </div>
                    <div class="heatmap-controls">
                        <button class="heatmap-btn" onclick="refreshHeatmapData()" title="Yenile">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                            </svg>
                        </button>
                        <button class="heatmap-btn" onclick="toggleHeatmapPanel()" title="Kapat">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Layer Selector -->
                <div class="heatmap-section">
                    <div class="heatmap-section-title">KATMAN SEÇİMİ</div>
                    <div class="layer-selector">
                        <label class="layer-option">
                            <input type="radio" name="heatmap-layer" value="threat" checked onchange="switchHeatmapLayer('threat')">
                            <span class="layer-indicator layer-threat"></span>
                            <span class="layer-label">Tehdit Yoğunluğu</span>
                        </label>
                        <label class="layer-option">
                            <input type="radio" name="heatmap-layer" value="camera" onchange="switchHeatmapLayer('camera')">
                            <span class="layer-indicator layer-camera"></span>
                            <span class="layer-label">Kamera Kapsamı</span>
                        </label>
                        <label class="layer-option">
                            <input type="radio" name="heatmap-layer" value="iot" onchange="switchHeatmapLayer('iot')">
                            <span class="layer-indicator layer-iot"></span>
                            <span class="layer-label">IoT Cihazlar</span>
                        </label>
                        <label class="layer-option">
                            <input type="radio" name="heatmap-layer" value="fusion" onchange="switchHeatmapLayer('fusion')">
                            <span class="layer-indicator layer-fusion"></span>
                            <span class="layer-label">Füzyon Analizi</span>
                        </label>
                    </div>
                </div>

                <!-- Time Control -->
                <div class="heatmap-section">
                    <div class="heatmap-section-title">ZAMAN SERİSİ</div>
                    <div class="time-controls">
                        <div class="playback-controls">
                            <button class="playback-btn" id="heatmap-play-btn" onclick="toggleHeatmapPlayback()">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M8 5v14l11-7z"/>
                                </svg>
                            </button>
                            <div class="speed-controls">
                                <button class="speed-btn ${heatmapState.playbackSpeed === 0.5 ? 'active' : ''}" onclick="setHeatmapSpeed(0.5)">0.5x</button>
                                <button class="speed-btn ${heatmapState.playbackSpeed === 1 ? 'active' : ''}" onclick="setHeatmapSpeed(1)">1x</button>
                                <button class="speed-btn ${heatmapState.playbackSpeed === 2 ? 'active' : ''}" onclick="setHeatmapSpeed(2)">2x</button>
                                <button class="speed-btn ${heatmapState.playbackSpeed === 4 ? 'active' : ''}" onclick="setHeatmapSpeed(4)">4x</button>
                            </div>
                        </div>
                        <div class="time-slider-container">
                            <input type="range" class="time-slider" id="heatmap-time-slider" min="0" max="24" value="12" step="1" oninput="updateHeatmapTime(this.value)">
                            <div class="time-display">
                                <span id="heatmap-time-label">12:00</span>
                                <span class="time-range">00:00 - 24:00</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Intensity Controls -->
                <div class="heatmap-section">
                    <div class="heatmap-section-title">GÖRSEL AYARLAR</div>
                    <div class="intensity-controls">
                        <div class="control-row">
                            <label class="control-label">Opaklık</label>
                            <input type="range" class="control-slider" id="heatmap-opacity" min="0" max="100" value="70" oninput="updateHeatmapOpacity(this.value)">
                            <span class="control-value" id="heatmap-opacity-value">70%</span>
                        </div>
                        <div class="control-row">
                            <label class="control-label">Bulanıklık Yarıçapı</label>
                            <input type="range" class="control-slider" id="heatmap-blur" min="5" max="50" value="25" oninput="updateHeatmapBlur(this.value)">
                            <span class="control-value" id="heatmap-blur-value">25px</span>
                        </div>
                        <div class="control-row">
                            <label class="control-label">Nokta Yarıçapı</label>
                            <input type="range" class="control-slider" id="heatmap-radius" min="5" max="50" value="25" oninput="updateHeatmapRadius(this.value)">
                            <span class="control-value" id="heatmap-radius-value">25px</span>
                        </div>
                        <div class="control-row">
                            <label class="control-label">Gradyan Yoğunluğu</label>
                            <input type="range" class="control-slider" id="heatmap-intensity" min="50" max="200" value="100" oninput="updateHeatmapIntensity(this.value)">
                            <span class="control-value" id="heatmap-intensity-value">100%</span>
                        </div>
                    </div>
                </div>

                <!-- Statistics -->
                <div class="heatmap-section">
                    <div class="heatmap-section-title">İSTATİSTİKLER</div>
                    <div class="heatmap-stats">
                        <div class="stat-box">
                            <div class="stat-value" id="heatmap-points">0</div>
                            <div class="stat-label">Veri Noktası</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="heatmap-coverage">0 km²</div>
                            <div class="stat-label">Kapsama Alanı</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="heatmap-hotspots">0</div>
                            <div class="stat-label">Sıcak Nokta</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="heatmap-intensity-avg">0%</div>
                            <div class="stat-label">Ort. Yoğunluk</div>
                        </div>
                    </div>
                </div>

                <!-- Legend -->
                <div class="heatmap-section">
                    <div class="heatmap-section-title">LEJANT</div>
                    <div class="heatmap-legend">
                        <div class="legend-gradient" id="heatmap-legend-gradient"></div>
                        <div class="legend-labels">
                            <span>Düşük</span>
                            <span>Orta</span>
                            <span>Yüksek</span>
                            <span>Kritik</span>
                        </div>
                    </div>
                </div>

                <!-- Data Info -->
                <div class="heatmap-section">
                    <div class="heatmap-info">
                        <div class="info-item">
                            <span class="info-label">Veri Kaynağı:</span>
                            <span class="info-value" id="heatmap-source">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Son Güncelleme:</span>
                            <span class="info-value" id="heatmap-update">-</span>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(panel);

            // Add styles
            const style = document.createElement('style');
            style.textContent = `
                .heatmap-panel {
                    position: fixed;
                    top: 60px;
                    right: 20px;
                    width: 450px;
                    max-height: 85vh;
                    background: rgba(10, 10, 20, 0.95);
                    backdrop-filter: blur(10px);
                    border: 1px solid rgba(255, 136, 0, 0.3);
                    border-radius: 12px;
                    box-shadow: 0 0 20px rgba(255, 136, 0, 0.2);
                    z-index: 2001;
                    display: none;
                    flex-direction: column;
                    color: #fff;
                    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
                    overflow: hidden;
                }
                .heatmap-panel.active {
                    display: flex;
                }
                .heatmap-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 15px;
                    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                    background: linear-gradient(135deg, rgba(255, 136, 0, 0.1), rgba(255, 68, 0, 0.05));
                }
                .heatmap-title {
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    font-size: 16px;
                    font-weight: 600;
                    color: #ff8800;
                }
                .heatmap-controls {
                    display: flex;
                    gap: 8px;
                }
                .heatmap-btn {
                    background: rgba(255, 255, 255, 0.1);
                    border: 1px solid rgba(255, 255, 255, 0.2);
                    color: #fff;
                    width: 32px;
                    height: 32px;
                    border-radius: 6px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: all 0.2s;
                }
                .heatmap-btn:hover {
                    background: rgba(255, 136, 0, 0.3);
                    border-color: rgba(255, 136, 0, 0.5);
                    transform: scale(1.05);
                }
                .heatmap-section {
                    padding: 15px;
                    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                }
                .heatmap-section-title {
                    font-size: 11px;
                    font-weight: 600;
                    text-transform: uppercase;
                    color: #888;
                    margin-bottom: 12px;
                    letter-spacing: 1px;
                }
                .layer-selector {
                    display: flex;
                    flex-direction: column;
                    gap: 8px;
                }
                .layer-option {
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    padding: 8px 12px;
                    background: rgba(0, 0, 0, 0.3);
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    border-radius: 8px;
                    cursor: pointer;
                    transition: all 0.2s;
                }
                .layer-option:hover {
                    background: rgba(255, 136, 0, 0.1);
                    border-color: rgba(255, 136, 0, 0.3);
                }
                .layer-option input[type="radio"] {
                    display: none;
                }
                .layer-option input[type="radio"]:checked + .layer-indicator {
                    box-shadow: 0 0 10px currentColor;
                }
                .layer-option input[type="radio"]:checked ~ .layer-label {
                    color: #ff8800;
                    font-weight: 600;
                }
                .layer-indicator {
                    width: 16px;
                    height: 16px;
                    border-radius: 50%;
                    border: 2px solid currentColor;
                }
                .layer-threat {
                    background: linear-gradient(135deg, #ff0, #f00);
                    color: #ff3355;
                }
                .layer-camera {
                    background: linear-gradient(135deg, #87ceeb, #0064c8);
                    color: #00b4ff;
                }
                .layer-iot {
                    background: linear-gradient(135deg, #90ee90, #00c800);
                    color: #00ff88;
                }
                .layer-fusion {
                    background: linear-gradient(135deg, #f0f, #00bfff, #fc0, #f00);
                    color: #ff00ff;
                }
                .layer-label {
                    font-size: 13px;
                    color: #ccc;
                }
                .time-controls {
                    display: flex;
                    flex-direction: column;
                    gap: 12px;
                }
                .playback-controls {
                    display: flex;
                    align-items: center;
                    gap: 10px;
                }
                .playback-btn {
                    background: rgba(255, 136, 0, 0.2);
                    border: 1px solid rgba(255, 136, 0, 0.4);
                    color: #ff8800;
                    width: 44px;
                    height: 44px;
                    border-radius: 8px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: all 0.2s;
                }
                .playback-btn:hover {
                    background: rgba(255, 136, 0, 0.4);
                    transform: scale(1.05);
                }
                .playback-btn.playing {
                    background: rgba(255, 0, 0, 0.3);
                    border-color: rgba(255, 0, 0, 0.5);
                }
                .speed-controls {
                    display: flex;
                    gap: 6px;
                }
                .speed-btn {
                    background: rgba(255, 255, 255, 0.05);
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    color: #888;
                    padding: 6px 10px;
                    border-radius: 6px;
                    font-size: 11px;
                    cursor: pointer;
                    transition: all 0.2s;
                }
                .speed-btn:hover {
                    background: rgba(255, 136, 0, 0.2);
                    color: #ff8800;
                }
                .speed-btn.active {
                    background: rgba(255, 136, 0, 0.3);
                    border-color: rgba(255, 136, 0, 0.5);
                    color: #ff8800;
                }
                .time-slider-container {
                    display: flex;
                    flex-direction: column;
                    gap: 8px;
                }
                .time-slider {
                    -webkit-appearance: none;
                    width: 100%;
                    height: 6px;
                    background: linear-gradient(90deg, #003366, #ff8800);
                    border-radius: 3px;
                    outline: none;
                }
                .time-slider::-webkit-slider-thumb {
                    -webkit-appearance: none;
                    width: 18px;
                    height: 18px;
                    background: #ff8800;
                    border-radius: 50%;
                    cursor: pointer;
                    box-shadow: 0 0 10px rgba(255, 136, 0, 0.5);
                }
                .time-slider::-moz-range-thumb {
                    width: 18px;
                    height: 18px;
                    background: #ff8800;
                    border-radius: 50%;
                    cursor: pointer;
                    border: none;
                    box-shadow: 0 0 10px rgba(255, 136, 0, 0.5);
                }
                .time-display {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }
                #heatmap-time-label {
                    font-size: 24px;
                    font-weight: 700;
                    color: #ff8800;
                    font-family: 'Courier New', monospace;
                }
                .time-range {
                    font-size: 11px;
                    color: #888;
                }
                .intensity-controls {
                    display: flex;
                    flex-direction: column;
                    gap: 12px;
                }
                .control-row {
                    display: flex;
                    align-items: center;
                    gap: 10px;
                }
                .control-label {
                    font-size: 12px;
                    color: #ccc;
                    min-width: 120px;
                }
                .control-slider {
                    -webkit-appearance: none;
                    flex: 1;
                    height: 4px;
                    background: rgba(255, 255, 255, 0.1);
                    border-radius: 2px;
                    outline: none;
                }
                .control-slider::-webkit-slider-thumb {
                    -webkit-appearance: none;
                    width: 14px;
                    height: 14px;
                    background: #ff8800;
                    border-radius: 50%;
                    cursor: pointer;
                }
                .control-slider::-moz-range-thumb {
                    width: 14px;
                    height: 14px;
                    background: #ff8800;
                    border-radius: 50%;
                    cursor: pointer;
                    border: none;
                }
                .control-value {
                    font-size: 12px;
                    color: #ff8800;
                    min-width: 50px;
                    text-align: right;
                    font-family: 'Courier New', monospace;
                }
                .heatmap-stats {
                    display: grid;
                    grid-template-columns: repeat(4, 1fr);
                    gap: 10px;
                }
                .stat-box {
                    background: rgba(0, 0, 0, 0.3);
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    border-radius: 8px;
                    padding: 12px 8px;
                    text-align: center;
                }
                .stat-box .stat-value {
                    font-size: 20px;
                    font-weight: 700;
                    color: #ff8800;
                    font-family: 'Courier New', monospace;
                }
                .stat-box .stat-label {
                    font-size: 10px;
                    color: #888;
                    margin-top: 4px;
                    text-transform: uppercase;
                }
                .heatmap-legend {
                    display: flex;
                    flex-direction: column;
                    gap: 8px;
                }
                .legend-gradient {
                    height: 20px;
                    border-radius: 10px;
                    background: linear-gradient(90deg,
                        rgba(255,255,255,0) 0%,
                        rgba(255,255,0,0.3) 25%,
                        rgba(255,136,0,0.6) 50%,
                        rgba(255,68,0,0.8) 75%,
                        rgba(255,0,0,0.9) 100%
                    );
                    border: 1px solid rgba(255, 255, 255, 0.1);
                }
                .legend-labels {
                    display: flex;
                    justify-content: space-between;
                    font-size: 10px;
                    color: #888;
                }
                .heatmap-info {
                    display: flex;
                    flex-direction: column;
                    gap: 6px;
                    background: rgba(0, 0, 0, 0.3);
                    padding: 10px;
                    border-radius: 8px;
                }
                .info-item {
                    display: flex;
                    justify-content: space-between;
                    font-size: 12px;
                }
                .info-label {
                    color: #888;
                }
                .info-value {
                    color: #ff8800;
                    font-family: 'Courier New', monospace;
                }
            `;
            document.head.appendChild(style);

            // Initialize legend gradient
            updateLegendGradient();
        }

        // ═══════════════════════════════════════════════════════════════
        // DATA LOADING
        // ═══════════════════════════════════════════════════════════════
        async function loadHeatmapData() {
            try {
                termLog('[HEATMAP] Veri yükleniyor...', 'info');

                // Load threat data
                const threatRes = await fetch('/api/shannon/findings');
                if (threatRes.ok) {
                    const threatData = await threatRes.json();
                    heatmapState.data.threat = processThreatData(threatData);
                    termLog(`[HEATMAP] ${heatmapState.data.threat.length} tehdit verisi yüklendi`, 'ok');
                }

                // Load camera data
                const cameraRes = await fetch('/api/harita/kameralar?zoom=8');
                if (cameraRes.ok) {
                    const cameraData = await cameraRes.json();
                    heatmapState.data.camera = processCameraData(cameraData);
                    termLog(`[HEATMAP] ${heatmapState.data.camera.length} kamera verisi yüklendi`, 'ok');
                }

                // Load IoT data
                const iotRes = await fetch('/api/harita/iot?zoom=8');
                if (iotRes.ok) {
                    const iotData = await iotRes.json();
                    heatmapState.data.iot = processIoTData(iotData);
                    termLog(`[HEATMAP] ${heatmapState.data.iot.length} IoT verisi yüklendi`, 'ok');
                }

                // Load AI prediction data
                const aiRes = await fetch('/api/harita/ai-tahminleri/gecmis');
                if (aiRes.ok) {
                    const aiData = await aiRes.json();
                    heatmapState.data.fusion = processFusionData(aiData);
                    termLog(`[HEATMAP] ${heatmapState.data.fusion.length} füzyon verisi yüklendi`, 'ok');
                }

                // Generate time-series data
                generateTimeSeriesData();

                // Update statistics
                updateHeatmapStats();

                // Update source info
                updateHeatmapSourceInfo();

                // Render current layer
                renderCurrentHeatmapLayer();

            } catch (error) {
                console.error('[HEATMAP] Veri yükleme hatası:', error);
                termLog(`[HEATMAP] Veri yükleme hatası: ${error.message}`, 'error');
            }
        }

        function processThreatData(data) {
            const points = [];
            if (data.bulgolar || data.findings || data.markers) {
                const items = data.bulgolar || data.findings || data.markers || [];
                items.forEach(item => {
                    if (item.lat && item.lng) {
                        points.push([
                            item.lat,
                            item.lng,
                            item.severity === 'critical' ? 1.0 :
                            item.severity === 'high' ? 0.8 :
                            item.severity === 'medium' ? 0.6 : 0.4
                        ]);
                    }
                });
            }
            return points;
        }

        function processCameraData(data) {
            const points = [];
            if (data.kameralar || data.cameras || data.markers) {
                const items = data.kameralar || data.cameras || data.markers || [];
                items.forEach(item => {
                    if (item.lat && item.lng) {
                        points.push([
                            item.lat,
                            item.lng,
                            item.durum === 'active' ? 0.9 : 0.5
                        ]);
                    }
                });
            }
            return points;
        }

        function processIoTData(data) {
            const points = [];
            if (data.cihazlar || data.devices || data.markers) {
                const items = data.cihazlar || data.devices || data.markers || [];
                items.forEach(item => {
                    if (item.lat && item.lng) {
                        points.push([
                            item.lat,
                            item.lng,
                            item.durum === 'online' ? 0.9 : 0.4
                        ]);
                    }
                });
            }
            return points;
        }

        function processFusionData(data) {
            const points = [];
            if (data.tahminler || data.predictions || data.markers) {
                const items = data.tahminler || data.predictions || data.markers || [];
                items.forEach(item => {
                    if (item.lat && item.lng) {
                        points.push([
                            item.lat,
                            item.lng,
                            item.guven_skoru || item.confidence || 0.7
                        ]);
                    }
                });
            }
            return points;
        }

        function generateTimeSeriesData() {
            // Generate hourly variations for time-series animation
            ['threat', 'camera', 'iot', 'fusion'].forEach(layer => {
                heatmapState.timeSeriesData[layer] = {};
                for (let hour = 0; hour < 24; hour++) {
                    // Simulate hourly activity patterns
                    const hourFactor = Math.sin((hour - 6) * Math.PI / 12) * 0.3 + 0.7; // Peak at noon
                    heatmapState.timeSeriesData[layer][hour] = heatmapState.data[layer].map(point => [
                        point[0],
                        point[1],
                        point[2] * hourFactor * (0.8 + Math.random() * 0.4)
                    ]);
                }
            });
        }

        // ═══════════════════════════════════════════════════════════════
        // HEATMAP RENDERING
        // ═══════════════════════════════════════════════════════════════
        function renderCurrentHeatmapLayer() {
            // Remove existing heatmap layer
            if (heatmapState.currentHeatmapLayer) {
                map.removeLayer(heatmapState.currentHeatmapLayer);
                heatmapState.currentHeatmapLayer = null;
            }

            // Get data for current time
            const data = heatmapState.timeSeriesData[heatmapState.currentLayer]?.[heatmapState.currentTime] ||
                        heatmapState.data[heatmapState.currentLayer];

            if (!data || data.length === 0) {
                return;
            }

            // Create heatmap layer
            const heatLayer = L.heatLayer(data, {
                radius: heatmapState.pointRadius,
                blur: heatmapState.blurRadius,
                maxZoom: 18,
                gradient: heatmapGradients[heatmapState.currentLayer],
                minOpacity: 0.1,
                maxOpacity: heatmapState.opacity
            });

            heatLayer.addTo(map);
            heatmapState.currentHeatmapLayer = heatLayer;

            termLog(`[HEATMAP] ${heatmapState.currentLayer} katmanı oluşturuldu - ${data.length} nokta`, 'ok');
        }

        function switchHeatmapLayer(layer) {
            heatmapState.currentLayer = layer;

            // Update legend gradient
            updateLegendGradient();

            // Render new layer
            renderCurrentHeatmapLayer();

            // Update stats
            updateHeatmapStats();

            termLog(`[HEATMAP] Katman değiştirildi: ${layer}`, 'info');
        }

        function updateLegendGradient() {
            const legend = document.getElementById('heatmap-legend-gradient');
            if (!legend) return;

            const gradients = {
                threat: 'linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,0,0.3) 25%, rgba(255,200,0,0.5) 50%, rgba(255,68,0,0.8) 75%, rgba(255,0,0,0.9) 100%)',
                camera: 'linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(135,206,250,0.4) 33%, rgba(0,191,255,0.6) 66%, rgba(0,50,150,0.8) 100%)',
                iot: 'linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(144,238,144,0.4) 33%, rgba(0,255,100,0.6) 66%, rgba(0,150,0,0.8) 100%)',
                fusion: 'linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,0,255,0.3) 25%, rgba(0,191,255,0.5) 50%, rgba(255,200,0,0.7) 75%, rgba(255,0,0,0.8) 100%)'
            };

            legend.style.background = gradients[heatmapState.currentLayer];
        }

        // ═══════════════════════════════════════════════════════════════
        // TIME SERIES ANIMATION
        // ═══════════════════════════════════════════════════════════════
        function toggleHeatmapPlayback() {
            if (heatmapState.isPlaying) {
                stopHeatmapPlayback();
            } else {
                startHeatmapPlayback();
            }
        }

        function startHeatmapPlayback() {
            heatmapState.isPlaying = true;

            const btn = document.getElementById('heatmap-play-btn');
            if (btn) {
                btn.classList.add('playing');
                btn.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>`;
            }

            const interval = 1000 / heatmapState.playbackSpeed;

            heatmapState.playbackInterval = setInterval(() => {
                heatmapState.currentTime = (heatmapState.currentTime + 1) % 24;

                // Update slider
                const slider = document.getElementById('heatmap-time-slider');
                if (slider) slider.value = heatmapState.currentTime;

                // Update time label
                updateTimeLabel();

                // Render heatmap for new time
                renderCurrentHeatmapLayer();

            }, interval);

            termLog(`[HEATMAP] Animasyon başlatıldı - ${heatmapState.playbackSpeed}x hız`, 'ok');
        }

        function stopHeatmapPlayback() {
            heatmapState.isPlaying = false;

            if (heatmapState.playbackInterval) {
                clearInterval(heatmapState.playbackInterval);
                heatmapState.playbackInterval = null;
            }

            const btn = document.getElementById('heatmap-play-btn');
            if (btn) {
                btn.classList.remove('playing');
                btn.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>`;
            }

            termLog('[HEATMAP] Animasyon durduruldu', 'info');
        }

        function setHeatmapSpeed(speed) {
            heatmapState.playbackSpeed = speed;

            // Update button styles
            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === speed + 'x') {
                    btn.classList.add('active');
                }
            });

            // Restart playback if playing
            if (heatmapState.isPlaying) {
                stopHeatmapPlayback();
                startHeatmapPlayback();
            }

            termLog(`[HEATMAP] Oynatma hızı: ${speed}x`, 'info');
        }

        function updateHeatmapTime(value) {
            heatmapState.currentTime = parseInt(value);
            updateTimeLabel();
            renderCurrentHeatmapLayer();
        }

        function updateTimeLabel() {
            const label = document.getElementById('heatmap-time-label');
            if (label) {
                const hour = heatmapState.currentTime.toString().padStart(2, '0');
                label.textContent = `${hour}:00`;
            }
        }

        // ═══════════════════════════════════════════════════════════════
        // VISUAL CONTROLS
        // ═══════════════════════════════════════════════════════════════
        function updateHeatmapOpacity(value) {
            heatmapState.opacity = value / 100;
            document.getElementById('heatmap-opacity-value').textContent = value + '%';
            renderCurrentHeatmapLayer();
        }

        function updateHeatmapBlur(value) {
            heatmapState.blurRadius = parseInt(value);
            document.getElementById('heatmap-blur-value').textContent = value + 'px';
            renderCurrentHeatmapLayer();
        }

        function updateHeatmapRadius(value) {
            heatmapState.pointRadius = parseInt(value);
            document.getElementById('heatmap-radius-value').textContent = value + 'px';
            renderCurrentHeatmapLayer();
        }

        function updateHeatmapIntensity(value) {
            heatmapState.gradientIntensity = value / 100;
            document.getElementById('heatmap-intensity-value').textContent = value + '%';

            // Adjust gradient based on intensity
            const adjustedGradient = {};
            const baseGradient = heatmapGradients[heatmapState.currentLayer];
            Object.keys(baseGradient).forEach(key => {
                adjustedGradient[key] = baseGradient[key];
            });

            heatmapGradients[heatmapState.currentLayer] = adjustedGradient;
            renderCurrentHeatmapLayer();
        }

        // ═══════════════════════════════════════════════════════════════
        // STATISTICS
        // ═══════════════════════════════════════════════════════════════
        function updateHeatmapStats() {
            const data = heatmapState.data[heatmapState.currentLayer];

            // Total points
            document.getElementById('heatmap-points').textContent = data.length;

            // Calculate coverage area (approximate)
            let minLat = 90, maxLat = -90, minLng = 180, maxLng = -180;
            data.forEach(point => {
                minLat = Math.min(minLat, point[0]);
                maxLat = Math.max(maxLat, point[0]);
                minLng = Math.min(minLng, point[1]);
                maxLng = Math.max(maxLng, point[1]);
            });

            const latDiff = maxLat - minLat;
            const lngDiff = maxLng - minLng;
            const coverage = Math.round(latDiff * lngDiff * 111 * 111); // Rough km²
            document.getElementById('heatmap-coverage').textContent = coverage + ' km²';

            // Count hotspots (high intensity points)
            const hotspots = data.filter(p => p[2] > 0.7).length;
            document.getElementById('heatmap-hotspots').textContent = hotspots;

            // Average intensity
            const avgIntensity = data.length > 0
                ? Math.round(data.reduce((sum, p) => sum + p[2], 0) / data.length * 100)
                : 0;
            document.getElementById('heatmap-intensity-avg').textContent = avgIntensity + '%';
        }

        function updateHeatmapSourceInfo() {
            const sources = {
                threat: 'Shannon Pentest API',
                camera: 'Kamera API',
                iot: 'IoT Cihaz API',
                fusion: 'AI Tahmin API'
            };

            document.getElementById('heatmap-source').textContent = sources[heatmapState.currentLayer];
            document.getElementById('heatmap-update').textContent = new Date().toLocaleTimeString('tr-TR');
        }

        function refreshHeatmapData() {
            stopHeatmapPlayback();
            loadHeatmapData();
            termLog('[HEATMAP] Veriler yenilendi', 'ok');
        }

        // ═══════════════════════════════════════════════════════════════
        // PANEL TOGGLE
        // ═══════════════════════════════════════════════════════════════
        function toggleHeatmapPanel() {
            const panel = document.getElementById('heatmap-panel');
            const isActive = panel.classList.contains('active');

            if (isActive) {
                panel.classList.remove('active');
                stopHeatmapPlayback();

                // Remove heatmap layer
                if (heatmapState.currentHeatmapLayer) {
                    map.removeLayer(heatmapState.currentHeatmapLayer);
                    heatmapState.currentHeatmapLayer = null;
                }

                heatmapState.active = false;
            } else {
                panel.classList.add('active');
                heatmapState.active = true;

                // Load data if not loaded
                if (heatmapState.data.threat.length === 0) {
                    loadHeatmapData();
                } else {
                    renderCurrentHeatmapLayer();
                }
            }

            termLog(`[HEATMAP] Panel ${isActive ? 'kapandı' : 'açıldı'}`, 'info');
        }

        // ═══════════════════════════════════════════════════════════════
        // INITIALIZATION
        // ═══════════════════════════════════════════════════════════════
        function initHeatmap() {
            createHeatmapUI();
            console.log('[HEATMAP] Palantir-style Advanced Heatmap başlatıldı');
        }

        // Initialize on page load
        initHeatmap();

        console.log('[FAZ 3.3] Advanced Heatmap Component eklendi - Multi-Layer Time-Series Analysis hazır');

        // ═══════════════════════════════════════════════════════════════════════════════
        // FAZ 3.4: DATA FUSION DASHBOARD - Palantir-Style Multi-Source Analysis
        // ═══════════════════════════════════════════════════════════════════════════════

        const fusionState = {
            active: false,
            data: {
                shannon: [],
                ai: [],
                iot: [],
                cameras: []
            },
            stats: {
                shannon: { total: 0, critical: 0, lastUpdate: null, health: 'unknown' },
                ai: { total: 0, confidence: 0, lastUpdate: null, health: 'unknown' },
                iot: { total: 0, online: 0, errors: 0, lastUpdate: null, health: 'unknown' },
                cameras: { total: 0, active: 0, offline: 0, lastUpdate: null, health: 'unknown' }
            },
            correlations: {},
            anomalies: [],
            crossSourceAnalysis: {
                overlappingEntities: [],
                geographicCorrelation: [],
                temporalCorrelation: [],
                riskScore: 0
            },
            filters: {
                sources: ['shannon', 'ai', 'iot', 'cameras'],
                timeRange: '24h'
            },
            settings: {
                autoRefresh: true,
                refreshInterval: 30000,
                anomalyThreshold: 2.0,
                maxAnomalies: 50
            },
            refreshTimer: null
        };

        // ═══════════════════════════════════════════════════════════════════════════════
        // UI CREATION
        // ═══════════════════════════════════════════════════════════════════════════════
        function createFusionUI() {
            const panel = document.createElement('div');
            panel.id = 'fusion-panel';
            panel.className = 'fusion-panel';
            panel.innerHTML = `
                <div class="fusion-header">
                    <div class="fusion-title">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M3 3h8v8H3V3zm10 0h8v8h-8V3zM3 13h8v8H3v-8zm10 0h8v8h-8v-8z"/>
                        </svg>
                        <span>Veri Füzyonu</span>
                        <span class="fusion-status" id="fusionStatus">● Bağlanıyor...</span>
                    </div>
                    <div class="fusion-controls">
                        <button class="fusion-btn" onclick="refreshFusionData()" title="Verileri Yenile">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0112 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                        </button>
                        <button class="fusion-btn" onclick="exportFusionReport()" title="Rapor Dışa Aktar">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                        </button>
                        <button class="fusion-btn" onclick="toggleFusionSettings()" title="Ayarlar">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
                        </button>
                        <button class="fusion-btn" onclick="toggleFusionPanel()" title="Kapat">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                        </button>
                    </div>
                </div>

                <div class="fusion-content">
                    <!-- Statistics Overview -->
                    <div class="fusion-section">
                        <div class="fusion-section-title">Genel İstatistikler</div>
                        <div class="fusion-stats-grid">
                            <div class="fusion-stat-card fusion-stat-shannon">
                                <div class="fusion-stat-icon">⚠️</div>
                                <div class="fusion-stat-content">
                                    <div class="fusion-stat-label">Shannon</div>
                                    <div class="fusion-stat-value" id="shannonTotal">0</div>
                                    <div class="fusion-stat-detail">
                                        <span id="shannonCritical">0</span> kritik
                                    </div>
                                </div>
                                <div class="fusion-stat-health" id="shannonHealth">●</div>
                            </div>
                            <div class="fusion-stat-card fusion-stat-ai">
                                <div class="fusion-stat-icon">🤖</div>
                                <div class="fusion-stat-content">
                                    <div class="fusion-stat-label">AI Tahminleri</div>
                                    <div class="fusion-stat-value" id="aiTotal">0</div>
                                    <div class="fusion-stat-detail">
                                        <span id="aiConfidence">0</span>% güven
                                    </div>
                                </div>
                                <div class="fusion-stat-health" id="aiHealth">●</div>
                            </div>
                            <div class="fusion-stat-card fusion-stat-iot">
                                <div class="fusion-stat-icon">📡</div>
                                <div class="fusion-stat-content">
                                    <div class="fusion-stat-label">IoT Cihazlar</div>
                                    <div class="fusion-stat-value" id="iotTotal">0</div>
                                    <div class="fusion-stat-detail">
                                        <span id="iotOnline">0</span> online
                                    </div>
                                </div>
                                <div class="fusion-stat-health" id="iotHealth">●</div>
                            </div>
                            <div class="fusion-stat-card fusion-stat-cameras">
                                <div class="fusion-stat-icon">📹</div>
                                <div class="fusion-stat-content">
                                    <div class="fusion-stat-label">Kameralar</div>
                                    <div class="fusion-stat-value" id="cameraTotal">0</div>
                                    <div class="fusion-stat-detail">
                                        <span id="cameraActive">0</span> aktif
                                    </div>
                                </div>
                                <div class="fusion-stat-health" id="cameraHealth">●</div>
                            </div>
                        </div>
                    </div>

                    <!-- Correlation Matrix -->
                    <div class="fusion-section">
                        <div class="fusion-section-title">Bağıntı Matrisi</div>
                        <div class="fusion-correlation-matrix" id="correlationMatrix">
                            <div class="fusion-matrix-header">
                                <div class="fusion-matrix-corner"></div>
                                <div class="fusion-matrix-label">Shannon</div>
                                <div class="fusion-matrix-label">AI</div>
                                <div class="fusion-matrix-label">IoT</div>
                                <div class="fusion-matrix-label">Kamera</div>
                            </div>
                            <div class="fusion-matrix-row">
                                <div class="fusion-matrix-row-label">Shannon</div>
                                <div class="fusion-matrix-cell fusion-matrix-diag" data-source1="shannon" data-source2="shannon">1.0</div>
                                <div class="fusion-matrix-cell" data-source1="shannon" data-source2="ai">-</div>
                                <div class="fusion-matrix-cell" data-source1="shannon" data-source2="iot">-</div>
                                <div class="fusion-matrix-cell" data-source1="shannon" data-source2="cameras">-</div>
                            </div>
                            <div class="fusion-matrix-row">
                                <div class="fusion-matrix-row-label">AI</div>
                                <div class="fusion-matrix-cell" data-source1="ai" data-source2="shannon">-</div>
                                <div class="fusion-matrix-cell fusion-matrix-diag" data-source1="ai" data-source2="ai">1.0</div>
                                <div class="fusion-matrix-cell" data-source1="ai" data-source2="iot">-</div>
                                <div class="fusion-matrix-cell" data-source1="ai" data-source2="cameras">-</div>
                            </div>
                            <div class="fusion-matrix-row">
                                <div class="fusion-matrix-row-label">IoT</div>
                                <div class="fusion-matrix-cell" data-source1="iot" data-source2="shannon">-</div>
                                <div class="fusion-matrix-cell" data-source1="iot" data-source2="ai">-</div>
                                <div class="fusion-matrix-cell fusion-matrix-diag" data-source1="iot" data-source2="iot">1.0</div>
                                <div class="fusion-matrix-cell" data-source1="iot" data-source2="cameras">-</div>
                            </div>
                            <div class="fusion-matrix-row">
                                <div class="fusion-matrix-row-label">Kamera</div>
                                <div class="fusion-matrix-cell" data-source1="cameras" data-source2="shannon">-</div>
                                <div class="fusion-matrix-cell" data-source1="cameras" data-source2="ai">-</div>
                                <div class="fusion-matrix-cell" data-source1="cameras" data-source2="iot">-</div>
                                <div class="fusion-matrix-cell fusion-matrix-diag" data-source1="cameras" data-source2="cameras">1.0</div>
                            </div>
                        </div>
                        <div class="fusion-legend">
                            <div class="fusion-legend-item"><span class="fusion-legend-color fusion-legend-none"></span> Yok (0-0.2)</div>
                            <div class="fusion-legend-item"><span class="fusion-legend-color fusion-legend-low"></span> Düşük (0.2-0.4)</div>
                            <div class="fusion-legend-item"><span class="fusion-legend-color fusion-legend-medium"></span> Orta (0.4-0.6)</div>
                            <div class="fusion-legend-item"><span class="fusion-legend-color fusion-legend-high"></span> Yüksek (0.6-0.8)</div>
                            <div class="fusion-legend-item"><span class="fusion-legend-color fusion-legend-critical"></span> Kritik (0.8-1.0)</div>
                        </div>
                    </div>

                    <!-- Anomaly Detection -->
                    <div class="fusion-section">
                        <div class="fusion-section-title">
                            <span>Anomali Tespiti</span>
                            <span class="fusion-anomaly-count" id="anomalyCount">0</span>
                        </div>
                        <div class="fusion-anomaly-list" id="anomalyList">
                            <div class="fusion-empty-state">Anomali tespit edilmedi</div>
                        </div>
                    </div>

                    <!-- Cross-Source Analysis -->
                    <div class="fusion-section">
                        <div class="fusion-section-title">Çapraz Kaynak Analizi</div>
                        <div class="fusion-cross-source">
                            <div class="fusion-cross-item">
                                <div class="fusion-cross-label">Örtüşen Varlıklar</div>
                                <div class="fusion-cross-value" id="overlappingEntities">0</div>
                                <div class="fusion-cross-detail">Birden fazla kaynakta görülen</div>
                            </div>
                            <div class="fusion-cross-item">
                                <div class="fusion-cross-label">Coğrafi Bağıntı</div>
                                <div class="fusion-cross-value" id="geographicCorrelation">0</div>
                                <div class="fusion-cross-detail">Yakın olaylar (1km içinde)</div>
                            </div>
                            <div class="fusion-cross-item">
                                <div class="fusion-cross-label">Zamansal Bağıntı</div>
                                <div class="fusion-cross-value" id="temporalCorrelation">0</div>
                                <div class="fusion-cross-detail">Aynı zamanda olan olaylar</div>
                            </div>
                            <div class="fusion-cross-item">
                                <div class="fusion-cross-label">Risk Skoru</div>
                                <div class="fusion-cross-value" id="riskScore">0%</div>
                                <div class="fusion-cross-detail">Toplam risk seviyesi</div>
                            </div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="fusion-section">
                        <div class="fusion-section-title">Filtreler</div>
                        <div class="fusion-filters">
                            <div class="fusion-filter-group">
                                <label class="fusion-filter-label">Kaynaklar</label>
                                <div class="fusion-filter-options">
                                    <label class="fusion-filter-option">
                                        <input type="checkbox" checked value="shannon" onchange="updateFusionFilters()">
                                        <span>Shannon</span>
                                    </label>
                                    <label class="fusion-filter-option">
                                        <input type="checkbox" checked value="ai" onchange="updateFusionFilters()">
                                        <span>AI Tahminleri</span>
                                    </label>
                                    <label class="fusion-filter-option">
                                        <input type="checkbox" checked value="iot" onchange="updateFusionFilters()">
                                        <span>IoT</span>
                                    </label>
                                    <label class="fusion-filter-option">
                                        <input type="checkbox" checked value="cameras" onchange="updateFusionFilters()">
                                        <span>Kameralar</span>
                                    </label>
                                </div>
                            </div>
                            <div class="fusion-filter-group">
                                <label class="fusion-filter-label">Zaman Aralığı</label>
                                <select class="fusion-time-select" onchange="updateFusionTimeRange(this.value)">
                                    <option value="1h">Son 1 Saat</option>
                                    <option value="6h">Son 6 Saat</option>
                                    <option value="12h">Son 12 Saat</option>
                                    <option value="24h" selected>Son 24 Saat</option>
                                    <option value="7d">Son 7 Gün</option>
                                </select>
                            </div>
                            <div class="fusion-filter-group">
                                <label class="fusion-filter-option">
                                    <input type="checkbox" checked id="autoRefreshToggle" onchange="toggleFusionAutoRefresh()">
                                    <span>Otomatik Yenileme (30sn)</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(panel);

            // Add styles
            const style = document.createElement('style');
            style.textContent = `
                .fusion-panel {
                    position: fixed;
                    top: 60px;
                    left: 20px;
                    width: 500px;
                    max-height: 85vh;
                    background: rgba(10, 10, 20, 0.95);
                    backdrop-filter: blur(10px);
                    border: 1px solid rgba(138, 43, 226, 0.3);
                    border-radius: 12px;
                    box-shadow: 0 0 20px rgba(138, 43, 226, 0.2);
                    z-index: 2001;
                    display: none;
                    flex-direction: column;
                    color: #fff;
                    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
                    overflow: hidden;
                }
                .fusion-panel.active {
                    display: flex;
                }
                .fusion-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 15px;
                    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                    background: linear-gradient(135deg, rgba(138, 43, 226, 0.1), rgba(75, 0, 130, 0.05));
                }
                .fusion-title {
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    font-size: 16px;
                    font-weight: 600;
                    color: #8a2be2;
                }
                .fusion-status {
                    font-size: 10px;
                    color: #666;
                    margin-left: 10px;
                }
                .fusion-status.online { color: #00ff88; }
                .fusion-status.offline { color: #ff3355; }
                .fusion-controls {
                    display: flex;
                    gap: 8px;
                }
                .fusion-btn {
                    background: rgba(255, 255, 255, 0.1);
                    border: 1px solid rgba(255, 255, 255, 0.2);
                    color: #fff;
                    width: 32px;
                    height: 32px;
                    border-radius: 6px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: all 0.2s;
                }
                .fusion-btn:hover {
                    background: rgba(138, 43, 226, 0.3);
                    border-color: rgba(138, 43, 226, 0.5);
                    transform: scale(1.05);
                }
                .fusion-content {
                    overflow-y: auto;
                    flex: 1;
                    padding: 0;
                }
                .fusion-content::-webkit-scrollbar {
                    width: 6px;
                }
                .fusion-content::-webkit-scrollbar-track {
                    background: rgba(0, 0, 0, 0.2);
                }
                .fusion-content::-webkit-scrollbar-thumb {
                    background: rgba(138, 43, 226, 0.5);
                    border-radius: 3px;
                }
                .fusion-section {
                    padding: 15px;
                    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                }
                .fusion-section-title {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    font-size: 11px;
                    font-weight: 600;
                    text-transform: uppercase;
                    color: #888;
                    margin-bottom: 12px;
                    letter-spacing: 1px;
                }
                .fusion-anomaly-count {
                    background: rgba(255, 51, 85, 0.2);
                    color: #ff3355;
                    padding: 2px 8px;
                    border-radius: 10px;
                    font-size: 10px;
                }
                .fusion-stats-grid {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 10px;
                }
                .fusion-stat-card {
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    padding: 12px;
                    background: rgba(0, 0, 0, 0.3);
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    border-radius: 8px;
                    position: relative;
                }
                .fusion-stat-card::before {
                    content: '';
                    position: absolute;
                    left: 0;
                    top: 0;
                    bottom: 0;
                    width: 3px;
                    border-radius: 8px 0 0 8px;
                }
                .fusion-stat-shannon::before { background: #ff3355; }
                .fusion-stat-ai::before { background: #ff00ff; }
                .fusion-stat-iot::before { background: #00ff9d; }
                .fusion-stat-cameras::before { background: #00b4ff; }
                .fusion-stat-icon {
                    font-size: 24px;
                }
                .fusion-stat-content {
                    flex: 1;
                }
                .fusion-stat-label {
                    font-size: 10px;
                    color: #888;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                }
                .fusion-stat-value {
                    font-size: 20px;
                    font-weight: 700;
                    color: #fff;
                }
                .fusion-stat-detail {
                    font-size: 10px;
                    color: #666;
                }
                .fusion-stat-health {
                    font-size: 12px;
                }
                .fusion-stat-health.online { color: #00ff88; }
                .fusion-stat-health.offline { color: #ff3355; }
                .fusion-stat-health.error { color: #ffaa00; }
                .fusion-stat-health.unknown { color: #666; }
                .fusion-correlation-matrix {
                    display: grid;
                    grid-template-columns: 80px repeat(4, 1fr);
                    gap: 2px;
                }
                .fusion-matrix-header {
                    display: contents;
                }
                .fusion-matrix-corner {
                    grid-column: 1;
                }
                .fusion-matrix-label {
                    font-size: 9px;
                    font-weight: 600;
                    color: #888;
                    text-transform: uppercase;
                    text-align: center;
                    padding: 8px 0;
                }
                .fusion-matrix-row {
                    display: contents;
                }
                .fusion-matrix-row-label {
                    font-size: 9px;
                    font-weight: 600;
                    color: #888;
                    text-transform: uppercase;
                    padding: 8px 5px;
                    text-align: right;
                }
                .fusion-matrix-cell {
                    aspect-ratio: 1;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 10px;
                    font-weight: 600;
                    border-radius: 4px;
                    cursor: pointer;
                    transition: all 0.2s;
                    background: rgba(255, 255, 255, 0.05);
                    color: #fff;
                }
                .fusion-matrix-cell:hover {
                    transform: scale(1.1);
                    z-index: 1;
                }
                .fusion-matrix-diag {
                    background: rgba(138, 43, 226, 0.2) !important;
                    color: #8a2be2;
                }
                .fusion-matrix-cell.corr-none { background: rgba(128, 128, 128, 0.2); }
                .fusion-matrix-cell.corr-low { background: rgba(0, 255, 136, 0.2); }
                .fusion-matrix-cell.corr-medium { background: rgba(255, 204, 0, 0.2); }
                .fusion-matrix-cell.corr-high { background: rgba(255, 136, 0, 0.2); }
                .fusion-matrix-cell.corr-critical { background: rgba(255, 51, 85, 0.2); }
                .fusion-legend {
                    display: flex;
                    flex-wrap: wrap;
                    gap: 10px;
                    margin-top: 10px;
                    padding-top: 10px;
                    border-top: 1px solid rgba(255, 255, 255, 0.1);
                }
                .fusion-legend-item {
                    display: flex;
                    align-items: center;
                    gap: 5px;
                    font-size: 9px;
                    color: #888;
                }
                .fusion-legend-color {
                    width: 12px;
                    height: 12px;
                    border-radius: 2px;
                }
                .fusion-legend-none { background: rgba(128, 128, 128, 0.5); }
                .fusion-legend-low { background: rgba(0, 255, 136, 0.5); }
                .fusion-legend-medium { background: rgba(255, 204, 0, 0.5); }
                .fusion-legend-high { background: rgba(255, 136, 0, 0.5); }
                .fusion-legend-critical { background: rgba(255, 51, 85, 0.5); }
                .fusion-anomaly-list {
                    max-height: 200px;
                    overflow-y: auto;
                    display: flex;
                    flex-direction: column;
                    gap: 8px;
                }
                .fusion-anomaly-list::-webkit-scrollbar {
                    width: 4px;
                }
                .fusion-anomaly-list::-webkit-scrollbar-thumb {
                    background: rgba(255, 51, 85, 0.5);
                    border-radius: 2px;
                }
                .fusion-anomaly-item {
                    display: flex;
                    align-items: flex-start;
                    gap: 10px;
                    padding: 10px;
                    background: rgba(0, 0, 0, 0.3);
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    border-radius: 6px;
                    border-left: 3px solid;
                    cursor: pointer;
                    transition: all 0.2s;
                }
                .fusion-anomaly-item:hover {
                    background: rgba(255, 51, 85, 0.1);
                }
                .fusion-anomaly-item.severity-low { border-left-color: #00ff88; }
                .fusion-anomaly-item.severity-medium { border-left-color: #ffcc00; }
                .fusion-anomaly-item.severity-high { border-left-color: #ffaa00; }
                .fusion-anomaly-item.severity-critical { border-left-color: #ff3355; }
                .fusion-anomaly-icon {
                    font-size: 16px;
                }
                .fusion-anomaly-content {
                    flex: 1;
                }
                .fusion-anomaly-title {
                    font-size: 11px;
                    font-weight: 600;
                    color: #fff;
                    margin-bottom: 4px;
                }
                .fusion-anomaly-meta {
                    font-size: 9px;
                    color: #888;
                }
                .fusion-anomaly-dismiss {
                    background: none;
                    border: none;
                    color: #666;
                    cursor: pointer;
                    font-size: 14px;
                    padding: 0;
                    transition: color 0.2s;
                }
                .fusion-anomaly-dismiss:hover {
                    color: #ff3355;
                }
                .fusion-empty-state {
                    text-align: center;
                    padding: 20px;
                    color: #666;
                    font-size: 11px;
                }
                .fusion-cross-source {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 10px;
                }
                .fusion-cross-item {
                    padding: 12px;
                    background: rgba(0, 0, 0, 0.3);
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    border-radius: 8px;
                    text-align: center;
                }
                .fusion-cross-label {
                    font-size: 9px;
                    color: #888;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                    margin-bottom: 5px;
                }
                .fusion-cross-value {
                    font-size: 18px;
                    font-weight: 700;
                    color: #8a2be2;
                    margin-bottom: 3px;
                }
                .fusion-cross-detail {
                    font-size: 8px;
                    color: #666;
                }
                .fusion-filters {
                    display: flex;
                    flex-direction: column;
                    gap: 15px;
                }
                .fusion-filter-group {
                    display: flex;
                    flex-direction: column;
                    gap: 8px;
                }
                .fusion-filter-label {
                    font-size: 10px;
                    font-weight: 600;
                    color: #888;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                }
                .fusion-filter-options {
                    display: flex;
                    flex-wrap: wrap;
                    gap: 10px;
                }
                .fusion-filter-option {
                    display: flex;
                    align-items: center;
                    gap: 5px;
                    font-size: 11px;
                    color: #ccc;
                    cursor: pointer;
                }
                .fusion-filter-option input[type="checkbox"] {
                    cursor: pointer;
                }
                .fusion-time-select {
                    width: 100%;
                    padding: 8px 12px;
                    background: rgba(0, 0, 0, 0.3);
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    border-radius: 6px;
                    color: #fff;
                    font-size: 11px;
                    cursor: pointer;
                }
                .fusion-time-select:focus {
                    outline: none;
                    border-color: rgba(138, 43, 226, 0.5);
                }
                .fusion-time-select option {
                    background: #1a1a2e;
                }

                /* Animation */
                @keyframes fusionPulse {
                    0%, 100% { opacity: 1; }
                    50% { opacity: 0.5; }
                }
                .fusion-status {
                    animation: fusionPulse 2s ease-in-out infinite;
                }
            `;
            document.head.appendChild(style);

            // Add click listeners to correlation matrix cells
            document.querySelectorAll('.fusion-matrix-cell').forEach(cell => {
                cell.addEventListener('click', function() {
                    const source1 = this.dataset.source1;
                    const source2 = this.dataset.source2;
                    if (source1 && source2 && source1 !== source2) {
                        showCorrelationDetails(source1, source2);
                    }
                });
            });

            console.log('[FUSION] Data Fusion Dashboard UI oluşturuldu');
        }

        // ═══════════════════════════════════════════════════════════════════════════════
        // DATA LOADING
        // ═══════════════════════════════════════════════════════════════════════════════
        async function loadFusionData() {
            try {
                // Load all 4 data sources
                const [shannonResponse, aiResponse, iotResponse, camerasResponse] = await Promise.all([
                    fetch('/api/shannon/findings').catch(() => ({ ok: false, json: async () => [] })),
                    fetch('/api/harita/ai-tahminleri/gecmis').catch(() => ({ ok: false, json: async () => [] })),
                    fetch('/api/harita/iot?zoom=8').catch(() => ({ ok: false, json: async () => ({ devices: [] }) })),
                    fetch('/api/harita/kameralar?zoom=8').catch(() => ({ ok: false, json: async () => ({ cameras: [] }) }))
                ]);

                // Process Shannon data
                if (shannonResponse.ok) {
                    const shannonData = await shannonResponse.json();
                    fusionState.data.shannon = Array.isArray(shannonData) ? shannonData : (shannonData.findings || []);
                    fusionState.stats.shannon = {
                        total: fusionState.data.shannon.length,
                        critical: fusionState.data.shannon.filter(f => f.severity === 'critical' || f.risk_level === 'high').length,
                        lastUpdate: new Date(),
                        health: 'online'
                    };
                } else {
                    fusionState.stats.shannon.health = 'offline';
                }

                // Process AI data
                if (aiResponse.ok) {
                    const aiData = await aiResponse.json();
                    fusionState.data.ai = Array.isArray(aiData) ? aiData : (aiData.predictions || []);
                    const avgConfidence = fusionState.data.ai.length > 0
                        ? fusionState.data.ai.reduce((sum, p) => sum + (p.confidence || p.güven_skoru || 0), 0) / fusionState.data.ai.length
                        : 0;
                    fusionState.stats.ai = {
                        total: fusionState.data.ai.length,
                        confidence: Math.round(avgConfidence * 100),
                        lastUpdate: new Date(),
                        health: 'online'
                    };
                } else {
                    fusionState.stats.ai.health = 'offline';
                }

                // Process IoT data
                if (iotResponse.ok) {
                    const iotData = await iotResponse.json();
                    const iotDevices = iotData.devices || iotData.cihazlar || [];
                    fusionState.data.iot = iotDevices;
                    fusionState.stats.iot = {
                        total: iotDevices.length,
                        online: iotDevices.filter(d => d.status === 'online' || d.durum === 'aktif').length,
                        errors: iotDevices.filter(d => d.status === 'error' || d.durum === 'hata').length,
                        lastUpdate: new Date(),
                        health: 'online'
                    };
                } else {
                    fusionState.stats.iot.health = 'offline';
                }

                // Process Camera data
                if (camerasResponse.ok) {
                    const camerasData = await camerasResponse.json();
                    const cameras = camerasData.cameras || camerasData.kameralar || [];
                    fusionState.data.cameras = cameras;
                    fusionState.stats.cameras = {
                        total: cameras.length,
                        active: cameras.filter(c => c.status === 'active' || c.durum === 'aktif').length,
                        offline: cameras.filter(c => c.status === 'offline' || c.durum === 'kapalı').length,
                        lastUpdate: new Date(),
                        health: 'online'
                    };
                } else {
                    fusionState.stats.cameras.health = 'offline';
                }

                // Update UI
                updateFusionUI();

                // Calculate correlations
                calculateAllCorrelations();

                // Detect anomalies
                detectAnomalies();

                // Perform cross-source analysis
                performCrossSourceAnalysis();

                // Update status
                document.getElementById('fusionStatus').textContent = '● Çevrimiçi';
                document.getElementById('fusionStatus').className = 'fusion-status online';

                termLog('[FUSION] Tüm veri kaynakları yüklendi', 'ok');
            } catch (error) {
                console.error('[FUSION] Veri yükleme hatası:', error);
                termLog(`[FUSION] Hata: ${error.message}`, 'error');
                document.getElementById('fusionStatus').textContent = '● Çevrimdışı';
                document.getElementById('fusionStatus').className = 'fusion-status offline';
            }
        }

        // ═══════════════════════════════════════════════════════════════════════════════
        // UI UPDATES
        // ═══════════════════════════════════════════════════════════════════════════════
        function updateFusionUI() {
            // Update Shannon stats
            document.getElementById('shannonTotal').textContent = fusionState.stats.shannon.total;
            document.getElementById('shannonCritical').textContent = fusionState.stats.shannon.critical;
            updateHealthIndicator('shannonHealth', fusionState.stats.shannon.health);

            // Update AI stats
            document.getElementById('aiTotal').textContent = fusionState.stats.ai.total;
            document.getElementById('aiConfidence').textContent = fusionState.stats.ai.confidence;
            updateHealthIndicator('aiHealth', fusionState.stats.ai.health);

            // Update IoT stats
            document.getElementById('iotTotal').textContent = fusionState.stats.iot.total;
            document.getElementById('iotOnline').textContent = fusionState.stats.iot.online;
            updateHealthIndicator('iotHealth', fusionState.stats.iot.health);

            // Update Camera stats
            document.getElementById('cameraTotal').textContent = fusionState.stats.cameras.total;
            document.getElementById('cameraActive').textContent = fusionState.stats.cameras.active;
            updateHealthIndicator('cameraHealth', fusionState.stats.cameras.health);
        }

        function updateHealthIndicator(elementId, health) {
            const element = document.getElementById(elementId);
            element.className = `fusion-stat-health ${health}`;
        }

        // ═══════════════════════════════════════════════════════════════════════════════
        // CORRELATION CALCULATION
        // ═══════════════════════════════════════════════════════════════════════════════
        function calculateAllCorrelations() {
            const sources = ['shannon', 'ai', 'iot', 'cameras'];

            sources.forEach(source1 => {
                sources.forEach(source2 => {
                    if (source1 !== source2) {
                        const correlation = calculateCorrelation(source1, source2);
                        fusionState.correlations[`${source1}-${source2}`] = correlation;

                        // Update UI cell
                        const cell = document.querySelector(
                            `.fusion-matrix-cell[data-source1="${source1}"][data-source2="${source2}"]`
                        );
                        if (cell) {
                            cell.textContent = correlation.toFixed(2);
                            updateCorrelationCellStyle(cell, correlation);
                        }
                    }
                });
            });
        }

        function calculateCorrelation(source1, source2) {
            const data1 = fusionState.data[source1];
            const data2 = fusionState.data[source2];

            if (!data1 || !data2 || data1.length === 0 || data2.length === 0) {
                return 0;
            }

            // Geographic overlap (devices within 1km)
            let geographicOverlap = 0;
            let geographicCount = 0;

            data1.forEach(item1 => {
                const loc1 = item1.location || item1.konum || item1.coords || item1.koordinat;
                if (loc1 && loc1.lat && loc1.lng) {
                    data2.forEach(item2 => {
                        const loc2 = item2.location || item2.konum || item2.coords || item2.koordinat;
                        if (loc2 && loc2.lat && loc2.lng) {
                            const distance = calculateDistance(loc1.lat, loc1.lng, loc2.lat, loc2.lng);
                            if (distance < 1) { // 1km radius
                                geographicOverlap++;
                            }
                            geographicCount++;
                        }
                    });
                }
            });

            const geoCorrelation = geographicCount > 0 ? geographicOverlap / geographicCount : 0;

            // Temporal overlap (events within same hour)
            let temporalOverlap = 0;
            let temporalCount = 0;

            const now = Date.now();
            const oneHour = 60 * 60 * 1000;

            data1.forEach(item1 => {
                const time1 = item1.timestamp || item1.zaman_damgasi || item1.created_at || item1.olusturulma;
                if (time1) {
                    const t1 = new Date(time1).getTime();
                    data2.forEach(item2 => {
                        const time2 = item2.timestamp || item2.zaman_damgasi || item2.created_at || item2.olusturulma;
                        if (time2) {
                            const t2 = new Date(time2).getTime();
                            if (Math.abs(t1 - t2) < oneHour) {
                                temporalOverlap++;
                            }
                            temporalCount++;
                        }
                    });
                }
            });

            const temporalCorrelation = temporalCount > 0 ? temporalOverlap / temporalCount : 0;

            // Type overlap (same entity types)
            const types1 = new Set(data1.map(item => item.type || item.tur || item.category || item.kategori).filter(Boolean));
            const types2 = new Set(data2.map(item => item.type || item.tur || item.category || item.kategori).filter(Boolean));
            const typeIntersection = new Set([...types1].filter(x => types2.has(x)));
            const typeUnion = new Set([...types1, ...types2]);
            const typeCorrelation = typeUnion.size > 0 ? typeIntersection.size / typeUnion.size : 0;

            // Weighted average
            const correlation = (geoCorrelation * 0.4 + temporalCorrelation * 0.4 + typeCorrelation * 0.2);

            return Math.min(1.0, Math.max(0.0, correlation));
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function updateCorrelationCellStyle(cell, value) {
            // Remove all correlation classes
            cell.classList.remove('corr-none', 'corr-low', 'corr-medium', 'corr-high', 'corr-critical');

            if (value < 0.2) {
                cell.classList.add('corr-none');
            } else if (value < 0.4) {
                cell.classList.add('corr-low');
            } else if (value < 0.6) {
                cell.classList.add('corr-medium');
            } else if (value < 0.8) {
                cell.classList.add('corr-high');
            } else {
                cell.classList.add('corr-critical');
            }
        }

        function showCorrelationDetails(source1, source2) {
            const correlation = fusionState.correlations[`${source1}-${source2}`];
            const sourceNames = {
                shannon: 'Shannon',
                ai: 'AI Tahminleri',
                iot: 'IoT Cihazlar',
                cameras: 'Kameralar'
            };

            alert(`${sourceNames[source1]} - ${sourceNames[source2]}\n\nBağıntı Değeri: ${correlation.toFixed(2)}\n\nBu değer iki kaynak arasındaki ilişki seviyesini gösterir.\n0.0-0.2: Yok\n0.2-0.4: Düşük\n0.4-0.6: Orta\n0.6-0.8: Yüksek\n0.8-1.0: Kritik`);
        }

        // ═══════════════════════════════════════════════════════════════════════════════
        // ANOMALY DETECTION
        // ═══════════════════════════════════════════════════════════════════════════════
        function detectAnomalies() {
            const anomalies = [];

            // Check for spatial anomalies (unusual clustering)
            const spatialAnomalies = detectSpatialAnomalies();
            anomalies.push(...spatialAnomalies);

            // Check for temporal anomalies (sudden activity spikes)
            const temporalAnomalies = detectTemporalAnomalies();
            anomalies.push(...temporalAnomalies);

            // Check for correlation anomalies (unexpected patterns)
            const correlationAnomalies = detectCorrelationAnomalies();
            anomalies.push(...correlationAnomalies);

            // Check for data gaps
            const gapAnomalies = detectDataGaps();
            anomalies.push(...gapAnomalies);

            // Sort by severity and timestamp
            anomalies.sort((a, b) => {
                const severityOrder = { critical: 0, high: 1, medium: 2, low: 3 };
                return severityOrder[a.severity] - severityOrder[b.severity] || b.timestamp - a.timestamp;
            });

            // Keep only max anomalies (FIFO)
            fusionState.anomalies = anomalies.slice(0, fusionState.settings.maxAnomalies);

            // Update UI
            updateAnomalyUI();
        }

        function detectSpatialAnomalies() {
            const anomalies = [];
            const allData = [
                ...fusionState.data.shannon.map(item => ({ ...item, source: 'shannon' })),
                ...fusionState.data.ai.map(item => ({ ...item, source: 'ai' })),
                ...fusionState.data.iot.map(item => ({ ...item, source: 'iot' })),
                ...fusionState.data.cameras.map(item => ({ ...item, source: 'cameras' }))
            ];

            // Group by location (1km grid)
            const locationGroups = {};
            allData.forEach(item => {
                const loc = item.location || item.konum || item.coords || item.koordinat;
                if (loc && loc.lat && loc.lng) {
                    const gridKey = `${Math.floor(loc.lat * 100)}_${Math.floor(loc.lng * 100)}`;
                    if (!locationGroups[gridKey]) {
                        locationGroups[gridKey] = [];
                    }
                    locationGroups[gridKey].push(item);
                }
            });

            // Find clusters with >10 events
            Object.entries(locationGroups).forEach(([key, items]) => {
                if (items.length > 10) {
                    const severity = items.length > 20 ? 'critical' : items.length > 15 ? 'high' : 'medium';
                    anomalies.push({
                        id: `spatial_${key}`,
                        type: 'spatial',
                        title: `Yüksek Olay Yoğunluğu`,
                        description: `${items.length} olay 1km² alanda yoğunlaşıyor`,
                        severity: severity,
                        timestamp: Date.now(),
                        source: items[0].source,
                        metadata: { count: items.length, location: key }
                    });
                }
            });

            return anomalies;
        }

        function detectTemporalAnomalies() {
            const anomalies = [];
            const sources = ['shannon', 'ai', 'iot', 'cameras'];

            sources.forEach(source => {
                const data = fusionState.data[source];
                if (data.length === 0) return;

                // Calculate events per hour
                const hourlyCounts = {};
                data.forEach(item => {
                    const time = item.timestamp || item.zaman_damgasi || item.created_at || item.olusturulma;
                    if (time) {
                        const hour = new Date(time).getHours();
                        hourlyCounts[hour] = (hourlyCounts[hour] || 0) + 1;
                    }
                });

                const counts = Object.values(hourlyCounts);
                if (counts.length < 2) return;

                const mean = counts.reduce((a, b) => a + b, 0) / counts.length;
                const variance = counts.reduce((sum, count) => sum + Math.pow(count - mean, 2), 0) / counts.length;
                const stdDev = Math.sqrt(variance);

                // Find spikes (>2 standard deviations)
                Object.entries(hourlyCounts).forEach(([hour, count]) => {
                    if (count > mean + 2 * stdDev) {
                        const severity = count > mean + 4 * stdDev ? 'critical' : count > mean + 3 * stdDev ? 'high' : 'medium';
                        anomalies.push({
                            id: `temporal_${source}_${hour}`,
                            type: 'temporal',
                            title: `Ani Aktivite Artışı`,
                            description: `${source}: ${hour}:00 saatinde normalin ${Math.round(count / mean)} katı aktivite`,
                            severity: severity,
                            timestamp: Date.now(),
                            source: source,
                            metadata: { hour, count, mean: Math.round(mean) }
                        });
                    }
                });
            });

            return anomalies;
        }

        function detectCorrelationAnomalies() {
            const anomalies = [];

            // Check for unexpected high correlations
            Object.entries(fusionState.correlations).forEach(([key, value]) => {
                const [source1, source2] = key.split('-');

                // High correlation between normally uncorrelated sources
                if (value > 0.7) {
                    anomalies.push({
                        id: `correlation_${key}`,
                        type: 'correlation',
                        title: `Beklenmedik Yüksek Bağıntı`,
                        description: `${source1} ve ${source2} kaynaklarında yüksek ilişki (%${Math.round(value * 100)})`,
                        severity: value > 0.9 ? 'critical' : 'high',
                        timestamp: Date.now(),
                        source: source1,
                        metadata: { correlation: value, source2 }
                    });
                }

                // Unexpected low correlation (should be high but isn't)
                if ((source1 === 'shannon' && source2 === 'ai' || source1 === 'ai' && source2 === 'shannon') && value < 0.2) {
                    anomalies.push({
                        id: `correlation_low_${key}`,
                        type: 'correlation',
                        title: `Beklenmedik Düşük Bağıntı`,
                        description: `${source1} ve ${source2} kaynaklarında düşük ilişki`,
                        severity: 'low',
                        timestamp: Date.now(),
                        source: source1,
                        metadata: { correlation: value, source2 }
                    });
                }
            });

            return anomalies;
        }

        function detectDataGaps() {
            const anomalies = [];
            const sources = ['shannon', 'ai', 'iot', 'cameras'];
            const now = Date.now();
            const fiveMinutes = 5 * 60 * 1000;

            sources.forEach(source => {
                const lastUpdate = fusionState.stats[source]?.lastUpdate;
                if (!lastUpdate) return;

                const timeSinceUpdate = now - new Date(lastUpdate).getTime();
                if (timeSinceUpdate > fiveMinutes) {
                    const minutes = Math.floor(timeSinceUpdate / 60000);
                    anomalies.push({
                        id: `gap_${source}`,
                        type: 'data_gap',
                        title: `Veri Boşluğu`,
                        description: `${source} kaynağı ${minutes} dakikadır güncellenmiyor`,
                        severity: minutes > 15 ? 'critical' : minutes > 10 ? 'high' : 'medium',
                        timestamp: Date.now(),
                        source: source,
                        metadata: { minutesSinceUpdate: minutes }
                    });
                }
            });

            return anomalies;
        }

        function updateAnomalyUI() {
            const anomalyList = document.getElementById('anomalyList');
            const anomalyCount = document.getElementById('anomalyCount');

            anomalyCount.textContent = fusionState.anomalies.length;

            if (fusionState.anomalies.length === 0) {
                anomalyList.innerHTML = '<div class="fusion-empty-state">Anomali tespit edilmedi</div>';
                return;
            }

            const icons = {
                spatial: '🗺️',
                temporal: '⏰',
                correlation: '🔗',
                data_gap: '❌'
            };

            anomalyList.innerHTML = fusionState.anomalies.map(anomaly => `
                <div class="fusion-anomaly-item severity-${anomaly.severity}" data-id="${anomaly.id}">
                    <div class="fusion-anomaly-icon">${icons[anomaly.type] || '⚠️'}</div>
                    <div class="fusion-anomaly-content">
                        <div class="fusion-anomaly-title">${anomaly.title}</div>
                        <div class="fusion-anomaly-meta">${anomaly.description}</div>
                    </div>
                    <button class="fusion-anomaly-dismiss" onclick="dismissAnomaly('${anomaly.id}')" title="Yok say">×</button>
                </div>
            `).join('');
        }

        function dismissAnomaly(anomalyId) {
            fusionState.anomalies = fusionState.anomalies.filter(a => a.id !== anomalyId);
            updateAnomalyUI();
            termLog(`[FUSION] Anomali yok sayıldı: ${anomalyId}`, 'info');
        }

        // ═══════════════════════════════════════════════════════════════════════════════
        // CROSS-SOURCE ANALYSIS
        // ═══════════════════════════════════════════════════════════════════════════════
        function performCrossSourceAnalysis() {
            // Find overlapping entities
            const overlappingEntities = findOverlappingEntities();
            fusionState.crossSourceAnalysis.overlappingEntities = overlappingEntities;

            // Find geographic correlations
            const geographicCorrelation = findGeographicCorrelations();
            fusionState.crossSourceAnalysis.geographicCorrelation = geographicCorrelation;

            // Find temporal correlations
            const temporalCorrelation = findTemporalCorrelations();
            fusionState.crossSourceAnalysis.temporalCorrelation = temporalCorrelation;

            // Calculate risk score
            const riskScore = calculateRiskScore();
            fusionState.crossSourceAnalysis.riskScore = riskScore;

            // Update UI
            document.getElementById('overlappingEntities').textContent = overlappingEntities.length;
            document.getElementById('geographicCorrelation').textContent = geographicCorrelation.length;
            document.getElementById('temporalCorrelation').textContent = temporalCorrelation.length;
            document.getElementById('riskScore').textContent = `${riskScore}%`;
        }

        function findOverlappingEntities() {
            const overlapping = [];
            const allEntities = new Map();

            // Collect all entities with identifiers
            ['shannon', 'ai', 'iot', 'cameras'].forEach(source => {
                fusionState.data[source].forEach(item => {
                    const id = item.id || item.identifier || item.device_id || item.kamera_id || item.cihaz_id;
                    if (id) {
                        if (!allEntities.has(id)) {
                            allEntities.set(id, { id, sources: [] });
                        }
                        allEntities.get(id).sources.push(source);
                    }
                });
            });

            // Find entities appearing in multiple sources
            allEntities.forEach(entity => {
                if (entity.sources.length > 1) {
                    overlapping.push(entity);
                }
            });

            return overlapping;
        }

        function findGeographicCorrelations() {
            const correlations = [];
            const allData = [
                ...fusionState.data.shannon.map(item => ({ ...item, source: 'shannon' })),
                ...fusionState.data.ai.map(item => ({ ...item, source: 'ai' })),
                ...fusionState.data.iot.map(item => ({ ...item, source: 'iot' })),
                ...fusionState.data.cameras.map(item => ({ ...item, source: 'cameras' }))
            ];

            // Find events from different sources within 1km
            for (let i = 0; i < allData.length; i++) {
                for (let j = i + 1; j < allData.length; j++) {
                    if (allData[i].source !== allData[j].source) {
                        const loc1 = allData[i].location || allData[i].konum;
                        const loc2 = allData[j].location || allData[j].konum;

                        if (loc1 && loc2 && loc1.lat && loc1.lng && loc2.lat && loc2.lng) {
                            const distance = calculateDistance(loc1.lat, loc1.lng, loc2.lat, loc2.lng);
                            if (distance < 1) {
                                correlations.push({
                                    item1: allData[i],
                                    item2: allData[j],
                                    distance
                                });
                            }
                        }
                    }
                }
            }

            return correlations;
        }

        function findTemporalCorrelations() {
            const correlations = [];
            const allData = [
                ...fusionState.data.shannon.map(item => ({ ...item, source: 'shannon' })),
                ...fusionState.data.ai.map(item => ({ ...item, source: 'ai' })),
                ...fusionState.data.iot.map(item => ({ ...item, source: 'iot' })),
                ...fusionState.data.cameras.map(item => ({ ...item, source: 'cameras' }))
            ];

            const fiveMinutes = 5 * 60 * 1000;

            // Find events from different sources within 5 minutes
            for (let i = 0; i < allData.length; i++) {
                for (let j = i + 1; j < allData.length; j++) {
                    if (allData[i].source !== allData[j].source) {
                        const time1 = allData[i].timestamp || allData[i].zaman_damgasi;
                        const time2 = allData[j].timestamp || allData[j].zaman_damgasi;

                        if (time1 && time2) {
                            const t1 = new Date(time1).getTime();
                            const t2 = new Date(time2).getTime();
                            const timeDiff = Math.abs(t1 - t2);

                            if (timeDiff < fiveMinutes) {
                                correlations.push({
                                    item1: allData[i],
                                    item2: allData[j],
                                    timeDiff
                                });
                            }
                        }
                    }
                }
            }

            return correlations;
        }

        function calculateRiskScore() {
            let score = 0;

            // Critical anomalies
            const criticalAnomalies = fusionState.anomalies.filter(a => a.severity === 'critical').length;
            score += criticalAnomalies * 10;

            // High anomalies
            const highAnomalies = fusionState.anomalies.filter(a => a.severity === 'high').length;
            score += highAnomalies * 5;

            // Medium anomalies
            const mediumAnomalies = fusionState.anomalies.filter(a => a.severity === 'medium').length;
            score += mediumAnomalies * 2;

            // High correlations
            const highCorrelations = Object.values(fusionState.correlations).filter(v => v > 0.7).length;
            score += highCorrelations * 3;

            // Normalize to 0-100
            score = Math.min(100, Math.round(score));

            return score;
        }

        // ═══════════════════════════════════════════════════════════════════════════════
        // FILTERS & SETTINGS
        // ═══════════════════════════════════════════════════════════════════════════════
        function updateFusionFilters() {
            const checkboxes = document.querySelectorAll('.fusion-filter-option input[type="checkbox"]');
            fusionState.filters.sources = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);

            termLog(`[FUSION] Filtreler güncellendi: ${fusionState.filters.sources.join(', ')}`, 'info');

            // Recalculate with filtered sources
            calculateAllCorrelations();
            detectAnomalies();
            performCrossSourceAnalysis();
        }

        function updateFusionTimeRange(range) {
            fusionState.filters.timeRange = range;
            termLog(`[FUSION] Zaman aralığı: ${range}`, 'info');

            // Reload data with new time range
            loadFusionData();
        }

        function toggleFusionAutoRefresh() {
            const toggle = document.getElementById('autoRefreshToggle');
            fusionState.settings.autoRefresh = toggle.checked;

            if (fusionState.settings.autoRefresh) {
                startFusionAutoRefresh();
                termLog('[FUSION] Otomatik yenileme aktif', 'ok');
            } else {
                stopFusionAutoRefresh();
                termLog('[FUSION] Otomatik yenileme devre dışı', 'info');
            }
        }

        function startFusionAutoRefresh() {
            stopFusionAutoRefresh();
            fusionState.refreshTimer = setInterval(() => {
                if (fusionState.active) {
                    loadFusionData();
                }
            }, fusionState.settings.refreshInterval);
        }

        function stopFusionAutoRefresh() {
            if (fusionState.refreshTimer) {
                clearInterval(fusionState.refreshTimer);
                fusionState.refreshTimer = null;
            }
        }

        function toggleFusionSettings() {
            alert('Ayarlar Paneli\n\nOtomatik Yenileme: ' + (fusionState.settings.autoRefresh ? 'Açık' : 'Kapalı') +
                  '\nYenileme Aralığı: ' + (fusionState.settings.refreshInterval / 1000) + ' saniye' +
                  '\nAnomali Eşiği: ' + fusionState.settings.anomalyThreshold + ' standart sapma' +
                  '\nMaksimum Anomali: ' + fusionState.settings.maxAnomalies);
        }

        // ═══════════════════════════════════════════════════════════════════════════════
        // ACTIONS
        // ═══════════════════════════════════════════════════════════════════════════════
        function refreshFusionData() {
            loadFusionData();
            termLog('[FUSION] Veriler manuel olarak yenilendi', 'info');
        }

        function exportFusionReport() {
            const report = {
                timestamp: new Date().toISOString(),
                statistics: fusionState.stats,
                correlations: fusionState.correlations,
                anomalies: fusionState.anomalies,
                crossSourceAnalysis: fusionState.crossSourceAnalysis,
                filters: fusionState.filters,
                settings: fusionState.settings
            };

            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tsunami-fusion-report-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            termLog('[FUSION] Rapor dışa aktarıldı', 'ok');
        }

        // ═══════════════════════════════════════════════════════════════════════════════
        // PANEL TOGGLE
        // ═══════════════════════════════════════════════════════════════════════════════
        function toggleFusionPanel() {
            const panel = document.getElementById('fusion-panel');
            const isActive = panel.classList.contains('active');

            if (isActive) {
                panel.classList.remove('active');
                stopFusionAutoRefresh();
                fusionState.active = false;
                termLog('[FUSION] Panel kapandı', 'info');
            } else {
                panel.classList.add('active');
                fusionState.active = true;

                // Load data if not loaded
                loadFusionData();

                // Start auto refresh if enabled
                if (fusionState.settings.autoRefresh) {
                    startFusionAutoRefresh();
                }

                termLog('[FUSION] Panel açıldı', 'info');
            }
        }

        // ═══════════════════════════════════════════════════════════════════════════════
        // INITIALIZATION
        // ═══════════════════════════════════════════════════════════════════════════════
        function initFusion() {
            createFusionUI();
            console.log('[FUSION] Palantir-style Data Fusion Dashboard başlatıldı');
        }

        // Initialize on page load
        initFusion();

        console.log('[FAZ 3.4] Data Fusion Dashboard Component eklendi - Multi-Source Analysis & Correlation hazır');

        // ═══════════════════════════════════════════════════════════════════════════════
        // BEYAZ ŞAPKA CSS STYLES
        // ═══════════════════════════════════════════════════════════════════════════════
        function injectBeyazSapkaStyles() {
            const beyazSapkaStyles = `
                <style>
                    .beyaz-sapka-panel {
                        position: fixed;
                        top: 60px;
                        right: -450px;
                        width: 430px;
                        height: calc(100vh - 80px);
                        max-height: 800px;
                        background: var(--bg-panel);
                        backdrop-filter: blur(20px);
                        border: 1px solid rgba(200, 200, 200, 0.3);
                        border-radius: 4px;
                        z-index: 9000;
                        transition: right 0.3s ease;
                        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
                        display: flex;
                        flex-direction: column;
                    }

                    .beyaz-sapka-panel.active {
                        right: 20px;
                    }

                    .beyaz-sapka-content {
                        display: flex;
                        flex-direction: column;
                        height: 100%;
                        overflow: hidden;
                    }

                    .beyaz-sapka-header {
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        padding: 20px;
                        border-bottom: 1px solid rgba(200, 200, 200, 0.2);
                        background: rgba(200, 200, 200, 0.05);
                    }

                    .beyaz-sapka-title {
                        display: flex;
                        align-items: center;
                        gap: 15px;
                    }

                    .beyaz-sapka-icon {
                        flex-shrink: 0;
                        width: 32px;
                        height: 32px;
                        padding: 6px;
                        background: rgba(200, 200, 200, 0.2);
                        border-radius: 4px;
                        color: #e0e0e0;
                    }

                    .beyaz-sapka-title h2 {
                        margin: 0;
                        font-size: 14px;
                        font-weight: 700;
                        color: var(--text-bright);
                        text-transform: uppercase;
                        letter-spacing: 1px;
                    }

                    .beyaz-sapka-subtitle {
                        margin: 4px 0 0 0;
                        font-size: 10px;
                        color: var(--text-dim);
                        text-transform: uppercase;
                        letter-spacing: 1px;
                    }

                    .beyaz-sapka-close {
                        width: 28px;
                        height: 28px;
                        border: 1px solid rgba(200, 200, 200, 0.3);
                        background: rgba(200, 200, 200, 0.1);
                        color: var(--text-normal);
                        border-radius: 4px;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 16px;
                        transition: all 0.2s;
                    }

                    .beyaz-sapka-close:hover {
                        background: rgba(255, 51, 85, 0.2);
                        border-color: rgba(255, 51, 85, 0.5);
                        color: #ff3355;
                    }

                    .beyaz-sapka-tabs {
                        display: flex;
                        gap: 2px;
                        padding: 10px;
                        border-bottom: 1px solid rgba(200, 200, 200, 0.2);
                        background: rgba(0, 0, 0, 0.2);
                    }

                    .beyaz-sapka-tab {
                        flex: 1;
                        padding: 10px 8px;
                        background: transparent;
                        border: none;
                        color: var(--text-dim);
                        font-size: 10px;
                        font-weight: 600;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        cursor: pointer;
                        border-radius: 4px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 6px;
                        transition: all 0.2s;
                    }

                    .beyaz-sapka-tab:hover {
                        background: rgba(200, 200, 200, 0.1);
                        color: var(--text-normal);
                    }

                    .beyaz-sapka-tab.active {
                        background: rgba(200, 200, 200, 0.2);
                        color: var(--text-bright);
                    }

                    .beyaz-sapka-body {
                        flex: 1;
                        overflow-y: auto;
                        padding: 15px;
                    }

                    .beyaz-sapka-body::-webkit-scrollbar {
                        width: 6px;
                    }

                    .beyaz-sapka-body::-webkit-scrollbar-track {
                        background: rgba(0, 0, 0, 0.2);
                    }

                    .beyaz-sapka-body::-webkit-scrollbar-thumb {
                        background: rgba(200, 200, 200, 0.3);
                        border-radius: 3px;
                    }

                    .beyaz-sapka-stats-grid {
                        display: grid;
                        grid-template-columns: repeat(2, 1fr);
                        gap: 10px;
                        margin-bottom: 20px;
                    }

                    .beyaz-sapka-stat-card {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        padding: 15px;
                        background: rgba(0, 0, 0, 0.3);
                        border: 1px solid rgba(200, 200, 200, 0.15);
                        border-radius: 4px;
                    }

                    .beyaz-sapka-stat-icon {
                        width: 40px;
                        height: 40px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        border-radius: 4px;
                        flex-shrink: 0;
                    }

                    .beyaz-sapka-stat-content {
                        flex: 1;
                    }

                    .beyaz-sapka-stat-value {
                        font-size: 20px;
                        font-weight: 700;
                        color: var(--text-bright);
                        line-height: 1.2;
                    }

                    .beyaz-sapka-stat-label {
                        font-size: 10px;
                        color: var(--text-dim);
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        margin-top: 2px;
                    }

                    .beyaz-sapka-section {
                        margin-bottom: 20px;
                    }

                    .beyaz-sapka-section-title {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        font-size: 12px;
                        font-weight: 600;
                        color: var(--text-bright);
                        text-transform: uppercase;
                        letter-spacing: 1px;
                        margin-bottom: 12px;
                        padding-bottom: 8px;
                        border-bottom: 1px solid rgba(200, 200, 200, 0.2);
                    }

                    .beyaz-sapka-compliance-list {
                        display: flex;
                        flex-direction: column;
                        gap: 8px;
                    }

                    .beyaz-sapka-compliance-item {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        padding: 12px;
                        background: rgba(0, 0, 0, 0.2);
                        border: 1px solid rgba(200, 200, 200, 0.1);
                        border-radius: 4px;
                    }

                    .beyaz-sapka-compliance-check {
                        width: 24px;
                        height: 24px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        background: rgba(0, 255, 157, 0.2);
                        color: #00ff9d;
                        border-radius: 4px;
                        font-size: 14px;
                        flex-shrink: 0;
                    }

                    .beyaz-sapka-compliance-text {
                        flex: 1;
                    }

                    .beyaz-sapka-compliance-text strong {
                        display: block;
                        font-size: 11px;
                        color: var(--text-bright);
                        margin-bottom: 2px;
                    }

                    .beyaz-sapka-compliance-text p {
                        margin: 0;
                        font-size: 10px;
                        color: var(--text-dim);
                    }

                    .beyaz-sapka-compliance-status {
                        font-size: 9px;
                        font-weight: 600;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        padding: 4px 8px;
                        border-radius: 3px;
                    }

                    .beyaz-sapka-status-success {
                        background: rgba(0, 255, 157, 0.2);
                        color: #00ff9d;
                    }

                    .beyaz-sapka-status-warning {
                        background: rgba(255, 170, 0, 0.2);
                        color: #ffaa00;
                    }

                    .beyaz-sapka-status-info {
                        background: rgba(0, 180, 255, 0.2);
                        color: #00b4ff;
                    }

                    .beyaz-sapka-filters {
                        display: flex;
                        gap: 8px;
                        margin-bottom: 15px;
                    }

                    .beyaz-sapka-filters select,
                    .beyaz-sapka-filters input {
                        flex: 1;
                        padding: 8px 12px;
                        background: rgba(0, 0, 0, 0.3);
                        border: 1px solid rgba(200, 200, 200, 0.2);
                        border-radius: 4px;
                        color: var(--text-normal);
                        font-size: 11px;
                        font-family: 'JetBrains Mono', monospace;
                    }

                    .beyaz-sapka-filter-btn {
                        padding: 8px 12px;
                        background: rgba(200, 200, 200, 0.1);
                        border: 1px solid rgba(200, 200, 200, 0.3);
                        border-radius: 4px;
                        color: var(--text-normal);
                        font-size: 11px;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        gap: 6px;
                        transition: all 0.2s;
                    }

                    .beyaz-sapka-filter-btn:hover {
                        background: rgba(200, 200, 200, 0.2);
                    }

                    .beyaz-sapka-audit-list {
                        display: flex;
                        flex-direction: column;
                        gap: 8px;
                    }

                    .beyaz-sapka-audit-item {
                        display: flex;
                        gap: 10px;
                        padding: 12px;
                        background: rgba(0, 0, 0, 0.2);
                        border: 1px solid rgba(200, 200, 200, 0.1);
                        border-left: 3px solid;
                        border-radius: 4px;
                    }

                    .beyaz-sapka-audit-critical {
                        border-left-color: #ff3355;
                    }

                    .beyaz-sapka-audit-warning {
                        border-left-color: #ffaa00;
                    }

                    .beyaz-sapka-audit-info {
                        border-left-color: #00b4ff;
                    }

                    .beyaz-sapka-audit-time {
                        font-size: 10px;
                        color: var(--text-dim);
                        font-family: 'JetBrains Mono', monospace;
                        flex-shrink: 0;
                    }

                    .beyaz-sapka-audit-content {
                        flex: 1;
                    }

                    .beyaz-sapka-audit-type {
                        font-size: 10px;
                        font-weight: 700;
                        color: var(--text-bright);
                        text-transform: uppercase;
                        margin-bottom: 4px;
                    }

                    .beyaz-sapka-audit-desc {
                        font-size: 11px;
                        color: var(--text-normal);
                        margin-bottom: 4px;
                    }

                    .beyaz-sapka-audit-meta {
                        font-size: 10px;
                        color: var(--text-dim);
                        font-family: 'JetBrains Mono', monospace;
                    }

                    .beyaz-sapka-approval-list {
                        display: flex;
                        flex-direction: column;
                        gap: 12px;
                    }

                    .beyaz-sapka-approval-item {
                        padding: 15px;
                        background: rgba(0, 0, 0, 0.2);
                        border: 1px solid rgba(200, 200, 200, 0.2);
                        border-radius: 4px;
                    }

                    .beyaz-sapka-approval-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 10px;
                    }

                    .beyaz-sapka-approval-type {
                        font-size: 11px;
                        font-weight: 600;
                        color: var(--text-bright);
                    }

                    .beyaz-sapka-approval-time {
                        font-size: 10px;
                        color: var(--text-dim);
                    }

                    .beyaz-sapka-approval-content {
                        margin-bottom: 12px;
                    }

                    .beyaz-sapka-approval-content p {
                        margin: 4px 0;
                        font-size: 11px;
                        color: var(--text-normal);
                    }

                    .beyaz-sapka-approval-content strong {
                        color: var(--text-bright);
                    }

                    .beyaz-sapka-approval-actions {
                        display: flex;
                        gap: 8px;
                    }

                    .beyaz-sapka-session-info {
                        padding: 15px;
                    }

                    .beyaz-sapka-session-card {
                        background: rgba(0, 0, 0, 0.2);
                        border: 1px solid rgba(200, 200, 200, 0.2);
                        border-radius: 4px;
                        padding: 20px;
                    }

                    .beyaz-sapka-session-card h4 {
                        margin: 0 0 15px 0;
                        font-size: 12px;
                        font-weight: 600;
                        color: var(--text-bright);
                        text-transform: uppercase;
                        letter-spacing: 1px;
                    }

                    .beyaz-sapka-session-details {
                        margin-bottom: 15px;
                    }

                    .beyaz-sapka-session-row {
                        display: flex;
                        justify-content: space-between;
                        padding: 8px 0;
                        border-bottom: 1px solid rgba(200, 200, 200, 0.1);
                    }

                    .beyaz-sapka-session-label {
                        font-size: 11px;
                        color: var(--text-dim);
                        text-transform: uppercase;
                    }

                    .beyaz-sapka-session-value {
                        font-size: 11px;
                        color: var(--text-bright);
                        font-family: 'JetBrains Mono', monospace;
                    }

                    .beyaz-sapka-session-actions {
                        display: flex;
                        gap: 8px;
                    }

                    .beyaz-sapka-footer {
                        display: flex;
                        gap: 8px;
                        padding: 15px;
                        border-top: 1px solid rgba(200, 200, 200, 0.2);
                        background: rgba(0, 0, 0, 0.2);
                    }

                    .beyaz-sapka-btn {
                        flex: 1;
                        padding: 10px 12px;
                        background: rgba(200, 200, 200, 0.1);
                        border: 1px solid rgba(200, 200, 200, 0.3);
                        border-radius: 4px;
                        color: var(--text-normal);
                        font-size: 10px;
                        font-weight: 600;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 6px;
                        transition: all 0.2s;
                    }

                    .beyaz-sapka-btn:hover {
                        background: rgba(200, 200, 200, 0.2);
                    }

                    .beyaz-sapka-btn-success {
                        background: rgba(0, 255, 157, 0.1);
                        border-color: rgba(0, 255, 157, 0.3);
                        color: #00ff9d;
                    }

                    .beyaz-sapka-btn-success:hover {
                        background: rgba(0, 255, 157, 0.2);
                    }

                    .beyaz-sapka-btn-warning {
                        background: rgba(255, 170, 0, 0.1);
                        border-color: rgba(255, 170, 0, 0.3);
                        color: #ffaa00;
                    }

                    .beyaz-sapka-btn-warning:hover {
                        background: rgba(255, 170, 0, 0.2);
                    }

                    .beyaz-sapka-btn-danger {
                        background: rgba(255, 51, 85, 0.1);
                        border-color: rgba(255, 51, 85, 0.3);
                        color: #ff3355;
                    }

                    .beyaz-sapka-btn-danger:hover {
                        background: rgba(255, 51, 85, 0.2);
                    }

                    .beyaz-sapka-btn-secondary {
                        background: transparent;
                        border-color: rgba(200, 200, 200, 0.2);
                    }

                    /* Theme-specific styles */
                    [data-theme="cockpit-bw"] .beyaz-sapka-panel {
                        background: rgba(0, 0, 0, 0.98) !important;
                        border-color: rgba(255, 255, 255, 0.3) !important;
                    }

                    [data-theme="cockpit-bw"] .beyaz-sapka-icon {
                        background: rgba(255, 255, 255, 0.1) !important;
                        color: #fff !important;
                    }

                    [data-theme="cockpit-bw"] .beyaz-sapka-btn {
                        border-color: rgba(255, 255, 255, 0.2) !important;
                    }
                </style>
            `;

            document.head.insertAdjacentHTML('beforeend', beyazSapkaStyles);
        }

        // Inject styles
        injectBeyazSapkaStyles();

        // ═══════════════════════════════════════════════════════════════════════════════
        // BEYAZ ŞAPKA KURALLARI PANEL - FAZ 4
        // Legal & Ethical Compliance Dashboard
        // ═══════════════════════════════════════════════════════════════════════════════

        const beyazSapkaState = {
            active: false,
            currentTab: 'genel',
            stats: {
                totalAudits: 0,
                criticalEvents: 0,
                pendingApprovals: 0,
                complianceScore: 0
            },
            auditLogs: [],
            pendingRequests: []
        };

        function createBeyazSapkaUI() {
            const panel = document.createElement('div');
            panel.id = 'beyaz-sapka-panel';
            panel.className = 'beyaz-sapka-panel';
            panel.innerHTML = `
                <div class="beyaz-sapka-content">
                    <!-- Header -->
                    <div class="beyaz-sapka-header">
                        <div class="beyaz-sapka-title">
                            <svg class="beyaz-sapka-icon" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/>
                            </svg>
                            <div>
                                <h2>BEYAZ ŞAPKA KURALLARI</h2>
                                <p class="beyaz-sapka-subtitle">KVKK & Siber Güvenlik Yasası Uyumluluk</p>
                            </div>
                        </div>
                        <button class="beyaz-sapka-close" onclick="toggleBeyazSapkaPanel()" title="Kapat">✕</button>
                    </div>

                    <!-- Tabs -->
                    <div class="beyaz-sapka-tabs">
                        <button class="beyaz-sapka-tab ${beyazSapkaState.currentTab === 'genel' ? 'active' : ''}" onclick="switchBeyazSapkaTab('genel')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>
                            Genel
                        </button>
                        <button class="beyaz-sapka-tab ${beyazSapkaState.currentTab === 'denetim' ? 'active' : ''}" onclick="switchBeyazSapkaTab('denetim')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
                            Denetim
                        </button>
                        <button class="beyaz-sapka-tab ${beyazSapkaState.currentTab === 'onaylar' ? 'active' : ''}" onclick="switchBeyazSapkaTab('onaylar')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19 8h-4V4h-2v4H9V4H7v4H3v2h4v4h2v-4h4v4h2v-4h4V8z"/></svg>
                            Onaylar
                        </button>
                        <button class="beyaz-sapka-tab ${beyazSapkaState.currentTab === 'oturum' ? 'active' : ''}" onclick="switchBeyazSapkaTab('oturum')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                            Oturum
                        </button>
                    </div>

                    <!-- Tab Content -->
                    <div class="beyaz-sapka-body" id="beyazSapkaBody">
                        <!-- Content will be loaded dynamically -->
                    </div>

                    <!-- Footer -->
                    <div class="beyaz-sapka-footer">
                        <button class="beyaz-sapka-btn beyaz-sapka-btn-secondary" onclick="showBeyazSapkaRules()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
                            Kuralları Görüntüle
                        </button>
                        <button class="beyaz-sapka-btn beyaz-sapka-btn-warning" onclick="reportBeyazSapkaViolation()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>
                            İhlal Bildir
                        </button>
                        <button class="beyaz-sapka-btn" onclick="exportBeyazSapkaReport()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M19 8h-4V4h-2v4H9V4H7v4H3v2h4v4h2v-4h4v4h2v-4h4V8z"/></svg>
                            Rapor Dışa Aktar
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(panel);

            // Load initial content
            loadBeyazSapkaContent();

            console.log('[BEYAZ_SAPKA] Panel oluşturuldu');
        }

        function loadBeyazSapkaContent() {
            const body = document.getElementById('beyazSapkaBody');
            if (!body) return;

            let content = '';

            switch(beyazSapkaState.currentTab) {
                case 'genel':
                    content = getBeyazSapkaGenelContent();
                    break;
                case 'denetim':
                    content = getBeyazSapkaDenetimContent();
                    break;
                case 'onaylar':
                    content = getBeyazSapkaOnaylarContent();
                    break;
                case 'oturum':
                    content = getBeyazSapkaOturumContent();
                    break;
            }

            body.innerHTML = content;
        }

        function getBeyazSapkaGenelContent() {
            return `
                <div class="beyaz-sapka-stats-grid">
                    <div class="beyaz-sapka-stat-card">
                        <div class="beyaz-sapka-stat-icon" style="background: rgba(243, 156, 18, 0.2);">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="#f39c12"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
                        </div>
                        <div class="beyaz-sapka-stat-content">
                            <div class="beyaz-sapka-stat-value">${beyazSapkaState.stats.totalAudits}</div>
                            <div class="beyaz-sapka-stat-label">Toplam Denetim</div>
                        </div>
                    </div>

                    <div class="beyaz-sapka-stat-card">
                        <div class="beyaz-sapka-stat-icon" style="background: rgba(255, 51, 85, 0.2);">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="#ff3355"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>
                        </div>
                        <div class="beyaz-sapka-stat-content">
                            <div class="beyaz-sapka-stat-value">${beyazSapkaState.stats.criticalEvents}</div>
                            <div class="beyaz-sapka-stat-label">Kritik Olay</div>
                        </div>
                    </div>

                    <div class="beyaz-sapka-stat-card">
                        <div class="beyaz-sapka-stat-icon" style="background: rgba(0, 180, 255, 0.2);">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="#00b4ff"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                        </div>
                        <div class="beyaz-sapka-stat-content">
                            <div class="beyaz-sapka-stat-value">${beyazSapkaState.stats.pendingApprovals}</div>
                            <div class="beyaz-sapka-stat-label">Bekleyen Onay</div>
                        </div>
                    </div>

                    <div class="beyaz-sapka-stat-card">
                        <div class="beyaz-sapka-stat-icon" style="background: rgba(0, 255, 157, 0.2);">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="#00ff9d"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/></svg>
                        </div>
                        <div class="beyaz-sapka-stat-content">
                            <div class="beyaz-sapka-stat-value">${beyazSapkaState.stats.complianceScore}%</div>
                            <div class="beyaz-sapka-stat-label">Uyumluluk Skoru</div>
                        </div>
                    </div>
                </div>

                <div class="beyaz-sapka-section">
                    <h3 class="beyaz-sapka-section-title">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                        Yasal Uyumluluk Durumu
                    </h3>
                    <div class="beyaz-sapka-compliance-list">
                        <div class="beyaz-sapka-compliance-item">
                            <span class="beyaz-sapka-compliance-check">✓</span>
                            <div class="beyaz-sapka-compliance-text">
                                <strong>KVKK Aydınlatma Metni</strong>
                                <p>Kullanıcılar bilgilendirildi</p>
                            </div>
                            <span class="beyaz-sapka-compliance-status beyaz-sapka-status-success">Tamamlandı</span>
                        </div>
                        <div class="beyaz-sapka-compliance-item">
                            <span class="beyaz-sapka-compliance-check">✓</span>
                            <div class="beyaz-sapka-compliance-text">
                                <strong>Veri Güvenliği Önlemleri</strong>
                                <p>Şifreleme ve erişim kontrolü aktif</p>
                            </div>
                            <span class="beyaz-sapka-compliance-status beyaz-sapka-status-success">Tamamlandı</span>
                        </div>
                        <div class="beyaz-sapka-compliance-item">
                            <span class="beyaz-sapka-compliance-check">⚠</span>
                            <div class="beyaz-sapka-compliance-text">
                                <strong>Denetim Logları</strong>
                                <p>3 günlük log incelemesi bekliyor</p>
                            </div>
                            <span class="beyaz-sapka-compliance-status beyaz-sapka-status-warning">Bekliyor</span>
                        </div>
                        <div class="beyaz-sapka-compliance-item">
                            <span class="beyaz-sapka-compliance-check">ⓘ</span>
                            <div class="beyaz-sapka-compliance-text">
                                <strong>Personel Eğitimi</strong>
                                <p>Sıradaki eğitim: 15 Mart 2026</p>
                            </div>
                            <span class="beyaz-sapka-compliance-status beyaz-sapka-status-info">Planlandı</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function getBeyazSapkaDenetimContent() {
            return `
                <div class="beyaz-sapka-filters">
                    <select id="beyazSapkaAuditFilter" onchange="filterBeyazSapkaAudit()">
                        <option value="all">Tüm Olaylar</option>
                        <option value="critical">Kritik</option>
                        <option value="warning">Uyarı</option>
                        <option value="info">Bilgi</option>
                    </select>
                    <input type="date" id="beyazSapkaAuditDate" onchange="filterBeyazSapkaAudit()">
                    <button class="beyaz-sapka-filter-btn" onclick="refreshBeyazSapkaAudit()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                        Yenile
                    </button>
                </div>

                <div class="beyaz-sapka-audit-list" id="beyazSapkaAuditList">
                    <div class="beyaz-sapka-audit-item beyaz-sapka-audit-critical">
                        <div class="beyaz-sapka-audit-time">14:32:15</div>
                        <div class="beyaz-sapka-audit-content">
                            <div class="beyaz-sapka-audit-type">KRİTİK</div>
                            <div class="beyaz-sapka-audit-desc">Yetkisiz erişim denemesi tespit edildi</div>
                            <div class="beyaz-sapka-audit-meta">IP: 192.168.1.100 | Kullanıcı: admin</div>
                        </div>
                    </div>
                    <div class="beyaz-sapka-audit-item beyaz-sapka-audit-warning">
                        <div class="beyaz-sapka-audit-time">14:28:42</div>
                        <div class="beyaz-sapka-audit-content">
                            <div class="beyaz-sapka-audit-type">UYARI</div>
                            <div class="beyaz-sapka-audit-desc">Bekleyen veri ihracı onayı</div>
                            <div class="beyaz-sapka-audit-meta">Kullanıcı: analyst | Kayıt: 150</div>
                        </div>
                    </div>
                    <div class="beyaz-sapka-audit-item beyaz-sapka-audit-info">
                        <div class="beyaz-sapka-audit-time">14:15:30</div>
                        <div class="beyaz-sapka-audit-content">
                            <div class="beyaz-sapka-audit-type">BİLGİ</div>
                            <div class="beyaz-sapka-audit-desc">Kullanıcı girişi başarılı</div>
                            <div class="beyaz-sapka-audit-meta">Kullanıcı: operator | IP: 10.0.0.50</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getBeyazSapkaOnaylarContent() {
            return `
                <div class="beyaz-sapka-approval-list">
                    <div class="beyaz-sapka-approval-item">
                        <div class="beyaz-sapka-approval-header">
                            <span class="beyaz-sapka-approval-type">Veri İhracı</span>
                            <span class="beyaz-sapka-approval-time">10 dakika önce</span>
                        </div>
                        <div class="beyaz-sapka-approval-content">
                            <p><strong>Kullanıcı:</strong> analyst</p>
                            <p><strong>Veri Türü:</strong> Audit Logs</p>
                            <p><strong>Kayıt Sayısı:</strong> 1,250</p>
                            <p><strong>Format:</strong> JSON</p>
                            <p><strong>Amaç:</strong> Aylık rapor hazırlama</p>
                        </div>
                        <div class="beyaz-sapka-approval-actions">
                            <button class="beyaz-sapka-btn beyaz-sapka-btn-success" onclick="approveBeyazSapkaRequest('EXP-001')">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/></svg>
                                Onayla
                            </button>
                            <button class="beyaz-sapka-btn beyaz-sapka-btn-danger" onclick="rejectBeyazSapkaRequest('EXP-001')">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                                Reddet
                            </button>
                        </div>
                    </div>

                    <div class="beyaz-sapka-approval-item">
                        <div class="beyaz-sapka-approval-header">
                            <span class="beyaz-sapka-approval-type">Sistem Değişikliği</span>
                            <span class="beyaz-sapka-approval-time">1 saat önce</span>
                        </div>
                        <div class="beyaz-sapka-approval-content">
                            <p><strong>Kullanıcı:</strong> admin</p>
                            <p><strong>Değişiklik:</strong> Log saklama süresi 90 gün → 365 gün</p>
                            <p><strong>Neden:</strong> KVKK uyumluluğu</p>
                        </div>
                        <div class="beyaz-sapka-approval-actions">
                            <button class="beyaz-sapka-btn beyaz-sapka-btn-success" onclick="approveBeyazSapkaRequest('SYS-002')">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/></svg>
                                Onayla
                            </button>
                            <button class="beyaz-sapka-btn beyaz-sapka-btn-danger" onclick="rejectBeyazSapkaRequest('SYS-002')">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                                Reddet
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function getBeyazSapkaOturumContent() {
            return `
                <div class="beyaz-sapka-session-info">
                    <div class="beyaz-sapka-session-card">
                        <h4>Şu Anki Oturum</h4>
                        <div class="beyaz-sapka-session-details">
                            <div class="beyaz-sapka-session-row">
                                <span class="beyaz-sapka-session-label">Kullanıcı:</span>
                                <span class="beyaz-sapka-session-value">admin</span>
                            </div>
                            <div class="beyaz-sapka-session-row">
                                <span class="beyaz-sapka-session-label">Rol:</span>
                                <span class="beyaz-sapka-session-value">Admin</span>
                            </div>
                            <div class="beyaz-sapka-session-row">
                                <span class="beyaz-sapka-session-label">Oturum ID:</span>
                                <span class="beyaz-sapka-session-value">sess_20260220_143022</span>
                            </div>
                            <div class="beyaz-sapka-session-row">
                                <span class="beyaz-sapka-session-label">IP Adresi:</span>
                                <span class="beyaz-sapka-session-value">10.0.0.50</span>
                            </div>
                            <div class="beyaz-sapka-session-row">
                                <span class="beyaz-sapka-session-label">Başlangıç:</span>
                                <span class="beyaz-sapka-session-value">14:30:22</span>
                            </div>
                            <div class="beyaz-sapka-session-row">
                                <span class="beyaz-sapka-session-label">Son Aktivite:</span>
                                <span class="beyaz-sapka-session-value">14:45:18</span>
                            </div>
                        </div>
                        <div class="beyaz-sapka-session-actions">
                            <button class="beyaz-sapka-btn beyaz-sapka-btn-warning" onclick="extendBeyazSapkaSession()">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                                Uzat
                            </button>
                            <button class="beyaz-sapka-btn beyaz-sapka-btn-danger" onclick="terminateBeyazSapkaSession()">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                                Sonlandır
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function switchBeyazSapkaTab(tab) {
            beyazSapkaState.currentTab = tab;
            loadBeyazSapkaContent();
            termLog('[BEYAZ_SAPKA] Tab değiştirildi: ' + tab, 'info');
        }

        function toggleBeyazSapkaPanel() {
            const panel = document.getElementById('beyaz-sapka-panel');
            const isActive = panel.classList.contains('active');

            if (isActive) {
                panel.classList.remove('active');
                beyazSapkaState.active = false;
                termLog('[BEYAZ_SAPKA] Panel kapandı', 'info');
            } else {
                panel.classList.add('active');
                beyazSapkaState.active = true;
                termLog('[BEYAZ_SAPKA] Panel açıldı', 'info');
            }
        }

        function showBeyazSapkaRules() {
            window.open('/docs/BEYAZ_SAPKA_KURALLARI.md', '_blank');
            termLog('[BEYAZ_SAPKA] Kurallar görüntülendi', 'info');
        }

        function reportBeyazSapkaViolation() {
            const reason = prompt('İhlal türünü giriniz:');
            if (reason) {
                alert('İhlal bildirimi alındı. Teşekkürler!');
                termLog('[BEYAZ_SAPKA] İhlal bildirimi: ' + reason, 'warning');
            }
        }

        function exportBeyazSapkaReport() {
            alert('Rapor hazırlanıyor... İndirme başlayacak.');
            termLog('[BEYAZ_SAPKA] Rapor dışa aktarılıyor', 'info');
        }

        function approveBeyazSapkaRequest(id) {
            alert('Talep ' + id + ' onaylandı.');
            termLog('[BEYAZ_SAPKA] Talep onaylandı: ' + id, 'ok');
            loadBeyazSapkaContent();
        }

        function rejectBeyazSapkaRequest(id) {
            const reason = prompt('Red nedeni:');
            if (reason) {
                alert('Talep ' + id + ' reddedildi.');
                termLog('[BEYAZ_SAPKA] Talep reddedildi: ' + id + ' - ' + reason, 'warning');
                loadBeyazSapkaContent();
            }
        }

        function extendBeyazSapkaSession() {
            alert('Oturum 2 saat uzatıldı.');
            termLog('[BEYAZ_SAPKA] Oturum uzatıldı', 'ok');
        }

        function terminateBeyazSapkaSession() {
            if (confirm('Oturumu sonlandırmak istediğinizden emin misiniz?')) {
                window.location.href = '/logout';
            }
        }

        function filterBeyazSapkaAudit() {
            termLog('[BEYAZ_SAPKA] Denetim filtresi uygulandı', 'info');
        }

        function refreshBeyazSapkaAudit() {
            termLog('[BEYAZ_SAPKA] Denetim logları yenilendi', 'ok');
            loadBeyazSapkaContent();
        }

        function initBeyazSapka() {
            createBeyazSapkaUI();
            console.log('[BEYAZ_SAPKA] Beyaz Şapka Kuralları Panel başlatıldı');
        }

        // Initialize on page load
        initBeyazSapka();

        console.log('[FAZ 4] Beyaz Şapka Kuralları Component eklendi - Legal & Ethical Compliance hazır');
    </script>

    <!-- ═══════════════════════════════════════════════════════════════════════
         FAZ 5: GERÇEK ZAMANLI VIDEO STREAM (REAL-TIME VIDEO STREAMING)
         Palantir-Style Video Surveillance Integration
         ═══════════════════════════════════════════════════════════════════════ -->

    <style>
        /* Video Stream Panel Styles */
        #video-stream-panel {
            position: fixed;
            top: 80px;
            right: -850px;
            width: 820px;
            height: calc(100vh - 100px);
            background: var(--bg-panel);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-glow);
            border-radius: 12px;
            z-index: 9998;
            transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            box-shadow: -10px 0 40px rgba(0, 180, 255, 0.15);
        }

        #video-stream-panel.active {
            right: 20px;
        }

        .video-stream-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, rgba(255, 51, 85, 0.15), rgba(255, 0, 128, 0.1));
        }

        .video-stream-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .video-stream-title h2 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            background: linear-gradient(135deg, #ff3355, #ff0080);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .video-stream-controls {
            display: flex;
            gap: 10px;
        }

        .video-stream-btn {
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            color: var(--text-normal);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .video-stream-btn:hover {
            background: var(--border-glow);
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }

        .video-stream-close {
            background: rgba(255, 51, 85, 0.2);
            border: 1px solid rgba(255, 51, 85, 0.4);
            color: #ff3355;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .video-stream-close:hover {
            background: rgba(255, 51, 85, 0.4);
            transform: rotate(90deg);
        }

        .video-stream-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        /* Video Statistics Cards */
        .video-stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .video-stat-card {
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            transition: all 0.3s;
        }

        .video-stat-card:hover {
            border-color: var(--border-glow);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 180, 255, 0.2);
        }

        .video-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 4px;
        }

        .video-stat-label {
            font-size: 11px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Video Filters */
        .video-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .video-filter-select {
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            color: var(--text-normal);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .video-filter-select:hover {
            border-color: var(--border-glow);
        }

        .video-filter-select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px rgba(0, 180, 255, 0.2);
        }

        /* Video Streams List */
        .video-streams-list {
            display: grid;
            gap: 12px;
        }

        .video-stream-item {
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .video-stream-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--border-subtle);
            transition: all 0.3s;
        }

        .video-stream-item.online::before {
            background: #00ff88;
        }

        .video-stream-item.offline::before {
            background: #ff3355;
        }

        .video-stream-item.connecting::before {
            background: #ffaa00;
        }

        .video-stream-item.recording::before {
            background: #00b4ff;
            animation: recordingPulse 1.5s infinite;
        }

        @keyframes recordingPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .video-stream-item:hover {
            border-color: var(--border-glow);
            transform: translateX(4px);
            box-shadow: -4px 0 12px rgba(0, 180, 255, 0.2);
        }

        .video-stream-header-info {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .video-stream-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-bright);
            margin-bottom: 4px;
        }

        .video-stream-location {
            font-size: 11px;
            color: var(--text-dim);
        }

        .video-stream-status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .video-stream-status-badge.online {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }

        .video-stream-status-badge.offline {
            background: rgba(255, 51, 85, 0.2);
            color: #ff3355;
        }

        .video-stream-status-badge.connecting {
            background: rgba(255, 170, 0, 0.2);
            color: #ffaa00;
        }

        .video-stream-status-badge.recording {
            background: rgba(0, 180, 255, 0.2);
            color: #00b4ff;
        }

        .video-stream-details {
            display: flex;
            gap: 16px;
            font-size: 11px;
            color: var(--text-dim);
        }

        .video-stream-detail {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .video-stream-detail svg {
            width: 12px;
            height: 12px;
        }

        /* Video Player Modal */
        .video-player-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .video-player-modal.active {
            display: flex;
        }

        .video-player-container {
            width: 90%;
            max-width: 1400px;
            background: var(--bg-deep);
            border: 1px solid var(--border-glow);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 180, 255, 0.3);
        }

        .video-player-header {
            padding: 16px 20px;
            background: linear-gradient(135deg, rgba(255, 51, 85, 0.15), rgba(255, 0, 128, 0.1));
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .video-player-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .video-player-title h3 {
            margin: 0;
            font-size: 16px;
            color: var(--text-bright);
        }

        .video-player-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .video-player-btn {
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            color: var(--text-normal);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
        }

        .video-player-btn:hover {
            background: var(--border-glow);
            border-color: var(--accent-primary);
        }

        .video-player-btn.active {
            background: rgba(0, 180, 255, 0.2);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .video-player-close {
            background: rgba(255, 51, 85, 0.2);
            border: 1px solid rgba(255, 51, 85, 0.4);
            color: #ff3355;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .video-player-close:hover {
            background: rgba(255, 51, 85, 0.4);
            transform: rotate(90deg);
        }

        .video-player-content {
            position: relative;
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
        }

        .video-player-element {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .video-player-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #0a0a14, #141428);
        }

        .video-player-placeholder svg {
            width: 80px;
            height: 80px;
            opacity: 0.5;
            margin-bottom: 16px;
        }

        .video-player-overlay {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .video-player-overlay-item {
            background: rgba(0, 0, 0, 0.7);
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 11px;
            color: var(--text-bright);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .video-player-overlay-item .indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #00ff88;
            animation: pulse 1.5s infinite;
        }

        .video-player-overlay-item .indicator.recording {
            background: #ff3355;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .video-player-footer {
            padding: 12px 20px;
            background: var(--bg-deep);
            border-top: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .video-player-info {
            display: flex;
            gap: 20px;
            font-size: 11px;
            color: var(--text-dim);
        }

        .video-player-timeline {
            flex: 1;
            max-width: 400px;
            margin: 0 20px;
        }

        .video-player-timeline-bar {
            width: 100%;
            height: 4px;
            background: var(--bg-glass);
            border-radius: 2px;
            overflow: hidden;
            cursor: pointer;
        }

        .video-player-timeline-progress {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            width: 0%;
            transition: width 0.1s;
        }

        /* Multi-View Grid */
        .video-multiview {
            display: none;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 4px;
            width: 90%;
            max-width: 1600px;
            aspect-ratio: 16/9;
        }

        .video-multiview.active {
            display: grid;
        }

        .video-multiview-item {
            background: #000;
            border: 1px solid var(--border-subtle);
            position: relative;
            overflow: hidden;
        }

        .video-multiview-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-multiview-label {
            position: absolute;
            bottom: 8px;
            left: 8px;
            background: rgba(0, 0, 0, 0.7);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            color: var(--text-bright);
        }

        /* Scrollbar Styling */
        #video-stream-panel::-webkit-scrollbar,
        .video-stream-content::-webkit-scrollbar {
            width: 6px;
        }

        #video-stream-panel::-webkit-scrollbar-track,
        .video-stream-content::-webkit-scrollbar-track {
            background: var(--bg-deep);
        }

        #video-stream-panel::-webkit-scrollbar-thumb,
        .video-stream-content::-webkit-scrollbar-thumb {
            background: var(--border-subtle);
            border-radius: 3px;
        }

        #video-stream-panel::-webkit-scrollbar-thumb:hover,
        .video-stream-content::-webkit-scrollbar-thumb:hover {
            background: var(--border-glow);
        }

        /* Recording Indicator */
        .recording-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: rgba(255, 51, 85, 0.2);
            border: 1px solid rgba(255, 51, 85, 0.4);
            border-radius: 12px;
            font-size: 11px;
            color: #ff3355;
        }

        .recording-indicator .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ff3355;
            animation: recordingPulse 1s infinite;
        }
    </style>

    <!-- Video Stream Panel HTML -->
    <div id="video-stream-panel">
        <div class="video-stream-header">
            <div class="video-stream-title">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="url(#videoGradient)" stroke-width="2">
                    <defs>
                        <linearGradient id="videoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#ff3355"/>
                            <stop offset="100%" style="stop-color:#ff0080"/>
                        </linearGradient>
                    </defs>
                    <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/>
                </svg>
                <h2>Video Akış Paneli</h2>
            </div>
            <div class="video-stream-controls">
                <button class="video-stream-btn" onclick="refreshVideoStreams()" title="Yenile">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 4v6h-6M1 20v-6h6"/>
                        <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                    </svg>
                    Yenile
                </button>
                <button class="video-stream-btn" onclick="toggleMultiView()" title="Çoklu Görünüm">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="8" height="8"/><rect x="13" y="3" width="8" height="8"/>
                        <rect x="3" y="13" width="8" height="8"/><rect x="13" y="13" width="8" height="8"/>
                    </svg>
                    2x2
                </button>
                <button class="video-stream-btn" onclick="exportVideoReport()" title="Rapor Dışa Aktar">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Dışa Aktar
                </button>
                <div class="video-stream-close" onclick="toggleVideoStreamPanel()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </div>
            </div>
        </div>

        <div class="video-stream-content">
            <!-- Statistics Cards -->
            <div class="video-stats-grid" id="videoStatsGrid">
                <div class="video-stat-card">
                    <div class="video-stat-value" id="videoTotalSources">0</div>
                    <div class="video-stat-label">Toplam Kaynak</div>
                </div>
                <div class="video-stat-card">
                    <div class="video-stat-value" id="videoOnlineSources" style="color: #00ff88">0</div>
                    <div class="video-stat-label">Çevrimiçi</div>
                </div>
                <div class="video-stat-card">
                    <div class="video-stat-value" id="videoRecordingSources" style="color: #00b4ff">0</div>
                    <div class="video-stat-label">Kayıt Yapıyor</div>
                </div>
                <div class="video-stat-card">
                    <div class="video-stat-value" id="videoAvgBitrate" style="color: #ffaa00">0</div>
                    <div class="video-stat-label">Ort. Bitrate (Kbps)</div>
                </div>
            </div>

            <!-- Filters -->
            <div class="video-filters">
                <select class="video-filter-select" id="videoStatusFilter" onchange="filterVideoStreams()">
                    <option value="">Tüm Durumlar</option>
                    <option value="online">Çevrimiçi</option>
                    <option value="offline">Çevrimdışı</option>
                    <option value="connecting">Bağlanıyor</option>
                    <option value="recording">Kayıt Yapıyor</option>
                </select>
                <select class="video-filter-select" id="videoProtocolFilter" onchange="filterVideoStreams()">
                    <option value="">Tüm Protokoller</option>
                    <option value="rtsp">RTSP</option>
                    <option value="hls">HLS</option>
                    <option value="webrtc">WebRTC</option>
                    <option value="http">HTTP</option>
                </select>
                <select class="video-filter-select" id="videoQualityFilter" onchange="filterVideoStreams()">
                    <option value="">Tüm Kaliteler</option>
                    <option value="4k">4K</option>
                    <option value="1080p">Full HD (1080p)</option>
                    <option value="720p">HD (720p)</option>
                    <option value="480p">SD (480p)</option>
                    <option value="360p">Low (360p)</option>
                </select>
                <select class="video-filter-select" id="videoLocationFilter" onchange="filterVideoStreams()">
                    <option value="">Tüm Konumlar</option>
                    <option value="İstanbul">İstanbul</option>
                    <option value="Ankara">Ankara</option>
                    <option value="İzmir">İzmir</option>
                    <option value="Bursa">Bursa</option>
                    <option value="Antalya">Antalya</option>
                    <option value="Adana">Adana</option>
                    <option value="Gaziantep">Gaziantep</option>
                    <option value="Konya">Konya</option>
                    <option value="Trabzon">Trabzon</option>
                </select>
            </div>

            <!-- Video Streams List -->
            <div class="video-streams-list" id="videoStreamsList">
                <!-- Streams will be loaded here dynamically -->
            </div>
        </div>
    </div>

    <!-- Video Player Modal -->
    <div class="video-player-modal" id="videoPlayerModal">
        <div class="video-player-container" id="videoPlayerContainer">
            <div class="video-player-header">
                <div class="video-player-title">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="#ff3355">
                        <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/>
                    </svg>
                    <h3 id="videoPlayerTitle">Video Akışı</h3>
                    <div class="recording-indicator" id="recordingIndicator" style="display: none;">
                        <div class="dot"></div>
                        <span>KAYIT</span>
                    </div>
                </div>
                <div class="video-player-controls">
                    <button class="video-player-btn" onclick="togglePiP()" title="Picture-in-Picture">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="8" y="8" width="14" height="10" rx="2"/><path d="M4 4h14v14"/>
                        </svg>
                        PiP
                    </button>
                    <button class="video-player-btn" onclick="toggleFullscreen()" title="Tam Ekran">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M8 3H5a2 2 0 00-2 2v3m18 0V5a2 2 0 00-2-2h-3m0 18h3a2 2 0 002-2v-3M3 16v3a2 2 0 002 2h3"/>
                        </svg>
                    </button>
                    <button class="video-player-btn" id="muteBtn" onclick="toggleMute()" title="Sessiz">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                            <path d="M19.07 4.93a10 10 0 010 14.14M15.54 8.46a5 5 0 010 7.07"/>
                        </svg>
                    </button>
                    <button class="video-player-btn" onclick="cycleQuality()" title="Kalite Değiştir">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6"/><path d="M1 12h6m6 0h6"/>
                        </svg>
                        <span id="currentQuality">1080p</span>
                    </button>
                    <button class="video-player-close" onclick="closeVideoPlayer()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="video-player-content" id="videoPlayerContent">
                <video class="video-player-element" id="videoElement" autoplay playsinline></video>
                <div class="video-player-placeholder" id="videoPlaceholder" style="display: none;">
                    <svg viewBox="0 0 24 24" fill="#ff3355">
                        <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/>
                    </svg>
                    <div style="color: var(--text-dim); font-size: 14px;">Video yükleniyor...</div>
                </div>
                <div class="video-player-overlay" id="videoPlayerOverlay">
                    <div class="video-player-overlay-item">
                        <div class="indicator" id="liveIndicator"></div>
                        <span>CANLI</span>
                    </div>
                    <div class="video-player-overlay-item" id="protocolBadge">
                        <span>RTSP</span>
                    </div>
                    <div class="video-player-overlay-item" id="fpsBadge">
                        <span>30 FPS</span>
                    </div>
                </div>
            </div>

            <div class="video-player-footer">
                <div class="video-player-info">
                    <span id="videoSourceName">Kaynak Adı</span>
                    <span id="videoSourceLocation">Konum</span>
                </div>
                <div class="video-player-timeline">
                    <div class="video-player-timeline-bar" onclick="seekVideo(event)">
                        <div class="video-player-timeline-progress" id="timelineProgress"></div>
                    </div>
                </div>
                <div class="video-player-controls">
                    <button class="video-player-btn" onclick="controlStream('play')" title="Oynat">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                            <polygon points="5 3 19 12 5 21 5 3"/>
                        </svg>
                    </button>
                    <button class="video-player-btn" onclick="controlStream('pause')" title="Duraklat">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                            <rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>
                        </svg>
                    </button>
                    <button class="video-player-btn" onclick="controlStream('stop')" title="Durdur">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                            <rect x="6" y="6" width="12" height="12"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Multi-View Grid -->
        <div class="video-multiview" id="videoMultiview">
            <div class="video-multiview-item">
                <video id="multiview1" autoplay muted></video>
                <div class="video-multiview-label">Kamera 1</div>
            </div>
            <div class="video-multiview-item">
                <video id="multiview2" autoplay muted></video>
                <div class="video-multiview-label">Kamera 2</div>
            </div>
            <div class="video-multiview-item">
                <video id="multiview3" autoplay muted></video>
                <div class="video-multiview-label">Kamera 3</div>
            </div>
            <div class="video-multiview-item">
                <video id="multiview4" autoplay muted></video>
                <div class="video-multiview-label">Kamera 4</div>
            </div>
        </div>
    </div>

    <script>
        // ═══════════════════════════════════════════════════════════════
        // FAZ 5: VIDEO STREAM MANAGER - JAVASCRIPT
        // Palantir-Style Real-Time Video Streaming
        // ═══════════════════════════════════════════════════════════════

        const VideoStreamManager = {
            state: {
                active: false,
                streams: [],
                currentStream: null,
                multiViewActive: false,
                multiViewStreams: [],
                filters: {
                    status: '',
                    protocol: '',
                    quality: '',
                    location: ''
                },
                qualities: ['360p', '480p', '720p', '1080p', '4k'],
                currentQualityIndex: 3
            },

            async loadVideoStreams() {
                try {
                    const response = await fetch('/api/harita/video-streams?zoom=8');
                    const data = await response.json();

                    if (data.basarili) {
                        this.state.streams = data.streams;
                        this.renderStreams();
                        this.updateStatistics();
                        termLog(`[VIDEO STREAM] ${data.toplam} video stream yüklendi`, 'ok');
                    }
                } catch (error) {
                    console.error('[VIDEO STREAM] Yükleme hatası:', error);
                    termLog('[VIDEO STREAM] Stream yükleme hatası: ' + error.message, 'error');
                }
            },

            renderStreams() {
                const container = document.getElementById('videoStreamsList');
                if (!container) return;

                let filteredStreams = [...this.state.streams];

                // Apply filters
                if (this.state.filters.status) {
                    filteredStreams = filteredStreams.filter(s => s.status === this.state.filters.status);
                }
                if (this.state.filters.protocol) {
                    filteredStreams = filteredStreams.filter(s => s.protocol_type === this.state.filters.protocol);
                }
                if (this.state.filters.quality) {
                    filteredStreams = filteredStreams.filter(s => s.quality === this.state.filters.quality);
                }
                if (this.state.filters.location) {
                    filteredStreams = filteredStreams.filter(s => s.location.includes(this.state.filters.location));
                }

                if (filteredStreams.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--text-dim);">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="opacity: 0.5;">
                                <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/>
                            </svg>
                            <div style="margin-top: 16px;">Video stream bulunamadı</div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = filteredStreams.map(stream => `
                    <div class="video-stream-item ${stream.status}" onclick="VideoStreamManager.openStream('${stream.source_id}')">
                        <div class="video-stream-header-info">
                            <div>
                                <div class="video-stream-name">${stream.name}</div>
                                <div class="video-stream-location">${stream.location}</div>
                            </div>
                            <span class="video-stream-status-badge ${stream.status}">${this.getStatusText(stream.status)}</span>
                        </div>
                        <div class="video-stream-details">
                            <div class="video-stream-detail">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6"/><path d="M1 12h6m6 0h6"/>
                                </svg>
                                <span>${stream.protocol_type.toUpperCase()}</span>
                            </div>
                            <div class="video-stream-detail">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="2" y="7" width="20" height="15" rx="2" ry="2"/><polyline points="17 2 12 7 7 2"/>
                                </svg>
                                <span>${stream.quality}</span>
                            </div>
                            <div class="video-stream-detail">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 2a10 10 0 1010 10H12V2z"/><path d="M12 2a10 10 0 0110 10"/>
                                </svg>
                                <span>${stream.bitrate} Kbps</span>
                            </div>
                            <div class="video-stream-detail">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                                </svg>
                                <span>${stream.fps} FPS</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            },

            getStatusText(status) {
                const statusMap = {
                    'online': 'Çevrimiçi',
                    'offline': 'Çevrimdışı',
                    'connecting': 'Bağlanıyor',
                    'error': 'Hata',
                    'recording': 'Kayıt Yapıyor'
                };
                return statusMap[status] || status;
            },

            updateStatistics() {
                const stats = {
                    total: this.state.streams.length,
                    online: this.state.streams.filter(s => s.status === 'online').length,
                    recording: this.state.streams.filter(s => s.status === 'recording').length,
                    avgBitrate: Math.round(this.state.streams.reduce((sum, s) => sum + s.bitrate, 0) / this.state.streams.length) || 0
                };

                const totalEl = document.getElementById('videoTotalSources');
                const onlineEl = document.getElementById('videoOnlineSources');
                const recordingEl = document.getElementById('videoRecordingSources');
                const bitrateEl = document.getElementById('videoAvgBitrate');

                if (totalEl) totalEl.textContent = stats.total;
                if (onlineEl) onlineEl.textContent = stats.online;
                if (recordingEl) recordingEl.textContent = stats.recording;
                if (bitrateEl) bitrateEl.textContent = stats.avgBitrate;
            },

            async openStream(sourceId) {
                try {
                    const stream = this.state.streams.find(s => s.source_id === sourceId);
                    if (!stream) return;

                    this.state.currentStream = stream;

                    // Update player UI
                    const titleEl = document.getElementById('videoPlayerTitle');
                    const sourceNameEl = document.getElementById('videoSourceName');
                    const sourceLocationEl = document.getElementById('videoSourceLocation');
                    const protocolEl = document.getElementById('protocolBadge');
                    const fpsEl = document.getElementById('fpsBadge');
                    const recordingIndicator = document.getElementById('recordingIndicator');

                    if (titleEl) titleEl.textContent = stream.name;
                    if (sourceNameEl) sourceNameEl.textContent = stream.name;
                    if (sourceLocationEl) sourceLocationEl.textContent = stream.location;
                    if (protocolEl) protocolEl.querySelector('span').textContent = stream.protocol_type.toUpperCase();
                    if (fpsEl) fpsEl.querySelector('span').textContent = stream.fps + ' FPS';
                    if (recordingIndicator) {
                        recordingIndicator.style.display = stream.recording_enabled ? 'flex' : 'none';
                    }

                    // Show player modal
                    document.getElementById('videoPlayerModal').classList.add('active');
                    document.getElementById('videoPlayerContainer').style.display = 'flex';
                    document.getElementById('videoMultiview').classList.remove('active');

                    // Start stream
                    await this.startStream(sourceId);

                    termLog(`[VIDEO STREAM] Stream açıldı: ${stream.name}`, 'ok');
                } catch (error) {
                    console.error('[VIDEO STREAM] Stream açma hatası:', error);
                    termLog('[VIDEO STREAM] Stream açma hatası: ' + error.message, 'error');
                }
            },

            async startStream(sourceId) {
                try {
                    const response = await fetch(`/api/harita/video-streams/${sourceId}/kontrol`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'play' })
                    });
                    const data = await response.json();

                    if (data.basarili && data.sonuc.success) {
                        const videoEl = document.getElementById('videoElement');
                        const placeholderEl = document.getElementById('videoPlaceholder');

                        // Simulate video loading (in production, set actual src)
                        placeholderEl.style.display = 'flex';

                        setTimeout(() => {
                            placeholderEl.style.display = 'none';
                            // In production: videoEl.src = data.sonuc.stream_url;
                            // For demo, use placeholder
                        }, 1000);

                        termLog(`[VIDEO STREAM] Stream başlatıldı: ${sourceId}`, 'ok');
                    }
                } catch (error) {
                    console.error('[VIDEO STREAM] Stream başlatma hatası:', error);
                }
            },

            closeStream() {
                const videoEl = document.getElementById('videoElement');
                if (videoEl) {
                    videoEl.pause();
                    videoEl.src = '';
                }

                document.getElementById('videoPlayerModal').classList.remove('active');
                this.state.currentStream = null;

                termLog('[VIDEO STREAM] Stream kapatıldı', 'info');
            }
        };

        // Global functions for HTML event handlers
        function toggleVideoStreamPanel() {
            const panel = document.getElementById('video-stream-panel');
            const isActive = panel.classList.contains('active');

            if (isActive) {
                panel.classList.remove('active');
                VideoStreamManager.state.active = false;
                termLog('[VIDEO STREAM] Panel kapandı', 'info');
            } else {
                panel.classList.add('active');
                VideoStreamManager.state.active = true;
                VideoStreamManager.loadVideoStreams();
                termLog('[VIDEO STREAM] Panel açıldı', 'info');
            }
        }

        function refreshVideoStreams() {
            VideoStreamManager.loadVideoStreams();
        }

        function filterVideoStreams() {
            VideoStreamManager.state.filters.status = document.getElementById('videoStatusFilter').value;
            VideoStreamManager.state.filters.protocol = document.getElementById('videoProtocolFilter').value;
            VideoStreamManager.state.filters.quality = document.getElementById('videoQualityFilter').value;
            VideoStreamManager.state.filters.location = document.getElementById('videoLocationFilter').value;
            VideoStreamManager.renderStreams();
            termLog('[VIDEO STREAM] Filtreler uygulandı', 'info');
        }

        function toggleMultiView() {
            const modal = document.getElementById('videoPlayerModal');
            const container = document.getElementById('videoPlayerContainer');
            const multiview = document.getElementById('videoMultiview');

            VideoStreamManager.state.multiViewActive = !VideoStreamManager.state.multiViewActive;

            if (VideoStreamManager.state.multiViewActive) {
                modal.classList.add('active');
                container.style.display = 'none';
                multiview.classList.add('active');

                // Load 4 streams for multiview
                const onlineStreams = VideoStreamManager.state.streams.filter(s => s.status === 'online').slice(0, 4);
                onlineStreams.forEach((stream, index) => {
                    const videoEl = document.getElementById(`multiview${index + 1}`);
                    if (videoEl) {
                        videoEl.src = stream.stream_url;
                        multiview.querySelector(`.video-multiview-item:nth-child(${index + 1}) .video-multiview-label`).textContent = stream.name;
                    }
                });

                termLog('[VIDEO STREAM] Çoklu görünüm aktif (2x2)', 'ok');
            } else {
                multiview.classList.remove('active');
                container.style.display = 'flex';
                termLog('[VIDEO STREAM] Tek görünüm aktif', 'info');
            }
        }

        function exportVideoReport() {
            const data = {
                timestamp: new Date().toISOString(),
                streams: VideoStreamManager.state.streams,
                statistics: {
                    total: VideoStreamManager.state.streams.length,
                    online: VideoStreamManager.state.streams.filter(s => s.status === 'online').length,
                    offline: VideoStreamManager.state.streams.filter(s => s.status === 'offline').length
                }
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tsunami-video-report-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);

            termLog('[VIDEO STREAM] Rapor dışa aktarıldı', 'ok');
        }

        function closeVideoPlayer() {
            VideoStreamManager.closeStream();
        }

        async function controlStream(action) {
            if (!VideoStreamManager.state.currentStream) return;

            try {
                const response = await fetch(`/api/harita/video-streams/${VideoStreamManager.state.currentStream.source_id}/kontrol`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: action })
                });
                const data = await response.json();

                if (data.basarili) {
                    termLog(`[VIDEO STREAM] Kontrol: ${action}`, 'ok');
                }
            } catch (error) {
                console.error('[VIDEO STREAM] Kontrol hatası:', error);
            }
        }

        function toggleMute() {
            const videoEl = document.getElementById('videoElement');
            if (videoEl) {
                videoEl.muted = !videoEl.muted;
                const btn = document.getElementById('muteBtn');
                btn.classList.toggle('active', videoEl.muted);
                termLog(`[VIDEO STREAM] Sessizlik: ${videoEl.muted ? 'Açık' : 'Kapalı'}`, 'info');
            }
        }

        function toggleFullscreen() {
            const container = document.getElementById('videoPlayerContainer');
            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else {
                container.requestFullscreen();
            }
        }

        async function togglePiP() {
            const videoEl = document.getElementById('videoElement');
            if (document.pictureInPictureElement) {
                await document.exitPictureInPicture();
            } else if (videoEl) {
                await videoEl.requestPictureInPicture();
            }
        }

        function cycleQuality() {
            const qualities = VideoStreamManager.state.qualities;
            VideoStreamManager.state.currentQualityIndex = (VideoStreamManager.state.currentQualityIndex + 1) % qualities.length;
            const newQuality = qualities[VideoStreamManager.state.currentQualityIndex];

            const qualityEl = document.getElementById('currentQuality');
            if (qualityEl) qualityEl.textContent = newQuality;

            termLog(`[VIDEO STREAM] Kalite değiştirildi: ${newQuality}`, 'info');

            // In production: Send quality change request to backend
            if (VideoStreamManager.state.currentStream) {
                controlStream('quality_change');
            }
        }

        function seekVideo(event) {
            const timeline = event.currentTarget;
            const rect = timeline.getBoundingClientRect();
            const percent = ((event.clientX - rect.left) / rect.width) * 100;

            const progressEl = document.getElementById('timelineProgress');
            if (progressEl) progressEl.style.width = percent + '%';

            // In production: Seek video to position
        }

        // Initialize video stream manager on page load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('[FAZ 5] Video Stream Manager başlatıldı - Real-Time Video Streaming hazır');
        });
    </script>
</body>
</html>
